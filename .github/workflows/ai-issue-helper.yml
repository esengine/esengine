name: AI Issue Helper

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read
  models: read

jobs:
  ai-helper:
    runs-on: ubuntu-latest
    # åªåœ¨çœŸå®žç”¨æˆ·æåˆ° @ai-helper æ—¶è§¦å‘ï¼Œå¿½ç•¥æœºå™¨äººè¯„è®?    if: |
      contains(github.event.comment.body, '@ai-helper') &&
      github.event.comment.user.type != 'Bot'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get Issue Details
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            // é™åˆ¶é•¿åº¦ï¼Œé¿å…è¶…è¿?token é™åˆ¶
            const maxLength = 1000;
            const truncate = (str, max) => {
              if (!str) return '';
              return str.length > max ? str.substring(0, max) + '...[å†…å®¹è¿‡é•¿å·²æˆªæ–­]' : str;
            };

            core.exportVariable('ISSUE_TITLE', truncate(issue.data.title || '', 200));
            core.exportVariable('ISSUE_BODY', truncate(issue.data.body || '', maxLength));
            core.exportVariable('COMMENT_BODY', truncate(context.payload.comment.body || '', 500));
            core.exportVariable('ISSUE_NUMBER', context.issue.number);

      - name: Create Prompt
        id: prompt
        run: |
          cat > prompt.txt << 'PROMPT_EOF'
          Issue #${{ env.ISSUE_NUMBER }}

          æ ‡é¢˜: ${{ env.ISSUE_TITLE }}

          å†…å®¹: ${{ env.ISSUE_BODY }}

          è¯„è®º: ${{ env.COMMENT_BODY }}

          è¯·æœç´¢é¡¹ç›®ä»£ç å¹¶æä¾›è§£å†³æ–¹æ¡ˆã€?          PROMPT_EOF

      - name: AI Analysis
        uses: actions/ai-inference@v1
        id: ai
        with:
          model: 'gpt-4o'
          enable-github-mcp: true
          max-tokens: 1500
          system-prompt: |
            ä½ æ˜¯ ECS Framework (TypeScript ECS æ¡†æž¶) çš?AI åŠ©æ‰‹ã€?            ä¸»è¦ä»£ç åœ?packages/framework/core/srcã€?            æœç´¢ç›¸å…³ä»£ç åŽï¼Œç”¨ä¸­æ–‡ç®€æ´å›žç­”é—®é¢˜ï¼ŒåŒ…å«é—®é¢˜åˆ†æžã€è§£å†³æ–¹æ¡ˆå’Œä»£ç å¼•ç”¨ã€?          prompt-file: prompt.txt

      - name: Post AI Response
        env:
          AI_RESPONSE: ${{ steps.ai.outputs.response }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: process.env.AI_RESPONSE
            });
