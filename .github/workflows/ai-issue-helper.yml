name: AI Issue Helper

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read
  models: read

jobs:
  ai-helper:
    runs-on: ubuntu-latest
    # Only trigger when real users mention @ai-helper, ignore bots
    if: |
      contains(github.event.comment.body, '@ai-helper') &&
      github.event.comment.user.type != 'Bot'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get Issue Details
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            // Limit length to avoid token limit
            const maxLength = 1000;
            const truncate = (str, max) => {
              if (!str) return '';
              return str.length > max ? str.substring(0, max) + '...[truncated]' : str;
            };

            core.exportVariable('ISSUE_TITLE', truncate(issue.data.title || '', 200));
            core.exportVariable('ISSUE_BODY', truncate(issue.data.body || '', maxLength));
            core.exportVariable('COMMENT_BODY', truncate(context.payload.comment.body || '', 500));
            core.exportVariable('ISSUE_NUMBER', context.issue.number);

      - name: Create Prompt
        id: prompt
        run: |
          cat > prompt.txt << 'PROMPT_EOF'
          Issue #${{ env.ISSUE_NUMBER }}

          Title: ${{ env.ISSUE_TITLE }}

          Content: ${{ env.ISSUE_BODY }}

          Comment: ${{ env.COMMENT_BODY }}

          Please search the project code and provide a solution.
          PROMPT_EOF

      - name: AI Analysis
        uses: actions/ai-inference@v1
        id: ai
        with:
          model: 'gpt-4o'
          enable-github-mcp: true
          max-tokens: 1500
          system-prompt: |
            You are an AI assistant for the ECS Framework (TypeScript ECS framework).
            Main code is in packages/framework/core/src.
            After searching relevant code, answer questions concisely in Chinese,
            including problem analysis, solution, and code references.
          prompt-file: prompt.txt

      - name: Post AI Response
        env:
          AI_RESPONSE: ${{ steps.ai.outputs.response }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: process.env.AI_RESPONSE
            });
