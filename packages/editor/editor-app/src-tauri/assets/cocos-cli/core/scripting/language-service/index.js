"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.LanguageServiceAdapter = exports.LanguageServiceHostAdapter = exports.ParseConfigFileHostAdapter = exports.VirtualIOAdapter = void 0;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
const typescript_1 = __importDefault(require("typescript"));
const cache_1 = require("../shared/cache");
const command_1 = require("./command");
const asserts_1 = require("../utils/asserts");
const query_shared_settings_1 = require("../shared/query-shared-settings");
/**
 * 这个类用来处理内存中的文件
 */
class VirtualIOAdapter {
    _fileCache = cache_1.tsScriptAssetCache;
    constructor() {
    }
    /** 如果内存中有这部分内容则优先使用内存的 */
    readFile(filePath) {
        if (filePath === LanguageServiceHostAdapter.defaultLibFileName) {
            return undefined;
        }
        const cache = this.readCache(filePath);
        let content;
        if (cache?.content) {
            content = cache.content;
        }
        else {
            try {
                content = (0, fs_extra_1.readFileSync)(filePath, 'utf8');
                const info = this._fileCache.get(filePath);
                (0, asserts_1.asserts)(info);
                const nowMtimeMs = (0, fs_extra_1.statSync)(filePath).mtimeMs;
                this.writeCache({ filePath, uuid: info.uuid, content, version: nowMtimeMs.toString() });
            }
            catch (error) {
                console.debug(error);
            }
        }
        return content;
    }
    /**从内存加载脚本信息 */
    readCache(filePath) {
        return this._fileCache.get(filePath);
    }
    removeCache(filePath) {
        return this._fileCache.delete(filePath);
    }
    /** 将文件写入至内存 */
    writeCache({ uuid, content, version, filePath }) {
        this._fileCache.set(filePath, { filePath, uuid, content, version });
    }
    fileExists(path) {
        return (0, fs_extra_1.existsSync)(path);
    }
    getFileNames() {
        return Array.from(cache_1.tsScriptAssetCache.keys());
    }
}
exports.VirtualIOAdapter = VirtualIOAdapter;
class ParseConfigFileHostAdapter extends VirtualIOAdapter {
    _currentDirectory;
    constructor(_currentDirectory) {
        super();
        this._currentDirectory = _currentDirectory;
    }
    getCurrentDirectory() {
        return this._currentDirectory;
    }
    useCaseSensitiveFileNames = true;
    readDirectory(rootDir, extensions, excludes, includes, depth) {
        return this.getFileNames();
    }
    onUnRecoverableConfigFileDiagnostic(...args) {
        console.error(...args);
    }
}
exports.ParseConfigFileHostAdapter = ParseConfigFileHostAdapter;
class LanguageServiceHostAdapter extends VirtualIOAdapter {
    _parseConfigFileHost;
    _tsconfigPath;
    _currentDirectory;
    _compilerOptions;
    static defaultLibFileName = '__DEFAULT_LIB_FILE_NAME_IS_NEVER_EXIST.d.ts';
    constructor(_parseConfigFileHost, _tsconfigPath, _currentDirectory, _compilerOptions) {
        super();
        this._parseConfigFileHost = _parseConfigFileHost;
        this._tsconfigPath = _tsconfigPath;
        this._currentDirectory = _currentDirectory;
        this._compilerOptions = _compilerOptions;
    }
    getCompilationSettings() {
        return this._compilerOptions;
    }
    getScriptFileNames() {
        return this.getFileNames().slice();
    }
    getScriptVersion(fileName) {
        return this.readCache(fileName)?.version ?? '';
    }
    getScriptSnapshot(fileName) {
        const file = this.readFile(fileName);
        return file && typescript_1.default.ScriptSnapshot.fromString(file) || undefined;
    }
    getCurrentDirectory() {
        return this._currentDirectory;
    }
    getDefaultLibFileName(options) {
        return LanguageServiceHostAdapter.defaultLibFileName;
    }
    useCaseSensitiveFileNames() {
        return this._parseConfigFileHost.useCaseSensitiveFileNames;
    }
}
exports.LanguageServiceHostAdapter = LanguageServiceHostAdapter;
class LanguageServiceAdapter {
    _tsconfigPath;
    _currentDirectory;
    _beforeBuildDelegate;
    _compilerOptions;
    dbURLInfos;
    languageService;
    host;
    autoUpdateFileImport;
    _parseConfigFileHost;
    /** 命令队列 */
    _awaitCommandQueue = [];
    /** 正在执行的命令 */
    _executingCommandID = '';
    _changedFileSet = new Set();
    _afterOutputTasks = [];
    constructor(_tsconfigPath, _currentDirectory, 
    /** 外部提供一个委托，这里注入委托，主要防止重复编译 */
    _beforeBuildDelegate, _compilerOptions, dbURLInfos) {
        this._tsconfigPath = _tsconfigPath;
        this._currentDirectory = _currentDirectory;
        this._beforeBuildDelegate = _beforeBuildDelegate;
        this._compilerOptions = _compilerOptions;
        this.dbURLInfos = dbURLInfos;
        this._parseConfigFileHost = new ParseConfigFileHostAdapter(_currentDirectory);
        this.host = new LanguageServiceHostAdapter(this._parseConfigFileHost, this._tsconfigPath, this._currentDirectory, this._compilerOptions);
        this.languageService = typescript_1.default.createLanguageService(this.host, undefined, typescript_1.default.LanguageServiceMode.Semantic);
        this._beforeBuildDelegate.add(async (assetChanges) => {
            assetChanges.forEach(item => item.oldFilePath && item.newFilePath && this.requestRenameFile(item.oldFilePath, item.newFilePath));
            await this.finishCommand(assetChanges);
        });
    }
    isExecuting(commandID) {
        if (this._executingCommandID === commandID || this._awaitCommandQueue.some(item => item.command.id === commandID)) {
            return true;
        }
        return false;
    }
    get isBusy() {
        return Boolean(this._executingCommandID);
    }
    async executeCommand(command) {
        if (this.isExecuting(command.id)) {
            return;
        }
        if (this._executingCommandID) {
            await new Promise((resolve, reject) => {
                this._awaitCommandQueue.push({
                    command,
                    resolveAwait: resolve,
                });
            });
        }
        this._executingCommandID = command.id;
        const result = await command.execute(this);
        for (const iterator of result.values()) {
            this._changedFileSet.add(iterator);
        }
        const nextCommand = this._awaitCommandQueue.shift();
        if (nextCommand) {
            nextCommand.resolveAwait(void 0);
        }
        else {
            await this.outPutFiles(this._changedFileSet);
            this._executingCommandID = '';
            this._changedFileSet.clear();
            // 从生成文件的过程中会注入命令，
            const nextCommand = this._awaitCommandQueue.shift();
            if (nextCommand) {
                nextCommand.resolveAwait(void 0);
            }
        }
    }
    /** 请求更新路径 */
    async requestRenameFile(oldFilePath, newFilePath) {
        if (oldFilePath && newFilePath && oldFilePath.endsWith('.ts') && newFilePath.endsWith('.ts') || !(0, path_1.extname)(oldFilePath)) {
            if (oldFilePath === newFilePath) {
                return;
            }
            if (this.autoUpdateFileImport === undefined) {
                this.autoUpdateFileImport = await query_shared_settings_1.scriptConfig.getProject('updateAutoUpdateImportConfig');
            }
            if (this.autoUpdateFileImport) {
                console.debug('Starting rename...');
                await this.executeCommand(new command_1.RenameCommand(oldFilePath, newFilePath));
                console.debug('Finish rename.');
            }
        }
    }
    applyChanges(text, changes) {
        for (let i = changes.length - 1; i >= 0; i--) {
            const { span, newText } = changes[i];
            text = `${text.substring(0, span.start)}${newText}${text.substring(this.textSpanEnd(span))}`;
        }
        return text;
    }
    /** 将缓存中的数据生成到位置 */
    async outPutFiles(fileNameSet) {
        const arr = Array.from(fileNameSet.values());
        await Promise.all(arr.map(async (file) => {
            try {
                const cache = this.host.readCache(file);
                if (!cache?.content) {
                    console.debug('There\'s nothing in the cache');
                    return;
                }
                await (0, fs_extra_1.writeFile)(file, cache?.content, { encoding: 'utf8' });
            }
            catch (error) {
                console.debug(`Failed to update script ${file}`, error);
            }
        }));
        while (this._afterOutputTasks.length) {
            const task = this._afterOutputTasks.shift();
            if (task) {
                task();
            }
        }
        this.clearCache();
    }
    clearCache() {
        cache_1.tsScriptAssetCache.forEach(item => item.content = undefined);
    }
    textSpanEnd(span) {
        return span.start + span.length;
    }
    async finishCommand(assetChanges) {
        return new Promise((resolve, reject) => {
            if (this.isBusy) {
                this._afterOutputTasks.push(resolve);
            }
            else {
                resolve();
            }
        });
    }
}
exports.LanguageServiceAdapter = LanguageServiceAdapter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29yZS9zY3JpcHRpbmcvbGFuZ3VhZ2Utc2VydmljZS9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSx1Q0FBeUU7QUFDekUsK0JBQStCO0FBQy9CLDREQUE0RztBQUc1RywyQ0FBK0Q7QUFFL0QsdUNBQWlFO0FBQ2pFLDhDQUEyQztBQUMzQywyRUFBK0Q7QUFFL0Q7O0dBRUc7QUFDSCxNQUFhLGdCQUFnQjtJQUNOLFVBQVUsR0FBMEIsMEJBQWtCLENBQUM7SUFDMUU7SUFJQSxDQUFDO0lBQ0QsMEJBQTBCO0lBQzFCLFFBQVEsQ0FBQyxRQUFrQjtRQUN2QixJQUFJLFFBQVEsS0FBSywwQkFBMEIsQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1lBQzdELE9BQU8sU0FBUyxDQUFDO1FBQ3JCLENBQUM7UUFDRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZDLElBQUksT0FBMkIsQ0FBQztRQUNoQyxJQUFJLEtBQUssRUFBRSxPQUFPLEVBQUUsQ0FBQztZQUNqQixPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQztRQUM1QixDQUFDO2FBQU0sQ0FBQztZQUNKLElBQUksQ0FBQztnQkFDRCxPQUFPLEdBQUcsSUFBQSx1QkFBWSxFQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztnQkFDekMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQzNDLElBQUEsaUJBQU8sRUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDZCxNQUFNLFVBQVUsR0FBRyxJQUFBLG1CQUFRLEVBQUMsUUFBUSxDQUFDLENBQUMsT0FBTyxDQUFDO2dCQUM5QyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsSUFB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QUFrQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDLENBQUM7SUFDakUsQ0FBQztJQUNTLFdBQVcsQ0FBQyxJQUFpQjtRQUNuQyxPQUFPLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUNwQyxDQUFDO0lBQ1MsS0FBSyxDQUFDLGFBQWEsQ0FBQyxZQUFtQztRQUM3RCxPQUFPLElBQUksT0FBTyxDQUFPLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3pDLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUNkLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDekMsQ0FBQztpQkFBTSxDQUFDO2dCQUNKLE9BQU8sRUFBRSxDQUFDO1lBQ2QsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNKO0FBeklELHdEQXlJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGV4aXN0c1N5bmMsIHJlYWRGaWxlU3luYywgc3RhdFN5bmMsIHdyaXRlRmlsZSB9IGZyb20gJ2ZzLWV4dHJhJztcclxuaW1wb3J0IHsgZXh0bmFtZSB9IGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgdHMsIHsgQ29tcGlsZXJPcHRpb25zLCBJU2NyaXB0U25hcHNob3QsIExhbmd1YWdlU2VydmljZUhvc3QsIFBhcnNlQ29uZmlnRmlsZUhvc3QgfSBmcm9tICd0eXBlc2NyaXB0JztcclxuaW1wb3J0IHsgRGJVUkxJbmZvIH0gZnJvbSAnLi4vaW50ZWxsaWdlbmNlJztcclxuaW1wb3J0IHsgTW9kaWZpZWRBc3NldENoYW5nZSB9IGZyb20gJy4uL3BhY2tlci1kcml2ZXIvYXNzZXQtZGItaW50ZXJvcCc7XHJcbmltcG9ydCB7IHRzU2NyaXB0QXNzZXRDYWNoZSwgRmlsZUluZm8gfSBmcm9tICcuLi9zaGFyZWQvY2FjaGUnO1xyXG5pbXBvcnQgeyBBc3luY0RlbGVnYXRlIH0gZnJvbSAnLi4vdXRpbHMvZGVsZWdhdGUnO1xyXG5pbXBvcnQgeyBBd2FpdENvbW1hbmQsIENvbW1hbmQsIFJlbmFtZUNvbW1hbmQgfSBmcm9tICcuL2NvbW1hbmQnO1xyXG5pbXBvcnQgeyBhc3NlcnRzIH0gZnJvbSAnLi4vdXRpbHMvYXNzZXJ0cyc7XHJcbmltcG9ydCB7IHNjcmlwdENvbmZpZyB9IGZyb20gJy4uL3NoYXJlZC9xdWVyeS1zaGFyZWQtc2V0dGluZ3MnO1xyXG5cclxuLyoqXHJcbiAqIOi/meS4quexu+eUqOadpeWkhOeQhuWGheWtmOS4reeahOaWh+S7tlxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIFZpcnR1YWxJT0FkYXB0ZXIge1xyXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IF9maWxlQ2FjaGU6IE1hcDxzdHJpbmcsIEZpbGVJbmZvPiA9IHRzU2NyaXB0QXNzZXRDYWNoZTtcclxuICAgIGNvbnN0cnVjdG9yKFxyXG5cclxuICAgICkge1xyXG5cclxuICAgIH1cclxuICAgIC8qKiDlpoLmnpzlhoXlrZjkuK3mnInov5npg6jliIblhoXlrrnliJnkvJjlhYjkvb/nlKjlhoXlrZjnmoQgKi9cclxuICAgIHJlYWRGaWxlKGZpbGVQYXRoOiBGaWxlUGF0aCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XHJcbiAgICAgICAgaWYgKGZpbGVQYXRoID09PSBMYW5ndWFnZVNlcnZpY2VIb3N0QWRhcHRlci5kZWZhdWx0TGliRmlsZU5hbWUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgY2FjaGUgPSB0aGlzLnJlYWRDYWNoZShmaWxlUGF0aCk7XHJcbiAgICAgICAgbGV0IGNvbnRlbnQ6IHN0cmluZyB8IHVuZGVmaW5lZDtcclxuICAgICAgICBpZiAoY2FjaGU/LmNvbnRlbnQpIHtcclxuICAgICAgICAgICAgY29udGVudCA9IGNhY2hlLmNvbnRlbnQ7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGNvbnRlbnQgPSByZWFkRmlsZVN5bmMoZmlsZVBhdGgsICd1dGY4Jyk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0gdGhpcy5fZmlsZUNhY2hlLmdldChmaWxlUGF0aCk7XHJcbiAgICAgICAgICAgICAgICBhc3NlcnRzKGluZm8pO1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgbm93TXRpbWVNcyA9IHN0YXRTeW5jKGZpbGVQYXRoKS5tdGltZU1zO1xyXG4gICAgICAgICAgICAgICAgdGhpcy53cml0ZUNhY2hlKHsgZmlsZVBhdGgsIHV1aWQ6IGluZm8udXVpZCwgY29udGVudCwgdmVyc2lvbjogbm93TXRpbWVNcy50b1N0cmluZygpIH0pO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhlcnJvcik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBjb250ZW50O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKuS7juWGheWtmOWKoOi9veiEmuacrOS/oeaBryAqL1xyXG4gICAgcmVhZENhY2hlKGZpbGVQYXRoOiBGaWxlUGF0aCk6IFJlYWRvbmx5PEZpbGVJbmZvPiB8IHVuZGVmaW5lZCB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2ZpbGVDYWNoZS5nZXQoZmlsZVBhdGgpO1xyXG4gICAgfVxyXG4gICAgcmVtb3ZlQ2FjaGUoZmlsZVBhdGg6IEZpbGVQYXRoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2ZpbGVDYWNoZS5kZWxldGUoZmlsZVBhdGgpO1xyXG4gICAgfVxyXG4gICAgLyoqIOWwhuaWh+S7tuWGmeWFpeiHs+WGheWtmCAqL1xyXG4gICAgd3JpdGVDYWNoZSh7IHV1aWQsIGNvbnRlbnQsIHZlcnNpb24sIGZpbGVQYXRoIH06IFJlYWRvbmx5PEZpbGVJbmZvPik6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuX2ZpbGVDYWNoZS5zZXQoZmlsZVBhdGgsIHsgZmlsZVBhdGgsIHV1aWQsIGNvbnRlbnQsIHZlcnNpb24gfSk7XHJcbiAgICB9XHJcbiAgICBmaWxlRXhpc3RzKHBhdGg6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiBleGlzdHNTeW5jKHBhdGgpO1xyXG4gICAgfVxyXG4gICAgZ2V0RmlsZU5hbWVzKCkge1xyXG4gICAgICAgIHJldHVybiBBcnJheS5mcm9tKHRzU2NyaXB0QXNzZXRDYWNoZS5rZXlzKCkpO1xyXG4gICAgfVxyXG59XHJcbmV4cG9ydCBjbGFzcyBQYXJzZUNvbmZpZ0ZpbGVIb3N0QWRhcHRlciBleHRlbmRzIFZpcnR1YWxJT0FkYXB0ZXIgaW1wbGVtZW50cyBQYXJzZUNvbmZpZ0ZpbGVIb3N0IHtcclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHByb3RlY3RlZCByZWFkb25seSBfY3VycmVudERpcmVjdG9yeTogRmlsZVBhdGgsXHJcblxyXG4gICAgKSB7XHJcbiAgICAgICAgc3VwZXIoKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRDdXJyZW50RGlyZWN0b3J5KCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2N1cnJlbnREaXJlY3Rvcnk7XHJcbiAgICB9XHJcbiAgICB1c2VDYXNlU2Vuc2l0aXZlRmlsZU5hbWVzID0gdHJ1ZTtcclxuICAgIHJlYWREaXJlY3Rvcnkocm9vdERpcjogc3RyaW5nLCBleHRlbnNpb25zOiByZWFkb25seSBzdHJpbmdbXSwgZXhjbHVkZXM6IHJlYWRvbmx5IHN0cmluZ1tdIHwgdW5kZWZpbmVkLCBpbmNsdWRlczogcmVhZG9ubHkgc3RyaW5nW10sIGRlcHRoPzogbnVtYmVyIHwgdW5kZWZpbmVkKTogcmVhZG9ubHkgc3RyaW5nW10ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldEZpbGVOYW1lcygpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uVW5SZWNvdmVyYWJsZUNvbmZpZ0ZpbGVEaWFnbm9zdGljKC4uLmFyZ3M6IFBhcmFtZXRlcnM8UGFyc2VDb25maWdGaWxlSG9zdFsnb25VblJlY292ZXJhYmxlQ29uZmlnRmlsZURpYWdub3N0aWMnXT4pIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKC4uLmFyZ3MpO1xyXG4gICAgfVxyXG5cclxufVxyXG5leHBvcnQgY2xhc3MgTGFuZ3VhZ2VTZXJ2aWNlSG9zdEFkYXB0ZXIgZXh0ZW5kcyBWaXJ0dWFsSU9BZGFwdGVyIGltcGxlbWVudHMgTGFuZ3VhZ2VTZXJ2aWNlSG9zdCB7XHJcbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IGRlZmF1bHRMaWJGaWxlTmFtZSA9ICdfX0RFRkFVTFRfTElCX0ZJTEVfTkFNRV9JU19ORVZFUl9FWElTVC5kLnRzJztcclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHByb3RlY3RlZCByZWFkb25seSBfcGFyc2VDb25maWdGaWxlSG9zdDogUmVhZG9ubHk8UGFyc2VDb25maWdGaWxlSG9zdEFkYXB0ZXI+LFxyXG4gICAgICAgIHByb3RlY3RlZCByZWFkb25seSBfdHNjb25maWdQYXRoOiBGaWxlUGF0aCxcclxuICAgICAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgX2N1cnJlbnREaXJlY3Rvcnk6IEZpbGVQYXRoLFxyXG4gICAgICAgIHByb3RlY3RlZCByZWFkb25seSBfY29tcGlsZXJPcHRpb25zOiBDb21waWxlck9wdGlvbnNcclxuXHJcbiAgICApIHtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgfVxyXG4gICAgZ2V0Q29tcGlsYXRpb25TZXR0aW5ncygpOiBDb21waWxlck9wdGlvbnMge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9jb21waWxlck9wdGlvbnM7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U2NyaXB0RmlsZU5hbWVzKCk6IHN0cmluZ1tdIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRGaWxlTmFtZXMoKS5zbGljZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFNjcmlwdFZlcnNpb24oZmlsZU5hbWU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucmVhZENhY2hlKGZpbGVOYW1lKT8udmVyc2lvbiA/PyAnJztcclxuICAgIH1cclxuICAgIGdldFNjcmlwdFNuYXBzaG90KGZpbGVOYW1lOiBzdHJpbmcpOiBJU2NyaXB0U25hcHNob3QgfCB1bmRlZmluZWQge1xyXG4gICAgICAgIGNvbnN0IGZpbGUgPSB0aGlzLnJlYWRGaWxlKGZpbGVOYW1lKTtcclxuICAgICAgICByZXR1cm4gZmlsZSAmJiB0cy5TY3JpcHRTbmFwc2hvdC5mcm9tU3RyaW5nKGZpbGUpIHx8IHVuZGVmaW5lZDtcclxuICAgIH1cclxuICAgIGdldEN1cnJlbnREaXJlY3RvcnkoKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fY3VycmVudERpcmVjdG9yeTtcclxuICAgIH1cclxuICAgIGdldERlZmF1bHRMaWJGaWxlTmFtZShvcHRpb25zOiBDb21waWxlck9wdGlvbnMpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiBMYW5ndWFnZVNlcnZpY2VIb3N0QWRhcHRlci5kZWZhdWx0TGliRmlsZU5hbWU7XHJcbiAgICB9XHJcbiAgICB1c2VDYXNlU2Vuc2l0aXZlRmlsZU5hbWVzKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9wYXJzZUNvbmZpZ0ZpbGVIb3N0LnVzZUNhc2VTZW5zaXRpdmVGaWxlTmFtZXM7XHJcbiAgICB9XHJcblxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIExhbmd1YWdlU2VydmljZUFkYXB0ZXJFZGl0T3B0aW9ucyB7XHJcbiAgICByZW5hbWVPcHRpb25zPzoge1xyXG4gICAgICAgIG9sZEZpbGVQYXRoOiBGaWxlUGF0aCxcclxuICAgICAgICBuZXdGaWxlUGF0aDogRmlsZVBhdGgsXHJcbiAgICB9LFxyXG4gICAgLyoqIOaYr+WQpui+k+WHuuS/ruaUueWQjueahOiEmuacrOWIsOehrOebmCAqL1xyXG4gICAgb3V0cHV0RmlsZXM/OiBib29sZWFuXHJcbn1cclxuZXhwb3J0IGNsYXNzIExhbmd1YWdlU2VydmljZUFkYXB0ZXIge1xyXG4gICAgcHVibGljIHJlYWRvbmx5IGxhbmd1YWdlU2VydmljZTogdHMuTGFuZ3VhZ2VTZXJ2aWNlO1xyXG4gICAgcHVibGljIHJlYWRvbmx5IGhvc3Q6IExhbmd1YWdlU2VydmljZUhvc3RBZGFwdGVyO1xyXG4gICAgcHVibGljIGF1dG9VcGRhdGVGaWxlSW1wb3J0OiBib29sZWFuIHwgdW5kZWZpbmVkO1xyXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IF9wYXJzZUNvbmZpZ0ZpbGVIb3N0OiBQYXJzZUNvbmZpZ0ZpbGVIb3N0QWRhcHRlcjtcclxuICAgIC8qKiDlkb3ku6TpmJ/liJcgKi9cclxuICAgIHByb3RlY3RlZCByZWFkb25seSBfYXdhaXRDb21tYW5kUXVldWU6IEF3YWl0Q29tbWFuZFtdID0gW107XHJcbiAgICAvKiog5q2j5Zyo5omn6KGM55qE5ZG95LukICovXHJcbiAgICBwcm90ZWN0ZWQgX2V4ZWN1dGluZ0NvbW1hbmRJRDogQ29tbWFuZFsnaWQnXSA9ICcnO1xyXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IF9jaGFuZ2VkRmlsZVNldDogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7XHJcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgX2FmdGVyT3V0cHV0VGFza3M6ICgoKSA9PiB2b2lkKVtdID0gW107XHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgX3RzY29uZmlnUGF0aDogRmlsZVBhdGgsXHJcbiAgICAgICAgcHJvdGVjdGVkIHJlYWRvbmx5IF9jdXJyZW50RGlyZWN0b3J5OiBGaWxlUGF0aCxcclxuICAgICAgICAvKiog5aSW6YOo5o+Q5L6b5LiA5Liq5aeU5omY77yM6L+Z6YeM5rOo5YWl5aeU5omY77yM5Li76KaB6Ziy5q2i6YeN5aSN57yW6K+RICovXHJcbiAgICAgICAgcHJvdGVjdGVkIHJlYWRvbmx5IF9iZWZvcmVCdWlsZERlbGVnYXRlOiBBc3luY0RlbGVnYXRlPChjaGFuZ2VzOiBNb2RpZmllZEFzc2V0Q2hhbmdlW10pID0+IFByb21pc2U8dm9pZD4+LFxyXG4gICAgICAgIHByb3RlY3RlZCByZWFkb25seSBfY29tcGlsZXJPcHRpb25zOiBSZWFkb25seTxDb21waWxlck9wdGlvbnM+LFxyXG4gICAgICAgIHB1YmxpYyByZWFkb25seSBkYlVSTEluZm9zOiByZWFkb25seSBEYlVSTEluZm9bXSxcclxuXHJcbiAgICApIHtcclxuICAgICAgICB0aGlzLl9wYXJzZUNvbmZpZ0ZpbGVIb3N0ID0gbmV3IFBhcnNlQ29uZmlnRmlsZUhvc3RBZGFwdGVyKF9jdXJyZW50RGlyZWN0b3J5KTtcclxuICAgICAgICB0aGlzLmhvc3QgPSBuZXcgTGFuZ3VhZ2VTZXJ2aWNlSG9zdEFkYXB0ZXIodGhpcy5fcGFyc2VDb25maWdGaWxlSG9zdCwgdGhpcy5fdHNjb25maWdQYXRoLCB0aGlzLl9jdXJyZW50RGlyZWN0b3J5LCB0aGlzLl9jb21waWxlck9wdGlvbnMpO1xyXG4gICAgICAgIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlID0gdHMuY3JlYXRlTGFuZ3VhZ2VTZXJ2aWNlKHRoaXMuaG9zdCwgdW5kZWZpbmVkLCB0cy5MYW5ndWFnZVNlcnZpY2VNb2RlLlNlbWFudGljKTtcclxuICAgICAgICB0aGlzLl9iZWZvcmVCdWlsZERlbGVnYXRlLmFkZChhc3luYyAoYXNzZXRDaGFuZ2VzKSA9PiB7XHJcbiAgICAgICAgICAgIGFzc2V0Q2hhbmdlcy5mb3JFYWNoKGl0ZW0gPT4gaXRlbS5vbGRGaWxlUGF0aCAmJiBpdGVtLm5ld0ZpbGVQYXRoICYmIHRoaXMucmVxdWVzdFJlbmFtZUZpbGUoaXRlbS5vbGRGaWxlUGF0aCwgaXRlbS5uZXdGaWxlUGF0aCkpO1xyXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmZpbmlzaENvbW1hbmQoYXNzZXRDaGFuZ2VzKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGlzRXhlY3V0aW5nKGNvbW1hbmRJRDogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICAgICAgaWYgKHRoaXMuX2V4ZWN1dGluZ0NvbW1hbmRJRCA9PT0gY29tbWFuZElEIHx8IHRoaXMuX2F3YWl0Q29tbWFuZFF1ZXVlLnNvbWUoaXRlbSA9PiBpdGVtLmNvbW1hbmQuaWQgPT09IGNvbW1hbmRJRCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIHB1YmxpYyBnZXQgaXNCdXN5KCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiBCb29sZWFuKHRoaXMuX2V4ZWN1dGluZ0NvbW1hbmRJRCk7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgYXN5bmMgZXhlY3V0ZUNvbW1hbmQoY29tbWFuZDogQ29tbWFuZCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGlmICh0aGlzLmlzRXhlY3V0aW5nKGNvbW1hbmQuaWQpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuX2V4ZWN1dGluZ0NvbW1hbmRJRCkge1xyXG4gICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9hd2FpdENvbW1hbmRRdWV1ZS5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICBjb21tYW5kLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmVBd2FpdDogcmVzb2x2ZSxcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5fZXhlY3V0aW5nQ29tbWFuZElEID0gY29tbWFuZC5pZDtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjb21tYW5kLmV4ZWN1dGUodGhpcyk7XHJcbiAgICAgICAgZm9yIChjb25zdCBpdGVyYXRvciBvZiByZXN1bHQudmFsdWVzKCkpIHtcclxuICAgICAgICAgICAgdGhpcy5fY2hhbmdlZEZpbGVTZXQuYWRkKGl0ZXJhdG9yKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgbmV4dENvbW1hbmQgPSB0aGlzLl9hd2FpdENvbW1hbmRRdWV1ZS5zaGlmdCgpO1xyXG4gICAgICAgIGlmIChuZXh0Q29tbWFuZCkge1xyXG4gICAgICAgICAgICBuZXh0Q29tbWFuZC5yZXNvbHZlQXdhaXQodm9pZCAwKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBhd2FpdCB0aGlzLm91dFB1dEZpbGVzKHRoaXMuX2NoYW5nZWRGaWxlU2V0KTtcclxuICAgICAgICAgICAgdGhpcy5fZXhlY3V0aW5nQ29tbWFuZElEID0gJyc7XHJcbiAgICAgICAgICAgIHRoaXMuX2NoYW5nZWRGaWxlU2V0LmNsZWFyKCk7XHJcbiAgICAgICAgICAgIC8vIOS7jueUn+aIkOaWh+S7tueahOi/h+eoi+S4reS8muazqOWFpeWRveS7pO+8jFxyXG4gICAgICAgICAgICBjb25zdCBuZXh0Q29tbWFuZCA9IHRoaXMuX2F3YWl0Q29tbWFuZFF1ZXVlLnNoaWZ0KCk7XHJcbiAgICAgICAgICAgIGlmIChuZXh0Q29tbWFuZCkge1xyXG4gICAgICAgICAgICAgICAgbmV4dENvbW1hbmQucmVzb2x2ZUF3YWl0KHZvaWQgMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIOivt+axguabtOaWsOi3r+W+hCAqL1xyXG4gICAgcHVibGljIGFzeW5jIHJlcXVlc3RSZW5hbWVGaWxlKG9sZEZpbGVQYXRoOiBGaWxlUGF0aCwgbmV3RmlsZVBhdGg6IEZpbGVQYXRoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgaWYgKG9sZEZpbGVQYXRoICYmIG5ld0ZpbGVQYXRoICYmIG9sZEZpbGVQYXRoLmVuZHNXaXRoKCcudHMnKSAmJiBuZXdGaWxlUGF0aC5lbmRzV2l0aCgnLnRzJykgfHwgIWV4dG5hbWUob2xkRmlsZVBhdGgpKSB7XHJcbiAgICAgICAgICAgIGlmIChvbGRGaWxlUGF0aCA9PT0gbmV3RmlsZVBhdGgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAodGhpcy5hdXRvVXBkYXRlRmlsZUltcG9ydCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmF1dG9VcGRhdGVGaWxlSW1wb3J0ID0gYXdhaXQgc2NyaXB0Q29uZmlnLmdldFByb2plY3Q8Ym9vbGVhbj4oJ3VwZGF0ZUF1dG9VcGRhdGVJbXBvcnRDb25maWcnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAodGhpcy5hdXRvVXBkYXRlRmlsZUltcG9ydCkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygnU3RhcnRpbmcgcmVuYW1lLi4uJyk7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmV4ZWN1dGVDb21tYW5kKG5ldyBSZW5hbWVDb21tYW5kKG9sZEZpbGVQYXRoLCBuZXdGaWxlUGF0aCkpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygnRmluaXNoIHJlbmFtZS4nKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFwcGx5Q2hhbmdlcyh0ZXh0OiBzdHJpbmcsIGNoYW5nZXM6IHJlYWRvbmx5IHRzLlRleHRDaGFuZ2VbXSk6IHN0cmluZyB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IGNoYW5nZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcclxuICAgICAgICAgICAgY29uc3QgeyBzcGFuLCBuZXdUZXh0IH0gPSBjaGFuZ2VzW2ldO1xyXG4gICAgICAgICAgICB0ZXh0ID0gYCR7dGV4dC5zdWJzdHJpbmcoMCwgc3Bhbi5zdGFydCl9JHtuZXdUZXh0fSR7dGV4dC5zdWJzdHJpbmcodGhpcy50ZXh0U3BhbkVuZChzcGFuKSl9YDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRleHQ7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIOWwhue8k+WtmOS4reeahOaVsOaNrueUn+aIkOWIsOS9jee9riAqL1xyXG4gICAgcHVibGljIGFzeW5jIG91dFB1dEZpbGVzKGZpbGVOYW1lU2V0OiBTZXQ8c3RyaW5nPikge1xyXG4gICAgICAgIGNvbnN0IGFyciA9IEFycmF5LmZyb20oZmlsZU5hbWVTZXQudmFsdWVzKCkpO1xyXG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKGFyci5tYXAoYXN5bmMgZmlsZSA9PiB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjYWNoZSA9IHRoaXMuaG9zdC5yZWFkQ2FjaGUoZmlsZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWNhY2hlPy5jb250ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygnVGhlcmVcXCdzIG5vdGhpbmcgaW4gdGhlIGNhY2hlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgYXdhaXQgd3JpdGVGaWxlKGZpbGUsIGNhY2hlPy5jb250ZW50LCB7IGVuY29kaW5nOiAndXRmOCcgfSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKGBGYWlsZWQgdG8gdXBkYXRlIHNjcmlwdCAke2ZpbGV9YCwgZXJyb3IpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIHdoaWxlICh0aGlzLl9hZnRlck91dHB1dFRhc2tzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBjb25zdCB0YXNrID0gdGhpcy5fYWZ0ZXJPdXRwdXRUYXNrcy5zaGlmdCgpO1xyXG4gICAgICAgICAgICBpZiAodGFzaykge1xyXG4gICAgICAgICAgICAgICAgdGFzaygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY2xlYXJDYWNoZSgpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgY2xlYXJDYWNoZSgpIHtcclxuICAgICAgICB0c1NjcmlwdEFzc2V0Q2FjaGUuZm9yRWFjaChpdGVtID0+IGl0ZW0uY29udGVudCA9IHVuZGVmaW5lZCk7XHJcbiAgICB9XHJcbiAgICBwcm90ZWN0ZWQgdGV4dFNwYW5FbmQoc3BhbjogdHMuVGV4dFNwYW4pIHtcclxuICAgICAgICByZXR1cm4gc3Bhbi5zdGFydCArIHNwYW4ubGVuZ3RoO1xyXG4gICAgfVxyXG4gICAgcHJvdGVjdGVkIGFzeW5jIGZpbmlzaENvbW1hbmQoYXNzZXRDaGFuZ2VzOiBNb2RpZmllZEFzc2V0Q2hhbmdlW10pIHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pc0J1c3kpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2FmdGVyT3V0cHV0VGFza3MucHVzaChyZXNvbHZlKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==