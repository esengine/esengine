"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.quickSpawn = quickSpawn;
const child_process_1 = require("child_process");
/**
* 快速开启子进程
* @param command
* @param cmdParams
* @param options
* @returns
*/
function quickSpawn(command, cmdParams, options = {
    downGradeLog: true,
    onlyPrintWhenError: true,
    prefix: '',
}) {
    return new Promise((resolve, reject) => {
        options.prefix = options.prefix || '';
        const child = (0, child_process_1.spawn)(command, cmdParams, {
            cwd: options?.cwd || undefined,
            env: options?.env,
            ...options,
        });
        let outputData = '';
        function output(type, data) {
            if (options.onlyPrintWhenError) {
                outputData += data;
                return;
            }
            if (type === 'log' && options.downGradeLog) {
                type = 'debug';
            }
            else if (type === 'warn' && options.downGradeWaring) {
                type = 'log';
            }
            else if (type === 'error' && options.downGradeError) {
                type = 'warn';
            }
            console[type](options.prefix + data.toString());
        }
        if (options.logLevel !== undefined && options.logLevel >= 0) {
            child.stdout.on('data', (data) => {
                output('log', data);
            });
        }
        if (options.logLevel !== undefined && options.logLevel >= 1) {
            child.stderr.on('data', (err) => {
                const error = err.toString();
                // 过滤掉空或只有换行的报错
                if (!error || error === '\n') {
                    return;
                }
                output('error', err);
            });
        }
        child.on('close', (code) => {
            if (code !== 0) {
                reject(options.prefix + `Child process exit width code ${code}: ${command} ${cmdParams.toString()}`);
            }
            else {
                resolve(true);
            }
        });
        child.on('error', (err) => {
            outputData && console.debug(options.prefix + 'child process output: ', { outputData });
            console.error(options.prefix + `child process error: ${command} ${cmdParams.toString()}`);
            reject(err);
        });
        child.on('exit', (code) => {
            !options.onlyPrintWhenError && console.debug(options.prefix + `Child process exit width code ${code}`);
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb3JlL2Jhc2UvdXRpbHMvcHJvY2Vzcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQStCQSxnQ0E0REM7QUEzRkQsaURBQW9EO0FBd0JwRDs7Ozs7O0VBTUU7QUFDRixTQUFnQixVQUFVLENBQUMsT0FBZSxFQUFFLFNBQW1CLEVBQUUsVUFBNkI7SUFDMUYsWUFBWSxFQUFFLElBQUk7SUFDbEIsa0JBQWtCLEVBQUUsSUFBSTtJQUN4QixNQUFNLEVBQUUsRUFBRTtDQUNiO0lBQ0csT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUNuQyxPQUFPLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDO1FBQ3RDLE1BQU0sS0FBSyxHQUFHLElBQUEscUJBQUssRUFBQyxPQUFPLEVBQUUsU0FBUyxFQUFFO1lBQ3BDLEdBQUcsRUFBRSxPQUFPLEVBQUUsR0FBRyxJQUFJLFNBQVM7WUFDOUIsR0FBRyxFQUFFLE9BQU8sRUFBRSxHQUFHO1lBQ2pCLEdBQUcsT0FBTztTQUNiLENBQUMsQ0FBQztRQUVILElBQUksVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNwQixTQUFTLE1BQU0sQ0FBQyxJQUF3QyxFQUFFLElBQVk7WUFDbEUsSUFBSSxPQUFPLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztnQkFDN0IsVUFBVSxJQUFJLElBQUksQ0FBQztnQkFDbkIsT0FBTztZQUNYLENBQUM7WUFDRCxJQUFJLElBQUksS0FBSyxLQUFLLElBQUksT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFDO2dCQUN6QyxJQUFJLEdBQUcsT0FBTyxDQUFDO1lBQ25CLENBQUM7aUJBQU0sSUFBSSxJQUFJLEtBQUssTUFBTSxJQUFJLE9BQU8sQ0FBQyxlQUFlLEVBQUUsQ0FBQztnQkFDcEQsSUFBSSxHQUFHLEtBQUssQ0FBQztZQUNqQixDQUFDO2lCQUFNLElBQUksSUFBSSxLQUFLLE9BQU8sSUFBSSxPQUFPLENBQUMsY0FBYyxFQUFFLENBQUM7Z0JBQ3BELElBQUksR0FBRyxNQUFNLENBQUM7WUFDbEIsQ0FBQztZQUNELE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQ3BELENBQUM7UUFDRCxJQUFJLE9BQU8sQ0FBQyxRQUFRLEtBQUssU0FBUyxJQUFJLE9BQU8sQ0FBQyxRQUFRLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDMUQsS0FBSyxDQUFDLE1BQU8sQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUU7Z0JBQzlCLE1BQU0sQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDeEIsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDO1FBQ0QsSUFBSSxPQUFPLENBQUMsUUFBUSxLQUFLLFNBQVMsSUFBSSxPQUFPLENBQUMsUUFBUSxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQzFELEtBQUssQ0FBQyxNQUFPLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFO2dCQUM3QixNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQzdCLGVBQWU7Z0JBQ2YsSUFBSSxDQUFDLEtBQUssSUFBSSxLQUFLLEtBQUssSUFBSSxFQUFFLENBQUM7b0JBQzNCLE9BQU87Z0JBQ1gsQ0FBQztnQkFDRCxNQUFNLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ3pCLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztRQUVELEtBQUssQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUU7WUFDdkIsSUFBSSxJQUFJLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQ2IsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsaUNBQWlDLElBQUksS0FBSyxPQUFPLElBQUksU0FBUyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUN6RyxDQUFDO2lCQUFNLENBQUM7Z0JBQ0osT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2xCLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUNILEtBQUssQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBVSxFQUFFLEVBQUU7WUFDN0IsVUFBVSxJQUFJLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyx3QkFBd0IsRUFBRSxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUM7WUFDdkYsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLHdCQUF3QixPQUFPLElBQUksU0FBUyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUMxRixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDaEIsQ0FBQyxDQUFDLENBQUM7UUFDSCxLQUFLLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ3RCLENBQUMsT0FBTyxDQUFDLGtCQUFrQixJQUFJLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxpQ0FBaUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUMzRyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHNwYXduLCBTcGF3bk9wdGlvbnMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcclxuXHJcbmV4cG9ydCBjb25zdCBlbnVtIExvZ0xldmVsIHtcclxuICAgIExPRyxcclxuICAgIFdBUk4sXHJcbiAgICBFUlJPUixcclxuICAgIE5VTEwsXHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSVF1aWNrU3Bhd25PcHRpb24gZXh0ZW5kcyBTcGF3bk9wdGlvbnMge1xyXG4gICAgY3dkPzogc3RyaW5nO1xyXG4gICAgZW52PzogYW55O1xyXG4gICAgLy8g6L6T5Ye6562J57qn77yM6buY6K6kIGxvZyDnuqfliKvku6XkuIrpg73miZPljbBcclxuICAgIGxvZ0xldmVsPzogTG9nTGV2ZWw7XHJcblxyXG4gICAgZG93bkdyYWRlV2FyaW5nPzogYm9vbGVhbjsgLy8g6K2m5ZGK5bCG5Lya6L2s5Li6IGxvZyDmiZPljbDvvIzpu5jorqTkuLogZmFsc2VcclxuICAgIGRvd25HcmFkZUxvZz86IGJvb2xlYW47IC8vIGxvZyDlsIbkvJrovazkuLogZGVidWcg5omT5Y2w77yM6buY6K6k5Li6IHRydWVcclxuICAgIGRvd25HcmFkZUVycm9yPzogYm9vbGVhbjsgLy8g6ZSZ6K+v5bCG5Lya6L2s5Li66K2m5ZGK5omT5Y2w77yM6buY6K6k5Li6IGZhbHNlXHJcblxyXG4gICAgb25seVByaW50V2hlbkVycm9yPzogYm9vbGVhbjsvLyDml6Xlv5fpg73mraPluLjmlLbpm4bvvIzkvYbku4XlnKjlj5HnlJ/plJnor6/ml7bmiZPljbDkv6Hmga/vvIzlhbbku5bml7blgJnpnZnpu5jlpITnkIZcclxuXHJcbiAgICBwcmVmaXg/OiBzdHJpbmc7IC8vIGxvZyDovpPlh7rliY3nvIBcclxufVxyXG5cclxuLyoqXHJcbiog5b+r6YCf5byA5ZCv5a2Q6L+b56iLXHJcbiogQHBhcmFtIGNvbW1hbmQgXHJcbiogQHBhcmFtIGNtZFBhcmFtcyBcclxuKiBAcGFyYW0gb3B0aW9ucyBcclxuKiBAcmV0dXJucyBcclxuKi9cclxuZXhwb3J0IGZ1bmN0aW9uIHF1aWNrU3Bhd24oY29tbWFuZDogc3RyaW5nLCBjbWRQYXJhbXM6IHN0cmluZ1tdLCBvcHRpb25zOiBJUXVpY2tTcGF3bk9wdGlvbiA9IHtcclxuICAgIGRvd25HcmFkZUxvZzogdHJ1ZSxcclxuICAgIG9ubHlQcmludFdoZW5FcnJvcjogdHJ1ZSxcclxuICAgIHByZWZpeDogJycsXHJcbn0pOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgb3B0aW9ucy5wcmVmaXggPSBvcHRpb25zLnByZWZpeCB8fCAnJztcclxuICAgICAgICBjb25zdCBjaGlsZCA9IHNwYXduKGNvbW1hbmQsIGNtZFBhcmFtcywge1xyXG4gICAgICAgICAgICBjd2Q6IG9wdGlvbnM/LmN3ZCB8fCB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIGVudjogb3B0aW9ucz8uZW52LFxyXG4gICAgICAgICAgICAuLi5vcHRpb25zLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBsZXQgb3V0cHV0RGF0YSA9ICcnO1xyXG4gICAgICAgIGZ1bmN0aW9uIG91dHB1dCh0eXBlOiAnbG9nJyB8ICdkZWJ1ZycgfCAnd2FybicgfCAnZXJyb3InLCBkYXRhOiBCdWZmZXIpIHtcclxuICAgICAgICAgICAgaWYgKG9wdGlvbnMub25seVByaW50V2hlbkVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBvdXRwdXREYXRhICs9IGRhdGE7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdsb2cnICYmIG9wdGlvbnMuZG93bkdyYWRlTG9nKSB7XHJcbiAgICAgICAgICAgICAgICB0eXBlID0gJ2RlYnVnJztcclxuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnd2FybicgJiYgb3B0aW9ucy5kb3duR3JhZGVXYXJpbmcpIHtcclxuICAgICAgICAgICAgICAgIHR5cGUgPSAnbG9nJztcclxuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnZXJyb3InICYmIG9wdGlvbnMuZG93bkdyYWRlRXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIHR5cGUgPSAnd2Fybic7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc29sZVt0eXBlXShvcHRpb25zLnByZWZpeCArIGRhdGEudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvcHRpb25zLmxvZ0xldmVsICE9PSB1bmRlZmluZWQgJiYgb3B0aW9ucy5sb2dMZXZlbCA+PSAwKSB7XHJcbiAgICAgICAgICAgIGNoaWxkLnN0ZG91dCEub24oJ2RhdGEnLCAoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgb3V0cHV0KCdsb2cnLCBkYXRhKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvcHRpb25zLmxvZ0xldmVsICE9PSB1bmRlZmluZWQgJiYgb3B0aW9ucy5sb2dMZXZlbCA+PSAxKSB7XHJcbiAgICAgICAgICAgIGNoaWxkLnN0ZGVyciEub24oJ2RhdGEnLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBlcnJvciA9IGVyci50b1N0cmluZygpO1xyXG4gICAgICAgICAgICAgICAgLy8g6L+H5ruk5o6J56m65oiW5Y+q5pyJ5o2i6KGM55qE5oql6ZSZXHJcbiAgICAgICAgICAgICAgICBpZiAoIWVycm9yIHx8IGVycm9yID09PSAnXFxuJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIG91dHB1dCgnZXJyb3InLCBlcnIpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNoaWxkLm9uKCdjbG9zZScsIChjb2RlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChjb2RlICE9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICByZWplY3Qob3B0aW9ucy5wcmVmaXggKyBgQ2hpbGQgcHJvY2VzcyBleGl0IHdpZHRoIGNvZGUgJHtjb2RlfTogJHtjb21tYW5kfSAke2NtZFBhcmFtcy50b1N0cmluZygpfWApO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNoaWxkLm9uKCdlcnJvcicsIChlcnI6IEVycm9yKSA9PiB7XHJcbiAgICAgICAgICAgIG91dHB1dERhdGEgJiYgY29uc29sZS5kZWJ1ZyhvcHRpb25zLnByZWZpeCArICdjaGlsZCBwcm9jZXNzIG91dHB1dDogJywgeyBvdXRwdXREYXRhIH0pO1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKG9wdGlvbnMucHJlZml4ICsgYGNoaWxkIHByb2Nlc3MgZXJyb3I6ICR7Y29tbWFuZH0gJHtjbWRQYXJhbXMudG9TdHJpbmcoKX1gKTtcclxuICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY2hpbGQub24oJ2V4aXQnLCAoY29kZSkgPT4ge1xyXG4gICAgICAgICAgICAhb3B0aW9ucy5vbmx5UHJpbnRXaGVuRXJyb3IgJiYgY29uc29sZS5kZWJ1ZyhvcHRpb25zLnByZWZpeCArIGBDaGlsZCBwcm9jZXNzIGV4aXQgd2lkdGggY29kZSAke2NvZGV9YCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxufSJdfQ==