"use strict";
/**
 * 提供给 Bundle 一些接口查询的方法
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getAssetPathInfo = getAssetPathInfo;
exports.getJsonPath = getJsonPath;
exports.getImportPathInfo = getImportPathInfo;
exports.resolveImportPath = resolveImportPath;
exports.resolveNativePath = resolveNativePath;
exports.getRawAssetPaths = getRawAssetPaths;
exports.initBundleConfig = initBundleConfig;
const path_1 = require("path");
const asset_library_1 = require("../../manager/asset-library");
const utils_1 = require("../../utils");
const cconb_1 = require("../../utils/cconb");
const asset_1 = __importDefault(require("../../../../../assets/manager/asset"));
const global_1 = require("../../../../share/global");
/**
 * 获取指定 uuid 资源的路径相关信息
 * @return {raw?: string | string[]; json?: string; groupIndex?: number;}
 * @return.raw: 该资源源文件的实际存储位置，存在多个为数组，不存在则为空
 * @return.json: 该资源序列化 json 的实际存储位置，不存在为空
 * @return.groupIndex: 若该资源的序列化 json 在某个 json 分组内，这里标识在分组内的 index，不存在为空
 */
function getAssetPathInfo(uuid, bundle) {
    if (!bundle.containsAsset(uuid, true)) {
        return null;
    }
    const importInfo = getImportPathInfo(uuid, bundle);
    const rawPaths = getRawAssetPaths(uuid, bundle);
    if (!importInfo && (!rawPaths.length)) {
        return null;
    }
    const result = {};
    if (importInfo) {
        Object.assign(result, importInfo);
    }
    rawPaths.length && (result.raw = rawPaths);
    return result;
}
function getJsonPath(uuid, bundle) {
    return getImportPathInfo(uuid, bundle)?.json || '';
}
/**
 * 指定 uuid 资源的序列化 json 在 bundle 构建后的信息
 * @param uuid
 * @param bundle
 */
function getImportPathInfo(uuid, bundle) {
    if (!bundle.containsAsset(uuid)) {
        return null;
    }
    const assetInfo = asset_library_1.buildAssetLibrary.getAsset(uuid);
    // 资源信息存在，且不存在 json 信息或者不是 cconb 类型则直接返回
    if (!assetInfo) {
        return null;
    }
    const extName = getImportExtName(assetInfo);
    if (!extName) {
        return null;
    }
    const group = bundle.groups.find((group) => group.uuids.includes(uuid));
    const path = resolveImportPath(group ? group.name : uuid, bundle, extName);
    if (!group) {
        return {
            import: path,
            [extName.replace('.', '')]: path,
        };
    }
    return {
        import: path,
        [extName.replace('.', '')]: path,
        groupIndex: group.uuids.indexOf(uuid),
    };
}
function resolveImportPath(name, bundle, extName) {
    return (0, utils_1.getResImportPath)(bundle.dest, name + (bundle.assetVer.import[name] ? '.' + bundle.assetVer.import[name] : ''), extName);
}
function resolveNativePath(libraryPath, extName, bundle) {
    const uuid = (0, path_1.basename)(libraryPath, extName);
    const version = bundle.assetVer.native[uuid];
    const path = libraryPath.replace((0, utils_1.getLibraryDir)(libraryPath), (0, path_1.join)(bundle.dest, global_1.BuildGlobalInfo.NATIVE_HEADER));
    return version ? path.replace(extName, `.${version}${extName}`) : path;
}
function getImportExtName(asset) {
    if ((0, cconb_1.hasCCONFormatAssetInLibrary)(asset)) {
        return '.bin';
    }
    else if (asset.meta.files.includes('.json')) {
        return '.json';
    }
    return '';
}
/**
 * 获取指定 uuid 原始资源的存放路径（不包括序列化 json）
 * 自动图集的小图 uuid 和自动图集的 uuid 都将会查询到合图大图的生成路径
 * 实际返回多个路径的情况：查询 uuid 为自动图集资源，且对应图集生成多张大图，纹理压缩会有多个图片格式路径
 */
function getRawAssetPaths(uuid, bundle) {
    // 图集资源的查询方式比较特殊，图集的序列化资源可能被剔除，但是原图需要能被查询到
    if (!bundle.containsAsset(uuid, true)) {
        return [];
    }
    const assetInfo = asset_library_1.buildAssetLibrary.getAsset(uuid);
    if (!assetInfo) {
        console.error(`Can't get assetInfo of uuid {asset(${uuid})}`);
        return [];
    }
    const importExtName = getImportExtName(assetInfo);
    const extNames = assetInfo.meta.files.filter((name) => name !== importExtName);
    // 过滤已生成到 import 内的数据
    const assetType = asset_1.default.queryAssetProperty(assetInfo, 'type');
    if (assetType === 'cc.Script') {
        return [bundle.scriptDest];
    }
    if (assetType === 'cc.ImageAsset' && bundle.compressRes[uuid]) {
        const version = bundle.assetVer.native[uuid];
        return bundle.compressRes[uuid].map(path => path.replace(uuid, version ? `${uuid}.${version}` : ''));
    }
    // ------------------- 处理合图资源的路径信息 -------------------
    if (['cc.ImageAsset', 'cc.SpriteFrame', 'cc.SpriteAtlas'].includes(assetType)) {
        const imageUuids = (bundle.atlasRes.assetsToImage[uuid] ? [bundle.atlasRes.assetsToImage[uuid]] : bundle.atlasRes.atlasToImages[uuid]) || [];
        if (imageUuids.length) {
            const rawPaths = [];
            for (const imageUuid of imageUuids) {
                if (!imageUuid || !bundle.containsAsset(imageUuid)) {
                    continue;
                }
                const version = bundle.assetVer.native[imageUuid];
                if (bundle.compressRes[imageUuid]) {
                    rawPaths.push(...bundle.compressRes[imageUuid].map(path => {
                        // 由于有图集，最终输出的 uuid 地址与原始资源可能不一样
                        const imageUuid = (0, utils_1.getUuidFromPath)(path);
                        return path.replace(imageUuid, version ? `${imageUuid}.${version}` : '');
                    }));
                    continue;
                }
                rawPaths.push((0, utils_1.getResRawAssetsPath)(bundle.dest, imageUuid, version ? `.${version}.png` : '.png'));
            }
            return rawPaths;
        }
    }
    // ----------------- ttf 资源 md5 是加在文件夹上 -----------------
    if (assetType === 'cc.TTFFont' && bundle.assetVer.native[uuid]) {
        return extNames.map((extName) => {
            return (0, utils_1.getResRawAssetsPath)(bundle.dest, `${uuid}.${bundle.assetVer.native[uuid]}/`, extName);
        });
    }
    if (!extNames.length) {
        return [];
    }
    return extNames.map((extName) => {
        return resolveNativePath(assetInfo.library + extName, extName, bundle);
    });
}
/**
 * 由于资源支持文件夹、以及一些特殊的父资源，需要先转换一下配置再走常规的过滤确认方法，常规的过滤方法目前有单元测试保障正确性
 * @param bundleConfigs
 * @returns
 */
function initBundleConfig(bundleConfigs) {
    if (!bundleConfigs || !bundleConfigs.length) {
        return [];
    }
    // 资源进程内获取 meta 数据后的处理如果涉及到数据修改的，需要深拷贝，否则会影响源数据
    const configs = JSON.parse(JSON.stringify(bundleConfigs));
    const newConfigs = [];
    for (const config of configs) {
        if (config.type === 'url' || !config.assets || !config.assets.length) {
            newConfigs.push(config);
            continue;
        }
        const addAssets = new Set();
        const directory = new Set();
        for (const uuid of config.assets) {
            const asset = uuid && asset_1.default.queryAsset(uuid);
            if (!asset) {
                continue;
            }
            // 文件夹直接转换为 url 配置
            if (asset.isDirectory()) {
                newConfigs.push({
                    type: 'url',
                    range: config.range,
                    patchOption: {
                        patchType: 'glob',
                        value: asset.url + '/**/*',
                    },
                });
                directory.add(asset.uuid);
                continue;
            }
            if (asset_1.default.queryAssetProperty(asset, 'type') === 'cc.Texture2D') {
                // texture 与 image 目前在编辑器界面是统一的无法分开配置，过滤配置存在 texture 需要将 image 一起剔除
                const fatherAsset = asset_1.default.queryAsset(uuid.replace('@6c48a', ''));
                if (asset_1.default.queryAssetProperty(fatherAsset, 'type') === 'cc.ImageAsset') {
                    addAssets.add(fatherAsset.uuid);
                }
            }
            // 配置父资源时，子资源也将参与对应的规则
            if (asset.subAssets) {
                Object.values(asset.subAssets).forEach((asset) => {
                    addAssets.add(asset.uuid);
                });
            }
        }
        // 剔除文件夹 uuid
        config.assets = config.assets.filter((uuid) => !directory.has(uuid));
        config.assets.push(...Array.from(addAssets));
        // 如果剔除文件夹或者其他资源后，assets 为空，则此配置无效
        if (config.assets.length) {
            newConfigs.push(config);
        }
    }
    return newConfigs;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9idWlsZGVyL3dvcmtlci9idWlsZGVyL2Fzc2V0LWhhbmRsZXIvYnVuZGxlL3V0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7Ozs7QUFtQkgsNENBZ0JDO0FBRUQsa0NBRUM7QUFPRCw4Q0EyQkM7QUFFRCw4Q0FFQztBQUVELDhDQU1DO0FBZ0JELDRDQTREQztBQU9ELDRDQTBEQztBQWhPRCwrQkFBc0M7QUFDdEMsK0RBQWdFO0FBQ2hFLHVDQUFvRztBQUNwRyw2Q0FBZ0U7QUFJaEUsZ0ZBQStEO0FBQy9ELHFEQUEyRDtBQUUzRDs7Ozs7O0dBTUc7QUFDSCxTQUFnQixnQkFBZ0IsQ0FBQyxJQUFZLEVBQUUsTUFBZTtJQUMxRCxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQztRQUNwQyxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBQ0QsTUFBTSxVQUFVLEdBQUcsaUJBQWlCLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ25ELE1BQU0sUUFBUSxHQUFHLGdCQUFnQixDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNoRCxJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztRQUNwQyxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBQ0QsTUFBTSxNQUFNLEdBQW1CLEVBQUUsQ0FBQztJQUNsQyxJQUFJLFVBQVUsRUFBRSxDQUFDO1FBQ2IsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUVELFFBQVEsQ0FBQyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxHQUFHLFFBQVEsQ0FBQyxDQUFDO0lBQzNDLE9B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LE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDckUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDN0Msa0NBQWtDO1FBQ2xDLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUN2QixVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzVCLENBQUM7SUFDTCxDQUFDO0lBRUQsT0FBTyxVQUFVLENBQUM7QUFDdEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiDmj5Dkvpvnu5kgQnVuZGxlIOS4gOS6m+aOpeWPo+afpeivoueahOaWueazlVxyXG4gKi9cclxuXHJcbmltcG9ydCB7IGJhc2VuYW1lLCBqb2luIH0gZnJvbSAncGF0aCc7XHJcbmltcG9ydCB7IGJ1aWxkQXNzZXRMaWJyYXJ5IH0gZnJvbSAnLi4vLi4vbWFuYWdlci9hc3NldC1saWJyYXJ5JztcclxuaW1wb3J0IHsgZ2V0TGlicmFyeURpciwgZ2V0UmVzSW1wb3J0UGF0aCwgZ2V0UmVzUmF3QXNzZXRzUGF0aCwgZ2V0VXVpZEZyb21QYXRoIH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xyXG5pbXBvcnQgeyBoYXNDQ09ORm9ybWF0QXNzZXRJbkxpYnJhcnkgfSBmcm9tICcuLi8uLi91dGlscy9jY29uYic7XHJcbmltcG9ydCB7IElBc3NldCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uL2Fzc2V0cy9AdHlwZXMvcHJvdGVjdGVkJztcclxuaW1wb3J0IHsgSUFzc2V0UGF0aEluZm8sIElJbXBvcnRBc3NldFBhdGhJbmZvIH0gZnJvbSAnLi4vLi4vLi4vLi4vQHR5cGVzJztcclxuaW1wb3J0IHsgQnVuZGxlRmlsdGVyQ29uZmlnLCBJQnVuZGxlIH0gZnJvbSAnLi4vLi4vLi4vLi4vQHR5cGVzL3Byb3RlY3RlZCc7XHJcbmltcG9ydCBhc3NldE1hbmFnZXIgZnJvbSAnLi4vLi4vLi4vLi4vLi4vYXNzZXRzL21hbmFnZXIvYXNzZXQnO1xyXG5pbXBvcnQgeyBCdWlsZEdsb2JhbEluZm8gfSBmcm9tICcuLi8uLi8uLi8uLi9zaGFyZS9nbG9iYWwnO1xyXG5cclxuLyoqXHJcbiAqIOiOt+WPluaMh+WumiB1dWlkIOi1hOa6kOeahOi3r+W+hOebuOWFs+S/oeaBr1xyXG4gKiBAcmV0dXJuIHtyYXc/OiBzdHJpbmcgfCBzdHJpbmdbXTsganNvbj86IHN0cmluZzsgZ3JvdXBJbmRleD86IG51bWJlcjt9XHJcbiAqIEByZXR1cm4ucmF3OiDor6XotYTmupDmupDmlofku7bnmoTlrp7pmYXlrZjlgqjkvY3nva7vvIzlrZjlnKjlpJrkuKrkuLrmlbDnu4TvvIzkuI3lrZjlnKjliJnkuLrnqbpcclxuICogQHJldHVybi5qc29uOiDor6XotYTmupDluo/liJfljJYganNvbiDnmoTlrp7pmYXlrZjlgqjkvY3nva7vvIzkuI3lrZjlnKjkuLrnqbpcclxuICogQHJldHVybi5ncm91cEluZGV4OiDoi6Xor6XotYTmupDnmoTluo/liJfljJYganNvbiDlnKjmn5DkuKoganNvbiDliIbnu4TlhoXvvIzov5nph4zmoIfor4blnKjliIbnu4TlhoXnmoQgaW5kZXjvvIzkuI3lrZjlnKjkuLrnqbpcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRBc3NldFBhdGhJbmZvKHV1aWQ6IHN0cmluZywgYnVuZGxlOiBJQnVuZGxlKTogSUFzc2V0UGF0aEluZm8gfCBudWxsIHtcclxuICAgIGlmICghYnVuZGxlLmNvbnRhaW5zQXNzZXQodXVpZCwgdHJ1ZSkpIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IGltcG9ydEluZm8gPSBnZXRJbXBvcnRQYXRoSW5mbyh1dWlkLCBidW5kbGUpO1xyXG4gICAgY29uc3QgcmF3UGF0aHMgPSBnZXRSYXdBc3NldFBhdGhzKHV1aWQsIGJ1bmRsZSk7XHJcbiAgICBpZiAoIWltcG9ydEluZm8gJiYgKCFyYXdQYXRocy5sZW5ndGgpKSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXN1bHQ6IElBc3NldFBhdGhJbmZvID0ge307XHJcbiAgICBpZiAoaW1wb3J0SW5mbykge1xyXG4gICAgICAgIE9iamVjdC5hc3NpZ24ocmVzdWx0LCBpbXBvcnRJbmZvKTtcclxuICAgIH1cclxuXHJcbiAgICByYXdQYXRocy5sZW5ndGggJiYgKHJlc3VsdC5yYXcgPSByYXdQYXRocyk7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0SnNvblBhdGgodXVpZDogc3RyaW5nLCBidW5kbGU6IElCdW5kbGUpIHtcclxuICAgIHJldHVybiBnZXRJbXBvcnRQYXRoSW5mbyh1dWlkLCBidW5kbGUpPy5qc29uIHx8ICcnO1xyXG59XHJcblxyXG4vKipcclxuICog5oyH5a6aIHV1aWQg6LWE5rqQ55qE5bqP5YiX5YyWIGpzb24g5ZyoIGJ1bmRsZSDmnoTlu7rlkI7nmoTkv6Hmga9cclxuICogQHBhcmFtIHV1aWRcclxuICogQHBhcmFtIGJ1bmRsZVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEltcG9ydFBhdGhJbmZvKHV1aWQ6IHN0cmluZywgYnVuZGxlOiBJQnVuZGxlKTogSUltcG9ydEFzc2V0UGF0aEluZm8gfCBudWxsIHtcclxuICAgIGlmICghYnVuZGxlLmNvbnRhaW5zQXNzZXQodXVpZCkpIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBhc3NldEluZm8gPSBidWlsZEFzc2V0TGlicmFyeS5nZXRBc3NldCh1dWlkKTtcclxuICAgIC8vIOi1hOa6kOS/oeaBr+WtmOWcqO+8jOS4lOS4jeWtmOWcqCBqc29uIOS/oeaBr+aIluiAheS4jeaYryBjY29uYiDnsbvlnovliJnnm7TmjqXov5Tlm55cclxuICAgIGlmICghYXNzZXRJbmZvKSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCBleHROYW1lID0gZ2V0SW1wb3J0RXh0TmFtZShhc3NldEluZm8pO1xyXG4gICAgaWYgKCFleHROYW1lKSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCBncm91cCA9IGJ1bmRsZS5ncm91cHMuZmluZCgoZ3JvdXApID0+IGdyb3VwLnV1aWRzLmluY2x1ZGVzKHV1aWQpKTtcclxuICAgIGNvbnN0IHBhdGggPSByZXNvbHZlSW1wb3J0UGF0aChncm91cCA/IGdyb3VwLm5hbWUgOiB1dWlkLCBidW5kbGUsIGV4dE5hbWUpO1xyXG4gICAgaWYgKCFncm91cCkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGltcG9ydDogcGF0aCxcclxuICAgICAgICAgICAgW2V4dE5hbWUucmVwbGFjZSgnLicsICcnKV06IHBhdGgsXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgaW1wb3J0OiBwYXRoLFxyXG4gICAgICAgIFtleHROYW1lLnJlcGxhY2UoJy4nLCAnJyldOiBwYXRoLFxyXG4gICAgICAgIGdyb3VwSW5kZXg6IGdyb3VwLnV1aWRzLmluZGV4T2YodXVpZCksXHJcbiAgICB9O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmVzb2x2ZUltcG9ydFBhdGgobmFtZTogc3RyaW5nLCBidW5kbGU6IElCdW5kbGUsIGV4dE5hbWU/OiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBnZXRSZXNJbXBvcnRQYXRoKGJ1bmRsZS5kZXN0LCBuYW1lICsgKGJ1bmRsZS5hc3NldFZlci5pbXBvcnRbbmFtZV0gPyAnLicgKyBidW5kbGUuYXNzZXRWZXIuaW1wb3J0W25hbWVdIDogJycpLCBleHROYW1lKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHJlc29sdmVOYXRpdmVQYXRoKGxpYnJhcnlQYXRoOiBzdHJpbmcsIGV4dE5hbWU6IHN0cmluZywgYnVuZGxlOiBJQnVuZGxlKSB7XHJcbiAgICBjb25zdCB1dWlkID0gYmFzZW5hbWUobGlicmFyeVBhdGgsIGV4dE5hbWUpO1xyXG4gICAgY29uc3QgdmVyc2lvbiA9IGJ1bmRsZS5hc3NldFZlci5uYXRpdmVbdXVpZF07XHJcblxyXG4gICAgY29uc3QgcGF0aCA9IGxpYnJhcnlQYXRoLnJlcGxhY2UoZ2V0TGlicmFyeURpcihsaWJyYXJ5UGF0aCksIGpvaW4oYnVuZGxlLmRlc3QsIEJ1aWxkR2xvYmFsSW5mby5OQVRJVkVfSEVBREVSKSk7XHJcbiAgICByZXR1cm4gdmVyc2lvbiA/IHBhdGgucmVwbGFjZShleHROYW1lLCBgLiR7dmVyc2lvbn0ke2V4dE5hbWV9YCkgOiBwYXRoO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRJbXBvcnRFeHROYW1lKGFzc2V0OiBJQXNzZXQpOiBzdHJpbmcge1xyXG4gICAgaWYgKGhhc0NDT05Gb3JtYXRBc3NldEluTGlicmFyeShhc3NldCkpIHtcclxuICAgICAgICByZXR1cm4gJy5iaW4nO1xyXG4gICAgfSBlbHNlIGlmIChhc3NldC5tZXRhLmZpbGVzLmluY2x1ZGVzKCcuanNvbicpKSB7XHJcbiAgICAgICAgcmV0dXJuICcuanNvbic7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gJyc7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDojrflj5bmjIflrpogdXVpZCDljp/lp4votYTmupDnmoTlrZjmlL7ot6/lvoTvvIjkuI3ljIXmi6zluo/liJfljJYganNvbu+8iVxyXG4gKiDoh6rliqjlm77pm4bnmoTlsI/lm74gdXVpZCDlkozoh6rliqjlm77pm4bnmoQgdXVpZCDpg73lsIbkvJrmn6Xor6LliLDlkIjlm77lpKflm77nmoTnlJ/miJDot6/lvoRcclxuICog5a6e6ZmF6L+U5Zue5aSa5Liq6Lev5b6E55qE5oOF5Ya177ya5p+l6K+iIHV1aWQg5Li66Ieq5Yqo5Zu+6ZuG6LWE5rqQ77yM5LiU5a+55bqU5Zu+6ZuG55Sf5oiQ5aSa5byg5aSn5Zu+77yM57q555CG5Y6L57yp5Lya5pyJ5aSa5Liq5Zu+54mH5qC85byP6Lev5b6EXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmF3QXNzZXRQYXRocyh1dWlkOiBzdHJpbmcsIGJ1bmRsZTogSUJ1bmRsZSk6IHN0cmluZ1tdIHtcclxuICAgIC8vIOWbvumbhui1hOa6kOeahOafpeivouaWueW8j+avlOi+g+eJueauiu+8jOWbvumbhueahOW6j+WIl+WMlui1hOa6kOWPr+iDveiiq+WJlOmZpO+8jOS9huaYr+WOn+WbvumcgOimgeiDveiiq+afpeivouWIsFxyXG4gICAgaWYgKCFidW5kbGUuY29udGFpbnNBc3NldCh1dWlkLCB0cnVlKSkge1xyXG4gICAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuICAgIGNvbnN0IGFzc2V0SW5mbyA9IGJ1aWxkQXNzZXRMaWJyYXJ5LmdldEFzc2V0KHV1aWQpO1xyXG4gICAgaWYgKCFhc3NldEluZm8pIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKGBDYW4ndCBnZXQgYXNzZXRJbmZvIG9mIHV1aWQge2Fzc2V0KCR7dXVpZH0pfWApO1xyXG4gICAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBpbXBvcnRFeHROYW1lID0gZ2V0SW1wb3J0RXh0TmFtZShhc3NldEluZm8pO1xyXG4gICAgY29uc3QgZXh0TmFtZXMgPSBhc3NldEluZm8ubWV0YS5maWxlcy5maWx0ZXIoKG5hbWUpID0+IG5hbWUgIT09IGltcG9ydEV4dE5hbWUpO1xyXG4gICAgLy8g6L+H5ruk5bey55Sf5oiQ5YiwIGltcG9ydCDlhoXnmoTmlbDmja5cclxuICAgIGNvbnN0IGFzc2V0VHlwZSA9IGFzc2V0TWFuYWdlci5xdWVyeUFzc2V0UHJvcGVydHkoYXNzZXRJbmZvLCAndHlwZScpO1xyXG4gICAgaWYgKGFzc2V0VHlwZSA9PT0gJ2NjLlNjcmlwdCcpIHtcclxuICAgICAgICByZXR1cm4gW2J1bmRsZS5zY3JpcHREZXN0XTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoYXNzZXRUeXBlID09PSAnY2MuSW1hZ2VBc3NldCcgJiYgYnVuZGxlLmNvbXByZXNzUmVzW3V1aWRdKSB7XHJcbiAgICAgICAgY29uc3QgdmVyc2lvbiA9IGJ1bmRsZS5hc3NldFZlci5uYXRpdmVbdXVpZF07XHJcbiAgICAgICAgcmV0dXJuIGJ1bmRsZS5jb21wcmVzc1Jlc1t1dWlkXS5tYXAocGF0aCA9PiBwYXRoLnJlcGxhY2UodXVpZCwgdmVyc2lvbiA/IGAke3V1aWR9LiR7dmVyc2lvbn1gIDogJycpKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tIOWkhOeQhuWQiOWbvui1hOa6kOeahOi3r+W+hOS/oeaBryAtLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiAgICBpZiAoWydjYy5JbWFnZUFzc2V0JywgJ2NjLlNwcml0ZUZyYW1lJywgJ2NjLlNwcml0ZUF0bGFzJ10uaW5jbHVkZXMoYXNzZXRUeXBlKSkge1xyXG4gICAgICAgIGNvbnN0IGltYWdlVXVpZHMgPSAoYnVuZGxlLmF0bGFzUmVzLmFzc2V0c1RvSW1hZ2VbdXVpZF0gPyBbYnVuZGxlLmF0bGFzUmVzLmFzc2V0c1RvSW1hZ2VbdXVpZF1dIDogYnVuZGxlLmF0bGFzUmVzLmF0bGFzVG9JbWFnZXNbdXVpZF0pIHx8IFtdO1xyXG4gICAgICAgIGlmIChpbWFnZVV1aWRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBjb25zdCByYXdQYXRoczogc3RyaW5nW10gPSBbXTtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBpbWFnZVV1aWQgb2YgaW1hZ2VVdWlkcykge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFpbWFnZVV1aWQgfHwgIWJ1bmRsZS5jb250YWluc0Fzc2V0KGltYWdlVXVpZCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNvbnN0IHZlcnNpb24gPSBidW5kbGUuYXNzZXRWZXIubmF0aXZlW2ltYWdlVXVpZF07XHJcbiAgICAgICAgICAgICAgICBpZiAoYnVuZGxlLmNvbXByZXNzUmVzW2ltYWdlVXVpZF0pIHtcclxuICAgICAgICAgICAgICAgICAgICByYXdQYXRocy5wdXNoKC4uLmJ1bmRsZS5jb21wcmVzc1Jlc1tpbWFnZVV1aWRdLm1hcChwYXRoID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8g55Sx5LqO5pyJ5Zu+6ZuG77yM5pyA57uI6L6T5Ye655qEIHV1aWQg5Zyw5Z2A5LiO5Y6f5aeL6LWE5rqQ5Y+v6IO95LiN5LiA5qC3XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGltYWdlVXVpZCA9IGdldFV1aWRGcm9tUGF0aChwYXRoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhdGgucmVwbGFjZShpbWFnZVV1aWQsIHZlcnNpb24gPyBgJHtpbWFnZVV1aWR9LiR7dmVyc2lvbn1gIDogJycpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJhd1BhdGhzLnB1c2goZ2V0UmVzUmF3QXNzZXRzUGF0aChidW5kbGUuZGVzdCwgaW1hZ2VVdWlkLCB2ZXJzaW9uID8gYC4ke3ZlcnNpb259LnBuZ2AgOiAnLnBuZycpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gcmF3UGF0aHM7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tIHR0ZiDotYTmupAgbWQ1IOaYr+WKoOWcqOaWh+S7tuWkueS4iiAtLS0tLS0tLS0tLS0tLS0tLVxyXG4gICAgaWYgKGFzc2V0VHlwZSA9PT0gJ2NjLlRURkZvbnQnICYmIGJ1bmRsZS5hc3NldFZlci5uYXRpdmVbdXVpZF0pIHtcclxuICAgICAgICByZXR1cm4gZXh0TmFtZXMubWFwKChleHROYW1lKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBnZXRSZXNSYXdBc3NldHNQYXRoKGJ1bmRsZS5kZXN0LCBgJHt1dWlkfS4ke2J1bmRsZS5hc3NldFZlci5uYXRpdmVbdXVpZF19L2AsIGV4dE5hbWUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKCFleHROYW1lcy5sZW5ndGgpIHtcclxuICAgICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZXh0TmFtZXMubWFwKChleHROYW1lKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHJlc29sdmVOYXRpdmVQYXRoKGFzc2V0SW5mby5saWJyYXJ5ICsgZXh0TmFtZSwgZXh0TmFtZSwgYnVuZGxlKTtcclxuICAgIH0pO1xyXG59XHJcblxyXG4vKipcclxuICog55Sx5LqO6LWE5rqQ5pSv5oyB5paH5Lu25aS544CB5Lul5Y+K5LiA5Lqb54m55q6K55qE54i26LWE5rqQ77yM6ZyA6KaB5YWI6L2s5o2i5LiA5LiL6YWN572u5YaN6LWw5bi46KeE55qE6L+H5ruk56Gu6K6k5pa55rOV77yM5bi46KeE55qE6L+H5ruk5pa55rOV55uu5YmN5pyJ5Y2V5YWD5rWL6K+V5L+d6Zqc5q2j56Gu5oCnXHJcbiAqIEBwYXJhbSBidW5kbGVDb25maWdzIFxyXG4gKiBAcmV0dXJucyBcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBpbml0QnVuZGxlQ29uZmlnKGJ1bmRsZUNvbmZpZ3M/OiBCdW5kbGVGaWx0ZXJDb25maWdbXSk6IEJ1bmRsZUZpbHRlckNvbmZpZ1tdIHtcclxuICAgIGlmICghYnVuZGxlQ29uZmlncyB8fCAhYnVuZGxlQ29uZmlncy5sZW5ndGgpIHtcclxuICAgICAgICByZXR1cm4gW107XHJcbiAgICB9XHJcbiAgICAvLyDotYTmupDov5vnqIvlhoXojrflj5YgbWV0YSDmlbDmja7lkI7nmoTlpITnkIblpoLmnpzmtonlj4rliLDmlbDmja7kv67mlLnnmoTvvIzpnIDopoHmt7Hmi7fotJ3vvIzlkKbliJnkvJrlvbHlk43mupDmlbDmja5cclxuICAgIGNvbnN0IGNvbmZpZ3M6IEJ1bmRsZUZpbHRlckNvbmZpZ1tdID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShidW5kbGVDb25maWdzKSk7XHJcbiAgICBjb25zdCBuZXdDb25maWdzOiBCdW5kbGVGaWx0ZXJDb25maWdbXSA9IFtdO1xyXG4gICAgZm9yIChjb25zdCBjb25maWcgb2YgY29uZmlncykge1xyXG4gICAgICAgIGlmIChjb25maWcudHlwZSA9PT0gJ3VybCcgfHwgIWNvbmZpZy5hc3NldHMgfHwgIWNvbmZpZy5hc3NldHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIG5ld0NvbmZpZ3MucHVzaChjb25maWcpO1xyXG4gICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgYWRkQXNzZXRzOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTtcclxuICAgICAgICBjb25zdCBkaXJlY3RvcnkgPSBuZXcgU2V0KCk7XHJcbiAgICAgICAgZm9yIChjb25zdCB1dWlkIG9mIGNvbmZpZy5hc3NldHMpIHtcclxuICAgICAgICAgICAgY29uc3QgYXNzZXQgPSB1dWlkICYmIGFzc2V0TWFuYWdlci5xdWVyeUFzc2V0KHV1aWQpO1xyXG4gICAgICAgICAgICBpZiAoIWFzc2V0KSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyDmlofku7blpLnnm7TmjqXovazmjaLkuLogdXJsIOmFjee9rlxyXG4gICAgICAgICAgICBpZiAoYXNzZXQuaXNEaXJlY3RvcnkoKSkge1xyXG4gICAgICAgICAgICAgICAgbmV3Q29uZmlncy5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiAndXJsJyxcclxuICAgICAgICAgICAgICAgICAgICByYW5nZTogY29uZmlnLnJhbmdlLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhdGNoT3B0aW9uOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhdGNoVHlwZTogJ2dsb2InLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogYXNzZXQudXJsICsgJy8qKi8qJyxcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBkaXJlY3RvcnkuYWRkKGFzc2V0LnV1aWQpO1xyXG4gICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChhc3NldE1hbmFnZXIucXVlcnlBc3NldFByb3BlcnR5KGFzc2V0LCAndHlwZScpID09PSAnY2MuVGV4dHVyZTJEJykge1xyXG4gICAgICAgICAgICAgICAgLy8gdGV4dHVyZSDkuI4gaW1hZ2Ug55uu5YmN5Zyo57yW6L6R5Zmo55WM6Z2i5piv57uf5LiA55qE5peg5rOV5YiG5byA6YWN572u77yM6L+H5ruk6YWN572u5a2Y5ZyoIHRleHR1cmUg6ZyA6KaB5bCGIGltYWdlIOS4gOi1t+WJlOmZpFxyXG4gICAgICAgICAgICAgICAgY29uc3QgZmF0aGVyQXNzZXQgPSBhc3NldE1hbmFnZXIucXVlcnlBc3NldCh1dWlkLnJlcGxhY2UoJ0A2YzQ4YScsICcnKSkhO1xyXG4gICAgICAgICAgICAgICAgaWYgKGFzc2V0TWFuYWdlci5xdWVyeUFzc2V0UHJvcGVydHkoZmF0aGVyQXNzZXQsICd0eXBlJykgPT09ICdjYy5JbWFnZUFzc2V0Jykge1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZEFzc2V0cy5hZGQoZmF0aGVyQXNzZXQudXVpZCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIOmFjee9rueItui1hOa6kOaXtu+8jOWtkOi1hOa6kOS5n+WwhuWPguS4juWvueW6lOeahOinhOWImVxyXG4gICAgICAgICAgICBpZiAoYXNzZXQuc3ViQXNzZXRzKSB7XHJcbiAgICAgICAgICAgICAgICBPYmplY3QudmFsdWVzKGFzc2V0LnN1YkFzc2V0cykuZm9yRWFjaCgoYXNzZXQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZEFzc2V0cy5hZGQoYXNzZXQudXVpZCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDliZTpmaTmlofku7blpLkgdXVpZFxyXG4gICAgICAgIGNvbmZpZy5hc3NldHMgPSBjb25maWcuYXNzZXRzLmZpbHRlcigodXVpZCkgPT4gIWRpcmVjdG9yeS5oYXModXVpZCkpO1xyXG4gICAgICAgIGNvbmZpZy5hc3NldHMucHVzaCguLi5BcnJheS5mcm9tKGFkZEFzc2V0cykpO1xyXG4gICAgICAgIC8vIOWmguaenOWJlOmZpOaWh+S7tuWkueaIluiAheWFtuS7lui1hOa6kOWQju+8jGFzc2V0cyDkuLrnqbrvvIzliJnmraTphY3nva7ml6DmlYhcclxuICAgICAgICBpZiAoY29uZmlnLmFzc2V0cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgbmV3Q29uZmlncy5wdXNoKGNvbmZpZyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBuZXdDb25maWdzO1xyXG59XHJcbiJdfQ==