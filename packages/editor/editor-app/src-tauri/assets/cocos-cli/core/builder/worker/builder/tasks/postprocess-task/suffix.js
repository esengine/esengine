'use strict';
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.name = exports.title = void 0;
exports.handle = handle;
const path_1 = require("path");
const script_1 = require("../../asset-handler/script");
const crypto_1 = require("crypto");
const fs_extra_1 = require("fs-extra");
const md5_cache_handler_1 = require("./md5-cache-handler");
const asset_1 = __importDefault(require("../../../../../assets/manager/asset"));
const utils_1 = require("../../utils");
exports.title = 'i18n:builder.tasks.build_suffix';
exports.name = 'build-task/suffix';
/**
 * 根据分组信息内的 json 数据，合并后打包到指定位置
 * @param options
 * @param settings
 */
async function handle(options, result, cache) {
    if (!options.md5Cache) {
        return;
    }
    // 自动替换主要为了替换构建模板内的文件引用，如不存在模板文件无需额外扫描处理
    if (options.md5CacheOptions.handleTemplateMd5Link && this.buildTemplate.isEnable) {
        // 自动给其他根目录以及 src 目录下的第一层文件添加 hash 值，并替换其他未被处理文件内的路径引用
        options.md5CacheOptions.includes.push('*', 'src/*');
    }
    const md5Cache = new md5_cache_handler_1.md5CacheHandler(result.paths.dir, options.md5CacheOptions);
    // 给插件脚本加上 md5，并更新数据
    for (let i = 0; i < result.settings.plugins.jsList.length; i++) {
        const pluginUrl = result.settings.plugins.jsList[i];
        const pluginUuid = asset_1.default.url2uuid('db://' + pluginUrl);
        const pluginPath = result.paths.plugins[pluginUuid];
        const newPath = await md5Cache.addMd5ToPath(pluginPath);
        result.settings.plugins.jsList[i] = pluginUrl.replace((0, path_1.basename)(pluginPath), (0, path_1.basename)(newPath));
    }
    // 给引擎脚本加上 md5
    for (const key of Object.keys(result.importMap.imports)) {
        const dirName = (0, path_1.dirname)(result.paths.importMap);
        const value = result.importMap.imports[key];
        // import map 可能映射到另一个虚拟模块，而不是相对路径
        if (!value.startsWith('.')) {
            continue;
        }
        const dest = (0, path_1.join)(dirName, value);
        const newPath = await md5Cache.addMd5ToPath(dest);
        result.importMap.imports[key] = `./${(0, utils_1.relativeUrl)(dirName, newPath)}`;
    }
    // 存在 md5 需要重新生成 import-map 数据
    await script_1.ScriptBuilder.outputImportMap(result.importMap, {
        dest: result.paths.importMap,
        importMapFormat: options.buildScriptParam.importMapFormat,
        debug: options.debug,
    });
    result.paths.importMap = await md5Cache.addMd5ToPath(result.paths.importMap);
    // 给一些独立脚本加上 md5
    if (result.paths.polyfillsJs) {
        result.paths.polyfillsJs = await md5Cache.addMd5ToPath(result.paths.polyfillsJs);
    }
    if (result.paths.systemJs) {
        result.paths.systemJs = await md5Cache.addMd5ToPath(result.paths.systemJs);
    }
    // 给 scriptPackages 里的脚本加上 md5，未记录到 import-map 内的处理需要加到
    for (let i = 0; i < result.scriptPackages.length; i++) {
        const dest = result.scriptPackages[i];
        const newPath = await md5Cache.addMd5ToPath(dest);
        result.scriptPackages[i] = newPath;
        // 更新 settings 内记录的数据
        result.settings.scripting.scriptPackages[i] = result.settings.scripting.scriptPackages[i].replace((0, path_1.basename)(dest), (0, path_1.basename)(newPath));
    }
    // 给 settings.json 加上 md5
    const settings = result.settings;
    const bundles = this.bundleManager.bundles.filter((bundle) => bundle.output).sort((a, b) => a.name.localeCompare(b.name));
    for (const bundle of bundles) {
        settings.assets.bundleVers[bundle.name] = bundle.version;
    }
    const cryptoHash = (0, crypto_1.createHash)('md5');
    cryptoHash.update(JSON.stringify(result.settings));
    md5Cache.hashedPathMap[result.paths.settings] = (0, path_1.join)((0, path_1.dirname)(result.paths.settings), `settings.${cryptoHash.digest('hex').slice(0, 5)}.json`);
    await (0, fs_extra_1.remove)(result.paths.settings);
    result.paths.settings = md5Cache.hashedPathMap[result.paths.settings];
    (0, fs_extra_1.outputFileSync)(result.paths.settings, JSON.stringify(settings, null, options.debug ? 4 : 0));
    await md5Cache.run();
    result.paths.hashedMap = md5Cache.hashedPathMap;
    // 更新一些必要的路径信息
    result.paths.applicationJS = md5Cache.hashedPathMap[result.paths.applicationJS];
    console.debug(`add suffix to assets(${Object.keys(md5Cache.hashedPathMap).length}) success!`);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3VmZml4LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvYnVpbGRlci93b3JrZXIvYnVpbGRlci90YXNrcy9wb3N0cHJvY2Vzcy10YXNrL3N1ZmZpeC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7Ozs7OztBQXFCYix3QkE2RUM7QUFoR0QsK0JBQStDO0FBRy9DLHVEQUEyRDtBQUMzRCxtQ0FBb0M7QUFDcEMsdUNBQWlIO0FBQ2pILDJEQUFzRDtBQUV0RCxnRkFBK0Q7QUFDL0QsdUNBQTBDO0FBQzdCLFFBQUEsS0FBSyxHQUFHLGlDQUFpQyxDQUFDO0FBRTFDLFFBQUEsSUFBSSxHQUFHLG1CQUFtQixDQUFDO0FBRXhDOzs7O0dBSUc7QUFDSSxLQUFLLFVBQVUsTUFBTSxDQUFpQixPQUE4QixFQUFFLE1BQTJCLEVBQUUsS0FBd0I7SUFDOUgsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNwQixPQUFPO0lBQ1gsQ0FBQztJQUVELHdDQUF3QztJQUN4QyxJQUFJLE9BQU8sQ0FBQyxlQUFlLENBQUMscUJBQXFCLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUMvRSxzREFBc0Q7UUFDdEQsT0FBTyxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBQ0QsTUFBTSxRQUFRLEdBQUcsSUFBSSxtQ0FBZSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUVoRixvQkFBb0I7SUFDcEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUM3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TSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBRSxZQUFZLFVBQVUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDOUksTUFBTSxJQUFBLGlCQUFNLEVBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNwQyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDdEUsSUFBQSx5QkFBYyxFQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDN0YsTUFBTSxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUM7SUFFckIsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQztJQUVoRCxjQUFjO0lBQ2QsTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ2hGLE9BQU8sQ0FBQyxLQUFLLENBQUMsd0JBQXdCLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxDQUFDLE1BQU0sWUFBWSxDQUFDLENBQUM7QUFDbEcsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxuXHJcbmltcG9ydCB7IGpvaW4sIGRpcm5hbWUsIGJhc2VuYW1lIH0gZnJvbSAncGF0aCc7XHJcbmltcG9ydCB7IEJ1aWxkZXJBc3NldENhY2hlIH0gZnJvbSAnLi4vLi4vbWFuYWdlci9hc3NldCc7XHJcbmltcG9ydCB7IEludGVybmFsQnVpbGRSZXN1bHQgfSBmcm9tICcuLi8uLi9tYW5hZ2VyL2J1aWxkLXJlc3VsdCc7XHJcbmltcG9ydCB7IFNjcmlwdEJ1aWxkZXIgfSBmcm9tICcuLi8uLi9hc3NldC1oYW5kbGVyL3NjcmlwdCc7XHJcbmltcG9ydCB7IGNyZWF0ZUhhc2ggfSBmcm9tICdjcnlwdG8nO1xyXG5pbXBvcnQgeyBvdXRwdXRGaWxlU3luYywgcmVhZGRpclN5bmMsIHJlbmFtZSwgcmVhZEZpbGVTeW5jLCBzdGF0LCBzdGF0U3luYywgcmVtb3ZlLCBvdXRwdXRGaWxlIH0gZnJvbSAnZnMtZXh0cmEnO1xyXG5pbXBvcnQgeyBtZDVDYWNoZUhhbmRsZXIgfSBmcm9tICcuL21kNS1jYWNoZS1oYW5kbGVyJztcclxuaW1wb3J0IHsgSUJ1aWxkZXIsIElJbnRlcm5hbEJ1aWxkT3B0aW9ucyB9IGZyb20gJy4uLy4uLy4uLy4uL0B0eXBlcy9wcm90ZWN0ZWQnO1xyXG5pbXBvcnQgYXNzZXRNYW5hZ2VyIGZyb20gJy4uLy4uLy4uLy4uLy4uL2Fzc2V0cy9tYW5hZ2VyL2Fzc2V0JztcclxuaW1wb3J0IHsgcmVsYXRpdmVVcmwgfSBmcm9tICcuLi8uLi91dGlscyc7XHJcbmV4cG9ydCBjb25zdCB0aXRsZSA9ICdpMThuOmJ1aWxkZXIudGFza3MuYnVpbGRfc3VmZml4JztcclxuXHJcbmV4cG9ydCBjb25zdCBuYW1lID0gJ2J1aWxkLXRhc2svc3VmZml4JztcclxuXHJcbi8qKlxyXG4gKiDmoLnmja7liIbnu4Tkv6Hmga/lhoXnmoQganNvbiDmlbDmja7vvIzlkIjlubblkI7miZPljIXliLDmjIflrprkvY3nva5cclxuICogQHBhcmFtIG9wdGlvbnNcclxuICogQHBhcmFtIHNldHRpbmdzXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaGFuZGxlKHRoaXM6IElCdWlsZGVyLCBvcHRpb25zOiBJSW50ZXJuYWxCdWlsZE9wdGlvbnMsIHJlc3VsdDogSW50ZXJuYWxCdWlsZFJlc3VsdCwgY2FjaGU6IEJ1aWxkZXJBc3NldENhY2hlKSB7XHJcbiAgICBpZiAoIW9wdGlvbnMubWQ1Q2FjaGUpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgLy8g6Ieq5Yqo5pu/5o2i5Li76KaB5Li65LqG5pu/5o2i5p6E5bu65qih5p2/5YaF55qE5paH5Lu25byV55So77yM5aaC5LiN5a2Y5Zyo5qih5p2/5paH5Lu25peg6ZyA6aKd5aSW5omr5o+P5aSE55CGXHJcbiAgICBpZiAob3B0aW9ucy5tZDVDYWNoZU9wdGlvbnMuaGFuZGxlVGVtcGxhdGVNZDVMaW5rICYmIHRoaXMuYnVpbGRUZW1wbGF0ZS5pc0VuYWJsZSkge1xyXG4gICAgICAgIC8vIOiHquWKqOe7meWFtuS7luagueebruW9leS7peWPiiBzcmMg55uu5b2V5LiL55qE56ys5LiA5bGC5paH5Lu25re75YqgIGhhc2gg5YC877yM5bm25pu/5o2i5YW25LuW5pyq6KKr5aSE55CG5paH5Lu25YaF55qE6Lev5b6E5byV55SoXHJcbiAgICAgICAgb3B0aW9ucy5tZDVDYWNoZU9wdGlvbnMuaW5jbHVkZXMucHVzaCgnKicsICdzcmMvKicpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgbWQ1Q2FjaGUgPSBuZXcgbWQ1Q2FjaGVIYW5kbGVyKHJlc3VsdC5wYXRocy5kaXIsIG9wdGlvbnMubWQ1Q2FjaGVPcHRpb25zKTtcclxuXHJcbiAgICAvLyDnu5nmj5Lku7bohJrmnKzliqDkuIogbWQ177yM5bm25pu05paw5pWw5o2uXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdC5zZXR0aW5ncy5wbHVnaW5zLmpzTGlzdC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGNvbnN0IHBsdWdpblVybCA9IHJlc3VsdC5zZXR0aW5ncy5wbHVnaW5zLmpzTGlzdFtpXTtcclxuICAgICAgICBjb25zdCBwbHVnaW5VdWlkID0gYXNzZXRNYW5hZ2VyLnVybDJ1dWlkKCdkYjovLycgKyBwbHVnaW5VcmwpO1xyXG4gICAgICAgIGNvbnN0IHBsdWdpblBhdGggPSByZXN1bHQucGF0aHMucGx1Z2luc1twbHVnaW5VdWlkXTtcclxuICAgICAgICBjb25zdCBuZXdQYXRoID0gYXdhaXQgbWQ1Q2FjaGUuYWRkTWQ1VG9QYXRoKHBsdWdpblBhdGgpO1xyXG4gICAgICAgIHJlc3VsdC5zZXR0aW5ncy5wbHVnaW5zLmpzTGlzdCFbaV0gPSBwbHVnaW5VcmwucmVwbGFjZShiYXNlbmFtZShwbHVnaW5QYXRoKSwgYmFzZW5hbWUobmV3UGF0aCkpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOe7meW8leaTjuiEmuacrOWKoOS4iiBtZDVcclxuICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKHJlc3VsdC5pbXBvcnRNYXAuaW1wb3J0cyEpKSB7XHJcbiAgICAgICAgY29uc3QgZGlyTmFtZSA9IGRpcm5hbWUocmVzdWx0LnBhdGhzLmltcG9ydE1hcCk7XHJcbiAgICAgICAgY29uc3QgdmFsdWUgPSByZXN1bHQuaW1wb3J0TWFwLmltcG9ydHMhW2tleV07XHJcbiAgICAgICAgLy8gaW1wb3J0IG1hcCDlj6/og73mmKDlsITliLDlj6bkuIDkuKromZrmi5/mqKHlnZfvvIzogIzkuI3mmK/nm7jlr7not6/lvoRcclxuICAgICAgICBpZiAoIXZhbHVlLnN0YXJ0c1dpdGgoJy4nKSkge1xyXG4gICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZGVzdCA9IGpvaW4oZGlyTmFtZSwgdmFsdWUpO1xyXG4gICAgICAgIGNvbnN0IG5ld1BhdGggPSBhd2FpdCBtZDVDYWNoZS5hZGRNZDVUb1BhdGgoZGVzdCk7XHJcbiAgICAgICAgcmVzdWx0LmltcG9ydE1hcC5pbXBvcnRzIVtrZXldID0gYC4vJHtyZWxhdGl2ZVVybChkaXJOYW1lLCBuZXdQYXRoKX1gO1xyXG4gICAgfVxyXG4gICAgLy8g5a2Y5ZyoIG1kNSDpnIDopoHph43mlrDnlJ/miJAgaW1wb3J0LW1hcCDmlbDmja5cclxuICAgIGF3YWl0IFNjcmlwdEJ1aWxkZXIub3V0cHV0SW1wb3J0TWFwKHJlc3VsdC5pbXBvcnRNYXAsIHtcclxuICAgICAgICBkZXN0OiByZXN1bHQucGF0aHMuaW1wb3J0TWFwLFxyXG4gICAgICAgIGltcG9ydE1hcEZvcm1hdDogb3B0aW9ucy5idWlsZFNjcmlwdFBhcmFtLmltcG9ydE1hcEZvcm1hdCxcclxuICAgICAgICBkZWJ1Zzogb3B0aW9ucy5kZWJ1ZyxcclxuICAgIH0pO1xyXG4gICAgcmVzdWx0LnBhdGhzLmltcG9ydE1hcCA9IGF3YWl0IG1kNUNhY2hlLmFkZE1kNVRvUGF0aChyZXN1bHQucGF0aHMuaW1wb3J0TWFwKTtcclxuXHJcbiAgICAvLyDnu5nkuIDkupvni6znq4vohJrmnKzliqDkuIogbWQ1XHJcbiAgICBpZiAocmVzdWx0LnBhdGhzLnBvbHlmaWxsc0pzKSB7XHJcbiAgICAgICAgcmVzdWx0LnBhdGhzLnBvbHlmaWxsc0pzID0gYXdhaXQgbWQ1Q2FjaGUuYWRkTWQ1VG9QYXRoKHJlc3VsdC5wYXRocy5wb2x5ZmlsbHNKcyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHJlc3VsdC5wYXRocy5zeXN0ZW1Kcykge1xyXG4gICAgICAgIHJlc3VsdC5wYXRocy5zeXN0ZW1KcyA9IGF3YWl0IG1kNUNhY2hlLmFkZE1kNVRvUGF0aChyZXN1bHQucGF0aHMuc3lzdGVtSnMpO1xyXG4gICAgfVxyXG4gICAgLy8g57uZIHNjcmlwdFBhY2thZ2VzIOmHjOeahOiEmuacrOWKoOS4iiBtZDXvvIzmnKrorrDlvZXliLAgaW1wb3J0LW1hcCDlhoXnmoTlpITnkIbpnIDopoHliqDliLBcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVzdWx0LnNjcmlwdFBhY2thZ2VzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgY29uc3QgZGVzdCA9IHJlc3VsdC5zY3JpcHRQYWNrYWdlc1tpXTtcclxuICAgICAgICBjb25zdCBuZXdQYXRoID0gYXdhaXQgbWQ1Q2FjaGUuYWRkTWQ1VG9QYXRoKGRlc3QpO1xyXG4gICAgICAgIHJlc3VsdC5zY3JpcHRQYWNrYWdlc1tpXSA9IG5ld1BhdGg7XHJcbiAgICAgICAgLy8g5pu05pawIHNldHRpbmdzIOWGheiusOW9leeahOaVsOaNrlxyXG4gICAgICAgIHJlc3VsdC5zZXR0aW5ncy5zY3JpcHRpbmcuc2NyaXB0UGFja2FnZXMhW2ldID0gcmVzdWx0LnNldHRpbmdzLnNjcmlwdGluZy5zY3JpcHRQYWNrYWdlcyFbaV0ucmVwbGFjZShiYXNlbmFtZShkZXN0KSwgYmFzZW5hbWUobmV3UGF0aCkpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOe7mSBzZXR0aW5ncy5qc29uIOWKoOS4iiBtZDVcclxuICAgIGNvbnN0IHNldHRpbmdzID0gcmVzdWx0LnNldHRpbmdzO1xyXG4gICAgY29uc3QgYnVuZGxlcyA9IHRoaXMuYnVuZGxlTWFuYWdlci5idW5kbGVzLmZpbHRlcigoYnVuZGxlKSA9PiBidW5kbGUub3V0cHV0KS5zb3J0KChhLCBiKSA9PiBhLm5hbWUubG9jYWxlQ29tcGFyZShiLm5hbWUpKTtcclxuICAgIGZvciAoY29uc3QgYnVuZGxlIG9mIGJ1bmRsZXMpIHtcclxuICAgICAgICBzZXR0aW5ncy5hc3NldHMuYnVuZGxlVmVyc1tidW5kbGUubmFtZV0gPSBidW5kbGUudmVyc2lvbjtcclxuICAgIH1cclxuICAgIGNvbnN0IGNyeXB0b0hhc2ggPSBjcmVhdGVIYXNoKCdtZDUnKTtcclxuICAgIGNyeXB0b0hhc2gudXBkYXRlKEpTT04uc3RyaW5naWZ5KHJlc3VsdC5zZXR0aW5ncykpO1xyXG4gICAgbWQ1Q2FjaGUuaGFzaGVkUGF0aE1hcFtyZXN1bHQucGF0aHMuc2V0dGluZ3NdID0gam9pbihkaXJuYW1lKHJlc3VsdC5wYXRocy5zZXR0aW5ncyksIGBzZXR0aW5ncy4ke2NyeXB0b0hhc2guZGlnZXN0KCdoZXgnKS5zbGljZSgwLCA1KX0uanNvbmApO1xyXG4gICAgYXdhaXQgcmVtb3ZlKHJlc3VsdC5wYXRocy5zZXR0aW5ncyk7XHJcbiAgICByZXN1bHQucGF0aHMuc2V0dGluZ3MgPSBtZDVDYWNoZS5oYXNoZWRQYXRoTWFwW3Jlc3VsdC5wYXRocy5zZXR0aW5nc107XHJcbiAgICBvdXRwdXRGaWxlU3luYyhyZXN1bHQucGF0aHMuc2V0dGluZ3MsIEpTT04uc3RyaW5naWZ5KHNldHRpbmdzLCBudWxsLCBvcHRpb25zLmRlYnVnID8gNCA6IDApKTtcclxuICAgIGF3YWl0IG1kNUNhY2hlLnJ1bigpO1xyXG5cclxuICAgIHJlc3VsdC5wYXRocy5oYXNoZWRNYXAgPSBtZDVDYWNoZS5oYXNoZWRQYXRoTWFwO1xyXG5cclxuICAgIC8vIOabtOaWsOS4gOS6m+W/heimgeeahOi3r+W+hOS/oeaBr1xyXG4gICAgcmVzdWx0LnBhdGhzLmFwcGxpY2F0aW9uSlMgPSBtZDVDYWNoZS5oYXNoZWRQYXRoTWFwW3Jlc3VsdC5wYXRocy5hcHBsaWNhdGlvbkpTXTtcclxuICAgIGNvbnNvbGUuZGVidWcoYGFkZCBzdWZmaXggdG8gYXNzZXRzKCR7T2JqZWN0LmtleXMobWQ1Q2FjaGUuaGFzaGVkUGF0aE1hcCkubGVuZ3RofSkgc3VjY2VzcyFgKTtcclxufSJdfQ==