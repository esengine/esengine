"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.BuiltinHashType = void 0;
exports.calculate = calculate;
const utils_1 = require("../../../share/utils");
const xxhashjs_1 = __importDefault(require("xxhashjs"));
// 因为我们计算的哈希值字符串长度不一定一样，所以在后面添加 ID 时要用分隔符隔开，
// 才能避免加了 ID 后又刚好和其它哈希值冲突
const UNIQUE_ID_SEP = '-';
function unique(array) {
    const counts = {};
    for (let i = 0; i < array.length; i++) {
        const hash = array[i];
        const count = counts[hash];
        if (typeof count === 'undefined') {
            counts[hash] = 1;
        }
        else {
            array[i] = hash + UNIQUE_ID_SEP + (count).toString(16);
            counts[hash] = count + 1;
        }
    }
}
/**
 * 传入多个 uuid 数组，计算出每个数组对应的哈希值（16进制字符串表示），保证每次返回的哈希值之间互不重复。
 * 如果指定了 hashName，保证不同的 hashName 返回的哈希值一定互不重复。
 * @param {String[][]} uuidGroups
 * @param {BuiltinHashType|String} hashName - 如果哈希值会用作文件名，要注意 hashName 不区分大小写并且不能包含非法字符
 * @return {String[][]} hashes
 */
function calculate(uuidGroups, hashName) {
    const H = xxhashjs_1.default.h32();
    const hashes = [];
    for (let i = 0; i < uuidGroups.length; i++) {
        let uuids = uuidGroups[i];
        // @ts-ignore
        uuids = uuids.slice().sort(utils_1.compareUUID);
        for (let j = 0; j < uuids.length; j++) {
            H.update(uuids[j]);
        }
        const hash = H.digest().toString(16).padEnd(8, '0');
        hashes.push(hash);
    }
    unique(hashes);
    // add prefix
    if (typeof hashName === 'string') {
        if (hashName.length < 2) {
            console.error('hashName string length must >= 2');
            return hashes;
        }
    }
    else {
        hashName = '0123456789abcdef'[hashName];
        if (!hashName) {
            console.error('Invalid hashName');
            return hashes;
        }
    }
    return hashes.map((x) => {
        return hashName + x;
    });
}
exports.BuiltinHashType = {
    PackedAssets: 0,
    AutoAtlasImage: 1,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFzaC11dWlkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvYnVpbGRlci93b3JrZXIvYnVpbGRlci91dGlscy9oYXNoLXV1aWQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBNkJBLDhCQWdDQztBQTdERCxnREFBbUQ7QUFFbkQsd0RBQTJCO0FBRTNCLDRDQUE0QztBQUM1Qyx5QkFBeUI7QUFDekIsTUFBTSxhQUFhLEdBQUcsR0FBRyxDQUFDO0FBRTFCLFNBQVMsTUFBTSxDQUFDLEtBQWU7SUFDM0IsTUFBTSxNQUFNLEdBQVEsRUFBRSxDQUFDO0lBQ3ZCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDcEMsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3RCLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMzQixJQUFJLE9BQU8sS0FBSyxLQUFLLFdBQVcsRUFBRSxDQUFDO1lBQy9CLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDckIsQ0FBQzthQUFNLENBQUM7WUFDSixLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxHQUFHLGFBQWEsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN2RCxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsS0FBSyxHQUFHLENBQUMsQ0FBQztRQUM3QixDQUFDO0lBQ0wsQ0FBQztBQUNMLENBQUM7QUFFRDs7Ozs7O0dBTUc7QUFDSCxTQUFnQixTQUFTLENBQUMsVUFBc0IsRUFBRSxRQUF5QjtJQUN2RSxNQUFNLENBQUMsR0FBRyxrQkFBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ3BCLE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQztJQUNsQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3pDLElBQUksS0FBSyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxQixhQUFhO1FBQ2IsS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQyxJQUFJLENBQUMsbUJBQVcsQ0FBQyxDQUFDO1FBQ3hDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDcEMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2QixDQUFDO1FBQ0QsTUFBTSxJQUFJLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3BELE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdEIsQ0FBQztJQUVELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUVmLGFBQWE7SUFDYixJQUFJLE9BQU8sUUFBUSxLQUFLLFFBQVEsRUFBRSxDQUFDO1FBQy9CLElBQUksUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUN0QixPQUFPLENBQUMsS0FBSyxDQUFDLGtDQUFrQyxDQUFDLENBQUM7WUFDbEQsT0FBTyxNQUFNLENBQUM7UUFDbEIsQ0FBQztJQUNMLENBQUM7U0FBTSxDQUFDO1FBQ0osUUFBUSxHQUFHLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3hDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNaLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsQ0FBQztZQUNsQyxPQUFPLE1BQU0sQ0FBQztRQUNsQixDQUFDO0lBQ0wsQ0FBQztJQUNELE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO1FBQ3BCLE9BQU8sUUFBUSxHQUFHLENBQUMsQ0FBQztJQUN4QixDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFWSxRQUFBLGVBQWUsR0FBRztJQUMzQixZQUFZLEVBQUUsQ0FBQztJQUNmLGNBQWMsRUFBRSxDQUFDO0NBQ3BCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjb21wYXJlVVVJRCB9IGZyb20gJy4uLy4uLy4uL3NoYXJlL3V0aWxzJztcclxuXHJcbmltcG9ydCBYWEggZnJvbSAneHhoYXNoanMnO1xyXG5cclxuLy8g5Zug5Li65oiR5Lus6K6h566X55qE5ZOI5biM5YC85a2X56ym5Liy6ZW/5bqm5LiN5LiA5a6a5LiA5qC377yM5omA5Lul5Zyo5ZCO6Z2i5re75YqgIElEIOaXtuimgeeUqOWIhumalOespumalOW8gO+8jFxyXG4vLyDmiY3og73pgb/lhY3liqDkuoYgSUQg5ZCO5Y+I5Yia5aW95ZKM5YW25a6D5ZOI5biM5YC85Yay56qBXHJcbmNvbnN0IFVOSVFVRV9JRF9TRVAgPSAnLSc7XHJcblxyXG5mdW5jdGlvbiB1bmlxdWUoYXJyYXk6IHN0cmluZ1tdKSB7XHJcbiAgICBjb25zdCBjb3VudHM6IGFueSA9IHt9O1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGNvbnN0IGhhc2ggPSBhcnJheVtpXTtcclxuICAgICAgICBjb25zdCBjb3VudCA9IGNvdW50c1toYXNoXTtcclxuICAgICAgICBpZiAodHlwZW9mIGNvdW50ID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICAgICAgICBjb3VudHNbaGFzaF0gPSAxO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGFycmF5W2ldID0gaGFzaCArIFVOSVFVRV9JRF9TRVAgKyAoY291bnQpLnRvU3RyaW5nKDE2KTtcclxuICAgICAgICAgICAgY291bnRzW2hhc2hdID0gY291bnQgKyAxO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOS8oOWFpeWkmuS4qiB1dWlkIOaVsOe7hO+8jOiuoeeul+WHuuavj+S4quaVsOe7hOWvueW6lOeahOWTiOW4jOWAvO+8iDE26L+b5Yi25a2X56ym5Liy6KGo56S677yJ77yM5L+d6K+B5q+P5qyh6L+U5Zue55qE5ZOI5biM5YC85LmL6Ze05LqS5LiN6YeN5aSN44CCXHJcbiAqIOWmguaenOaMh+WumuS6hiBoYXNoTmFtZe+8jOS/neivgeS4jeWQjOeahCBoYXNoTmFtZSDov5Tlm57nmoTlk4jluIzlgLzkuIDlrprkupLkuI3ph43lpI3jgIJcclxuICogQHBhcmFtIHtTdHJpbmdbXVtdfSB1dWlkR3JvdXBzXHJcbiAqIEBwYXJhbSB7QnVpbHRpbkhhc2hUeXBlfFN0cmluZ30gaGFzaE5hbWUgLSDlpoLmnpzlk4jluIzlgLzkvJrnlKjkvZzmlofku7blkI3vvIzopoHms6jmhI8gaGFzaE5hbWUg5LiN5Yy65YiG5aSn5bCP5YaZ5bm25LiU5LiN6IO95YyF5ZCr6Z2e5rOV5a2X56ymXHJcbiAqIEByZXR1cm4ge1N0cmluZ1tdW119IGhhc2hlc1xyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZSh1dWlkR3JvdXBzOiBzdHJpbmdbXVtdLCBoYXNoTmFtZTogc3RyaW5nIHwgbnVtYmVyKSB7XHJcbiAgICBjb25zdCBIID0gWFhILmgzMigpO1xyXG4gICAgY29uc3QgaGFzaGVzID0gW107XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHV1aWRHcm91cHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBsZXQgdXVpZHMgPSB1dWlkR3JvdXBzW2ldO1xyXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICB1dWlkcyA9IHV1aWRzLnNsaWNlKCkuc29ydChjb21wYXJlVVVJRCk7XHJcbiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB1dWlkcy5sZW5ndGg7IGorKykge1xyXG4gICAgICAgICAgICBILnVwZGF0ZSh1dWlkc1tqXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGhhc2ggPSBILmRpZ2VzdCgpLnRvU3RyaW5nKDE2KS5wYWRFbmQoOCwgJzAnKTtcclxuICAgICAgICBoYXNoZXMucHVzaChoYXNoKTtcclxuICAgIH1cclxuXHJcbiAgICB1bmlxdWUoaGFzaGVzKTtcclxuXHJcbiAgICAvLyBhZGQgcHJlZml4XHJcbiAgICBpZiAodHlwZW9mIGhhc2hOYW1lID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgIGlmIChoYXNoTmFtZS5sZW5ndGggPCAyKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ2hhc2hOYW1lIHN0cmluZyBsZW5ndGggbXVzdCA+PSAyJyk7XHJcbiAgICAgICAgICAgIHJldHVybiBoYXNoZXM7XHJcbiAgICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBoYXNoTmFtZSA9ICcwMTIzNDU2Nzg5YWJjZGVmJ1toYXNoTmFtZV07XHJcbiAgICAgICAgaWYgKCFoYXNoTmFtZSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdJbnZhbGlkIGhhc2hOYW1lJyk7XHJcbiAgICAgICAgICAgIHJldHVybiBoYXNoZXM7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGhhc2hlcy5tYXAoKHgpID0+IHtcclxuICAgICAgICByZXR1cm4gaGFzaE5hbWUgKyB4O1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBCdWlsdGluSGFzaFR5cGUgPSB7XHJcbiAgICBQYWNrZWRBc3NldHM6IDAsXHJcbiAgICBBdXRvQXRsYXNJbWFnZTogMSxcclxufTtcclxuIl19