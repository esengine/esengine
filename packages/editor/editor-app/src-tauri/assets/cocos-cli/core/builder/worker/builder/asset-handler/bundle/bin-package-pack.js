"use strict";
/**
 * bin package格式说明.
|PACK_BIN_TYPE - 4bytes|
|VERSION - 4bytes|
|FILES_COUNT - 4bytes|
|FILE_1_OFFSET - 4bytes|
|FILE_1_SIZE - 4bytes|
|FILE_2_OFFSET - 4bytes|
|FILE_2_SIZE - 4bytes|
...
|FILE_N_OFFSET - 4bytes|
|FILE_N_SIZE - 4bytes|
|PACKED_BIN|
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.binPackagePack = binPackagePack;
// 文件头, cocos的bin文件类型标识, BINP代表bin package格式
const PACK_BIN_TYPE = 'BINP';
// 如果以后格式有变化, 这里VERSION需要递增
const VERSION = 2;
// bin package header需要TypedArray的格式来记录合并文件列表信息
// UNIT_SIZE相当于TypedArray的单位大小(4字节)
// LITTLE_ENDIAN配置大小端
const UNIT_SIZE = 4;
const LITTLE_ENDIAN = true;
const FLOAT32_SIZE = 4;
function binPackagePack(arrayBuffers) {
    const headerBin = genHeaderBin(arrayBuffers);
    const packedBin = packBin(arrayBuffers);
    return packBin([headerBin, packedBin]);
}
function getPaddedSize(size) {
    return Math.ceil(size / FLOAT32_SIZE) * FLOAT32_SIZE;
}
function packBin(arrayBuffers) {
    const totalSize = arrayBuffers.reduce((sum, buffer) => sum + getPaddedSize(buffer.byteLength), 0);
    const packedBin = new Uint8Array(totalSize);
    let offset = 0;
    arrayBuffers.forEach(buffer => {
        packedBin.set(new Uint8Array(buffer), offset);
        offset += getPaddedSize(buffer.byteLength);
    });
    return packedBin.buffer;
}
function genHeaderBin(arrayBuffers) {
    const filesCount = arrayBuffers.length;
    const ret = new ArrayBuffer(UNIT_SIZE * (3 + filesCount * 2));
    const dataView = new DataView(ret);
    for (let i = 0; i < PACK_BIN_TYPE.length; i++) {
        dataView.setUint8(i, PACK_BIN_TYPE.charCodeAt(i));
    }
    dataView.setUint32(UNIT_SIZE, VERSION, LITTLE_ENDIAN);
    dataView.setUint32(UNIT_SIZE * 2, filesCount, LITTLE_ENDIAN);
    let offset = 0;
    arrayBuffers.forEach((arrayBuffer, index) => {
        dataView.setUint32(UNIT_SIZE * (3 + index * 2), offset, LITTLE_ENDIAN);
        offset += getPaddedSize(arrayBuffer.byteLength);
        dataView.setUint32(UNIT_SIZE * (3 + index * 2 + 1), arrayBuffer.byteLength, LITTLE_ENDIAN);
    });
    return ret;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluLXBhY2thZ2UtcGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL2J1aWxkZXIvd29ya2VyL2J1aWxkZXIvYXNzZXQtaGFuZGxlci9idW5kbGUvYmluLXBhY2thZ2UtcGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7R0FhRzs7QUFlSCx3Q0FJQztBQWpCRCw0Q0FBNEM7QUFDNUMsTUFBTSxhQUFhLEdBQUcsTUFBTSxDQUFDO0FBQzdCLDJCQUEyQjtBQUMzQixNQUFNLE9BQU8sR0FBRyxDQUFDLENBQUM7QUFFbEIsK0NBQStDO0FBQy9DLG1DQUFtQztBQUNuQyxxQkFBcUI7QUFDckIsTUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFDO0FBQ3BCLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQztBQUUzQixNQUFNLFlBQVksR0FBRyxDQUFDLENBQUM7QUFFdkIsU0FBZ0IsY0FBYyxDQUFDLFlBQTJCO0lBQ3RELE1BQU0sU0FBUyxHQUFHLFlBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUM3QyxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDeEMsT0FBTyxPQUFPLENBQUMsQ0FBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQztBQUMzQyxDQUFDO0FBRUQsU0FBUyxhQUFhLENBQUMsSUFBWTtJQUMvQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLFlBQVksQ0FBQyxHQUFHLFlBQVksQ0FBQztBQUN6RCxDQUFDO0FBRUQsU0FBUyxPQUFPLENBQUMsWUFBMkI7SUFDeEMsTUFBTSxTQUFTLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDLEdBQUcsR0FBRyxhQUFhLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ2xHLE1BQU0sU0FBUyxHQUFHLElBQUksVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzVDLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQztJQUNmLFlBQVksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7UUFDMUIsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLFVBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUM5QyxNQUFNLElBQUksYUFBYSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUMvQyxDQUFDLENBQUMsQ0FBQztJQUNILE9BQU8sU0FBUyxDQUFDLE1BQU0sQ0FBQztBQUM1QixDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsWUFBMkI7SUFDN0MsTUFBTSxVQUFVLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQztJQUN2QyxNQUFNLEdBQUcsR0FBRyxJQUFJLFdBQVcsQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDLEdBQUcsVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFbkMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLGFBQWEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUM1QyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUNELFFBQVEsQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQztJQUN0RCxRQUFRLENBQUMsU0FBUyxDQUFDLFNBQVMsR0FBRyxDQUFDLEVBQUUsVUFBVSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBRTdELElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQztJQUNmLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQyxXQUFXLEVBQUUsS0FBSyxFQUFFLEVBQUU7UUFDeEMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDLEdBQUcsS0FBSyxHQUFHLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxhQUFhLENBQUMsQ0FBQztRQUN2RSxNQUFNLElBQUksYUFBYSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNoRCxRQUFRLENBQUMsU0FBUyxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsR0FBRyxLQUFLLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxVQUFVLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFDL0YsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLEdBQUcsQ0FBQztBQUNmLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogYmluIHBhY2thZ2XmoLzlvI/or7TmmI4uXHJcbnxQQUNLX0JJTl9UWVBFIC0gNGJ5dGVzfFxyXG58VkVSU0lPTiAtIDRieXRlc3xcclxufEZJTEVTX0NPVU5UIC0gNGJ5dGVzfFxyXG58RklMRV8xX09GRlNFVCAtIDRieXRlc3xcclxufEZJTEVfMV9TSVpFIC0gNGJ5dGVzfFxyXG58RklMRV8yX09GRlNFVCAtIDRieXRlc3xcclxufEZJTEVfMl9TSVpFIC0gNGJ5dGVzfFxyXG4uLi5cclxufEZJTEVfTl9PRkZTRVQgLSA0Ynl0ZXN8XHJcbnxGSUxFX05fU0laRSAtIDRieXRlc3xcclxufFBBQ0tFRF9CSU58XHJcbiAqL1xyXG5cclxuLy8g5paH5Lu25aS0LCBjb2Nvc+eahGJpbuaWh+S7tuexu+Wei+agh+ivhiwgQklOUOS7o+ihqGJpbiBwYWNrYWdl5qC85byPXHJcbmNvbnN0IFBBQ0tfQklOX1RZUEUgPSAnQklOUCc7XHJcbi8vIOWmguaenOS7peWQjuagvOW8j+acieWPmOWMliwg6L+Z6YeMVkVSU0lPTumcgOimgemAkuWinlxyXG5jb25zdCBWRVJTSU9OID0gMjtcclxuXHJcbi8vIGJpbiBwYWNrYWdlIGhlYWRlcumcgOimgVR5cGVkQXJyYXnnmoTmoLzlvI/mnaXorrDlvZXlkIjlubbmlofku7bliJfooajkv6Hmga9cclxuLy8gVU5JVF9TSVpF55u45b2T5LqOVHlwZWRBcnJheeeahOWNleS9jeWkp+Wwjyg05a2X6IqCKVxyXG4vLyBMSVRUTEVfRU5ESUFO6YWN572u5aSn5bCP56uvXHJcbmNvbnN0IFVOSVRfU0laRSA9IDQ7XHJcbmNvbnN0IExJVFRMRV9FTkRJQU4gPSB0cnVlO1xyXG5cclxuY29uc3QgRkxPQVQzMl9TSVpFID0gNDtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBiaW5QYWNrYWdlUGFjayhhcnJheUJ1ZmZlcnM6IEFycmF5QnVmZmVyW10pOiBBcnJheUJ1ZmZlciB7XHJcbiAgICBjb25zdCBoZWFkZXJCaW4gPSBnZW5IZWFkZXJCaW4oYXJyYXlCdWZmZXJzKTtcclxuICAgIGNvbnN0IHBhY2tlZEJpbiA9IHBhY2tCaW4oYXJyYXlCdWZmZXJzKTtcclxuICAgIHJldHVybiBwYWNrQmluKFtoZWFkZXJCaW4sIHBhY2tlZEJpbl0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRQYWRkZWRTaXplKHNpemU6IG51bWJlcik6IG51bWJlciB7XHJcbiAgICByZXR1cm4gTWF0aC5jZWlsKHNpemUgLyBGTE9BVDMyX1NJWkUpICogRkxPQVQzMl9TSVpFO1xyXG59XHJcblxyXG5mdW5jdGlvbiBwYWNrQmluKGFycmF5QnVmZmVyczogQXJyYXlCdWZmZXJbXSk6IEFycmF5QnVmZmVyIHtcclxuICAgIGNvbnN0IHRvdGFsU2l6ZSA9IGFycmF5QnVmZmVycy5yZWR1Y2UoKHN1bSwgYnVmZmVyKSA9PiBzdW0gKyBnZXRQYWRkZWRTaXplKGJ1ZmZlci5ieXRlTGVuZ3RoKSwgMCk7XHJcbiAgICBjb25zdCBwYWNrZWRCaW4gPSBuZXcgVWludDhBcnJheSh0b3RhbFNpemUpO1xyXG4gICAgbGV0IG9mZnNldCA9IDA7XHJcbiAgICBhcnJheUJ1ZmZlcnMuZm9yRWFjaChidWZmZXIgPT4ge1xyXG4gICAgICAgIHBhY2tlZEJpbi5zZXQobmV3IFVpbnQ4QXJyYXkoYnVmZmVyKSwgb2Zmc2V0KTtcclxuICAgICAgICBvZmZzZXQgKz0gZ2V0UGFkZGVkU2l6ZShidWZmZXIuYnl0ZUxlbmd0aCk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBwYWNrZWRCaW4uYnVmZmVyO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZW5IZWFkZXJCaW4oYXJyYXlCdWZmZXJzOiBBcnJheUJ1ZmZlcltdKTogQXJyYXlCdWZmZXIge1xyXG4gICAgY29uc3QgZmlsZXNDb3VudCA9IGFycmF5QnVmZmVycy5sZW5ndGg7XHJcbiAgICBjb25zdCByZXQgPSBuZXcgQXJyYXlCdWZmZXIoVU5JVF9TSVpFICogKDMgKyBmaWxlc0NvdW50ICogMikpO1xyXG4gICAgY29uc3QgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcocmV0KTtcclxuXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IFBBQ0tfQklOX1RZUEUubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBkYXRhVmlldy5zZXRVaW50OChpLCBQQUNLX0JJTl9UWVBFLmNoYXJDb2RlQXQoaSkpO1xyXG4gICAgfVxyXG4gICAgZGF0YVZpZXcuc2V0VWludDMyKFVOSVRfU0laRSwgVkVSU0lPTiwgTElUVExFX0VORElBTik7XHJcbiAgICBkYXRhVmlldy5zZXRVaW50MzIoVU5JVF9TSVpFICogMiwgZmlsZXNDb3VudCwgTElUVExFX0VORElBTik7XHJcblxyXG4gICAgbGV0IG9mZnNldCA9IDA7XHJcbiAgICBhcnJheUJ1ZmZlcnMuZm9yRWFjaCgoYXJyYXlCdWZmZXIsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgZGF0YVZpZXcuc2V0VWludDMyKFVOSVRfU0laRSAqICgzICsgaW5kZXggKiAyKSwgb2Zmc2V0LCBMSVRUTEVfRU5ESUFOKTtcclxuICAgICAgICBvZmZzZXQgKz0gZ2V0UGFkZGVkU2l6ZShhcnJheUJ1ZmZlci5ieXRlTGVuZ3RoKTtcclxuICAgICAgICBkYXRhVmlldy5zZXRVaW50MzIoVU5JVF9TSVpFICogKDMgKyBpbmRleCAqIDIgKyAxKSwgYXJyYXlCdWZmZXIuYnl0ZUxlbmd0aCwgTElUVExFX0VORElBTik7XHJcbiAgICB9KTtcclxuICAgIFxyXG4gICAgcmV0dXJuIHJldDtcclxufVxyXG4iXX0=