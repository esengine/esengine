"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.packer = packer;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
const config_1 = require("./config");
const pac_info_1 = require("./pac-info");
const algorithm_1 = require("./algorithm");
const sharp_1 = __importDefault(require("sharp"));
const bleeding_1 = require("./bleeding");
async function packer(spriteFrameInfos, packOptions) {
    // 超出了 AtlasInfo 的最大宽或高而无法打包的 SpriteFrame
    const filterResult = filterUnpacked(spriteFrameInfos);
    console.debug(`Start trim sprite image ...`);
    await trimImages(filterResult.result);
    console.debug('determine atlas size...');
    const deterResult = determineAtlasSize(filterResult.result, packOptions);
    const unpackedImages = Array.from(filterResult.unpackedImages.concat(deterResult.unpackedImages));
    console.debug('Start generate atlas image...');
    await Promise.all(deterResult.packAtlas.map((atlas) => {
        return generateAtlas(atlas, packOptions);
    }));
    return {
        atlases: deterResult.packAtlas.map((atlas) => atlas.toJSON()),
        unpackedImages: unpackedImages.map((asset) => {
            return {
                imageUuid: asset.uuid,
                libraryPath: asset._file,
            };
        }),
        pacUuid: spriteFrameInfos[0]._pacUuid,
    };
}
function determineAtlasSize(spriteFrameInfos, options) {
    // 先拷贝一份新数组
    const inputs = spriteFrameInfos.concat();
    const packAtlas = [];
    let unpackedImages = [];
    let packingFunc = algorithm_1.TexturePackerAlgorithm[options.algorithm];
    if (!packingFunc) {
        console.warn(`determineAtlasSize failed: Can not find algorithm ${options.algorithm}, use MaxRects`);
        packingFunc = algorithm_1.TexturePackerAlgorithm.MaxRects;
    }
    const maxWidth = options.maxWidth;
    const maxHeight = options.maxHeight;
    const allowRotation = options.allowRotation;
    // 多张碎图无法放进图集内时，自动生成多个图集
    let n = 0;
    while (inputs.length > 0) {
        const packedSprites = packingFunc.call(algorithm_1.TexturePackerAlgorithm, inputs, maxWidth, maxHeight, allowRotation);
        if (packedSprites.length === 0) {
            unpackedImages = unpackedImages.concat(inputs);
            break;
        }
        packedSprites.forEach((rect) => {
            inputs.splice(inputs.indexOf(rect), 1);
        });
        let width = 0;
        let height = 0;
        // tslint:disable-next-line: prefer-for-of
        for (let i = 0; i < packedSprites.length; i++) {
            const item = packedSprites[i];
            item.rotatedWidth = item.rotated ? item.height : item.width;
            item.rotatedHeight = item.rotated ? item.width : item.height;
            item.trim.rotatedWidth = item.rotated ? item.trim.height : item.trim.width;
            item.trim.rotatedHeight = item.rotated ? item.trim.width : item.trim.height;
            const right = item.x + item.rotatedWidth;
            const top = item.y + item.rotatedHeight;
            if (right > width) {
                width = right;
            }
            if (top > height) {
                height = top;
            }
        }
        const name = options.name + '-' + n;
        n++;
        const imagePath = (0, path_1.join)(options.destDir, name + '.' + options.format);
        // TODO packedSprites 的定义需要梳理
        packAtlas.push(new pac_info_1.AtlasInfo(packedSprites, width, height, name, imagePath));
    }
    // square and powerOfTwo options here
    packAtlas.forEach((atlas) => {
        applySquareAndPowerConstraints(atlas, options.forceSquared, options.powerOfTwo);
        atlas.spriteFrameInfos.forEach((item) => {
            item.trim.x = item.x + options.padding + options.bleed;
            item.trim.y = item.y + options.padding + options.bleed;
        });
    });
    return {
        packAtlas,
        unpackedImages,
    };
}
function applySquareAndPowerConstraints(options, square, powerOfTwo) {
    if (square) {
        options.width = options.height = Math.max(options.width, options.height);
    }
    if (powerOfTwo) {
        options.width = roundToPowerOfTwo(options.width);
        options.height = roundToPowerOfTwo(options.height);
    }
}
function roundToPowerOfTwo(num) {
    if (typeof num !== 'number') {
        return 0;
    }
    let powers = 2;
    while (num > powers) {
        powers *= 2;
    }
    return powers;
}
/**
 * 过滤无法直接打包的资源信息
 * @param spriteFrameInfos
 */
function filterUnpacked(spriteFrameInfos) {
    const unpackedImages = [];
    const result = spriteFrameInfos.filter((spriteFrameInfos) => {
        if (spriteFrameInfos.trim.width > 0 && spriteFrameInfos.trim.height > 0) {
            return true;
        }
        spriteFrameInfos.width = spriteFrameInfos.rawWidth;
        spriteFrameInfos.height = spriteFrameInfos.rawHeight;
        unpackedImages.push(spriteFrameInfos);
        return false;
    });
    return { unpackedImages, result };
}
/**
 * 生成合图
 * @param atlas
 * @param options
 */
async function generateAtlas(atlas, options) {
    const spriteFrameInfos = atlas.spriteFrameInfos;
    const width = atlas.width;
    const height = atlas.height;
    const channels = 4;
    const opts = { raw: { width, height, channels } };
    let atlasImage = await (0, sharp_1.default)({
        create: {
            width,
            height,
            channels,
            background: { r: 0, b: 0, g: 0, alpha: 0 },
        },
    }).toBuffer();
    const batchMemLimited = 2 * 1024 * 1024;
    let batchMem = 0;
    // 批量 sharp 处理限制数量，避免内存过大导致编辑器崩溃
    const batchCountLimited = 100;
    let batchCount = 0;
    let compositeInputs = [];
    for (let i = 0; i < spriteFrameInfos.length; i++) {
        const spriteImage = spriteFrameInfos[i];
        const x = spriteImage.trim.x;
        const y = spriteImage.trim.y;
        const width = spriteImage.trim.width;
        const height = spriteImage.trim.height;
        batchMem += width * height * channels;
        batchCount++;
        try {
            if (batchMem >= batchMemLimited || batchCount >= batchCountLimited) {
                atlasImage = await (0, sharp_1.default)(atlasImage, opts)
                    .composite(compositeInputs)
                    .toBuffer();
                compositeInputs = [];
                batchMem = 0;
                batchCount = 0;
            }
            let sharp = (0, sharp_1.default)(spriteImage._libraryPath);
            if (spriteImage.rotated) {
                sharp = sharp.rotate(90);
            }
            const buffer = await sharp.toBuffer();
            compositeInputs.push({
                input: buffer,
                left: x,
                top: y,
            });
        }
        catch (error) {
            console.error(`Handle image [${spriteImage._libraryPath} error]. \n Origin path is [${spriteImage.originalPath}:${spriteImage.name}]. \n Error : ${error.toString()}`);
            continue;
        }
    }
    atlasImage = await (0, sharp_1.default)(atlasImage, opts)
        .composite(compositeInputs)
        .toBuffer();
    if (options.contourBleed || options.paddingBleed) {
        bleeding_1.BleedingProcessor.applyBleed(options, atlas, atlasImage, atlasImage);
    }
    await (0, sharp_1.default)(atlasImage, opts).png().toFile(atlas.imagePath);
}
/**
 * 根据图片设置裁剪图片
 * @param spriteFrameInfos
 */
async function trimImages(spriteFrameInfos) {
    const trimTempDir = (0, path_1.join)(config_1.buildTempDir, 'trimImages');
    (0, fs_extra_1.ensureDirSync)(trimTempDir);
    // 将图片裁剪一遍
    await Promise.all(spriteFrameInfos.map((spriteFrameInfo, index) => {
        spriteFrameInfo.originalPath = spriteFrameInfo._libraryPath;
        spriteFrameInfo._libraryPath = (0, path_1.join)(trimTempDir, 'spritesheet_js_' + spriteFrameInfo.uuid + '_image_' + index++ + '.png');
        const trim = spriteFrameInfo.trim;
        const image = (0, sharp_1.default)(spriteFrameInfo.originalPath).extract({
            left: trim.x,
            top: trim.y,
            width: trim.rotatedWidth,
            height: trim.rotatedHeight,
        });
        // TODO 原本使用 spriteFrameInfo.spriteFrame.rotated 需要确认是否保持一致
        if (spriteFrameInfo.rotated) {
            image.rotate(270);
        }
        return image.toFile(spriteFrameInfo._libraryPath).catch((err) => {
            console.error(`trimImages(${spriteFrameInfo.originalPath}) failed!`);
            throw err;
        });
    }));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFja2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvYnVpbGRlci93b3JrZXIvYnVpbGRlci9hc3NldC1oYW5kbGVyL3RleHR1cmUtcGFja2VyL3BhY2tlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQVVBLHdCQTBCQztBQXBDRCx1Q0FBeUM7QUFDekMsK0JBQTRCO0FBQzVCLHFDQUF3QztBQUN4Qyx5Q0FBaUU7QUFHakUsMkNBQXFEO0FBQ3JELGtEQUE0QztBQUM1Qyx5Q0FBK0M7QUFFeEMsS0FBSyxVQUFVLE1BQU0sQ0FBQyxnQkFBbUMsRUFBRSxXQUFpQztJQUUvRix5Q0FBeUM7SUFDekMsTUFBTSxZQUFZLEdBQUcsY0FBYyxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDdEQsT0FBTyxDQUFDLEtBQUssQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0lBQzdDLE1BQU0sVUFBVSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN0QyxPQUFPLENBQUMsS0FBSyxDQUFDLHlCQUF5QixDQUFDLENBQUM7SUFFekMsTUFBTSxXQUFXLEdBQUcsa0JBQWtCLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxXQUFXLENBQUMsQ0FBQztJQUN6RSxNQUFNLGNBQWMsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO0lBQ2xHLE9BQU8sQ0FBQyxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztJQUMvQyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQ2IsV0FBVyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtRQUNoQyxPQUFPLGFBQWEsQ0FBQyxLQUFLLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDN0MsQ0FBQyxDQUFDLENBQ0wsQ0FBQztJQUNGLE9BQU87UUFD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QyxLQUFLLENBQUMsY0FBYyxlQUFlLENBQUMsWUFBWSxXQUFXLENBQUMsQ0FBQztZQUNyRSxNQUFNLEdBQUcsQ0FBQztRQUNkLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQ0wsQ0FBQztBQUNOLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlbnN1cmVEaXJTeW5jIH0gZnJvbSAnZnMtZXh0cmEnO1xyXG5pbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCc7XHJcbmltcG9ydCB7IGJ1aWxkVGVtcERpciB9IGZyb20gJy4vY29uZmlnJztcclxuaW1wb3J0IHsgQXRsYXNJbmZvLCBQYWNJbmZvLCBTcHJpdGVGcmFtZUluZm8gfSBmcm9tICcuL3BhYy1pbmZvJztcclxuaW1wb3J0IHsgSUludGVybmFsUGFja09wdGlvbnMsIElQYWNrUmVzdWx0LCBJUGFja09wdGlvbnMgfSBmcm9tICcuLi8uLi8uLi8uLi9AdHlwZXMvcHJvdGVjdGVkJztcclxuXHJcbmltcG9ydCB7IFRleHR1cmVQYWNrZXJBbGdvcml0aG0gfSBmcm9tICcuL2FsZ29yaXRobSc7XHJcbmltcG9ydCBTaGFycCwgeyBTaGFycE9wdGlvbnMgfSBmcm9tICdzaGFycCc7XHJcbmltcG9ydCB7IEJsZWVkaW5nUHJvY2Vzc29yIH0gZnJvbSAnLi9ibGVlZGluZyc7XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcGFja2VyKHNwcml0ZUZyYW1lSW5mb3M6IFNwcml0ZUZyYW1lSW5mb1tdLCBwYWNrT3B0aW9uczogSUludGVybmFsUGFja09wdGlvbnMpOiBQcm9taXNlPElQYWNrUmVzdWx0PiB7XHJcblxyXG4gICAgLy8g6LaF5Ye65LqGIEF0bGFzSW5mbyDnmoTmnIDlpKflrr3miJbpq5jogIzml6Dms5XmiZPljIXnmoQgU3ByaXRlRnJhbWVcclxuICAgIGNvbnN0IGZpbHRlclJlc3VsdCA9IGZpbHRlclVucGFja2VkKHNwcml0ZUZyYW1lSW5mb3MpO1xyXG4gICAgY29uc29sZS5kZWJ1ZyhgU3RhcnQgdHJpbSBzcHJpdGUgaW1hZ2UgLi4uYCk7XHJcbiAgICBhd2FpdCB0cmltSW1hZ2VzKGZpbHRlclJlc3VsdC5yZXN1bHQpO1xyXG4gICAgY29uc29sZS5kZWJ1ZygnZGV0ZXJtaW5lIGF0bGFzIHNpemUuLi4nKTtcclxuXHJcbiAgICBjb25zdCBkZXRlclJlc3VsdCA9IGRldGVybWluZUF0bGFzU2l6ZShmaWx0ZXJSZXN1bHQucmVzdWx0LCBwYWNrT3B0aW9ucyk7XHJcbiAgICBjb25zdCB1bnBhY2tlZEltYWdlcyA9IEFycmF5LmZyb20oZmlsdGVyUmVzdWx0LnVucGFja2VkSW1hZ2VzLmNvbmNhdChkZXRlclJlc3VsdC51bnBhY2tlZEltYWdlcykpO1xyXG4gICAgY29uc29sZS5kZWJ1ZygnU3RhcnQgZ2VuZXJhdGUgYXRsYXMgaW1hZ2UuLi4nKTtcclxuICAgIGF3YWl0IFByb21pc2UuYWxsKFxyXG4gICAgICAgIGRldGVyUmVzdWx0LnBhY2tBdGxhcy5tYXAoKGF0bGFzKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBnZW5lcmF0ZUF0bGFzKGF0bGFzLCBwYWNrT3B0aW9ucyk7XHJcbiAgICAgICAgfSksXHJcbiAgICApO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBhdGxhc2VzOiBkZXRlclJlc3VsdC5wYWNrQXRsYXMubWFwKChhdGxhcykgPT4gYXRsYXMudG9KU09OKCkpLFxyXG4gICAgICAgIHVucGFja2VkSW1hZ2VzOiB1bnBhY2tlZEltYWdlcy5tYXAoKGFzc2V0KSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBpbWFnZVV1aWQ6IGFzc2V0LnV1aWQsXHJcbiAgICAgICAgICAgICAgICBsaWJyYXJ5UGF0aDogYXNzZXQuX2ZpbGUsXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgcGFjVXVpZDogc3ByaXRlRnJhbWVJbmZvc1swXS5fcGFjVXVpZCxcclxuICAgIH07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRldGVybWluZUF0bGFzU2l6ZShzcHJpdGVGcmFtZUluZm9zOiBTcHJpdGVGcmFtZUluZm9bXSwgb3B0aW9uczogSUludGVybmFsUGFja09wdGlvbnMpIHtcclxuICAgIC8vIOWFiOaLt+i0neS4gOS7veaWsOaVsOe7hFxyXG4gICAgY29uc3QgaW5wdXRzID0gc3ByaXRlRnJhbWVJbmZvcy5jb25jYXQoKTtcclxuICAgIGNvbnN0IHBhY2tBdGxhcyA9IFtdO1xyXG4gICAgbGV0IHVucGFja2VkSW1hZ2VzOiBTcHJpdGVGcmFtZUluZm9bXSA9IFtdO1xyXG4gICAgbGV0IHBhY2tpbmdGdW5jID0gVGV4dHVyZVBhY2tlckFsZ29yaXRobVtvcHRpb25zLmFsZ29yaXRobV07XHJcbiAgICBpZiAoIXBhY2tpbmdGdW5jKSB7XHJcbiAgICAgICAgY29uc29sZS53YXJuKGBkZXRlcm1pbmVBdGxhc1NpemUgZmFpbGVkOiBDYW4gbm90IGZpbmQgYWxnb3JpdGhtICR7b3B0aW9ucy5hbGdvcml0aG19LCB1c2UgTWF4UmVjdHNgKTtcclxuICAgICAgICBwYWNraW5nRnVuYyA9IFRleHR1cmVQYWNrZXJBbGdvcml0aG0uTWF4UmVjdHM7XHJcbiAgICB9XHJcbiAgICBjb25zdCBtYXhXaWR0aCA9IG9wdGlvbnMubWF4V2lkdGg7XHJcbiAgICBjb25zdCBtYXhIZWlnaHQgPSBvcHRpb25zLm1heEhlaWdodDtcclxuICAgIGNvbnN0IGFsbG93Um90YXRpb24gPSBvcHRpb25zLmFsbG93Um90YXRpb247XHJcblxyXG4gICAgLy8g5aSa5byg56KO5Zu+5peg5rOV5pS+6L+b5Zu+6ZuG5YaF5pe277yM6Ieq5Yqo55Sf5oiQ5aSa5Liq5Zu+6ZuGXHJcbiAgICBsZXQgbiA9IDA7XHJcbiAgICB3aGlsZSAoaW5wdXRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjb25zdCBwYWNrZWRTcHJpdGVzID0gcGFja2luZ0Z1bmMuY2FsbChUZXh0dXJlUGFja2VyQWxnb3JpdGhtLCBpbnB1dHMsIG1heFdpZHRoLCBtYXhIZWlnaHQsIGFsbG93Um90YXRpb24pO1xyXG5cclxuICAgICAgICBpZiAocGFja2VkU3ByaXRlcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgdW5wYWNrZWRJbWFnZXMgPSB1bnBhY2tlZEltYWdlcy5jb25jYXQoaW5wdXRzKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwYWNrZWRTcHJpdGVzLmZvckVhY2goKHJlY3Q6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpbnB1dHMuc3BsaWNlKGlucHV0cy5pbmRleE9mKHJlY3QpLCAxKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbGV0IHdpZHRoID0gMDtcclxuICAgICAgICBsZXQgaGVpZ2h0ID0gMDtcclxuXHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBwcmVmZXItZm9yLW9mXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYWNrZWRTcHJpdGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSBwYWNrZWRTcHJpdGVzW2ldO1xyXG5cclxuICAgICAgICAgICAgaXRlbS5yb3RhdGVkV2lkdGggPSBpdGVtLnJvdGF0ZWQgPyBpdGVtLmhlaWdodCA6IGl0ZW0ud2lkdGg7XHJcbiAgICAgICAgICAgIGl0ZW0ucm90YXRlZEhlaWdodCA9IGl0ZW0ucm90YXRlZCA/IGl0ZW0ud2lkdGggOiBpdGVtLmhlaWdodDtcclxuXHJcbiAgICAgICAgICAgIGl0ZW0udHJpbS5yb3RhdGVkV2lkdGggPSBpdGVtLnJvdGF0ZWQgPyBpdGVtLnRyaW0uaGVpZ2h0IDogaXRlbS50cmltLndpZHRoO1xyXG4gICAgICAgICAgICBpdGVtLnRyaW0ucm90YXRlZEhlaWdodCA9IGl0ZW0ucm90YXRlZCA/IGl0ZW0udHJpbS53aWR0aCA6IGl0ZW0udHJpbS5oZWlnaHQ7XHJcblxyXG4gICAgICAgICAgICBjb25zdCByaWdodCA9IGl0ZW0ueCArIGl0ZW0ucm90YXRlZFdpZHRoO1xyXG4gICAgICAgICAgICBjb25zdCB0b3AgPSBpdGVtLnkgKyBpdGVtLnJvdGF0ZWRIZWlnaHQ7XHJcblxyXG4gICAgICAgICAgICBpZiAocmlnaHQgPiB3aWR0aCkge1xyXG4gICAgICAgICAgICAgICAgd2lkdGggPSByaWdodDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAodG9wID4gaGVpZ2h0KSB7XHJcbiAgICAgICAgICAgICAgICBoZWlnaHQgPSB0b3A7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgbmFtZSA9IG9wdGlvbnMubmFtZSArICctJyArIG47XHJcbiAgICAgICAgbisrO1xyXG4gICAgICAgIGNvbnN0IGltYWdlUGF0aCA9IGpvaW4ob3B0aW9ucy5kZXN0RGlyLCBuYW1lICsgJy4nICsgb3B0aW9ucy5mb3JtYXQpO1xyXG4gICAgICAgIC8vIFRPRE8gcGFja2VkU3ByaXRlcyDnmoTlrprkuYnpnIDopoHmorPnkIZcclxuICAgICAgICBwYWNrQXRsYXMucHVzaChuZXcgQXRsYXNJbmZvKHBhY2tlZFNwcml0ZXMgYXMgdW5rbm93biBhcyBTcHJpdGVGcmFtZUluZm9bXSwgd2lkdGgsIGhlaWdodCwgbmFtZSwgaW1hZ2VQYXRoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gc3F1YXJlIGFuZCBwb3dlck9mVHdvIG9wdGlvbnMgaGVyZVxyXG4gICAgcGFja0F0bGFzLmZvckVhY2goKGF0bGFzOiBBdGxhc0luZm8pID0+IHtcclxuICAgICAgICBhcHBseVNxdWFyZUFuZFBvd2VyQ29uc3RyYWludHMoYXRsYXMsIG9wdGlvbnMuZm9yY2VTcXVhcmVkLCBvcHRpb25zLnBvd2VyT2ZUd28pO1xyXG5cclxuICAgICAgICBhdGxhcy5zcHJpdGVGcmFtZUluZm9zLmZvckVhY2goKGl0ZW06IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpdGVtLnRyaW0ueCA9IGl0ZW0ueCArIG9wdGlvbnMucGFkZGluZyArIG9wdGlvbnMuYmxlZWQ7XHJcbiAgICAgICAgICAgIGl0ZW0udHJpbS55ID0gaXRlbS55ICsgb3B0aW9ucy5wYWRkaW5nICsgb3B0aW9ucy5ibGVlZDtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBwYWNrQXRsYXMsXHJcbiAgICAgICAgdW5wYWNrZWRJbWFnZXMsXHJcbiAgICB9O1xyXG59XHJcblxyXG5mdW5jdGlvbiBhcHBseVNxdWFyZUFuZFBvd2VyQ29uc3RyYWludHMob3B0aW9uczogYW55LCBzcXVhcmU6IGJvb2xlYW4sIHBvd2VyT2ZUd286IGJvb2xlYW4pIHtcclxuICAgIGlmIChzcXVhcmUpIHtcclxuICAgICAgICBvcHRpb25zLndpZHRoID0gb3B0aW9ucy5oZWlnaHQgPSBNYXRoLm1heChvcHRpb25zLndpZHRoLCBvcHRpb25zLmhlaWdodCk7XHJcbiAgICB9XHJcbiAgICBpZiAocG93ZXJPZlR3bykge1xyXG4gICAgICAgIG9wdGlvbnMud2lkdGggPSByb3VuZFRvUG93ZXJPZlR3byhvcHRpb25zLndpZHRoKTtcclxuICAgICAgICBvcHRpb25zLmhlaWdodCA9IHJvdW5kVG9Qb3dlck9mVHdvKG9wdGlvbnMuaGVpZ2h0KTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcm91bmRUb1Bvd2VyT2ZUd28obnVtOiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgaWYgKHR5cGVvZiBudW0gIT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgcmV0dXJuIDA7XHJcbiAgICB9XHJcbiAgICBsZXQgcG93ZXJzID0gMjtcclxuICAgIHdoaWxlIChudW0gPiBwb3dlcnMpIHtcclxuICAgICAgICBwb3dlcnMgKj0gMjtcclxuICAgIH1cclxuICAgIHJldHVybiBwb3dlcnM7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDov4fmu6Tml6Dms5Xnm7TmjqXmiZPljIXnmoTotYTmupDkv6Hmga9cclxuICogQHBhcmFtIHNwcml0ZUZyYW1lSW5mb3NcclxuICovXHJcbmZ1bmN0aW9uIGZpbHRlclVucGFja2VkKHNwcml0ZUZyYW1lSW5mb3M6IFNwcml0ZUZyYW1lSW5mb1tdKSB7XHJcbiAgICBjb25zdCB1bnBhY2tlZEltYWdlczogU3ByaXRlRnJhbWVJbmZvW10gPSBbXTtcclxuICAgIGNvbnN0IHJlc3VsdCA9IHNwcml0ZUZyYW1lSW5mb3MuZmlsdGVyKChzcHJpdGVGcmFtZUluZm9zKSA9PiB7XHJcbiAgICAgICAgaWYgKHNwcml0ZUZyYW1lSW5mb3MudHJpbS53aWR0aCA+IDAgJiYgc3ByaXRlRnJhbWVJbmZvcy50cmltLmhlaWdodCA+IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBzcHJpdGVGcmFtZUluZm9zLndpZHRoID0gc3ByaXRlRnJhbWVJbmZvcy5yYXdXaWR0aDtcclxuICAgICAgICBzcHJpdGVGcmFtZUluZm9zLmhlaWdodCA9IHNwcml0ZUZyYW1lSW5mb3MucmF3SGVpZ2h0O1xyXG4gICAgICAgIHVucGFja2VkSW1hZ2VzLnB1c2goc3ByaXRlRnJhbWVJbmZvcyk7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4geyB1bnBhY2tlZEltYWdlcywgcmVzdWx0IH07XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDnlJ/miJDlkIjlm75cclxuICogQHBhcmFtIGF0bGFzXHJcbiAqIEBwYXJhbSBvcHRpb25zXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiBnZW5lcmF0ZUF0bGFzKGF0bGFzOiBBdGxhc0luZm8sIG9wdGlvbnM6IElQYWNrT3B0aW9ucykge1xyXG4gICAgY29uc3Qgc3ByaXRlRnJhbWVJbmZvcyA9IGF0bGFzLnNwcml0ZUZyYW1lSW5mb3M7XHJcbiAgICBjb25zdCB3aWR0aCA9IGF0bGFzLndpZHRoO1xyXG4gICAgY29uc3QgaGVpZ2h0ID0gYXRsYXMuaGVpZ2h0O1xyXG4gICAgY29uc3QgY2hhbm5lbHMgPSA0O1xyXG4gICAgY29uc3Qgb3B0czogU2hhcnBPcHRpb25zID0geyByYXc6IHsgd2lkdGgsIGhlaWdodCwgY2hhbm5lbHMgfSB9O1xyXG5cclxuICAgIGxldCBhdGxhc0ltYWdlID0gYXdhaXQgU2hhcnAoe1xyXG4gICAgICAgIGNyZWF0ZToge1xyXG4gICAgICAgICAgICB3aWR0aCxcclxuICAgICAgICAgICAgaGVpZ2h0LFxyXG4gICAgICAgICAgICBjaGFubmVscyxcclxuICAgICAgICAgICAgYmFja2dyb3VuZDogeyByOiAwLCBiOiAwLCBnOiAwLCBhbHBoYTogMCB9LFxyXG4gICAgICAgIH0sXHJcbiAgICB9KS50b0J1ZmZlcigpO1xyXG5cclxuICAgIGNvbnN0IGJhdGNoTWVtTGltaXRlZCA9IDIgKiAxMDI0ICogMTAyNDtcclxuICAgIGxldCBiYXRjaE1lbSA9IDA7XHJcbiAgICAvLyDmibnph48gc2hhcnAg5aSE55CG6ZmQ5Yi25pWw6YeP77yM6YG/5YWN5YaF5a2Y6L+H5aSn5a+86Ie057yW6L6R5Zmo5bSp5rqDXHJcbiAgICBjb25zdCBiYXRjaENvdW50TGltaXRlZCA9IDEwMDtcclxuICAgIGxldCBiYXRjaENvdW50ID0gMDtcclxuICAgIGxldCBjb21wb3NpdGVJbnB1dHM6IGFueVtdID0gW107XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzcHJpdGVGcmFtZUluZm9zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgY29uc3Qgc3ByaXRlSW1hZ2UgPSBzcHJpdGVGcmFtZUluZm9zW2ldO1xyXG4gICAgICAgIGNvbnN0IHggPSBzcHJpdGVJbWFnZS50cmltLng7XHJcbiAgICAgICAgY29uc3QgeSA9IHNwcml0ZUltYWdlLnRyaW0ueTtcclxuICAgICAgICBjb25zdCB3aWR0aCA9IHNwcml0ZUltYWdlLnRyaW0ud2lkdGg7XHJcbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gc3ByaXRlSW1hZ2UudHJpbS5oZWlnaHQ7XHJcblxyXG4gICAgICAgIGJhdGNoTWVtICs9IHdpZHRoICogaGVpZ2h0ICogY2hhbm5lbHM7XHJcbiAgICAgICAgYmF0Y2hDb3VudCsrO1xyXG5cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBpZiAoYmF0Y2hNZW0gPj0gYmF0Y2hNZW1MaW1pdGVkIHx8IGJhdGNoQ291bnQgPj0gYmF0Y2hDb3VudExpbWl0ZWQpIHtcclxuICAgICAgICAgICAgICAgIGF0bGFzSW1hZ2UgPSBhd2FpdCBTaGFycChhdGxhc0ltYWdlLCBvcHRzKVxyXG4gICAgICAgICAgICAgICAgICAgIC5jb21wb3NpdGUoY29tcG9zaXRlSW5wdXRzKVxyXG4gICAgICAgICAgICAgICAgICAgIC50b0J1ZmZlcigpO1xyXG4gICAgICAgICAgICAgICAgY29tcG9zaXRlSW5wdXRzID0gW107XHJcbiAgICAgICAgICAgICAgICBiYXRjaE1lbSA9IDA7XHJcbiAgICAgICAgICAgICAgICBiYXRjaENvdW50ID0gMDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbGV0IHNoYXJwID0gU2hhcnAoc3ByaXRlSW1hZ2UuX2xpYnJhcnlQYXRoKTtcclxuICAgICAgICAgICAgaWYgKHNwcml0ZUltYWdlLnJvdGF0ZWQpIHtcclxuICAgICAgICAgICAgICAgIHNoYXJwID0gc2hhcnAucm90YXRlKDkwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBidWZmZXIgPSBhd2FpdCBzaGFycC50b0J1ZmZlcigpO1xyXG4gICAgICAgICAgICBjb21wb3NpdGVJbnB1dHMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICBpbnB1dDogYnVmZmVyLFxyXG4gICAgICAgICAgICAgICAgbGVmdDogeCxcclxuICAgICAgICAgICAgICAgIHRvcDogeSxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFxyXG4gICAgICAgICAgICAgICAgYEhhbmRsZSBpbWFnZSBbJHtzcHJpdGVJbWFnZS5fbGlicmFyeVBhdGh9IGVycm9yXS4gXFxuIE9yaWdpbiBwYXRoIGlzIFske3Nwcml0ZUltYWdlLm9yaWdpbmFsUGF0aH06JHtzcHJpdGVJbWFnZS5uYW1lXHJcbiAgICAgICAgICAgICAgICB9XS4gXFxuIEVycm9yIDogJHtlcnJvci50b1N0cmluZygpfWAsXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGF0bGFzSW1hZ2UgPSBhd2FpdCBTaGFycChhdGxhc0ltYWdlLCBvcHRzKVxyXG4gICAgICAgIC5jb21wb3NpdGUoY29tcG9zaXRlSW5wdXRzKVxyXG4gICAgICAgIC50b0J1ZmZlcigpO1xyXG4gICAgaWYgKG9wdGlvbnMuY29udG91ckJsZWVkIHx8IG9wdGlvbnMucGFkZGluZ0JsZWVkKSB7XHJcbiAgICAgICAgQmxlZWRpbmdQcm9jZXNzb3IuYXBwbHlCbGVlZChvcHRpb25zLCBhdGxhcywgYXRsYXNJbWFnZSwgYXRsYXNJbWFnZSk7XHJcbiAgICB9XHJcblxyXG4gICAgYXdhaXQgU2hhcnAoYXRsYXNJbWFnZSwgb3B0cykucG5nKCkudG9GaWxlKGF0bGFzLmltYWdlUGF0aCk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDmoLnmja7lm77niYforr7nva7oo4Hliarlm77niYdcclxuICogQHBhcmFtIHNwcml0ZUZyYW1lSW5mb3NcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIHRyaW1JbWFnZXMoc3ByaXRlRnJhbWVJbmZvczogU3ByaXRlRnJhbWVJbmZvW10pIHtcclxuICAgIGNvbnN0IHRyaW1UZW1wRGlyID0gam9pbihidWlsZFRlbXBEaXIsICd0cmltSW1hZ2VzJyk7XHJcbiAgICBlbnN1cmVEaXJTeW5jKHRyaW1UZW1wRGlyKTtcclxuICAgIC8vIOWwhuWbvueJh+ijgeWJquS4gOmBjVxyXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoXHJcbiAgICAgICAgc3ByaXRlRnJhbWVJbmZvcy5tYXAoKHNwcml0ZUZyYW1lSW5mbywgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgc3ByaXRlRnJhbWVJbmZvLm9yaWdpbmFsUGF0aCA9IHNwcml0ZUZyYW1lSW5mby5fbGlicmFyeVBhdGg7XHJcbiAgICAgICAgICAgIHNwcml0ZUZyYW1lSW5mby5fbGlicmFyeVBhdGggPSBqb2luKHRyaW1UZW1wRGlyLCAnc3ByaXRlc2hlZXRfanNfJyArIHNwcml0ZUZyYW1lSW5mby51dWlkICsgJ19pbWFnZV8nICsgaW5kZXgrKyArICcucG5nJyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHRyaW0gPSBzcHJpdGVGcmFtZUluZm8udHJpbTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGltYWdlID0gU2hhcnAoc3ByaXRlRnJhbWVJbmZvLm9yaWdpbmFsUGF0aCkuZXh0cmFjdCh7XHJcbiAgICAgICAgICAgICAgICBsZWZ0OiB0cmltLngsXHJcbiAgICAgICAgICAgICAgICB0b3A6IHRyaW0ueSxcclxuICAgICAgICAgICAgICAgIHdpZHRoOiB0cmltLnJvdGF0ZWRXaWR0aCxcclxuICAgICAgICAgICAgICAgIGhlaWdodDogdHJpbS5yb3RhdGVkSGVpZ2h0LFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgLy8gVE9ETyDljp/mnKzkvb/nlKggc3ByaXRlRnJhbWVJbmZvLnNwcml0ZUZyYW1lLnJvdGF0ZWQg6ZyA6KaB56Gu6K6k5piv5ZCm5L+d5oyB5LiA6Ie0XHJcbiAgICAgICAgICAgIGlmIChzcHJpdGVGcmFtZUluZm8ucm90YXRlZCkge1xyXG4gICAgICAgICAgICAgICAgaW1hZ2Uucm90YXRlKDI3MCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGltYWdlLnRvRmlsZShzcHJpdGVGcmFtZUluZm8uX2xpYnJhcnlQYXRoKS5jYXRjaCgoZXJyOiBFcnJvcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgdHJpbUltYWdlcygke3Nwcml0ZUZyYW1lSW5mby5vcmlnaW5hbFBhdGh9KSBmYWlsZWQhYCk7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pLFxyXG4gICAgKTtcclxufVxyXG4iXX0=