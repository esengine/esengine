'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.handle = handle;
const fs_extra_1 = require("fs-extra");
/**
 * 根据缓存地址还原 settings 数据
 * @param options
 * @param settings
 */
async function handle(settingDest) {
    const cacheSettings = await (0, fs_extra_1.readJSON)(settingDest);
    if (!cacheSettings) {
        console.error('can\'t get cache settings...');
        return;
    }
    const uuids = cacheSettings.uuids;
    const rawAssets = cacheSettings.rawAssets;
    const assetTypes = cacheSettings.assetTypes;
    const realRawAssets = cacheSettings.rawAssets = {};
    for (const mount in rawAssets) {
        const entries = rawAssets[mount];
        const realEntries = realRawAssets[mount] = {};
        for (const id in entries) {
            const entry = entries[id];
            const type = entry[1];
            // retrieve minified raw asset
            if (typeof type === 'number') {
                entry[1] = assetTypes[type];
            }
            // retrieve uuid
            realEntries[uuids[id] || id] = entry;
        }
    }
    const scenes = cacheSettings.scenes;
    for (let i = 0; i < scenes.length; ++i) {
        const scene = scenes[i];
        if (typeof scene.uuid === 'number') {
            scene.uuid = uuids[scene.uuid];
        }
    }
    const packedAssets = cacheSettings.packedAssets;
    for (const packId in packedAssets) {
        const packedIds = packedAssets[packId];
        for (let j = 0; j < packedIds.length; ++j) {
            if (typeof packedIds[j] === 'number') {
                packedIds[j] = uuids[packedIds[j]];
            }
        }
    }
    const subpackages = cacheSettings.subpackages;
    for (const subId in subpackages) {
        const uuidArray = subpackages[subId].uuids;
        if (uuidArray) {
            for (let k = 0, l = uuidArray.length; k < l; k++) {
                if (typeof uuidArray[k] === 'number') {
                    uuidArray[k] = uuids[uuidArray[k]];
                }
            }
        }
    }
    return cacheSettings;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9idWlsZGVyL3dvcmtlci9idWlsZGVyL3Rhc2tzL3NldHRpbmctdGFzay91dGlscy9jYWNoZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7O0FBU2Isd0JBb0RDO0FBM0RELHVDQUFvQztBQUVwQzs7OztHQUlHO0FBQ0ksS0FBSyxVQUFVLE1BQU0sQ0FBQyxXQUFtQjtJQUM1QyxNQUFNLGFBQWEsR0FBUSxNQUFNLElBQUEsbUJBQVEsRUFBQyxXQUFXLENBQUMsQ0FBQztJQUN2RCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDakIsT0FBTyxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO1FBQzlDLE9BQU87SUFDWCxDQUFDO0lBQ0QsTUFBTSxLQUFLLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQztJQUNsQyxNQUFNLFNBQVMsR0FBRyxhQUFhLENBQUMsU0FBUyxDQUFDO0lBQzFDLE1BQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQyxVQUFVLENBQUM7SUFDNUMsTUFBTSxhQUFhLEdBQVEsYUFBYSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7SUFDeEQsS0FBSyxNQUFNLEtBQUssSUFBSSxTQUFTLEVBQUUsQ0FBQztRQUM1QixNQUFNLE9BQU8sR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDakMsTUFBTSxXQUFXLEdBQVEsYUFBYSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUNuRCxLQUFLLE1BQU0sRUFBRSxJQUFJLE9BQU8sRUFBRSxDQUFDO1lBQ3ZCLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMxQixNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEIsOEJBQThCO1lBQzlCLElBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxFQUFFLENBQUM7Z0JBQzNCLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDaEMsQ0FBQztZQUNELGdCQUFnQjtZQUNoQixXQUFXLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUN6QyxDQUFDO0lBQ0wsQ0FBQztJQUNELE1BQU0sTUFBTSxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUM7SUFDcEMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUNyQyxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDeEIsSUFBSSxPQUFPLEtBQUssQ0FBQyxJQUFJLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDakMsS0FBSyxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ25DLENBQUM7SUFDTCxDQUFDO0lBQ0QsTUFBTSxZQUFZLEdBQUcsYUFBYSxDQUFDLFlBQVksQ0FBQztJQUNoRCxLQUFLLE1BQU0sTUFBTSxJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ2hDLE1BQU0sU0FBUyxHQUFHLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN2QyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsU0FBUyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDO1lBQ3hDLElBQUksT0FBTyxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssUUFBUSxFQUFFLENBQUM7Z0JBQ25DLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdkMsQ0FBQztRQUNMLENBQUM7SUFDTCxDQUFDO0lBQ0QsTUFBTSxXQUFXLEdBQUcsYUFBYSxDQUFDLFdBQVcsQ0FBQztJQUM5QyxLQUFLLE1BQU0sS0FBSyxJQUFJLFdBQVcsRUFBRSxDQUFDO1FBQzlCLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFDM0MsSUFBSSxTQUFTLEVBQUUsQ0FBQztZQUNaLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxTQUFTLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDL0MsSUFBSSxPQUFPLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxRQUFRLEVBQUUsQ0FBQztvQkFDbkMsU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdkMsQ0FBQztZQUNMLENBQUM7UUFDTCxDQUFDO0lBQ0wsQ0FBQztJQUNELE9BQU8sYUFBYSxDQUFDO0FBQ3pCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG5pbXBvcnQgeyByZWFkSlNPTiB9IGZyb20gJ2ZzLWV4dHJhJztcclxuXHJcbi8qKlxyXG4gKiDmoLnmja7nvJPlrZjlnLDlnYDov5jljp8gc2V0dGluZ3Mg5pWw5o2uXHJcbiAqIEBwYXJhbSBvcHRpb25zXHJcbiAqIEBwYXJhbSBzZXR0aW5nc1xyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGhhbmRsZShzZXR0aW5nRGVzdDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBjYWNoZVNldHRpbmdzOiBhbnkgPSBhd2FpdCByZWFkSlNPTihzZXR0aW5nRGVzdCk7XHJcbiAgICBpZiAoIWNhY2hlU2V0dGluZ3MpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKCdjYW5cXCd0IGdldCBjYWNoZSBzZXR0aW5ncy4uLicpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IHV1aWRzID0gY2FjaGVTZXR0aW5ncy51dWlkcztcclxuICAgIGNvbnN0IHJhd0Fzc2V0cyA9IGNhY2hlU2V0dGluZ3MucmF3QXNzZXRzO1xyXG4gICAgY29uc3QgYXNzZXRUeXBlcyA9IGNhY2hlU2V0dGluZ3MuYXNzZXRUeXBlcztcclxuICAgIGNvbnN0IHJlYWxSYXdBc3NldHM6IGFueSA9IGNhY2hlU2V0dGluZ3MucmF3QXNzZXRzID0ge307XHJcbiAgICBmb3IgKGNvbnN0IG1vdW50IGluIHJhd0Fzc2V0cykge1xyXG4gICAgICAgIGNvbnN0IGVudHJpZXMgPSByYXdBc3NldHNbbW91bnRdO1xyXG4gICAgICAgIGNvbnN0IHJlYWxFbnRyaWVzOiBhbnkgPSByZWFsUmF3QXNzZXRzW21vdW50XSA9IHt9O1xyXG4gICAgICAgIGZvciAoY29uc3QgaWQgaW4gZW50cmllcykge1xyXG4gICAgICAgICAgICBjb25zdCBlbnRyeSA9IGVudHJpZXNbaWRdO1xyXG4gICAgICAgICAgICBjb25zdCB0eXBlID0gZW50cnlbMV07XHJcbiAgICAgICAgICAgIC8vIHJldHJpZXZlIG1pbmlmaWVkIHJhdyBhc3NldFxyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgICAgICAgICBlbnRyeVsxXSA9IGFzc2V0VHlwZXNbdHlwZV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gcmV0cmlldmUgdXVpZFxyXG4gICAgICAgICAgICByZWFsRW50cmllc1t1dWlkc1tpZF0gfHwgaWRdID0gZW50cnk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgY29uc3Qgc2NlbmVzID0gY2FjaGVTZXR0aW5ncy5zY2VuZXM7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNjZW5lcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgIGNvbnN0IHNjZW5lID0gc2NlbmVzW2ldO1xyXG4gICAgICAgIGlmICh0eXBlb2Ygc2NlbmUudXVpZCA9PT0gJ251bWJlcicpIHtcclxuICAgICAgICAgICAgc2NlbmUudXVpZCA9IHV1aWRzW3NjZW5lLnV1aWRdO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGNvbnN0IHBhY2tlZEFzc2V0cyA9IGNhY2hlU2V0dGluZ3MucGFja2VkQXNzZXRzO1xyXG4gICAgZm9yIChjb25zdCBwYWNrSWQgaW4gcGFja2VkQXNzZXRzKSB7XHJcbiAgICAgICAgY29uc3QgcGFja2VkSWRzID0gcGFja2VkQXNzZXRzW3BhY2tJZF07XHJcbiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBwYWNrZWRJZHMubGVuZ3RoOyArK2opIHtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBwYWNrZWRJZHNbal0gPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgICAgICAgICBwYWNrZWRJZHNbal0gPSB1dWlkc1twYWNrZWRJZHNbal1dO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgY29uc3Qgc3VicGFja2FnZXMgPSBjYWNoZVNldHRpbmdzLnN1YnBhY2thZ2VzO1xyXG4gICAgZm9yIChjb25zdCBzdWJJZCBpbiBzdWJwYWNrYWdlcykge1xyXG4gICAgICAgIGNvbnN0IHV1aWRBcnJheSA9IHN1YnBhY2thZ2VzW3N1YklkXS51dWlkcztcclxuICAgICAgICBpZiAodXVpZEFycmF5KSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGsgPSAwLCBsID0gdXVpZEFycmF5Lmxlbmd0aDsgayA8IGw7IGsrKykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB1dWlkQXJyYXlba10gPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXVpZEFycmF5W2tdID0gdXVpZHNbdXVpZEFycmF5W2tdXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBjYWNoZVNldHRpbmdzO1xyXG59XHJcbiJdfQ==