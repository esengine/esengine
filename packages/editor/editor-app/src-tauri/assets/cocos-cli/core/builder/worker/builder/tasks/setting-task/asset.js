'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.title = void 0;
exports.handle = handle;
const bundle_utils_1 = require("../../../../share/bundle-utils");
const asset_library_1 = require("../../manager/asset-library");
const utils_1 = require("../../utils");
exports.title = 'i18n:builder.tasks.settings.options';
const layerMask = [];
for (let i = 0; i <= 19; i++) {
    layerMask[i] = 1 << i;
}
/**
 * 根据选项填充 settings
 * @param options
 * @param settings
 */
async function handle(options, result, cache) {
    const bundles = this.bundleManager.bundles.filter((bundle) => bundle.output);
    for (const bundle of bundles) {
        if (bundle.name === bundle_utils_1.BuiltinBundleName.RESOURCES) {
            result.settings.assets.preloadBundles.push({ bundle: bundle_utils_1.BuiltinBundleName.RESOURCES });
        }
        else if (bundle.name === bundle_utils_1.BuiltinBundleName.START_SCENE) {
            result.settings.assets.preloadBundles.push({ bundle: bundle_utils_1.BuiltinBundleName.START_SCENE });
        }
        else if (bundle.name === bundle_utils_1.BuiltinBundleName.MAIN) {
            result.settings.assets.preloadBundles.push({ bundle: bundle_utils_1.BuiltinBundleName.MAIN });
        }
        if (bundle.isRemote) {
            result.settings.assets.remoteBundles.push(bundle.name);
        }
        if (bundle.isSubpackage) {
            result.settings.assets.subpackages.push(bundle.name);
        }
    }
    if (!options.preview) {
        const startSceneAsset = asset_library_1.buildAssetLibrary.getAsset(options.startScene);
        if (!startSceneAsset) {
            // 理论上进入构建前应该已经校验过，这里还是校验一下给一个可阅读的报错
            throw new Error('can not find start scene asset by uuid or url: ' + options.startScene);
        }
        options.startScene = startSceneAsset.url;
    }
    if (!options.debug) {
        result.settings.rendering.renderPipeline = (0, utils_1.compressUuid)(result.settings.rendering.renderPipeline, true);
    }
    result.settings.assets.projectBundles = bundles.map((bundle) => bundle.name);
    result.settings.engine.builtinAssets = Array.from(this.bundleManager.bundleMap[bundle_utils_1.BuiltinBundleName.INTERNAL]._rootAssets);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9idWlsZGVyL3dvcmtlci9idWlsZGVyL3Rhc2tzL3NldHRpbmctdGFzay9hc3NldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7OztBQXNCYix3QkE4QkM7QUFoREQsaUVBQW1FO0FBRW5FLCtEQUFnRTtBQUVoRSx1Q0FBMkM7QUFFOUIsUUFBQSxLQUFLLEdBQUcscUNBQXFDLENBQUM7QUFFM0QsTUFBTSxTQUFTLEdBQWEsRUFBRSxDQUFDO0FBQy9CLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztJQUMzQixTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUMxQixDQUFDO0FBRUQ7Ozs7R0FJRztBQUNJLEtBQUssVUFBVSxNQUFNLENBQWlCLE9BQThCLEVBQUUsTUFBMkIsRUFBRSxLQUF3QjtJQUM5SCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM3RSxLQUFLLE1BQU0sTUFBTSxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQzNCLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxnQ0FBaUIsQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUM5QyxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLGdDQUFpQixDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUM7UUFDeEYsQ0FBQzthQUFNLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxnQ0FBaUIsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUN2RCxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLGdDQUFpQixDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDMUYsQ0FBQzthQUFNLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxnQ0FBaUIsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNoRCxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLGdDQUFpQixDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFDbkYsQ0FBQztRQUNELElBQUksTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ2xCLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzNELENBQUM7UUFDRCxJQUFJLE1BQU0sQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUN0QixNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN6RCxDQUFDO0lBQ0wsQ0FBQztJQUNELElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDbkIsTUFBTSxlQUFlLEdBQUcsaUNBQWlCLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN2RSxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDbkIsb0NBQW9DO1lBQ3BDLE1BQU0sSUFBSSxLQUFLLENBQUMsaURBQWlELEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzVGLENBQUM7UUFDRCxPQUFPLENBQUMsVUFBVSxHQUFHLGVBQWUsQ0FBQyxHQUFHLENBQUM7SUFDN0MsQ0FBQztJQUNELElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDakIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsY0FBYyxHQUFHLElBQUEsb0JBQVksRUFBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDNUcsQ0FBQztJQUNELE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLGNBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBZSxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdEYsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsZ0NBQWlCLENBQUMsUUFBUSxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDNUgsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxuXHJcbmltcG9ydCBpMThuIGZyb20gJy4uLy4uLy4uLy4uLy4uL2Jhc2UvaTE4bic7XHJcbmltcG9ydCB7IElCdWlsZGVyLCBJSW50ZXJuYWxCdWlsZE9wdGlvbnMsIElCdW5kbGUgfSBmcm9tICcuLi8uLi8uLi8uLi9AdHlwZXMvcHJvdGVjdGVkJztcclxuaW1wb3J0IHsgQnVpbHRpbkJ1bmRsZU5hbWUgfSBmcm9tICcuLi8uLi8uLi8uLi9zaGFyZS9idW5kbGUtdXRpbHMnO1xyXG5pbXBvcnQgeyBCdWlsZGVyQXNzZXRDYWNoZSB9IGZyb20gJy4uLy4uL21hbmFnZXIvYXNzZXQnO1xyXG5pbXBvcnQgeyBidWlsZEFzc2V0TGlicmFyeSB9IGZyb20gJy4uLy4uL21hbmFnZXIvYXNzZXQtbGlicmFyeSc7XHJcbmltcG9ydCB7IEludGVybmFsQnVpbGRSZXN1bHQgfSBmcm9tICcuLi8uLi9tYW5hZ2VyL2J1aWxkLXJlc3VsdCc7XHJcbmltcG9ydCB7IGNvbXByZXNzVXVpZCB9IGZyb20gJy4uLy4uL3V0aWxzJztcclxuXHJcbmV4cG9ydCBjb25zdCB0aXRsZSA9ICdpMThuOmJ1aWxkZXIudGFza3Muc2V0dGluZ3Mub3B0aW9ucyc7XHJcblxyXG5jb25zdCBsYXllck1hc2s6IG51bWJlcltdID0gW107XHJcbmZvciAobGV0IGkgPSAwOyBpIDw9IDE5OyBpKyspIHtcclxuICAgIGxheWVyTWFza1tpXSA9IDEgPDwgaTtcclxufVxyXG5cclxuLyoqXHJcbiAqIOagueaNrumAiemhueWhq+WFhSBzZXR0aW5nc1xyXG4gKiBAcGFyYW0gb3B0aW9uc1xyXG4gKiBAcGFyYW0gc2V0dGluZ3NcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGUodGhpczogSUJ1aWxkZXIsIG9wdGlvbnM6IElJbnRlcm5hbEJ1aWxkT3B0aW9ucywgcmVzdWx0OiBJbnRlcm5hbEJ1aWxkUmVzdWx0LCBjYWNoZTogQnVpbGRlckFzc2V0Q2FjaGUpIHtcclxuICAgIGNvbnN0IGJ1bmRsZXMgPSB0aGlzLmJ1bmRsZU1hbmFnZXIuYnVuZGxlcy5maWx0ZXIoKGJ1bmRsZSkgPT4gYnVuZGxlLm91dHB1dCk7XHJcbiAgICBmb3IgKGNvbnN0IGJ1bmRsZSBvZiBidW5kbGVzKSB7XHJcbiAgICAgICAgaWYgKGJ1bmRsZS5uYW1lID09PSBCdWlsdGluQnVuZGxlTmFtZS5SRVNPVVJDRVMpIHtcclxuICAgICAgICAgICAgcmVzdWx0LnNldHRpbmdzLmFzc2V0cy5wcmVsb2FkQnVuZGxlcy5wdXNoKHsgYnVuZGxlOiBCdWlsdGluQnVuZGxlTmFtZS5SRVNPVVJDRVMgfSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChidW5kbGUubmFtZSA9PT0gQnVpbHRpbkJ1bmRsZU5hbWUuU1RBUlRfU0NFTkUpIHtcclxuICAgICAgICAgICAgcmVzdWx0LnNldHRpbmdzLmFzc2V0cy5wcmVsb2FkQnVuZGxlcy5wdXNoKHsgYnVuZGxlOiBCdWlsdGluQnVuZGxlTmFtZS5TVEFSVF9TQ0VORSB9KTtcclxuICAgICAgICB9IGVsc2UgaWYgKGJ1bmRsZS5uYW1lID09PSBCdWlsdGluQnVuZGxlTmFtZS5NQUlOKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5zZXR0aW5ncy5hc3NldHMucHJlbG9hZEJ1bmRsZXMucHVzaCh7IGJ1bmRsZTogQnVpbHRpbkJ1bmRsZU5hbWUuTUFJTiB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGJ1bmRsZS5pc1JlbW90ZSkge1xyXG4gICAgICAgICAgICByZXN1bHQuc2V0dGluZ3MuYXNzZXRzLnJlbW90ZUJ1bmRsZXMucHVzaChidW5kbGUubmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChidW5kbGUuaXNTdWJwYWNrYWdlKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5zZXR0aW5ncy5hc3NldHMuc3VicGFja2FnZXMucHVzaChidW5kbGUubmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgaWYgKCFvcHRpb25zLnByZXZpZXcpIHtcclxuICAgICAgICBjb25zdCBzdGFydFNjZW5lQXNzZXQgPSBidWlsZEFzc2V0TGlicmFyeS5nZXRBc3NldChvcHRpb25zLnN0YXJ0U2NlbmUpO1xyXG4gICAgICAgIGlmICghc3RhcnRTY2VuZUFzc2V0KSB7XHJcbiAgICAgICAgICAgIC8vIOeQhuiuuuS4iui/m+WFpeaehOW7uuWJjeW6lOivpeW3sue7j+agoemqjOi/h++8jOi/memHjOi/mOaYr+agoemqjOS4gOS4i+e7meS4gOS4quWPr+mYheivu+eahOaKpemUmVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NhbiBub3QgZmluZCBzdGFydCBzY2VuZSBhc3NldCBieSB1dWlkIG9yIHVybDogJyArIG9wdGlvbnMuc3RhcnRTY2VuZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG9wdGlvbnMuc3RhcnRTY2VuZSA9IHN0YXJ0U2NlbmVBc3NldC51cmw7XHJcbiAgICB9XHJcbiAgICBpZiAoIW9wdGlvbnMuZGVidWcpIHtcclxuICAgICAgICByZXN1bHQuc2V0dGluZ3MucmVuZGVyaW5nLnJlbmRlclBpcGVsaW5lID0gY29tcHJlc3NVdWlkKHJlc3VsdC5zZXR0aW5ncy5yZW5kZXJpbmcucmVuZGVyUGlwZWxpbmUsIHRydWUpO1xyXG4gICAgfVxyXG4gICAgcmVzdWx0LnNldHRpbmdzLmFzc2V0cy5wcm9qZWN0QnVuZGxlcyA9IGJ1bmRsZXMubWFwKChidW5kbGU6IElCdW5kbGUpID0+IGJ1bmRsZS5uYW1lKTtcclxuICAgIHJlc3VsdC5zZXR0aW5ncy5lbmdpbmUuYnVpbHRpbkFzc2V0cyA9IEFycmF5LmZyb20odGhpcy5idW5kbGVNYW5hZ2VyLmJ1bmRsZU1hcFtCdWlsdGluQnVuZGxlTmFtZS5JTlRFUk5BTF0uX3Jvb3RBc3NldHMpO1xyXG59XHJcbiJdfQ==