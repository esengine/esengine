"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.bundleDataTask = bundleDataTask;
exports.bundleOutputTask = bundleOutputTask;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
const asset_library_1 = require("../../manager/asset-library");
function bundleDataTask(bundle, imageCompressManager) {
    bundle.assetsWithoutRedirect.forEach((uuid) => {
        const assetInfo = asset_library_1.buildAssetLibrary.getAsset(uuid);
        const task = imageCompressManager.addTaskWithAssetInfo(assetInfo);
        if (task) {
            bundle.compressTask[assetInfo.uuid] = task;
        }
    });
    console.debug(`init image compress task ${Object.keys(bundle.compressTask).length} in bundle ${bundle.name}`);
}
async function bundleOutputTask(bundle, cache) {
    await Promise.all(Object.keys(bundle.compressTask).map(async (uuid) => {
        const task = bundle.compressTask[uuid];
        if (!task.dest || !task.dest.length) {
            // 需要移除任务记录，后续将以此判断压缩任务是否被有效执行
            delete bundle.compressTask[uuid];
            return;
        }
        const realSuffix = [];
        bundle.compressRes[uuid] = [];
        await Promise.all(task.dest.map(async (path, index) => {
            if (!(0, fs_extra_1.existsSync)(path)) {
                return;
            }
            const dest = (0, path_1.join)(bundle.dest, bundle.nativeBase, uuid.substr(0, 2), (0, path_1.basename)(path));
            await (0, fs_extra_1.copy)(path, dest);
            realSuffix.push(task.suffix[index]);
            bundle.compressRes[uuid].push(dest);
        }));
        // 写入新增 instance , 后续进行 json 处理的时候，就能带上这个数据了
        const assetInstance = await cache.getInstance(uuid);
        assetInstance._exportedExts = realSuffix.sort();
        cache.addInstance(assetInstance);
    }));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dHVyZS1jb21wcmVzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL2J1aWxkZXIvd29ya2VyL2J1aWxkZXIvYXNzZXQtaGFuZGxlci9idW5kbGUvdGV4dHVyZS1jb21wcmVzcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQU9BLHdDQVVDO0FBRUQsNENBMEJDO0FBN0NELHVDQUFvRDtBQUNwRCwrQkFBc0M7QUFDdEMsK0RBQWdFO0FBS2hFLFNBQWdCLGNBQWMsQ0FBQyxNQUFlLEVBQUUsb0JBQXFDO0lBQ2pGLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtRQUMxQyxNQUFNLFNBQVMsR0FBRyxpQ0FBaUIsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbkQsTUFBTSxJQUFJLEdBQUcsb0JBQW9CLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDbEUsSUFBSSxJQUFJLEVBQUUsQ0FBQztZQUNQLE1BQU0sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQztRQUMvQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxPQUFPLENBQUMsS0FBSyxDQUFDLDRCQUE0QixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxNQUFNLGNBQWMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7QUFDbEgsQ0FBQztBQUVNLEtBQUssVUFBVSxnQkFBZ0IsQ0FBQyxNQUFlLEVBQUUsS0FBd0I7SUFDNUUsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQUU7UUFDbEUsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2QyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDbEMsOEJBQThCO1lBQzlCLE9BQU8sTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNqQyxPQUFPO1FBQ1gsQ0FBQztRQUNELE1BQU0sVUFBVSxHQUFhLEVBQUUsQ0FBQztRQUNoQyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUM5QixNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRTtZQUNsRCxJQUFJLENBQUMsSUFBQSxxQkFBVSxFQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7Z0JBQ3BCLE9BQU87WUFDWCxDQUFDO1lBQ0QsTUFBTSxJQUFJLEdBQUcsSUFBQSxXQUFJLEVBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLElBQUEsZUFBUSxFQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDckYsTUFBTSxJQUFBLGVBQUksRUFBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFFdkIsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDcEMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDeEMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVKLDRDQUE0QztRQUM1QyxNQUFNLGFBQWEsR0FBRyxNQUFNLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDcEQsYUFBYSxDQUFDLGFBQWEsR0FBRyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDaEQsS0FBSyxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNyQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ1IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGV4aXN0c1N5bmMsIGNvcHksIHJlbW92ZSB9IGZyb20gJ2ZzLWV4dHJhJztcclxuaW1wb3J0IHsgYmFzZW5hbWUsIGpvaW4gfSBmcm9tICdwYXRoJztcclxuaW1wb3J0IHsgYnVpbGRBc3NldExpYnJhcnkgfSBmcm9tICcuLi8uLi9tYW5hZ2VyL2Fzc2V0LWxpYnJhcnknO1xyXG5pbXBvcnQgeyBUZXh0dXJlQ29tcHJlc3MgfSBmcm9tICcuLi90ZXh0dXJlLWNvbXByZXNzJztcclxuaW1wb3J0IHsgSUJ1bmRsZSB9IGZyb20gJy4uLy4uLy4uLy4uL0B0eXBlcy9wcm90ZWN0ZWQnO1xyXG5pbXBvcnQgeyBCdWlsZGVyQXNzZXRDYWNoZSB9IGZyb20gJy4uLy4uL21hbmFnZXIvYXNzZXQnO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGJ1bmRsZURhdGFUYXNrKGJ1bmRsZTogSUJ1bmRsZSwgaW1hZ2VDb21wcmVzc01hbmFnZXI6IFRleHR1cmVDb21wcmVzcykge1xyXG4gICAgYnVuZGxlLmFzc2V0c1dpdGhvdXRSZWRpcmVjdC5mb3JFYWNoKCh1dWlkKSA9PiB7XHJcbiAgICAgICAgY29uc3QgYXNzZXRJbmZvID0gYnVpbGRBc3NldExpYnJhcnkuZ2V0QXNzZXQodXVpZCk7XHJcbiAgICAgICAgY29uc3QgdGFzayA9IGltYWdlQ29tcHJlc3NNYW5hZ2VyLmFkZFRhc2tXaXRoQXNzZXRJbmZvKGFzc2V0SW5mbyk7XHJcbiAgICAgICAgaWYgKHRhc2spIHtcclxuICAgICAgICAgICAgYnVuZGxlLmNvbXByZXNzVGFza1thc3NldEluZm8udXVpZF0gPSB0YXNrO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnNvbGUuZGVidWcoYGluaXQgaW1hZ2UgY29tcHJlc3MgdGFzayAke09iamVjdC5rZXlzKGJ1bmRsZS5jb21wcmVzc1Rhc2spLmxlbmd0aH0gaW4gYnVuZGxlICR7YnVuZGxlLm5hbWV9YCk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBidW5kbGVPdXRwdXRUYXNrKGJ1bmRsZTogSUJ1bmRsZSwgY2FjaGU6IEJ1aWxkZXJBc3NldENhY2hlKSB7XHJcbiAgICBhd2FpdCBQcm9taXNlLmFsbChPYmplY3Qua2V5cyhidW5kbGUuY29tcHJlc3NUYXNrKS5tYXAoYXN5bmMgKHV1aWQpID0+IHtcclxuICAgICAgICBjb25zdCB0YXNrID0gYnVuZGxlLmNvbXByZXNzVGFza1t1dWlkXTtcclxuICAgICAgICBpZiAoIXRhc2suZGVzdCB8fCAhdGFzay5kZXN0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgICAvLyDpnIDopoHnp7vpmaTku7vliqHorrDlvZXvvIzlkI7nu63lsIbku6XmraTliKTmlq3ljovnvKnku7vliqHmmK/lkKbooqvmnInmlYjmiafooYxcclxuICAgICAgICAgICAgZGVsZXRlIGJ1bmRsZS5jb21wcmVzc1Rhc2tbdXVpZF07XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcmVhbFN1ZmZpeDogc3RyaW5nW10gPSBbXTtcclxuICAgICAgICBidW5kbGUuY29tcHJlc3NSZXNbdXVpZF0gPSBbXTtcclxuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbCh0YXNrLmRlc3QubWFwKGFzeW5jIChwYXRoLCBpbmRleCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIWV4aXN0c1N5bmMocGF0aCkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBkZXN0ID0gam9pbihidW5kbGUuZGVzdCwgYnVuZGxlLm5hdGl2ZUJhc2UsIHV1aWQuc3Vic3RyKDAsIDIpLCBiYXNlbmFtZShwYXRoKSk7XHJcbiAgICAgICAgICAgIGF3YWl0IGNvcHkocGF0aCwgZGVzdCk7XHJcblxyXG4gICAgICAgICAgICByZWFsU3VmZml4LnB1c2godGFzay5zdWZmaXhbaW5kZXhdKTtcclxuICAgICAgICAgICAgYnVuZGxlLmNvbXByZXNzUmVzW3V1aWRdLnB1c2goZGVzdCk7XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICAvLyDlhpnlhaXmlrDlop4gaW5zdGFuY2UgLCDlkI7nu63ov5vooYwganNvbiDlpITnkIbnmoTml7blgJnvvIzlsLHog73luKbkuIrov5nkuKrmlbDmja7kuoZcclxuICAgICAgICBjb25zdCBhc3NldEluc3RhbmNlID0gYXdhaXQgY2FjaGUuZ2V0SW5zdGFuY2UodXVpZCk7XHJcbiAgICAgICAgYXNzZXRJbnN0YW5jZS5fZXhwb3J0ZWRFeHRzID0gcmVhbFN1ZmZpeC5zb3J0KCk7XHJcbiAgICAgICAgY2FjaGUuYWRkSW5zdGFuY2UoYXNzZXRJbnN0YW5jZSk7XHJcbiAgICB9KSk7XHJcbn0iXX0=