"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MemoryTrack = void 0;
exports.formateBytes = formateBytes;
exports.getMemorySize = getMemorySize;
/**
 * 内存统计 构建内存性能测试 A022
 */
class MemoryTrack {
    _startMemory = 0;
    _maxMemory = 0;
    _interval = 0;
    _intervalId = null;
    // 是否开启内存统计
    static enabled = false;
    _lastMemory = 0;
    constructor(interval = 1000) {
        this._interval = interval;
    }
    start() {
        if (!MemoryTrack.enabled) {
            return;
        }
        console.debug(`memory track start, ${getMemorySize()}`);
        this._startMemory = this.currentMemory;
        this._intervalId = setInterval(() => {
            const currentMemory = this.currentMemory;
            this._maxMemory = Math.max(this._maxMemory, currentMemory);
            const increment = currentMemory - this._lastMemory;
            if (increment < 0) {
                return;
            }
            if (increment > 1024 * 1024 * 5) {
                console.debug(`memory track increment > 1M, increment: ${formateBytes(increment)}, current: ${formateBytes(currentMemory)}, last: ${formateBytes(this._lastMemory)}`);
                this._lastMemory = currentMemory;
            }
        }, this._interval);
    }
    stop() {
        if (!MemoryTrack.enabled) {
            return;
        }
        if (this._intervalId) {
            console.debug(`memory track stop, ${getMemorySize()}`);
            clearInterval(this._intervalId);
            this.printResult();
        }
    }
    get memoryUsage() {
        return this._maxMemory - this._startMemory;
    }
    get currentMemory() {
        return process.memoryUsage().heapUsed;
    }
    // 打印内存使用情况
    printResult() {
        if (!MemoryTrack.enabled) {
            return;
        }
        console.log(`memory track usage: ${formateBytes(this.memoryUsage)}`);
    }
}
exports.MemoryTrack = MemoryTrack;
function formateBytes(bytes) {
    const data = bytes / 1024 / 1024;
    if (data < 1) {
        return (bytes / 1024).toFixed(2) + 'KB';
    }
    return (data).toFixed(2) + 'MB';
}
/**
 * 获取当前内存占用
 */
function getMemorySize() {
    const memory = process.memoryUsage();
    return 'Process: heapTotal ' + formateBytes(memory.heapTotal) + ' heapUsed ' + formateBytes(memory.heapUsed) + ' rss ' + formateBytes(memory.rss);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVtb3J5LXRyYWNrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvYnVpbGRlci93b3JrZXIvYnVpbGRlci91dGlscy9tZW1vcnktdHJhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBaUVBLG9DQU1DO0FBS0Qsc0NBR0M7QUE5RUQ7O0dBRUc7QUFDSCxNQUFhLFdBQVc7SUFDWixZQUFZLEdBQUcsQ0FBQyxDQUFDO0lBQ2pCLFVBQVUsR0FBRyxDQUFDLENBQUM7SUFDZixTQUFTLEdBQUcsQ0FBQyxDQUFDO0lBQ2QsV0FBVyxHQUEwQixJQUFJLENBQUM7SUFDbEQsV0FBVztJQUNYLE1BQU0sQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO0lBQ2YsV0FBVyxHQUFHLENBQUMsQ0FBQztJQUV4QixZQUFZLFFBQVEsR0FBRyxJQUFJO1FBQ3ZCLElBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDO0lBQzlCLENBQUM7SUFFRCxLQUFLO1FBQ0QsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUN2QixPQUFPO1FBQ1gsQ0FBQztRQUNELE9BQU8sQ0FBQyxLQUFLLENBQUMsdUJBQXVCLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUM7UUFDdkMsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUMsR0FBRyxFQUFFO1lBQ2hDLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUM7WUFDekMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsYUFBYSxDQUFDLENBQUM7WUFDM0QsTUFBTSxTQUFTLEdBQUcsYUFBYSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7WUFDbkQsSUFBSSxTQUFTLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQ2hCLE9BQU87WUFDWCxDQUFDO1lBQ0QsSUFBSSxTQUFTLEdBQUcsSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLEVBQUUsQ0FBQztnQkFDOUIsT0FBTyxDQUFDLEtBQUssQ0FBQywyQ0FBMkMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxjQUFjLFlBQVksQ0FBQyxhQUFhLENBQUMsV0FBVyxZQUFZLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDdEssSUFBSSxDQUFDLFdBQVcsR0FBRyxhQUFhLENBQUM7WUFDckMsQ0FBQztRQUNMLENBQUMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDdkIsQ0FBQztJQUVELElBQUk7UUFDQSxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3ZCLE9BQU87UUFDWCxDQUFDO1FBQ0QsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDbkIsT0FBTyxDQUFDLEtBQUssQ0FBQyxzQkFBc0IsYUFBYSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZELGFBQWEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDaEMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3ZCLENBQUM7SUFDTCxDQUFDO0lBRUQsSUFBSSxXQUFXO1FBQ1gsT0FBTyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUM7SUFDL0MsQ0FBQztJQUVELElBQUksYUFBYTtRQUNiLE9BQU8sT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQztJQUMxQyxDQUFDO0lBRUQsV0FBVztJQUNYLFdBQVc7UUFDUCxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3ZCLE9BQU87UUFDWCxDQUFDO1FBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsWUFBWSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDekUsQ0FBQzs7QUExREwsa0NBMkRDO0FBRUQsU0FBZ0IsWUFBWSxDQUFDLEtBQWE7SUFDdEMsTUFBTSxJQUFJLEdBQUcsS0FBSyxHQUFHLElBQUksR0FBRyxJQUFJLENBQUM7SUFDakMsSUFBSSxJQUFJLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDWCxPQUFPLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDNUMsQ0FBQztJQUNELE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO0FBQ3BDLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQWdCLGFBQWE7SUFDekIsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3JDLE9BQU8scUJBQXFCLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxZQUFZLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxPQUFPLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN0SixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbi8qKlxyXG4gKiDlhoXlrZjnu5/orqEg5p6E5bu65YaF5a2Y5oCn6IO95rWL6K+VIEEwMjJcclxuICovXHJcbmV4cG9ydCBjbGFzcyBNZW1vcnlUcmFjayB7XHJcbiAgICBwcml2YXRlIF9zdGFydE1lbW9yeSA9IDA7XHJcbiAgICBwcml2YXRlIF9tYXhNZW1vcnkgPSAwO1xyXG4gICAgcHJpdmF0ZSBfaW50ZXJ2YWwgPSAwO1xyXG4gICAgcHJpdmF0ZSBfaW50ZXJ2YWxJZDogTm9kZUpTLlRpbWVvdXQgfCBudWxsID0gbnVsbDtcclxuICAgIC8vIOaYr+WQpuW8gOWQr+WGheWtmOe7n+iuoVxyXG4gICAgc3RhdGljIGVuYWJsZWQgPSBmYWxzZTtcclxuICAgIHByaXZhdGUgX2xhc3RNZW1vcnkgPSAwO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGludGVydmFsID0gMTAwMCkge1xyXG4gICAgICAgIHRoaXMuX2ludGVydmFsID0gaW50ZXJ2YWw7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhcnQoKSB7XHJcbiAgICAgICAgaWYgKCFNZW1vcnlUcmFjay5lbmFibGVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc29sZS5kZWJ1ZyhgbWVtb3J5IHRyYWNrIHN0YXJ0LCAke2dldE1lbW9yeVNpemUoKX1gKTtcclxuICAgICAgICB0aGlzLl9zdGFydE1lbW9yeSA9IHRoaXMuY3VycmVudE1lbW9yeTtcclxuICAgICAgICB0aGlzLl9pbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBjdXJyZW50TWVtb3J5ID0gdGhpcy5jdXJyZW50TWVtb3J5O1xyXG4gICAgICAgICAgICB0aGlzLl9tYXhNZW1vcnkgPSBNYXRoLm1heCh0aGlzLl9tYXhNZW1vcnksIGN1cnJlbnRNZW1vcnkpO1xyXG4gICAgICAgICAgICBjb25zdCBpbmNyZW1lbnQgPSBjdXJyZW50TWVtb3J5IC0gdGhpcy5fbGFzdE1lbW9yeTtcclxuICAgICAgICAgICAgaWYgKGluY3JlbWVudCA8IDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoaW5jcmVtZW50ID4gMTAyNCAqIDEwMjQgKiA1KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKGBtZW1vcnkgdHJhY2sgaW5jcmVtZW50ID4gMU0sIGluY3JlbWVudDogJHtmb3JtYXRlQnl0ZXMoaW5jcmVtZW50KX0sIGN1cnJlbnQ6ICR7Zm9ybWF0ZUJ5dGVzKGN1cnJlbnRNZW1vcnkpfSwgbGFzdDogJHtmb3JtYXRlQnl0ZXModGhpcy5fbGFzdE1lbW9yeSl9YCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9sYXN0TWVtb3J5ID0gY3VycmVudE1lbW9yeTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sIHRoaXMuX2ludGVydmFsKTtcclxuICAgIH1cclxuXHJcbiAgICBzdG9wKCkge1xyXG4gICAgICAgIGlmICghTWVtb3J5VHJhY2suZW5hYmxlZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLl9pbnRlcnZhbElkKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYG1lbW9yeSB0cmFjayBzdG9wLCAke2dldE1lbW9yeVNpemUoKX1gKTtcclxuICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9pbnRlcnZhbElkKTtcclxuICAgICAgICAgICAgdGhpcy5wcmludFJlc3VsdCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXQgbWVtb3J5VXNhZ2UoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX21heE1lbW9yeSAtIHRoaXMuX3N0YXJ0TWVtb3J5O1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBjdXJyZW50TWVtb3J5KCkge1xyXG4gICAgICAgIHJldHVybiBwcm9jZXNzLm1lbW9yeVVzYWdlKCkuaGVhcFVzZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5omT5Y2w5YaF5a2Y5L2/55So5oOF5Ya1XHJcbiAgICBwcmludFJlc3VsdCgpIHtcclxuICAgICAgICBpZiAoIU1lbW9yeVRyYWNrLmVuYWJsZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zb2xlLmxvZyhgbWVtb3J5IHRyYWNrIHVzYWdlOiAke2Zvcm1hdGVCeXRlcyh0aGlzLm1lbW9yeVVzYWdlKX1gKTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdGVCeXRlcyhieXRlczogbnVtYmVyKSB7XHJcbiAgICBjb25zdCBkYXRhID0gYnl0ZXMgLyAxMDI0IC8gMTAyNDtcclxuICAgIGlmIChkYXRhIDwgMSkge1xyXG4gICAgICAgIHJldHVybiAoYnl0ZXMgLyAxMDI0KS50b0ZpeGVkKDIpICsgJ0tCJztcclxuICAgIH1cclxuICAgIHJldHVybiAoZGF0YSkudG9GaXhlZCgyKSArICdNQic7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDojrflj5blvZPliY3lhoXlrZjljaDnlKhcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRNZW1vcnlTaXplKCkge1xyXG4gICAgY29uc3QgbWVtb3J5ID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpO1xyXG4gICAgcmV0dXJuICdQcm9jZXNzOiBoZWFwVG90YWwgJyArIGZvcm1hdGVCeXRlcyhtZW1vcnkuaGVhcFRvdGFsKSArICcgaGVhcFVzZWQgJyArIGZvcm1hdGVCeXRlcyhtZW1vcnkuaGVhcFVzZWQpICsgJyByc3MgJyArIGZvcm1hdGVCeXRlcyhtZW1vcnkucnNzKTtcclxufSJdfQ==