"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TexturePacker = void 0;
exports.packAutoAtlas = packAutoAtlas;
exports.queryAutoAtlasFileCache = queryAutoAtlasFileCache;
exports.querySpriteToAutoAtlas = querySpriteToAutoAtlas;
const fs_extra_1 = require("fs-extra");
const lodash_1 = __importDefault(require("lodash"));
const path_1 = require("path");
const asset_library_1 = require("../../manager/asset-library");
const config_1 = require("./config");
const pac_info_1 = require("./pac-info");
const packer_1 = require("./packer");
const utils_1 = require("../../utils");
// 管理自动图集缓存，提供对外接口
class TexturePacker {
    pacInfos = [];
    /**
     * 是否使用缓存
     */
    static useCache = true;
    static getCacheDirWithUuid(packUuid, mode = 'build') {
        return (0, path_1.join)(asset_library_1.buildAssetLibrary.getAssetTempDirByUuid(packUuid), 'texture-packer' + mode);
    }
    static async packSingle(pacAsset, option) {
        const pacInfo = await new pac_info_1.PacInfo(pacAsset, option).initSpriteFramesWithRange();
        return TexturePacker.internalPack(pacInfo);
    }
    static queryPacStoredPath(pacInfo) {
        const cacheTempDir = TexturePacker.getCacheDirWithUuid(pacInfo.uuid, pacInfo.packOptions.mode);
        return (0, path_1.join)(cacheTempDir, 'pac-info.json');
    }
    async init(pacAssets, assetsRange) {
        const pacInfos = [];
        await Promise.all(pacAssets.map(async (pacAsset) => {
            if (pacAsset.url.startsWith('db://internal/default_file_content')) {
                return;
            }
            const pacInfo = await new pac_info_1.PacInfo(pacAsset).initSpriteFramesWithRange(assetsRange);
            if (pacInfo.spriteFrameInfos.length === 0) {
                return;
            }
            pacInfos.push(pacInfo);
        }));
        this.pacInfos = pacInfos;
        return this;
    }
    async pack() {
        return await Promise.all(this.pacInfos.map((pacInfo) => {
            return TexturePacker.internalPack(pacInfo);
        }));
    }
    static async internalPack(pacInfo) {
        let storedPacInfo = null;
        const storedPacInfoPath = TexturePacker.queryPacStoredPath(pacInfo);
        if (TexturePacker.useCache) {
            const res = TexturePacker.getPacResFromCache(pacInfo, storedPacInfoPath);
            if (res.result) {
                pacInfo.result = res.result;
                pacInfo.dirty = false;
                return pacInfo;
            }
            storedPacInfo = res;
            pacInfo.dirty = true;
        }
        const destDir = this.getCacheDirWithUuid(pacInfo.uuid, pacInfo.packOptions.mode);
        (0, fs_extra_1.emptyDirSync)(destDir);
        if (pacInfo.spriteFrameInfos && pacInfo.spriteFrameInfos.length) {
            // TODO 开启子进程打包图集
            const result = await (0, packer_1.packer)(pacInfo.spriteFrameInfos, {
                ...pacInfo.packOptions,
                destDir,
                name: pacInfo.name,
            });
            pacInfo.result = result;
            if (TexturePacker.useCache) {
                storedPacInfo = storedPacInfo || TexturePacker.genNewStoredInfo(pacInfo);
                storedPacInfo.result = result;
                try {
                    (0, fs_extra_1.outputJSONSync)(storedPacInfoPath, storedPacInfo, { spaces: 2 });
                }
                catch (error) {
                    console.debug('write pac info cache failed');
                    console.error(error);
                }
            }
        }
        return pacInfo;
    }
    static getStoredPacInfo(pacInfo, storedPacInfoPath) {
        storedPacInfoPath = storedPacInfoPath || TexturePacker.queryPacStoredPath(pacInfo);
        const res = {
            newStoredPacInfo: TexturePacker.genNewStoredInfo(pacInfo),
            storedPacInfo: null,
        };
        if (!(0, fs_extra_1.existsSync)(storedPacInfoPath)) {
            return res;
        }
        try {
            res.storedPacInfo = (0, fs_extra_1.readJSONSync)(storedPacInfoPath);
        }
        catch (error) {
            console.debug(error);
        }
        return res;
    }
    static genNewStoredInfo(pacInfo) {
        const newStoredPacInfo = {
            md5: '',
            versionDev: config_1.versionDev,
            sharpMd5: (0, utils_1.calcMd5)(JSON.stringify(require('sharp').versions)),
        };
        // 对图片进行排序，确保每次重新计算 md5 一致
        pacInfo.storeInfo.sprites = lodash_1.default.sortBy(pacInfo.storeInfo.sprites, 'uuid');
        // TODO 字符串计算 md5 可能导致计算结果不稳定
        newStoredPacInfo.md5 = (0, utils_1.calcMd5)(JSON.stringify({
            packStoreInfo: pacInfo.storeInfo,
            versionDev: config_1.versionDev,
            sharpMd5: newStoredPacInfo.sharpMd5,
        }));
        return newStoredPacInfo;
    }
    static getPacResFromCache(pacInfo, storedPacInfoPath) {
        const { storedPacInfo, newStoredPacInfo } = TexturePacker.getStoredPacInfo(pacInfo, storedPacInfoPath);
        let dirty = (!storedPacInfo || newStoredPacInfo.md5 !== storedPacInfo.md5);
        if (dirty) {
            return newStoredPacInfo;
        }
        try {
            for (const atlas of storedPacInfo.result.atlases) {
                // 需要检查所有缓存的图集资源是否依旧正常存在
                if (!(0, fs_extra_1.existsSync)(atlas.imagePath)) {
                    dirty = true;
                    break;
                }
            }
            newStoredPacInfo.result = storedPacInfo.result;
        }
        catch (error) {
            console.warn(`Get Cache info of pac failed {asset(${pacInfo.uuid})}`);
            console.warn(error);
        }
        console.debug(`Get Cache info of pac success {asset(${pacInfo.uuid})}`);
        return newStoredPacInfo;
    }
    static async queryPacCache(pacUuid) {
        const pacInfo = new pac_info_1.PacInfo(asset_library_1.buildAssetLibrary.getAsset(pacUuid));
        // 将会决定获取的缓存位置
        pacInfo.packOptions.mode = 'preview';
        // 由于此接口还要获取最新的图集信息对比缓存是否失效，因而此处虽不需要生成预览图但需要初始化
        await pacInfo.initSpriteFramesWithRange();
        const cacheInfo = TexturePacker.getStoredPacInfo(pacInfo);
        if (!cacheInfo || !cacheInfo.storedPacInfo || !cacheInfo.storedPacInfo.result || cacheInfo.storedPacInfo.md5 !== cacheInfo.newStoredPacInfo.md5) {
            return null;
        }
        const pacRes = cacheInfo.storedPacInfo.result;
        return {
            unpackedImages: pacRes.unpackedImages,
            dirty: false,
            atlasImagePaths: cacheInfo.storedPacInfo.result.atlases.map((info) => info.imagePath),
            atlases: cacheInfo.storedPacInfo.result.atlases,
            storeInfo: pacInfo.storeInfo,
        };
    }
}
exports.TexturePacker = TexturePacker;
async function packAutoAtlas(pacUuid, option) {
    if (!option) {
        option = {};
    }
    option.mode = 'preview';
    try {
        const pacInfo = await TexturePacker.packSingle(asset_library_1.buildAssetLibrary.getAsset(pacUuid), option);
        if (!pacInfo.spriteFrames.length) {
            console.warn(`No invalid SpriteFrame found in folder [{link(${(0, path_1.dirname)(pacInfo.path)})}]. Please check the AutoAtlas [{link(${pacInfo.path})}].`);
        }
        if (!pacInfo.result) {
            return null;
        }
        const atlasImagePaths = pacInfo.result.atlases.map((info) => info.imagePath);
        return {
            atlasImagePaths,
            unpackedImages: pacInfo.result.unpackedImages,
            dirty: pacInfo.dirty,
            storeInfo: pacInfo.storeInfo,
            atlases: pacInfo.result.atlases,
        };
    }
    catch (error) {
        console.error(error);
    }
    return null;
}
/**
 * 查询某个图集的预览缓存
 * @param pacUuid
 */
function queryAutoAtlasFileCache(pacUuid) {
    return TexturePacker.queryPacCache(pacUuid);
}
async function querySpriteToAutoAtlas(spriteUuid) {
    const info = asset_library_1.buildAssetLibrary.getAsset(spriteUuid);
    if (info.url.startsWith('db://internal')) {
        return null;
    }
    // 找到小图所在 db 所有的图集信息
    const allPacs = asset_library_1.buildAssetLibrary.queryAssetsByOptions({
        pattern: `db://${info._assetDB.options.name}/**/*.pac`,
    });
    if (!allPacs.length) {
        return null;
    }
    const packer = new TexturePacker();
    await packer.init(allPacs);
    const targetPackInfo = packer.pacInfos.find((pacInfo) => !!pacInfo.spriteFrameInfos.find((spriteInfo) => spriteInfo.uuid === spriteUuid));
    if (!targetPackInfo) {
        return null;
    }
    return {
        url: targetPackInfo.path,
        uuid: targetPackInfo.uuid,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9idWlsZGVyL3dvcmtlci9idWlsZGVyL2Fzc2V0LWhhbmRsZXIvdGV4dHVyZS1wYWNrZXIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBOEtBLHNDQTBCQztBQU1ELDBEQUVDO0FBRUQsd0RBNEJDO0FBN09ELHVDQUFrRjtBQUNsRixvREFBNEI7QUFDNUIsK0JBQXFDO0FBQ3JDLCtEQUFnRTtBQUNoRSxxQ0FBc0M7QUFDdEMseUNBQXFDO0FBQ3JDLHFDQUFrQztBQUdsQyx1Q0FBc0M7QUFFdEMsa0JBQWtCO0FBQ2xCLE1BQWEsYUFBYTtJQUV0QixRQUFRLEdBQWMsRUFBRSxDQUFDO0lBRXpCOztPQUVHO0lBQ0gsTUFBTSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7SUFFZixNQUFNLENBQUMsbUJBQW1CLENBQUMsUUFBZ0IsRUFBRSxPQUE0QixPQUFPO1FBQ3BGLE9BQU8sSUFBQSxXQUFJLEVBQUMsaUNBQWlCLENBQUMscUJBQXFCLENBQUMsUUFBUSxDQUFDLEVBQUUsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLENBQUM7SUFDNUYsQ0FBQztJQUVELE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLFFBQWdCLEVBQUUsTUFBOEI7UUFDcEUsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLGtCQUFPLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDLHlCQUF5QixFQUFFLENBQUM7UUFDaEYsT0FBTyxhQUFhLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFRCxNQUFNLENBQUMsa0JBQWtCLENBQUMsT0FBZ0I7UUFDdEMsTUFBTSxZQUFZLEdBQUcsYUFBYSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztR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SSxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7SUFDMUksSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ2xCLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxPQUFPO1FBQ0gsR0FBRyxFQUFFLGNBQWMsQ0FBQyxJQUFJO1FBQ3hCLElBQUksRUFBRSxjQUFjLENBQUMsSUFBSTtLQUM1QixDQUFDO0FBQ04sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFzc2V0LCBWaXJ0dWFsQXNzZXQgfSBmcm9tICdAY29jb3MvYXNzZXQtZGInO1xyXG5pbXBvcnQgeyBlbXB0eURpclN5bmMsIGV4aXN0c1N5bmMsIG91dHB1dEpTT05TeW5jLCByZWFkSlNPTlN5bmMgfSBmcm9tICdmcy1leHRyYSc7XHJcbmltcG9ydCBsb2Rhc2ggZnJvbSAnbG9kYXNoJztcclxuaW1wb3J0IHsgZGlybmFtZSwgam9pbiB9IGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgeyBidWlsZEFzc2V0TGlicmFyeSB9IGZyb20gJy4uLy4uL21hbmFnZXIvYXNzZXQtbGlicmFyeSc7XHJcbmltcG9ydCB7IHZlcnNpb25EZXYgfSBmcm9tICcuL2NvbmZpZyc7XHJcbmltcG9ydCB7IFBhY0luZm8gfSBmcm9tICcuL3BhYy1pbmZvJztcclxuaW1wb3J0IHsgcGFja2VyIH0gZnJvbSAnLi9wYWNrZXInO1xyXG5pbXBvcnQgeyBJQXNzZXQgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi9hc3NldHMvQHR5cGVzL3Byb3RlY3RlZCc7XHJcbmltcG9ydCB7IElQYWNrT3B0aW9ucywgSVN0b3JlUGFja0luZm8sIFByZXZpZXdQYWNrUmVzdWx0IH0gZnJvbSAnLi4vLi4vLi4vLi4vQHR5cGVzL3Byb3RlY3RlZCc7XHJcbmltcG9ydCB7IGNhbGNNZDUgfSBmcm9tICcuLi8uLi91dGlscyc7XHJcblxyXG4vLyDnrqHnkIboh6rliqjlm77pm4bnvJPlrZjvvIzmj5Dkvpvlr7nlpJbmjqXlj6NcclxuZXhwb3J0IGNsYXNzIFRleHR1cmVQYWNrZXIge1xyXG5cclxuICAgIHBhY0luZm9zOiBQYWNJbmZvW10gPSBbXTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOaYr+WQpuS9v+eUqOe8k+WtmFxyXG4gICAgICovXHJcbiAgICBzdGF0aWMgdXNlQ2FjaGUgPSB0cnVlO1xyXG5cclxuICAgIHByaXZhdGUgc3RhdGljIGdldENhY2hlRGlyV2l0aFV1aWQocGFja1V1aWQ6IHN0cmluZywgbW9kZTogJ2J1aWxkJyB8ICdwcmV2aWV3JyA9ICdidWlsZCcpIHtcclxuICAgICAgICByZXR1cm4gam9pbihidWlsZEFzc2V0TGlicmFyeS5nZXRBc3NldFRlbXBEaXJCeVV1aWQocGFja1V1aWQpLCAndGV4dHVyZS1wYWNrZXInICsgbW9kZSk7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGFzeW5jIHBhY2tTaW5nbGUocGFjQXNzZXQ6IElBc3NldCwgb3B0aW9uPzogUGFydGlhbDxJUGFja09wdGlvbnM+KSB7XHJcbiAgICAgICAgY29uc3QgcGFjSW5mbyA9IGF3YWl0IG5ldyBQYWNJbmZvKHBhY0Fzc2V0LCBvcHRpb24pLmluaXRTcHJpdGVGcmFtZXNXaXRoUmFuZ2UoKTtcclxuICAgICAgICByZXR1cm4gVGV4dHVyZVBhY2tlci5pbnRlcm5hbFBhY2socGFjSW5mbyk7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIHF1ZXJ5UGFjU3RvcmVkUGF0aChwYWNJbmZvOiBQYWNJbmZvKSB7XHJcbiAgICAgICAgY29uc3QgY2FjaGVUZW1wRGlyID0gVGV4dHVyZVBhY2tlci5nZXRDYWNoZURpcldpdGhVdWlkKHBhY0luZm8udXVpZCwgcGFjSW5mby5wYWNrT3B0aW9ucy5tb2RlKTtcclxuICAgICAgICByZXR1cm4gam9pbihjYWNoZVRlbXBEaXIsICdwYWMtaW5mby5qc29uJyk7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgaW5pdChwYWNBc3NldHM6IEFycmF5PElBc3NldD4sIGFzc2V0c1JhbmdlPzogc3RyaW5nW10pIHtcclxuICAgICAgICBjb25zdCBwYWNJbmZvczogUGFjSW5mb1tdID0gW107XHJcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwocGFjQXNzZXRzLm1hcChhc3luYyAocGFjQXNzZXQpID0+IHtcclxuICAgICAgICAgICAgaWYgKHBhY0Fzc2V0LnVybC5zdGFydHNXaXRoKCdkYjovL2ludGVybmFsL2RlZmF1bHRfZmlsZV9jb250ZW50JykpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBwYWNJbmZvID0gYXdhaXQgbmV3IFBhY0luZm8ocGFjQXNzZXQpLmluaXRTcHJpdGVGcmFtZXNXaXRoUmFuZ2UoYXNzZXRzUmFuZ2UpO1xyXG4gICAgICAgICAgICBpZiAocGFjSW5mby5zcHJpdGVGcmFtZUluZm9zLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHBhY0luZm9zLnB1c2gocGFjSW5mbyk7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIHRoaXMucGFjSW5mb3MgPSBwYWNJbmZvcztcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBwYWNrKCk6IFByb21pc2U8UGFjSW5mb1tdPiB7XHJcbiAgICAgICAgcmV0dXJuIGF3YWl0IFByb21pc2UuYWxsKHRoaXMucGFjSW5mb3MubWFwKChwYWNJbmZvKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBUZXh0dXJlUGFja2VyLmludGVybmFsUGFjayhwYWNJbmZvKTtcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgYXN5bmMgaW50ZXJuYWxQYWNrKHBhY0luZm86IFBhY0luZm8pOiBQcm9taXNlPFBhY0luZm8+IHtcclxuICAgICAgICBsZXQgc3RvcmVkUGFjSW5mbzogSVN0b3JlUGFja0luZm8gfCBudWxsID0gbnVsbDtcclxuICAgICAgICBjb25zdCBzdG9yZWRQYWNJbmZvUGF0aCA9IFRleHR1cmVQYWNrZXIucXVlcnlQYWNTdG9yZWRQYXRoKHBhY0luZm8pO1xyXG4gICAgICAgIGlmIChUZXh0dXJlUGFja2VyLnVzZUNhY2hlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlcyA9IFRleHR1cmVQYWNrZXIuZ2V0UGFjUmVzRnJvbUNhY2hlKHBhY0luZm8sIHN0b3JlZFBhY0luZm9QYXRoKTtcclxuICAgICAgICAgICAgaWYgKHJlcy5yZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgIHBhY0luZm8ucmVzdWx0ID0gcmVzLnJlc3VsdDtcclxuICAgICAgICAgICAgICAgIHBhY0luZm8uZGlydHkgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBwYWNJbmZvO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHN0b3JlZFBhY0luZm8gPSByZXM7XHJcbiAgICAgICAgICAgIHBhY0luZm8uZGlydHkgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBkZXN0RGlyID0gdGhpcy5nZXRDYWNoZURpcldpdGhVdWlkKHBhY0luZm8udXVpZCwgcGFjSW5mby5wYWNrT3B0aW9ucy5tb2RlKTtcclxuICAgICAgICBlbXB0eURpclN5bmMoZGVzdERpcik7XHJcbiAgICAgICAgaWYgKHBhY0luZm8uc3ByaXRlRnJhbWVJbmZvcyAmJiBwYWNJbmZvLnNwcml0ZUZyYW1lSW5mb3MubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIC8vIFRPRE8g5byA5ZCv5a2Q6L+b56iL5omT5YyF5Zu+6ZuGXHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHBhY2tlcihwYWNJbmZvLnNwcml0ZUZyYW1lSW5mb3MsIHtcclxuICAgICAgICAgICAgICAgIC4uLnBhY0luZm8ucGFja09wdGlvbnMsXHJcbiAgICAgICAgICAgICAgICBkZXN0RGlyLFxyXG4gICAgICAgICAgICAgICAgbmFtZTogcGFjSW5mby5uYW1lLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcGFjSW5mby5yZXN1bHQgPSByZXN1bHQ7XHJcbiAgICAgICAgICAgIGlmIChUZXh0dXJlUGFja2VyLnVzZUNhY2hlKSB7XHJcbiAgICAgICAgICAgICAgICBzdG9yZWRQYWNJbmZvID0gc3RvcmVkUGFjSW5mbyB8fCBUZXh0dXJlUGFja2VyLmdlbk5ld1N0b3JlZEluZm8ocGFjSW5mbyk7XHJcbiAgICAgICAgICAgICAgICBzdG9yZWRQYWNJbmZvLnJlc3VsdCA9IHJlc3VsdDtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb3V0cHV0SlNPTlN5bmMoc3RvcmVkUGFjSW5mb1BhdGgsIHN0b3JlZFBhY0luZm8sIHsgc3BhY2VzOiAyIH0pO1xyXG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKCd3cml0ZSBwYWMgaW5mbyBjYWNoZSBmYWlsZWQnKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcGFjSW5mbztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBnZXRTdG9yZWRQYWNJbmZvKHBhY0luZm86IFBhY0luZm8sIHN0b3JlZFBhY0luZm9QYXRoPzogc3RyaW5nKTogeyBuZXdTdG9yZWRQYWNJbmZvOiBJU3RvcmVQYWNrSW5mbywgc3RvcmVkUGFjSW5mbzogSVN0b3JlUGFja0luZm8gfCBudWxsIH0ge1xyXG4gICAgICAgIHN0b3JlZFBhY0luZm9QYXRoID0gc3RvcmVkUGFjSW5mb1BhdGggfHwgVGV4dHVyZVBhY2tlci5xdWVyeVBhY1N0b3JlZFBhdGgocGFjSW5mbyk7XHJcbiAgICAgICAgY29uc3QgcmVzID0ge1xyXG4gICAgICAgICAgICBuZXdTdG9yZWRQYWNJbmZvOiBUZXh0dXJlUGFja2VyLmdlbk5ld1N0b3JlZEluZm8ocGFjSW5mbyksXHJcbiAgICAgICAgICAgIHN0b3JlZFBhY0luZm86IG51bGwsXHJcbiAgICAgICAgfTtcclxuICAgICAgICBpZiAoIWV4aXN0c1N5bmMoc3RvcmVkUGFjSW5mb1BhdGgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXM7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHJlcy5zdG9yZWRQYWNJbmZvID0gcmVhZEpTT05TeW5jKHN0b3JlZFBhY0luZm9QYXRoKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKGVycm9yKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiByZXM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZ2VuTmV3U3RvcmVkSW5mbyhwYWNJbmZvOiBQYWNJbmZvKTogSVN0b3JlUGFja0luZm8ge1xyXG4gICAgICAgIGNvbnN0IG5ld1N0b3JlZFBhY0luZm86IElTdG9yZVBhY2tJbmZvID0ge1xyXG4gICAgICAgICAgICBtZDU6ICcnLFxyXG4gICAgICAgICAgICB2ZXJzaW9uRGV2LFxyXG4gICAgICAgICAgICBzaGFycE1kNTogY2FsY01kNShKU09OLnN0cmluZ2lmeShyZXF1aXJlKCdzaGFycCcpLnZlcnNpb25zKSksXHJcbiAgICAgICAgfTtcclxuICAgICAgICAvLyDlr7nlm77niYfov5vooYzmjpLluo/vvIznoa7kv53mr4/mrKHph43mlrDorqHnrpcgbWQ1IOS4gOiHtFxyXG4gICAgICAgIHBhY0luZm8uc3RvcmVJbmZvLnNwcml0ZXMgPSBsb2Rhc2guc29ydEJ5KHBhY0luZm8uc3RvcmVJbmZvLnNwcml0ZXMsICd1dWlkJyk7XHJcbiAgICAgICAgLy8gVE9ETyDlrZfnrKbkuLLorqHnrpcgbWQ1IOWPr+iDveWvvOiHtOiuoeeul+e7k+aenOS4jeeos+WumlxyXG4gICAgICAgIG5ld1N0b3JlZFBhY0luZm8ubWQ1ID0gY2FsY01kNShKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICAgIHBhY2tTdG9yZUluZm86IHBhY0luZm8uc3RvcmVJbmZvLFxyXG4gICAgICAgICAgICB2ZXJzaW9uRGV2LFxyXG4gICAgICAgICAgICBzaGFycE1kNTogbmV3U3RvcmVkUGFjSW5mby5zaGFycE1kNSxcclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgcmV0dXJuIG5ld1N0b3JlZFBhY0luZm87XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZ2V0UGFjUmVzRnJvbUNhY2hlKHBhY0luZm86IFBhY0luZm8sIHN0b3JlZFBhY0luZm9QYXRoOiBzdHJpbmcpOiBJU3RvcmVQYWNrSW5mbyB7XHJcbiAgICAgICAgY29uc3QgeyBzdG9yZWRQYWNJbmZvLCBuZXdTdG9yZWRQYWNJbmZvIH0gPSBUZXh0dXJlUGFja2VyLmdldFN0b3JlZFBhY0luZm8ocGFjSW5mbywgc3RvcmVkUGFjSW5mb1BhdGgpO1xyXG4gICAgICAgIGxldCBkaXJ0eSA9ICghc3RvcmVkUGFjSW5mbyB8fCBuZXdTdG9yZWRQYWNJbmZvLm1kNSAhPT0gc3RvcmVkUGFjSW5mby5tZDUpO1xyXG4gICAgICAgIGlmIChkaXJ0eSkge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3U3RvcmVkUGFjSW5mbztcclxuICAgICAgICB9XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBhdGxhcyBvZiBzdG9yZWRQYWNJbmZvIS5yZXN1bHQhLmF0bGFzZXMpIHtcclxuICAgICAgICAgICAgICAgIC8vIOmcgOimgeajgOafpeaJgOaciee8k+WtmOeahOWbvumbhui1hOa6kOaYr+WQpuS+neaXp+ato+W4uOWtmOWcqFxyXG4gICAgICAgICAgICAgICAgaWYgKCFleGlzdHNTeW5jKGF0bGFzLmltYWdlUGF0aCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBkaXJ0eSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbmV3U3RvcmVkUGFjSW5mby5yZXN1bHQgPSBzdG9yZWRQYWNJbmZvIS5yZXN1bHQhO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihgR2V0IENhY2hlIGluZm8gb2YgcGFjIGZhaWxlZCB7YXNzZXQoJHtwYWNJbmZvLnV1aWR9KX1gKTtcclxuICAgICAgICAgICAgY29uc29sZS53YXJuKGVycm9yKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc29sZS5kZWJ1ZyhgR2V0IENhY2hlIGluZm8gb2YgcGFjIHN1Y2Nlc3Mge2Fzc2V0KCR7cGFjSW5mby51dWlkfSl9YCk7XHJcbiAgICAgICAgcmV0dXJuIG5ld1N0b3JlZFBhY0luZm87XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyBxdWVyeVBhY0NhY2hlKHBhY1V1aWQ6IHN0cmluZyk6IFByb21pc2U8UHJldmlld1BhY2tSZXN1bHQgfCBudWxsPiB7XHJcbiAgICAgICAgY29uc3QgcGFjSW5mbyA9IG5ldyBQYWNJbmZvKGJ1aWxkQXNzZXRMaWJyYXJ5LmdldEFzc2V0KHBhY1V1aWQpKTtcclxuICAgICAgICAvLyDlsIbkvJrlhrPlrprojrflj5bnmoTnvJPlrZjkvY3nva5cclxuICAgICAgICBwYWNJbmZvLnBhY2tPcHRpb25zLm1vZGUgPSAncHJldmlldyc7XHJcbiAgICAgICAgLy8g55Sx5LqO5q2k5o6l5Y+j6L+Y6KaB6I635Y+W5pyA5paw55qE5Zu+6ZuG5L+h5oGv5a+55q+U57yT5a2Y5piv5ZCm5aSx5pWI77yM5Zug6ICM5q2k5aSE6Jm95LiN6ZyA6KaB55Sf5oiQ6aKE6KeI5Zu+5L2G6ZyA6KaB5Yid5aeL5YyWXHJcbiAgICAgICAgYXdhaXQgcGFjSW5mby5pbml0U3ByaXRlRnJhbWVzV2l0aFJhbmdlKCk7XHJcbiAgICAgICAgY29uc3QgY2FjaGVJbmZvID0gVGV4dHVyZVBhY2tlci5nZXRTdG9yZWRQYWNJbmZvKHBhY0luZm8pO1xyXG4gICAgICAgIGlmICghY2FjaGVJbmZvIHx8ICFjYWNoZUluZm8uc3RvcmVkUGFjSW5mbyB8fCAhY2FjaGVJbmZvLnN0b3JlZFBhY0luZm8ucmVzdWx0IHx8IGNhY2hlSW5mby5zdG9yZWRQYWNJbmZvLm1kNSAhPT0gY2FjaGVJbmZvLm5ld1N0b3JlZFBhY0luZm8ubWQ1KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBwYWNSZXMgPSBjYWNoZUluZm8uc3RvcmVkUGFjSW5mby5yZXN1bHQ7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgdW5wYWNrZWRJbWFnZXM6IHBhY1Jlcy51bnBhY2tlZEltYWdlcyxcclxuICAgICAgICAgICAgZGlydHk6IGZhbHNlLFxyXG4gICAgICAgICAgICBhdGxhc0ltYWdlUGF0aHM6IGNhY2hlSW5mby5zdG9yZWRQYWNJbmZvLnJlc3VsdC5hdGxhc2VzLm1hcCgoaW5mbykgPT4gaW5mby5pbWFnZVBhdGgpLFxyXG4gICAgICAgICAgICBhdGxhc2VzOiBjYWNoZUluZm8uc3RvcmVkUGFjSW5mby5yZXN1bHQuYXRsYXNlcyxcclxuICAgICAgICAgICAgc3RvcmVJbmZvOiBwYWNJbmZvLnN0b3JlSW5mbyxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcGFja0F1dG9BdGxhcyhwYWNVdWlkOiBzdHJpbmcsIG9wdGlvbj86IFBhcnRpYWw8SVBhY2tPcHRpb25zPik6IFByb21pc2U8UHJldmlld1BhY2tSZXN1bHQgfCBudWxsPiB7XHJcbiAgICBpZiAoIW9wdGlvbikge1xyXG4gICAgICAgIG9wdGlvbiA9IHt9O1xyXG4gICAgfVxyXG4gICAgb3B0aW9uLm1vZGUgPSAncHJldmlldyc7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IHBhY0luZm8gPSBhd2FpdCBUZXh0dXJlUGFja2VyLnBhY2tTaW5nbGUoYnVpbGRBc3NldExpYnJhcnkuZ2V0QXNzZXQocGFjVXVpZCksIG9wdGlvbik7XHJcbiAgICAgICAgaWYgKCFwYWNJbmZvLnNwcml0ZUZyYW1lcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgY29uc29sZS53YXJuKGBObyBpbnZhbGlkIFNwcml0ZUZyYW1lIGZvdW5kIGluIGZvbGRlciBbe2xpbmsoJHtkaXJuYW1lKHBhY0luZm8ucGF0aCl9KX1dLiBQbGVhc2UgY2hlY2sgdGhlIEF1dG9BdGxhcyBbe2xpbmsoJHtwYWNJbmZvLnBhdGh9KX1dLmApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXBhY0luZm8ucmVzdWx0KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBhdGxhc0ltYWdlUGF0aHMgPSBwYWNJbmZvLnJlc3VsdC5hdGxhc2VzLm1hcCgoaW5mbykgPT4gaW5mby5pbWFnZVBhdGgpO1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGF0bGFzSW1hZ2VQYXRocyxcclxuICAgICAgICAgICAgdW5wYWNrZWRJbWFnZXM6IHBhY0luZm8ucmVzdWx0LnVucGFja2VkSW1hZ2VzLFxyXG4gICAgICAgICAgICBkaXJ0eTogcGFjSW5mby5kaXJ0eSxcclxuICAgICAgICAgICAgc3RvcmVJbmZvOiBwYWNJbmZvLnN0b3JlSW5mbyxcclxuICAgICAgICAgICAgYXRsYXNlczogcGFjSW5mby5yZXN1bHQuYXRsYXNlcyxcclxuICAgICAgICB9O1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbnVsbDtcclxufVxyXG5cclxuLyoqXHJcbiAqIOafpeivouafkOS4quWbvumbhueahOmihOiniOe8k+WtmFxyXG4gKiBAcGFyYW0gcGFjVXVpZCBcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBxdWVyeUF1dG9BdGxhc0ZpbGVDYWNoZShwYWNVdWlkOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBUZXh0dXJlUGFja2VyLnF1ZXJ5UGFjQ2FjaGUocGFjVXVpZCk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBxdWVyeVNwcml0ZVRvQXV0b0F0bGFzKHNwcml0ZVV1aWQ6IHN0cmluZyk6IFByb21pc2U8e1xyXG4gICAgdXJsOiBzdHJpbmc7XHJcbiAgICB1dWlkOiBzdHJpbmc7XHJcbn0gfCBudWxsPiB7XHJcbiAgICBjb25zdCBpbmZvID0gYnVpbGRBc3NldExpYnJhcnkuZ2V0QXNzZXQoc3ByaXRlVXVpZCk7XHJcbiAgICBpZiAoaW5mby51cmwuc3RhcnRzV2l0aCgnZGI6Ly9pbnRlcm5hbCcpKSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5om+5Yiw5bCP5Zu+5omA5ZyoIGRiIOaJgOacieeahOWbvumbhuS/oeaBr1xyXG4gICAgY29uc3QgYWxsUGFjcyA9IGJ1aWxkQXNzZXRMaWJyYXJ5LnF1ZXJ5QXNzZXRzQnlPcHRpb25zKHtcclxuICAgICAgICBwYXR0ZXJuOiBgZGI6Ly8ke2luZm8uX2Fzc2V0REIub3B0aW9ucy5uYW1lfS8qKi8qLnBhY2AsXHJcbiAgICB9KTtcclxuICAgIGlmICghYWxsUGFjcy5sZW5ndGgpIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBwYWNrZXIgPSBuZXcgVGV4dHVyZVBhY2tlcigpO1xyXG4gICAgYXdhaXQgcGFja2VyLmluaXQoYWxsUGFjcyk7XHJcbiAgICBjb25zdCB0YXJnZXRQYWNrSW5mbyA9IHBhY2tlci5wYWNJbmZvcy5maW5kKChwYWNJbmZvKSA9PiAhIXBhY0luZm8uc3ByaXRlRnJhbWVJbmZvcy5maW5kKChzcHJpdGVJbmZvKSA9PiBzcHJpdGVJbmZvLnV1aWQgPT09IHNwcml0ZVV1aWQpKTtcclxuICAgIGlmICghdGFyZ2V0UGFja0luZm8pIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHVybDogdGFyZ2V0UGFja0luZm8ucGF0aCxcclxuICAgICAgICB1dWlkOiB0YXJnZXRQYWNrSW5mby51dWlkLFxyXG4gICAgfTtcclxufSJdfQ==