"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class Pool {
    _fn;
    _idx;
    _frees;
    constructor(fn, size) {
        this._fn = fn;
        this._idx = size - 1;
        this._frees = new Array(size);
        for (let i = 0; i < size; ++i) {
            this._frees[i] = fn();
        }
    }
    alloc() {
        // create some more space (expand by 20%, minimum 1)
        if (this._idx < 0) {
            this._expand(Math.round(this._frees.length * 1.2) + 1);
        }
        const ret = this._frees[this._idx];
        this._frees.splice(this._idx);
        --this._idx;
        return ret;
    }
    free(obj) {
        ++this._idx;
        this._frees[this._idx] = obj;
    }
    clear(fn) {
        for (let i = 0; i <= this._idx; i++) {
            if (fn) {
                fn(this._frees[i]);
            }
        }
        this._frees.splice(0);
        this._idx = -1;
    }
    _expand(size) {
        const old = this._frees;
        this._frees = new Array(size);
        const len = size - old.length;
        for (let i = 0; i < len; ++i) {
            this._frees[i] = this._fn();
        }
        for (let i = len, j = 0; i < size; ++i, ++j) {
            this._frees[i] = old[j];
        }
        this._idx += len;
    }
}
exports.default = Pool;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9vbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL3NjZW5lL3NjZW5lLXByb2Nlc3Mvc2VydmljZS9hc3NldC9wb29sLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBcUIsSUFBSTtJQUNiLEdBQUcsQ0FBVTtJQUNiLElBQUksQ0FBUztJQUNiLE1BQU0sQ0FBTTtJQUVwQixZQUFZLEVBQVcsRUFBRSxJQUFZO1FBQ2pDLElBQUksQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ2QsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxLQUFLLENBQUksSUFBSSxDQUFDLENBQUM7UUFFakMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDO1lBQzVCLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUM7UUFDMUIsQ0FBQztJQUNMLENBQUM7SUFFTSxLQUFLO1FBQ1Isb0RBQW9EO1FBQ3BELElBQUksSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUNoQixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDM0QsQ0FBQztRQUVELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ25DLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM5QixFQUFFLElBQUksQ0FBQyxJQUFJLENBQUM7UUFFWixPQUFPLEdBQUcsQ0FBQztJQUNmLENBQUM7SUFFTSxJQUFJLENBQUMsR0FBTTtRQUNkLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQztRQUNaLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQztJQUNqQyxDQUFDO0lBRU0sS0FBSyxDQUFDLEVBQW9CO1FBQzdCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDbEMsSUFBSSxFQUFFLEVBQUUsQ0FBQztnQkFDTCxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZCLENBQUM7UUFDTCxDQUFDO1FBQ0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEIsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNuQixDQUFDO0lBRU8sT0FBTyxDQUFDLElBQVk7UUFDeEIsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUN4QixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRTlCLE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDO1FBQzlCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztZQUMzQixJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUNoQyxDQUFDO1FBRUQsS0FBSyxJQUFJLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUM7WUFDMUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUIsQ0FBQztRQUVELElBQUksQ0FBQyxJQUFJLElBQUksR0FBRyxDQUFDO0lBQ3JCLENBQUM7Q0FDSjtBQTFERCx1QkEwREMiLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgZGVmYXVsdCBjbGFzcyBQb29sPFQ+IHtcclxuICAgIHByaXZhdGUgX2ZuOiAoKSA9PiBUO1xyXG4gICAgcHJpdmF0ZSBfaWR4OiBudW1iZXI7XHJcbiAgICBwcml2YXRlIF9mcmVlczogVFtdO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGZuOiAoKSA9PiBULCBzaXplOiBudW1iZXIpIHtcclxuICAgICAgICB0aGlzLl9mbiA9IGZuO1xyXG4gICAgICAgIHRoaXMuX2lkeCA9IHNpemUgLSAxO1xyXG4gICAgICAgIHRoaXMuX2ZyZWVzID0gbmV3IEFycmF5PFQ+KHNpemUpO1xyXG5cclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNpemU7ICsraSkge1xyXG4gICAgICAgICAgICB0aGlzLl9mcmVlc1tpXSA9IGZuKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhbGxvYygpOiBUIHtcclxuICAgICAgICAvLyBjcmVhdGUgc29tZSBtb3JlIHNwYWNlIChleHBhbmQgYnkgMjAlLCBtaW5pbXVtIDEpXHJcbiAgICAgICAgaWYgKHRoaXMuX2lkeCA8IDApIHtcclxuICAgICAgICAgICAgdGhpcy5fZXhwYW5kKE1hdGgucm91bmQodGhpcy5fZnJlZXMubGVuZ3RoICogMS4yKSArIDEpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgcmV0ID0gdGhpcy5fZnJlZXNbdGhpcy5faWR4XTtcclxuICAgICAgICB0aGlzLl9mcmVlcy5zcGxpY2UodGhpcy5faWR4KTtcclxuICAgICAgICAtLXRoaXMuX2lkeDtcclxuXHJcbiAgICAgICAgcmV0dXJuIHJldDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZnJlZShvYmo6IFQpIHtcclxuICAgICAgICArK3RoaXMuX2lkeDtcclxuICAgICAgICB0aGlzLl9mcmVlc1t0aGlzLl9pZHhdID0gb2JqO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjbGVhcihmbjogKG9iajogVCkgPT4gdm9pZCkge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IHRoaXMuX2lkeDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmIChmbikge1xyXG4gICAgICAgICAgICAgICAgZm4odGhpcy5fZnJlZXNbaV0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX2ZyZWVzLnNwbGljZSgwKTtcclxuICAgICAgICB0aGlzLl9pZHggPSAtMTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9leHBhbmQoc2l6ZTogbnVtYmVyKSB7XHJcbiAgICAgICAgY29uc3Qgb2xkID0gdGhpcy5fZnJlZXM7XHJcbiAgICAgICAgdGhpcy5fZnJlZXMgPSBuZXcgQXJyYXkoc2l6ZSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGxlbiA9IHNpemUgLSBvbGQubGVuZ3RoO1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyArK2kpIHtcclxuICAgICAgICAgICAgdGhpcy5fZnJlZXNbaV0gPSB0aGlzLl9mbigpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IGxlbiwgaiA9IDA7IGkgPCBzaXplOyArK2ksICsraikge1xyXG4gICAgICAgICAgICB0aGlzLl9mcmVlc1tpXSA9IG9sZFtqXTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX2lkeCArPSBsZW47XHJcbiAgICB9XHJcbn1cclxuIl19