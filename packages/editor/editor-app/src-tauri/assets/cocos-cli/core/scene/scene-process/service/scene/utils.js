"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.sceneUtils = void 0;
exports.withTimeout = withTimeout;
const cc_1 = __importDefault(require("cc"));
const index_1 = __importDefault(require("../component/index"));
const utils_1 = require("../prefab/utils");
class SceneUtil {
    /** 默认超时：1分钟 */
    static Timeout = 60 * 1000;
    /**
     * 立即运行场景，清除节点与组件缓存
     * @param sceneAsset
     */
    runScene(sceneAsset) {
        // 重要：清空节点与组件的 path 缓存，否则会出现数据重复的问题
        EditorExtends.Node.clear();
        EditorExtends.Component.clear();
        return new Promise((resolve, reject) => {
            cc_1.default.director.runSceneImmediate(sceneAsset, () => { }, (err, instance) => {
                if (err || !instance) {
                    console.error('运行场景失败:', err);
                    reject(err ?? new Error('Unknown scene run error'));
                    return;
                }
                resolve(instance);
            });
        });
    }
    /**
     * 从一个序列化后的 JSON 内加载并运行场景
     * @param serializeJSON
     */
    async runSceneImmediateByJson(serializeJSON) {
        return withTimeout(new Promise((resolve, reject) => {
            cc_1.default.assetManager.loadWithJson(serializeJSON, null, (error, scene) => {
                if (error)
                    return reject(error);
                this.runScene(scene).then(resolve).catch(reject);
            });
        }), SceneUtil.Timeout, '加载场景超时');
    }
    /**
     * 生成组件信息
     */
    generateComponentInfo(component) {
        return index_1.default.getComponentIdentifier(component);
    }
    generatePrefabInfo(prefab) {
        if (!prefab) {
            return null;
        }
        const generateTargetInfo = (info) => {
            if (!info) {
                return null;
            }
            return {
                localID: info.localID,
            };
        };
        const generatePropertyOverrideInfo = (info) => {
            return {
                targetInfo: generateTargetInfo(info.targetInfo),
                propertyPath: info.propertyPath,
                value: info.value,
            };
        };
        const generateMountedChildrenInfo = (info) => {
            return {
                targetInfo: generateTargetInfo(info.targetInfo),
                nodes: info.nodes.map((node) => this.generateNodeIdentifier(node))
            };
        };
        const generateMountedComponentsInfo = (info) => {
            return {
                targetInfo: generateTargetInfo(info.targetInfo),
                components: info.components.map((comp) => this.generateComponentIdentifier(comp)),
            };
        };
        const generatePrefabInstance = (instance) => {
            if (!instance) {
                return undefined;
            }
            const result = {
                fileId: instance.fileId,
                prefabRootNode: instance.prefabRootNode ? this.generateNodeIdentifier(instance.prefabRootNode) : undefined,
                mountedChildren: instance.mountedChildren.map(generateMountedChildrenInfo),
                mountedComponents: instance.mountedComponents.map(generateMountedComponentsInfo),
                propertyOverrides: instance.propertyOverrides.map(generatePropertyOverrideInfo),
                removedComponents: instance.removedComponents.map(generateTargetInfo),
            };
            //prefabRootNode is optional field.
            if (!result.prefabRootNode) {
                delete result.prefabRootNode;
            }
            return result;
        };
        const generatePrefabAsset = (asset) => {
            if (!asset) {
                return undefined;
            }
            return {
                name: asset.name,
                uuid: asset._uuid,
                data: this.generateNodeIdentifier(asset.data),
                optimizationPolicy: asset.optimizationPolicy,
                persistent: asset.persistent,
            };
        };
        const generateTargetOverrideInfo = (info) => {
            return {
                source: info.source ? (info.source.node ? this.generateNodeIdentifier(info.source.node) : this.generateComponentIdentifier(info.source)) : null,
                sourceInfo: generateTargetInfo(info.sourceInfo),
                propertyPath: info.propertyPath,
                target: info.target ? this.generateNodeIdentifier(info.target) : null,
                targetInfo: generateTargetInfo(info.targetInfo),
            };
        };
        const root = prefab.root && this.generateNodeIdentifier(prefab.root);
        const result = {
            asset: generatePrefabAsset(prefab.asset) ?? undefined,
            root: root ?? undefined,
            instance: generatePrefabInstance(prefab.instance) ?? undefined,
            fileId: prefab.fileId,
            targetOverrides: prefab.targetOverrides ? prefab.targetOverrides.map(generateTargetOverrideInfo) : [],
            nestedPrefabInstanceRoots: prefab.nestedPrefabInstanceRoots ? prefab.nestedPrefabInstanceRoots.map((node) => this.generateNodeIdentifier(node)) : [],
        };
        // asset, root, instance is a optional field in SchemaPrefabInfo.
        if (!result.asset) {
            delete result.asset;
        }
        if (!result.root) {
            delete result.root;
        }
        if (!result.instance) {
            delete result.instance;
        }
        return result;
    }
    generateNodeIdentifier(node) {
        return {
            nodeId: node.uuid,
            path: EditorExtends.Node.getNodePath(node),
            name: node.name,
        };
    }
    generateComponentIdentifier(component) {
        return index_1.default.getComponentIdentifier(component);
    }
    /**
     * 节点 dump 数据
     * @param node
     * @param generateChildren
     */
    generateNodeInfo(node, generateChildren) {
        const identifier = this.generateNodeIdentifier(node);
        const nodeInfo = {
            ...identifier,
            prefab: this.generatePrefabInfo(node['_prefab']),
            properties: {
                active: node.active,
                position: node.position,
                rotation: node.rotation,
                scale: node.scale,
                layer: node.layer,
                eulerAngles: node.eulerAngles,
                mobility: node.mobility,
            },
            components: [],
        };
        if (node.components) {
            nodeInfo.components = node.components
                .map((component) => {
                return this.generateComponentInfo(component);
            });
        }
        if (generateChildren) {
            node.children.forEach((child) => {
                if (!nodeInfo.children) {
                    nodeInfo.children = [];
                }
                nodeInfo.children.push(this.generateNodeInfo(child, true));
            });
        }
        return nodeInfo;
    }
    /**
     * 序列化场景
     * @private
     */
    serialize(scene) {
        const asset = new cc_1.default.SceneAsset();
        utils_1.prefabUtils.gatherPrefabInstanceRoots(scene);
        utils_1.prefabUtils.removeInvalidPrefabData(scene);
        asset.scene = scene;
        return EditorExtends.serialize(asset);
    }
    /**
     * 根据资源 uuid 加载资源
     * @param uuid
     */
    async loadAny(uuid) {
        return new Promise((resolve, reject) => {
            cc_1.default.assetManager.assets.remove(uuid);
            cc_1.default.assetManager.loadAny(uuid, (error, asset) => {
                if (error) {
                    reject(error);
                }
                else {
                    resolve(asset);
                }
            });
        });
    }
}
/**
 * 通用超时包装函数
 * @param promise 要执行的 Promise
 * @param timeoutMs 超时时间（毫秒）
 * @param message 超时错误信息
 */
async function withTimeout(promise, timeoutMs, message = 'Operation timed out') {
    let timer;
    return Promise.race([
        promise,
        new Promise((_, reject) => {
            timer = setTimeout(() => reject(new Error(message)), timeoutMs);
        }),
    ]).finally(() => clearTimeout(timer));
}
exports.sceneUtils = new SceneUtil();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9zY2VuZS9zY2VuZS1wcm9jZXNzL3NlcnZpY2Uvc2NlbmUvdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBZ1FBLGtDQVlDO0FBNVFELDRDQUFvQjtBQWNwQiwrREFBeUM7QUFDekMsMkNBQThDO0FBRTlDLE1BQU0sU0FBUztJQUNYLGVBQWU7SUFDZixNQUFNLENBQVUsT0FBTyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7SUFFcEM7OztPQUdHO0lBQ0gsUUFBUSxDQUFDLFVBQW9DO1FBQ3pDLG1DQUFtQztRQUNuQyxhQUFhLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzNCLGFBQWEsQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFaEMsT0FBTyxJQUFJLE9BQU8sQ0FBVyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUM3QyxZQUFFLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUN6QixVQUFVLEVBQ1YsR0FBRyxFQUFFLEdBQTJCLENBQUMsRUFDakMsQ0FBQyxHQUFpQixFQUFFLFFBQW1CLEVBQUUsRUFBRTtnQkFDdkMsSUFBSSxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztvQkFDbkIsT0FBTyxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsR0FBRyxDQUFDLENBQUM7b0JBQzlCLE1BQU0sQ0FBQyxHQUFHLElBQUksSUFBSSxLQUFLLENBQUMseUJBQXlCLENBQUMsQ0FBQyxDQUFDO29CQUNwRCxPQUFPO2dCQUNYLENBQUM7Z0JBQ0QsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3RCLENBQUMsQ0FDSixDQUFDO1FBQ04sQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBQ0Q7OztPQUdHO0lBQ0gsS0FBSyxDQUFDLHVCQUF1QixDQUFDLGFBQWtDO1FBQzVELE9BQU8sV0FBVyxD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RSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3BDLFlBQUUsQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFTLElBQUksRUFBRSxDQUFDLEtBQW1CLEVBQUUsS0FBYSxFQUFFLEVBQUU7Z0JBQ3pFLElBQUksS0FBSyxFQUFFLENBQUM7b0JBQ1IsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNsQixDQUFDO3FCQUFNLENBQUM7b0JBQ0osT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNuQixDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7O0FBR0w7Ozs7O0dBS0c7QUFDSSxLQUFLLFVBQVUsV0FBVyxDQUM3QixPQUFtQixFQUNuQixTQUFpQixFQUNqQixPQUFPLEdBQUcscUJBQXFCO0lBRS9CLElBQUksS0FBcUIsQ0FBQztJQUMxQixPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQUM7UUFDaEIsT0FBTztRQUNQLElBQUksT0FBTyxDQUFRLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQzdCLEtBQUssR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDcEUsQ0FBQyxDQUFDO0tBQ0wsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztBQUMxQyxDQUFDO0FBRVksUUFBQSxVQUFVLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjYyBmcm9tICdjYyc7XHJcbmltcG9ydCB7XHJcbiAgICBJQ29tcG9uZW50SWRlbnRpZmllcixcclxuICAgIElNb3VudGVkQ2hpbGRyZW5JbmZvLFxyXG4gICAgSU1vdW50ZWRDb21wb25lbnRzSW5mbyxcclxuICAgIElOb2RlLFxyXG4gICAgSVByZWZhYixcclxuICAgIElQcmVmYWJJbmZvLFxyXG4gICAgSVByZWZhYkluc3RhbmNlLFxyXG4gICAgSVByb3BlcnR5T3ZlcnJpZGVJbmZvLFxyXG4gICAgSVRhcmdldEluZm8sXHJcbiAgICBJVGFyZ2V0T3ZlcnJpZGVJbmZvLFxyXG4gICAgT3B0aW1pemF0aW9uUG9saWN5LFxyXG59IGZyb20gJy4uLy4uLy4uL2NvbW1vbic7XHJcbmltcG9ydCBjb21wTWdyIGZyb20gJy4uL2NvbXBvbmVudC9pbmRleCc7XHJcbmltcG9ydCB7IHByZWZhYlV0aWxzIH0gZnJvbSAnLi4vcHJlZmFiL3V0aWxzJztcclxuXHJcbmNsYXNzIFNjZW5lVXRpbCB7XHJcbiAgICAvKiog6buY6K6k6LaF5pe277yaMeWIhumSnyAqL1xyXG4gICAgc3RhdGljIHJlYWRvbmx5IFRpbWVvdXQgPSA2MCAqIDEwMDA7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnq4vljbPov5DooYzlnLrmma/vvIzmuIXpmaToioLngrnkuI7nu4Tku7bnvJPlrZhcclxuICAgICAqIEBwYXJhbSBzY2VuZUFzc2V0XHJcbiAgICAgKi9cclxuICAgIHJ1blNjZW5lKHNjZW5lQXNzZXQ6IGNjLlNjZW5lQXNzZXQgfCBjYy5TY2VuZSk6IFByb21pc2U8Y2MuU2NlbmU+IHtcclxuICAgICAgICAvLyDph43opoHvvJrmuIXnqbroioLngrnkuI7nu4Tku7bnmoQgcGF0aCDnvJPlrZjvvIzlkKbliJnkvJrlh7rnjrDmlbDmja7ph43lpI3nmoTpl67pophcclxuICAgICAgICBFZGl0b3JFeHRlbmRzLk5vZGUuY2xlYXIoKTtcclxuICAgICAgICBFZGl0b3JFeHRlbmRzLkNvbXBvbmVudC5jbGVhcigpO1xyXG5cclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8Y2MuU2NlbmU+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgY2MuZGlyZWN0b3IucnVuU2NlbmVJbW1lZGlhdGUoXHJcbiAgICAgICAgICAgICAgICBzY2VuZUFzc2V0LFxyXG4gICAgICAgICAgICAgICAgKCkgPT4geyAvKiBvbkxhdW5jaGVkIOWbnuiwg++8iOWPr+mAie+8iSAqLyB9LFxyXG4gICAgICAgICAgICAgICAgKGVycjogRXJyb3IgfCBudWxsLCBpbnN0YW5jZT86IGNjLlNjZW5lKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVyciB8fCAhaW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcign6L+Q6KGM5Zy65pmv5aSx6LSlOicsIGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIgPz8gbmV3IEVycm9yKCdVbmtub3duIHNjZW5lIHJ1biBlcnJvcicpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGluc3RhbmNlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog5LuO5LiA5Liq5bqP5YiX5YyW5ZCO55qEIEpTT04g5YaF5Yqg6L295bm26L+Q6KGM5Zy65pmvXHJcbiAgICAgKiBAcGFyYW0gc2VyaWFsaXplSlNPTlxyXG4gICAgICovXHJcbiAgICBhc3luYyBydW5TY2VuZUltbWVkaWF0ZUJ5SnNvbihzZXJpYWxpemVKU09OOiBSZWNvcmQ8c3RyaW5nLCBhbnk+KTogUHJvbWlzZTxjYy5TY2VuZT4ge1xyXG4gICAgICAgIHJldHVybiB3aXRoVGltZW91dChcclxuICAgICAgICAgICAgbmV3IFByb21pc2U8Y2MuU2NlbmU+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgICAgIGNjLmFzc2V0TWFuYWdlci5sb2FkV2l0aEpzb24oc2VyaWFsaXplSlNPTiwgbnVsbCwgKGVycm9yOiBFcnJvciB8IG51bGwsIHNjZW5lOiBjYy5TY2VuZUFzc2V0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSByZXR1cm4gcmVqZWN0KGVycm9yKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJ1blNjZW5lKHNjZW5lKS50aGVuKHJlc29sdmUpLmNhdGNoKHJlamVjdCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIFNjZW5lVXRpbC5UaW1lb3V0LFxyXG4gICAgICAgICAgICAn5Yqg6L295Zy65pmv6LaF5pe2J1xyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnlJ/miJDnu4Tku7bkv6Hmga9cclxuICAgICAqL1xyXG4gICAgZ2VuZXJhdGVDb21wb25lbnRJbmZvKGNvbXBvbmVudDogY2MuQ29tcG9uZW50KTogSUNvbXBvbmVudElkZW50aWZpZXIge1xyXG4gICAgICAgIHJldHVybiBjb21wTWdyLmdldENvbXBvbmVudElkZW50aWZpZXIoY29tcG9uZW50KTtcclxuICAgIH1cclxuXHJcbiAgICBnZW5lcmF0ZVByZWZhYkluZm8ocHJlZmFiOiBjYy5QcmVmYWIuX3V0aWxzLlByZWZhYkluZm8gfCBudWxsKTogSVByZWZhYkluZm8gfCBudWxsIHtcclxuICAgICAgICBpZiAoIXByZWZhYikge1xyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGdlbmVyYXRlVGFyZ2V0SW5mbyA9IChpbmZvOiBhbnkpOiBJVGFyZ2V0SW5mbyB8IG51bGwgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIWluZm8pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBsb2NhbElEOiBpbmZvLmxvY2FsSUQsXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgY29uc3QgZ2VuZXJhdGVQcm9wZXJ0eU92ZXJyaWRlSW5mbyA9IChpbmZvOiBhbnkpOiBJUHJvcGVydHlPdmVycmlkZUluZm8gPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgdGFyZ2V0SW5mbzogZ2VuZXJhdGVUYXJnZXRJbmZvKGluZm8udGFyZ2V0SW5mbyksXHJcbiAgICAgICAgICAgICAgICBwcm9wZXJ0eVBhdGg6IGluZm8ucHJvcGVydHlQYXRoLFxyXG4gICAgICAgICAgICAgICAgdmFsdWU6IGluZm8udmFsdWUsXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgY29uc3QgZ2VuZXJhdGVNb3VudGVkQ2hpbGRyZW5JbmZvID0gKGluZm86IGFueSk6IElNb3VudGVkQ2hpbGRyZW5JbmZvID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIHRhcmdldEluZm86IGdlbmVyYXRlVGFyZ2V0SW5mbyhpbmZvLnRhcmdldEluZm8pLFxyXG4gICAgICAgICAgICAgICAgbm9kZXM6IGluZm8ubm9kZXMubWFwKChub2RlOiBjYy5Ob2RlKSA9PiB0aGlzLmdlbmVyYXRlTm9kZUlkZW50aWZpZXIobm9kZSkpXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgY29uc3QgZ2VuZXJhdGVNb3VudGVkQ29tcG9uZW50c0luZm8gPSAoaW5mbzogYW55KTogSU1vdW50ZWRDb21wb25lbnRzSW5mbyA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICB0YXJnZXRJbmZvOiBnZW5lcmF0ZVRhcmdldEluZm8oaW5mby50YXJnZXRJbmZvKSxcclxuICAgICAgICAgICAgICAgIGNvbXBvbmVudHM6IGluZm8uY29tcG9uZW50cy5tYXAoKGNvbXA6IGNjLkNvbXBvbmVudCkgPT4gdGhpcy5nZW5lcmF0ZUNvbXBvbmVudElkZW50aWZpZXIoY29tcCkpLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGNvbnN0IGdlbmVyYXRlUHJlZmFiSW5zdGFuY2UgPSAoaW5zdGFuY2U6IGFueSk6IElQcmVmYWJJbnN0YW5jZSB8IHVuZGVmaW5lZCA9PiB7XHJcbiAgICAgICAgICAgIGlmICghaW5zdGFuY2UpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0ge1xyXG4gICAgICAgICAgICAgICAgZmlsZUlkOiBpbnN0YW5jZS5maWxlSWQsXHJcbiAgICAgICAgICAgICAgICBwcmVmYWJSb290Tm9kZTogaW5zdGFuY2UucHJlZmFiUm9vdE5vZGUgPyB0aGlzLmdlbmVyYXRlTm9kZUlkZW50aWZpZXIoaW5zdGFuY2UucHJlZmFiUm9vdE5vZGUpIDogdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICAgICAgbW91bnRlZENoaWxkcmVuOiBpbnN0YW5jZS5tb3VudGVkQ2hpbGRyZW4ubWFwKGdlbmVyYXRlTW91bnRlZENoaWxkcmVuSW5mbyksXHJcbiAgICAgICAgICAgICAgICBtb3VudGVkQ29tcG9uZW50czogaW5zdGFuY2UubW91bnRlZENvbXBvbmVudHMubWFwKGdlbmVyYXRlTW91bnRlZENvbXBvbmVudHNJbmZvKSxcclxuICAgICAgICAgICAgICAgIHByb3BlcnR5T3ZlcnJpZGVzOiBpbnN0YW5jZS5wcm9wZXJ0eU92ZXJyaWRlcy5tYXAoZ2VuZXJhdGVQcm9wZXJ0eU92ZXJyaWRlSW5mbyksXHJcbiAgICAgICAgICAgICAgICByZW1vdmVkQ29tcG9uZW50czogaW5zdGFuY2UucmVtb3ZlZENvbXBvbmVudHMubWFwKGdlbmVyYXRlVGFyZ2V0SW5mbyksXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIC8vcHJlZmFiUm9vdE5vZGUgaXMgb3B0aW9uYWwgZmllbGQuXHJcbiAgICAgICAgICAgIGlmICghcmVzdWx0LnByZWZhYlJvb3ROb2RlKSB7XHJcbiAgICAgICAgICAgICAgICBkZWxldGUgcmVzdWx0LnByZWZhYlJvb3ROb2RlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgY29uc3QgZ2VuZXJhdGVQcmVmYWJBc3NldCA9IChhc3NldDogYW55KTogSVByZWZhYiB8IHVuZGVmaW5lZCA9PiB7XHJcbiAgICAgICAgICAgIGlmICghYXNzZXQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIG5hbWU6IGFzc2V0Lm5hbWUsXHJcbiAgICAgICAgICAgICAgICB1dWlkOiBhc3NldC5fdXVpZCxcclxuICAgICAgICAgICAgICAgIGRhdGE6IHRoaXMuZ2VuZXJhdGVOb2RlSWRlbnRpZmllcihhc3NldC5kYXRhKSxcclxuICAgICAgICAgICAgICAgIG9wdGltaXphdGlvblBvbGljeTogYXNzZXQub3B0aW1pemF0aW9uUG9saWN5IGFzIE9wdGltaXphdGlvblBvbGljeSxcclxuICAgICAgICAgICAgICAgIHBlcnNpc3RlbnQ6IGFzc2V0LnBlcnNpc3RlbnQsXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgY29uc3QgZ2VuZXJhdGVUYXJnZXRPdmVycmlkZUluZm8gPSAoaW5mbzogYW55KTogSVRhcmdldE92ZXJyaWRlSW5mbyA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBzb3VyY2U6IGluZm8uc291cmNlID8gKGluZm8uc291cmNlLm5vZGUgPyB0aGlzLmdlbmVyYXRlTm9kZUlkZW50aWZpZXIoaW5mby5zb3VyY2Uubm9kZSkgOiB0aGlzLmdlbmVyYXRlQ29tcG9uZW50SWRlbnRpZmllcihpbmZvLnNvdXJjZSkpIDogbnVsbCxcclxuICAgICAgICAgICAgICAgIHNvdXJjZUluZm86IGdlbmVyYXRlVGFyZ2V0SW5mbyhpbmZvLnNvdXJjZUluZm8pLFxyXG4gICAgICAgICAgICAgICAgcHJvcGVydHlQYXRoOiBpbmZvLnByb3BlcnR5UGF0aCxcclxuICAgICAgICAgICAgICAgIHRhcmdldDogaW5mby50YXJnZXQgPyB0aGlzLmdlbmVyYXRlTm9kZUlkZW50aWZpZXIoaW5mby50YXJnZXQpIDogbnVsbCxcclxuICAgICAgICAgICAgICAgIHRhcmdldEluZm86IGdlbmVyYXRlVGFyZ2V0SW5mbyhpbmZvLnRhcmdldEluZm8pLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGNvbnN0IHJvb3QgPSBwcmVmYWIucm9vdCAmJiB0aGlzLmdlbmVyYXRlTm9kZUlkZW50aWZpZXIocHJlZmFiLnJvb3QpO1xyXG5cclxuICAgICAgICBjb25zdCByZXN1bHQgPSB7XHJcbiAgICAgICAgICAgIGFzc2V0OiBnZW5lcmF0ZVByZWZhYkFzc2V0KHByZWZhYi5hc3NldCkgPz8gdW5kZWZpbmVkLFxyXG4gICAgICAgICAgICByb290OiByb290ID8/IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgaW5zdGFuY2U6IGdlbmVyYXRlUHJlZmFiSW5zdGFuY2UocHJlZmFiLmluc3RhbmNlKSA/PyB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgIGZpbGVJZDogcHJlZmFiLmZpbGVJZCxcclxuICAgICAgICAgICAgdGFyZ2V0T3ZlcnJpZGVzOiBwcmVmYWIudGFyZ2V0T3ZlcnJpZGVzID8gcHJlZmFiLnRhcmdldE92ZXJyaWRlcy5tYXAoZ2VuZXJhdGVUYXJnZXRPdmVycmlkZUluZm8pIDogW10sXHJcbiAgICAgICAgICAgIG5lc3RlZFByZWZhYkluc3RhbmNlUm9vdHM6IHByZWZhYi5uZXN0ZWRQcmVmYWJJbnN0YW5jZVJvb3RzID8gcHJlZmFiLm5lc3RlZFByZWZhYkluc3RhbmNlUm9vdHMubWFwKChub2RlOiBjYy5Ob2RlKSA9PiB0aGlzLmdlbmVyYXRlTm9kZUlkZW50aWZpZXIobm9kZSkpIDogW10sXHJcbiAgICAgICAgfTtcclxuICAgICAgICAvLyBhc3NldCwgcm9vdCwgaW5zdGFuY2UgaXMgYSBvcHRpb25hbCBmaWVsZCBpbiBTY2hlbWFQcmVmYWJJbmZvLlxyXG4gICAgICAgIGlmICghcmVzdWx0LmFzc2V0KSB7XHJcbiAgICAgICAgICAgIGRlbGV0ZSByZXN1bHQuYXNzZXQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghcmVzdWx0LnJvb3QpIHtcclxuICAgICAgICAgICAgZGVsZXRlIHJlc3VsdC5yb290O1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXJlc3VsdC5pbnN0YW5jZSkge1xyXG4gICAgICAgICAgICBkZWxldGUgcmVzdWx0Lmluc3RhbmNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIGdlbmVyYXRlTm9kZUlkZW50aWZpZXIobm9kZTogY2MuTm9kZSkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIG5vZGVJZDogbm9kZS51dWlkLFxyXG4gICAgICAgICAgICBwYXRoOiBFZGl0b3JFeHRlbmRzLk5vZGUuZ2V0Tm9kZVBhdGgobm9kZSksXHJcbiAgICAgICAgICAgIG5hbWU6IG5vZGUubmFtZSxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGdlbmVyYXRlQ29tcG9uZW50SWRlbnRpZmllcihjb21wb25lbnQ6IGNjLkNvbXBvbmVudCkge1xyXG4gICAgICAgIHJldHVybiBjb21wTWdyLmdldENvbXBvbmVudElkZW50aWZpZXIoY29tcG9uZW50KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiKgueCuSBkdW1wIOaVsOaNrlxyXG4gICAgICogQHBhcmFtIG5vZGVcclxuICAgICAqIEBwYXJhbSBnZW5lcmF0ZUNoaWxkcmVuXHJcbiAgICAgKi9cclxuICAgIGdlbmVyYXRlTm9kZUluZm8obm9kZTogY2MuTm9kZSwgZ2VuZXJhdGVDaGlsZHJlbjogYm9vbGVhbik6IElOb2RlIHtcclxuICAgICAgICBjb25zdCBpZGVudGlmaWVyID0gdGhpcy5nZW5lcmF0ZU5vZGVJZGVudGlmaWVyKG5vZGUpO1xyXG4gICAgICAgIGNvbnN0IG5vZGVJbmZvOiBJTm9kZSA9IHtcclxuICAgICAgICAgICAgLi4uaWRlbnRpZmllcixcclxuICAgICAgICAgICAgcHJlZmFiOiB0aGlzLmdlbmVyYXRlUHJlZmFiSW5mbyhub2RlWydfcHJlZmFiJ10pLFxyXG4gICAgICAgICAgICBwcm9wZXJ0aWVzOiB7XHJcbiAgICAgICAgICAgICAgICBhY3RpdmU6IG5vZGUuYWN0aXZlLFxyXG4gICAgICAgICAgICAgICAgcG9zaXRpb246IG5vZGUucG9zaXRpb24sXHJcbiAgICAgICAgICAgICAgICByb3RhdGlvbjogbm9kZS5yb3RhdGlvbixcclxuICAgICAgICAgICAgICAgIHNjYWxlOiBub2RlLnNjYWxlLFxyXG4gICAgICAgICAgICAgICAgbGF5ZXI6IG5vZGUubGF5ZXIsXHJcbiAgICAgICAgICAgICAgICBldWxlckFuZ2xlczogbm9kZS5ldWxlckFuZ2xlcyxcclxuICAgICAgICAgICAgICAgIG1vYmlsaXR5OiBub2RlLm1vYmlsaXR5LFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBjb21wb25lbnRzOiBbXSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIGlmIChub2RlLmNvbXBvbmVudHMpIHtcclxuICAgICAgICAgICAgbm9kZUluZm8uY29tcG9uZW50cyA9IG5vZGUuY29tcG9uZW50c1xyXG4gICAgICAgICAgICAgICAgLm1hcCgoY29tcG9uZW50OiBjYy5Db21wb25lbnQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZW5lcmF0ZUNvbXBvbmVudEluZm8oY29tcG9uZW50KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZ2VuZXJhdGVDaGlsZHJlbikge1xyXG4gICAgICAgICAgICBub2RlLmNoaWxkcmVuLmZvckVhY2goKGNoaWxkKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIW5vZGVJbmZvLmNoaWxkcmVuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZUluZm8uY2hpbGRyZW4gPSBbXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIG5vZGVJbmZvLmNoaWxkcmVuLnB1c2godGhpcy5nZW5lcmF0ZU5vZGVJbmZvKGNoaWxkLCB0cnVlKSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbm9kZUluZm87XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDluo/liJfljJblnLrmma9cclxuICAgICAqIEBwcml2YXRlXHJcbiAgICAgKi9cclxuICAgIHNlcmlhbGl6ZShzY2VuZTogY2MuU2NlbmUpIHtcclxuICAgICAgICBjb25zdCBhc3NldCA9IG5ldyBjYy5TY2VuZUFzc2V0KCk7XHJcbiAgICAgICAgcHJlZmFiVXRpbHMuZ2F0aGVyUHJlZmFiSW5zdGFuY2VSb290cyhzY2VuZSk7XHJcbiAgICAgICAgcHJlZmFiVXRpbHMucmVtb3ZlSW52YWxpZFByZWZhYkRhdGEoc2NlbmUpO1xyXG4gICAgICAgIGFzc2V0LnNjZW5lID0gc2NlbmU7XHJcbiAgICAgICAgcmV0dXJuIEVkaXRvckV4dGVuZHMuc2VyaWFsaXplKGFzc2V0KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOagueaNrui1hOa6kCB1dWlkIOWKoOi9vei1hOa6kFxyXG4gICAgICogQHBhcmFtIHV1aWRcclxuICAgICAqL1xyXG4gICAgYXN5bmMgbG9hZEFueTxUQXNzZXQgZXh0ZW5kcyBjYy5Bc3NldD4odXVpZDogc3RyaW5nKTogUHJvbWlzZTxUQXNzZXQ+IHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8VEFzc2V0PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIGNjLmFzc2V0TWFuYWdlci5hc3NldHMucmVtb3ZlKHV1aWQpO1xyXG4gICAgICAgICAgICBjYy5hc3NldE1hbmFnZXIubG9hZEFueTxUQXNzZXQ+KHV1aWQsIChlcnJvcjogRXJyb3IgfCBudWxsLCBhc3NldDogVEFzc2V0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGFzc2V0KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDpgJrnlKjotoXml7bljIXoo4Xlh73mlbBcclxuICogQHBhcmFtIHByb21pc2Ug6KaB5omn6KGM55qEIFByb21pc2VcclxuICogQHBhcmFtIHRpbWVvdXRNcyDotoXml7bml7bpl7TvvIjmr6vnp5LvvIlcclxuICogQHBhcmFtIG1lc3NhZ2Ug6LaF5pe26ZSZ6K+v5L+h5oGvXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gd2l0aFRpbWVvdXQ8VD4oXHJcbiAgICBwcm9taXNlOiBQcm9taXNlPFQ+LFxyXG4gICAgdGltZW91dE1zOiBudW1iZXIsXHJcbiAgICBtZXNzYWdlID0gJ09wZXJhdGlvbiB0aW1lZCBvdXQnXHJcbik6IFByb21pc2U8VD4ge1xyXG4gICAgbGV0IHRpbWVyOiBOb2RlSlMuVGltZW91dDtcclxuICAgIHJldHVybiBQcm9taXNlLnJhY2UoW1xyXG4gICAgICAgIHByb21pc2UsXHJcbiAgICAgICAgbmV3IFByb21pc2U8bmV2ZXI+KChfLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHJlamVjdChuZXcgRXJyb3IobWVzc2FnZSkpLCB0aW1lb3V0TXMpO1xyXG4gICAgICAgIH0pLFxyXG4gICAgXSkuZmluYWxseSgoKSA9PiBjbGVhclRpbWVvdXQodGltZXIpKTtcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IHNjZW5lVXRpbHMgPSBuZXcgU2NlbmVVdGlsKCk7XHJcbiJdfQ==