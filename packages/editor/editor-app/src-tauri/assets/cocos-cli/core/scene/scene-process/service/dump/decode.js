'use strict';
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.decodeMountedRoot = decodeMountedRoot;
exports.decodePatch = decodePatch;
exports.resetProperty = resetProperty;
exports.updatePropertyFromNull = updatePropertyFromNull;
const utils_1 = require("./utils");
const lodash_1 = __importDefault(require("lodash"));
const { get, set } = lodash_1.default;
const dump_defines_1 = require("./dump-defines");
const cc_1 = require("cc");
const NodeMgr = EditorExtends.Node;
// 还原mountedRoot
function decodeMountedRoot(compOrNode, mountedRoot) {
    if (!compOrNode) {
        return;
    }
    if (typeof mountedRoot === 'undefined') {
        return null;
    }
    const mountedRootNode = NodeMgr.getNode(mountedRoot);
    if (mountedRootNode) {
        if (!compOrNode[cc_1.editorExtrasTag]) {
            compOrNode[cc_1.editorExtrasTag] = {};
        }
        compOrNode[cc_1.editorExtrasTag].mountedRoot = mountedRootNode;
    }
    else {
        if (compOrNode[cc_1.editorExtrasTag]) {
            compOrNode[cc_1.editorExtrasTag].mountedRoot = undefined;
        }
    }
}
async function _decodeByType(type, node, info, dump, opts) {
    const dumpType = dump_defines_1.DumpDefines[type];
    if (dumpType) {
        await dumpType.decode(node, info, dump, opts);
        return true;
    }
    return false;
}
/**
 * 解码一个 dump 补丁到指定的 node 上
 * @param path
 * @param dump
 * @param node
 */
async function decodePatch(path, dump, node) {
    // 将 dump path 转成实际的 node search path
    const info = (0, utils_1.parsingPath)(path, node);
    const parentInfo = (0, utils_1.parsingPath)(info.search, node);
    const forbidUserChanges = [
        cc_1.editorExtrasTag,
        '__scriptAsset',
        'node',
        'uuid',
    ];
    // 获取需要修改的数据
    const data = info.search ? get(node, info.search) : node;
    if (!data) {
        throw new Error(`Failed to decodePatch: Target component not found. path=${path}, info=${JSON.stringify(info)}`);
    }
    if (data instanceof cc_1.Component && forbidUserChanges.includes(info.key)) {
        throw new Error(`Failed to decodePatch: Property(${info.key}) modification not allowed`);
    }
    if (Object.prototype.toString.call(data) === '[object Object]') {
        // 只对 json 格式处理，array 等其他数据放行
        // 判断属性是否为 readonly,是则跳过还原步骤
        let propertyConfig = Object.getOwnPropertyDescriptor(data, info.key);
        if (propertyConfig === undefined) {
            // 原型链上的判断
            propertyConfig = cc.Class.attr(data, info.key);
            if (!propertyConfig || !propertyConfig.hasSetter) {
                // 如果是一个没有经过修饰器的数据，就会进这里
                // 经过 2020/08/25 引擎修饰情整理后，getter 都不会带修饰器，所以需要直接赋值
                // 例如 enabled
                // 如果 propertyConfig.hasGetter 为 true，说明是一个只读的 ccclass 属性
                if (info.key in data && (!propertyConfig || propertyConfig.hasGetter !== true)) {
                    data[info.key] = dump.value;
                }
                return;
            }
        }
        else if (!propertyConfig.writable && !propertyConfig.set) {
            throw new Error(`Failed to decodePatch: Property(${info.key}) is read-only or has no setter`);
        }
    }
    const parentData = parentInfo.search ? get(node, parentInfo.search) : node;
    // 如果 dump.value 为 null，则需要自动填充默认数据
    if (!('value' in dump) || dump.type === 'Unknown') {
        let attr = cc.Class.attr(data, info.key);
        if (Array.isArray(parentData) && parentInfo.search !== '_components') {
            const grandInfo = (0, utils_1.parsingPath)(parentInfo.search, node);
            const grandData = grandInfo.search ? get(node, grandInfo.search) : node;
            attr = cc.Class.attr(grandData, grandInfo.key);
            attr = cc.Class.attr(attr.ctor, info.key);
        }
        const value = getDefaultAttrData(attr);
        data[info.key] = value;
        return value;
    }
    // 获取数据的类型
    const ccType = cc.js.getClassByName(dump.type);
    const ccExtends = ccType ? (0, utils_1.getTypeInheritanceChain)(ccType) : [];
    const sceneType = 'cc.Scene';
    const nodeType = 'cc.Node';
    const componentType = 'cc.Component';
    const assetType = 'cc.Asset';
    const valueType = 'cc.ValueType';
    // 实际修改数据
    if (dump.isArray) {
        // 需要对数组内部填充准确的默认值，新值可能是一个 ccClass 类
        if (Array.isArray(dump.value)) {
            const arrayValue = [];
            const attr = cc.Class.attr(data.constructor, info.key);
            for (let i = 0; i < dump.value.length; i++) {
                /**
                 * 这个是历史遗留赋值一个初始值，可能没有需要，
                 * 观察一段时间
                 * 如果后续发现真的有一些场景需要请修改本条注释
                 */
                arrayValue[i] = (0, utils_1.ccClassAttrPropertyDefaultValue)(attr);
                const dumpItem = {
                    type: dump.type,
                    value: dump.value[i]
                };
                await decodePatch(`${i}`, dumpItem, arrayValue);
            }
            data[info.key] = arrayValue;
        }
        else {
            data[info.key] = [];
        }
    }
    else {
        const opts = {};
        opts.ccType = ccType;
        // 特殊属性
        if (info.key in nodeSpecialPropertyDefaultValue) {
            setNodeSpecialProperty(node, info.key, dump.value);
        }
        else if (await _decodeByType(dump.type, data, info, dump, opts)) {
            // empty
        }
        else if (sceneType === dump.type) {
            _decodeByType(nodeType, data, info, dump, opts);
        }
        else if (ArrayBuffer.isView(dump.value)) {
            _decodeByType('TypedArray', data, info, dump, opts);
        }
        else if (ccExtends.includes(nodeType) || nodeType === dump.type) {
            _decodeByType(nodeType, data, info, dump, opts);
        }
        else if (ccExtends.includes(assetType) || assetType === dump.type) {
            await _decodeByType(assetType, data, info, dump, opts);
        }
        else if (ccExtends.includes(componentType) || componentType === dump.type) {
            _decodeByType(componentType, data, info, dump, opts);
        }
        else if (ccExtends.includes(valueType)) {
            _decodeByType(valueType, data, info, dump, opts);
        }
        else if (info.key === 'length' && dump.type === 'Array') {
            // 更改数组长度时造的数据
            while (data.length > dump.value) {
                data.pop();
            }
            const parentData = get(node, parentInfo.search);
            const attr = cc.Class.attr(parentData, parentInfo.key);
            for (let i = data.length; i < dump.value; i++) {
                data[i] = (0, utils_1.ccClassAttrPropertyDefaultValue)(attr);
            }
            set(node, info.search, data);
        }
        else {
            if (ccType && !data[info.key] && dump.value !== null) {
                data[info.key] = new ccType();
                for (let i = 0; i < ccType.__props__.length; i++) {
                    const key = ccType.__props__[i];
                    const item = dump.value[key];
                    if (item) {
                        await decodePatch(`${path}.${key}`, item, node);
                    }
                }
            }
            else if (dump.value === null) {
                // 下一行的 typeof null === 'object' , 这行增加容错
                data[info.key] = dump.value;
            }
            else if (typeof dump.value === 'object') {
                for (const key in dump.value) {
                    if (dump.value[key] === undefined) {
                        continue;
                    }
                    await decodePatch(key, dump.value[key], data[info.key]);
                }
            }
            else {
                data[info.key] = dump.value;
            }
        }
    }
    info.search && set(node, info.search, data);
    if (parentInfo && parentInfo.search) {
        const data = get(node, parentInfo.search);
        // 对组件下的自定义类型进行还原时，可能存在没有setter的情况
        if (data instanceof Object && cc.Class.attr(data, info.key)?.hasSetter) {
            // eslint-disable-next-line no-self-assign
            data[parentInfo.key] = data[parentInfo.key];
        }
    }
}
// 节点特殊属性需要另外用 method 设置
const nodeSpecialPropertyDefaultValue = {
    _lpos() {
        return new cc_1.Vec3(0, 0, 0);
    },
    eulerAngles() {
        return new cc_1.Vec3(0, 0, 0);
    },
    _lscale() {
        return new cc_1.Vec3(1, 1, 1);
    },
    mobility() {
        return cc_1.MobilityMode.Static;
    },
};
function setNodeSpecialProperty(node, key, value) {
    if (node instanceof cc.Node) {
        switch (key) {
            case '_lpos':
                node.position = value;
                break;
            case 'eulerAngles':
                node.eulerAngles = value;
                break;
            case '_lscale':
                node.scale = value;
                break;
            case 'mobility':
                node.mobility = value;
                break;
        }
    }
}
function getDefaultAttrData(attr) {
    let value = (0, utils_1.getDefault)(attr);
    if (typeof value === 'object' && value) {
        if (typeof value.clone === 'function') {
            value = value.clone();
        }
        else if (Array.isArray(value)) {
            value = [];
        }
    }
    return value;
}
function resetProperty(node, path) {
    // 将 dump path 转成实际的 node search path
    const info = (0, utils_1.parsingPath)(path, node);
    // 获取需要修改的数据
    const data = info.search ? get(node, info.search) : node;
    if (!data) {
        return;
    }
    if (info.key in nodeSpecialPropertyDefaultValue) {
        const value = nodeSpecialPropertyDefaultValue[info.key]();
        setNodeSpecialProperty(data, info.key, value);
    }
    else {
        const attr = cc.Class.attr(data.constructor, info.key);
        data[info.key] = getDefaultAttrData(attr);
    }
}
// 将一个属性其现存值与定义类型值不匹配，或者为 null 默认值，改为一个可编辑的值
function updatePropertyFromNull(node, path) {
    // 将 dump path 转成实际的 node search path
    const info = (0, utils_1.parsingPath)(path, node);
    // 获取需要修改的数据
    const data = info.search ? get(node, info.search) : node;
    if (!data) {
        return;
    }
    const attr = cc.Class.attr(data.constructor, info.key);
    data[info.key] = getDefaultAttrData(attr);
    if ((data[info.key] === null || data[info.key] === undefined) && attr.ctor) {
        data[info.key] = new attr.ctor();
    }
}
exports.default = {
    decodePatch,
    resetProperty,
    updatePropertyFromNull,
    decodeMountedRoot,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVjb2RlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvc2NlbmUvc2NlbmUtcHJvY2Vzcy9zZXJ2aWNlL2R1bXAvZGVjb2RlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7Ozs7QUFhYiw4Q0FrQkM7QUFrQkQsa0NBb0tDO0FBd0RELHNDQWlCQztBQUdELHdEQWdCQztBQTdTRCxtQ0FBNEc7QUFFNUcsb0RBQTRCO0FBQzVCLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsZ0JBQU0sQ0FBQztBQUM1QixpREFBNkM7QUFDN0MsMkJBQTBFO0FBQzFFLE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUM7QUFFbkMsZ0JBQWdCO0FBQ2hCLFNBQWdCLGlCQUFpQixDQUFDLFVBQTRCLEVBQUUsV0FBb0I7SUFDaEYsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ2QsT0FBTztJQUNYLENBQUM7SUFDRCxJQUFJLE9BQU8sV0FBVyxLQUFLLFdBQVcsRUFBRSxDQUFDO1FBQ3JDLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFDRCxNQUFNLGVBQWUsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ3JELElBQUksZUFBZSxFQUFFLENBQUM7UUFDbEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxvQkFBZSxDQUFDLEVBQUUsQ0FBQztZQUMvQixVQUFVLENBQUMsb0JBQWUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUNyQyxDQUFDO1FBQ0QsVUFBVSxDQUFDLG9CQUFlLENBQUMsQ0FBQyxXQUFXLEdBQUcsZUFBZSxDQUFDO0lBQzlELENBQUM7U0FBTSxDQUFDO1FBQ0osSUFBSSxVQUFVLENBQUMsb0JBQWUsQ0FBQyxFQUFFLENBQUM7WUFDOUIsVUFBVSxDQUFDLG9CQUFlLENBQUMsQ0FBQyxXQUFXLEdBQUcsU0FBUyxDQUFDO1FBQ3hELENB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QUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFFekQsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ1IsT0FBTztJQUNYLENBQUM7SUFFRCxNQUFNLElBQUksR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN2RCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBRTFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN6RSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3JDLENBQUM7QUFDTCxDQUFDO0FBRUQsa0JBQWU7SUFDWCxXQUFXO0lBQ1gsYUFBYTtJQUNiLHNCQUFzQjtJQUN0QixpQkFBaUI7Q0FDcEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxuXHJcbmRlY2xhcmUgY29uc3QgY2M6IGFueTtcclxuXHJcbmltcG9ydCB7IGNjQ2xhc3NBdHRyUHJvcGVydHlEZWZhdWx0VmFsdWUsIGdldERlZmF1bHQsIGdldFR5cGVJbmhlcml0YW5jZUNoYWluLCBwYXJzaW5nUGF0aCB9IGZyb20gJy4vdXRpbHMnO1xyXG5cclxuaW1wb3J0IGxvZGFzaCBmcm9tICdsb2Rhc2gnO1xyXG5jb25zdCB7IGdldCwgc2V0IH0gPSBsb2Rhc2g7XHJcbmltcG9ydCB7IER1bXBEZWZpbmVzIH0gZnJvbSAnLi9kdW1wLWRlZmluZXMnO1xyXG5pbXBvcnQgeyBDb21wb25lbnQsIGVkaXRvckV4dHJhc1RhZywgTm9kZSwgVmVjMywgTW9iaWxpdHlNb2RlIH0gZnJvbSAnY2MnO1xyXG5jb25zdCBOb2RlTWdyID0gRWRpdG9yRXh0ZW5kcy5Ob2RlO1xyXG5cclxuLy8g6L+Y5Y6fbW91bnRlZFJvb3RcclxuZXhwb3J0IGZ1bmN0aW9uIGRlY29kZU1vdW50ZWRSb290KGNvbXBPck5vZGU6IE5vZGUgfCBDb21wb25lbnQsIG1vdW50ZWRSb290Pzogc3RyaW5nKSB7XHJcbiAgICBpZiAoIWNvbXBPck5vZGUpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAodHlwZW9mIG1vdW50ZWRSb290ID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgbW91bnRlZFJvb3ROb2RlID0gTm9kZU1nci5nZXROb2RlKG1vdW50ZWRSb290KTtcclxuICAgIGlmIChtb3VudGVkUm9vdE5vZGUpIHtcclxuICAgICAgICBpZiAoIWNvbXBPck5vZGVbZWRpdG9yRXh0cmFzVGFnXSkge1xyXG4gICAgICAgICAgICBjb21wT3JOb2RlW2VkaXRvckV4dHJhc1RhZ10gPSB7fTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29tcE9yTm9kZVtlZGl0b3JFeHRyYXNUYWddLm1vdW50ZWRSb290ID0gbW91bnRlZFJvb3ROb2RlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAoY29tcE9yTm9kZVtlZGl0b3JFeHRyYXNUYWddKSB7XHJcbiAgICAgICAgICAgIGNvbXBPck5vZGVbZWRpdG9yRXh0cmFzVGFnXS5tb3VudGVkUm9vdCA9IHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIF9kZWNvZGVCeVR5cGUodHlwZTogc3RyaW5nLCBub2RlOiBhbnksIGluZm86IGFueSwgZHVtcDogYW55LCBvcHRzPzogYW55KSB7XHJcbiAgICBjb25zdCBkdW1wVHlwZSA9IER1bXBEZWZpbmVzW3R5cGVdO1xyXG5cclxuICAgIGlmIChkdW1wVHlwZSkge1xyXG4gICAgICAgIGF3YWl0IGR1bXBUeXBlLmRlY29kZShub2RlLCBpbmZvLCBkdW1wLCBvcHRzKTtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbn1cclxuLyoqXHJcbiAqIOino+eggeS4gOS4qiBkdW1wIOihpeS4geWIsOaMh+WumueahCBub2RlIOS4ilxyXG4gKiBAcGFyYW0gcGF0aFxyXG4gKiBAcGFyYW0gZHVtcFxyXG4gKiBAcGFyYW0gbm9kZVxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlY29kZVBhdGNoKHBhdGg6IHN0cmluZywgZHVtcDogYW55LCBub2RlOiBhbnkpIHtcclxuICAgIC8vIOWwhiBkdW1wIHBhdGgg6L2s5oiQ5a6e6ZmF55qEIG5vZGUgc2VhcmNoIHBhdGhcclxuICAgIGNvbnN0IGluZm8gPSBwYXJzaW5nUGF0aChwYXRoLCBub2RlKTtcclxuICAgIGNvbnN0IHBhcmVudEluZm8gPSBwYXJzaW5nUGF0aChpbmZvLnNlYXJjaCwgbm9kZSk7XHJcblxyXG4gICAgY29uc3QgZm9yYmlkVXNlckNoYW5nZXMgPSBbXHJcbiAgICAgICAgZWRpdG9yRXh0cmFzVGFnLFxyXG4gICAgICAgICdfX3NjcmlwdEFzc2V0JyxcclxuICAgICAgICAnbm9kZScsXHJcbiAgICAgICAgJ3V1aWQnLFxyXG4gICAgXTtcclxuXHJcbiAgICAvLyDojrflj5bpnIDopoHkv67mlLnnmoTmlbDmja5cclxuICAgIGNvbnN0IGRhdGEgPSBpbmZvLnNlYXJjaCA/IGdldChub2RlLCBpbmZvLnNlYXJjaCkgOiBub2RlO1xyXG5cclxuICAgIGlmICghZGF0YSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGRlY29kZVBhdGNoOiBUYXJnZXQgY29tcG9uZW50IG5vdCBmb3VuZC4gcGF0aD0ke3BhdGh9LCBpbmZvPSR7SlNPTi5zdHJpbmdpZnkoaW5mbyl9YCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBDb21wb25lbnQgJiYgZm9yYmlkVXNlckNoYW5nZXMuaW5jbHVkZXMoaW5mby5rZXkpKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZGVjb2RlUGF0Y2g6IFByb3BlcnR5KCR7aW5mby5rZXl9KSBtb2RpZmljYXRpb24gbm90IGFsbG93ZWRgKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGRhdGEpID09PSAnW29iamVjdCBPYmplY3RdJykge1xyXG4gICAgICAgIC8vIOWPquWvuSBqc29uIOagvOW8j+WkhOeQhu+8jGFycmF5IOetieWFtuS7luaVsOaNruaUvuihjFxyXG4gICAgICAgIC8vIOWIpOaWreWxnuaAp+aYr+WQpuS4uiByZWFkb25seSzmmK/liJnot7Pov4fov5jljp/mraXpqqRcclxuICAgICAgICBsZXQgcHJvcGVydHlDb25maWc6IGFueSA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZGF0YSwgaW5mby5rZXkpO1xyXG4gICAgICAgIGlmIChwcm9wZXJ0eUNvbmZpZyA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIC8vIOWOn+Wei+mTvuS4iueahOWIpOaWrVxyXG4gICAgICAgICAgICBwcm9wZXJ0eUNvbmZpZyA9IGNjLkNsYXNzLmF0dHIoZGF0YSwgaW5mby5rZXkpO1xyXG4gICAgICAgICAgICBpZiAoIXByb3BlcnR5Q29uZmlnIHx8ICFwcm9wZXJ0eUNvbmZpZy5oYXNTZXR0ZXIpIHtcclxuICAgICAgICAgICAgICAgIC8vIOWmguaenOaYr+S4gOS4quayoeaciee7j+i/h+S/rumlsOWZqOeahOaVsOaNru+8jOWwseS8mui/m+i/memHjFxyXG4gICAgICAgICAgICAgICAgLy8g57uP6L+HIDIwMjAvMDgvMjUg5byV5pOO5L+u6aWw5oOF5pW055CG5ZCO77yMZ2V0dGVyIOmDveS4jeS8muW4puS/rumlsOWZqO+8jOaJgOS7pemcgOimgeebtOaOpei1i+WAvFxyXG4gICAgICAgICAgICAgICAgLy8g5L6L5aaCIGVuYWJsZWRcclxuICAgICAgICAgICAgICAgIC8vIOWmguaenCBwcm9wZXJ0eUNvbmZpZy5oYXNHZXR0ZXIg5Li6IHRydWXvvIzor7TmmI7mmK/kuIDkuKrlj6ror7vnmoQgY2NjbGFzcyDlsZ7mgKdcclxuICAgICAgICAgICAgICAgIGlmIChpbmZvLmtleSBpbiBkYXRhICYmICghcHJvcGVydHlDb25maWcgfHwgcHJvcGVydHlDb25maWcuaGFzR2V0dGVyICE9PSB0cnVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGRhdGFbaW5mby5rZXldID0gZHVtcC52YWx1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAoIXByb3BlcnR5Q29uZmlnLndyaXRhYmxlICYmICFwcm9wZXJ0eUNvbmZpZy5zZXQpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZGVjb2RlUGF0Y2g6IFByb3BlcnR5KCR7aW5mby5rZXl9KSBpcyByZWFkLW9ubHkgb3IgaGFzIG5vIHNldHRlcmApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBwYXJlbnREYXRhID0gcGFyZW50SW5mby5zZWFyY2ggPyBnZXQobm9kZSwgcGFyZW50SW5mby5zZWFyY2gpIDogbm9kZTtcclxuXHJcbiAgICAvLyDlpoLmnpwgZHVtcC52YWx1ZSDkuLogbnVsbO+8jOWImemcgOimgeiHquWKqOWhq+WFhem7mOiupOaVsOaNrlxyXG4gICAgaWYgKCEoJ3ZhbHVlJyBpbiBkdW1wKSB8fCBkdW1wLnR5cGUgPT09ICdVbmtub3duJykge1xyXG4gICAgICAgIGxldCBhdHRyID0gY2MuQ2xhc3MuYXR0cihkYXRhLCBpbmZvLmtleSk7XHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocGFyZW50RGF0YSkgJiYgcGFyZW50SW5mby5zZWFyY2ggIT09ICdfY29tcG9uZW50cycpIHtcclxuICAgICAgICAgICAgY29uc3QgZ3JhbmRJbmZvID0gcGFyc2luZ1BhdGgocGFyZW50SW5mby5zZWFyY2gsIG5vZGUpO1xyXG4gICAgICAgICAgICBjb25zdCBncmFuZERhdGEgPSBncmFuZEluZm8uc2VhcmNoID8gZ2V0KG5vZGUsIGdyYW5kSW5mby5zZWFyY2gpIDogbm9kZTtcclxuICAgICAgICAgICAgYXR0ciA9IGNjLkNsYXNzLmF0dHIoZ3JhbmREYXRhLCBncmFuZEluZm8ua2V5KTtcclxuICAgICAgICAgICAgYXR0ciA9IGNjLkNsYXNzLmF0dHIoYXR0ci5jdG9yLCBpbmZvLmtleSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB2YWx1ZSA9IGdldERlZmF1bHRBdHRyRGF0YShhdHRyKTtcclxuICAgICAgICBkYXRhW2luZm8ua2V5XSA9IHZhbHVlO1xyXG5cclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g6I635Y+W5pWw5o2u55qE57G75Z6LXHJcbiAgICBjb25zdCBjY1R5cGUgPSBjYy5qcy5nZXRDbGFzc0J5TmFtZShkdW1wLnR5cGUpO1xyXG4gICAgY29uc3QgY2NFeHRlbmRzID0gY2NUeXBlID8gZ2V0VHlwZUluaGVyaXRhbmNlQ2hhaW4oY2NUeXBlKSA6IFtdO1xyXG4gICAgY29uc3Qgc2NlbmVUeXBlID0gJ2NjLlNjZW5lJztcclxuICAgIGNvbnN0IG5vZGVUeXBlID0gJ2NjLk5vZGUnO1xyXG4gICAgY29uc3QgY29tcG9uZW50VHlwZSA9ICdjYy5Db21wb25lbnQnO1xyXG4gICAgY29uc3QgYXNzZXRUeXBlID0gJ2NjLkFzc2V0JztcclxuICAgIGNvbnN0IHZhbHVlVHlwZSA9ICdjYy5WYWx1ZVR5cGUnO1xyXG5cclxuICAgIC8vIOWunumZheS/ruaUueaVsOaNrlxyXG4gICAgaWYgKGR1bXAuaXNBcnJheSkge1xyXG4gICAgICAgIC8vIOmcgOimgeWvueaVsOe7hOWGhemDqOWhq+WFheWHhuehrueahOm7mOiupOWAvO+8jOaWsOWAvOWPr+iDveaYr+S4gOS4qiBjY0NsYXNzIOexu1xyXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGR1bXAudmFsdWUpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGFycmF5VmFsdWU6IGFueSA9IFtdO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgYXR0ciA9IGNjLkNsYXNzLmF0dHIoZGF0YS5jb25zdHJ1Y3RvciwgaW5mby5rZXkpO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGR1bXAudmFsdWUubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIC8qKlxyXG4gICAgICAgICAgICAgICAgICog6L+Z5Liq5piv5Y6G5Y+y6YGX55WZ6LWL5YC85LiA5Liq5Yid5aeL5YC877yM5Y+v6IO95rKh5pyJ6ZyA6KaB77yMXHJcbiAgICAgICAgICAgICAgICAgKiDop4Llr5/kuIDmrrXml7bpl7RcclxuICAgICAgICAgICAgICAgICAqIOWmguaenOWQjue7reWPkeeOsOecn+eahOacieS4gOS6m+WcuuaZr+mcgOimgeivt+S/ruaUueacrOadoeazqOmHilxyXG4gICAgICAgICAgICAgICAgICovXHJcbiAgICAgICAgICAgICAgICBhcnJheVZhbHVlW2ldID0gY2NDbGFzc0F0dHJQcm9wZXJ0eURlZmF1bHRWYWx1ZShhdHRyKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGR1bXBJdGVtID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IGR1bXAudHlwZSxcclxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZHVtcC52YWx1ZVtpXVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIGF3YWl0IGRlY29kZVBhdGNoKGAke2l9YCwgZHVtcEl0ZW0sIGFycmF5VmFsdWUpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBkYXRhW2luZm8ua2V5XSA9IGFycmF5VmFsdWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZGF0YVtpbmZvLmtleV0gPSBbXTtcclxuICAgICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnN0IG9wdHM6IGFueSA9IHt9O1xyXG4gICAgICAgIG9wdHMuY2NUeXBlID0gY2NUeXBlO1xyXG4gICAgICAgIC8vIOeJueauiuWxnuaAp1xyXG4gICAgICAgIGlmIChpbmZvLmtleSBpbiBub2RlU3BlY2lhbFByb3BlcnR5RGVmYXVsdFZhbHVlKSB7XHJcbiAgICAgICAgICAgIHNldE5vZGVTcGVjaWFsUHJvcGVydHkobm9kZSwgaW5mby5rZXksIGR1bXAudmFsdWUpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoYXdhaXQgX2RlY29kZUJ5VHlwZShkdW1wLnR5cGUsIGRhdGEsIGluZm8sIGR1bXAsIG9wdHMpKSB7XHJcbiAgICAgICAgICAgIC8vIGVtcHR5XHJcbiAgICAgICAgfSBlbHNlIGlmIChzY2VuZVR5cGUgPT09IGR1bXAudHlwZSkge1xyXG4gICAgICAgICAgICBfZGVjb2RlQnlUeXBlKG5vZGVUeXBlLCBkYXRhLCBpbmZvLCBkdW1wLCBvcHRzKTtcclxuICAgICAgICB9IGVsc2UgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhkdW1wLnZhbHVlKSkge1xyXG4gICAgICAgICAgICBfZGVjb2RlQnlUeXBlKCdUeXBlZEFycmF5JywgZGF0YSwgaW5mbywgZHVtcCwgb3B0cyk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChjY0V4dGVuZHMuaW5jbHVkZXMobm9kZVR5cGUpIHx8IG5vZGVUeXBlID09PSBkdW1wLnR5cGUpIHtcclxuICAgICAgICAgICAgX2RlY29kZUJ5VHlwZShub2RlVHlwZSwgZGF0YSwgaW5mbywgZHVtcCwgb3B0cyk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChjY0V4dGVuZHMuaW5jbHVkZXMoYXNzZXRUeXBlKSB8fCBhc3NldFR5cGUgPT09IGR1bXAudHlwZSkge1xyXG4gICAgICAgICAgICBhd2FpdCBfZGVjb2RlQnlUeXBlKGFzc2V0VHlwZSwgZGF0YSwgaW5mbywgZHVtcCwgb3B0cyk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChjY0V4dGVuZHMuaW5jbHVkZXMoY29tcG9uZW50VHlwZSkgfHwgY29tcG9uZW50VHlwZSA9PT0gZHVtcC50eXBlKSB7XHJcbiAgICAgICAgICAgIF9kZWNvZGVCeVR5cGUoY29tcG9uZW50VHlwZSwgZGF0YSwgaW5mbywgZHVtcCwgb3B0cyk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChjY0V4dGVuZHMuaW5jbHVkZXModmFsdWVUeXBlKSkge1xyXG4gICAgICAgICAgICBfZGVjb2RlQnlUeXBlKHZhbHVlVHlwZSwgZGF0YSwgaW5mbywgZHVtcCwgb3B0cyk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChpbmZvLmtleSA9PT0gJ2xlbmd0aCcgJiYgZHVtcC50eXBlID09PSAnQXJyYXknKSB7XHJcbiAgICAgICAgICAgIC8vIOabtOaUueaVsOe7hOmVv+W6puaXtumAoOeahOaVsOaNrlxyXG4gICAgICAgICAgICB3aGlsZSAoZGF0YS5sZW5ndGggPiBkdW1wLnZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICBkYXRhLnBvcCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudERhdGEgPSBnZXQobm9kZSwgcGFyZW50SW5mby5zZWFyY2gpO1xyXG4gICAgICAgICAgICBjb25zdCBhdHRyID0gY2MuQ2xhc3MuYXR0cihwYXJlbnREYXRhLCBwYXJlbnRJbmZvLmtleSk7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSBkYXRhLmxlbmd0aDsgaSA8IGR1bXAudmFsdWU7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgZGF0YVtpXSA9IGNjQ2xhc3NBdHRyUHJvcGVydHlEZWZhdWx0VmFsdWUoYXR0cik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgc2V0KG5vZGUsIGluZm8uc2VhcmNoLCBkYXRhKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoY2NUeXBlICYmICFkYXRhW2luZm8ua2V5XSAmJiBkdW1wLnZhbHVlICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBkYXRhW2luZm8ua2V5XSA9IG5ldyBjY1R5cGUoKTtcclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2NUeXBlLl9fcHJvcHNfXy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IGNjVHlwZS5fX3Byb3BzX19baV07XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXRlbSA9IGR1bXAudmFsdWVba2V5XTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBkZWNvZGVQYXRjaChgJHtwYXRofS4ke2tleX1gLCBpdGVtLCBub2RlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZHVtcC52YWx1ZSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgLy8g5LiL5LiA6KGM55qEIHR5cGVvZiBudWxsID09PSAnb2JqZWN0JyAsIOi/meihjOWinuWKoOWuuemUmVxyXG4gICAgICAgICAgICAgICAgZGF0YVtpbmZvLmtleV0gPSBkdW1wLnZhbHVlO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkdW1wLnZhbHVlID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gZHVtcC52YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChkdW1wLnZhbHVlW2tleV0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGRlY29kZVBhdGNoKGtleSwgZHVtcC52YWx1ZVtrZXldLCBkYXRhW2luZm8ua2V5XSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBkYXRhW2luZm8ua2V5XSA9IGR1bXAudmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaW5mby5zZWFyY2ggJiYgc2V0KG5vZGUsIGluZm8uc2VhcmNoLCBkYXRhKTtcclxuICAgIGlmIChwYXJlbnRJbmZvICYmIHBhcmVudEluZm8uc2VhcmNoKSB7XHJcbiAgICAgICAgY29uc3QgZGF0YSA9IGdldChub2RlLCBwYXJlbnRJbmZvLnNlYXJjaCk7XHJcbiAgICAgICAgLy8g5a+557uE5Lu25LiL55qE6Ieq5a6a5LmJ57G75Z6L6L+b6KGM6L+Y5Y6f5pe277yM5Y+v6IO95a2Y5Zyo5rKh5pyJc2V0dGVy55qE5oOF5Ya1XHJcbiAgICAgICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBPYmplY3QgJiYgY2MuQ2xhc3MuYXR0cihkYXRhLCBpbmZvLmtleSk/Lmhhc1NldHRlcikge1xyXG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tc2VsZi1hc3NpZ25cclxuICAgICAgICAgICAgZGF0YVtwYXJlbnRJbmZvLmtleV0gPSBkYXRhW3BhcmVudEluZm8ua2V5XTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbnR5cGUgTm9kZVNwZWNpYWxQcm9wZXJ0eSA9IHtcclxuICAgIF9scG9zOiAoKSA9PiBWZWMzO1xyXG4gICAgZXVsZXJBbmdsZXM6ICgpID0+IFZlYzM7XHJcbiAgICBfbHNjYWxlOiAoKSA9PiBWZWMzO1xyXG4gICAgbW9iaWxpdHk6ICgpID0+IG51bWJlcjtcclxufTtcclxuXHJcbi8vIOiKgueCueeJueauiuWxnuaAp+mcgOimgeWPpuWklueUqCBtZXRob2Qg6K6+572uXHJcbmNvbnN0IG5vZGVTcGVjaWFsUHJvcGVydHlEZWZhdWx0VmFsdWU6IE5vZGVTcGVjaWFsUHJvcGVydHkgPSB7XHJcbiAgICBfbHBvcygpIHtcclxuICAgICAgICByZXR1cm4gbmV3IFZlYzMoMCwgMCwgMCk7XHJcbiAgICB9LFxyXG4gICAgZXVsZXJBbmdsZXMoKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBWZWMzKDAsIDAsIDApO1xyXG4gICAgfSxcclxuICAgIF9sc2NhbGUoKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBWZWMzKDEsIDEsIDEpO1xyXG4gICAgfSxcclxuICAgIG1vYmlsaXR5KCkge1xyXG4gICAgICAgIHJldHVybiBNb2JpbGl0eU1vZGUuU3RhdGljO1xyXG4gICAgfSxcclxufTtcclxuXHJcbmZ1bmN0aW9uIHNldE5vZGVTcGVjaWFsUHJvcGVydHkobm9kZTogYW55LCBrZXk6IHN0cmluZywgdmFsdWU6IGFueSkge1xyXG4gICAgaWYgKG5vZGUgaW5zdGFuY2VvZiBjYy5Ob2RlKSB7XHJcbiAgICAgICAgc3dpdGNoIChrZXkpIHtcclxuICAgICAgICAgICAgY2FzZSAnX2xwb3MnOlxyXG4gICAgICAgICAgICAgICAgbm9kZS5wb3NpdGlvbiA9IHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgJ2V1bGVyQW5nbGVzJzpcclxuICAgICAgICAgICAgICAgIG5vZGUuZXVsZXJBbmdsZXMgPSB2YWx1ZTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdfbHNjYWxlJzpcclxuICAgICAgICAgICAgICAgIG5vZGUuc2NhbGUgPSB2YWx1ZTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdtb2JpbGl0eSc6XHJcbiAgICAgICAgICAgICAgICBub2RlLm1vYmlsaXR5ID0gdmFsdWU7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldERlZmF1bHRBdHRyRGF0YShhdHRyOiBhbnkpIHtcclxuICAgIGxldCB2YWx1ZSA9IGdldERlZmF1bHQoYXR0cik7XHJcbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiB2YWx1ZSkge1xyXG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUuY2xvbmUgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5jbG9uZSgpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcclxuICAgICAgICAgICAgdmFsdWUgPSBbXTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdmFsdWU7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiByZXNldFByb3BlcnR5KG5vZGU6IGFueSwgcGF0aDogc3RyaW5nKSB7XHJcbiAgICAvLyDlsIYgZHVtcCBwYXRoIOi9rOaIkOWunumZheeahCBub2RlIHNlYXJjaCBwYXRoXHJcbiAgICBjb25zdCBpbmZvID0gcGFyc2luZ1BhdGgocGF0aCwgbm9kZSk7XHJcbiAgICAvLyDojrflj5bpnIDopoHkv67mlLnnmoTmlbDmja5cclxuICAgIGNvbnN0IGRhdGEgPSBpbmZvLnNlYXJjaCA/IGdldChub2RlLCBpbmZvLnNlYXJjaCkgOiBub2RlO1xyXG5cclxuICAgIGlmICghZGF0YSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoaW5mby5rZXkgaW4gbm9kZVNwZWNpYWxQcm9wZXJ0eURlZmF1bHRWYWx1ZSkge1xyXG4gICAgICAgIGNvbnN0IHZhbHVlID0gbm9kZVNwZWNpYWxQcm9wZXJ0eURlZmF1bHRWYWx1ZVtpbmZvLmtleSBhcyBrZXlvZiBOb2RlU3BlY2lhbFByb3BlcnR5XSgpO1xyXG4gICAgICAgIHNldE5vZGVTcGVjaWFsUHJvcGVydHkoZGF0YSwgaW5mby5rZXksIHZhbHVlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QgYXR0ciA9IGNjLkNsYXNzLmF0dHIoZGF0YS5jb25zdHJ1Y3RvciwgaW5mby5rZXkpO1xyXG4gICAgICAgIGRhdGFbaW5mby5rZXldID0gZ2V0RGVmYXVsdEF0dHJEYXRhKGF0dHIpO1xyXG4gICAgfVxyXG59XHJcblxyXG4vLyDlsIbkuIDkuKrlsZ7mgKflhbbnjrDlrZjlgLzkuI7lrprkuYnnsbvlnovlgLzkuI3ljLnphY3vvIzmiJbogIXkuLogbnVsbCDpu5jorqTlgLzvvIzmlLnkuLrkuIDkuKrlj6/nvJbovpHnmoTlgLxcclxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZVByb3BlcnR5RnJvbU51bGwobm9kZTogYW55LCBwYXRoOiBzdHJpbmcpIHtcclxuICAgIC8vIOWwhiBkdW1wIHBhdGgg6L2s5oiQ5a6e6ZmF55qEIG5vZGUgc2VhcmNoIHBhdGhcclxuICAgIGNvbnN0IGluZm8gPSBwYXJzaW5nUGF0aChwYXRoLCBub2RlKTtcclxuICAgIC8vIOiOt+WPlumcgOimgeS/ruaUueeahOaVsOaNrlxyXG4gICAgY29uc3QgZGF0YSA9IGluZm8uc2VhcmNoID8gZ2V0KG5vZGUsIGluZm8uc2VhcmNoKSA6IG5vZGU7XHJcblxyXG4gICAgaWYgKCFkYXRhKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGF0dHIgPSBjYy5DbGFzcy5hdHRyKGRhdGEuY29uc3RydWN0b3IsIGluZm8ua2V5KTtcclxuICAgIGRhdGFbaW5mby5rZXldID0gZ2V0RGVmYXVsdEF0dHJEYXRhKGF0dHIpO1xyXG5cclxuICAgIGlmICgoZGF0YVtpbmZvLmtleV0gPT09IG51bGwgfHwgZGF0YVtpbmZvLmtleV0gPT09IHVuZGVmaW5lZCkgJiYgYXR0ci5jdG9yKSB7XHJcbiAgICAgICAgZGF0YVtpbmZvLmtleV0gPSBuZXcgYXR0ci5jdG9yKCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IHtcclxuICAgIGRlY29kZVBhdGNoLFxyXG4gICAgcmVzZXRQcm9wZXJ0eSxcclxuICAgIHVwZGF0ZVByb3BlcnR5RnJvbU51bGwsXHJcbiAgICBkZWNvZGVNb3VudGVkUm9vdCxcclxufTtcclxuIl19