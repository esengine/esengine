"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cc_1 = require("cc");
function getBoundingBox(node) {
    const modelComponent = node.getComponent(cc_1.MeshRenderer);
    if (!modelComponent || !modelComponent.mesh) {
        return {
            minPosition: cc_1.Vec3.ZERO,
            maxPosition: cc_1.Vec3.ZERO,
        };
    }
    return {
        minPosition: modelComponent.mesh.minPosition,
        maxPosition: modelComponent.mesh.maxPosition,
    };
}
function getSize(boundingBox) {
    const size = new cc_1.Vec3();
    cc_1.Vec3.subtract(size, boundingBox.maxPosition, boundingBox.minPosition);
    return size;
}
function getCenter(boundingBox) {
    const size = getSize(boundingBox);
    const center = new cc_1.Vec3();
    cc_1.Vec3.scaleAndAdd(center, boundingBox.minPosition, size, 0.5);
    return center;
}
function maxComponent(v) {
    return Math.max(v.x, Math.max(v.y, v.z));
}
class ComponentUtils {
    /**
     * 添加组件对应的内部处理方法
     */
    addComponentMap = {
        SphereCollider(component, node) {
            if (node['_prefab']) {
                return;
            }
            const boundingBox = getBoundingBox(node);
            const boundingSize = getSize(boundingBox);
            if (!cc_1.Vec3.strictEquals(boundingSize, cc_1.Vec3.ZERO)) {
                component.radius = maxComponent(boundingSize) / 2;
                component.center = getCenter(boundingBox);
            }
        },
        BoxCollider(component, node) {
            if (node['_prefab']) {
                return;
            }
            const boundingBox = getBoundingBox(node);
            const boundingSize = getSize(boundingBox);
            if (!cc_1.Vec3.strictEquals(boundingSize, cc_1.Vec3.ZERO)) {
                boundingSize.x = boundingSize.x === 0 ? 0.001 : boundingSize.x;
                boundingSize.y = boundingSize.y === 0 ? 0.001 : boundingSize.y;
                boundingSize.z = boundingSize.z === 0 ? 0.001 : boundingSize.z;
                component.size = boundingSize;
                component.center = getCenter(boundingBox);
            }
        },
        ConeCollider(component, node) {
            if (node['_prefab']) {
                return;
            }
            const boundingBox = getBoundingBox(node);
            const boundingSize = getSize(boundingBox);
            if (!cc_1.Vec3.strictEquals(boundingSize, cc_1.Vec3.ZERO)) {
                const radius = Math.max(boundingSize.x, boundingSize.z) / 2;
                const height = boundingSize.y;
                if (radius > 0) {
                    component.radius = radius;
                }
                if (height > 0) {
                    component.height = height;
                }
                component.center = getCenter(boundingBox);
            }
        },
        CylinderCollider(component, node) {
            if (node['_prefab']) {
                return;
            }
            const boundingBox = getBoundingBox(node);
            const boundingSize = getSize(boundingBox);
            if (!cc_1.Vec3.strictEquals(boundingSize, cc_1.Vec3.ZERO)) {
                const radius = Math.max(boundingSize.x, boundingSize.z) / 2;
                const height = boundingSize.y;
                if (radius > 0) {
                    component.radius = radius;
                }
                if (height > 0) {
                    component.height = height;
                }
                component.center = getCenter(boundingBox);
            }
        },
        CapsuleCollider(component, node) {
            if (node['_prefab']) {
                return;
            }
            const boundingBox = getBoundingBox(node);
            const boundingSize = getSize(boundingBox);
            if (!cc_1.Vec3.strictEquals(boundingSize, cc_1.Vec3.ZERO)) {
                const radius = Math.max(boundingSize.x, boundingSize.z) / 2;
                const cylinderHeight = boundingSize.y - radius * 2;
                if (radius > 0) {
                    component.radius = radius;
                    component.cylinderHeight = cylinderHeight > 0 ? cylinderHeight : 0;
                }
                component.center = getCenter(boundingBox);
            }
        },
        MeshCollider(component, node) {
            if (node['_prefab']) {
                return;
            }
            const model = node.getComponent(cc_1.MeshRenderer);
            if (model && model.mesh) {
                component.mesh = model.mesh;
            }
        },
        TerrainCollider(component, node) {
            if (node['_prefab']) {
                return;
            }
            const terrain = node.getComponent(cc_1.Terrain);
            if (terrain && terrain._asset) {
                component.terrain = terrain._asset;
            }
        },
        BoxCollider2D(component, node) {
            const trans = component.getComponent(cc_1.UITransformComponent);
            if (!trans) {
                return;
            }
            const size = trans.contentSize;
            if (size.width !== 0 && size.height !== 0) {
                component.size = cc.size(size);
                component.offset.x = (0.5 - trans.anchorX) * size.width;
                component.offset.y = (0.5 - trans.anchorY) * size.height;
            }
        },
        CircleCollider2D(component, node) {
            const trans = component.getComponent(cc_1.UITransformComponent);
            if (!trans) {
                return;
            }
            const size = trans.contentSize;
            const radius = Math.max(size.width, size.height) / 2;
            if (radius !== 0) {
                component.radius = radius;
            }
        },
        PolygonCollider2D(component, node) {
            //TODO: PhysicsUtils.resetPoints(component);
        },
        Camera(component, node) {
            component.visibility = cc_1.Layers.makeMaskInclude([cc_1.Layers.Enum.UI_3D, cc_1.Layers.Enum.UI_2D]);
            component.projection = cc_1.Camera.ProjectionType.ORTHO;
            component.near = 0;
            component.clearFlags = cc_1.Camera.ClearFlag.DEPTH_ONLY;
        },
    };
    /**
     * 检测一个字符串是否是合法的 UUID（支持 v1 ~ v5）
     * @param value 要检测的字符串
     * @returns 是否为 UUID
     */
    isUUID(value) {
        if (typeof value !== 'string') {
            return false;
        }
        // UUID 正则匹配 (v1-v5)
        const uuidReg = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
        return uuidReg.test(value);
    }
}
exports.default = new ComponentUtils();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9zY2VuZS9zY2VuZS1wcm9jZXNzL3NlcnZpY2UvY29tcG9uZW50L3V0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkJBaUJZO0FBT1osU0FBUyxjQUFjLENBQUMsSUFBVTtJQUM5QixNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLGlCQUFZLENBQWlCLENBQUM7SUFDdkUsSUFBSSxDQUFDLGNBQWMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUMxQyxPQUFPO1lBQ0gsV0FBVyxFQUFFLFNBQUksQ0FBQyxJQUFJO1lBQ3RCLFdBQVcsRUFBRSxTQUFJLENBQUMsSUFBSTtTQUN6QixDQUFDO0lBQ04sQ0FBQztJQUNELE9BQU87UUFDSCxXQUFXLEVBQUUsY0FBZSxDQUFDLElBQUssQ0FBQyxXQUFZO1FBQy9DLFdBQVcsRUFBRSxjQUFlLENBQUMsSUFBSyxDQUFDLFdBQVk7S0FDbEQsQ0FBQztBQUNOLENBQUM7QUFFRCxTQUFTLE9BQU8sQ0FBQyxXQUF5QjtJQUN0QyxNQUFNLElBQUksR0FBRyxJQUFJLFNBQUksRUFBRSxDQUFDO0lBQ3hCLFNBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ3RFLE9BQU8sSUFBSSxDQUFDO0FBQ2hCLENBQUM7QUFFRCxTQUFTLFNBQVMsQ0FBQyxXQUF5QjtJQUN4QyxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDbEMsTUFBTSxNQUFNLEdBQUcsSUFBSSxTQUFJLEVBQUUsQ0FBQztJQUMxQixTQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxXQUFXLENBQUMsV0FBVyxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUM3RCxPQUFP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QUMvQixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNyRCxJQUFJLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDZixTQUFTLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztZQUM5QixDQUFDO1FBQ0wsQ0FBQztRQUVELGlCQUFpQixDQUFDLFNBQTRCLEVBQUUsSUFBVTtZQUN0RCw0Q0FBNEM7UUFDaEQsQ0FBQztRQUVELE1BQU0sQ0FBQyxTQUFpQixFQUFFLElBQVU7WUFDaEMsU0FBUyxDQUFDLFVBQVUsR0FBRyxXQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsV0FBTSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsV0FBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ3RGLFNBQVMsQ0FBQyxVQUFVLEdBQUcsV0FBTSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUM7WUFDbkQsU0FBUyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7WUFDbkIsU0FBUyxDQUFDLFVBQVUsR0FBRyxXQUFNLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQztRQUN2RCxDQUFDO0tBQ0osQ0FBQztJQUVGOzs7O09BSUc7SUFDSCxNQUFNLENBQUMsS0FBYztRQUNqQixJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQzVCLE9BQU8sS0FBSyxDQUFDO1FBQ2pCLENBQUM7UUFFRCxvQkFBb0I7UUFDcEIsTUFBTSxPQUFPLEdBQ1QsNEVBQTRFLENBQUM7UUFFakYsT0FBTyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQy9CLENBQUM7Q0FDSjtBQUVELGtCQUFlLElBQUksY0FBYyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gICAgTm9kZSxcclxuICAgIE1lc2hSZW5kZXJlcixcclxuICAgIFZlYzMsXHJcbiAgICBTcGhlcmVDb2xsaWRlcixcclxuICAgIEJveENvbGxpZGVyLFxyXG4gICAgVUlUcmFuc2Zvcm1Db21wb25lbnQsXHJcbiAgICBQb2x5Z29uQ29sbGlkZXIyRCxcclxuICAgIE1lc2hDb2xsaWRlcixcclxuICAgIENhcHN1bGVDb2xsaWRlcixcclxuICAgIEN5bGluZGVyQ29sbGlkZXIsXHJcbiAgICBUZXJyYWluQ29sbGlkZXIsXHJcbiAgICBUZXJyYWluLFxyXG4gICAgQ29uZUNvbGxpZGVyLFxyXG4gICAgSVZlYzNMaWtlLFxyXG4gICAgQ2FtZXJhLFxyXG4gICAgTGF5ZXJzLFxyXG59IGZyb20gJ2NjJztcclxuXHJcbmludGVyZmFjZSBJQm91bmRpbmdCb3gge1xyXG4gICAgbWluUG9zaXRpb246IElWZWMzTGlrZTtcclxuICAgIG1heFBvc2l0aW9uOiBJVmVjM0xpa2U7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldEJvdW5kaW5nQm94KG5vZGU6IE5vZGUpIHtcclxuICAgIGNvbnN0IG1vZGVsQ29tcG9uZW50ID0gbm9kZS5nZXRDb21wb25lbnQoTWVzaFJlbmRlcmVyKSBhcyBNZXNoUmVuZGVyZXI7XHJcbiAgICBpZiAoIW1vZGVsQ29tcG9uZW50IHx8ICFtb2RlbENvbXBvbmVudC5tZXNoKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgbWluUG9zaXRpb246IFZlYzMuWkVSTyxcclxuICAgICAgICAgICAgbWF4UG9zaXRpb246IFZlYzMuWkVSTyxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBtaW5Qb3NpdGlvbjogbW9kZWxDb21wb25lbnQhLm1lc2ghLm1pblBvc2l0aW9uISxcclxuICAgICAgICBtYXhQb3NpdGlvbjogbW9kZWxDb21wb25lbnQhLm1lc2ghLm1heFBvc2l0aW9uISxcclxuICAgIH07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFNpemUoYm91bmRpbmdCb3g6IElCb3VuZGluZ0JveCkge1xyXG4gICAgY29uc3Qgc2l6ZSA9IG5ldyBWZWMzKCk7XHJcbiAgICBWZWMzLnN1YnRyYWN0KHNpemUsIGJvdW5kaW5nQm94Lm1heFBvc2l0aW9uLCBib3VuZGluZ0JveC5taW5Qb3NpdGlvbik7XHJcbiAgICByZXR1cm4gc2l6ZTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0Q2VudGVyKGJvdW5kaW5nQm94OiBJQm91bmRpbmdCb3gpIHtcclxuICAgIGNvbnN0IHNpemUgPSBnZXRTaXplKGJvdW5kaW5nQm94KTtcclxuICAgIGNvbnN0IGNlbnRlciA9IG5ldyBWZWMzKCk7XHJcbiAgICBWZWMzLnNjYWxlQW5kQWRkKGNlbnRlciwgYm91bmRpbmdCb3gubWluUG9zaXRpb24sIHNpemUsIDAuNSk7XHJcbiAgICByZXR1cm4gY2VudGVyO1xyXG59XHJcblxyXG5mdW5jdGlvbiBtYXhDb21wb25lbnQodjogVmVjMykge1xyXG4gICAgcmV0dXJuIE1hdGgubWF4KHYueCwgTWF0aC5tYXgodi55LCB2LnopKTtcclxufVxyXG5cclxuY2xhc3MgQ29tcG9uZW50VXRpbHMge1xyXG4gICAgLyoqXHJcbiAgICAgKiDmt7vliqDnu4Tku7blr7nlupTnmoTlhoXpg6jlpITnkIbmlrnms5VcclxuICAgICAqL1xyXG4gICAgYWRkQ29tcG9uZW50TWFwID0ge1xyXG4gICAgICAgIFNwaGVyZUNvbGxpZGVyKGNvbXBvbmVudDogU3BoZXJlQ29sbGlkZXIsIG5vZGU6IE5vZGUpIHtcclxuICAgICAgICAgICAgaWYgKChub2RlIGFzIGFueSlbJ19wcmVmYWInXSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IGJvdW5kaW5nQm94ID0gZ2V0Qm91bmRpbmdCb3gobm9kZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGJvdW5kaW5nU2l6ZSA9IGdldFNpemUoYm91bmRpbmdCb3gpO1xyXG4gICAgICAgICAgICBpZiAoIVZlYzMuc3RyaWN0RXF1YWxzKGJvdW5kaW5nU2l6ZSwgVmVjMy5aRVJPKSkge1xyXG4gICAgICAgICAgICAgICAgY29tcG9uZW50LnJhZGl1cyA9IG1heENvbXBvbmVudChib3VuZGluZ1NpemUpIC8gMjtcclxuICAgICAgICAgICAgICAgIGNvbXBvbmVudC5jZW50ZXIgPSBnZXRDZW50ZXIoYm91bmRpbmdCb3gpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgQm94Q29sbGlkZXIoY29tcG9uZW50OiBCb3hDb2xsaWRlciwgbm9kZTogTm9kZSkge1xyXG4gICAgICAgICAgICBpZiAoKG5vZGUgYXMgYW55KVsnX3ByZWZhYiddKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgYm91bmRpbmdCb3ggPSBnZXRCb3VuZGluZ0JveChub2RlKTtcclxuICAgICAgICAgICAgY29uc3QgYm91bmRpbmdTaXplID0gZ2V0U2l6ZShib3VuZGluZ0JveCk7XHJcbiAgICAgICAgICAgIGlmICghVmVjMy5zdHJpY3RFcXVhbHMoYm91bmRpbmdTaXplLCBWZWMzLlpFUk8pKSB7XHJcbiAgICAgICAgICAgICAgICBib3VuZGluZ1NpemUueCA9IGJvdW5kaW5nU2l6ZS54ID09PSAwID8gMC4wMDEgOiBib3VuZGluZ1NpemUueDtcclxuICAgICAgICAgICAgICAgIGJvdW5kaW5nU2l6ZS55ID0gYm91bmRpbmdTaXplLnkgPT09IDAgPyAwLjAwMSA6IGJvdW5kaW5nU2l6ZS55O1xyXG4gICAgICAgICAgICAgICAgYm91bmRpbmdTaXplLnogPSBib3VuZGluZ1NpemUueiA9PT0gMCA/IDAuMDAxIDogYm91bmRpbmdTaXplLno7XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnQuc2l6ZSA9IGJvdW5kaW5nU2l6ZTtcclxuICAgICAgICAgICAgICAgIGNvbXBvbmVudC5jZW50ZXIgPSBnZXRDZW50ZXIoYm91bmRpbmdCb3gpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgQ29uZUNvbGxpZGVyKGNvbXBvbmVudDogQ29uZUNvbGxpZGVyLCBub2RlOiBOb2RlKSB7XHJcbiAgICAgICAgICAgIGlmICgobm9kZSBhcyBhbnkpWydfcHJlZmFiJ10pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBib3VuZGluZ0JveCA9IGdldEJvdW5kaW5nQm94KG5vZGUpO1xyXG4gICAgICAgICAgICBjb25zdCBib3VuZGluZ1NpemUgPSBnZXRTaXplKGJvdW5kaW5nQm94KTtcclxuICAgICAgICAgICAgaWYgKCFWZWMzLnN0cmljdEVxdWFscyhib3VuZGluZ1NpemUsIFZlYzMuWkVSTykpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IE1hdGgubWF4KGJvdW5kaW5nU2l6ZS54LCBib3VuZGluZ1NpemUueikgLyAyO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaGVpZ2h0ID0gYm91bmRpbmdTaXplLnk7XHJcbiAgICAgICAgICAgICAgICBpZiAocmFkaXVzID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudC5yYWRpdXMgPSByYWRpdXM7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoaGVpZ2h0ID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudC5oZWlnaHQgPSBoZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnQuY2VudGVyID0gZ2V0Q2VudGVyKGJvdW5kaW5nQm94KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIEN5bGluZGVyQ29sbGlkZXIoY29tcG9uZW50OiBDeWxpbmRlckNvbGxpZGVyLCBub2RlOiBOb2RlKSB7XHJcbiAgICAgICAgICAgIGlmICgobm9kZSBhcyBhbnkpWydfcHJlZmFiJ10pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBib3VuZGluZ0JveCA9IGdldEJvdW5kaW5nQm94KG5vZGUpO1xyXG4gICAgICAgICAgICBjb25zdCBib3VuZGluZ1NpemUgPSBnZXRTaXplKGJvdW5kaW5nQm94KTtcclxuICAgICAgICAgICAgaWYgKCFWZWMzLnN0cmljdEVxdWFscyhib3VuZGluZ1NpemUsIFZlYzMuWkVSTykpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IE1hdGgubWF4KGJvdW5kaW5nU2l6ZS54LCBib3VuZGluZ1NpemUueikgLyAyO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaGVpZ2h0ID0gYm91bmRpbmdTaXplLnk7XHJcbiAgICAgICAgICAgICAgICBpZiAocmFkaXVzID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudC5yYWRpdXMgPSByYWRpdXM7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoaGVpZ2h0ID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudC5oZWlnaHQgPSBoZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnQuY2VudGVyID0gZ2V0Q2VudGVyKGJvdW5kaW5nQm94KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcblxyXG4gICAgICAgIENhcHN1bGVDb2xsaWRlcihjb21wb25lbnQ6IENhcHN1bGVDb2xsaWRlciwgbm9kZTogTm9kZSkge1xyXG4gICAgICAgICAgICBpZiAoKG5vZGUgYXMgYW55KVsnX3ByZWZhYiddKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgYm91bmRpbmdCb3ggPSBnZXRCb3VuZGluZ0JveChub2RlKTtcclxuICAgICAgICAgICAgY29uc3QgYm91bmRpbmdTaXplID0gZ2V0U2l6ZShib3VuZGluZ0JveCk7XHJcbiAgICAgICAgICAgIGlmICghVmVjMy5zdHJpY3RFcXVhbHMoYm91bmRpbmdTaXplLCBWZWMzLlpFUk8pKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByYWRpdXMgPSBNYXRoLm1heChib3VuZGluZ1NpemUueCwgYm91bmRpbmdTaXplLnopIC8gMjtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGN5bGluZGVySGVpZ2h0ID0gYm91bmRpbmdTaXplLnkgLSByYWRpdXMgKiAyO1xyXG4gICAgICAgICAgICAgICAgaWYgKHJhZGl1cyA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBjb21wb25lbnQucmFkaXVzID0gcmFkaXVzO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudC5jeWxpbmRlckhlaWdodCA9IGN5bGluZGVySGVpZ2h0ID4gMCA/IGN5bGluZGVySGVpZ2h0IDogMDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNvbXBvbmVudC5jZW50ZXIgPSBnZXRDZW50ZXIoYm91bmRpbmdCb3gpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgTWVzaENvbGxpZGVyKGNvbXBvbmVudDogTWVzaENvbGxpZGVyLCBub2RlOiBOb2RlKSB7XHJcbiAgICAgICAgICAgIGlmICgobm9kZSBhcyBhbnkpWydfcHJlZmFiJ10pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBtb2RlbCA9IG5vZGUuZ2V0Q29tcG9uZW50KE1lc2hSZW5kZXJlcik7XHJcbiAgICAgICAgICAgIGlmIChtb2RlbCAmJiBtb2RlbC5tZXNoKSB7XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnQubWVzaCA9IG1vZGVsLm1lc2g7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBUZXJyYWluQ29sbGlkZXIoY29tcG9uZW50OiBUZXJyYWluQ29sbGlkZXIsIG5vZGU6IE5vZGUpIHtcclxuICAgICAgICAgICAgaWYgKChub2RlIGFzIGFueSlbJ19wcmVmYWInXSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHRlcnJhaW4gPSBub2RlLmdldENvbXBvbmVudChUZXJyYWluKTtcclxuICAgICAgICAgICAgaWYgKHRlcnJhaW4gJiYgdGVycmFpbi5fYXNzZXQpIHtcclxuICAgICAgICAgICAgICAgIGNvbXBvbmVudC50ZXJyYWluID0gdGVycmFpbi5fYXNzZXQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBCb3hDb2xsaWRlcjJEKGNvbXBvbmVudDogYW55LCBub2RlOiBOb2RlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRyYW5zID0gY29tcG9uZW50LmdldENvbXBvbmVudChVSVRyYW5zZm9ybUNvbXBvbmVudCk7XHJcbiAgICAgICAgICAgIGlmICghdHJhbnMpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBzaXplID0gdHJhbnMuY29udGVudFNpemU7XHJcbiAgICAgICAgICAgIGlmIChzaXplLndpZHRoICE9PSAwICYmIHNpemUuaGVpZ2h0ICE9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnQuc2l6ZSA9IGNjLnNpemUoc2l6ZSk7XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnQub2Zmc2V0LnggPSAoMC41IC0gdHJhbnMuYW5jaG9yWCkgKiBzaXplLndpZHRoO1xyXG4gICAgICAgICAgICAgICAgY29tcG9uZW50Lm9mZnNldC55ID0gKDAuNSAtIHRyYW5zLmFuY2hvclkpICogc2l6ZS5oZWlnaHQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBDaXJjbGVDb2xsaWRlcjJEKGNvbXBvbmVudDogYW55LCBub2RlOiBOb2RlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRyYW5zID0gY29tcG9uZW50LmdldENvbXBvbmVudChVSVRyYW5zZm9ybUNvbXBvbmVudCk7XHJcbiAgICAgICAgICAgIGlmICghdHJhbnMpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBzaXplID0gdHJhbnMuY29udGVudFNpemU7XHJcbiAgICAgICAgICAgIGNvbnN0IHJhZGl1cyA9IE1hdGgubWF4KHNpemUud2lkdGgsIHNpemUuaGVpZ2h0KSAvIDI7XHJcbiAgICAgICAgICAgIGlmIChyYWRpdXMgIT09IDApIHtcclxuICAgICAgICAgICAgICAgIGNvbXBvbmVudC5yYWRpdXMgPSByYWRpdXM7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG5cclxuICAgICAgICBQb2x5Z29uQ29sbGlkZXIyRChjb21wb25lbnQ6IFBvbHlnb25Db2xsaWRlcjJELCBub2RlOiBOb2RlKSB7XHJcbiAgICAgICAgICAgIC8vVE9ETzogUGh5c2ljc1V0aWxzLnJlc2V0UG9pbnRzKGNvbXBvbmVudCk7XHJcbiAgICAgICAgfSxcclxuXHJcbiAgICAgICAgQ2FtZXJhKGNvbXBvbmVudDogQ2FtZXJhLCBub2RlOiBOb2RlKSB7XHJcbiAgICAgICAgICAgIGNvbXBvbmVudC52aXNpYmlsaXR5ID0gTGF5ZXJzLm1ha2VNYXNrSW5jbHVkZShbTGF5ZXJzLkVudW0uVUlfM0QsIExheWVycy5FbnVtLlVJXzJEXSk7XHJcbiAgICAgICAgICAgIGNvbXBvbmVudC5wcm9qZWN0aW9uID0gQ2FtZXJhLlByb2plY3Rpb25UeXBlLk9SVEhPO1xyXG4gICAgICAgICAgICBjb21wb25lbnQubmVhciA9IDA7XHJcbiAgICAgICAgICAgIGNvbXBvbmVudC5jbGVhckZsYWdzID0gQ2FtZXJhLkNsZWFyRmxhZy5ERVBUSF9PTkxZO1xyXG4gICAgICAgIH0sXHJcbiAgICB9O1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5qOA5rWL5LiA5Liq5a2X56ym5Liy5piv5ZCm5piv5ZCI5rOV55qEIFVVSUTvvIjmlK/mjIEgdjEgfiB2Ne+8iVxyXG4gICAgICogQHBhcmFtIHZhbHVlIOimgeajgOa1i+eahOWtl+espuS4slxyXG4gICAgICogQHJldHVybnMg5piv5ZCm5Li6IFVVSURcclxuICAgICAqL1xyXG4gICAgaXNVVUlEKHZhbHVlOiB1bmtub3duKTogdmFsdWUgaXMgc3RyaW5nIHtcclxuICAgICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBVVUlEIOato+WImeWMuemFjSAodjEtdjUpXHJcbiAgICAgICAgY29uc3QgdXVpZFJlZyA9XHJcbiAgICAgICAgICAgIC9eWzAtOWEtZl17OH0tWzAtOWEtZl17NH0tWzEtNV1bMC05YS1mXXszfS1bODlhYl1bMC05YS1mXXszfS1bMC05YS1mXXsxMn0kL2k7XHJcblxyXG4gICAgICAgIHJldHVybiB1dWlkUmVnLnRlc3QodmFsdWUpO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBuZXcgQ29tcG9uZW50VXRpbHMoKTtcclxuIl19