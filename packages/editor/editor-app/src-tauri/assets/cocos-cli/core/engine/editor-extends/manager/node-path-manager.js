"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.NodePathManager = void 0;
class NodePathManager {
    _uuidToPath = new Map(); // UUID -> 路径
    _pathToUuid = new Map(); // 路径 -> UUID
    _nodeNames = new Map(); // 父节点UUID -> (节点名 -> 计数)
    /**
        * 清理名称中的非法字符
        */
    _sanitizeName(name) {
        // 移除或替换路径中的非法字符
        return name.replace(/[\/\\:\*\?"<>\|]/g, '_');
    }
    /**
     * 生成唯一路径
     */
    generateUniquePath(uuid, name, parentUuid) {
        if (!parentUuid) {
            return '';
        }
        const parentPath = parentUuid ? this._uuidToPath.get(parentUuid) || '' : '';
        // 清理名称中的非法路径字符
        const cleanName = this._sanitizeName(name);
        // 检查名称是否唯一，如果不唯一则添加自增后缀
        const finalName = this.ensureUniqueName(parentUuid, cleanName);
        const finalPath = parentPath ? `${parentPath}/${finalName}` : `${finalName}`;
        this.add(uuid, finalPath);
        return finalPath;
    }
    add(uuid, path) {
        this._uuidToPath.set(uuid, path);
        this._pathToUuid.set(path, uuid);
    }
    remove(uuid) {
        const path = this._uuidToPath.get(uuid);
        if (path) {
            this._pathToUuid.delete(path);
        }
        this._uuidToPath.delete(uuid);
        this._nodeNames.delete(uuid);
        const parentUuid = this._getParentUuid(path);
        if (parentUuid && this._nodeNames.has(parentUuid)) {
            const nameMap = this._nodeNames.get(parentUuid);
            const nodeName = path ? path.split('/').pop() : undefined;
            if (nodeName) {
                nameMap.delete(nodeName);
            }
        }
    }
    changeUuid(oldUuid, newUuid) {
        const path = this._uuidToPath.get(oldUuid);
        if (!path) {
            return;
        }
        this._pathToUuid.delete(path);
        this._uuidToPath.delete(oldUuid);
        this._uuidToPath.set(newUuid, path);
        this._pathToUuid.set(path, newUuid);
        if (this._nodeNames.has(oldUuid)) {
            const nameMap = this._nodeNames.get(oldUuid);
            this._nodeNames.delete(oldUuid);
            this._nodeNames.set(newUuid, nameMap);
        }
    }
    clear() {
        this._uuidToPath.clear();
        this._pathToUuid.clear();
        this._nodeNames.clear();
    }
    _getParentUuid(nodePath) {
        if (!nodePath) {
            return undefined;
        }
        const parts = nodePath.split('/');
        if (parts.length <= 1) {
            return undefined; // 已经是根节点或没有父节点
        }
        // 移除最后一个元素（当前节点），然后重新组合
        const parentPath = parts.slice(0, -1).join('/');
        const parentUuid = parentPath ? this._pathToUuid.get(parentPath) : undefined;
        return parentUuid;
    }
    /**
     * 确保节点名称在父节点下唯一
     */
    ensureUniqueName(parentUuid, baseName) {
        if (!this._nodeNames.has(parentUuid)) {
            this._nodeNames.set(parentUuid, new Map());
        }
        const nameMap = this._nodeNames.get(parentUuid);
        if (!nameMap.has(baseName)) {
            nameMap.set(baseName, 1);
            return baseName;
        }
        // 名称已存在，添加自增后缀
        let counter = nameMap.get(baseName) + 1;
        let newName = `${baseName}_${counter}`;
        // 确保新名称也不存在
        while (nameMap.has(newName)) {
            counter++;
            newName = `${baseName}_${counter}`;
        }
        nameMap.set(baseName, counter);
        nameMap.set(newName, 1);
        return newName;
    }
    getNodeUuid(path) {
        const uuid = this._pathToUuid.get(path);
        return uuid;
    }
    getNodePath(uuid) {
        return this._uuidToPath.get(uuid) || '';
    }
    updateUuid(uuid, newName, parentUuid) {
        const oldPath = this._uuidToPath.get(uuid);
        // 生成新的唯一路径
        const newPath = this.generateUniquePath(uuid, newName, parentUuid);
        // 更新路径映射
        this._uuidToPath.set(uuid, newPath);
        this._pathToUuid.delete(oldPath);
        this._pathToUuid.set(newPath, uuid);
    }
    getNameMap(uuid) {
        if (!this._nodeNames.has(uuid)) {
            return null;
        }
        return this._nodeNames.get(uuid);
    }
}
exports.NodePathManager = NodePathManager;
exports.default = new NodePathManager();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS1wYXRoLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9lbmdpbmUvZWRpdG9yLWV4dGVuZHMvbWFuYWdlci9ub2RlLXBhdGgtbWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxNQUFhLGVBQWU7SUFDaEIsV0FBVyxHQUF3QixJQUFJLEdBQUcsRUFBRSxDQUFDLENBQVUsYUFBYTtJQUNwRSxXQUFXLEdBQXdCLElBQUksR0FBRyxFQUFFLENBQUMsQ0FBVSxhQUFhO0lBQ3BFLFVBQVUsR0FBcUMsSUFBSSxHQUFHLEVBQUUsQ0FBQyxDQUFDLHlCQUF5QjtJQUUzRjs7VUFFTTtJQUNFLGFBQWEsQ0FBQyxJQUFZO1FBQzlCLGdCQUFnQjtRQUNoQixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVEOztPQUVHO0lBQ0ksa0JBQWtCLENBQUMsSUFBWSxFQUFFLElBQVksRUFBRSxVQUFtQjtRQUNyRSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDZCxPQUFPLEVBQUUsQ0FBQztRQUNkLENBQUM7UUFDRCxNQUFNLFVBQVUsR0FBRyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBRTVFLGVBQWU7UUFDZixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRTNDLHdCQUF3QjtRQUN4QixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQy9ELE1BQU0sU0FBUyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxVQUFVLElBQUksU0FBUyxFQUFFLENBQUMsQ0FBQyxD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QUMsSUFBWTtRQUNuQixJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUM3QixPQUFPLElBQUksQ0FBQztRQUNoQixDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUUsQ0FBQztJQUN0QyxDQUFDO0NBQ0o7QUF4SkQsMENBd0pDO0FBRUQsa0JBQWUsSUFBSSxlQUFlLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBjbGFzcyBOb2RlUGF0aE1hbmFnZXIge1xyXG4gICAgcHJpdmF0ZSBfdXVpZFRvUGF0aDogTWFwPHN0cmluZywgc3RyaW5nPiA9IG5ldyBNYXAoKTsgICAgICAgICAgLy8gVVVJRCAtPiDot6/lvoRcclxuICAgIHByaXZhdGUgX3BhdGhUb1V1aWQ6IE1hcDxzdHJpbmcsIHN0cmluZz4gPSBuZXcgTWFwKCk7ICAgICAgICAgIC8vIOi3r+W+hCAtPiBVVUlEXHJcbiAgICBwcml2YXRlIF9ub2RlTmFtZXM6IE1hcDxzdHJpbmcsIE1hcDxzdHJpbmcsIG51bWJlcj4+ID0gbmV3IE1hcCgpOyAvLyDniLboioLngrlVVUlEIC0+ICjoioLngrnlkI0gLT4g6K6h5pWwKVxyXG5cclxuICAgIC8qKlxyXG4gICAgICAgICog5riF55CG5ZCN56ew5Lit55qE6Z2e5rOV5a2X56ymXHJcbiAgICAgICAgKi9cclxuICAgIHByaXZhdGUgX3Nhbml0aXplTmFtZShuYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIC8vIOenu+mZpOaIluabv+aNoui3r+W+hOS4reeahOmdnuazleWtl+esplxyXG4gICAgICAgIHJldHVybiBuYW1lLnJlcGxhY2UoL1tcXC9cXFxcOlxcKlxcP1wiPD5cXHxdL2csICdfJyk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnlJ/miJDllK/kuIDot6/lvoRcclxuICAgICAqL1xyXG4gICAgcHVibGljIGdlbmVyYXRlVW5pcXVlUGF0aCh1dWlkOiBzdHJpbmcsIG5hbWU6IHN0cmluZywgcGFyZW50VXVpZD86IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICAgICAgaWYgKCFwYXJlbnRVdWlkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAnJztcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcGFyZW50UGF0aCA9IHBhcmVudFV1aWQgPyB0aGlzLl91dWlkVG9QYXRoLmdldChwYXJlbnRVdWlkKSB8fCAnJyA6ICcnO1xyXG5cclxuICAgICAgICAvLyDmuIXnkIblkI3np7DkuK3nmoTpnZ7ms5Xot6/lvoTlrZfnrKZcclxuICAgICAgICBjb25zdCBjbGVhbk5hbWUgPSB0aGlzLl9zYW5pdGl6ZU5hbWUobmFtZSk7XHJcblxyXG4gICAgICAgIC8vIOajgOafpeWQjeensOaYr+WQpuWUr+S4gO+8jOWmguaenOS4jeWUr+S4gOWImea3u+WKoOiHquWinuWQjue8gFxyXG4gICAgICAgIGNvbnN0IGZpbmFsTmFtZSA9IHRoaXMuZW5zdXJlVW5pcXVlTmFtZShwYXJlbnRVdWlkLCBjbGVhbk5hbWUpO1xyXG4gICAgICAgIGNvbnN0IGZpbmFsUGF0aCA9IHBhcmVudFBhdGggPyBgJHtwYXJlbnRQYXRofS8ke2ZpbmFsTmFtZX1gIDogYCR7ZmluYWxOYW1lfWA7XHJcblxyXG4gICAgICAgIHRoaXMuYWRkKHV1aWQsIGZpbmFsUGF0aCk7XHJcblxyXG4gICAgICAgIHJldHVybiBmaW5hbFBhdGg7XHJcbiAgICB9XHJcblxyXG4gICAgYWRkKHV1aWQ6IHN0cmluZywgcGF0aDogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5fdXVpZFRvUGF0aC5zZXQodXVpZCwgcGF0aCk7XHJcbiAgICAgICAgdGhpcy5fcGF0aFRvVXVpZC5zZXQocGF0aCwgdXVpZCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlKHV1aWQ6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IHBhdGggPSB0aGlzLl91dWlkVG9QYXRoLmdldCh1dWlkKTtcclxuICAgICAgICBpZiAocGF0aCkge1xyXG4gICAgICAgICAgICB0aGlzLl9wYXRoVG9VdWlkLmRlbGV0ZShwYXRoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5fdXVpZFRvUGF0aC5kZWxldGUodXVpZCk7XHJcbiAgICAgICAgdGhpcy5fbm9kZU5hbWVzLmRlbGV0ZSh1dWlkKTtcclxuICAgICAgICBjb25zdCBwYXJlbnRVdWlkID0gdGhpcy5fZ2V0UGFyZW50VXVpZChwYXRoKTtcclxuICAgICAgICBpZiAocGFyZW50VXVpZCAmJiB0aGlzLl9ub2RlTmFtZXMuaGFzKHBhcmVudFV1aWQpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5hbWVNYXAgPSB0aGlzLl9ub2RlTmFtZXMuZ2V0KHBhcmVudFV1aWQpITtcclxuICAgICAgICAgICAgY29uc3Qgbm9kZU5hbWUgPSBwYXRoID8gcGF0aC5zcGxpdCgnLycpLnBvcCgpIDogdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICBpZiAobm9kZU5hbWUpIHtcclxuICAgICAgICAgICAgICAgIG5hbWVNYXAuZGVsZXRlKG5vZGVOYW1lKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjaGFuZ2VVdWlkKG9sZFV1aWQ6IHN0cmluZywgbmV3VXVpZDogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuX3V1aWRUb1BhdGguZ2V0KG9sZFV1aWQpO1xyXG4gICAgICAgIGlmICghcGF0aCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX3BhdGhUb1V1aWQuZGVsZXRlKHBhdGgpO1xyXG4gICAgICAgIHRoaXMuX3V1aWRUb1BhdGguZGVsZXRlKG9sZFV1aWQpO1xyXG4gICAgICAgIHRoaXMuX3V1aWRUb1BhdGguc2V0KG5ld1V1aWQsIHBhdGgpO1xyXG4gICAgICAgIHRoaXMuX3BhdGhUb1V1aWQuc2V0KHBhdGgsIG5ld1V1aWQpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5fbm9kZU5hbWVzLmhhcyhvbGRVdWlkKSkge1xyXG4gICAgICAgICAgICBjb25zdCBuYW1lTWFwID0gdGhpcy5fbm9kZU5hbWVzLmdldChvbGRVdWlkKSE7XHJcbiAgICAgICAgICAgIHRoaXMuX25vZGVOYW1lcy5kZWxldGUob2xkVXVpZCk7XHJcbiAgICAgICAgICAgIHRoaXMuX25vZGVOYW1lcy5zZXQobmV3VXVpZCwgbmFtZU1hcCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNsZWFyKCkge1xyXG4gICAgICAgIHRoaXMuX3V1aWRUb1BhdGguY2xlYXIoKTtcclxuICAgICAgICB0aGlzLl9wYXRoVG9VdWlkLmNsZWFyKCk7XHJcbiAgICAgICAgdGhpcy5fbm9kZU5hbWVzLmNsZWFyKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfZ2V0UGFyZW50VXVpZChub2RlUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcclxuICAgICAgICBpZiAoIW5vZGVQYXRoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHBhcnRzID0gbm9kZVBhdGguc3BsaXQoJy8nKTtcclxuICAgICAgICBpZiAocGFydHMubGVuZ3RoIDw9IDEpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsgLy8g5bey57uP5piv5qC56IqC54K55oiW5rKh5pyJ54i26IqC54K5XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIOenu+mZpOacgOWQjuS4gOS4quWFg+e0oO+8iOW9k+WJjeiKgueCue+8ie+8jOeEtuWQjumHjeaWsOe7hOWQiFxyXG4gICAgICAgIGNvbnN0IHBhcmVudFBhdGggPSBwYXJ0cy5zbGljZSgwLCAtMSkuam9pbignLycpO1xyXG4gICAgICAgIGNvbnN0IHBhcmVudFV1aWQgPSBwYXJlbnRQYXRoID8gdGhpcy5fcGF0aFRvVXVpZC5nZXQocGFyZW50UGF0aCkgOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgcmV0dXJuIHBhcmVudFV1aWQ7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnoa7kv53oioLngrnlkI3np7DlnKjniLboioLngrnkuIvllK/kuIBcclxuICAgICAqL1xyXG4gICAgZW5zdXJlVW5pcXVlTmFtZShwYXJlbnRVdWlkOiBzdHJpbmcsIGJhc2VOYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIGlmICghdGhpcy5fbm9kZU5hbWVzLmhhcyhwYXJlbnRVdWlkKSkge1xyXG4gICAgICAgICAgICB0aGlzLl9ub2RlTmFtZXMuc2V0KHBhcmVudFV1aWQsIG5ldyBNYXAoKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBuYW1lTWFwID0gdGhpcy5fbm9kZU5hbWVzLmdldChwYXJlbnRVdWlkKSE7XHJcblxyXG4gICAgICAgIGlmICghbmFtZU1hcC5oYXMoYmFzZU5hbWUpKSB7XHJcbiAgICAgICAgICAgIG5hbWVNYXAuc2V0KGJhc2VOYW1lLCAxKTtcclxuICAgICAgICAgICAgcmV0dXJuIGJhc2VOYW1lO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g5ZCN56ew5bey5a2Y5Zyo77yM5re75Yqg6Ieq5aKe5ZCO57yAXHJcbiAgICAgICAgbGV0IGNvdW50ZXIgPSBuYW1lTWFwLmdldChiYXNlTmFtZSkhICsgMTtcclxuICAgICAgICBsZXQgbmV3TmFtZSA9IGAke2Jhc2VOYW1lfV8ke2NvdW50ZXJ9YDtcclxuXHJcbiAgICAgICAgLy8g56Gu5L+d5paw5ZCN56ew5Lmf5LiN5a2Y5ZyoXHJcbiAgICAgICAgd2hpbGUgKG5hbWVNYXAuaGFzKG5ld05hbWUpKSB7XHJcbiAgICAgICAgICAgIGNvdW50ZXIrKztcclxuICAgICAgICAgICAgbmV3TmFtZSA9IGAke2Jhc2VOYW1lfV8ke2NvdW50ZXJ9YDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIG5hbWVNYXAuc2V0KGJhc2VOYW1lLCBjb3VudGVyKTtcclxuICAgICAgICBuYW1lTWFwLnNldChuZXdOYW1lLCAxKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIG5ld05hbWU7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0Tm9kZVV1aWQocGF0aDogc3RyaW5nKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcclxuICAgICAgICBjb25zdCB1dWlkID0gdGhpcy5fcGF0aFRvVXVpZC5nZXQocGF0aCk7XHJcbiAgICAgICAgcmV0dXJuIHV1aWQ7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0Tm9kZVBhdGgodXVpZDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fdXVpZFRvUGF0aC5nZXQodXVpZCkgfHwgJyc7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlVXVpZCh1dWlkOiBzdHJpbmcsIG5ld05hbWU6IHN0cmluZywgcGFyZW50VXVpZD86IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IG9sZFBhdGggPSB0aGlzLl91dWlkVG9QYXRoLmdldCh1dWlkKTtcclxuICAgICAgICAvLyDnlJ/miJDmlrDnmoTllK/kuIDot6/lvoRcclxuICAgICAgICBjb25zdCBuZXdQYXRoID0gdGhpcy5nZW5lcmF0ZVVuaXF1ZVBhdGgodXVpZCwgbmV3TmFtZSwgcGFyZW50VXVpZCk7XHJcblxyXG4gICAgICAgIC8vIOabtOaWsOi3r+W+hOaYoOWwhFxyXG4gICAgICAgIHRoaXMuX3V1aWRUb1BhdGguc2V0KHV1aWQsIG5ld1BhdGgpO1xyXG4gICAgICAgIHRoaXMuX3BhdGhUb1V1aWQuZGVsZXRlKG9sZFBhdGghKTtcclxuICAgICAgICB0aGlzLl9wYXRoVG9VdWlkLnNldChuZXdQYXRoLCB1dWlkKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXROYW1lTWFwKHV1aWQ6IHN0cmluZyk6IE1hcDxzdHJpbmcsIG51bWJlcj4gfCBudWxsIHtcclxuICAgICAgICBpZiAoIXRoaXMuX25vZGVOYW1lcy5oYXModXVpZCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5fbm9kZU5hbWVzLmdldCh1dWlkKSE7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IG5ldyBOb2RlUGF0aE1hbmFnZXIoKTtcclxuIl19