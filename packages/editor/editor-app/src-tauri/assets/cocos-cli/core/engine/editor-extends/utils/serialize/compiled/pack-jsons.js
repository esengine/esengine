"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = packJSONs;
const cc_1 = require("cc");
// import deserializer types
var D = cc_1.deserialize.Internal;
var DataTypeID = D.DataTypeID_;
var File = D.File_;
var Refs = D.Refs_;
const types_1 = require("./types");
const builder_1 = require("./builder");
const create_class_mask_1 = __importDefault(require("./create-class-mask"));
const { EMPTY_PLACEHOLDER, CUSTOM_OBJ_DATA_CLASS, ARRAY_ITEM_VALUES, CLASS_PROP_TYPE_OFFSET, MASK_CLASS, OBJ_DATA_MASK, DICT_JSON_LAYOUT, PACKED_SECTIONS, } = cc_1.deserialize._macros;
function genArrayParser(parser) {
    return (data, value, classNodes) => {
        for (let i = 0; i < value.length; ++i) {
            parser(data, value[i], classNodes);
        }
    };
}
function parseArray(data, value, classNodes) {
    const array = value[ARRAY_ITEM_VALUES];
    for (let i = 0; i < array.length; ++i) {
        const type = value[i + 1];
        const op = PARSERS[type];
        if (op) {
            op(data, array[i], classNodes);
        }
    }
}
function parseDict(data, value, classNodes) {
    for (let i = DICT_JSON_LAYOUT + 1; i < value.length; i += 3) {
        const type = value[i + 1];
        const op = PARSERS[type];
        if (op) {
            const subValue = value[i + 2];
            op(data, subValue, classNodes);
        }
    }
}
function parseClass(data, value, classNodes) {
    const mask = data[File.SharedMasks][value[OBJ_DATA_MASK]];
    const clazz = data[File.SharedClasses][mask[MASK_CLASS]];
    const node = types_1.ClassNode.fromData(clazz, mask, value);
    classNodes.push(node);
    const classTypeOffset = clazz[CLASS_PROP_TYPE_OFFSET];
    const maskTypeOffset = mask[mask.length - 1];
    // parse advanced type
    for (let i = maskTypeOffset; i < value.length; ++i) {
        const type = clazz[mask[i] + classTypeOffset];
        const op = PARSERS[type];
        if (op) {
            op(data, value[i], classNodes);
        }
    }
}
function parseCustomClass(data, value, classNodes) {
    const ctor = data[File.SharedClasses][value[CUSTOM_OBJ_DATA_CLASS]];
    const node = types_1.CustomClassNode.fromData(ctor, value);
    classNodes.push(node);
}
const PARSERS = new Array(DataTypeID.ARRAY_LENGTH);
PARSERS.fill(null);
PARSERS[DataTypeID.Class] = parseClass;
PARSERS[DataTypeID.CustomizedClass] = parseCustomClass;
PARSERS[DataTypeID.Array] = parseArray;
PARSERS[DataTypeID.Array_Class] = genArrayParser(parseClass);
PARSERS[DataTypeID.Dict] = parseDict;
function parseInstances(data, classNodes) {
    const sharedClasses = data[File.SharedClasses];
    const instances = data[File.Instances];
    const instanceTypes = data[File.InstanceTypes];
    const instanceTypesLen = instanceTypes === EMPTY_PLACEHOLDER ? 0 : instanceTypes.length;
    const rootInfo = instances[instances.length - 1];
    let normalObjectCount = instances.length - instanceTypesLen;
    if (typeof rootInfo === 'number') {
        --normalObjectCount;
    }
    let insIndex = 0;
    for (; insIndex < normalObjectCount; ++insIndex) {
        const eachData = instances[insIndex];
        parseClass(data, eachData, classNodes);
    }
    if (instanceTypes) {
        for (let typeIndex = 0; typeIndex < instanceTypesLen; ++typeIndex, ++insIndex) {
            let type = instanceTypes[typeIndex];
            const eachData = instances[insIndex];
            if (type >= 0) {
                // class index for DataTypeID.CustomizedClass
                const classId = sharedClasses[type];
                const node = types_1.CustomClassNode.fromData(classId, [type, eachData]);
                node.instanceIndex = insIndex;
                classNodes.push(node);
                // @ts-ignore: 用于将类型更新到对应的 InstanceTypes
                instanceTypes[typeIndex] = node;
            }
            else {
                // Other
                type = ~type;
                const op = PARSERS[type];
                if (op) {
                    // @ts-ignore
                    op(data, eachData, classNodes);
                }
            }
        }
    }
}
function parseJSON(data, packedUuids, packedStrings, classNodes) {
    const sharedUuids = data[File.SharedUuids];
    const sharedStrings = data[File.SharedStrings];
    // merge uuids
    const uuidIndices = data[File.DependUuidIndices];
    for (let j = 0; j < uuidIndices.length; ++j) {
        const uuid = sharedUuids[uuidIndices[j]];
        packedUuids.traceString(uuid, uuidIndices, j);
    }
    // merge strings
    if (data[File.Refs]) {
        const refs = data[File.Refs];
        const dataLength = refs.length - 1;
        for (let i = 0; i < dataLength; i += Refs.EACH_RECORD_LENGTH) {
            const key = refs[i + Refs.KEY_OFFSET];
            if (key >= 0) {
                const str = sharedStrings[key];
                packedStrings.traceString(str, refs, i + Refs.KEY_OFFSET);
            }
        }
    }
    const dependKeys = data[File.DependKeys];
    for (let i = 0; i < dependKeys.length; ++i) {
        const key = dependKeys[i];
        if (key >= 0) {
            const str = sharedStrings[key];
            packedStrings.traceString(str, dependKeys, i);
        }
    }
    // merge classes/masks
    parseInstances(data, classNodes);
}
// 此函数会修改传入的 datas
function packJSONs(datas) {
    const packedUuids = new types_1.TraceableDict();
    const packedStrings = new types_1.TraceableDict();
    const classNodes = new Array();
    // 重建所有 dump 后的 ClassNode/CustomClassNode
    for (let i = 0; i < datas.length; ++i) {
        parseJSON(datas[i], packedUuids, packedStrings, classNodes);
    }
    // 重新生成所有 class/mask
    const { sharedClasses: packedClasses, sharedMasks: packedMasks } = (0, create_class_mask_1.default)(classNodes);
    for (let i = 0; i < datas.length; ++i) {
        const data = datas[i];
        // 更新 InstanceTypes 类型的信息
        const instanceTypes = data[File.InstanceTypes];
        if (instanceTypes) {
            for (let i = 0; i < instanceTypes.length; ++i) {
                const type = instanceTypes[i];
                if (type instanceof types_1.CustomClassNode) {
                    instanceTypes[i] = type.dumped[CUSTOM_OBJ_DATA_CLASS];
                }
            }
        }
        // 抹去原有的共享信息
        data.splice(0, 5);
    }
    // @ts-ignore
    const res = new Array(PACKED_SECTIONS + 1);
    res[File.Version] = builder_1.FORMAT_VERSION;
    res[File.SharedUuids] = (0, builder_1.reduceEmptyArray)(packedUuids.dump());
    res[File.SharedStrings] = (0, builder_1.reduceEmptyArray)(packedStrings.dump());
    res[File.SharedClasses] = packedClasses;
    res[File.SharedMasks] = (0, builder_1.reduceEmptyArray)(packedMasks);
    // @ts-ignore
    res[PACKED_SECTIONS] = datas;
    return res;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFjay1qc29ucy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL2VuZ2luZS9lZGl0b3ItZXh0ZW5kcy91dGlscy9zZXJpYWxpemUvY29tcGlsZWQvcGFjay1qc29ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQWdNQSw0QkF3Q0M7QUF4T0QsMkJBRVk7QUFFWiw0QkFBNEI7QUFDNUIsSUFBTyxDQUFDLEdBQUcsZ0JBQVcsQ0FBQyxRQUFRLENBQUM7QUFFaEMsSUFBTyxVQUFVLEdBQUcsQ0FBQyxDQUFDLFdBQVcsQ0FBQztBQU1sQyxJQUFPLElBQUksR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO0FBSXRCLElBQU8sSUFBSSxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFPdEIsbUNBQW9FO0FBQ3BFLHVDQUE2RDtBQUM3RCw0RUFBOEM7QUFFOUMsTUFBTSxFQUNGLGlCQUFpQixFQUNqQixxQkFBcUIsRUFDckIsaUJBQWlCLEVBQ2pCLHNCQUFzQixFQUN0QixVQUFVLEVBQ1YsYUFBYSxFQUNiLGdCQUFnQixFQUNoQixlQUFlLEdBQ2xCLEdBQUcsZ0JBQVcsQ0FBQyxPQUFPLENBQUM7QUFJeEIsU0FBUyxjQUFjLENBQUksTUFBd0I7SUFDL0MsT0FBTyxDQUFDLElBQWUsRUFBRSxLQUFZLEVBQUUsVUFBMkMsRUFBRSxFQUFFO1FBQ2xGLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUM7WUFDcEMsTUFBTSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDdkMsQ0FBQztJQUNMLENBQUMsQ0FBQztBQUNOLENBQUM7QUFFRCxTQUFTLFVBQVUsQ0FBQyxJQUFlLEVBQUUsS0FBaUIsRUFBRSxVQUF5QztJQUM3RixNQUFNLEtBQUssR0FBRyxL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QUksQ0FBQyxhQUFhLENBQUMsR0FBRyxJQUFBLDBCQUFnQixFQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ2pFLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsYUFBYSxDQUFDO0lBQ3hDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsSUFBQSwwQkFBZ0IsRUFBQyxXQUFXLENBQUMsQ0FBQztJQUN0RCxhQUFhO0lBQ2IsR0FBRyxDQUFDLGVBQWUsQ0FBQyxHQUFHLEtBQUssQ0FBQztJQUU3QixPQUFPLEdBQUcsQ0FBQztBQUNmLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gICAgZGVzZXJpYWxpemUsXHJcbn0gZnJvbSAnY2MnO1xyXG5cclxuLy8gaW1wb3J0IGRlc2VyaWFsaXplciB0eXBlc1xyXG5pbXBvcnQgRCA9IGRlc2VyaWFsaXplLkludGVybmFsO1xyXG50eXBlIEFueURhdGEgPSBELkFueURhdGFfO1xyXG5pbXBvcnQgRGF0YVR5cGVJRCA9IEQuRGF0YVR5cGVJRF87XHJcbnR5cGUgSUFycmF5RGF0YSA9IEQuSUFycmF5RGF0YV87XHJcbnR5cGUgSUNsYXNzID0gRC5JQ2xhc3NfO1xyXG50eXBlIElDbGFzc09iamVjdERhdGEgPSBELklDbGFzc09iamVjdERhdGFfO1xyXG50eXBlIElDdXN0b21PYmplY3REYXRhID0gRC5JQ3VzdG9tT2JqZWN0RGF0YV87XHJcbnR5cGUgSURpY3REYXRhID0gRC5JRGljdERhdGFfO1xyXG5pbXBvcnQgRmlsZSA9IEQuRmlsZV87XHJcbnR5cGUgSUZpbGVEYXRhID0gRC5JRmlsZURhdGFfO1xyXG50eXBlIElNYXNrID0gRC5JTWFza187XHJcbnR5cGUgSVBhY2tlZEZpbGVEYXRhID0gRC5JUGFja2VkRmlsZURhdGFfO1xyXG5pbXBvcnQgUmVmcyA9IEQuUmVmc187XHJcbnR5cGUgSVJlZnMgPSBELklSZWZzXztcclxudHlwZSBPdGhlck9iamVjdFR5cGVJRCA9IEQuT3RoZXJPYmplY3RUeXBlSURfO1xyXG50eXBlIFNoYXJlZFN0cmluZyA9IEQuU2hhcmVkU3RyaW5nXztcclxudHlwZSBTdHJpbmdJbmRleCA9IEQuU3RyaW5nSW5kZXhfO1xyXG50eXBlIFN0cmluZ0luZGV4Qm5vdE51bWJlciA9IEQuU3RyaW5nSW5kZXhCbm90TnVtYmVyXztcclxuXHJcbmltcG9ydCB7IENsYXNzTm9kZSwgQ3VzdG9tQ2xhc3NOb2RlLCBUcmFjZWFibGVEaWN0IH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IEZPUk1BVF9WRVJTSU9OLCByZWR1Y2VFbXB0eUFycmF5IH0gZnJvbSAnLi9idWlsZGVyJztcclxuaW1wb3J0IGR1bXBDbGFzc2VzIGZyb20gJy4vY3JlYXRlLWNsYXNzLW1hc2snO1xyXG5cclxuY29uc3Qge1xyXG4gICAgRU1QVFlfUExBQ0VIT0xERVIsXHJcbiAgICBDVVNUT01fT0JKX0RBVEFfQ0xBU1MsXHJcbiAgICBBUlJBWV9JVEVNX1ZBTFVFUyxcclxuICAgIENMQVNTX1BST1BfVFlQRV9PRkZTRVQsXHJcbiAgICBNQVNLX0NMQVNTLFxyXG4gICAgT0JKX0RBVEFfTUFTSyxcclxuICAgIERJQ1RfSlNPTl9MQVlPVVQsXHJcbiAgICBQQUNLRURfU0VDVElPTlMsXHJcbn0gPSBkZXNlcmlhbGl6ZS5fbWFjcm9zO1xyXG5cclxudHlwZSBQYXJzZUZ1bmN0aW9uPFQ+ID0gKGRhdGE6IElGaWxlRGF0YSwgdmFsdWU6IFQsIGNsYXNzTm9kZXM6IChDbGFzc05vZGV8Q3VzdG9tQ2xhc3NOb2RlKVtdKSA9PiB2b2lkO1xyXG5cclxuZnVuY3Rpb24gZ2VuQXJyYXlQYXJzZXI8VD4ocGFyc2VyOiBQYXJzZUZ1bmN0aW9uPFQ+KTogUGFyc2VGdW5jdGlvbjxUW10+IHtcclxuICAgIHJldHVybiAoZGF0YTogSUZpbGVEYXRhLCB2YWx1ZTogYW55W10sIGNsYXNzTm9kZXM6IChDbGFzc05vZGUgfCBDdXN0b21DbGFzc05vZGUpW10pID0+IHtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgIHBhcnNlcihkYXRhLCB2YWx1ZVtpXSwgY2xhc3NOb2Rlcyk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VBcnJheShkYXRhOiBJRmlsZURhdGEsIHZhbHVlOiBJQXJyYXlEYXRhLCBjbGFzc05vZGVzOiAoQ2xhc3NOb2RlfEN1c3RvbUNsYXNzTm9kZSlbXSkge1xyXG4gICAgY29uc3QgYXJyYXkgPSB2YWx1ZVtBUlJBWV9JVEVNX1ZBTFVFU10gYXMgYW55W107XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgY29uc3QgdHlwZSA9IHZhbHVlW2kgKyAxXSBhcyBEYXRhVHlwZUlEO1xyXG4gICAgICAgIGNvbnN0IG9wID0gUEFSU0VSU1t0eXBlXTtcclxuICAgICAgICBpZiAob3ApIHtcclxuICAgICAgICAgICAgb3AoZGF0YSwgYXJyYXlbaV0sIGNsYXNzTm9kZXMpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VEaWN0KGRhdGE6IElGaWxlRGF0YSwgdmFsdWU6IElEaWN0RGF0YSwgY2xhc3NOb2RlczogKENsYXNzTm9kZXxDdXN0b21DbGFzc05vZGUpW10pIHtcclxuICAgIGZvciAobGV0IGkgPSBESUNUX0pTT05fTEFZT1VUICsgMTsgaSA8IHZhbHVlLmxlbmd0aDsgaSArPSAzKSB7XHJcbiAgICAgICAgY29uc3QgdHlwZSA9IHZhbHVlW2kgKyAxXSBhcyBEYXRhVHlwZUlEO1xyXG4gICAgICAgIGNvbnN0IG9wID0gUEFSU0VSU1t0eXBlXTtcclxuICAgICAgICBpZiAob3ApIHtcclxuICAgICAgICAgICAgY29uc3Qgc3ViVmFsdWUgPSB2YWx1ZVtpICsgMl0gYXMgQW55RGF0YTtcclxuICAgICAgICAgICAgb3AoZGF0YSwgc3ViVmFsdWUsIGNsYXNzTm9kZXMpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VDbGFzcyhkYXRhOiBJRmlsZURhdGEsIHZhbHVlOiBJQ2xhc3NPYmplY3REYXRhLCBjbGFzc05vZGVzOiAoQ2xhc3NOb2RlfEN1c3RvbUNsYXNzTm9kZSlbXSkge1xyXG4gICAgY29uc3QgbWFzayA9IChkYXRhW0ZpbGUuU2hhcmVkTWFza3NdIGFzIElNYXNrW10pW3ZhbHVlW09CSl9EQVRBX01BU0tdIGFzIG51bWJlcl07XHJcbiAgICBjb25zdCBjbGF6eiA9IGRhdGFbRmlsZS5TaGFyZWRDbGFzc2VzXVttYXNrW01BU0tfQ0xBU1NdXSBhcyBJQ2xhc3M7XHJcbiAgICBjb25zdCBub2RlID0gQ2xhc3NOb2RlLmZyb21EYXRhKGNsYXp6LCBtYXNrLCB2YWx1ZSk7XHJcbiAgICBjbGFzc05vZGVzLnB1c2gobm9kZSk7XHJcblxyXG4gICAgY29uc3QgY2xhc3NUeXBlT2Zmc2V0ID0gY2xhenpbQ0xBU1NfUFJPUF9UWVBFX09GRlNFVF0gYXMgbnVtYmVyO1xyXG4gICAgY29uc3QgbWFza1R5cGVPZmZzZXQgPSBtYXNrW21hc2subGVuZ3RoIC0gMV07XHJcblxyXG4gICAgLy8gcGFyc2UgYWR2YW5jZWQgdHlwZVxyXG4gICAgZm9yIChsZXQgaSA9IG1hc2tUeXBlT2Zmc2V0OyBpIDwgdmFsdWUubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICBjb25zdCB0eXBlID0gY2xhenpbbWFza1tpXSArIGNsYXNzVHlwZU9mZnNldF0gYXMgRGF0YVR5cGVJRDtcclxuICAgICAgICBjb25zdCBvcCA9IFBBUlNFUlNbdHlwZV07XHJcbiAgICAgICAgaWYgKG9wKSB7XHJcbiAgICAgICAgICAgIG9wKGRhdGEsIHZhbHVlW2ldLCBjbGFzc05vZGVzKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhcnNlQ3VzdG9tQ2xhc3MoZGF0YTogSUZpbGVEYXRhLCB2YWx1ZTogSUN1c3RvbU9iamVjdERhdGEsIGNsYXNzTm9kZXM6IChDbGFzc05vZGV8Q3VzdG9tQ2xhc3NOb2RlKVtdKSB7XHJcbiAgICBjb25zdCBjdG9yID0gZGF0YVtGaWxlLlNoYXJlZENsYXNzZXNdW3ZhbHVlW0NVU1RPTV9PQkpfREFUQV9DTEFTU11dIGFzIHN0cmluZztcclxuICAgIGNvbnN0IG5vZGUgPSBDdXN0b21DbGFzc05vZGUuZnJvbURhdGEoY3RvciwgdmFsdWUpO1xyXG4gICAgY2xhc3NOb2Rlcy5wdXNoKG5vZGUpO1xyXG59XHJcblxyXG5jb25zdCBQQVJTRVJTID0gbmV3IEFycmF5PFBhcnNlRnVuY3Rpb248YW55PiB8IG51bGw+KERhdGFUeXBlSUQuQVJSQVlfTEVOR1RIKTtcclxuUEFSU0VSUy5maWxsKG51bGwpO1xyXG5QQVJTRVJTW0RhdGFUeXBlSUQuQ2xhc3NdID0gcGFyc2VDbGFzcztcclxuUEFSU0VSU1tEYXRhVHlwZUlELkN1c3RvbWl6ZWRDbGFzc10gPSBwYXJzZUN1c3RvbUNsYXNzO1xyXG5QQVJTRVJTW0RhdGFUeXBlSUQuQXJyYXldID0gcGFyc2VBcnJheTtcclxuUEFSU0VSU1tEYXRhVHlwZUlELkFycmF5X0NsYXNzXSA9IGdlbkFycmF5UGFyc2VyKHBhcnNlQ2xhc3MpO1xyXG5QQVJTRVJTW0RhdGFUeXBlSUQuRGljdF0gPSBwYXJzZURpY3Q7XHJcblxyXG5mdW5jdGlvbiBwYXJzZUluc3RhbmNlcyhkYXRhOiBJRmlsZURhdGEsIGNsYXNzTm9kZXM6IChDbGFzc05vZGV8Q3VzdG9tQ2xhc3NOb2RlKVtdKSB7XHJcbiAgICBjb25zdCBzaGFyZWRDbGFzc2VzID0gZGF0YVtGaWxlLlNoYXJlZENsYXNzZXNdO1xyXG4gICAgY29uc3QgaW5zdGFuY2VzID0gZGF0YVtGaWxlLkluc3RhbmNlc107XHJcbiAgICBjb25zdCBpbnN0YW5jZVR5cGVzID0gZGF0YVtGaWxlLkluc3RhbmNlVHlwZXNdO1xyXG5cclxuICAgIGNvbnN0IGluc3RhbmNlVHlwZXNMZW4gPSBpbnN0YW5jZVR5cGVzID09PSBFTVBUWV9QTEFDRUhPTERFUiA/IDAgOiAoaW5zdGFuY2VUeXBlcyBhcyBhbnlbXSkubGVuZ3RoO1xyXG4gICAgY29uc3Qgcm9vdEluZm8gPSBpbnN0YW5jZXNbaW5zdGFuY2VzLmxlbmd0aCAtIDFdO1xyXG4gICAgbGV0IG5vcm1hbE9iamVjdENvdW50ID0gaW5zdGFuY2VzLmxlbmd0aCAtIGluc3RhbmNlVHlwZXNMZW47XHJcbiAgICBpZiAodHlwZW9mIHJvb3RJbmZvID09PSAnbnVtYmVyJykge1xyXG4gICAgICAgIC0tbm9ybWFsT2JqZWN0Q291bnQ7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGluc0luZGV4ID0gMDtcclxuICAgIGZvciAoOyBpbnNJbmRleCA8IG5vcm1hbE9iamVjdENvdW50OyArK2luc0luZGV4KSB7XHJcbiAgICAgICAgY29uc3QgZWFjaERhdGEgPSBpbnN0YW5jZXNbaW5zSW5kZXhdIGFzIElDbGFzc09iamVjdERhdGE7XHJcbiAgICAgICAgcGFyc2VDbGFzcyhkYXRhLCBlYWNoRGF0YSwgY2xhc3NOb2Rlcyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGluc3RhbmNlVHlwZXMpIHtcclxuICAgICAgICBmb3IgKGxldCB0eXBlSW5kZXggPSAwOyB0eXBlSW5kZXggPCBpbnN0YW5jZVR5cGVzTGVuOyArK3R5cGVJbmRleCwgKytpbnNJbmRleCkge1xyXG4gICAgICAgICAgICBsZXQgdHlwZSA9IGluc3RhbmNlVHlwZXNbdHlwZUluZGV4XSBhcyBPdGhlck9iamVjdFR5cGVJRDtcclxuICAgICAgICAgICAgY29uc3QgZWFjaERhdGEgPSBpbnN0YW5jZXNbaW5zSW5kZXhdO1xyXG4gICAgICAgICAgICBpZiAodHlwZSA+PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBjbGFzcyBpbmRleCBmb3IgRGF0YVR5cGVJRC5DdXN0b21pemVkQ2xhc3NcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNsYXNzSWQgPSBzaGFyZWRDbGFzc2VzW3R5cGVdIGFzIHN0cmluZztcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5vZGUgPSBDdXN0b21DbGFzc05vZGUuZnJvbURhdGEoY2xhc3NJZCwgW3R5cGUsIGVhY2hEYXRhXSk7XHJcbiAgICAgICAgICAgICAgICBub2RlLmluc3RhbmNlSW5kZXggPSBpbnNJbmRleDtcclxuICAgICAgICAgICAgICAgIGNsYXNzTm9kZXMucHVzaChub2RlKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlOiDnlKjkuo7lsIbnsbvlnovmm7TmlrDliLDlr7nlupTnmoQgSW5zdGFuY2VUeXBlc1xyXG4gICAgICAgICAgICAgICAgaW5zdGFuY2VUeXBlc1t0eXBlSW5kZXhdID0gbm9kZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vIE90aGVyXHJcbiAgICAgICAgICAgICAgICB0eXBlID0gfnR5cGU7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBvcCA9IFBBUlNFUlNbdHlwZV07XHJcbiAgICAgICAgICAgICAgICBpZiAob3ApIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICAgICAgb3AoZGF0YSwgZWFjaERhdGEsIGNsYXNzTm9kZXMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZUpTT04oZGF0YTogSUZpbGVEYXRhLFxyXG4gICAgcGFja2VkVXVpZHM6IFRyYWNlYWJsZURpY3Q8U2hhcmVkU3RyaW5nPiwgcGFja2VkU3RyaW5nczogVHJhY2VhYmxlRGljdDxTaGFyZWRTdHJpbmc+LFxyXG4gICAgY2xhc3NOb2RlczogKENsYXNzTm9kZXxDdXN0b21DbGFzc05vZGUpW11cclxuKSB7XHJcbiAgICBjb25zdCBzaGFyZWRVdWlkcyA9IGRhdGFbRmlsZS5TaGFyZWRVdWlkc107XHJcbiAgICBjb25zdCBzaGFyZWRTdHJpbmdzID0gZGF0YVtGaWxlLlNoYXJlZFN0cmluZ3NdO1xyXG5cclxuICAgIC8vIG1lcmdlIHV1aWRzXHJcblxyXG4gICAgY29uc3QgdXVpZEluZGljZXMgPSBkYXRhW0ZpbGUuRGVwZW5kVXVpZEluZGljZXNdO1xyXG4gICAgZm9yIChsZXQgaiA9IDA7IGogPCB1dWlkSW5kaWNlcy5sZW5ndGg7ICsraikge1xyXG4gICAgICAgIGNvbnN0IHV1aWQgPSAoc2hhcmVkVXVpZHMgYXMgU2hhcmVkU3RyaW5nW10pW3V1aWRJbmRpY2VzW2pdIGFzIFN0cmluZ0luZGV4XTtcclxuICAgICAgICBwYWNrZWRVdWlkcy50cmFjZVN0cmluZyh1dWlkLCB1dWlkSW5kaWNlcywgaik7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gbWVyZ2Ugc3RyaW5nc1xyXG5cclxuICAgIGlmIChkYXRhW0ZpbGUuUmVmc10pIHtcclxuICAgICAgICBjb25zdCByZWZzID0gZGF0YVtGaWxlLlJlZnNdIGFzIElSZWZzO1xyXG4gICAgICAgIGNvbnN0IGRhdGFMZW5ndGggPSByZWZzLmxlbmd0aCAtIDE7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhTGVuZ3RoOyBpICs9IFJlZnMuRUFDSF9SRUNPUkRfTEVOR1RIKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGtleSA9IHJlZnNbaSArIFJlZnMuS0VZX09GRlNFVF0gYXMgU3RyaW5nSW5kZXhCbm90TnVtYmVyO1xyXG4gICAgICAgICAgICBpZiAoa2V5ID49IDApIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHN0ciA9IChzaGFyZWRTdHJpbmdzIGFzIFNoYXJlZFN0cmluZ1tdKVtrZXldO1xyXG4gICAgICAgICAgICAgICAgcGFja2VkU3RyaW5ncy50cmFjZVN0cmluZyhzdHIsIHJlZnMsIGkgKyBSZWZzLktFWV9PRkZTRVQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgY29uc3QgZGVwZW5kS2V5cyA9IGRhdGFbRmlsZS5EZXBlbmRLZXlzXTtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGVwZW5kS2V5cy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgIGNvbnN0IGtleSA9IGRlcGVuZEtleXNbaV0gYXMgbnVtYmVyO1xyXG4gICAgICAgIGlmIChrZXkgPj0gMCkge1xyXG4gICAgICAgICAgICBjb25zdCBzdHIgPSAoc2hhcmVkU3RyaW5ncyBhcyBTaGFyZWRTdHJpbmdbXSlba2V5XTtcclxuICAgICAgICAgICAgcGFja2VkU3RyaW5ncy50cmFjZVN0cmluZyhzdHIsIGRlcGVuZEtleXMsIGkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBtZXJnZSBjbGFzc2VzL21hc2tzXHJcblxyXG4gICAgcGFyc2VJbnN0YW5jZXMoZGF0YSwgY2xhc3NOb2Rlcyk7XHJcbn1cclxuXHJcbi8vIOatpOWHveaVsOS8muS/ruaUueS8oOWFpeeahCBkYXRhc1xyXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBwYWNrSlNPTnMoZGF0YXM6IElGaWxlRGF0YVtdKTogSVBhY2tlZEZpbGVEYXRhIHtcclxuICAgIGNvbnN0IHBhY2tlZFV1aWRzID0gbmV3IFRyYWNlYWJsZURpY3Q8U2hhcmVkU3RyaW5nPigpO1xyXG4gICAgY29uc3QgcGFja2VkU3RyaW5ncyA9IG5ldyBUcmFjZWFibGVEaWN0PFNoYXJlZFN0cmluZz4oKTtcclxuICAgIGNvbnN0IGNsYXNzTm9kZXMgPSBuZXcgQXJyYXk8Q2xhc3NOb2RlfEN1c3RvbUNsYXNzTm9kZT4oKTtcclxuXHJcbiAgICAvLyDph43lu7rmiYDmnIkgZHVtcCDlkI7nmoQgQ2xhc3NOb2RlL0N1c3RvbUNsYXNzTm9kZVxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgIHBhcnNlSlNPTihkYXRhc1tpXSwgcGFja2VkVXVpZHMsIHBhY2tlZFN0cmluZ3MsIGNsYXNzTm9kZXMpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOmHjeaWsOeUn+aIkOaJgOaciSBjbGFzcy9tYXNrXHJcbiAgICBjb25zdCB7IHNoYXJlZENsYXNzZXM6IHBhY2tlZENsYXNzZXMsIHNoYXJlZE1hc2tzOiBwYWNrZWRNYXNrcyB9ID0gZHVtcENsYXNzZXMoY2xhc3NOb2Rlcyk7XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgIGNvbnN0IGRhdGEgPSBkYXRhc1tpXTtcclxuICAgICAgICAvLyDmm7TmlrAgSW5zdGFuY2VUeXBlcyDnsbvlnovnmoTkv6Hmga9cclxuICAgICAgICBjb25zdCBpbnN0YW5jZVR5cGVzID0gZGF0YVtGaWxlLkluc3RhbmNlVHlwZXNdO1xyXG4gICAgICAgIGlmIChpbnN0YW5jZVR5cGVzKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5zdGFuY2VUeXBlcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdHlwZSA9IGluc3RhbmNlVHlwZXNbaV0gYXMgYW55O1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGUgaW5zdGFuY2VvZiBDdXN0b21DbGFzc05vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZVR5cGVzW2ldID0gKHR5cGUuZHVtcGVkIGFzIElDdXN0b21PYmplY3REYXRhKVtDVVNUT01fT0JKX0RBVEFfQ0xBU1NdO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOaKueWOu+WOn+acieeahOWFseS6q+S/oeaBr1xyXG4gICAgICAgIGRhdGEuc3BsaWNlKDAsIDUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEB0cy1pZ25vcmVcclxuICAgIGNvbnN0IHJlczogSVBhY2tlZEZpbGVEYXRhID0gbmV3IEFycmF5PGFueT4oUEFDS0VEX1NFQ1RJT05TICsgMSk7XHJcbiAgICByZXNbRmlsZS5WZXJzaW9uXSA9IEZPUk1BVF9WRVJTSU9OO1xyXG4gICAgcmVzW0ZpbGUuU2hhcmVkVXVpZHNdID0gcmVkdWNlRW1wdHlBcnJheShwYWNrZWRVdWlkcy5kdW1wKCkpO1xyXG4gICAgcmVzW0ZpbGUuU2hhcmVkU3RyaW5nc10gPSByZWR1Y2VFbXB0eUFycmF5KHBhY2tlZFN0cmluZ3MuZHVtcCgpKTtcclxuICAgIHJlc1tGaWxlLlNoYXJlZENsYXNzZXNdID0gcGFja2VkQ2xhc3NlcztcclxuICAgIHJlc1tGaWxlLlNoYXJlZE1hc2tzXSA9IHJlZHVjZUVtcHR5QXJyYXkocGFja2VkTWFza3MpO1xyXG4gICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgcmVzW1BBQ0tFRF9TRUNUSU9OU10gPSBkYXRhcztcclxuXHJcbiAgICByZXR1cm4gcmVzO1xyXG59XHJcbiJdfQ==