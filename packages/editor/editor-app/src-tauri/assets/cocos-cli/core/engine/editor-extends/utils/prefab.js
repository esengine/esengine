"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.walkNode = walkNode;
exports.visitObjTypeReferences = visitObjTypeReferences;
exports.addPrefabInfo = addPrefabInfo;
exports.checkAndStripNode = checkAndStripNode;
exports.addPrefabInstance = addPrefabInstance;
const cc_1 = require("cc");
const utils_1 = __importDefault(require("../../../base/utils"));
const CompPrefabInfo = cc_1.Prefab._utils.CompPrefabInfo;
const PrefabInfo = cc_1.Prefab._utils.PrefabInfo;
const PrefabInstance = cc_1.Prefab._utils.PrefabInstance;
const DontClearIDComponentNames = ['TerrainRenderable'];
/**
 * 递归循环所有的子节点，执行 handle 方法
 * @param {*} node
 * @param {*} handle
 */
function walkNode(node, handle, isChild = false) {
    const skipChildren = handle(node, !!isChild);
    if (skipChildren) {
        return;
    }
    const children = node.children;
    for (let i = children.length - 1; i >= 0; --i) {
        walkNode(children[i], handle, true);
    }
}
// 遍历节点下的所有可序列化字段(不含子节点)
// 只会遍历非空的 object 类型
function visitObjTypeReferences(node, visitor) {
    const parseFireClass = (obj, klass) => {
        klass = klass || obj.constructor;
        const props = klass.__values__;
        for (let p = 0; p < props.length; p++) {
            const key = props[p];
            const value = obj[key];
            if (value && typeof value === 'object') {
                if (Array.isArray(value)) {
                    for (let i = 0; i < value.length; i++) {
                        if (cc.isValid(value)) {
                            visitor(value, '' + i, value[i]);
                        }
                    }
                }
                else if (cc.isValid(value)) {
                    visitor(obj, key, value);
                }
            }
        }
    };
    for (let c = 0; c < node.components.length; ++c) {
        const component = node.components[c];
        parseFireClass(component);
    }
}
function initNodePrefabInfo(node, rootNode, asset) {
    // @ts-ignore private member access
    if (!node._prefab) {
        // @ts-ignore private member access
        node._prefab = new PrefabInfo();
    }
    // @ts-ignore private member access
    const prefabInfo = node._prefab;
    if (!prefabInfo) {
        return null;
    }
    prefabInfo.root = rootNode;
    prefabInfo.asset = asset;
    return prefabInfo;
}
function isPrefabRoot(node) {
    // @ts-ignore
    return !!(node._prefab && node._prefab.instance);
}
function addPrefabInfo(targetNode, rootNode, asset, opts = {}) {
    if (!rootNode) {
        console.error('addPrefabInfo without a rootNode');
        return;
    }
    walkNode(targetNode, (node, isChild) => {
        if (!node) {
            return;
        }
        // 私有节点不需要添加 prefabInfo 数据
        if (node.objFlags & cc.Object.Flags.HideInHierarchy) {
            return;
        }
        const isNestedPrefab = isChild && isPrefabRoot(node);
        // @ts-ignore
        let prefabInfo = node._prefab;
        if (prefabInfo) {
            if (!isNestedPrefab) {
                prefabInfo.asset = asset;
                prefabInfo.root = rootNode;
            }
            // @ts-ignore
            const rootPrefabInfo = rootNode._prefab;
            if (rootPrefabInfo && prefabInfo.instance) {
                prefabInfo.instance.prefabRootNode = rootNode;
            }
        }
        else {
            prefabInfo = initNodePrefabInfo(node, rootNode, asset);
        }
        if (!prefabInfo) {
            return;
        }
        if (opts.nodeFileIdGenerator) {
            prefabInfo.fileId = opts.nodeFileIdGenerator(node);
        }
        else {
            prefabInfo.fileId = prefabInfo.fileId ? prefabInfo.fileId : node.uuid;
        }
        // 组件也添加 __prefab fileId 属性，以便复用
        if (node.components && node.components.length) {
            for (let i = 0; i < node.components.length; i++) {
                const comp = node.components[i];
                if (!comp.__prefab) {
                    comp.__prefab = new CompPrefabInfo();
                }
                if (!comp.__prefab) {
                    continue;
                }
                if (opts.compFileIdGenerator) {
                    comp.__prefab.fileId = opts.compFileIdGenerator(comp, i);
                }
                else {
                    comp.__prefab.fileId = comp.__prefab.fileId ? comp.__prefab.fileId : comp.uuid;
                }
            }
        }
        if (isNestedPrefab) {
            return true;
        }
    });
}
// 清理后需要返回的数据，用于还原
function checkAndStripNode(node, quiet = undefined) {
    const clearedReference = {};
    walkNode(node, function (item) {
        if (item.objFlags & cc.Object.Flags.HideInHierarchy) {
            // 私有Node不参与序列化
            // 友情备注：编辑器小窗预览等用到的节点
            // hack 处理PrivatePreview的节点，后面大版本删除它
            // @ts-ignore
            if (item.isPrivatePreview) {
                return;
            }
            // 目前RichText的PrivateNode会被序列化，所以这里需要处理剃除id的逻辑
            // TerrainRenderable清掉会导致销毁报错
            // @ts-ignore
            item._id = '';
            for (let c = 0; c < item.components.length; ++c) {
                const component = item.components[c];
                if (DontClearIDComponentNames.includes(cc_1.js.getClassName(component))) {
                    continue;
                }
                component._id = '';
            }
            return;
        }
        // strip other node or components references
        visitObjTypeReferences(item, function (obj, key, val) {
            let shouldStrip = false;
            if (val instanceof cc.Component.EventHandler) {
                val = val.target;
            }
            else if (val instanceof cc.Component) {
                val = val.node;
            }
            if (val && val instanceof cc.Node && !val.isChildOf(node)) {
                shouldStrip = true;
            }
            if (shouldStrip) {
                if (obj[key] instanceof cc.Component.EventHandler) {
                    obj[key] = new cc.Component.EventHandler();
                }
                else {
                    // @ts-ignore
                    if (item._prefab?.fileId && obj.__prefab?.fileId) {
                        // @ts-ignore
                        clearedReference[item._prefab.fileId] = {
                            path: key,
                            component: obj.__prefab.fileId,
                            value: obj[key],
                        };
                    }
                    obj[key] = null;
                }
                if (!quiet) {
                    console.warn('Reference "%s" of "%s" to external scene object "%s" can not be saved in prefab asset.', key, obj.name || node.name, val.name);
                }
            }
        });
        // 清空 prefab 中的 uuid，这些 uuid 不会被用到，不应该保存到 prefab 资源中，以免每次保存资源都发生改变。
        // @ts-ignore
        item._id = '';
        for (let c = 0; c < item.components.length; ++c) {
            const component = item.components[c];
            component._id = '';
        }
    });
    return clearedReference;
}
function addPrefabInstance(node) {
    // @ts-ignore
    const prefabInfo = node._prefab;
    if (prefabInfo && !prefabInfo.instance) {
        const prefabInstance = new PrefabInstance();
        prefabInstance.fileId = utils_1.default.UUID.generate();
        prefabInfo.instance = prefabInstance;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlZmFiLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvZW5naW5lL2VkaXRvci1leHRlbmRzL3V0aWxzL3ByZWZhYi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQWlCQSw0QkFVQztBQUlELHdEQXlCQztBQXlCRCxzQ0FvRUM7QUFHRCw4Q0E2RUM7QUFFRCw4Q0FRQztBQS9PRCwyQkFBa0U7QUFDbEUsZ0VBQXdDO0FBQ3hDLE1BQU0sY0FBYyxHQUFHLFdBQU0sQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDO0FBQ3BELE1BQU0sVUFBVSxHQUFHLFdBQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDO0FBQzVDLE1BQU0sY0FBYyxHQUFHLFdBQU0sQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDO0FBTXBELE1BQU0seUJBQXlCLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBRXhEOzs7O0dBSUc7QUFDSCxTQUFnQixRQUFRLENBQUMsSUFBVSxFQUFFLE1BQXNELEVBQUUsT0FBTyxHQUFHLEtBQUs7SUFDeEcsTUFBTSxZQUFZLEdBQUcsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDN0MsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUNmLE9BQU87SUFDWCxDQUFDO0lBRUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUMvQixLQUFLLElBQUksQ0FBQyxHQUFHLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUM1QyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN4QyxDQUFDO0FBQ0wsQ0FBQztBQUVELHdCQUF3QjtBQUN4QixvQkFBb0I7QUFDcEIsU0FBZ0Isc0JBQXNCLENBQUMsSUFBVSxFQUFF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LElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztZQUM5QyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3JDLFNBQVMsQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUNILE9BQU8sZ0JBQWdCLENBQUM7QUFDNUIsQ0FBQztBQUVELFNBQWdCLGlCQUFpQixDQUFDLElBQVU7SUFDeEMsYUFBYTtJQUNiLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDaEMsSUFBSSxVQUFVLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDckMsTUFBTSxjQUFjLEdBQUcsSUFBSSxjQUFjLEVBQUUsQ0FBQztRQUM1QyxjQUFjLENBQUMsTUFBTSxHQUFHLGVBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDOUMsVUFBVSxDQUFDLFFBQVEsR0FBRyxjQUFjLENBQUM7SUFDekMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIGVkaXRvckV4dHJhc1RhZywganMsIE5vZGUsIFByZWZhYiB9IGZyb20gJ2NjJztcclxuaW1wb3J0IHV0aWxzIGZyb20gJy4uLy4uLy4uL2Jhc2UvdXRpbHMnO1xyXG5jb25zdCBDb21wUHJlZmFiSW5mbyA9IFByZWZhYi5fdXRpbHMuQ29tcFByZWZhYkluZm87XHJcbmNvbnN0IFByZWZhYkluZm8gPSBQcmVmYWIuX3V0aWxzLlByZWZhYkluZm87XHJcbmNvbnN0IFByZWZhYkluc3RhbmNlID0gUHJlZmFiLl91dGlscy5QcmVmYWJJbnN0YW5jZTtcclxuaW50ZXJmYWNlIElBZGRQcmVmYWJJbmZvT3B0aW9uIHtcclxuICAgIG5vZGVGaWxlSWRHZW5lcmF0b3I/OiAobm9kZTogTm9kZSkgPT4gc3RyaW5nOyAvLyDnlKjkuo7nlJ/miJDoioLngrlQcmVmYWLnmoRGaWxlSWTnmoTmlrnms5VcclxuICAgIGNvbXBGaWxlSWRHZW5lcmF0b3I/OiAoY29tcDogQ29tcG9uZW50LCBpbmRleDogbnVtYmVyKSA9PiBzdHJpbmc7IC8vIOeUqOS6jueUn+aIkGNvbXBvbmVudOeahEZpbGVJZOeahOaWueazlVxyXG59XHJcblxyXG5jb25zdCBEb250Q2xlYXJJRENvbXBvbmVudE5hbWVzID0gWydUZXJyYWluUmVuZGVyYWJsZSddO1xyXG5cclxuLyoqXHJcbiAqIOmAkuW9kuW+queOr+aJgOacieeahOWtkOiKgueCue+8jOaJp+ihjCBoYW5kbGUg5pa55rOVXHJcbiAqIEBwYXJhbSB7Kn0gbm9kZVxyXG4gKiBAcGFyYW0geyp9IGhhbmRsZVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIHdhbGtOb2RlKG5vZGU6IE5vZGUsIGhhbmRsZTogKG5vZGU6IE5vZGUsIGlzQ2hpbGQ6IGJvb2xlYW4pID0+IGJvb2xlYW58dm9pZCwgaXNDaGlsZCA9IGZhbHNlKSB7XHJcbiAgICBjb25zdCBza2lwQ2hpbGRyZW4gPSBoYW5kbGUobm9kZSwgISFpc0NoaWxkKTtcclxuICAgIGlmIChza2lwQ2hpbGRyZW4pIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY2hpbGRyZW4gPSBub2RlLmNoaWxkcmVuO1xyXG4gICAgZm9yIChsZXQgaSA9IGNoaWxkcmVuLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7XHJcbiAgICAgICAgd2Fsa05vZGUoY2hpbGRyZW5baV0sIGhhbmRsZSwgdHJ1ZSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbi8vIOmBjeWOhuiKgueCueS4i+eahOaJgOacieWPr+W6j+WIl+WMluWtl+autSjkuI3lkKvlrZDoioLngrkpXHJcbi8vIOWPquS8mumBjeWOhumdnuepuueahCBvYmplY3Qg57G75Z6LXHJcbmV4cG9ydCBmdW5jdGlvbiB2aXNpdE9ialR5cGVSZWZlcmVuY2VzKG5vZGU6IE5vZGUsIHZpc2l0b3I6IGFueSkge1xyXG4gICAgY29uc3QgcGFyc2VGaXJlQ2xhc3MgPSAob2JqOiBhbnksIGtsYXNzPzogYW55KSA9PiB7XHJcbiAgICAgICAga2xhc3MgPSBrbGFzcyB8fCBvYmouY29uc3RydWN0b3I7XHJcbiAgICAgICAgY29uc3QgcHJvcHMgPSBrbGFzcy5fX3ZhbHVlc19fO1xyXG4gICAgICAgIGZvciAobGV0IHAgPSAwOyBwIDwgcHJvcHMubGVuZ3RoOyBwKyspIHtcclxuICAgICAgICAgICAgY29uc3Qga2V5ID0gcHJvcHNbcF07XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gb2JqW2tleV07XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYy5pc1ZhbGlkKHZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlzaXRvcih2YWx1ZSwgJycgKyBpLCB2YWx1ZVtpXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNjLmlzVmFsaWQodmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmlzaXRvcihvYmosIGtleSwgdmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBmb3IgKGxldCBjID0gMDsgYyA8IG5vZGUuY29tcG9uZW50cy5sZW5ndGg7ICsrYykge1xyXG4gICAgICAgIGNvbnN0IGNvbXBvbmVudCA9IG5vZGUuY29tcG9uZW50c1tjXTtcclxuICAgICAgICBwYXJzZUZpcmVDbGFzcyhjb21wb25lbnQpO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBpbml0Tm9kZVByZWZhYkluZm8obm9kZTogTm9kZSwgcm9vdE5vZGU6IE5vZGV8dW5kZWZpbmVkLCBhc3NldDogUHJlZmFiKSB7XHJcbiAgICAvLyBAdHMtaWdub3JlIHByaXZhdGUgbWVtYmVyIGFjY2Vzc1xyXG4gICAgaWYgKCFub2RlLl9wcmVmYWIpIHtcclxuICAgICAgICAvLyBAdHMtaWdub3JlIHByaXZhdGUgbWVtYmVyIGFjY2Vzc1xyXG4gICAgICAgIG5vZGUuX3ByZWZhYiA9IG5ldyBQcmVmYWJJbmZvKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQHRzLWlnbm9yZSBwcml2YXRlIG1lbWJlciBhY2Nlc3NcclxuICAgIGNvbnN0IHByZWZhYkluZm8gPSBub2RlLl9wcmVmYWI7XHJcbiAgICBpZiAoIXByZWZhYkluZm8pIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIHByZWZhYkluZm8ucm9vdCA9IHJvb3ROb2RlO1xyXG4gICAgcHJlZmFiSW5mby5hc3NldCA9IGFzc2V0O1xyXG5cclxuICAgIHJldHVybiBwcmVmYWJJbmZvO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc1ByZWZhYlJvb3Qobm9kZTogTm9kZSkge1xyXG4gICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgcmV0dXJuICEhKG5vZGUuX3ByZWZhYiAmJiBub2RlLl9wcmVmYWIuaW5zdGFuY2UpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gYWRkUHJlZmFiSW5mbyh0YXJnZXROb2RlOiBOb2RlLCByb290Tm9kZTogTm9kZSwgYXNzZXQ6IFByZWZhYiwgb3B0czogSUFkZFByZWZhYkluZm9PcHRpb24gPSB7fSkge1xyXG4gICAgaWYgKCFyb290Tm9kZSkge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ2FkZFByZWZhYkluZm8gd2l0aG91dCBhIHJvb3ROb2RlJyk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHdhbGtOb2RlKHRhcmdldE5vZGUsIChub2RlLCBpc0NoaWxkKSA9PiB7XHJcbiAgICAgICAgaWYgKCFub2RlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOengeacieiKgueCueS4jemcgOimgea3u+WKoCBwcmVmYWJJbmZvIOaVsOaNrlxyXG4gICAgICAgIGlmIChub2RlLm9iakZsYWdzICYgY2MuT2JqZWN0LkZsYWdzLkhpZGVJbkhpZXJhcmNoeSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBpc05lc3RlZFByZWZhYiA9IGlzQ2hpbGQgJiYgaXNQcmVmYWJSb290KG5vZGUpO1xyXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICBsZXQgcHJlZmFiSW5mbyA9IG5vZGUuX3ByZWZhYjtcclxuICAgICAgICBpZiAocHJlZmFiSW5mbykge1xyXG4gICAgICAgICAgICBpZiAoIWlzTmVzdGVkUHJlZmFiKSB7XHJcbiAgICAgICAgICAgICAgICBwcmVmYWJJbmZvLmFzc2V0ID0gYXNzZXQ7XHJcbiAgICAgICAgICAgICAgICBwcmVmYWJJbmZvLnJvb3QgPSByb290Tm9kZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICBjb25zdCByb290UHJlZmFiSW5mbyA9IHJvb3ROb2RlLl9wcmVmYWI7XHJcbiAgICAgICAgICAgIGlmIChyb290UHJlZmFiSW5mbyAmJiBwcmVmYWJJbmZvLmluc3RhbmNlKSB7XHJcbiAgICAgICAgICAgICAgICBwcmVmYWJJbmZvLmluc3RhbmNlLnByZWZhYlJvb3ROb2RlID0gcm9vdE5vZGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBwcmVmYWJJbmZvID0gaW5pdE5vZGVQcmVmYWJJbmZvKG5vZGUsIHJvb3ROb2RlLCBhc3NldCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIXByZWZhYkluZm8pIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKG9wdHMubm9kZUZpbGVJZEdlbmVyYXRvcikge1xyXG4gICAgICAgICAgICBwcmVmYWJJbmZvLmZpbGVJZCA9IG9wdHMubm9kZUZpbGVJZEdlbmVyYXRvcihub2RlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBwcmVmYWJJbmZvLmZpbGVJZCA9IHByZWZhYkluZm8uZmlsZUlkID8gcHJlZmFiSW5mby5maWxlSWQgOiBub2RlLnV1aWQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyDnu4Tku7bkuZ/mt7vliqAgX19wcmVmYWIgZmlsZUlkIOWxnuaAp++8jOS7peS+v+WkjeeUqFxyXG4gICAgICAgIGlmIChub2RlLmNvbXBvbmVudHMgJiYgbm9kZS5jb21wb25lbnRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuY29tcG9uZW50cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY29tcCA9IG5vZGUuY29tcG9uZW50c1tpXTtcclxuICAgICAgICAgICAgICAgIGlmICghY29tcC5fX3ByZWZhYikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbXAuX19wcmVmYWIgPSBuZXcgQ29tcFByZWZhYkluZm8oKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoIWNvbXAuX19wcmVmYWIpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAob3B0cy5jb21wRmlsZUlkR2VuZXJhdG9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29tcC5fX3ByZWZhYi5maWxlSWQgPSBvcHRzLmNvbXBGaWxlSWRHZW5lcmF0b3IoY29tcCwgaSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbXAuX19wcmVmYWIuZmlsZUlkID0gY29tcC5fX3ByZWZhYi5maWxlSWQgPyBjb21wLl9fcHJlZmFiLmZpbGVJZCA6IGNvbXAudXVpZDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGlzTmVzdGVkUHJlZmFiKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59XHJcblxyXG4vLyDmuIXnkIblkI7pnIDopoHov5Tlm57nmoTmlbDmja7vvIznlKjkuo7ov5jljp9cclxuZXhwb3J0IGZ1bmN0aW9uIGNoZWNrQW5kU3RyaXBOb2RlKG5vZGU6IE5vZGUsIHF1aWV0OiBib29sZWFuIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkKSB7XHJcbiAgICBjb25zdCBjbGVhcmVkUmVmZXJlbmNlOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XHJcbiAgICB3YWxrTm9kZShub2RlLCBmdW5jdGlvbihpdGVtOiBOb2RlKSB7XHJcbiAgICAgICAgaWYgKGl0ZW0ub2JqRmxhZ3MgJiBjYy5PYmplY3QuRmxhZ3MuSGlkZUluSGllcmFyY2h5KSB7XHJcbiAgICAgICAgICAgIC8vIOengeaciU5vZGXkuI3lj4LkuI7luo/liJfljJZcclxuXHJcbiAgICAgICAgICAgIC8vIOWPi+aDheWkh+azqO+8mue8lui+keWZqOWwj+eql+mihOiniOetieeUqOWIsOeahOiKgueCuVxyXG4gICAgICAgICAgICAvLyBoYWNrIOWkhOeQhlByaXZhdGVQcmV2aWV355qE6IqC54K577yM5ZCO6Z2i5aSn54mI5pys5Yig6Zmk5a6DXHJcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICAgICAgaWYgKGl0ZW0uaXNQcml2YXRlUHJldmlldykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyDnm67liY1SaWNoVGV4dOeahFByaXZhdGVOb2Rl5Lya6KKr5bqP5YiX5YyW77yM5omA5Lul6L+Z6YeM6ZyA6KaB5aSE55CG5YmD6ZmkaWTnmoTpgLvovpFcclxuICAgICAgICAgICAgLy8gVGVycmFpblJlbmRlcmFibGXmuIXmjonkvJrlr7zoh7TplIDmr4HmiqXplJlcclxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICBpdGVtLl9pZCA9ICcnO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBjID0gMDsgYyA8IGl0ZW0uY29tcG9uZW50cy5sZW5ndGg7ICsrYykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY29tcG9uZW50ID0gaXRlbS5jb21wb25lbnRzW2NdO1xyXG4gICAgICAgICAgICAgICAgaWYgKERvbnRDbGVhcklEQ29tcG9uZW50TmFtZXMuaW5jbHVkZXMoanMuZ2V0Q2xhc3NOYW1lKGNvbXBvbmVudCkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb21wb25lbnQuX2lkID0gJyc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gc3RyaXAgb3RoZXIgbm9kZSBvciBjb21wb25lbnRzIHJlZmVyZW5jZXNcclxuICAgICAgICB2aXNpdE9ialR5cGVSZWZlcmVuY2VzKGl0ZW0sIGZ1bmN0aW9uKG9iajogYW55LCBrZXk6IGFueSwgdmFsOiBhbnkpIHtcclxuICAgICAgICAgICAgbGV0IHNob3VsZFN0cmlwID0gZmFsc2U7XHJcblxyXG4gICAgICAgICAgICBpZiAodmFsIGluc3RhbmNlb2YgY2MuQ29tcG9uZW50LkV2ZW50SGFuZGxlcikge1xyXG4gICAgICAgICAgICAgICAgdmFsID0gdmFsLnRhcmdldDtcclxuICAgICAgICAgICAgfSBlbHNlIGlmICh2YWwgaW5zdGFuY2VvZiBjYy5Db21wb25lbnQpIHtcclxuICAgICAgICAgICAgICAgIHZhbCA9IHZhbC5ub2RlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAodmFsICYmIHZhbCBpbnN0YW5jZW9mIGNjLk5vZGUgJiYgIXZhbC5pc0NoaWxkT2Yobm9kZSkpIHtcclxuICAgICAgICAgICAgICAgIHNob3VsZFN0cmlwID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHNob3VsZFN0cmlwKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAob2JqW2tleV0gaW5zdGFuY2VvZiBjYy5Db21wb25lbnQuRXZlbnRIYW5kbGVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb2JqW2tleV0gPSBuZXcgY2MuQ29tcG9uZW50LkV2ZW50SGFuZGxlcigpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uX3ByZWZhYj8uZmlsZUlkICYmIG9iai5fX3ByZWZhYj8uZmlsZUlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJlZFJlZmVyZW5jZVtpdGVtLl9wcmVmYWIuZmlsZUlkXSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGg6IGtleSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudDogb2JqLl9fcHJlZmFiLmZpbGVJZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBvYmpba2V5XSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgb2JqW2tleV0gPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICghcXVpZXQpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICdSZWZlcmVuY2UgXCIlc1wiIG9mIFwiJXNcIiB0byBleHRlcm5hbCBzY2VuZSBvYmplY3QgXCIlc1wiIGNhbiBub3QgYmUgc2F2ZWQgaW4gcHJlZmFiIGFzc2V0LicsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgb2JqLm5hbWUgfHwgbm9kZS5uYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWwubmFtZSxcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIOa4heepuiBwcmVmYWIg5Lit55qEIHV1aWTvvIzov5nkupsgdXVpZCDkuI3kvJrooqvnlKjliLDvvIzkuI3lupTor6Xkv53lrZjliLAgcHJlZmFiIOi1hOa6kOS4re+8jOS7peWFjeavj+asoeS/neWtmOi1hOa6kOmDveWPkeeUn+aUueWPmOOAglxyXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICBpdGVtLl9pZCA9ICcnO1xyXG4gICAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgaXRlbS5jb21wb25lbnRzLmxlbmd0aDsgKytjKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbXBvbmVudCA9IGl0ZW0uY29tcG9uZW50c1tjXTtcclxuICAgICAgICAgICAgY29tcG9uZW50Ll9pZCA9ICcnO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGNsZWFyZWRSZWZlcmVuY2U7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBhZGRQcmVmYWJJbnN0YW5jZShub2RlOiBOb2RlKSB7XHJcbiAgICAvLyBAdHMtaWdub3JlXHJcbiAgICBjb25zdCBwcmVmYWJJbmZvID0gbm9kZS5fcHJlZmFiO1xyXG4gICAgaWYgKHByZWZhYkluZm8gJiYgIXByZWZhYkluZm8uaW5zdGFuY2UpIHtcclxuICAgICAgICBjb25zdCBwcmVmYWJJbnN0YW5jZSA9IG5ldyBQcmVmYWJJbnN0YW5jZSgpO1xyXG4gICAgICAgIHByZWZhYkluc3RhbmNlLmZpbGVJZCA9IHV0aWxzLlVVSUQuZ2VuZXJhdGUoKTtcclxuICAgICAgICBwcmVmYWJJbmZvLmluc3RhbmNlID0gcHJlZmFiSW5zdGFuY2U7XHJcbiAgICB9XHJcbn0iXX0=