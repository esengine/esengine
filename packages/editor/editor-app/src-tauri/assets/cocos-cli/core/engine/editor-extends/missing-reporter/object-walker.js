'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.ObjectWalker = exports.ObjectWalkerBehavior = void 0;
exports.walk = walk;
exports.walkProperties = walkProperties;
exports.getNextProperty = getNextProperty;
// ObjectWalkerBehavior
class ObjectWalkerBehavior {
    walk(obj, key, val) { }
    root;
    constructor(root) {
        this.root = root;
    }
    parseObject(val) {
        if (Array.isArray(val)) {
            this.forEach(val);
        }
        else {
            const klass = val.constructor;
            if (val instanceof cc.Asset || // skip Asset
                (klass !== Object && !cc.js.getClassId(val, false)) // skip non-serializable or other type objects
            ) {
                if (val !== this.root) {
                    return;
                }
            }
            const props = klass && klass.__props__;
            if (props) {
                // CCClass or fastDefine
                this.parseCCClass(val, klass, props);
            }
            else {
                this.forIn(val);
            }
        }
    }
    parseCCClass(val, klass, props) {
        const attrs = cc.Class.Attr.getClassAttrs(klass);
        for (let i = 0; i < props.length; i++) {
            const prop = props[i];
            if (attrs[prop + cc.Class.Attr.DELIMETER + 'serializable'] === false) {
                continue;
            }
            this.walk(val, prop, val[prop]);
        }
    }
    forIn(val) {
        for (const key in val) {
            if (
            // eslint-disable-next-line no-prototype-builtins
            val.hasOwnProperty(key) &&
                (key.charCodeAt(0) !== 95 || key.charCodeAt(1) !== 95) // not starts with __
            ) {
                this.walk(val, key, val[key]);
            }
        }
    }
    forEach(val) {
        for (let i = 0, len = val.length; i < len; ++i) {
            this.walk(val, '' + i, val[i]);
        }
    }
}
exports.ObjectWalkerBehavior = ObjectWalkerBehavior;
// ObjectWalker
// Traverse all objects recursively.
// Each object will be navigated only once in the value parameter in callback.
class ObjectWalker extends ObjectWalkerBehavior {
    iteratee;
    parsedObjects;
    parsedKeys;
    ignoreParent;
    ignoreSubPrefabHelper;
    walked = new Set();
    constructor(root, iteratee, options) {
        super(root);
        this.iteratee = iteratee;
        this.parsedObjects = [];
        this.parsedKeys = [];
        this.walked.add(root);
        this.ignoreParent = options && options.ignoreParent;
        this.ignoreSubPrefabHelper = options && options.ignoreSubPrefabHelper;
        if (this.ignoreParent) {
            if (this.root instanceof cc.Component) {
                this.ignoreParent = this.root.node;
            }
            else if (this.root instanceof cc.Node) {
                this.ignoreParent = this.root;
            }
            else {
                return cc.error('can only ignore parent of scene node');
            }
        }
        this.parseObject(root);
    }
    walk(obj, key, val) {
        const isObj = val && typeof val === 'object';
        if (isObj) {
            if (this.walked.has(val)) {
                return;
            }
            if (this.ignoreParent) {
                if (val instanceof cc.Node) {
                    if (!val.isChildOf(this.ignoreParent)) {
                        return;
                    }
                }
                else if (val instanceof cc.Component) {
                    if (!val.node.isChildOf(this.ignoreParent)) {
                        return;
                    }
                }
            }
            if (this.ignoreSubPrefabHelper && val instanceof cc._PrefabInfo && val.root !== obj) {
                return;
            }
            this.walked.add(val);
            this.iteratee(obj, key, val, this.parsedObjects, this.parsedKeys);
            this.parsedObjects.push(obj);
            this.parsedKeys.push(key);
            this.parseObject(val);
            this.parsedObjects.pop();
            this.parsedKeys.pop();
        }
    }
}
exports.ObjectWalker = ObjectWalker;
// FACADE
/**
 * Traverse all objects recursively
 * @param {Object} root
 * @param {Function} iteratee
 * @param {Object} iteratee.object
 * @param {String} iteratee.property
 * @param {Object} iteratee.value - per object will be navigated ONLY once in this parameter
 * @param {Object[]} iteratee.parsedObjects - parsed object path, NOT contains the "object" parameter
 */
function walk(root, iteratee) {
    new ObjectWalker(root, iteratee);
}
const staticDummyWalker = new ObjectWalkerBehavior(null);
// enumerate properties not recursively
function doWalkProperties(obj, iteratee) {
    const SKIP_INVALID_TYPES_EVEN_IF_ROOT = null;
    staticDummyWalker.root = SKIP_INVALID_TYPES_EVEN_IF_ROOT;
    staticDummyWalker.walk = iteratee;
    staticDummyWalker.parseObject(obj);
}
/**
 * Traverse all object's properties recursively
 * @param {Object}   root
 * @param {Function} iteratee
 * @param {Object}     iteratee.object
 * @param {String}     iteratee.property - per object property will be navigated ONLY once in this parameter
 * @param {Object}     iteratee.value - per object may be navigated MORE than once in this parameter
 * @param {Object[]}   iteratee.parsedObjects - parsed object path, NOT contains the "object" parameter
 * @param {Object}   [options]
 * @param {Boolean}    [options.dontSkipNull = false]
 */
function walkProperties(root, iteratee, options) {
    const dontSkipNull = options && options.dontSkipNull;
    new ObjectWalker(root, function (obj, key, value, parsedObjects) {
        // 如果 value 已经遍历过，ObjectWalker 不会枚举其余对象对 value 的引用
        // 所以这里拿到 value 后自己再枚举一次 value 内的引用
        const noPropToWalk = !value || typeof value !== 'object';
        if (noPropToWalk) {
            return;
        }
        parsedObjects.push(obj);
        doWalkProperties(value, function (obj, key, val) {
            const isObj = typeof val === 'object';
            if (isObj) {
                if (dontSkipNull || val) {
                    iteratee(obj, key, val, parsedObjects);
                }
            }
        });
        parsedObjects.pop();
    }, options);
}
function getNextProperty(parsedObjects, parsingObject, object) {
    let nextObj;
    const i = parsedObjects.lastIndexOf(object);
    if (i === parsedObjects.length - 1) {
        nextObj = parsingObject;
    }
    else if (0 <= i && i < parsedObjects.length - 1) {
        nextObj = parsedObjects[i + 1];
    }
    else {
        return '';
    }
    let foundKey = '';
    doWalkProperties(object, function (obj, key, val) {
        if (val === nextObj) {
            foundKey = key;
        }
    });
    return foundKey;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JqZWN0LXdhbGtlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL2VuZ2luZS9lZGl0b3ItZXh0ZW5kcy9taXNzaW5nLXJlcG9ydGVyL29iamVjdC13YWxrZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFvSmIsb0JBRUM7QUF1QkQsd0NBd0JDO0FBRUQsMENBaUJDO0FBdE5ELHVCQUF1QjtBQUV2QixNQUFhLG9CQUFvQjtJQUM3QixJQUFJLENBQUMsR0FBd0IsRUFBRSxHQUFXLEVBQUUsR0FBUSxJQUFJLENBQUM7SUFFekQsSUFBSSxDQUFNO0lBRVYsWUFBWSxJQUFTO1FBQ2pCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxXQUFXLENBQUMsR0FBUTtRQUNoQixJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUNyQixJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RCLENBQUM7YUFBTSxDQUFDO1lBQ0osTUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLFdBQVcsQ0FBQztZQUU5QixJQUNJLEdBQUcsWUFBWSxFQUFFLENBQUMsS0FBSyxJQUFJLGFBQWE7Z0JBQ3hDLENBQUMsS0FBSyxLQUFLLE1BQU0sSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLDhDQUE4QztjQUNwRyxDQUFDO2dCQUNDLElBQUksR0FBRyxLQUFLLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztvQkFDcEIsT0FBTztnQkFDWCxDQUFDO1lBQ0wsQ0FBQztZQUVELE1BQU0sS0FBSyxHQUFHLEtBQUssSUFBSSxLQUFLLENBQUMsU0FBUyxDQUFDO1lBQ3ZDLElBQUksS0FBSyxFQUFFLENBQUM7Z0JBQ1Isd0JBQXdCO2dCQUN4QixJQUFJ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LE9BQU8sR0FBRyxhQUFhLENBQUM7SUFDNUIsQ0FBQztTQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsYUFBYSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUNoRCxPQUFPLEdBQUcsYUFBYSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNuQyxDQUFDO1NBQU0sQ0FBQztRQUNKLE9BQU8sRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUNELElBQUksUUFBUSxHQUFHLEVBQUUsQ0FBQztJQUNsQixnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsVUFBVSxHQUFRLEVBQUUsR0FBUSxFQUFFLEdBQVE7UUFDM0QsSUFBSSxHQUFHLEtBQUssT0FBTyxFQUFFLENBQUM7WUFDbEIsUUFBUSxHQUFHLEdBQUcsQ0FBQztRQUNuQixDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDSCxPQUFPLFFBQVEsQ0FBQztBQUNwQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG5cclxuLy8gT2JqZWN0V2Fsa2VyQmVoYXZpb3JcclxuXHJcbmV4cG9ydCBjbGFzcyBPYmplY3RXYWxrZXJCZWhhdmlvciB7XHJcbiAgICB3YWxrKG9iajogUmVjb3JkPHN0cmluZywgYW55Piwga2V5OiBzdHJpbmcsIHZhbDogYW55KSB7IH1cclxuXHJcbiAgICByb290OiBhbnk7XHJcblxyXG4gICAgY29uc3RydWN0b3Iocm9vdDogYW55KSB7XHJcbiAgICAgICAgdGhpcy5yb290ID0gcm9vdDtcclxuICAgIH1cclxuXHJcbiAgICBwYXJzZU9iamVjdCh2YWw6IGFueSkge1xyXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbCkpIHtcclxuICAgICAgICAgICAgdGhpcy5mb3JFYWNoKHZhbCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3Qga2xhc3MgPSB2YWwuY29uc3RydWN0b3I7XHJcblxyXG4gICAgICAgICAgICBpZiAoXHJcbiAgICAgICAgICAgICAgICB2YWwgaW5zdGFuY2VvZiBjYy5Bc3NldCB8fCAvLyBza2lwIEFzc2V0XHJcbiAgICAgICAgICAgICAgICAoa2xhc3MgIT09IE9iamVjdCAmJiAhY2MuanMuZ2V0Q2xhc3NJZCh2YWwsIGZhbHNlKSkgLy8gc2tpcCBub24tc2VyaWFsaXphYmxlIG9yIG90aGVyIHR5cGUgb2JqZWN0c1xyXG4gICAgICAgICAgICApIHtcclxuICAgICAgICAgICAgICAgIGlmICh2YWwgIT09IHRoaXMucm9vdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgcHJvcHMgPSBrbGFzcyAmJiBrbGFzcy5fX3Byb3BzX187XHJcbiAgICAgICAgICAgIGlmIChwcm9wcykge1xyXG4gICAgICAgICAgICAgICAgLy8gQ0NDbGFzcyBvciBmYXN0RGVmaW5lXHJcbiAgICAgICAgICAgICAgICB0aGlzLnBhcnNlQ0NDbGFzcyh2YWwsIGtsYXNzLCBwcm9wcyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZvckluKHZhbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwYXJzZUNDQ2xhc3ModmFsOiBhbnksIGtsYXNzOiBhbnksIHByb3BzOiBhbnkpIHtcclxuICAgICAgICBjb25zdCBhdHRycyA9IGNjLkNsYXNzLkF0dHIuZ2V0Q2xhc3NBdHRycyhrbGFzcyk7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBjb25zdCBwcm9wID0gcHJvcHNbaV07XHJcbiAgICAgICAgICAgIGlmIChhdHRyc1twcm9wICsgY2MuQ2xhc3MuQXR0ci5ERUxJTUVURVIgKyAnc2VyaWFsaXphYmxlJ10gPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLndhbGsodmFsLCBwcm9wLCB2YWxbcHJvcF0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGZvckluKHZhbDogYW55KSB7XHJcbiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gdmFsKSB7XHJcbiAgICAgICAgICAgIGlmIChcclxuICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1wcm90b3R5cGUtYnVpbHRpbnNcclxuICAgICAgICAgICAgICAgIHZhbC5oYXNPd25Qcm9wZXJ0eShrZXkpICYmXHJcbiAgICAgICAgICAgICAgICAoa2V5LmNoYXJDb2RlQXQoMCkgIT09IDk1IHx8IGtleS5jaGFyQ29kZUF0KDEpICE9PSA5NSkgLy8gbm90IHN0YXJ0cyB3aXRoIF9fXHJcbiAgICAgICAgICAgICkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy53YWxrKHZhbCwga2V5LCB2YWxba2V5XSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBmb3JFYWNoKHZhbDogYW55KSB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHZhbC5sZW5ndGg7IGkgPCBsZW47ICsraSkge1xyXG4gICAgICAgICAgICB0aGlzLndhbGsodmFsLCAnJyArIGksIHZhbFtpXSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG4vLyBPYmplY3RXYWxrZXJcclxuXHJcbi8vIFRyYXZlcnNlIGFsbCBvYmplY3RzIHJlY3Vyc2l2ZWx5LlxyXG4vLyBFYWNoIG9iamVjdCB3aWxsIGJlIG5hdmlnYXRlZCBvbmx5IG9uY2UgaW4gdGhlIHZhbHVlIHBhcmFtZXRlciBpbiBjYWxsYmFjay5cclxuZXhwb3J0IGNsYXNzIE9iamVjdFdhbGtlciBleHRlbmRzIE9iamVjdFdhbGtlckJlaGF2aW9yIHtcclxuICAgIGl0ZXJhdGVlOiBhbnk7XHJcbiAgICBwYXJzZWRPYmplY3RzOiBhbnk7XHJcbiAgICBwYXJzZWRLZXlzOiBhbnk7XHJcbiAgICBpZ25vcmVQYXJlbnQ6IGFueTtcclxuICAgIGlnbm9yZVN1YlByZWZhYkhlbHBlcjogYW55O1xyXG5cclxuICAgIHdhbGtlZCA9IG5ldyBTZXQoKTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihyb290OiBhbnksIGl0ZXJhdGVlOiBhbnksIG9wdGlvbnM/OiBhbnkpIHtcclxuICAgICAgICBzdXBlcihyb290KTtcclxuICAgICAgICB0aGlzLml0ZXJhdGVlID0gaXRlcmF0ZWU7XHJcbiAgICAgICAgdGhpcy5wYXJzZWRPYmplY3RzID0gW107XHJcbiAgICAgICAgdGhpcy5wYXJzZWRLZXlzID0gW107XHJcblxyXG4gICAgICAgIHRoaXMud2Fsa2VkLmFkZChyb290KTtcclxuXHJcbiAgICAgICAgdGhpcy5pZ25vcmVQYXJlbnQgPSBvcHRpb25zICYmIG9wdGlvbnMuaWdub3JlUGFyZW50O1xyXG4gICAgICAgIHRoaXMuaWdub3JlU3ViUHJlZmFiSGVscGVyID0gb3B0aW9ucyAmJiBvcHRpb25zLmlnbm9yZVN1YlByZWZhYkhlbHBlcjtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaWdub3JlUGFyZW50KSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnJvb3QgaW5zdGFuY2VvZiBjYy5Db21wb25lbnQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaWdub3JlUGFyZW50ID0gdGhpcy5yb290Lm5vZGU7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5yb290IGluc3RhbmNlb2YgY2MuTm9kZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pZ25vcmVQYXJlbnQgPSB0aGlzLnJvb3Q7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gY2MuZXJyb3IoJ2NhbiBvbmx5IGlnbm9yZSBwYXJlbnQgb2Ygc2NlbmUgbm9kZScpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnBhcnNlT2JqZWN0KHJvb3QpO1xyXG4gICAgfVxyXG4gICAgd2FsayhvYmo6IGFueSwga2V5OiBhbnksIHZhbDogYW55KSB7XHJcbiAgICAgICAgY29uc3QgaXNPYmogPSB2YWwgJiYgdHlwZW9mIHZhbCA9PT0gJ29iamVjdCc7XHJcbiAgICAgICAgaWYgKGlzT2JqKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLndhbGtlZC5oYXModmFsKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlnbm9yZVBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHZhbCBpbnN0YW5jZW9mIGNjLk5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbC5pc0NoaWxkT2YodGhpcy5pZ25vcmVQYXJlbnQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZhbCBpbnN0YW5jZW9mIGNjLkNvbXBvbmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdmFsLm5vZGUuaXNDaGlsZE9mKHRoaXMuaWdub3JlUGFyZW50KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5pZ25vcmVTdWJQcmVmYWJIZWxwZXIgJiYgdmFsIGluc3RhbmNlb2YgY2MuX1ByZWZhYkluZm8gJiYgdmFsLnJvb3QgIT09IG9iaikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLndhbGtlZC5hZGQodmFsKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuaXRlcmF0ZWUob2JqLCBrZXksIHZhbCwgdGhpcy5wYXJzZWRPYmplY3RzLCB0aGlzLnBhcnNlZEtleXMpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5wYXJzZWRPYmplY3RzLnB1c2gob2JqKTtcclxuICAgICAgICAgICAgdGhpcy5wYXJzZWRLZXlzLnB1c2goa2V5KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMucGFyc2VPYmplY3QodmFsKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMucGFyc2VkT2JqZWN0cy5wb3AoKTtcclxuICAgICAgICAgICAgdGhpcy5wYXJzZWRLZXlzLnBvcCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4vLyBGQUNBREVcclxuXHJcbi8qKlxyXG4gKiBUcmF2ZXJzZSBhbGwgb2JqZWN0cyByZWN1cnNpdmVseVxyXG4gKiBAcGFyYW0ge09iamVjdH0gcm9vdFxyXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufSBpdGVyYXRlZVxyXG4gKiBAcGFyYW0ge09iamVjdH0gaXRlcmF0ZWUub2JqZWN0XHJcbiAqIEBwYXJhbSB7U3RyaW5nfSBpdGVyYXRlZS5wcm9wZXJ0eVxyXG4gKiBAcGFyYW0ge09iamVjdH0gaXRlcmF0ZWUudmFsdWUgLSBwZXIgb2JqZWN0IHdpbGwgYmUgbmF2aWdhdGVkIE9OTFkgb25jZSBpbiB0aGlzIHBhcmFtZXRlclxyXG4gKiBAcGFyYW0ge09iamVjdFtdfSBpdGVyYXRlZS5wYXJzZWRPYmplY3RzIC0gcGFyc2VkIG9iamVjdCBwYXRoLCBOT1QgY29udGFpbnMgdGhlIFwib2JqZWN0XCIgcGFyYW1ldGVyXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gd2Fsayhyb290OiBhbnksIGl0ZXJhdGVlOiBhbnkpIHtcclxuICAgIG5ldyBPYmplY3RXYWxrZXIocm9vdCwgaXRlcmF0ZWUpO1xyXG59XHJcblxyXG5jb25zdCBzdGF0aWNEdW1teVdhbGtlciA9IG5ldyBPYmplY3RXYWxrZXJCZWhhdmlvcihudWxsKTtcclxuXHJcbi8vIGVudW1lcmF0ZSBwcm9wZXJ0aWVzIG5vdCByZWN1cnNpdmVseVxyXG5mdW5jdGlvbiBkb1dhbGtQcm9wZXJ0aWVzKG9iajogYW55LCBpdGVyYXRlZTogYW55KSB7XHJcbiAgICBjb25zdCBTS0lQX0lOVkFMSURfVFlQRVNfRVZFTl9JRl9ST09UID0gbnVsbDtcclxuICAgIHN0YXRpY0R1bW15V2Fsa2VyLnJvb3QgPSBTS0lQX0lOVkFMSURfVFlQRVNfRVZFTl9JRl9ST09UO1xyXG4gICAgc3RhdGljRHVtbXlXYWxrZXIud2FsayA9IGl0ZXJhdGVlO1xyXG4gICAgc3RhdGljRHVtbXlXYWxrZXIucGFyc2VPYmplY3Qob2JqKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFRyYXZlcnNlIGFsbCBvYmplY3QncyBwcm9wZXJ0aWVzIHJlY3Vyc2l2ZWx5XHJcbiAqIEBwYXJhbSB7T2JqZWN0fSAgIHJvb3RcclxuICogQHBhcmFtIHtGdW5jdGlvbn0gaXRlcmF0ZWVcclxuICogQHBhcmFtIHtPYmplY3R9ICAgICBpdGVyYXRlZS5vYmplY3RcclxuICogQHBhcmFtIHtTdHJpbmd9ICAgICBpdGVyYXRlZS5wcm9wZXJ0eSAtIHBlciBvYmplY3QgcHJvcGVydHkgd2lsbCBiZSBuYXZpZ2F0ZWQgT05MWSBvbmNlIGluIHRoaXMgcGFyYW1ldGVyXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSAgICAgaXRlcmF0ZWUudmFsdWUgLSBwZXIgb2JqZWN0IG1heSBiZSBuYXZpZ2F0ZWQgTU9SRSB0aGFuIG9uY2UgaW4gdGhpcyBwYXJhbWV0ZXJcclxuICogQHBhcmFtIHtPYmplY3RbXX0gICBpdGVyYXRlZS5wYXJzZWRPYmplY3RzIC0gcGFyc2VkIG9iamVjdCBwYXRoLCBOT1QgY29udGFpbnMgdGhlIFwib2JqZWN0XCIgcGFyYW1ldGVyXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSAgIFtvcHRpb25zXVxyXG4gKiBAcGFyYW0ge0Jvb2xlYW59ICAgIFtvcHRpb25zLmRvbnRTa2lwTnVsbCA9IGZhbHNlXVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIHdhbGtQcm9wZXJ0aWVzKHJvb3Q6IGFueSwgaXRlcmF0ZWU6IGFueSwgb3B0aW9uczogYW55KSB7XHJcbiAgICBjb25zdCBkb250U2tpcE51bGwgPSBvcHRpb25zICYmIG9wdGlvbnMuZG9udFNraXBOdWxsO1xyXG4gICAgbmV3IE9iamVjdFdhbGtlcihcclxuICAgICAgICByb290LFxyXG4gICAgICAgIGZ1bmN0aW9uIChvYmo6IGFueSwga2V5OiBhbnksIHZhbHVlOiBhbnksIHBhcnNlZE9iamVjdHM6IGFueSkge1xyXG4gICAgICAgICAgICAvLyDlpoLmnpwgdmFsdWUg5bey57uP6YGN5Y6G6L+H77yMT2JqZWN0V2Fsa2VyIOS4jeS8muaemuS4vuWFtuS9meWvueixoeWvuSB2YWx1ZSDnmoTlvJXnlKhcclxuICAgICAgICAgICAgLy8g5omA5Lul6L+Z6YeM5ou/5YiwIHZhbHVlIOWQjuiHquW3seWGjeaemuS4vuS4gOasoSB2YWx1ZSDlhoXnmoTlvJXnlKhcclxuICAgICAgICAgICAgY29uc3Qgbm9Qcm9wVG9XYWxrID0gIXZhbHVlIHx8IHR5cGVvZiB2YWx1ZSAhPT0gJ29iamVjdCc7XHJcbiAgICAgICAgICAgIGlmIChub1Byb3BUb1dhbGspIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBwYXJzZWRPYmplY3RzLnB1c2gob2JqKTtcclxuICAgICAgICAgICAgZG9XYWxrUHJvcGVydGllcyh2YWx1ZSwgZnVuY3Rpb24gKG9iajogYW55LCBrZXk6IGFueSwgdmFsOiBhbnkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGlzT2JqID0gdHlwZW9mIHZhbCA9PT0gJ29iamVjdCc7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXNPYmopIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZG9udFNraXBOdWxsIHx8IHZhbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVyYXRlZShvYmosIGtleSwgdmFsLCBwYXJzZWRPYmplY3RzKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBwYXJzZWRPYmplY3RzLnBvcCgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgb3B0aW9ucyxcclxuICAgICk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXROZXh0UHJvcGVydHkocGFyc2VkT2JqZWN0czogYW55LCBwYXJzaW5nT2JqZWN0OiBhbnksIG9iamVjdDogYW55KSB7XHJcbiAgICBsZXQgbmV4dE9iajogYW55O1xyXG4gICAgY29uc3QgaSA9IHBhcnNlZE9iamVjdHMubGFzdEluZGV4T2Yob2JqZWN0KTtcclxuICAgIGlmIChpID09PSBwYXJzZWRPYmplY3RzLmxlbmd0aCAtIDEpIHtcclxuICAgICAgICBuZXh0T2JqID0gcGFyc2luZ09iamVjdDtcclxuICAgIH0gZWxzZSBpZiAoMCA8PSBpICYmIGkgPCBwYXJzZWRPYmplY3RzLmxlbmd0aCAtIDEpIHtcclxuICAgICAgICBuZXh0T2JqID0gcGFyc2VkT2JqZWN0c1tpICsgMV07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICAgIGxldCBmb3VuZEtleSA9ICcnO1xyXG4gICAgZG9XYWxrUHJvcGVydGllcyhvYmplY3QsIGZ1bmN0aW9uIChvYmo6IGFueSwga2V5OiBhbnksIHZhbDogYW55KSB7XHJcbiAgICAgICAgaWYgKHZhbCA9PT0gbmV4dE9iaikge1xyXG4gICAgICAgICAgICBmb3VuZEtleSA9IGtleTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBmb3VuZEtleTtcclxufVxyXG4iXX0=