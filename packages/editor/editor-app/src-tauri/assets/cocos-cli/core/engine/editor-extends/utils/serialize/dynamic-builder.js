"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.asAsset = asAsset;
exports.setName = setName;
exports.findRootObject = findRootObject;
exports.assert = assert;
const cc_1 = require("cc");
const base_builder_1 = require("./base-builder");
class DynamicBuilder extends base_builder_1.Builder {
    forceInline;
    // list of serialized data
    serializedList = [];
    constructor(options) {
        super(options);
        this.forceInline = !!options.forceInline;
    }
    setProperty_Array(owner, ownerInfo, key, options) {
        return this.addObject(options.writeOnlyArray, ownerInfo, key, options.formerlySerializedAs, false);
    }
    setProperty_Dict(owner, ownerInfo, key, options) {
        return this.addObject({}, ownerInfo, key, options?.formerlySerializedAs, false);
    }
    addObject(data, ownerInfo, key, formerlySerializedAs, forceIndexed) {
        let id = -1;
        let refData = data;
        const isRoot = !ownerInfo;
        if ((!this.forceInline && forceIndexed) || isRoot) {
            id = this.serializedList.length;
            this.serializedList.push(data);
            if (!this.forceInline) {
                refData = { __id__: id };
            }
        }
        if (ownerInfo) {
            ownerInfo.data[key] = refData;
            if (formerlySerializedAs) {
                ownerInfo.data[formerlySerializedAs] = refData;
            }
        }
        return { data, id };
    }
    setProperty_Class(owner, ownerInfo, key, options) {
        const data = {
            __type__: options.type,
        };
        return this.addObject(data, ownerInfo, key, options.formerlySerializedAs, !(options.uniquelyReferenced ?? false));
    }
    setProperty_CustomizedClass(owner, ownerInfo, key, options) {
        const data = {
            __type__: options.type,
            content: options.content,
        };
        return this.addObject(data, ownerInfo, key, options.formerlySerializedAs, true);
    }
    // parsed
    setProperty_ParsedObject(ownerInfo, key, valueInfo, formerlySerializedAs) {
        if (!this.forceInline && valueInfo.id >= 0) {
            // 可索引对象
            ownerInfo.data[key] = { __id__: valueInfo.id };
        }
        else {
            // 不可索引对象，直接内联数据
            ownerInfo.data[key] = valueInfo.data;
        }
        if (formerlySerializedAs) {
            ownerInfo.data[formerlySerializedAs] = ownerInfo.data[key];
        }
    }
    // Static Values
    setProperty_Raw(owner, ownerInfo, key, value, options) {
        ownerInfo.data[key] = value;
        if (options?.formerlySerializedAs) {
            ownerInfo.data[options.formerlySerializedAs] = value;
        }
    }
    setProperty_ValueType(owner, ownerInfo, key, value, options) {
        const data = {
            __type__: cc_1.js.getClassId(value, false),
        };
        const props = value.constructor.__values__;
        if (props) {
            for (let p = 0; p < props.length; p++) {
                const propName = props[p];
                data[propName] = value[propName];
            }
        }
        if (ownerInfo) {
            ownerInfo.data[key] = data;
            if (options?.formerlySerializedAs) {
                ownerInfo.data[options.formerlySerializedAs] = data;
            }
            return { data, id: -1 };
        }
        else {
            this.serializedList.push(data);
            return { data, id: 0 };
        }
    }
    setProperty_TypedArray(owner, ownerInfo, key, value, options) {
        let data;
        if (this.hasBinaryBuffer) {
            const isDataView = value instanceof DataView;
            if (!isDataView) {
                this.mainBufferBuilder.alignAs(value.constructor.BYTES_PER_ELEMENT);
            }
            const offset = this.mainBufferBuilder.append(value);
            data = {
                __type__: 'TypedArrayRef',
                ctor: value.constructor.name,
                offset,
                length: isDataView ? value.byteLength : value.length,
            };
        }
        else {
            data = {
                __type__: 'TypedArray',
                ctor: value.constructor.name,
                array: Array.from(value),
            };
        }
        if (ownerInfo) {
            ownerInfo.data[key] = data;
            if (options?.formerlySerializedAs) {
                ownerInfo.data[options.formerlySerializedAs] = data;
            }
        }
        else {
            this.serializedList.push(data);
        }
    }
    setProperty_AssetUuid(owner, ownerInfo, key, uuid, options) {
        ownerInfo.data[key] = { __uuid__: uuid };
        if (options?.formerlySerializedAs) {
            ownerInfo.data[options.formerlySerializedAs] = ownerInfo.data[key];
        }
        if (options?.expectedType) {
            ownerInfo.data[key].__expectedType__ = options.expectedType;
        }
    }
    setRoot(objInfo) {
        assert(objInfo.id === 0, `Wrong root object to serialize, id is ${objInfo.id}`);
    }
    finalizeJsonPart() {
        const serializedList = this.serializedList;
        let serializedData;
        if (serializedList.length === 1 && !Array.isArray(serializedList[0])) {
            serializedData = serializedList[0];
        }
        else {
            serializedData = serializedList;
        }
        return serializedData;
    }
}
exports.default = DynamicBuilder;
/**
 * Create a pseudo object which will be force serialized as a reference to any asset by specified uuid.
 */
function asAsset(uuid, type = cc_1.Asset) {
    if (!uuid) {
        (0, cc_1.error)('[EditorExtends.serialize.asAsset] The uuid must be non-nil!');
        return null;
    }
    const pseudoAsset = new type();
    pseudoAsset._uuid = uuid;
    return pseudoAsset;
}
/**
 * Set the asset's name directly in JSON object
 */
function setName(data, name) {
    if (Array.isArray(data)) {
        data[0]._name = name;
    }
    else {
        data._name = name;
    }
}
function findRootObject(data, type) {
    if (Array.isArray(data)) {
        for (let i = 0; i < data.length; i++) {
            const obj = data[i];
            if (obj.__type__ === type) {
                return obj;
            }
        }
    }
    else if (data.__type__ === type) {
        return data;
    }
    return null;
}
function assert(condition, message) {
    if (!condition) {
        throw new Error(message || 'Assertion failed');
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvZW5naW5lL2VkaXRvci1leHRlbmRzL3V0aWxzL3NlcmlhbGl6ZS9keW5hbWljLWJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFrT0EsMEJBUUM7QUFLRCwwQkFNQztBQUVELHdDQWFDO0FBRUQsd0JBSUM7QUExUUQsMkJBT1k7QUFZWixpREFBMEQ7QUF5QzFELE1BQXFCLGNBQWUsU0FBUSxzQkFBTztJQUMvQyxXQUFXLENBQVU7SUFFckIsMEJBQTBCO0lBQ2xCLGNBQWMsR0FBVSxFQUFFLENBQUM7SUFFbkMsWUFBWSxPQUF3QjtRQUNoQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDZixJQUFJLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDO0lBQzdDLENBQUM7SUFFRCxpQkFBaUIsQ0FBQyxLQUFvQixFQUFFLFNBQTJCLEVBQUUsR0FBb0IsRUFBRSxPQUFzQjtRQUM3RyxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLGNBQWMsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE9BQU8sQ0FBQyxvQkFBb0IsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUN2RyxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsS0FBb0IsRUFBRSxTQUEyQixFQUFFLEdBQW9CLEVBQUUsT0FBd0I7UUFDOUcsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNwRixDQUFDO0lBRU8sU0FBUyxDQUFDLElBQW1CLEVBQUUsU0FBMkIsRUFBRSxHQUFvQixFQUFFLG9CQUF3QyxFQUFFLFlBQXFCO1FBQ3JKLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ1osSUFBSSxPQUFPLEdBQW1CLElBQUksQ0FBQztRQUNuQyxNQUFNLE1BQU0sR0FBRyxDQUFDLFNBQVMsQ0FBQztRQUMxQixJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxJQUFJLFlBQVksQ0FBQyxJQUFJLE1BQU0sRUFBRSxDQUFDO1lBQ2hELEVBQUUsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQztZQUNoQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMvQixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUNwQixPQUFPLEdBQUcsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUE4QixDQUFDO1lBQ3pELENBQUM7UUFDTCxDQUFDO1FBQ0QsSUFBSSxTQUFTLEVBQUUsQ0FBQztZQUNYLFNBQVMsQ0FBQyxJQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsT0FBTyxDQUFDO1lBQ3ZDLElBQUksb0JBQW9CLEVBQUUsQ0FBQztnQkFDdEIsU0FBUyxDQUFDLElBQVksQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLE9BQU8sQ0FBQztZQUM1RCxDQUFDO1FBQ0wsQ0FBQztRQUNELE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUM7SUFDeEIsQ0FBQztJQUVELGlCQUFpQixDQUFDLEtBQW9CLEVBQUUsU0FBMkIsRUFBRSxHQUFvQixFQUFFLE9BQXNCO1FBQzdHLE1BQU0sSUFBSSxHQUFHO1lBQ1QsUUFBUSxFQUFFLE9BQU8sQ0FBQyxJQUFJO1NBQ1QsQ0FBQztRQUNsQixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsT0FBTyxDQUFDLG9CQUFvQixFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQztJQUN0SCxDQUFDO0lBRUQsMkJBQTJCLENBQUMsS0FBb0IsRUFBRSxTQUEyQixFQUFFLEdBQW9CLEVBQUUsT0FBNEI7UUFDN0gsTUFBTSxJQUFJLEdBQUc7WUFDVCxRQUFRLEVBQUUsT0FBTyxDQUFDLElBQUk7WUFDdEIsT0FBTyxFQUFFLE9BQU8sQ0FBQyxPQUFPO1NBQ0QsQ0FBQztRQUM1QixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsT0FBTyxDQUFDLG9CQUFvQixFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3BGLENBQUM7SUFFRCxTQUFTO0lBRVQsd0JBQXdCLENBQUMsU0FBb0IsRUFBRSxHQUFvQixFQUFFLFNBQW9CLEVBQUUsb0JBQW1DO1FBQzFILElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxJQUFJLFNBQVMsQ0FBQyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDekMsUUFBUTtZQUNQLFNBQVMsQ0FBQyxJQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxNQUFNLEVBQUUsU0FBUyxDQUFDLEVBQUUsRUFBOEIsQ0FBQztRQUN4RixDQUFDO2FBQ0ksQ0FBQztZQUNGLGdCQUFnQjtZQUNmLFNBQVMsQ0FBQyxJQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQztRQUNsRCxDQUFDO1FBQ0QsSUFBSSxvQkFBb0IsRUFBRSxDQUFDO1lBQ3RCLFNBQVMsQ0FBQyxJQUFZLENBQUMsb0JBQW9CLENBQUMsR0FBSSxTQUFTLENBQUMsSUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2pGLENBQUM7SUFDTCxDQUFDO0lBRUQsZ0JBQWdCO0lBRWhCLGVBQWUsQ0FBQyxLQUFhLEVBQUUsU0FBb0IsRUFBRSxHQUFvQixFQUFFLEtBQVUsRUFBRSxPQUF3QjtRQUMxRyxTQUFTLENBQUMsSUFBWSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUNyQyxJQUFJLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxDQUFDO1lBQy9CLFNBQVMsQ0FBQyxJQUFZLENBQUMsT0FBTyxDQUFDLG9CQUFvQixDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQ2xFLENBQUM7SUFDTCxDQUFDO0lBRUQscUJBQXFCLENBQUMsS0FBb0IsRUFBRSxTQUEyQixFQUFFLEdBQW9CLEVBQUUsS0FBZ0IsRUFBRSxPQUF3QjtRQUNySSxNQUFNLElBQUksR0FBRztZQUNULFFBQVEsRUFBRSxPQUFFLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUM7U0FDeEIsQ0FBQztRQUVsQixNQUFNLEtBQUssR0FBSSxLQUFLLENBQUMsV0FBMEIsQ0FBQyxVQUFVLENBQUM7UUFDM0QsSUFBSSxLQUFLLEVBQUUsQ0FBQztZQUNSLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQ3BDLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDMUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFJLEtBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM5QyxDQUFDO1FBQ0wsQ0FBQztRQUVELElBQUksU0FBUyxFQUFFLENBQUM7WUFDWCxTQUFTLENBQUMsSUFBWSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQztZQUNwQyxJQUFJLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxDQUFDO2dCQUMvQixTQUFTLENBQUMsSUFBWSxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLElBQUksQ0FBQztZQUNqRSxDQUFDO1lBQ0QsT0FBTyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUM1QixDQUFDO2FBQ0ksQ0FBQztZQUNGLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQy9CLE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDO1FBQzNCLENBQUM7SUFDTCxDQUFDO0lBRUQsc0JBQXNCLENBQUMsS0FBYSxFQUFFLFNBQW9CLEVBQUUsR0FBb0IsRUFBRSxLQUFVLEVBQUUsT0FBd0I7UUFDbEgsSUFBSSxJQUFJLENBQUM7UUFDVCxJQUFJLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUN2QixNQUFNLFVBQVUsR0FBRyxLQUFLLFlBQVksUUFBUSxDQUFDO1lBQzdDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztnQkFDZCxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsaUJBQWlCLENBQUMsQ0FBQztZQUN4RSxDQUFDO1lBQ0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNwRCxJQUFJLEdBQUc7Z0JBQ0gsUUFBUSxFQUFFLGVBQWU7Z0JBQ3pCLElBQUksRUFBRSxLQUFLLENBQUMsV0FBVyxDQUFDLElBQUk7Z0JBQzVCLE1BQU07Z0JBQ04sTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU07YUFDdkQsQ0FBQztRQUNOLENBQUM7YUFBTSxDQUFDO1lBQ0osSUFBSSxHQUFHO2dCQUNILFFBQVEsRUFBRSxZQUFZO2dCQUN0QixJQUFJLEVBQUUsS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFJO2dCQUM1QixLQUFLLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7YUFDTixDQUFDO1FBQzNCLENBQUM7UUFFRCxJQUFJLFNBQVMsRUFBRSxDQUFDO1lBQ1gsU0FBUyxDQUFDLElBQVksQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDcEMsSUFBSSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsQ0FBQztnQkFDL0IsU0FBUyxDQUFDLElBQVksQ0FBQyxPQUFPLENBQUMsb0JBQW9CLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDakUsQ0FBQztRQUNMLENBQUM7YUFBTSxDQUFDO1lBQ0osSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbkMsQ0FBQztJQUNMLENBQUM7SUFFRCxxQkFBcUIsQ0FBQyxLQUFhLEVBQUUsU0FBb0IsRUFBRSxHQUFvQixFQUFFLElBQVksRUFBRSxPQUF3QjtRQUNsSCxTQUFTLENBQUMsSUFBWSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBMkIsQ0FBQztRQUMzRSxJQUFJLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxDQUFDO1lBQy9CLFNBQVMsQ0FBQyxJQUFZLENBQUMsT0FBTyxDQUFDLG9CQUFvQixDQUFDLEdBQUksU0FBUyxDQUFDLElBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN6RixDQUFDO1FBQ0QsSUFBSSxPQUFPLEVBQUUsWUFBWSxFQUFFLENBQUM7WUFDdkIsU0FBUyxDQUFDLElBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQyxnQkFBZ0IsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDO1FBQ3pFLENBQUM7SUFDTCxDQUFDO0lBRUQsT0FBTyxDQUFDLE9BQWtCO1FBQ3RCLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxLQUFLLENBQUMsRUFBRSx5Q0FBeUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDcEYsQ0FBQztJQUVTLGdCQUFnQjtRQUN0QixNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDO1FBQzNDLElBQUksY0FBYyxDQUFDO1FBQ25CLElBQUksY0FBYyxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDbkUsY0FBYyxHQUFHLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2QyxDQUFDO2FBQU0sQ0FBQztZQUNKLGNBQWMsR0FBRyxjQUFjLENBQUM7UUFDcEMsQ0FBQztRQUNELE9BQU8sY0FBYyxDQUFDO0lBQzFCLENBQUM7Q0FDSjtBQWpLRCxpQ0FpS0M7QUFFRDs7R0FFRztBQUNILFNBQWdCLE9BQU8sQ0FBQyxJQUFZLEVBQUUsT0FBMkIsVUFBSztJQUNsRSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDUixJQUFBLFVBQUssRUFBQyw2REFBNkQsQ0FBQyxDQUFDO1FBQ3JFLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFDRCxNQUFNLFdBQVcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO0lBQy9CLFdBQVcsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO0lBQ3pCLE9BQU8sV0FBVyxDQUFDO0FBQ3ZCLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQWdCLE9BQU8sQ0FBQyxJQUFvQixFQUFFLElBQVk7SUFDdEQsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLENBQUMsQ0FBUyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7SUFDbEMsQ0FBQztTQUFNLENBQUM7UUFDSCxJQUFZLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztJQUMvQixDQUFDO0FBQ0wsQ0FBQztBQUVELFNBQWdCLGNBQWMsQ0FBQyxJQUFvQixFQUFFLElBQVk7SUFDN0QsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDdEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUNuQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFpQixDQUFDO1lBQ3BDLElBQUksR0FBRyxDQUFDLFFBQVEsS0FBSyxJQUFJLEVBQUUsQ0FBQztnQkFDeEIsT0FBTyxHQUFHLENBQUM7WUFDZixDQUFDO1FBQ0wsQ0FBQztJQUNMLENBQUM7U0FDSSxJQUFLLElBQXFCLENBQUMsUUFBUSxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ2hELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFDRCxPQUFPLElBQUksQ0FBQztBQUNoQixDQUFDO0FBRUQsU0FBZ0IsTUFBTSxDQUFDLFNBQWMsRUFBRSxPQUFnQjtJQUNuRCxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDYixNQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sSUFBSSxrQkFBa0IsQ0FBQyxDQUFDO0lBQ25ELENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICAgIEFzc2V0LFxyXG4gICAgVmFsdWVUeXBlLFxyXG4gICAganMsXHJcbiAgICBkZXNlcmlhbGl6ZSxcclxuICAgIGVycm9yLFxyXG4gICAgQ29uc3RydWN0b3IsXHJcbn0gZnJvbSAnY2MnO1xyXG5cclxuaW1wb3J0IHtcclxuICAgIFByb3BlcnR5T3B0aW9ucyxcclxuICAgIElBcnJheU9wdGlvbnMsXHJcbiAgICBJQ2xhc3NPcHRpb25zLFxyXG4gICAgSUN1c3RvbUNsYXNzT3B0aW9ucyxcclxuICAgIElPYmpQYXJzaW5nSW5mbyxcclxufSBmcm9tICcuL3BhcnNlcic7XHJcblxyXG4vLyBpbXBvcnQgZGVzZXJpYWxpemVyIHR5cGVzXHJcbmltcG9ydCBEID0gZGVzZXJpYWxpemUuSW50ZXJuYWw7XHJcbmltcG9ydCB7IEJ1aWxkZXIsIElCdWlsZGVyT3B0aW9ucyB9IGZyb20gJy4vYmFzZS1idWlsZGVyJztcclxudHlwZSBBbnlDQ0NsYXNzID0gRC5BbnlDQ0NsYXNzXztcclxuXHJcbm5hbWVzcGFjZSBGb3JtYXQge1xyXG4gICAgZXhwb3J0IGludGVyZmFjZSBDbGFzcyB7XHJcbiAgICAgICAgX190eXBlX186IHN0cmluZztcclxuICAgICAgICBbcHJvcDogc3RyaW5nXTogQW55SXRlbTtcclxuICAgIH1cclxuICAgIGV4cG9ydCBpbnRlcmZhY2UgQ3VzdG9taXplZENsYXNzIGV4dGVuZHMgQ2xhc3Mge1xyXG4gICAgICAgIGNvbnRlbnQ6IGFueTtcclxuICAgIH1cclxuICAgIGV4cG9ydCBpbnRlcmZhY2UgVHlwZWRBcnJheSBleHRlbmRzIENsYXNzIHtcclxuICAgICAgICBfX3R5cGVfXzogJ1R5cGVkQXJyYXknLFxyXG4gICAgICAgIGN0b3I6IHN0cmluZyxcclxuICAgICAgICBhcnJheTogYW55W10sXHJcbiAgICB9XHJcbiAgICBleHBvcnQgaW50ZXJmYWNlIEluc3RhbmNlUmVmZXJlbmNlIHtcclxuICAgICAgICBfX2lkX186IG51bWJlcjtcclxuICAgIH1cclxuICAgIGV4cG9ydCBpbnRlcmZhY2UgQXNzZXRSZWZlcmVuY2Uge1xyXG4gICAgICAgIF9fdXVpZF9fOiBzdHJpbmc7XHJcbiAgICB9XHJcblxyXG4gICAgdHlwZSBSYXdJdGVtID0gbnVtYmVyIHwgc3RyaW5nIHwgYm9vbGVhbiB8IG51bGw7XHJcbiAgICB0eXBlIEl0ZW0gPSBDbGFzcyB8IEluc3RhbmNlUmVmZXJlbmNlIHwgUmF3SXRlbTtcclxuICAgIHR5cGUgRGljdCA9IHtcclxuICAgICAgICBba2V5IGluIHN0cmluZ106IEFueUl0ZW07XHJcbiAgICB9O1xyXG4gICAgdHlwZSBBcnJheSA9IEFueUl0ZW1bXTtcclxuXHJcbiAgICBleHBvcnQgdHlwZSBPYmplY3QgPSBDbGFzcyB8IERpY3QgfCBBcnJheTtcclxuICAgIGV4cG9ydCB0eXBlIEFueUl0ZW0gPSBJdGVtIHwgRGljdCB8IEFycmF5O1xyXG59XHJcblxyXG5pbnRlcmZhY2UgSU9iakFuZElkIGV4dGVuZHMgSU9ialBhcnNpbmdJbmZvIHtcclxuICAgIC8vIHNlcmlhbGl6ZWRMaXN0IOS4reeahOW6j+WIl+WMlue7k+aenFxyXG4gICAgZGF0YTogRm9ybWF0LkFueUl0ZW0sXHJcbiAgICAvLyBfX2lkX1/vvIzkuLrotJ/liJnor7TmmI7kuI3lnKggc2VyaWFsaXplZExpc3RcclxuICAgIGlkOiBudW1iZXIsXHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIER5bmFtaWNCdWlsZGVyIGV4dGVuZHMgQnVpbGRlciB7XHJcbiAgICBmb3JjZUlubGluZTogYm9vbGVhbjtcclxuXHJcbiAgICAvLyBsaXN0IG9mIHNlcmlhbGl6ZWQgZGF0YVxyXG4gICAgcHJpdmF0ZSBzZXJpYWxpemVkTGlzdDogYW55W10gPSBbXTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiBJQnVpbGRlck9wdGlvbnMpIHtcclxuICAgICAgICBzdXBlcihvcHRpb25zKTtcclxuICAgICAgICB0aGlzLmZvcmNlSW5saW5lID0gISFvcHRpb25zLmZvcmNlSW5saW5lO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFByb3BlcnR5X0FycmF5KG93bmVyOiBvYmplY3QgfCBudWxsLCBvd25lckluZm86IElPYmpBbmRJZCB8IG51bGwsIGtleTogc3RyaW5nIHwgbnVtYmVyLCBvcHRpb25zOiBJQXJyYXlPcHRpb25zKTogSU9iakFuZElkIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5hZGRPYmplY3Qob3B0aW9ucy53cml0ZU9ubHlBcnJheSwgb3duZXJJbmZvLCBrZXksIG9wdGlvbnMuZm9ybWVybHlTZXJpYWxpemVkQXMsIGZhbHNlKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRQcm9wZXJ0eV9EaWN0KG93bmVyOiBvYmplY3QgfCBudWxsLCBvd25lckluZm86IElPYmpBbmRJZCB8IG51bGwsIGtleTogc3RyaW5nIHwgbnVtYmVyLCBvcHRpb25zOiBQcm9wZXJ0eU9wdGlvbnMpOiBJT2JqQW5kSWQge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmFkZE9iamVjdCh7fSwgb3duZXJJbmZvLCBrZXksIG9wdGlvbnM/LmZvcm1lcmx5U2VyaWFsaXplZEFzLCBmYWxzZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhZGRPYmplY3QoZGF0YTogRm9ybWF0Lk9iamVjdCwgb3duZXJJbmZvOiBJT2JqQW5kSWQgfCBudWxsLCBrZXk6IHN0cmluZyB8IG51bWJlciwgZm9ybWVybHlTZXJpYWxpemVkQXM6IHN0cmluZyB8IHVuZGVmaW5lZCwgZm9yY2VJbmRleGVkOiBib29sZWFuKTogSU9iakFuZElkIHtcclxuICAgICAgICBsZXQgaWQgPSAtMTtcclxuICAgICAgICBsZXQgcmVmRGF0YTogRm9ybWF0LkFueUl0ZW0gPSBkYXRhO1xyXG4gICAgICAgIGNvbnN0IGlzUm9vdCA9ICFvd25lckluZm87XHJcbiAgICAgICAgaWYgKCghdGhpcy5mb3JjZUlubGluZSAmJiBmb3JjZUluZGV4ZWQpIHx8IGlzUm9vdCkge1xyXG4gICAgICAgICAgICBpZCA9IHRoaXMuc2VyaWFsaXplZExpc3QubGVuZ3RoO1xyXG4gICAgICAgICAgICB0aGlzLnNlcmlhbGl6ZWRMaXN0LnB1c2goZGF0YSk7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5mb3JjZUlubGluZSkge1xyXG4gICAgICAgICAgICAgICAgcmVmRGF0YSA9IHsgX19pZF9fOiBpZCB9IGFzIEZvcm1hdC5JbnN0YW5jZVJlZmVyZW5jZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAob3duZXJJbmZvKSB7XHJcbiAgICAgICAgICAgIChvd25lckluZm8uZGF0YSBhcyBhbnkpW2tleV0gPSByZWZEYXRhO1xyXG4gICAgICAgICAgICBpZiAoZm9ybWVybHlTZXJpYWxpemVkQXMpIHtcclxuICAgICAgICAgICAgICAgIChvd25lckluZm8uZGF0YSBhcyBhbnkpW2Zvcm1lcmx5U2VyaWFsaXplZEFzXSA9IHJlZkRhdGE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHsgZGF0YSwgaWQgfTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRQcm9wZXJ0eV9DbGFzcyhvd25lcjogb2JqZWN0IHwgbnVsbCwgb3duZXJJbmZvOiBJT2JqQW5kSWQgfCBudWxsLCBrZXk6IHN0cmluZyB8IG51bWJlciwgb3B0aW9uczogSUNsYXNzT3B0aW9ucyk6IElPYmpBbmRJZCB7XHJcbiAgICAgICAgY29uc3QgZGF0YSA9IHtcclxuICAgICAgICAgICAgX190eXBlX186IG9wdGlvbnMudHlwZSxcclxuICAgICAgICB9IGFzIEZvcm1hdC5DbGFzcztcclxuICAgICAgICByZXR1cm4gdGhpcy5hZGRPYmplY3QoZGF0YSwgb3duZXJJbmZvLCBrZXksIG9wdGlvbnMuZm9ybWVybHlTZXJpYWxpemVkQXMsICEob3B0aW9ucy51bmlxdWVseVJlZmVyZW5jZWQgPz8gZmFsc2UpKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRQcm9wZXJ0eV9DdXN0b21pemVkQ2xhc3Mob3duZXI6IG9iamVjdCB8IG51bGwsIG93bmVySW5mbzogSU9iakFuZElkIHwgbnVsbCwga2V5OiBzdHJpbmcgfCBudW1iZXIsIG9wdGlvbnM6IElDdXN0b21DbGFzc09wdGlvbnMpOiBJT2JqQW5kSWQge1xyXG4gICAgICAgIGNvbnN0IGRhdGEgPSB7XHJcbiAgICAgICAgICAgIF9fdHlwZV9fOiBvcHRpb25zLnR5cGUsXHJcbiAgICAgICAgICAgIGNvbnRlbnQ6IG9wdGlvbnMuY29udGVudCxcclxuICAgICAgICB9IGFzIEZvcm1hdC5DdXN0b21pemVkQ2xhc3M7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYWRkT2JqZWN0KGRhdGEsIG93bmVySW5mbywga2V5LCBvcHRpb25zLmZvcm1lcmx5U2VyaWFsaXplZEFzLCB0cnVlKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBwYXJzZWRcclxuXHJcbiAgICBzZXRQcm9wZXJ0eV9QYXJzZWRPYmplY3Qob3duZXJJbmZvOiBJT2JqQW5kSWQsIGtleTogc3RyaW5nIHwgbnVtYmVyLCB2YWx1ZUluZm86IElPYmpBbmRJZCwgZm9ybWVybHlTZXJpYWxpemVkQXM6IHN0cmluZyB8IG51bGwpOiB2b2lkIHtcclxuICAgICAgICBpZiAoIXRoaXMuZm9yY2VJbmxpbmUgJiYgdmFsdWVJbmZvLmlkID49IDApIHtcclxuICAgICAgICAgICAgLy8g5Y+v57Si5byV5a+56LGhXHJcbiAgICAgICAgICAgIChvd25lckluZm8uZGF0YSBhcyBhbnkpW2tleV0gPSB7IF9faWRfXzogdmFsdWVJbmZvLmlkIH0gYXMgRm9ybWF0Lkluc3RhbmNlUmVmZXJlbmNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgLy8g5LiN5Y+v57Si5byV5a+56LGh77yM55u05o6l5YaF6IGU5pWw5o2uXHJcbiAgICAgICAgICAgIChvd25lckluZm8uZGF0YSBhcyBhbnkpW2tleV0gPSB2YWx1ZUluZm8uZGF0YTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGZvcm1lcmx5U2VyaWFsaXplZEFzKSB7XHJcbiAgICAgICAgICAgIChvd25lckluZm8uZGF0YSBhcyBhbnkpW2Zvcm1lcmx5U2VyaWFsaXplZEFzXSA9IChvd25lckluZm8uZGF0YSBhcyBhbnkpW2tleV07XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIFN0YXRpYyBWYWx1ZXNcclxuXHJcbiAgICBzZXRQcm9wZXJ0eV9SYXcob3duZXI6IG9iamVjdCwgb3duZXJJbmZvOiBJT2JqQW5kSWQsIGtleTogc3RyaW5nIHwgbnVtYmVyLCB2YWx1ZTogYW55LCBvcHRpb25zOiBQcm9wZXJ0eU9wdGlvbnMpOiB2b2lkIHtcclxuICAgICAgICAob3duZXJJbmZvLmRhdGEgYXMgYW55KVtrZXldID0gdmFsdWU7XHJcbiAgICAgICAgaWYgKG9wdGlvbnM/LmZvcm1lcmx5U2VyaWFsaXplZEFzKSB7XHJcbiAgICAgICAgICAgIChvd25lckluZm8uZGF0YSBhcyBhbnkpW29wdGlvbnMuZm9ybWVybHlTZXJpYWxpemVkQXNdID0gdmFsdWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNldFByb3BlcnR5X1ZhbHVlVHlwZShvd25lcjogb2JqZWN0IHwgbnVsbCwgb3duZXJJbmZvOiBJT2JqQW5kSWQgfCBudWxsLCBrZXk6IHN0cmluZyB8IG51bWJlciwgdmFsdWU6IFZhbHVlVHlwZSwgb3B0aW9uczogUHJvcGVydHlPcHRpb25zKTogSU9iakFuZElkIHtcclxuICAgICAgICBjb25zdCBkYXRhID0ge1xyXG4gICAgICAgICAgICBfX3R5cGVfXzoganMuZ2V0Q2xhc3NJZCh2YWx1ZSwgZmFsc2UpLFxyXG4gICAgICAgIH0gYXMgRm9ybWF0LkNsYXNzO1xyXG5cclxuICAgICAgICBjb25zdCBwcm9wcyA9ICh2YWx1ZS5jb25zdHJ1Y3RvciBhcyBBbnlDQ0NsYXNzKS5fX3ZhbHVlc19fO1xyXG4gICAgICAgIGlmIChwcm9wcykge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBwID0gMDsgcCA8IHByb3BzLmxlbmd0aDsgcCsrKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9wTmFtZSA9IHByb3BzW3BdO1xyXG4gICAgICAgICAgICAgICAgZGF0YVtwcm9wTmFtZV0gPSAodmFsdWUgYXMgYW55KVtwcm9wTmFtZV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChvd25lckluZm8pIHtcclxuICAgICAgICAgICAgKG93bmVySW5mby5kYXRhIGFzIGFueSlba2V5XSA9IGRhdGE7XHJcbiAgICAgICAgICAgIGlmIChvcHRpb25zPy5mb3JtZXJseVNlcmlhbGl6ZWRBcykge1xyXG4gICAgICAgICAgICAgICAgKG93bmVySW5mby5kYXRhIGFzIGFueSlbb3B0aW9ucy5mb3JtZXJseVNlcmlhbGl6ZWRBc10gPSBkYXRhO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB7IGRhdGEsIGlkOiAtMSB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5zZXJpYWxpemVkTGlzdC5wdXNoKGRhdGEpO1xyXG4gICAgICAgICAgICByZXR1cm4geyBkYXRhLCBpZDogMCB9O1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzZXRQcm9wZXJ0eV9UeXBlZEFycmF5KG93bmVyOiBvYmplY3QsIG93bmVySW5mbzogSU9iakFuZElkLCBrZXk6IHN0cmluZyB8IG51bWJlciwgdmFsdWU6IGFueSwgb3B0aW9uczogUHJvcGVydHlPcHRpb25zKTogdm9pZCB7XHJcbiAgICAgICAgbGV0IGRhdGE7XHJcbiAgICAgICAgaWYgKHRoaXMuaGFzQmluYXJ5QnVmZmVyKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGlzRGF0YVZpZXcgPSB2YWx1ZSBpbnN0YW5jZW9mIERhdGFWaWV3O1xyXG4gICAgICAgICAgICBpZiAoIWlzRGF0YVZpZXcpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubWFpbkJ1ZmZlckJ1aWxkZXIuYWxpZ25Bcyh2YWx1ZS5jb25zdHJ1Y3Rvci5CWVRFU19QRVJfRUxFTUVOVCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy5tYWluQnVmZmVyQnVpbGRlci5hcHBlbmQodmFsdWUpO1xyXG4gICAgICAgICAgICBkYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgX190eXBlX186ICdUeXBlZEFycmF5UmVmJyxcclxuICAgICAgICAgICAgICAgIGN0b3I6IHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUsXHJcbiAgICAgICAgICAgICAgICBvZmZzZXQsXHJcbiAgICAgICAgICAgICAgICBsZW5ndGg6IGlzRGF0YVZpZXcgPyB2YWx1ZS5ieXRlTGVuZ3RoIDogdmFsdWUubGVuZ3RoLFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGRhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICBfX3R5cGVfXzogJ1R5cGVkQXJyYXknLFxyXG4gICAgICAgICAgICAgICAgY3RvcjogdmFsdWUuY29uc3RydWN0b3IubmFtZSxcclxuICAgICAgICAgICAgICAgIGFycmF5OiBBcnJheS5mcm9tKHZhbHVlKSxcclxuICAgICAgICAgICAgfSBhcyBGb3JtYXQuVHlwZWRBcnJheTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChvd25lckluZm8pIHtcclxuICAgICAgICAgICAgKG93bmVySW5mby5kYXRhIGFzIGFueSlba2V5XSA9IGRhdGE7XHJcbiAgICAgICAgICAgIGlmIChvcHRpb25zPy5mb3JtZXJseVNlcmlhbGl6ZWRBcykge1xyXG4gICAgICAgICAgICAgICAgKG93bmVySW5mby5kYXRhIGFzIGFueSlbb3B0aW9ucy5mb3JtZXJseVNlcmlhbGl6ZWRBc10gPSBkYXRhO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5zZXJpYWxpemVkTGlzdC5wdXNoKGRhdGEpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzZXRQcm9wZXJ0eV9Bc3NldFV1aWQob3duZXI6IG9iamVjdCwgb3duZXJJbmZvOiBJT2JqQW5kSWQsIGtleTogc3RyaW5nIHwgbnVtYmVyLCB1dWlkOiBzdHJpbmcsIG9wdGlvbnM6IFByb3BlcnR5T3B0aW9ucyk6IHZvaWQge1xyXG4gICAgICAgIChvd25lckluZm8uZGF0YSBhcyBhbnkpW2tleV0gPSB7IF9fdXVpZF9fOiB1dWlkIH0gYXMgRm9ybWF0LkFzc2V0UmVmZXJlbmNlO1xyXG4gICAgICAgIGlmIChvcHRpb25zPy5mb3JtZXJseVNlcmlhbGl6ZWRBcykge1xyXG4gICAgICAgICAgICAob3duZXJJbmZvLmRhdGEgYXMgYW55KVtvcHRpb25zLmZvcm1lcmx5U2VyaWFsaXplZEFzXSA9IChvd25lckluZm8uZGF0YSBhcyBhbnkpW2tleV07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvcHRpb25zPy5leHBlY3RlZFR5cGUpIHtcclxuICAgICAgICAgICAgKG93bmVySW5mby5kYXRhIGFzIGFueSlba2V5XS5fX2V4cGVjdGVkVHlwZV9fID0gb3B0aW9ucy5leHBlY3RlZFR5cGU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNldFJvb3Qob2JqSW5mbzogSU9iakFuZElkKTogdm9pZCB7XHJcbiAgICAgICAgYXNzZXJ0KG9iakluZm8uaWQgPT09IDAsIGBXcm9uZyByb290IG9iamVjdCB0byBzZXJpYWxpemUsIGlkIGlzICR7b2JqSW5mby5pZH1gKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgZmluYWxpemVKc29uUGFydCgpIHtcclxuICAgICAgICBjb25zdCBzZXJpYWxpemVkTGlzdCA9IHRoaXMuc2VyaWFsaXplZExpc3Q7XHJcbiAgICAgICAgbGV0IHNlcmlhbGl6ZWREYXRhO1xyXG4gICAgICAgIGlmIChzZXJpYWxpemVkTGlzdC5sZW5ndGggPT09IDEgJiYgIUFycmF5LmlzQXJyYXkoc2VyaWFsaXplZExpc3RbMF0pKSB7XHJcbiAgICAgICAgICAgIHNlcmlhbGl6ZWREYXRhID0gc2VyaWFsaXplZExpc3RbMF07XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgc2VyaWFsaXplZERhdGEgPSBzZXJpYWxpemVkTGlzdDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZWREYXRhO1xyXG4gICAgfVxyXG59XHJcblxyXG4vKipcclxuICogQ3JlYXRlIGEgcHNldWRvIG9iamVjdCB3aGljaCB3aWxsIGJlIGZvcmNlIHNlcmlhbGl6ZWQgYXMgYSByZWZlcmVuY2UgdG8gYW55IGFzc2V0IGJ5IHNwZWNpZmllZCB1dWlkLlxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGFzQXNzZXQodXVpZDogc3RyaW5nLCB0eXBlOiBDb25zdHJ1Y3RvcjxBc3NldD4gPSBBc3NldCk6IEFzc2V0IHwgbnVsbCB7XHJcbiAgICBpZiAoIXV1aWQpIHtcclxuICAgICAgICBlcnJvcignW0VkaXRvckV4dGVuZHMuc2VyaWFsaXplLmFzQXNzZXRdIFRoZSB1dWlkIG11c3QgYmUgbm9uLW5pbCEnKTtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IHBzZXVkb0Fzc2V0ID0gbmV3IHR5cGUoKTtcclxuICAgIHBzZXVkb0Fzc2V0Ll91dWlkID0gdXVpZDtcclxuICAgIHJldHVybiBwc2V1ZG9Bc3NldDtcclxufVxyXG5cclxuLyoqXHJcbiAqIFNldCB0aGUgYXNzZXQncyBuYW1lIGRpcmVjdGx5IGluIEpTT04gb2JqZWN0XHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gc2V0TmFtZShkYXRhOiBGb3JtYXQuQW55SXRlbSwgbmFtZTogc3RyaW5nKSB7XHJcbiAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkge1xyXG4gICAgICAgIChkYXRhWzBdIGFzIGFueSkuX25hbWUgPSBuYW1lO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICAoZGF0YSBhcyBhbnkpLl9uYW1lID0gbmFtZTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRSb290T2JqZWN0KGRhdGE6IEZvcm1hdC5BbnlJdGVtLCB0eXBlOiBzdHJpbmcpIHtcclxuICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG9iaiA9IGRhdGFbaV0gYXMgRm9ybWF0LkNsYXNzO1xyXG4gICAgICAgICAgICBpZiAob2JqLl9fdHlwZV9fID09PSB0eXBlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb2JqO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoKGRhdGEgYXMgRm9ybWF0LkNsYXNzKS5fX3R5cGVfXyA9PT0gdHlwZSkge1xyXG4gICAgICAgIHJldHVybiBkYXRhO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBhc3NlcnQoY29uZGl0aW9uOiBhbnksIG1lc3NhZ2U/OiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGlmICghY29uZGl0aW9uKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1lc3NhZ2UgfHwgJ0Fzc2VydGlvbiBmYWlsZWQnKTtcclxuICAgIH1cclxufSJdfQ==