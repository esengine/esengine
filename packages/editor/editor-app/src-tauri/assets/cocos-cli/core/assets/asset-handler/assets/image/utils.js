"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.defaultIconConfig = void 0;
exports.makeDefaultTextureCubeAssetUserData = makeDefaultTextureCubeAssetUserData;
exports.makeDefaultTexture2DAssetUserData = makeDefaultTexture2DAssetUserData;
exports.makeDefaultTexture2DAssetUserDataFromImagePath = makeDefaultTexture2DAssetUserDataFromImagePath;
exports.makeDefaultTexture2DAssetUserDataFromImageUuid = makeDefaultTexture2DAssetUserDataFromImageUuid;
exports.makeDefaultSpriteFrameAssetUserData = makeDefaultSpriteFrameAssetUserData;
exports.makeDefaultSpriteFrameAssetUserDataFromImageUuid = makeDefaultSpriteFrameAssetUserDataFromImageUuid;
exports.saveImageAsset = saveImageAsset;
exports.isCapableToFixAlphaTransparencyArtifacts = isCapableToFixAlphaTransparencyArtifacts;
exports.handleImageUserData = handleImageUserData;
exports.importWithType = importWithType;
exports.converImage = converImage;
exports.openImageAsset = openImageAsset;
const cc_1 = require("cc");
const fs_extra_1 = require("fs-extra");
const sharp_1 = __importDefault(require("sharp"));
const utils_1 = require("../../utils");
const bleeding_1 = require("../utils/algorithm/bleeding");
const texture_base_1 = require("../texture-base");
const RGBChannels = 3;
const RGBAChannels = 4;
function makeDefaultTextureCubeAssetUserData() {
    const userData = (0, texture_base_1.makeDefaultTextureBaseAssetUserData)();
    userData.isRGBE = false;
    userData.mipfilter = 'linear';
    return userData;
}
function makeDefaultTexture2DAssetUserData() {
    return (0, texture_base_1.makeDefaultTextureBaseAssetUserData)();
}
function makeDefaultTexture2DAssetUserDataFromImagePath(path) {
    return Object.assign((0, texture_base_1.makeDefaultTextureBaseAssetUserData)(), {
        isUuid: false,
        imageUuidOrDatabaseUri: path,
    });
}
function makeDefaultTexture2DAssetUserDataFromImageUuid(uuid, extName) {
    const defaultUserData = (0, texture_base_1.makeDefaultTextureBaseAssetUserData)();
    if (extName && ['.exr', '.hdr', '.znt'].includes(extName)) {
        defaultUserData.mipfilter = 'none';
        defaultUserData.minfilter = 'nearest';
        defaultUserData.magfilter = 'nearest';
    }
    return Object.assign(defaultUserData, {
        isUuid: true,
        imageUuidOrDatabaseUri: uuid,
    });
}
function makeDefaultSpriteFrameAssetUserData() {
    return (0, texture_base_1.makeDefaultSpriteFrameBaseAssetUserData)();
}
function makeDefaultSpriteFrameAssetUserDataFromImageUuid(uuid, atlas) {
    return Object.assign((0, texture_base_1.makeDefaultSpriteFrameBaseAssetUserData)(), {
        isUuid: true,
        imageUuidOrDatabaseUri: uuid,
        atlasUuid: atlas,
    });
}
async function saveImageAsset(asset, imageDataBufferOrimagePath, extName, displayName) {
    // Save the image data into library.
    if (typeof imageDataBufferOrimagePath === 'string') {
        await asset.copyToLibrary(extName, imageDataBufferOrimagePath);
    }
    else {
        await asset.saveToLibrary(extName, imageDataBufferOrimagePath);
    }
    // Create the image asset.
    const image = new cc_1.ImageAsset();
    image.name = displayName;
    image._setRawAsset(extName);
    const serializeJSON = EditorExtends.serialize(image);
    await asset.saveToLibrary('.json', serializeJSON);
    const depends = (0, utils_1.getDependUUIDList)(serializeJSON);
    asset.setData('depends', depends);
}
exports.defaultIconConfig = {
    type: 'icon',
    value: 'image',
};
/** 返回一个资源是否可以被消除阴影 */
function isCapableToFixAlphaTransparencyArtifacts(asset, type, extName) {
    const disableTypes = ['normal map', 'texture cube', 'sprite-frame', 'texture'];
    if (disableTypes.includes(type)) {
        return false;
    }
    const formatName = extName.toLocaleLowerCase().replace('.', '');
    const userData = asset.userData;
    const bannedFormatList = ['hdr', 'exr'];
    return !bannedFormatList.includes(formatName) && !userData.isRGBE;
}
async function handleImageUserData(asset, imageDataBufferOrimagePath, rawExtName) {
    if (typeof imageDataBufferOrimagePath === 'string') {
        imageDataBufferOrimagePath = await (0, fs_extra_1.readFile)(imageDataBufferOrimagePath);
    }
    const userData = asset.userData;
    const sharpResult = (0, sharp_1.default)(imageDataBufferOrimagePath);
    const metaData = await sharpResult.metadata();
    userData.hasAlpha = metaData.hasAlpha;
    userData.type ||= 'texture';
    // Do flip if needed.
    const flipVertical = !!userData.flipVertical;
    if (flipVertical) {
        imageDataBufferOrimagePath = await sharpResult.flip().toBuffer();
    }
    if (userData.fixAlphaTransparencyArtifacts && metaData.hasAlpha) {
        userData.fixAlphaTransparencyArtifacts = true;
        const img = await (0, sharp_1.default)(imageDataBufferOrimagePath).raw().toBuffer();
        /**
         * sharp 库获取含 alpha 通道的 png 图片的原始 buffer 的时候,会将图片展成四个通道。
         * 部分情况下会是有透明度的使用灰度通道的 Png ,这个时候通道数量为 2 所以不能够使用原图的通道数，
         * 因此将通道数强制设置为 4
         */
        let hasPurelyTransparentPixel = false;
        for (let index = 0; index < img.length; index += RGBAChannels) {
            const alpha = img[index + 3 /* Color.Alpha */];
            if (alpha === 0) {
                hasPurelyTransparentPixel = true;
                break;
            }
        }
        if (hasPurelyTransparentPixel) {
            const newBuffer = Buffer.from(img);
            //   offset
            //   . . .
            //   . o .
            //   . . .
            const sampleXOffsets = [-1, 0, 1, -1, 1, -1, 0, 1];
            const sampleYOffsets = [-1, -1, -1, 0, 0, 1, 1, 1];
            const bufIdxOffsets = [];
            const ditch = metaData.width * RGBAChannels;
            for (let j = 0; j < sampleXOffsets.length; j++) {
                bufIdxOffsets[j] = sampleXOffsets[j] * RGBAChannels + sampleYOffsets[j] * ditch;
            }
            (0, bleeding_1.applyContourBleed)(newBuffer, img, metaData.width, new cc_1.Rect(0, 0, metaData.width, metaData.height), sampleXOffsets, sampleYOffsets, bufIdxOffsets);
            imageDataBufferOrimagePath = await (0, sharp_1.default)(newBuffer, {
                raw: {
                    channels: RGBAChannels,
                    height: metaData.height,
                    width: metaData.width,
                },
            })
                .toFormat('png')
                .toBuffer();
        }
    }
    // flip green channel
    if (userData.flipGreenChannel) {
        const sharpResult = await (0, sharp_1.default)(imageDataBufferOrimagePath);
        const { width, height } = await sharpResult.metadata();
        const buffer = await sharpResult.raw().toBuffer();
        const channels = (buffer.length / width / height);
        const startIndex = 1 /* Color.Green */;
        for (let index = startIndex; index < buffer.length; index = channels + index) {
            buffer[index] = 255 - buffer[index];
        }
        const opts = { raw: { width: width, height: height, channels: channels } };
        imageDataBufferOrimagePath = await (0, sharp_1.default)(buffer, opts).toFormat('png').toBuffer();
    }
    return imageDataBufferOrimagePath;
}
async function importWithType(asset, type, displayName, extName) {
    const userData = asset.userData;
    switch (type) {
        case 'texture':
            {
                const texture2DSubAsset = await asset.createSubAsset('texture', 'texture', {
                    displayName,
                });
                userData.redirect = texture2DSubAsset.uuid;
                texture2DSubAsset.assignUserData(makeDefaultTexture2DAssetUserDataFromImageUuid(asset.uuid, extName));
                texture2DSubAsset.userData.imageUuidOrDatabaseUri = asset.uuid;
                texture2DSubAsset.userData.visible = false;
            }
            break;
        case 'normal map':
            {
                const normal2DSubAsset = await asset.createSubAsset('normalMap', 'texture', {
                    displayName,
                });
                normal2DSubAsset.assignUserData(makeDefaultTexture2DAssetUserDataFromImageUuid(asset.uuid));
            }
            break;
        case 'texture cube':
            {
                const textureCubeSubAsset = await asset.createSubAsset('textureCube', 'erp-texture-cube', {
                    displayName,
                });
                textureCubeSubAsset.assignUserData(makeDefaultTextureCubeAssetUserData());
                textureCubeSubAsset.userData.imageDatabaseUri = asset.uuid;
                textureCubeSubAsset.userData.isRGBE = !!userData.isRGBE;
            }
            break;
        case 'sprite-frame':
            {
                // const sprite2DSubAsset = await asset.createSubAsset(asset.basename, 'texture');
                const texture2DSubAssetWithSprite = await asset.createSubAsset('texture', 'texture', {
                    displayName,
                });
                texture2DSubAssetWithSprite.userData.wrapModeS = texture2DSubAssetWithSprite.userData.wrapModeS || 'clamp-to-edge';
                texture2DSubAssetWithSprite.userData.wrapModeT = texture2DSubAssetWithSprite.userData.wrapModeT || 'clamp-to-edge';
                userData.redirect = texture2DSubAssetWithSprite.uuid;
                texture2DSubAssetWithSprite.userData.imageUuidOrDatabaseUri = asset.uuid;
                texture2DSubAssetWithSprite.userData.isUuid = true;
                texture2DSubAssetWithSprite.userData.visible = false;
                const textureSpriteFrameSubAsset = await asset.createSubAsset('spriteFrame', 'sprite-frame', {
                    displayName,
                });
                textureSpriteFrameSubAsset.assignUserData(makeDefaultSpriteFrameAssetUserDataFromImageUuid(texture2DSubAssetWithSprite.uuid, ''));
                textureSpriteFrameSubAsset.userData.imageUuidOrDatabaseUri = texture2DSubAssetWithSprite.uuid;
            }
            break;
    }
}
async function converImage() { }
async function openImageAsset(asset) {
    // TODO: 实现打开图片资产
    return false;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9hc3NldHMvYXNzZXQtaGFuZGxlci9hc3NldHMvaW1hZ2UvdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBMkJBLGtGQUtDO0FBRUQsOEVBRUM7QUFFRCx3R0FLQztBQUVELHdHQVdDO0FBRUQsa0ZBRUM7QUFFRCw0R0FNQztBQUVELHdDQXNCQztBQVFELDRGQVNDO0FBRUQsa0RBZ0ZDO0FBRUQsd0NBc0RDO0FBRUQsa0NBQXVDO0FBRXZDLHdDQUlDO0FBN1BELDJCQUFzQztBQUN0Qyx1Q0FBZ0Q7QUFFaEQsa0RBQTBCO0FBUzFCLHVDQUFnRDtBQUNoRCwwREFBZ0U7QUFDaEUsa0RBQStHO0FBUS9HLE1BQU0sV0FBVyxHQUFtQixDQUFDLENBQUM7QUFDdEMsTUFBTSxZQUFZLEdBQW1CLENBQUMsQ0FBQztBQUV2QyxTQUFnQixtQ0FBbUM7SUFDL0MsTUFBTSxRQUFRLEdBQUcsSUFBQSxrREFBbUMsR0FBOEIsQ0FBQztJQUNuRixRQUFRLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztJQUN4QixRQUFRLENBQUMsU0FBUyxHQUFHLFFBQVEsQ0FBQztJQUM5QixPQUFPLFFBQVEsQ0FBQztBQUNwQixDQUFDO0FBRUQsU0FBZ0IsaUNBQWlDO0lBQzdDLE9BQU8sSUFBQSxrREFBbUMsR0FBRSxDQUFDO0FBQ2pELENBQUM7QUFFRCxTQUFnQiw4Q0FBOEMsQ0FBQyxJQUFZO0lBQ3ZFLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFBLGtEQUFtQyxHQUFFLEVBQUU7UUFDeEQsTUFBTSxFQUFFLEtBQUs7UUFDYixzQkFBc0IsRUFBRSxJQUFJO0tBQy9CLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRCxTQUFnQiw4Q0FBOEMsQ0FBQyxJQUFZLEVBQUUsT0FBZ0I7SUFDekYsTUFBTSxlQUFlLEdBQUcsSUFBQSxrREFBbUMsR0FBRSxDQUFD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LGdEQUFnRCxDQUFDLDJCQUEyQixDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FDekYsQ0FBQztnQkFDRiwwQkFBMEIsQ0FBQyxRQUFRLENBQUMsc0JBQXNCLEdBQUcsMkJBQTJCLENBQUMsSUFBSSxDQUFDO1lBQ2xHLENBQUM7WUFDRCxNQUFNO0lBQ2QsQ0FBQztBQUNMLENBQUM7QUFFTSxLQUFLLFVBQVUsV0FBVyxLQUFLLENBQUM7QUFFaEMsS0FBSyxVQUFVLGNBQWMsQ0FBQyxLQUFZO0lBQzdDLGlCQUFpQjtJQUVqQixPQUFPLEtBQUssQ0FBQztBQUNqQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXNzZXQsIFZpcnR1YWxBc3NldCB9IGZyb20gJ0Bjb2Nvcy9hc3NldC1kYic7XHJcbmltcG9ydCB7IElBc3NldCwgVGh1bWJuYWlsSW5mbyB9IGZyb20gJy4uLy4uLy4uL0B0eXBlcy9wcm90ZWN0ZWQnO1xyXG5pbXBvcnQgeyBJbWFnZUFzc2V0LCBSZWN0IH0gZnJvbSAnY2MnO1xyXG5pbXBvcnQgeyBleGlzdHNTeW5jLCByZWFkRmlsZSB9IGZyb20gJ2ZzLWV4dHJhJztcclxuaW1wb3J0IHsgam9pbiB9IGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgU2hhcnAgZnJvbSAnc2hhcnAnO1xyXG5pbXBvcnQge1xyXG4gICAgSW1hZ2VBc3NldFVzZXJEYXRhLFxyXG4gICAgSW1hZ2VJbXBvcnRUeXBlLFxyXG4gICAgU3ByaXRlRnJhbWVBc3NldFVzZXJEYXRhLFxyXG4gICAgU3ByaXRlRnJhbWVCYXNlQXNzZXRVc2VyRGF0YSxcclxuICAgIFRleHR1cmUyREFzc2V0VXNlckRhdGEsXHJcbiAgICBUZXh0dXJlQ3ViZUFzc2V0VXNlckRhdGEsXHJcbn0gZnJvbSAnLi4vLi4vLi4vQHR5cGVzL3VzZXJEYXRhcyc7XHJcbmltcG9ydCB7IGdldERlcGVuZFVVSURMaXN0IH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xyXG5pbXBvcnQgeyBhcHBseUNvbnRvdXJCbGVlZCB9IGZyb20gJy4uL3V0aWxzL2FsZ29yaXRobS9ibGVlZGluZyc7XHJcbmltcG9ydCB7IG1ha2VEZWZhdWx0U3ByaXRlRnJhbWVCYXNlQXNzZXRVc2VyRGF0YSwgbWFrZURlZmF1bHRUZXh0dXJlQmFzZUFzc2V0VXNlckRhdGEgfSBmcm9tICcuLi90ZXh0dXJlLWJhc2UnO1xyXG5cclxuY29uc3QgZW51bSBDb2xvciB7XHJcbiAgICBSZWQgPSAwLFxyXG4gICAgR3JlZW4sXHJcbiAgICBCbHVlLFxyXG4gICAgQWxwaGEgPSAzLFxyXG59XHJcbmNvbnN0IFJHQkNoYW5uZWxzOiBTaGFycC5DaGFubmVscyA9IDM7XHJcbmNvbnN0IFJHQkFDaGFubmVsczogU2hhcnAuQ2hhbm5lbHMgPSA0O1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VEZWZhdWx0VGV4dHVyZUN1YmVBc3NldFVzZXJEYXRhKCk6IFRleHR1cmVDdWJlQXNzZXRVc2VyRGF0YSB7XHJcbiAgICBjb25zdCB1c2VyRGF0YSA9IG1ha2VEZWZhdWx0VGV4dHVyZUJhc2VBc3NldFVzZXJEYXRhKCkgYXMgVGV4dHVyZUN1YmVBc3NldFVzZXJEYXRhO1xyXG4gICAgdXNlckRhdGEuaXNSR0JFID0gZmFsc2U7XHJcbiAgICB1c2VyRGF0YS5taXBmaWx0ZXIgPSAnbGluZWFyJztcclxuICAgIHJldHVybiB1c2VyRGF0YTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VEZWZhdWx0VGV4dHVyZTJEQXNzZXRVc2VyRGF0YSgpOiBUZXh0dXJlMkRBc3NldFVzZXJEYXRhIHtcclxuICAgIHJldHVybiBtYWtlRGVmYXVsdFRleHR1cmVCYXNlQXNzZXRVc2VyRGF0YSgpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbWFrZURlZmF1bHRUZXh0dXJlMkRBc3NldFVzZXJEYXRhRnJvbUltYWdlUGF0aChwYXRoOiBzdHJpbmcpOiBUZXh0dXJlMkRBc3NldFVzZXJEYXRhIHtcclxuICAgIHJldHVybiBPYmplY3QuYXNzaWduKG1ha2VEZWZhdWx0VGV4dHVyZUJhc2VBc3NldFVzZXJEYXRhKCksIHtcclxuICAgICAgICBpc1V1aWQ6IGZhbHNlLFxyXG4gICAgICAgIGltYWdlVXVpZE9yRGF0YWJhc2VVcmk6IHBhdGgsXHJcbiAgICB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VEZWZhdWx0VGV4dHVyZTJEQXNzZXRVc2VyRGF0YUZyb21JbWFnZVV1aWQodXVpZDogc3RyaW5nLCBleHROYW1lPzogc3RyaW5nKTogVGV4dHVyZTJEQXNzZXRVc2VyRGF0YSB7XHJcbiAgICBjb25zdCBkZWZhdWx0VXNlckRhdGEgPSBtYWtlRGVmYXVsdFRleHR1cmVCYXNlQXNzZXRVc2VyRGF0YSgpO1xyXG4gICAgaWYgKGV4dE5hbWUgJiYgWycuZXhyJywgJy5oZHInLCAnLnpudCddLmluY2x1ZGVzKGV4dE5hbWUpKSB7XHJcbiAgICAgICAgZGVmYXVsdFVzZXJEYXRhLm1pcGZpbHRlciA9ICdub25lJztcclxuICAgICAgICBkZWZhdWx0VXNlckRhdGEubWluZmlsdGVyID0gJ25lYXJlc3QnO1xyXG4gICAgICAgIGRlZmF1bHRVc2VyRGF0YS5tYWdmaWx0ZXIgPSAnbmVhcmVzdCc7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihkZWZhdWx0VXNlckRhdGEsIHtcclxuICAgICAgICBpc1V1aWQ6IHRydWUsXHJcbiAgICAgICAgaW1hZ2VVdWlkT3JEYXRhYmFzZVVyaTogdXVpZCxcclxuICAgIH0pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbWFrZURlZmF1bHRTcHJpdGVGcmFtZUFzc2V0VXNlckRhdGEoKTogU3ByaXRlRnJhbWVCYXNlQXNzZXRVc2VyRGF0YSB7XHJcbiAgICByZXR1cm4gbWFrZURlZmF1bHRTcHJpdGVGcmFtZUJhc2VBc3NldFVzZXJEYXRhKCk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBtYWtlRGVmYXVsdFNwcml0ZUZyYW1lQXNzZXRVc2VyRGF0YUZyb21JbWFnZVV1aWQodXVpZDogc3RyaW5nLCBhdGxhczogc3RyaW5nKTogU3ByaXRlRnJhbWVBc3NldFVzZXJEYXRhIHtcclxuICAgIHJldHVybiBPYmplY3QuYXNzaWduKG1ha2VEZWZhdWx0U3ByaXRlRnJhbWVCYXNlQXNzZXRVc2VyRGF0YSgpLCB7XHJcbiAgICAgICAgaXNVdWlkOiB0cnVlLFxyXG4gICAgICAgIGltYWdlVXVpZE9yRGF0YWJhc2VVcmk6IHV1aWQsXHJcbiAgICAgICAgYXRsYXNVdWlkOiBhdGxhcyxcclxuICAgIH0pO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2F2ZUltYWdlQXNzZXQoXHJcbiAgICBhc3NldDogQXNzZXQgfCBWaXJ0dWFsQXNzZXQsXHJcbiAgICBpbWFnZURhdGFCdWZmZXJPcmltYWdlUGF0aDogQnVmZmVyLFxyXG4gICAgZXh0TmFtZTogc3RyaW5nLFxyXG4gICAgZGlzcGxheU5hbWU6IHN0cmluZyxcclxuKSB7XHJcbiAgICAvLyBTYXZlIHRoZSBpbWFnZSBkYXRhIGludG8gbGlicmFyeS5cclxuICAgIGlmICh0eXBlb2YgaW1hZ2VEYXRhQnVmZmVyT3JpbWFnZVBhdGggPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgYXdhaXQgYXNzZXQuY29weVRvTGlicmFyeShleHROYW1lLCBpbWFnZURhdGFCdWZmZXJPcmltYWdlUGF0aCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGF3YWl0IGFzc2V0LnNhdmVUb0xpYnJhcnkoZXh0TmFtZSwgaW1hZ2VEYXRhQnVmZmVyT3JpbWFnZVBhdGgpO1xyXG4gICAgfVxyXG4gICAgLy8gQ3JlYXRlIHRoZSBpbWFnZSBhc3NldC5cclxuICAgIGNvbnN0IGltYWdlID0gbmV3IEltYWdlQXNzZXQoKTtcclxuICAgIGltYWdlLm5hbWUgPSBkaXNwbGF5TmFtZTtcclxuICAgIGltYWdlLl9zZXRSYXdBc3NldChleHROYW1lKTtcclxuXHJcbiAgICBjb25zdCBzZXJpYWxpemVKU09OID0gRWRpdG9yRXh0ZW5kcy5zZXJpYWxpemUoaW1hZ2UpO1xyXG4gICAgYXdhaXQgYXNzZXQuc2F2ZVRvTGlicmFyeSgnLmpzb24nLCBzZXJpYWxpemVKU09OKTtcclxuXHJcbiAgICBjb25zdCBkZXBlbmRzID0gZ2V0RGVwZW5kVVVJRExpc3Qoc2VyaWFsaXplSlNPTik7XHJcbiAgICBhc3NldC5zZXREYXRhKCdkZXBlbmRzJywgZGVwZW5kcyk7XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBkZWZhdWx0SWNvbkNvbmZpZzogVGh1bWJuYWlsSW5mbyA9IHtcclxuICAgIHR5cGU6ICdpY29uJyxcclxuICAgIHZhbHVlOiAnaW1hZ2UnLFxyXG59O1xyXG5cclxuLyoqIOi/lOWbnuS4gOS4qui1hOa6kOaYr+WQpuWPr+S7peiiq+a2iOmZpOmYtOW9sSAqL1xyXG5leHBvcnQgZnVuY3Rpb24gaXNDYXBhYmxlVG9GaXhBbHBoYVRyYW5zcGFyZW5jeUFydGlmYWN0cyhhc3NldDogQXNzZXQgfCBWaXJ0dWFsQXNzZXQsIHR5cGU6IEltYWdlSW1wb3J0VHlwZSwgZXh0TmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCBkaXNhYmxlVHlwZXM6IEltYWdlSW1wb3J0VHlwZVtdID0gWydub3JtYWwgbWFwJywgJ3RleHR1cmUgY3ViZScsICdzcHJpdGUtZnJhbWUnLCAndGV4dHVyZSddO1xyXG4gICAgaWYgKGRpc2FibGVUeXBlcy5pbmNsdWRlcyh0eXBlKSkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGNvbnN0IGZvcm1hdE5hbWUgPSBleHROYW1lLnRvTG9jYWxlTG93ZXJDYXNlKCkucmVwbGFjZSgnLicsICcnKTtcclxuICAgIGNvbnN0IHVzZXJEYXRhID0gYXNzZXQudXNlckRhdGEgYXMgSW1hZ2VBc3NldFVzZXJEYXRhO1xyXG4gICAgY29uc3QgYmFubmVkRm9ybWF0TGlzdCA9IFsnaGRyJywgJ2V4ciddO1xyXG4gICAgcmV0dXJuICFiYW5uZWRGb3JtYXRMaXN0LmluY2x1ZGVzKGZvcm1hdE5hbWUpICYmICF1c2VyRGF0YS5pc1JHQkU7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGVJbWFnZVVzZXJEYXRhKGFzc2V0OiBBc3NldCB8IFZpcnR1YWxBc3NldCwgaW1hZ2VEYXRhQnVmZmVyT3JpbWFnZVBhdGg6IEJ1ZmZlciB8IHN0cmluZywgcmF3RXh0TmFtZTogc3RyaW5nKSB7XHJcbiAgICBpZiAodHlwZW9mIGltYWdlRGF0YUJ1ZmZlck9yaW1hZ2VQYXRoID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgIGltYWdlRGF0YUJ1ZmZlck9yaW1hZ2VQYXRoID0gYXdhaXQgcmVhZEZpbGUoaW1hZ2VEYXRhQnVmZmVyT3JpbWFnZVBhdGgpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgdXNlckRhdGEgPSBhc3NldC51c2VyRGF0YSBhcyBJbWFnZUFzc2V0VXNlckRhdGE7XHJcbiAgICBjb25zdCBzaGFycFJlc3VsdCA9IFNoYXJwKGltYWdlRGF0YUJ1ZmZlck9yaW1hZ2VQYXRoKTtcclxuICAgIGNvbnN0IG1ldGFEYXRhID0gYXdhaXQgc2hhcnBSZXN1bHQubWV0YWRhdGEoKTtcclxuICAgIHVzZXJEYXRhLmhhc0FscGhhID0gbWV0YURhdGEuaGFzQWxwaGE7XHJcbiAgICB1c2VyRGF0YS50eXBlIHx8PSAndGV4dHVyZSc7XHJcbiAgICAvLyBEbyBmbGlwIGlmIG5lZWRlZC5cclxuICAgIGNvbnN0IGZsaXBWZXJ0aWNhbCA9ICEhdXNlckRhdGEuZmxpcFZlcnRpY2FsO1xyXG4gICAgaWYgKGZsaXBWZXJ0aWNhbCkge1xyXG4gICAgICAgIGltYWdlRGF0YUJ1ZmZlck9yaW1hZ2VQYXRoID0gYXdhaXQgc2hhcnBSZXN1bHQuZmxpcCgpLnRvQnVmZmVyKCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHVzZXJEYXRhLmZpeEFscGhhVHJhbnNwYXJlbmN5QXJ0aWZhY3RzICYmIG1ldGFEYXRhLmhhc0FscGhhKSB7XHJcbiAgICAgICAgdXNlckRhdGEuZml4QWxwaGFUcmFuc3BhcmVuY3lBcnRpZmFjdHMgPSB0cnVlO1xyXG4gICAgICAgIGNvbnN0IGltZyA9IGF3YWl0IFNoYXJwKGltYWdlRGF0YUJ1ZmZlck9yaW1hZ2VQYXRoKS5yYXcoKS50b0J1ZmZlcigpO1xyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIHNoYXJwIOW6k+iOt+WPluWQqyBhbHBoYSDpgJrpgZPnmoQgcG5nIOWbvueJh+eahOWOn+WniyBidWZmZXIg55qE5pe25YCZLOS8muWwhuWbvueJh+WxleaIkOWbm+S4qumAmumBk+OAglxyXG4gICAgICAgICAqIOmDqOWIhuaDheWGteS4i+S8muaYr+aciemAj+aYjuW6pueahOS9v+eUqOeBsOW6pumAmumBk+eahCBQbmcgLOi/meS4quaXtuWAmemAmumBk+aVsOmHj+S4uiAyIOaJgOS7peS4jeiDveWkn+S9v+eUqOWOn+WbvueahOmAmumBk+aVsO+8jFxyXG4gICAgICAgICAqIOWboOatpOWwhumAmumBk+aVsOW8uuWItuiuvue9ruS4uiA0XHJcbiAgICAgICAgICovXHJcblxyXG4gICAgICAgIGxldCBoYXNQdXJlbHlUcmFuc3BhcmVudFBpeGVsID0gZmFsc2U7XHJcbiAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGltZy5sZW5ndGg7IGluZGV4ICs9IFJHQkFDaGFubmVscykge1xyXG4gICAgICAgICAgICBjb25zdCBhbHBoYSA9IGltZ1tpbmRleCArIENvbG9yLkFscGhhXTtcclxuICAgICAgICAgICAgaWYgKGFscGhhID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICBoYXNQdXJlbHlUcmFuc3BhcmVudFBpeGVsID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChoYXNQdXJlbHlUcmFuc3BhcmVudFBpeGVsKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5ld0J1ZmZlciA9IEJ1ZmZlci5mcm9tKGltZyBhcyBVaW50OEFycmF5KTtcclxuICAgICAgICAgICAgLy8gICBvZmZzZXRcclxuICAgICAgICAgICAgLy8gICAuIC4gLlxyXG4gICAgICAgICAgICAvLyAgIC4gbyAuXHJcbiAgICAgICAgICAgIC8vICAgLiAuIC5cclxuICAgICAgICAgICAgY29uc3Qgc2FtcGxlWE9mZnNldHMgPSBbLTEsIDAsIDEsIC0xLCAxLCAtMSwgMCwgMV07XHJcbiAgICAgICAgICAgIGNvbnN0IHNhbXBsZVlPZmZzZXRzID0gWy0xLCAtMSwgLTEsIDAsIDAsIDEsIDEsIDFdO1xyXG4gICAgICAgICAgICBjb25zdCBidWZJZHhPZmZzZXRzOiBudW1iZXJbXSA9IFtdO1xyXG4gICAgICAgICAgICBjb25zdCBkaXRjaCA9IG1ldGFEYXRhLndpZHRoISAqIFJHQkFDaGFubmVscztcclxuICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBzYW1wbGVYT2Zmc2V0cy5sZW5ndGg7IGorKykge1xyXG4gICAgICAgICAgICAgICAgYnVmSWR4T2Zmc2V0c1tqXSA9IHNhbXBsZVhPZmZzZXRzW2pdICogUkdCQUNoYW5uZWxzICsgc2FtcGxlWU9mZnNldHNbal0gKiBkaXRjaDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBhcHBseUNvbnRvdXJCbGVlZChcclxuICAgICAgICAgICAgICAgIG5ld0J1ZmZlcixcclxuICAgICAgICAgICAgICAgIGltZyxcclxuICAgICAgICAgICAgICAgIG1ldGFEYXRhLndpZHRoISxcclxuICAgICAgICAgICAgICAgIG5ldyBSZWN0KDAsIDAsIG1ldGFEYXRhLndpZHRoLCBtZXRhRGF0YS5oZWlnaHQpLFxyXG4gICAgICAgICAgICAgICAgc2FtcGxlWE9mZnNldHMsXHJcbiAgICAgICAgICAgICAgICBzYW1wbGVZT2Zmc2V0cyxcclxuICAgICAgICAgICAgICAgIGJ1ZklkeE9mZnNldHMsXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIGltYWdlRGF0YUJ1ZmZlck9yaW1hZ2VQYXRoID0gYXdhaXQgU2hhcnAobmV3QnVmZmVyLCB7XHJcbiAgICAgICAgICAgICAgICByYXc6IHtcclxuICAgICAgICAgICAgICAgICAgICBjaGFubmVsczogUkdCQUNoYW5uZWxzLFxyXG4gICAgICAgICAgICAgICAgICAgIGhlaWdodDogbWV0YURhdGEuaGVpZ2h0ISxcclxuICAgICAgICAgICAgICAgICAgICB3aWR0aDogbWV0YURhdGEud2lkdGghLFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC50b0Zvcm1hdCgncG5nJylcclxuICAgICAgICAgICAgICAgIC50b0J1ZmZlcigpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBmbGlwIGdyZWVuIGNoYW5uZWxcclxuICAgIGlmICh1c2VyRGF0YS5mbGlwR3JlZW5DaGFubmVsKSB7XHJcbiAgICAgICAgY29uc3Qgc2hhcnBSZXN1bHQgPSBhd2FpdCBTaGFycChpbWFnZURhdGFCdWZmZXJPcmltYWdlUGF0aCk7XHJcbiAgICAgICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSBhd2FpdCBzaGFycFJlc3VsdC5tZXRhZGF0YSgpO1xyXG4gICAgICAgIGNvbnN0IGJ1ZmZlciA9IGF3YWl0IHNoYXJwUmVzdWx0LnJhdygpLnRvQnVmZmVyKCk7XHJcbiAgICAgICAgY29uc3QgY2hhbm5lbHMgPSAoYnVmZmVyLmxlbmd0aCAvIHdpZHRoISAvIGhlaWdodCEpIGFzIFNoYXJwLkNoYW5uZWxzO1xyXG4gICAgICAgIGNvbnN0IHN0YXJ0SW5kZXggPSBDb2xvci5HcmVlbjtcclxuICAgICAgICBmb3IgKGxldCBpbmRleCA9IHN0YXJ0SW5kZXg7IGluZGV4IDwgYnVmZmVyLmxlbmd0aDsgaW5kZXggPSBjaGFubmVscyEgKyBpbmRleCkge1xyXG4gICAgICAgICAgICBidWZmZXJbaW5kZXhdID0gMjU1IC0gYnVmZmVyW2luZGV4XTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3Qgb3B0cyA9IHsgcmF3OiB7IHdpZHRoOiB3aWR0aCEsIGhlaWdodDogaGVpZ2h0ISwgY2hhbm5lbHM6IGNoYW5uZWxzISB9IH07XHJcbiAgICAgICAgaW1hZ2VEYXRhQnVmZmVyT3JpbWFnZVBhdGggPSBhd2FpdCBTaGFycChidWZmZXIsIG9wdHMpLnRvRm9ybWF0KCdwbmcnKS50b0J1ZmZlcigpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGltYWdlRGF0YUJ1ZmZlck9yaW1hZ2VQYXRoO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaW1wb3J0V2l0aFR5cGUoYXNzZXQ6IEFzc2V0IHwgVmlydHVhbEFzc2V0LCB0eXBlOiBJbWFnZUltcG9ydFR5cGUsIGRpc3BsYXlOYW1lOiBzdHJpbmcsIGV4dE5hbWU6IHN0cmluZykge1xyXG4gICAgY29uc3QgdXNlckRhdGEgPSBhc3NldC51c2VyRGF0YTtcclxuICAgIHN3aXRjaCAodHlwZSkge1xyXG4gICAgICAgIGNhc2UgJ3RleHR1cmUnOlxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0ZXh0dXJlMkRTdWJBc3NldCA9IGF3YWl0IGFzc2V0LmNyZWF0ZVN1YkFzc2V0KCd0ZXh0dXJlJywgJ3RleHR1cmUnLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlzcGxheU5hbWUsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIHVzZXJEYXRhLnJlZGlyZWN0ID0gdGV4dHVyZTJEU3ViQXNzZXQudXVpZDtcclxuICAgICAgICAgICAgICAgIHRleHR1cmUyRFN1YkFzc2V0LmFzc2lnblVzZXJEYXRhKG1ha2VEZWZhdWx0VGV4dHVyZTJEQXNzZXRVc2VyRGF0YUZyb21JbWFnZVV1aWQoYXNzZXQudXVpZCwgZXh0TmFtZSkpO1xyXG4gICAgICAgICAgICAgICAgdGV4dHVyZTJEU3ViQXNzZXQudXNlckRhdGEuaW1hZ2VVdWlkT3JEYXRhYmFzZVVyaSA9IGFzc2V0LnV1aWQ7XHJcbiAgICAgICAgICAgICAgICB0ZXh0dXJlMkRTdWJBc3NldC51c2VyRGF0YS52aXNpYmxlID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnbm9ybWFsIG1hcCc6XHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5vcm1hbDJEU3ViQXNzZXQgPSBhd2FpdCBhc3NldC5jcmVhdGVTdWJBc3NldCgnbm9ybWFsTWFwJywgJ3RleHR1cmUnLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlzcGxheU5hbWUsXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIG5vcm1hbDJEU3ViQXNzZXQuYXNzaWduVXNlckRhdGEobWFrZURlZmF1bHRUZXh0dXJlMkRBc3NldFVzZXJEYXRhRnJvbUltYWdlVXVpZChhc3NldC51dWlkKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAndGV4dHVyZSBjdWJlJzpcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdGV4dHVyZUN1YmVTdWJBc3NldCA9IGF3YWl0IGFzc2V0LmNyZWF0ZVN1YkFzc2V0KCd0ZXh0dXJlQ3ViZScsICdlcnAtdGV4dHVyZS1jdWJlJywge1xyXG4gICAgICAgICAgICAgICAgICAgIGRpc3BsYXlOYW1lLFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB0ZXh0dXJlQ3ViZVN1YkFzc2V0LmFzc2lnblVzZXJEYXRhKG1ha2VEZWZhdWx0VGV4dHVyZUN1YmVBc3NldFVzZXJEYXRhKCkpO1xyXG4gICAgICAgICAgICAgICAgKHRleHR1cmVDdWJlU3ViQXNzZXQudXNlckRhdGEgYXMgVGV4dHVyZUN1YmVBc3NldFVzZXJEYXRhKS5pbWFnZURhdGFiYXNlVXJpID0gYXNzZXQudXVpZDtcclxuICAgICAgICAgICAgICAgICh0ZXh0dXJlQ3ViZVN1YkFzc2V0LnVzZXJEYXRhIGFzIFRleHR1cmVDdWJlQXNzZXRVc2VyRGF0YSkuaXNSR0JFID0gISF1c2VyRGF0YS5pc1JHQkU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnc3ByaXRlLWZyYW1lJzpcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgLy8gY29uc3Qgc3ByaXRlMkRTdWJBc3NldCA9IGF3YWl0IGFzc2V0LmNyZWF0ZVN1YkFzc2V0KGFzc2V0LmJhc2VuYW1lLCAndGV4dHVyZScpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdGV4dHVyZTJEU3ViQXNzZXRXaXRoU3ByaXRlID0gYXdhaXQgYXNzZXQuY3JlYXRlU3ViQXNzZXQoJ3RleHR1cmUnLCAndGV4dHVyZScsIHtcclxuICAgICAgICAgICAgICAgICAgICBkaXNwbGF5TmFtZSxcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgdGV4dHVyZTJEU3ViQXNzZXRXaXRoU3ByaXRlLnVzZXJEYXRhLndyYXBNb2RlUyA9IHRleHR1cmUyRFN1YkFzc2V0V2l0aFNwcml0ZS51c2VyRGF0YS53cmFwTW9kZVMgfHwgJ2NsYW1wLXRvLWVkZ2UnO1xyXG4gICAgICAgICAgICAgICAgdGV4dHVyZTJEU3ViQXNzZXRXaXRoU3ByaXRlLnVzZXJEYXRhLndyYXBNb2RlVCA9IHRleHR1cmUyRFN1YkFzc2V0V2l0aFNwcml0ZS51c2VyRGF0YS53cmFwTW9kZVQgfHwgJ2NsYW1wLXRvLWVkZ2UnO1xyXG4gICAgICAgICAgICAgICAgdXNlckRhdGEucmVkaXJlY3QgPSB0ZXh0dXJlMkRTdWJBc3NldFdpdGhTcHJpdGUudXVpZDtcclxuICAgICAgICAgICAgICAgIHRleHR1cmUyRFN1YkFzc2V0V2l0aFNwcml0ZS51c2VyRGF0YS5pbWFnZVV1aWRPckRhdGFiYXNlVXJpID0gYXNzZXQudXVpZDtcclxuICAgICAgICAgICAgICAgIHRleHR1cmUyRFN1YkFzc2V0V2l0aFNwcml0ZS51c2VyRGF0YS5pc1V1aWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgdGV4dHVyZTJEU3ViQXNzZXRXaXRoU3ByaXRlLnVzZXJEYXRhLnZpc2libGUgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRleHR1cmVTcHJpdGVGcmFtZVN1YkFzc2V0ID0gYXdhaXQgYXNzZXQuY3JlYXRlU3ViQXNzZXQoJ3Nwcml0ZUZyYW1lJywgJ3Nwcml0ZS1mcmFtZScsIHtcclxuICAgICAgICAgICAgICAgICAgICBkaXNwbGF5TmFtZSxcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgdGV4dHVyZVNwcml0ZUZyYW1lU3ViQXNzZXQuYXNzaWduVXNlckRhdGEoXHJcbiAgICAgICAgICAgICAgICAgICAgbWFrZURlZmF1bHRTcHJpdGVGcmFtZUFzc2V0VXNlckRhdGFGcm9tSW1hZ2VVdWlkKHRleHR1cmUyRFN1YkFzc2V0V2l0aFNwcml0ZS51dWlkLCAnJyksXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgdGV4dHVyZVNwcml0ZUZyYW1lU3ViQXNzZXQudXNlckRhdGEuaW1hZ2VVdWlkT3JEYXRhYmFzZVVyaSA9IHRleHR1cmUyRFN1YkFzc2V0V2l0aFNwcml0ZS51dWlkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY29udmVySW1hZ2UoKSB7IH1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBvcGVuSW1hZ2VBc3NldChhc3NldDogQXNzZXQpIHtcclxuICAgIC8vIFRPRE86IOWunueOsOaJk+W8gOWbvueJh+i1hOS6p1xyXG5cclxuICAgIHJldHVybiBmYWxzZTtcclxufVxyXG4iXX0=