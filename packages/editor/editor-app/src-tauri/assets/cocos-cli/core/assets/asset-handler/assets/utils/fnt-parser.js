"use strict";
// 类型定义
Object.defineProperty(exports, "__esModule", { value: true });
class FntLoader {
    INFO_EXP = /info .*?(?=\/>)|info .*/gi;
    COMMON_EXP = /common .*?(?=\/>)|common .*/gi;
    PAGE_EXP = /page .*?(?=\/>)|page .*/gi;
    CHAR_EXP = /char .*?(?=\/>)|char .*/gi;
    KERNING_EXP = /kerning .*?(?=\/>)|kerning .*/gi;
    ITEM_EXP = /\w+=[^ \r\n]+/gi;
    NUM_EXP = /^-?\d+(?:\.\d+)?$/;
    _parseStrToObj(str) {
        const arr = str.match(this.ITEM_EXP);
        const obj = {};
        if (arr) {
            for (let i = 0, li = arr.length; i < li; i++) {
                const tempStr = arr[i];
                const index = tempStr.indexOf('=');
                const key = tempStr.substring(0, index);
                let value = tempStr.substring(index + 1);
                if (value[0] === '"') {
                    value = value.substring(1, value.length - 1);
                    if (value.match(this.NUM_EXP)) {
                        value = parseFloat(value);
                    }
                }
                else if (value.match(this.NUM_EXP)) {
                    value = parseFloat(value);
                }
                obj[key] = value;
            }
        }
        return obj;
    }
    /**
     * Parse Fnt string.
     * @param fntStr - FNT file content string
     * @returns Parsed font data
     */
    parseFnt(fntStr) {
        const fnt = {};
        // padding
        const infoResult = fntStr.match(this.INFO_EXP);
        if (!infoResult) {
            return fnt;
        }
        const infoObj = this._parseStrToObj(infoResult[0]);
        // var paddingArr = infoObj["padding"].split(",");
        // var padding = {
        //     left: parseInt(paddingArr[0]),
        //     top: parseInt(paddingArr[1]),
        //     right: parseInt(paddingArr[2]),
        //     bottom: parseInt(paddingArr[3])
        // };
        // common
        const commonMatch = fntStr.match(this.COMMON_EXP);
        if (!commonMatch) {
            return fnt;
        }
        const commonObj = this._parseStrToObj(commonMatch[0]);
        fnt.commonHeight = commonObj['lineHeight'];
        fnt.fontSize = parseInt(infoObj['size']);
        if (cc.game.renderType === cc.game.RENDER_TYPE_WEBGL) {
            const texSize = cc.configuration.getMaxTextureSize();
            if (commonObj['scaleW'] > texSize.width || commonObj['scaleH'] > texSize.height) {
                console.log('cc.LabelBMFont._parseCommonArguments(): page can\'t be larger than supported');
            }
        }
        if (commonObj['pages'] !== 1) {
            console.log('cc.LabelBMFont._parseCommonArguments(): only supports 1 page');
        }
        // page
        const pageMatch = fntStr.match(this.PAGE_EXP);
        if (!pageMatch) {
            return fnt;
        }
        const pageObj = this._parseStrToObj(pageMatch[0]);
        if (pageObj['id'] !== 0) {
            console.log('cc.LabelBMFont._parseImageFileName() : file could not be found');
        }
        fnt.atlasName = pageObj['file'];
        // char
        const charLines = fntStr.match(this.CHAR_EXP);
        if (!charLines) {
            return fnt;
        }
        const fontDefDictionary = {};
        fnt.fontDefDictionary = fontDefDictionary;
        for (let i = 0, li = charLines.length; i < li; i++) {
            const charObj = this._parseStrToObj(charLines[i]);
            const charId = charObj['id'];
            fontDefDictionary[charId] = {
                rect: {
                    x: charObj['x'],
                    y: charObj['y'],
                    width: charObj['width'],
                    height: charObj['height']
                },
                xOffset: charObj['xoffset'],
                yOffset: charObj['yoffset'],
                xAdvance: charObj['xadvance'],
            };
        }
        // kerning
        const kerningDict = {};
        fnt.kerningDict = kerningDict;
        const kerningLines = fntStr.match(this.KERNING_EXP);
        if (kerningLines) {
            for (let i = 0, li = kerningLines.length; i < li; i++) {
                const kerningObj = this._parseStrToObj(kerningLines[i]);
                kerningDict[kerningObj['first'] << 16 | kerningObj['second'] & 0xffff] = kerningObj['amount'];
            }
        }
        return fnt;
    }
}
exports.default = new FntLoader();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm50LXBhcnNlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL2Fzc2V0cy9hc3NldC1oYW5kbGVyL2Fzc2V0cy91dGlscy9mbnQtcGFyc2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPOztBQVFQLE1BQU0sU0FBUztJQUNNLFFBQVEsR0FBRywyQkFBMkIsQ0FBQztJQUN2QyxVQUFVLEdBQUcsK0JBQStCLENBQUM7SUFDN0MsUUFBUSxHQUFHLDJCQUEyQixDQUFDO0lBQ3ZDLFFBQVEsR0FBRywyQkFBMkIsQ0FBQztJQUN2QyxXQUFXLEdBQUcsaUNBQWlDLENBQUM7SUFDaEQsUUFBUSxHQUFHLGlCQUFpQixDQUFDO0lBQzdCLE9BQU8sR0FBRyxtQkFBbUIsQ0FBQztJQUV2QyxjQUFjLENBQUMsR0FBVztRQUM5QixNQUFNLEdBQUcsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNyQyxNQUFNLEdBQUcsR0FBYyxFQUFFLENBQUM7UUFDMUIsSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUNOLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsR0FBRyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDM0MsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN2QixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNuQyxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFDeEMsSUFBSSxLQUFLLEdBQW9CLE9BQU8sQ0FBQyxTQUFTLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUMxRCxJQUFJLEtBQUssQ0FBQyxDQUFD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LENBQUM7UUFDcEMsR0FBRyxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7UUFDOUIsTUFBTSxZQUFZLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDcEQsSUFBSSxZQUFZLEVBQUUsQ0FBQztZQUNmLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsR0FBRyxZQUFZLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDcEQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDeEQsV0FBVyxDQUFFLFVBQVUsQ0FBQyxPQUFPLENBQVksSUFBSSxFQUFFLEdBQUksVUFBVSxDQUFDLFFBQVEsQ0FBWSxHQUFHLE1BQU0sQ0FBQyxHQUFHLFVBQVUsQ0FBQyxRQUFRLENBQVcsQ0FBQztZQUNwSSxDQUFDO1FBQ0wsQ0FBQztRQUNELE9BQU8sR0FBRyxDQUFDO0lBQ2YsQ0FBQztDQUNKO0FBRUQsa0JBQWUsSUFBSSxTQUFTLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIOexu+Wei+WumuS5iVxyXG5cclxuaW1wb3J0IHsgRm50RGF0YSwgRm9udERlZkRpY3Rpb25hcnksIEtlcm5pbmdEaWN0IH0gZnJvbSAnLi4vLi4vLi4vQHR5cGVzL3VzZXJEYXRhcyc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFBhcnNlZE9iaiB7XHJcbiAgICBba2V5OiBzdHJpbmddOiBzdHJpbmcgfCBudW1iZXI7XHJcbn1cclxuXHJcbmNsYXNzIEZudExvYWRlciB7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IElORk9fRVhQID0gL2luZm8gLio/KD89XFwvPil8aW5mbyAuKi9naTtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgQ09NTU9OX0VYUCA9IC9jb21tb24gLio/KD89XFwvPil8Y29tbW9uIC4qL2dpO1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSBQQUdFX0VYUCA9IC9wYWdlIC4qPyg/PVxcLz4pfHBhZ2UgLiovZ2k7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IENIQVJfRVhQID0gL2NoYXIgLio/KD89XFwvPil8Y2hhciAuKi9naTtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgS0VSTklOR19FWFAgPSAva2VybmluZyAuKj8oPz1cXC8+KXxrZXJuaW5nIC4qL2dpO1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSBJVEVNX0VYUCA9IC9cXHcrPVteIFxcclxcbl0rL2dpO1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSBOVU1fRVhQID0gL14tP1xcZCsoPzpcXC5cXGQrKT8kLztcclxuXHJcbiAgICBwcml2YXRlIF9wYXJzZVN0clRvT2JqKHN0cjogc3RyaW5nKTogUGFyc2VkT2JqIHtcclxuICAgICAgICBjb25zdCBhcnIgPSBzdHIubWF0Y2godGhpcy5JVEVNX0VYUCk7XHJcbiAgICAgICAgY29uc3Qgb2JqOiBQYXJzZWRPYmogPSB7fTtcclxuICAgICAgICBpZiAoYXJyKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwLCBsaSA9IGFyci5sZW5ndGg7IGkgPCBsaTsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0ZW1wU3RyID0gYXJyW2ldO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSB0ZW1wU3RyLmluZGV4T2YoJz0nKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IHRlbXBTdHIuc3Vic3RyaW5nKDAsIGluZGV4KTtcclxuICAgICAgICAgICAgICAgIGxldCB2YWx1ZTogc3RyaW5nIHwgbnVtYmVyID0gdGVtcFN0ci5zdWJzdHJpbmcoaW5kZXggKyAxKTtcclxuICAgICAgICAgICAgICAgIGlmICh2YWx1ZVswXSA9PT0gJ1wiJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc3Vic3RyaW5nKDEsIHZhbHVlLmxlbmd0aCAtIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5tYXRjaCh0aGlzLk5VTV9FWFApKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gcGFyc2VGbG9hdCh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5tYXRjaCh0aGlzLk5VTV9FWFApKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBwYXJzZUZsb2F0KHZhbHVlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIG9ialtrZXldID0gdmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG9iajtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFBhcnNlIEZudCBzdHJpbmcuXHJcbiAgICAgKiBAcGFyYW0gZm50U3RyIC0gRk5UIGZpbGUgY29udGVudCBzdHJpbmdcclxuICAgICAqIEByZXR1cm5zIFBhcnNlZCBmb250IGRhdGFcclxuICAgICAqL1xyXG4gICAgcHVibGljIHBhcnNlRm50KGZudFN0cjogc3RyaW5nKTogRm50RGF0YSB7XHJcbiAgICAgICAgY29uc3QgZm50OiBGbnREYXRhID0ge307XHJcblxyXG4gICAgICAgIC8vIHBhZGRpbmdcclxuICAgICAgICBjb25zdCBpbmZvUmVzdWx0ID0gZm50U3RyLm1hdGNoKHRoaXMuSU5GT19FWFApO1xyXG4gICAgICAgIGlmICghaW5mb1Jlc3VsdCkge1xyXG4gICAgICAgICAgICByZXR1cm4gZm50O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgaW5mb09iaiA9IHRoaXMuX3BhcnNlU3RyVG9PYmooaW5mb1Jlc3VsdFswXSk7XHJcbiAgICAgICAgLy8gdmFyIHBhZGRpbmdBcnIgPSBpbmZvT2JqW1wicGFkZGluZ1wiXS5zcGxpdChcIixcIik7XHJcbiAgICAgICAgLy8gdmFyIHBhZGRpbmcgPSB7XHJcbiAgICAgICAgLy8gICAgIGxlZnQ6IHBhcnNlSW50KHBhZGRpbmdBcnJbMF0pLFxyXG4gICAgICAgIC8vICAgICB0b3A6IHBhcnNlSW50KHBhZGRpbmdBcnJbMV0pLFxyXG4gICAgICAgIC8vICAgICByaWdodDogcGFyc2VJbnQocGFkZGluZ0FyclsyXSksXHJcbiAgICAgICAgLy8gICAgIGJvdHRvbTogcGFyc2VJbnQocGFkZGluZ0FyclszXSlcclxuICAgICAgICAvLyB9O1xyXG5cclxuICAgICAgICAvLyBjb21tb25cclxuICAgICAgICBjb25zdCBjb21tb25NYXRjaCA9IGZudFN0ci5tYXRjaCh0aGlzLkNPTU1PTl9FWFApO1xyXG4gICAgICAgIGlmICghY29tbW9uTWF0Y2gpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZudDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgY29tbW9uT2JqID0gdGhpcy5fcGFyc2VTdHJUb09iaihjb21tb25NYXRjaFswXSk7XHJcbiAgICAgICAgZm50LmNvbW1vbkhlaWdodCA9IGNvbW1vbk9ialsnbGluZUhlaWdodCddIGFzIG51bWJlcjtcclxuICAgICAgICBmbnQuZm9udFNpemUgPSBwYXJzZUludChpbmZvT2JqWydzaXplJ10gYXMgc3RyaW5nKTtcclxuXHJcbiAgICAgICAgaWYgKGNjLmdhbWUucmVuZGVyVHlwZSA9PT0gY2MuZ2FtZS5SRU5ERVJfVFlQRV9XRUJHTCkge1xyXG4gICAgICAgICAgICBjb25zdCB0ZXhTaXplID0gY2MuY29uZmlndXJhdGlvbi5nZXRNYXhUZXh0dXJlU2l6ZSgpO1xyXG4gICAgICAgICAgICBpZiAoKGNvbW1vbk9ialsnc2NhbGVXJ10gYXMgbnVtYmVyKSA+IHRleFNpemUud2lkdGggfHwgKGNvbW1vbk9ialsnc2NhbGVIJ10gYXMgbnVtYmVyKSA+IHRleFNpemUuaGVpZ2h0KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnY2MuTGFiZWxCTUZvbnQuX3BhcnNlQ29tbW9uQXJndW1lbnRzKCk6IHBhZ2UgY2FuXFwndCBiZSBsYXJnZXIgdGhhbiBzdXBwb3J0ZWQnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY29tbW9uT2JqWydwYWdlcyddICE9PSAxKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdjYy5MYWJlbEJNRm9udC5fcGFyc2VDb21tb25Bcmd1bWVudHMoKTogb25seSBzdXBwb3J0cyAxIHBhZ2UnKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHBhZ2VcclxuICAgICAgICBjb25zdCBwYWdlTWF0Y2ggPSBmbnRTdHIubWF0Y2godGhpcy5QQUdFX0VYUCk7XHJcbiAgICAgICAgaWYgKCFwYWdlTWF0Y2gpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZudDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcGFnZU9iaiA9IHRoaXMuX3BhcnNlU3RyVG9PYmoocGFnZU1hdGNoWzBdKTtcclxuICAgICAgICBpZiAocGFnZU9ialsnaWQnXSAhPT0gMCkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnY2MuTGFiZWxCTUZvbnQuX3BhcnNlSW1hZ2VGaWxlTmFtZSgpIDogZmlsZSBjb3VsZCBub3QgYmUgZm91bmQnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm50LmF0bGFzTmFtZSA9IHBhZ2VPYmpbJ2ZpbGUnXSBhcyBzdHJpbmc7XHJcblxyXG4gICAgICAgIC8vIGNoYXJcclxuICAgICAgICBjb25zdCBjaGFyTGluZXMgPSBmbnRTdHIubWF0Y2godGhpcy5DSEFSX0VYUCk7XHJcbiAgICAgICAgaWYgKCFjaGFyTGluZXMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZudDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZm9udERlZkRpY3Rpb25hcnk6IEZvbnREZWZEaWN0aW9uYXJ5ID0ge307XHJcbiAgICAgICAgZm50LmZvbnREZWZEaWN0aW9uYXJ5ID0gZm9udERlZkRpY3Rpb25hcnk7XHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwLCBsaSA9IGNoYXJMaW5lcy5sZW5ndGg7IGkgPCBsaTsgaSsrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNoYXJPYmogPSB0aGlzLl9wYXJzZVN0clRvT2JqKGNoYXJMaW5lc1tpXSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGNoYXJJZCA9IGNoYXJPYmpbJ2lkJ10gYXMgbnVtYmVyO1xyXG4gICAgICAgICAgICBmb250RGVmRGljdGlvbmFyeVtjaGFySWRdID0ge1xyXG4gICAgICAgICAgICAgICAgcmVjdDoge1xyXG4gICAgICAgICAgICAgICAgICAgIHg6IGNoYXJPYmpbJ3gnXSBhcyBudW1iZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgeTogY2hhck9ialsneSddIGFzIG51bWJlcixcclxuICAgICAgICAgICAgICAgICAgICB3aWR0aDogY2hhck9ialsnd2lkdGgnXSBhcyBudW1iZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBjaGFyT2JqWydoZWlnaHQnXSBhcyBudW1iZXJcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB4T2Zmc2V0OiBjaGFyT2JqWyd4b2Zmc2V0J10gYXMgbnVtYmVyLFxyXG4gICAgICAgICAgICAgICAgeU9mZnNldDogY2hhck9ialsneW9mZnNldCddIGFzIG51bWJlcixcclxuICAgICAgICAgICAgICAgIHhBZHZhbmNlOiBjaGFyT2JqWyd4YWR2YW5jZSddIGFzIG51bWJlcixcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGtlcm5pbmdcclxuICAgICAgICBjb25zdCBrZXJuaW5nRGljdDogS2VybmluZ0RpY3QgPSB7fTtcclxuICAgICAgICBmbnQua2VybmluZ0RpY3QgPSBrZXJuaW5nRGljdDtcclxuICAgICAgICBjb25zdCBrZXJuaW5nTGluZXMgPSBmbnRTdHIubWF0Y2godGhpcy5LRVJOSU5HX0VYUCk7XHJcbiAgICAgICAgaWYgKGtlcm5pbmdMaW5lcykge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMCwgbGkgPSBrZXJuaW5nTGluZXMubGVuZ3RoOyBpIDwgbGk7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qga2VybmluZ09iaiA9IHRoaXMuX3BhcnNlU3RyVG9PYmooa2VybmluZ0xpbmVzW2ldKTtcclxuICAgICAgICAgICAgICAgIGtlcm5pbmdEaWN0WyhrZXJuaW5nT2JqWydmaXJzdCddIGFzIG51bWJlcikgPDwgMTYgfCAoa2VybmluZ09ialsnc2Vjb25kJ10gYXMgbnVtYmVyKSAmIDB4ZmZmZl0gPSBrZXJuaW5nT2JqWydhbW91bnQnXSBhcyBudW1iZXI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZudDtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgbmV3IEZudExvYWRlcigpO1xyXG4iXX0=