"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.modelConvertRoutine = modelConvertRoutine;
const fs_extra_1 = __importDefault(require("fs-extra"));
const path_1 = __importDefault(require("path"));
/**
 * @param converterId
 * @param asset
 * @param assetDB
 * @param version
 * @param converter
 */
async function modelConvertRoutine(converterId, asset, assetDB, version, converter) {
    const workspace = path_1.default.join(assetDB.options.temp, converterId, asset.uuid);
    await fs_extra_1.default.ensureDir(workspace);
    const sourceTimeStamp = (await fs_extra_1.default.stat(asset.source)).mtimeMs;
    const statusFile = path_1.default.join(workspace, 'status.json');
    let oldStatus;
    try {
        oldStatus = await fs_extra_1.default.readJson(statusFile);
    }
    catch (err) {
        console.debug(`Status file ${statusFile}: ${err}`);
    }
    const outputDir = path_1.default.join(workspace, 'output');
    await fs_extra_1.default.ensureDir(outputDir);
    const converterOptions = converter.options;
    const isCacheAvailable = oldStatus !== undefined &&
        oldStatus.version === version &&
        oldStatus.sourceTimeStamp === sourceTimeStamp &&
        validateOptions(converterOptions, oldStatus.options) &&
        (await isOutputTimeStampsAvailable(outputDir, oldStatus.outputTimeStamps));
    if (!isCacheAvailable) {
        await fs_extra_1.default.emptyDir(outputDir);
        const ok = await converter.convert(asset, outputDir);
        if (!ok) {
            return;
        }
        const outputTimeStamps = {};
        await getMtimeTree(outputDir, outputTimeStamps);
        const status = {
            version,
            sourceTimeStamp,
            outputTimeStamps,
            options: converterOptions,
        };
        await fs_extra_1.default.ensureDir(path_1.default.dirname(statusFile));
        await fs_extra_1.default.writeJson(statusFile, status, { spaces: 2 });
    }
    await converter.printLogs?.(asset, outputDir);
    return await converter.get(asset, outputDir);
}
async function getMtimeTree(baseDir, record, prefix = undefined) {
    const items = await fs_extra_1.default.readdir(baseDir);
    await Promise.all(items.map(async (item) => {
        const file = path_1.default.join(baseDir, item);
        const stat = await fs_extra_1.default.stat(file);
        const key = prefix ? `${prefix}/${item}` : item;
        if (stat.isFile()) {
            record[key] = stat.mtimeMs;
        }
        else if (stat.isDirectory()) {
            await getMtimeTree(file, record, key);
        }
    }));
}
async function isOutputTimeStampsAvailable(baseDir, record) {
    return (await Promise.all(Object.entries(record).map(async ([key, mTimeMs]) => {
        const file = path_1.default.join(baseDir, path_1.default.join(...key.split('/')));
        try {
            const stat = await fs_extra_1.default.stat(file);
            return stat.mtimeMs === mTimeMs;
        }
        catch {
            return false;
        }
    }))).every((b) => b);
}
function validateOptions(newOptions, oldOptions) {
    return matchObject(newOptions, oldOptions);
}
function matchObject(lhs, rhs) {
    return matchLhs(lhs, rhs);
    function matchLhs(lhs, rhs) {
        if (Array.isArray(lhs)) {
            return Array.isArray(rhs) && lhs.length === rhs.length && lhs.every((v, i) => matchLhs(v, rhs[i]));
        }
        else if (typeof lhs === 'object' && lhs !== null) {
            return (typeof rhs === 'object' && rhs !== null && Object.keys(lhs).every((key) => matchLhs(lhs[key], rhs[key])));
        }
        else if (lhs === null) {
            return rhs === null;
        }
        else {
            return lhs === rhs;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kZWwtY29udmVydC1yb3V0aW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvYXNzZXRzL2Fzc2V0LWhhbmRsZXIvYXNzZXRzL3V0aWxzL21vZGVsLWNvbnZlcnQtcm91dGluZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQTJDQSxrREF1REM7QUFqR0Qsd0RBQTBCO0FBQzFCLGdEQUFzQjtBQWtDdEI7Ozs7OztHQU1HO0FBQ0ksS0FBSyxVQUFVLG1CQUFtQixDQUNyQyxXQUFtQixFQUNuQixLQUFZLEVBQ1osT0FBZ0IsRUFDaEIsT0FBZSxFQUNmLFNBQWdDO0lBRWhDLE1BQU0sU0FBUyxHQUFHLGNBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN6RSxNQUFNLGtCQUFFLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBRTlCLE1BQU0sZUFBZSxHQUFHLENBQUMsTUFBTSxrQkFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7SUFFOUQsTUFBTSxVQUFVLEdBQUcsY0FBRSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFDckQsSUFBSSxTQUFxQyxDQUFDO0lBQzFDLElBQUksQ0FBQztRQUNELFNBQVMsR0FBRyxNQUFNLGtCQUFFLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ1gsT0FBTyxDQUFDLEtBQUssQ0FBQyxlQUFlLFVBQVUsS0FBSyxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFRCxNQUFNLFNBQVMsR0FBRyxjQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FB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QVEsSUFBSSxHQUFHLEtBQUssSUFBSSxFQUFFLENBQUM7WUFDakQsT0FBTyxDQUNILE9BQU8sR0FBRyxLQUFLLFFBQVEsSUFBSSxHQUFHLEtBQUssSUFBSSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUUsR0FBVyxDQUFDLEdBQUcsQ0FBQyxFQUFHLEdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQzdILENBQUM7UUFDTixDQUFDO2FBQU0sSUFBSSxHQUFHLEtBQUssSUFBSSxFQUFFLENBQUM7WUFDdEIsT0FBTyxHQUFHLEtBQUssSUFBSSxDQUFDO1FBQ3hCLENBQUM7YUFBTSxDQUFDO1lBQ0osT0FBTyxHQUFHLEtBQUssR0FBRyxDQUFDO1FBQ3ZCLENBQUM7SUFDTCxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFzc2V0LCBBc3NldERCIH0gZnJvbSAnQGNvY29zL2Fzc2V0LWRiJztcclxuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcclxuaW1wb3J0IHBzIGZyb20gJ3BhdGgnO1xyXG5cclxuaW50ZXJmYWNlIElDb252ZXJ0U3RhdHVzIHtcclxuICAgIC8qKlxyXG4gICAgICogVmVyc2lvbiBvZiB0aGUgY29udmVydGVyLlxyXG4gICAgICovXHJcbiAgICB2ZXJzaW9uOiBzdHJpbmc7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBUaW1lIHN0YW1wIG9mIHNvdXJjZS5cclxuICAgICAqL1xyXG4gICAgc291cmNlVGltZVN0YW1wOiBudW1iZXI7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBUaW1lIHN0YW1wcyBvZiBlYWNoIHJlY3Vyc2l2ZSBmaWxlIGluIG91dHB1dCBkaXIuXHJcbiAgICAgKi9cclxuICAgIG91dHB1dFRpbWVTdGFtcHM6IFJlY29yZDxzdHJpbmcsIG51bWJlcj47XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDb252ZXJ0IG9wdGlvbnMsIHVzZWQgZm9yIGNhY2hlIHZhbGlkYXRpb24uXHJcbiAgICAgKi9cclxuICAgIG9wdGlvbnM/OiB1bmtub3duO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElBYnN0cmFjdENvbnZlcnRlcjxUPiB7XHJcbiAgICByZWFkb25seSBvcHRpb25zPzogdW5rbm93bjtcclxuXHJcbiAgICBjb252ZXJ0KGFzc2V0OiBBc3NldCwgb3V0cHV0RGlyOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+O1xyXG5cclxuICAgIHByaW50TG9ncz8oYXNzZXQ6IEFzc2V0LCBvdXRwdXREaXI6IHN0cmluZyk6IHZvaWQgfCBQcm9taXNlPHZvaWQ+O1xyXG5cclxuICAgIGdldChhc3NldDogQXNzZXQsIG91dHB1dERpcjogc3RyaW5nKTogVCB8IFByb21pc2U8VD47XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBAcGFyYW0gY29udmVydGVySWRcclxuICogQHBhcmFtIGFzc2V0XHJcbiAqIEBwYXJhbSBhc3NldERCXHJcbiAqIEBwYXJhbSB2ZXJzaW9uXHJcbiAqIEBwYXJhbSBjb252ZXJ0ZXJcclxuICovXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtb2RlbENvbnZlcnRSb3V0aW5lPFQ+KFxyXG4gICAgY29udmVydGVySWQ6IHN0cmluZyxcclxuICAgIGFzc2V0OiBBc3NldCxcclxuICAgIGFzc2V0REI6IEFzc2V0REIsXHJcbiAgICB2ZXJzaW9uOiBzdHJpbmcsXHJcbiAgICBjb252ZXJ0ZXI6IElBYnN0cmFjdENvbnZlcnRlcjxUPixcclxuKTogUHJvbWlzZTxUIHwgdW5kZWZpbmVkPiB7XHJcbiAgICBjb25zdCB3b3Jrc3BhY2UgPSBwcy5qb2luKGFzc2V0REIub3B0aW9ucy50ZW1wLCBjb252ZXJ0ZXJJZCwgYXNzZXQudXVpZCk7XHJcbiAgICBhd2FpdCBmcy5lbnN1cmVEaXIod29ya3NwYWNlKTtcclxuXHJcbiAgICBjb25zdCBzb3VyY2VUaW1lU3RhbXAgPSAoYXdhaXQgZnMuc3RhdChhc3NldC5zb3VyY2UpKS5tdGltZU1zO1xyXG5cclxuICAgIGNvbnN0IHN0YXR1c0ZpbGUgPSBwcy5qb2luKHdvcmtzcGFjZSwgJ3N0YXR1cy5qc29uJyk7XHJcbiAgICBsZXQgb2xkU3RhdHVzOiBJQ29udmVydFN0YXR1cyB8IHVuZGVmaW5lZDtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgb2xkU3RhdHVzID0gYXdhaXQgZnMucmVhZEpzb24oc3RhdHVzRmlsZSk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICBjb25zb2xlLmRlYnVnKGBTdGF0dXMgZmlsZSAke3N0YXR1c0ZpbGV9OiAke2Vycn1gKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBvdXRwdXREaXIgPSBwcy5qb2luKHdvcmtzcGFjZSwgJ291dHB1dCcpO1xyXG4gICAgYXdhaXQgZnMuZW5zdXJlRGlyKG91dHB1dERpcik7XHJcblxyXG4gICAgY29uc3QgY29udmVydGVyT3B0aW9ucyA9IGNvbnZlcnRlci5vcHRpb25zO1xyXG5cclxuICAgIGNvbnN0IGlzQ2FjaGVBdmFpbGFibGUgPVxyXG4gICAgICAgIG9sZFN0YXR1cyAhPT0gdW5kZWZpbmVkICYmXHJcbiAgICAgICAgb2xkU3RhdHVzLnZlcnNpb24gPT09IHZlcnNpb24gJiZcclxuICAgICAgICBvbGRTdGF0dXMuc291cmNlVGltZVN0YW1wID09PSBzb3VyY2VUaW1lU3RhbXAgJiZcclxuICAgICAgICB2YWxpZGF0ZU9wdGlvbnMoY29udmVydGVyT3B0aW9ucywgb2xkU3RhdHVzLm9wdGlvbnMpICYmXHJcbiAgICAgICAgKGF3YWl0IGlzT3V0cHV0VGltZVN0YW1wc0F2YWlsYWJsZShvdXRwdXREaXIsIG9sZFN0YXR1cy5vdXRwdXRUaW1lU3RhbXBzKSk7XHJcblxyXG4gICAgaWYgKCFpc0NhY2hlQXZhaWxhYmxlKSB7XHJcbiAgICAgICAgYXdhaXQgZnMuZW1wdHlEaXIob3V0cHV0RGlyKTtcclxuXHJcbiAgICAgICAgY29uc3Qgb2sgPSBhd2FpdCBjb252ZXJ0ZXIuY29udmVydChhc3NldCwgb3V0cHV0RGlyKTtcclxuICAgICAgICBpZiAoIW9rKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IG91dHB1dFRpbWVTdGFtcHM6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7fTtcclxuICAgICAgICBhd2FpdCBnZXRNdGltZVRyZWUob3V0cHV0RGlyLCBvdXRwdXRUaW1lU3RhbXBzKTtcclxuICAgICAgICBjb25zdCBzdGF0dXM6IElDb252ZXJ0U3RhdHVzID0ge1xyXG4gICAgICAgICAgICB2ZXJzaW9uLFxyXG4gICAgICAgICAgICBzb3VyY2VUaW1lU3RhbXAsXHJcbiAgICAgICAgICAgIG91dHB1dFRpbWVTdGFtcHMsXHJcbiAgICAgICAgICAgIG9wdGlvbnM6IGNvbnZlcnRlck9wdGlvbnMsXHJcbiAgICAgICAgfTtcclxuICAgICAgICBhd2FpdCBmcy5lbnN1cmVEaXIocHMuZGlybmFtZShzdGF0dXNGaWxlKSk7XHJcbiAgICAgICAgYXdhaXQgZnMud3JpdGVKc29uKHN0YXR1c0ZpbGUsIHN0YXR1cywgeyBzcGFjZXM6IDIgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgYXdhaXQgY29udmVydGVyLnByaW50TG9ncz8uKGFzc2V0LCBvdXRwdXREaXIpO1xyXG5cclxuICAgIHJldHVybiBhd2FpdCBjb252ZXJ0ZXIuZ2V0KGFzc2V0LCBvdXRwdXREaXIpO1xyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBnZXRNdGltZVRyZWUoYmFzZURpcjogc3RyaW5nLCByZWNvcmQ6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4sIHByZWZpeDogc3RyaW5nIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkKSB7XHJcbiAgICBjb25zdCBpdGVtcyA9IGF3YWl0IGZzLnJlYWRkaXIoYmFzZURpcik7XHJcbiAgICBhd2FpdCBQcm9taXNlLmFsbChcclxuICAgICAgICBpdGVtcy5tYXAoYXN5bmMgKGl0ZW0pID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZmlsZSA9IHBzLmpvaW4oYmFzZURpciwgaXRlbSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHN0YXQgPSBhd2FpdCBmcy5zdGF0KGZpbGUpO1xyXG4gICAgICAgICAgICBjb25zdCBrZXkgPSBwcmVmaXggPyBgJHtwcmVmaXh9LyR7aXRlbX1gIDogaXRlbTtcclxuICAgICAgICAgICAgaWYgKHN0YXQuaXNGaWxlKCkpIHtcclxuICAgICAgICAgICAgICAgIHJlY29yZFtrZXldID0gc3RhdC5tdGltZU1zO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXQuaXNEaXJlY3RvcnkoKSkge1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgZ2V0TXRpbWVUcmVlKGZpbGUsIHJlY29yZCwga2V5KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pLFxyXG4gICAgKTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gaXNPdXRwdXRUaW1lU3RhbXBzQXZhaWxhYmxlKGJhc2VEaXI6IHN0cmluZywgcmVjb3JkOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+KSB7XHJcbiAgICByZXR1cm4gKFxyXG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKFxyXG4gICAgICAgICAgICBPYmplY3QuZW50cmllcyhyZWNvcmQpLm1hcChhc3luYyAoW2tleSwgbVRpbWVNc10pID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZpbGUgPSBwcy5qb2luKGJhc2VEaXIsIHBzLmpvaW4oLi4ua2V5LnNwbGl0KCcvJykpKTtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhdCA9IGF3YWl0IGZzLnN0YXQoZmlsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN0YXQubXRpbWVNcyA9PT0gbVRpbWVNcztcclxuICAgICAgICAgICAgICAgIH0gY2F0Y2gge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgKVxyXG4gICAgKS5ldmVyeSgoYikgPT4gYik7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHZhbGlkYXRlT3B0aW9ucyhuZXdPcHRpb25zOiB1bmtub3duLCBvbGRPcHRpb25zOiB1bmtub3duKSB7XHJcbiAgICByZXR1cm4gbWF0Y2hPYmplY3QobmV3T3B0aW9ucywgb2xkT3B0aW9ucyk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG1hdGNoT2JqZWN0KGxoczogdW5rbm93biwgcmhzOiB1bmtub3duKSB7XHJcbiAgICByZXR1cm4gbWF0Y2hMaHMobGhzLCByaHMpO1xyXG5cclxuICAgIGZ1bmN0aW9uIG1hdGNoTGhzKGxoczogdW5rbm93biwgcmhzOiB1bmtub3duKTogYm9vbGVhbiB7XHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobGhzKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShyaHMpICYmIGxocy5sZW5ndGggPT09IHJocy5sZW5ndGggJiYgbGhzLmV2ZXJ5KCh2LCBpKSA9PiBtYXRjaExocyh2LCByaHNbaV0pKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBsaHMgPT09ICdvYmplY3QnICYmIGxocyAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICByZXR1cm4gKFxyXG4gICAgICAgICAgICAgICAgdHlwZW9mIHJocyA9PT0gJ29iamVjdCcgJiYgcmhzICE9PSBudWxsICYmIE9iamVjdC5rZXlzKGxocykuZXZlcnkoKGtleSkgPT4gbWF0Y2hMaHMoKGxocyBhcyBhbnkpW2tleV0sIChyaHMgYXMgYW55KVtrZXldKSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGxocyA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICByZXR1cm4gcmhzID09PSBudWxsO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBsaHMgPT09IHJocztcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19