"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.GltfMeshHandler = void 0;
const reader_manager_1 = require("./reader-manager");
const utils_1 = require("../../utils");
const cc_1 = require("cc");
const fs_extra_1 = __importDefault(require("fs-extra"));
const uv_unwrap_1 = require("../utils/uv-unwrap");
const fs_extra_2 = require("fs-extra");
const meshOptimizer_1 = require("./meshOptimizer");
const fbx_1 = __importDefault(require("../fbx"));
const gltf_1 = __importDefault(require("../gltf"));
exports.GltfMeshHandler = {
    // Handler 的名字，用于指定 Handler as 等
    name: 'gltf-mesh',
    // 引擎内对应的类型
    assetType: 'cc.Mesh',
    iconInfo: {
        default: {
            type: 'icon',
            value: 'gltf-mesh',
        },
        async generateThumbnail(asset) {
            const result = {
                type: 'icon',
                value: 'gltf-mesh',
            };
            // TODO: 实现生成 mesh 的缩略图
            return result;
        },
    },
    /**
     * 允许这种类型的资源进行实例化
     */
    instantiation: '.mesh',
    importer: {
        // 版本号如果变更，则会强制重新导入
        version: '1.1.1',
        /**
         * 实际导入流程
         * 需要自己控制是否生成、拷贝文件
         *
         * 返回是否导入成功的 boolean
         * 如果返回 false，则下次启动还会重新导入
         * @param asset
         */
        async import(asset) {
            // This could not happen
            if (!asset.parent) {
                return false;
            }
            let version = gltf_1.default.importer.version;
            if (asset.parent.meta.importer === 'fbx') {
                version = fbx_1.default.importer.version;
            }
            // Fetch the gltf convert associated with parent (gltf)asset
            const gltfConverter = await reader_manager_1.glTfReaderManager.getOrCreate(asset.parent, version);
            const generateLightmapUV = asset.parent.userData.generateLightmapUVNode;
            const gltfUserData = asset.parent.userData;
            const assetUserData = asset.userData;
            // Create the mesh asset
            let mesh = gltfConverter.createMesh(asset.userData.gltfIndex, generateLightmapUV, gltfUserData.addVertexColor ?? false);
            // 新增的 mesh 需要进行减面
            if (assetUserData.lodOptions) {
                const defaultOption = (0, meshOptimizer_1.getDefaultSimplifyOptions)();
                defaultOption.targetRatio = assetUserData.lodOptions.faceCount;
                mesh = await (0, meshOptimizer_1.simplifyMesh)(mesh, defaultOption);
            }
            // 记录 mesh 的面数
            let meshTriangleCount = 0;
            assetUserData.triangleCount = 0;
            mesh.struct.primitives?.forEach((subMesh) => {
                if (subMesh && subMesh.indexView) {
                    meshTriangleCount += subMesh.indexView.count / 3;
                }
            });
            assetUserData.triangleCount = meshTriangleCount;
            mesh.allowDataAccess = asset.parent.userData.allowMeshDataAccess ?? true;
            if (generateLightmapUV) {
                let hasUV1 = false;
                const vArray = [], iArray = [];
                //Write out vb and ib
                let subMeshStartIndex = 0;
                for (let iSubMesh = 0; iSubMesh < mesh.struct.primitives.length; iSubMesh++) {
                    const vPosArray = mesh.readAttribute(iSubMesh, cc_1.gfx.AttributeName.ATTR_POSITION);
                    let indexArray;
                    if (mesh.struct.vertexBundles[iSubMesh].view.stride === 2) {
                        indexArray = mesh.readIndices(iSubMesh);
                    }
                    else if (mesh.struct.vertexBundles[iSubMesh].view.stride === 4) {
                        indexArray = mesh.readIndices(iSubMesh);
                    }
                    else {
                        console.warn('Invalid indeces stride');
                        indexArray = [];
                    }
                    for (let i = 0; i < vPosArray.length; ++i) {
                        vArray.push(vPosArray[i]);
                    }
                    for (let i = 0; i < indexArray.length; ++i) {
                        iArray.push(indexArray[i] + subMeshStartIndex);
                    }
                    if (mesh.readAttribute(iSubMesh, cc_1.gfx.AttributeName.ATTR_TEX_COORD1)) {
                        hasUV1 = true;
                    }
                    subMeshStartIndex += mesh.struct.vertexBundles[iSubMesh].view.count;
                }
                const totalVertex = vArray.length / 3;
                const total = new Uint8Array(8 + vArray.length * 4 + iArray.length * 4);
                const vInt32ptr = new Int32Array(total.buffer, 0);
                vInt32ptr[0] = totalVertex;
                vInt32ptr[1] = iArray.length;
                const vPosFlt32ptr = new Float32Array(total.buffer, 8);
                const idxInt32Ptr = new Int32Array(total.buffer, 8 + vArray.length * 4);
                for (let i = 0; i < vArray.length; i++) {
                    vPosFlt32ptr[i] = vArray[i];
                }
                for (let i = 0; i < iArray.length; i++) {
                    idxInt32Ptr[i] = iArray[i];
                }
                //save out file.
                const fileName = asset.uuid;
                const folderToSave = asset.temp;
                await (0, fs_extra_2.ensureDir)(folderToSave);
                await fs_extra_1.default.promises.writeFile(`${folderToSave}/${fileName}_in.bin`, total);
                await (0, uv_unwrap_1.unwrapLightmapUV)(`${folderToSave}/${fileName}_in.bin`, `${folderToSave}/${fileName}_out.bin`);
                const f2 = await fs_extra_1.default.promises.readFile(`${folderToSave}/${fileName}_out.bin`);
                const bData = new Uint8Array(f2);
                const vPositionArr = new Float32Array(bData.buffer, 4);
                let index = 0;
                for (let iSubMesh = 0; iSubMesh < mesh.struct.primitives.length; iSubMesh++) {
                    const lightmapUV = mesh.readAttribute(iSubMesh, cc_1.gfx.AttributeName.ATTR_TEX_COORD1);
                    const attrs = mesh.struct.vertexBundles[iSubMesh].attributes;
                    let uvOffset = 0;
                    if (lightmapUV.length > 0) {
                        for (let i = 0; i < attrs.length; i++) {
                            if (attrs[i].name === cc_1.gfx.AttributeName.ATTR_TEX_COORD1) {
                                break;
                            }
                            else {
                                const fInfo = mesh.readAttributeFormat(iSubMesh, attrs[i].name);
                                if (fInfo) {
                                    uvOffset += fInfo.size;
                                }
                            }
                        }
                        if (uvOffset > 0) {
                            for (let i = 0; i < mesh.struct.vertexBundles[iSubMesh].view.count; i++) {
                                const tOffset = mesh.struct.vertexBundles[iSubMesh].view.offset +
                                    uvOffset +
                                    i * mesh.struct.vertexBundles[iSubMesh].view.stride;
                                const view = new DataView(mesh.data.buffer);
                                view.setFloat32(tOffset, vPositionArr[index], true);
                                view.setFloat32(tOffset + 4, vPositionArr[index + 1], true);
                                index += 2;
                            }
                        }
                    }
                }
            }
            // simplify pass
            if (gltfUserData.meshSimplify && gltfUserData.meshSimplify.enable) {
                mesh = await (0, meshOptimizer_1.simplifyMesh)(mesh, gltfUserData.meshSimplify);
            }
            // optimize pass
            if (gltfUserData.meshOptimize && gltfUserData.meshOptimize.enable) {
                mesh = await (0, meshOptimizer_1.optimizeMesh)(mesh, gltfUserData.meshOptimize);
            }
            // cluster pass
            if (gltfUserData.meshCluster && gltfUserData.meshCluster.enable) {
                mesh = await (0, meshOptimizer_1.clusterizeMesh)(mesh, gltfUserData.meshCluster);
            }
            // compress pass
            if (gltfUserData.meshCompress && gltfUserData.meshCompress.enable) {
                mesh = await (0, meshOptimizer_1.compressMesh)(mesh, gltfUserData.meshCompress);
            }
            if (mesh.data.byteLength !== 0) {
                // Do not create an empty file for empty binary data
                mesh._setRawAsset('.bin');
                await asset.saveToLibrary('.bin', Buffer.from(mesh.data));
            }
            // Save the mesh asset into library
            const serializeJSON = EditorExtends.serialize(mesh);
            await asset.saveToLibrary('.json', serializeJSON);
            const depends = (0, utils_1.getDependUUIDList)(serializeJSON);
            asset.setData('depends', depends);
            return true;
        },
    },
};
exports.default = exports.GltfMeshHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL2Fzc2V0cy9hc3NldC1oYW5kbGVyL2Fzc2V0cy9nbHRmL21lc2gudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EscURBQXFEO0FBQ3JELHVDQUFnRDtBQUVoRCwyQkFBeUI7QUFDekIsd0RBQTBCO0FBQzFCLGtEQUFzRDtBQUN0RCx1Q0FBcUM7QUFFckMsbURBQXNIO0FBQ3RILGlEQUFnQztBQUNoQyxtREFBa0M7QUFFckIsUUFBQSxlQUFlLEdBQWlCO0lBQ3pDLGdDQUFnQztJQUNoQyxJQUFJLEVBQUUsV0FBVztJQUVqQixXQUFXO0lBQ1gsU0FBUyxFQUFFLFNBQVM7SUFFcEIsUUFBUSxFQUFFO1FBQ04sT0FBTyxFQUFFO1lBQ0wsSUFBSSxFQUFFLE1BQU07WUFDWixLQUFLLEVBQUUsV0FBVztTQUNyQjtRQUNELEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxLQUFZO1lBQ2hDLE1BQU0sTUFBTSxHQUFrQjtnQkFDMUIsSUFBSSxFQUFFLE1BQU07Z0JBQ1osS0FBSyxFQUFFLFdBQVc7YUFDckIsQ0FBQztZQUVGLHVCQUF1QjtZQUN2QixPQUFPLE1BQU0sQ0FBQztRQUNsQixDQUFDO0tBQ0o7SUFFRDs7T0FFRztJQUNILGFBQWEsRUFBRSxPQUFPO0lBRXRCLFFBQVEsRUFBRTtRQUNOLG1CQUFtQjtRQUNuQixPQUFPLEVBQUUsT0FBTztRQUVoQjs7Ozs7OztXQU9HO1FBQ0gsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFtQjtZQUM1Qix3QkFBd0I7WUFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDaEIsT0FBTyxLQUFLLENBQUM7WUFDakIsQ0FBQztZQUNELElBQUksT0FBTyxHQUFHLGNBQVcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDO1lBQzNDLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMs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WUFFbEMsT0FBTyxJQUFJLENBQUM7UUFDaEIsQ0FBQztLQUNKO0NBQ0osQ0FBQztBQUVGLGtCQUFlLHVCQUFlLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBc3NldCwgVmlydHVhbEFzc2V0IH0gZnJvbSAnQGNvY29zL2Fzc2V0LWRiJztcclxuaW1wb3J0IHsgZ2xUZlJlYWRlck1hbmFnZXIgfSBmcm9tICcuL3JlYWRlci1tYW5hZ2VyJztcclxuaW1wb3J0IHsgZ2V0RGVwZW5kVVVJRExpc3QgfSBmcm9tICcuLi8uLi91dGlscyc7XHJcbmltcG9ydCB7IEdsVEZVc2VyRGF0YSwgSVZpcnR1YWxBc3NldFVzZXJEYXRhIH0gZnJvbSAnLi4vLi4vLi4vQHR5cGVzL3VzZXJEYXRhcyc7XHJcbmltcG9ydCB7IGdmeCB9IGZyb20gJ2NjJztcclxuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcclxuaW1wb3J0IHsgdW53cmFwTGlnaHRtYXBVViB9IGZyb20gJy4uL3V0aWxzL3V2LXVud3JhcCc7XHJcbmltcG9ydCB7IGVuc3VyZURpciB9IGZyb20gJ2ZzLWV4dHJhJztcclxuaW1wb3J0IHsgQXNzZXRIYW5kbGVyLCBUaHVtYm5haWxJbmZvIH0gZnJvbSAnLi4vLi4vLi4vQHR5cGVzL3Byb3RlY3RlZCc7XHJcbmltcG9ydCB7IG9wdGltaXplTWVzaCwgY2x1c3Rlcml6ZU1lc2gsIHNpbXBsaWZ5TWVzaCwgZ2V0RGVmYXVsdFNpbXBsaWZ5T3B0aW9ucywgY29tcHJlc3NNZXNoIH0gZnJvbSAnLi9tZXNoT3B0aW1pemVyJztcclxuaW1wb3J0IEZieEhhbmRsZXIgZnJvbSAnLi4vZmJ4JztcclxuaW1wb3J0IEdsdGZIYW5kbGVyIGZyb20gJy4uL2dsdGYnO1xyXG5cclxuZXhwb3J0IGNvbnN0IEdsdGZNZXNoSGFuZGxlcjogQXNzZXRIYW5kbGVyID0ge1xyXG4gICAgLy8gSGFuZGxlciDnmoTlkI3lrZfvvIznlKjkuo7mjIflrpogSGFuZGxlciBhcyDnrYlcclxuICAgIG5hbWU6ICdnbHRmLW1lc2gnLFxyXG5cclxuICAgIC8vIOW8leaTjuWGheWvueW6lOeahOexu+Wei1xyXG4gICAgYXNzZXRUeXBlOiAnY2MuTWVzaCcsXHJcblxyXG4gICAgaWNvbkluZm86IHtcclxuICAgICAgICBkZWZhdWx0OiB7XHJcbiAgICAgICAgICAgIHR5cGU6ICdpY29uJyxcclxuICAgICAgICAgICAgdmFsdWU6ICdnbHRmLW1lc2gnLFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgYXN5bmMgZ2VuZXJhdGVUaHVtYm5haWwoYXNzZXQ6IEFzc2V0KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdDogVGh1bWJuYWlsSW5mbyA9IHtcclxuICAgICAgICAgICAgICAgIHR5cGU6ICdpY29uJyxcclxuICAgICAgICAgICAgICAgIHZhbHVlOiAnZ2x0Zi1tZXNoJyxcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIC8vIFRPRE86IOWunueOsOeUn+aIkCBtZXNoIOeahOe8qeeVpeWbvlxyXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgIH0sXHJcbiAgICB9LFxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5YWB6K646L+Z56eN57G75Z6L55qE6LWE5rqQ6L+b6KGM5a6e5L6L5YyWXHJcbiAgICAgKi9cclxuICAgIGluc3RhbnRpYXRpb246ICcubWVzaCcsXHJcblxyXG4gICAgaW1wb3J0ZXI6IHtcclxuICAgICAgICAvLyDniYjmnKzlj7flpoLmnpzlj5jmm7TvvIzliJnkvJrlvLrliLbph43mlrDlr7zlhaVcclxuICAgICAgICB2ZXJzaW9uOiAnMS4xLjEnLFxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiDlrp7pmYXlr7zlhaXmtYHnqItcclxuICAgICAgICAgKiDpnIDopoHoh6rlt7HmjqfliLbmmK/lkKbnlJ/miJDjgIHmi7fotJ3mlofku7ZcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIOi/lOWbnuaYr+WQpuWvvOWFpeaIkOWKn+eahCBib29sZWFuXHJcbiAgICAgICAgICog5aaC5p6c6L+U5ZueIGZhbHNl77yM5YiZ5LiL5qyh5ZCv5Yqo6L+Y5Lya6YeN5paw5a+85YWlXHJcbiAgICAgICAgICogQHBhcmFtIGFzc2V0XHJcbiAgICAgICAgICovXHJcbiAgICAgICAgYXN5bmMgaW1wb3J0KGFzc2V0OiBWaXJ0dWFsQXNzZXQpIHtcclxuICAgICAgICAgICAgLy8gVGhpcyBjb3VsZCBub3QgaGFwcGVuXHJcbiAgICAgICAgICAgIGlmICghYXNzZXQucGFyZW50KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGV0IHZlcnNpb24gPSBHbHRmSGFuZGxlci5pbXBvcnRlci52ZXJzaW9uO1xyXG4gICAgICAgICAgICBpZiAoYXNzZXQucGFyZW50Lm1ldGEuaW1wb3J0ZXIgPT09ICdmYngnKSB7XHJcbiAgICAgICAgICAgICAgICB2ZXJzaW9uID0gRmJ4SGFuZGxlci5pbXBvcnRlci52ZXJzaW9uO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIEZldGNoIHRoZSBnbHRmIGNvbnZlcnQgYXNzb2NpYXRlZCB3aXRoIHBhcmVudCAoZ2x0Zilhc3NldFxyXG4gICAgICAgICAgICBjb25zdCBnbHRmQ29udmVydGVyID0gYXdhaXQgZ2xUZlJlYWRlck1hbmFnZXIuZ2V0T3JDcmVhdGUoYXNzZXQucGFyZW50IGFzIEFzc2V0LCB2ZXJzaW9uKTtcclxuICAgICAgICAgICAgY29uc3QgZ2VuZXJhdGVMaWdodG1hcFVWID0gKGFzc2V0LnBhcmVudC51c2VyRGF0YSBhcyBHbFRGVXNlckRhdGEpLmdlbmVyYXRlTGlnaHRtYXBVVk5vZGU7XHJcbiAgICAgICAgICAgIGNvbnN0IGdsdGZVc2VyRGF0YSA9IGFzc2V0LnBhcmVudC51c2VyRGF0YSBhcyBHbFRGVXNlckRhdGE7XHJcbiAgICAgICAgICAgIGNvbnN0IGFzc2V0VXNlckRhdGEgPSBhc3NldC51c2VyRGF0YSBhcyBJVmlydHVhbEFzc2V0VXNlckRhdGE7XHJcblxyXG4gICAgICAgICAgICAvLyBDcmVhdGUgdGhlIG1lc2ggYXNzZXRcclxuICAgICAgICAgICAgbGV0IG1lc2ggPSBnbHRmQ29udmVydGVyLmNyZWF0ZU1lc2goXHJcbiAgICAgICAgICAgICAgICBhc3NldC51c2VyRGF0YS5nbHRmSW5kZXggYXMgbnVtYmVyLFxyXG4gICAgICAgICAgICAgICAgZ2VuZXJhdGVMaWdodG1hcFVWLFxyXG4gICAgICAgICAgICAgICAgZ2x0ZlVzZXJEYXRhLmFkZFZlcnRleENvbG9yID8/IGZhbHNlLFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAvLyDmlrDlop7nmoQgbWVzaCDpnIDopoHov5vooYzlh4/pnaJcclxuICAgICAgICAgICAgaWYgKGFzc2V0VXNlckRhdGEubG9kT3B0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGVmYXVsdE9wdGlvbiA9IGdldERlZmF1bHRTaW1wbGlmeU9wdGlvbnMoKTtcclxuICAgICAgICAgICAgICAgIGRlZmF1bHRPcHRpb24udGFyZ2V0UmF0aW8gPSBhc3NldFVzZXJEYXRhLmxvZE9wdGlvbnMuZmFjZUNvdW50O1xyXG4gICAgICAgICAgICAgICAgbWVzaCA9IGF3YWl0IHNpbXBsaWZ5TWVzaChtZXNoLCBkZWZhdWx0T3B0aW9uKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyDorrDlvZUgbWVzaCDnmoTpnaLmlbBcclxuICAgICAgICAgICAgbGV0IG1lc2hUcmlhbmdsZUNvdW50ID0gMDtcclxuICAgICAgICAgICAgYXNzZXRVc2VyRGF0YS50cmlhbmdsZUNvdW50ID0gMDtcclxuICAgICAgICAgICAgbWVzaC5zdHJ1Y3QucHJpbWl0aXZlcz8uZm9yRWFjaCgoc3ViTWVzaDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3ViTWVzaCAmJiBzdWJNZXNoLmluZGV4Vmlldykge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lc2hUcmlhbmdsZUNvdW50ICs9IHN1Yk1lc2guaW5kZXhWaWV3LmNvdW50IC8gMztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGFzc2V0VXNlckRhdGEudHJpYW5nbGVDb3VudCA9IG1lc2hUcmlhbmdsZUNvdW50O1xyXG5cclxuICAgICAgICAgICAgbWVzaC5hbGxvd0RhdGFBY2Nlc3MgPSAoYXNzZXQucGFyZW50LnVzZXJEYXRhIGFzIEdsVEZVc2VyRGF0YSkuYWxsb3dNZXNoRGF0YUFjY2VzcyA/PyB0cnVlO1xyXG4gICAgICAgICAgICBpZiAoZ2VuZXJhdGVMaWdodG1hcFVWKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgaGFzVVYxID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB2QXJyYXk6IG51bWJlcltdID0gW10sXHJcbiAgICAgICAgICAgICAgICAgICAgaUFycmF5OiBudW1iZXJbXSA9IFtdO1xyXG4gICAgICAgICAgICAgICAgLy9Xcml0ZSBvdXQgdmIgYW5kIGliXHJcbiAgICAgICAgICAgICAgICBsZXQgc3ViTWVzaFN0YXJ0SW5kZXggPSAwO1xyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaVN1Yk1lc2ggPSAwOyBpU3ViTWVzaCA8IG1lc2guc3RydWN0LnByaW1pdGl2ZXMubGVuZ3RoOyBpU3ViTWVzaCsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdlBvc0FycmF5ID0gbWVzaC5yZWFkQXR0cmlidXRlKGlTdWJNZXNoLCBnZnguQXR0cmlidXRlTmFtZS5BVFRSX1BPU0lUSU9OKSBhcyBGbG9hdDMyQXJyYXk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGluZGV4QXJyYXk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1lc2guc3RydWN0LnZlcnRleEJ1bmRsZXNbaVN1Yk1lc2hdLnZpZXcuc3RyaWRlID09PSAyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4QXJyYXkgPSBtZXNoLnJlYWRJbmRpY2VzKGlTdWJNZXNoKSBhcyBVaW50MTZBcnJheTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1lc2guc3RydWN0LnZlcnRleEJ1bmRsZXNbaVN1Yk1lc2hdLnZpZXcuc3RyaWRlID09PSA0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4QXJyYXkgPSBtZXNoLnJlYWRJbmRpY2VzKGlTdWJNZXNoKSBhcyBVaW50MzJBcnJheTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ0ludmFsaWQgaW5kZWNlcyBzdHJpZGUnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXhBcnJheSA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZQb3NBcnJheS5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2QXJyYXkucHVzaCh2UG9zQXJyYXlbaV0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZGV4QXJyYXkubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaUFycmF5LnB1c2goaW5kZXhBcnJheVtpXSArIHN1Yk1lc2hTdGFydEluZGV4KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1lc2gucmVhZEF0dHJpYnV0ZShpU3ViTWVzaCwgZ2Z4LkF0dHJpYnV0ZU5hbWUuQVRUUl9URVhfQ09PUkQxKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBoYXNVVjEgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBzdWJNZXNoU3RhcnRJbmRleCArPSBtZXNoLnN0cnVjdC52ZXJ0ZXhCdW5kbGVzW2lTdWJNZXNoXS52aWV3LmNvdW50O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY29uc3QgdG90YWxWZXJ0ZXggPSB2QXJyYXkubGVuZ3RoIC8gMztcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsID0gbmV3IFVpbnQ4QXJyYXkoOCArIHZBcnJheS5sZW5ndGggKiA0ICsgaUFycmF5Lmxlbmd0aCAqIDQpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdkludDMycHRyID0gbmV3IEludDMyQXJyYXkodG90YWwuYnVmZmVyLCAwKTtcclxuICAgICAgICAgICAgICAgIHZJbnQzMnB0clswXSA9IHRvdGFsVmVydGV4O1xyXG4gICAgICAgICAgICAgICAgdkludDMycHRyWzFdID0gaUFycmF5Lmxlbmd0aDtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHZQb3NGbHQzMnB0ciA9IG5ldyBGbG9hdDMyQXJyYXkodG90YWwuYnVmZmVyLCA4KTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGlkeEludDMyUHRyID0gbmV3IEludDMyQXJyYXkodG90YWwuYnVmZmVyLCA4ICsgdkFycmF5Lmxlbmd0aCAqIDQpO1xyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2QXJyYXkubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICB2UG9zRmx0MzJwdHJbaV0gPSB2QXJyYXlbaV07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGlBcnJheS5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlkeEludDMyUHRyW2ldID0gaUFycmF5W2ldO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy9zYXZlIG91dCBmaWxlLlxyXG4gICAgICAgICAgICAgICAgY29uc3QgZmlsZU5hbWUgPSBhc3NldC51dWlkO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZm9sZGVyVG9TYXZlID0gYXNzZXQudGVtcDtcclxuICAgICAgICAgICAgICAgIGF3YWl0IGVuc3VyZURpcihmb2xkZXJUb1NhdmUpO1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgZnMucHJvbWlzZXMud3JpdGVGaWxlKGAke2ZvbGRlclRvU2F2ZX0vJHtmaWxlTmFtZX1faW4uYmluYCwgdG90YWwpO1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgdW53cmFwTGlnaHRtYXBVVihgJHtmb2xkZXJUb1NhdmV9LyR7ZmlsZU5hbWV9X2luLmJpbmAsIGAke2ZvbGRlclRvU2F2ZX0vJHtmaWxlTmFtZX1fb3V0LmJpbmApO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZjIgPSBhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZShgJHtmb2xkZXJUb1NhdmV9LyR7ZmlsZU5hbWV9X291dC5iaW5gKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGJEYXRhID0gbmV3IFVpbnQ4QXJyYXkoZjIpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdlBvc2l0aW9uQXJyID0gbmV3IEZsb2F0MzJBcnJheShiRGF0YS5idWZmZXIsIDQpO1xyXG4gICAgICAgICAgICAgICAgbGV0IGluZGV4ID0gMDtcclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGlTdWJNZXNoID0gMDsgaVN1Yk1lc2ggPCBtZXNoLnN0cnVjdC5wcmltaXRpdmVzLmxlbmd0aDsgaVN1Yk1lc2grKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpZ2h0bWFwVVYgPSBtZXNoLnJlYWRBdHRyaWJ1dGUoaVN1Yk1lc2gsIGdmeC5BdHRyaWJ1dGVOYW1lLkFUVFJfVEVYX0NPT1JEMSkgYXMgRmxvYXQzMkFycmF5O1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJzID0gbWVzaC5zdHJ1Y3QudmVydGV4QnVuZGxlc1tpU3ViTWVzaF0uYXR0cmlidXRlcztcclxuICAgICAgICAgICAgICAgICAgICBsZXQgdXZPZmZzZXQgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChsaWdodG1hcFVWLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhdHRycy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJzW2ldLm5hbWUgPT09IGdmeC5BdHRyaWJ1dGVOYW1lLkFUVFJfVEVYX0NPT1JEMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmSW5mbyA9IG1lc2gucmVhZEF0dHJpYnV0ZUZvcm1hdChpU3ViTWVzaCwgYXR0cnNbaV0ubmFtZSBhcyBnZnguQXR0cmlidXRlTmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZJbmZvKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHV2T2Zmc2V0ICs9IGZJbmZvLnNpemU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1dk9mZnNldCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWVzaC5zdHJ1Y3QudmVydGV4QnVuZGxlc1tpU3ViTWVzaF0udmlldy5jb3VudDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdE9mZnNldCA9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc2guc3RydWN0LnZlcnRleEJ1bmRsZXNbaVN1Yk1lc2hdLnZpZXcub2Zmc2V0ICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXZPZmZzZXQgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpICogbWVzaC5zdHJ1Y3QudmVydGV4QnVuZGxlc1tpU3ViTWVzaF0udmlldy5zdHJpZGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldyhtZXNoLmRhdGEuYnVmZmVyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWV3LnNldEZsb2F0MzIodE9mZnNldCwgdlBvc2l0aW9uQXJyW2luZGV4XSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlldy5zZXRGbG9hdDMyKHRPZmZzZXQgKyA0LCB2UG9zaXRpb25BcnJbaW5kZXggKyAxXSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gMjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gc2ltcGxpZnkgcGFzc1xyXG4gICAgICAgICAgICBpZiAoZ2x0ZlVzZXJEYXRhLm1lc2hTaW1wbGlmeSAmJiBnbHRmVXNlckRhdGEubWVzaFNpbXBsaWZ5LmVuYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgbWVzaCA9IGF3YWl0IHNpbXBsaWZ5TWVzaChtZXNoLCBnbHRmVXNlckRhdGEubWVzaFNpbXBsaWZ5KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gb3B0aW1pemUgcGFzc1xyXG4gICAgICAgICAgICBpZiAoZ2x0ZlVzZXJEYXRhLm1lc2hPcHRpbWl6ZSAmJiBnbHRmVXNlckRhdGEubWVzaE9wdGltaXplLmVuYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgbWVzaCA9IGF3YWl0IG9wdGltaXplTWVzaChtZXNoLCBnbHRmVXNlckRhdGEubWVzaE9wdGltaXplKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gY2x1c3RlciBwYXNzXHJcbiAgICAgICAgICAgIGlmIChnbHRmVXNlckRhdGEubWVzaENsdXN0ZXIgJiYgZ2x0ZlVzZXJEYXRhLm1lc2hDbHVzdGVyLmVuYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgbWVzaCA9IGF3YWl0IGNsdXN0ZXJpemVNZXNoKG1lc2gsIGdsdGZVc2VyRGF0YS5tZXNoQ2x1c3Rlcik7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIGNvbXByZXNzIHBhc3NcclxuICAgICAgICAgICAgaWYgKGdsdGZVc2VyRGF0YS5tZXNoQ29tcHJlc3MgJiYgZ2x0ZlVzZXJEYXRhLm1lc2hDb21wcmVzcy5lbmFibGUpIHtcclxuICAgICAgICAgICAgICAgIG1lc2ggPSBhd2FpdCBjb21wcmVzc01lc2gobWVzaCwgZ2x0ZlVzZXJEYXRhLm1lc2hDb21wcmVzcyk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChtZXNoLmRhdGEuYnl0ZUxlbmd0aCAhPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgLy8gRG8gbm90IGNyZWF0ZSBhbiBlbXB0eSBmaWxlIGZvciBlbXB0eSBiaW5hcnkgZGF0YVxyXG4gICAgICAgICAgICAgICAgbWVzaC5fc2V0UmF3QXNzZXQoJy5iaW4nKTtcclxuICAgICAgICAgICAgICAgIGF3YWl0IGFzc2V0LnNhdmVUb0xpYnJhcnkoJy5iaW4nLCBCdWZmZXIuZnJvbShtZXNoLmRhdGEpKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gU2F2ZSB0aGUgbWVzaCBhc3NldCBpbnRvIGxpYnJhcnlcclxuICAgICAgICAgICAgY29uc3Qgc2VyaWFsaXplSlNPTiA9IEVkaXRvckV4dGVuZHMuc2VyaWFsaXplKG1lc2gpO1xyXG4gICAgICAgICAgICBhd2FpdCBhc3NldC5zYXZlVG9MaWJyYXJ5KCcuanNvbicsIHNlcmlhbGl6ZUpTT04pO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgZGVwZW5kcyA9IGdldERlcGVuZFVVSURMaXN0KHNlcmlhbGl6ZUpTT04pO1xyXG4gICAgICAgICAgICBhc3NldC5zZXREYXRhKCdkZXBlbmRzJywgZGVwZW5kcyk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9LFxyXG4gICAgfSxcclxufTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IEdsdGZNZXNoSGFuZGxlcjtcclxuIl19