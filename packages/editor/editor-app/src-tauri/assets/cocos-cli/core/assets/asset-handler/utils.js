'use strict';
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MigrateStep = void 0;
exports.i18nTranslate = i18nTranslate;
exports.getDependUUIDList = getDependUUIDList;
exports.getDependList = getDependList;
exports.deserialize = deserialize;
exports.getDeserializeResult = getDeserializeResult;
exports.linkToAssetTarget = linkToAssetTarget;
exports.clamp = clamp;
exports.getPixiel = getPixiel;
exports.getTrimRect = getTrimRect;
exports.removeNull = removeNull;
exports.openCode = openCode;
exports.mergeMeta = mergeMeta;
exports.getMediaDuration = getMediaDuration;
const i18n_1 = __importDefault(require("../../base/i18n"));
const utils_1 = __importDefault(require("../../base/utils"));
const missing_class_reporter_1 = require("../../engine/editor-extends/missing-reporter/missing-class-reporter");
function i18nTranslate(key, ...args) {
    let translated = i18n_1.default.t(key);
    if (typeof args[0] === 'object') {
        const paramArgument = args[0];
        const matches = translated.match(/{(\w+)}/g);
        if (matches) {
            for (const match of matches) {
                const name = match.substr(1, match.length - 2);
                translated = translated.replace(match, paramArgument[name]);
            }
        }
    }
    return translated;
}
function getDependUUIDList(content, uuid) {
    if (typeof content === 'string') {
        // 注意：此方法无法匹配出脚本引用的 uuid
        let arr = content.match(/[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}(@[a-z0-9]+){0,}/g);
        if (arr) {
            // https://stackoverflow.com/questions/32813720/nodejs-profiling-parent-in-sliced-string
            arr = JSON.parse(JSON.stringify(Array.from(new Set(arr)).filter((id) => id !== uuid)));
        }
        // const arr = content.match(/"__uuid__":( )?"[^"]+/g);
        return arr || [];
    }
    // console.warn('Unable to extract dependencies properly');
    return getDeserializeResult(content).uuids;
}
function getDependList(content) {
    if (typeof content === 'string') {
        // TODO 此方式依赖了目前的字符串格式，有风险，但由于目前脚本加载无法在导入之前完成，无法正常反序列化
        const uuids = getDependUUIDList(content);
        const classTypes = content.match(/"__type__":\s*"([0-9a-zA-Z+/]{22,23})"/g);
        const dependScriptUuids = classTypes ? classTypes.toString().match(/[0-9a-zA-Z+/]{22,23}/g) || [] : [];
        // https://stackoverflow.com/questions/32813720/nodejs-profiling-parent-in-sliced-string
        return {
            uuids,
            dependScriptUuids: Array.from(new Set(dependScriptUuids.map((classId) => utils_1.default.UUID.decompressUUID(classId)))),
        };
    }
    const info = getDeserializeResult(content);
    return {
        uuids: info.uuids,
        dependScriptUuids: info.dependScriptUuids,
    };
}
function deserialize(json) {
    return getDeserializeResult(json).instance;
}
function getDeserializeResult(json) {
    const deserializeDetails = new cc.deserialize.Details();
    deserializeDetails.reset();
    missing_class_reporter_1.MissingClass.reset();
    missing_class_reporter_1.MissingClass.hasMissingClass = false;
    const dependScriptID = new Set();
    function classFinder(classId) {
        if (utils_1.default.UUID.isUUID(classId)) {
            dependScriptID.add(utils_1.default.UUID.decompressUUID(classId));
        }
        return missing_class_reporter_1.MissingClass.classFinder(classId);
    }
    const deserializedAsset = cc.deserialize(json, deserializeDetails, {
        classFinder,
    });
    deserializeDetails.assignAssetsBy(function (uuid, options) {
        return EditorExtends.serialize.asAsset(uuid);
    });
    return {
        instance: deserializedAsset,
        uuids: deserializeDetails.uuidList,
        dependScriptUuids: Array.from(dependScriptID),
        classFinder: missing_class_reporter_1.MissingClass.classFinder,
    };
}
function linkToAssetTarget(uuid) {
    return `{asset(${uuid})}`;
}
/**
 * 判断 val 的值是否超出
 * @param val
 * @param min
 * @param max
 */
function clamp(val, min, max) {
    return val < min ? min : val > max ? max : val;
}
/**
 * 获取一个像素的颜色值
 * @param data
 * @param x
 * @param y
 * @param imgWidth
 */
function getPixiel(buffer, x, y, imgWidth) {
    const idx = x * 4 + y * imgWidth * 4;
    return {
        r: buffer[idx],
        g: buffer[idx + 1],
        b: buffer[idx + 2],
        a: buffer[idx + 3],
    };
}
/**
 * 获取非透明像素的矩形大小
 * @param data
 * @param w
 * @param h
 * @param trimThreshold
 */
function getTrimRect(buffer, w, h, trimThreshold) {
    // A B C
    // D x F
    // G H I
    const threshold = trimThreshold;
    let tx = w;
    let ty = h;
    let tw = 0;
    let th = 0;
    let x;
    let y;
    // trim A B C
    for (y = 0; y < h; y++) {
        for (x = 0; x < w; x++) {
            if (getPixiel(buffer, x, y, w).a >= threshold) {
                ty = y;
                y = h;
                break;
            }
        }
    }
    // trim G H I
    for (y = h - 1; y >= ty; y--) {
        for (x = 0; x < w; x++) {
            if (getPixiel(buffer, x, y, w).a >= threshold) {
                th = y - ty + 1;
                y = 0;
                break;
            }
        }
    }
    // trim D
    for (x = 0; x < w; x++) {
        for (y = ty; y < ty + th; y++) {
            if (getPixiel(buffer, x, y, w).a >= threshold) {
                tx = x;
                x = w;
                break;
            }
        }
    }
    // trim F
    for (x = w - 1; x >= tx; x--) {
        for (y = ty; y < ty + th; y++) {
            if (getPixiel(buffer, x, y, w).a >= threshold) {
                tw = x - tx + 1;
                x = 0;
                break;
            }
        }
    }
    return [tx, ty, tw, th];
}
function removeNull(sceneData, assetUuid) {
    let hasNull = false;
    for (const nodeData of sceneData) {
        if (nodeData._children && nodeData._children.length) {
            for (let i = 0; i < nodeData._children.length; i++) {
                const el = nodeData._children[i];
                if (!el) {
                    nodeData._children.splice(i, 1);
                    hasNull = true;
                    console.warn(i18n_1.default.t('importer.invalid_node_data', {
                        assetUuid,
                        type: i18n_1.default.t('importer.node'),
                        value: String(el),
                    }));
                    i--;
                    continue;
                }
            }
        }
        if (nodeData._components) {
            for (let i = 0; i < nodeData._components.length; i++) {
                const el = nodeData._components[i];
                if (!el) {
                    nodeData._components.splice(i, 1);
                    console.warn(i18n_1.default.t('importer.invalid_node_data', {
                        assetUuid,
                        type: i18n_1.default.t('importer.component'),
                        value: String(el),
                    }));
                    hasNull = true;
                    i--;
                    continue;
                }
            }
        }
    }
    return hasNull;
}
async function findVsCode() {
    const appPath = '';
    // TODO
    return appPath;
}
class MigrateStep {
    resolveQueue = [];
    hold() {
        return new Promise((resolve) => {
            this.resolveQueue.push(resolve);
            if (this.resolveQueue.length === 1) {
                resolve();
                // @ts-ignore
                resolve.hasResolve = true;
            }
        });
    }
    step() {
        const resolve = this.resolveQueue.shift();
        resolve && resolve();
        if (resolve && resolve.hasResolve) {
            this.step();
        }
    }
}
exports.MigrateStep = MigrateStep;
async function openCode(asset) {
    return false;
}
/**
 * 将两个 meta 合并
 * 因为 meta 的可能被其他 asset 直接引用，所以不能直接覆盖
 * subMetas 里的数据是另一个 asset 的 meta，所以也需要拷贝
 * @param a
 * @param b
 */
function mergeMeta(a, b) {
    Object.keys(b).map((key) => {
        if (key === 'subMetas') {
            Object.keys(b.subMetas).forEach((id) => {
                if (!a.subMetas[id]) {
                    a.subMetas[id] = {};
                }
                mergeMeta(a.subMetas[id], b.subMetas[id]);
            });
            if (a.subMetas) {
                Object.keys(a.subMetas).forEach((id) => {
                    if (!(id in b.subMetas)) {
                        delete a.subMetas[id];
                    }
                });
            }
        }
        else {
            // @ts-ignore
            a[key] = b[key];
        }
    });
}
async function getMediaDuration(filePath) {
    const ffprobe = require('@ffprobe-installer/ffprobe');
    const { execSync } = require('child_process');
    const ffprobePath = ffprobe.path;
    const command = `"${ffprobePath}" -v error -show_entries format=duration -of csv=p=0 "${filePath}"`;
    try {
        const result = execSync(command).toString().trim();
        return parseFloat(result);
    }
    catch (error) {
        throw new Error(`获取媒体时长失败: ${error.message}`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29yZS9hc3NldHMvYXNzZXQtaGFuZGxlci91dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7Ozs7OztBQVdiLHNDQWtCQztBQUNELDhDQWNDO0FBRUQsc0NBbUJDO0FBRUQsa0NBRUM7QUFFRCxvREF3QkM7QUFFRCw4Q0FFQztBQVFELHNCQUVDO0FBU0QsOEJBUUM7QUFTRCxrQ0F1REM7QUFFRCxnQ0EyQ0M7QUErQkQsNEJBRUM7QUFTRCw4QkFxQkM7QUFFRCw0Q0FZQztBQXJURCwyREFBbUM7QUFDbkMsNkRBQXFDO0FBQ3JDLGdIQUFtRztBQU1uRyxTQUFnQixhQUFhLENBQ3pCLEdBQVEsRUFDUixHQUFHLElBQVc7SUFFZCxJQUFJLFVBQVUsR0FBRyxjQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRTdCLElBQUksT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssUUFBUSxFQUFFLENBQUM7UUFDOUIsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlCLE1BQU0sT0FBTyxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDN0MsSUFBSSxPQUFPLEVBQUUsQ0FBQztZQUNWLEtBQUssTUFBTSxLQUFLLElBQUksT0FBTyxFQUFFLENBQUM7Z0JBQzFCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQy9DLFVBQVUsR0FBRyxVQUFVLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNoRSxDQUFDO1FBQ0wsQ0FBQztJQUNMLENBQUM7SUFFRCxPQUFPLFVBQVUsQ0FBQztBQUN0QixDQUFDO0FBQ0QsU0FB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QzthQUFNLENBQUM7WUFDSixhQUFhO1lBQ2IsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNwQixDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBRU0sS0FBSyxVQUFVLGdCQUFnQixDQUFDLFFBQWdCO0lBQ25ELE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0lBQ3RELE1BQU0sRUFBRSxRQUFRLEVBQUUsR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDOUMsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQztJQUNqQyxNQUFNLE9BQU8sR0FBRyxJQUFJLFdBQVcseURBQXlELFFBQVEsR0FBRyxDQUFDO0lBRXBHLElBQUksQ0FBQztRQUNELE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNuRCxPQUFPLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM5QixDQUFDO0lBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztRQUNsQixNQUFNLElBQUksS0FBSyxDQUFDLGFBQWEsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7SUFDbEQsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG5pbXBvcnQgdHlwZSB7IENDT04gfSBmcm9tICdjYy9lZGl0b3Ivc2VyaWFsaXphdGlvbic7XHJcbmltcG9ydCBpMThuIGZyb20gJy4uLy4uL2Jhc2UvaTE4bic7XHJcbmltcG9ydCBVdGlscyBmcm9tICcuLi8uLi9iYXNlL3V0aWxzJztcclxuaW1wb3J0IHsgTWlzc2luZ0NsYXNzIH0gZnJvbSAnLi4vLi4vZW5naW5lL2VkaXRvci1leHRlbmRzL21pc3NpbmctcmVwb3J0ZXIvbWlzc2luZy1jbGFzcy1yZXBvcnRlcic7XHJcbmltcG9ydCB7IEFzc2V0IH0gZnJvbSAnQGNvY29zL2Fzc2V0LWRiJztcclxuaW1wb3J0IHsgSUFzc2V0TWV0YSB9IGZyb20gJy4uL0B0eXBlcy9wcml2YXRlJztcclxuaW1wb3J0IHR5cGUgeyBJMThuS2V5cyB9IGZyb20gJy4uLy4uLy4uL2kxOG4vdHlwZXMvZ2VuZXJhdGVkJztcclxuZGVjbGFyZSBjb25zdCBjYzogYW55O1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGkxOG5UcmFuc2xhdGU8S2V5IGV4dGVuZHMgSTE4bktleXM+KFxyXG4gICAga2V5OiBLZXksXHJcbiAgICAuLi5hcmdzOiBhbnlbXVxyXG4pOiBzdHJpbmcge1xyXG4gICAgbGV0IHRyYW5zbGF0ZWQgPSBpMThuLnQoa2V5KTtcclxuXHJcbiAgICBpZiAodHlwZW9mIGFyZ3NbMF0gPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgY29uc3QgcGFyYW1Bcmd1bWVudCA9IGFyZ3NbMF07XHJcbiAgICAgICAgY29uc3QgbWF0Y2hlcyA9IHRyYW5zbGF0ZWQubWF0Y2goL3soXFx3Kyl9L2cpO1xyXG4gICAgICAgIGlmIChtYXRjaGVzKSB7XHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgbWF0Y2ggb2YgbWF0Y2hlcykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbmFtZSA9IG1hdGNoLnN1YnN0cigxLCBtYXRjaC5sZW5ndGggLSAyKTtcclxuICAgICAgICAgICAgICAgIHRyYW5zbGF0ZWQgPSB0cmFuc2xhdGVkLnJlcGxhY2UobWF0Y2gsIHBhcmFtQXJndW1lbnRbbmFtZV0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0cmFuc2xhdGVkO1xyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiBnZXREZXBlbmRVVUlETGlzdChjb250ZW50OiBzdHJpbmcgfCBDQ09OIHwgT2JqZWN0LCB1dWlkPzogc3RyaW5nKSB7XHJcbiAgICBpZiAodHlwZW9mIGNvbnRlbnQgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgLy8g5rOo5oSP77ya5q2k5pa55rOV5peg5rOV5Yy56YWN5Ye66ISa5pys5byV55So55qEIHV1aWRcclxuICAgICAgICBsZXQgYXJyID0gY29udGVudC5tYXRjaCgvW2EtejAtOV17OH0tW2EtejAtOV17NH0tW2EtejAtOV17NH0tW2EtejAtOV17NH0tW2EtejAtOV17MTJ9KEBbYS16MC05XSspezAsfS9nKTtcclxuICAgICAgICBpZiAoYXJyKSB7XHJcbiAgICAgICAgICAgIC8vIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzMyODEzNzIwL25vZGVqcy1wcm9maWxpbmctcGFyZW50LWluLXNsaWNlZC1zdHJpbmdcclxuICAgICAgICAgICAgYXJyID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShBcnJheS5mcm9tKG5ldyBTZXQoYXJyKSkuZmlsdGVyKChpZCkgPT4gaWQgIT09IHV1aWQpKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIGNvbnN0IGFyciA9IGNvbnRlbnQubWF0Y2goL1wiX191dWlkX19cIjooICk/XCJbXlwiXSsvZyk7XHJcbiAgICAgICAgcmV0dXJuIGFyciB8fCBbXTtcclxuICAgIH1cclxuICAgIC8vIGNvbnNvbGUud2FybignVW5hYmxlIHRvIGV4dHJhY3QgZGVwZW5kZW5jaWVzIHByb3Blcmx5Jyk7XHJcblxyXG4gICAgcmV0dXJuIGdldERlc2VyaWFsaXplUmVzdWx0KGNvbnRlbnQpLnV1aWRzO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0RGVwZW5kTGlzdChjb250ZW50OiBzdHJpbmcgfCBDQ09OIHwgT2JqZWN0KSB7XHJcbiAgICBpZiAodHlwZW9mIGNvbnRlbnQgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgLy8gVE9ETyDmraTmlrnlvI/kvp3otZbkuobnm67liY3nmoTlrZfnrKbkuLLmoLzlvI/vvIzmnInpo47pmanvvIzkvYbnlLHkuo7nm67liY3ohJrmnKzliqDovb3ml6Dms5XlnKjlr7zlhaXkuYvliY3lrozmiJDvvIzml6Dms5XmraPluLjlj43luo/liJfljJZcclxuICAgICAgICBjb25zdCB1dWlkcyA9IGdldERlcGVuZFVVSURMaXN0KGNvbnRlbnQpO1xyXG4gICAgICAgIGNvbnN0IGNsYXNzVHlwZXMgPSBjb250ZW50Lm1hdGNoKC9cIl9fdHlwZV9fXCI6XFxzKlwiKFswLTlhLXpBLVorL117MjIsMjN9KVwiL2cpO1xyXG4gICAgICAgIGNvbnN0IGRlcGVuZFNjcmlwdFV1aWRzID0gY2xhc3NUeXBlcyA/IGNsYXNzVHlwZXMudG9TdHJpbmcoKS5tYXRjaCgvWzAtOWEtekEtWisvXXsyMiwyM30vZykgfHwgW10gOiBbXTtcclxuXHJcbiAgICAgICAgLy8gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzI4MTM3MjAvbm9kZWpzLXByb2ZpbGluZy1wYXJlbnQtaW4tc2xpY2VkLXN0cmluZ1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHV1aWRzLFxyXG4gICAgICAgICAgICBkZXBlbmRTY3JpcHRVdWlkczogQXJyYXkuZnJvbShuZXcgU2V0KGRlcGVuZFNjcmlwdFV1aWRzLm1hcCgoY2xhc3NJZCkgPT4gVXRpbHMuVVVJRC5kZWNvbXByZXNzVVVJRChjbGFzc0lkKSkpKSxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgY29uc3QgaW5mbyA9IGdldERlc2VyaWFsaXplUmVzdWx0KGNvbnRlbnQpO1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgdXVpZHM6IGluZm8udXVpZHMsXHJcbiAgICAgICAgZGVwZW5kU2NyaXB0VXVpZHM6IGluZm8uZGVwZW5kU2NyaXB0VXVpZHMsXHJcbiAgICB9O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZGVzZXJpYWxpemUoanNvbjogQ0NPTiB8IE9iamVjdCkge1xyXG4gICAgcmV0dXJuIGdldERlc2VyaWFsaXplUmVzdWx0KGpzb24pLmluc3RhbmNlO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0RGVzZXJpYWxpemVSZXN1bHQoanNvbjogQ0NPTiB8IE9iamVjdCkge1xyXG4gICAgY29uc3QgZGVzZXJpYWxpemVEZXRhaWxzID0gbmV3IGNjLmRlc2VyaWFsaXplLkRldGFpbHMoKTtcclxuICAgIGRlc2VyaWFsaXplRGV0YWlscy5yZXNldCgpO1xyXG4gICAgTWlzc2luZ0NsYXNzLnJlc2V0KCk7XHJcbiAgICBNaXNzaW5nQ2xhc3MuaGFzTWlzc2luZ0NsYXNzID0gZmFsc2U7XHJcbiAgICBjb25zdCBkZXBlbmRTY3JpcHRJRCA9IG5ldyBTZXQoKTtcclxuICAgIGZ1bmN0aW9uIGNsYXNzRmluZGVyKGNsYXNzSWQ6IHN0cmluZykge1xyXG4gICAgICAgIGlmIChVdGlscy5VVUlELmlzVVVJRChjbGFzc0lkKSkge1xyXG4gICAgICAgICAgICBkZXBlbmRTY3JpcHRJRC5hZGQoVXRpbHMuVVVJRC5kZWNvbXByZXNzVVVJRChjbGFzc0lkKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBNaXNzaW5nQ2xhc3MuY2xhc3NGaW5kZXIoY2xhc3NJZCk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBkZXNlcmlhbGl6ZWRBc3NldCA9IGNjLmRlc2VyaWFsaXplKGpzb24sIGRlc2VyaWFsaXplRGV0YWlscywge1xyXG4gICAgICAgIGNsYXNzRmluZGVyLFxyXG4gICAgfSk7XHJcbiAgICBkZXNlcmlhbGl6ZURldGFpbHMuYXNzaWduQXNzZXRzQnkoZnVuY3Rpb24gKHV1aWQ6IHN0cmluZywgb3B0aW9uczogeyBvd25lcjogb2JqZWN0OyBwcm9wOiBzdHJpbmc7IHR5cGU6IEZ1bmN0aW9uIH0pIHtcclxuICAgICAgICByZXR1cm4gRWRpdG9yRXh0ZW5kcy5zZXJpYWxpemUuYXNBc3NldCh1dWlkKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBpbnN0YW5jZTogZGVzZXJpYWxpemVkQXNzZXQsXHJcbiAgICAgICAgdXVpZHM6IGRlc2VyaWFsaXplRGV0YWlscy51dWlkTGlzdCxcclxuICAgICAgICBkZXBlbmRTY3JpcHRVdWlkczogQXJyYXkuZnJvbShkZXBlbmRTY3JpcHRJRCksXHJcbiAgICAgICAgY2xhc3NGaW5kZXI6IE1pc3NpbmdDbGFzcy5jbGFzc0ZpbmRlcixcclxuICAgIH07XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBsaW5rVG9Bc3NldFRhcmdldCh1dWlkOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBge2Fzc2V0KCR7dXVpZH0pfWA7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDliKTmlq0gdmFsIOeahOWAvOaYr+WQpui2heWHulxyXG4gKiBAcGFyYW0gdmFsXHJcbiAqIEBwYXJhbSBtaW5cclxuICogQHBhcmFtIG1heFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGNsYW1wKHZhbDogbnVtYmVyLCBtaW46IG51bWJlciwgbWF4OiBudW1iZXIpIHtcclxuICAgIHJldHVybiB2YWwgPCBtaW4gPyBtaW4gOiB2YWwgPiBtYXggPyBtYXggOiB2YWw7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDojrflj5bkuIDkuKrlg4/ntKDnmoTpopzoibLlgLxcclxuICogQHBhcmFtIGRhdGFcclxuICogQHBhcmFtIHhcclxuICogQHBhcmFtIHlcclxuICogQHBhcmFtIGltZ1dpZHRoXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGl4aWVsKGJ1ZmZlcjogQnVmZmVyLCB4OiBudW1iZXIsIHk6IG51bWJlciwgaW1nV2lkdGg6IG51bWJlcikge1xyXG4gICAgY29uc3QgaWR4ID0geCAqIDQgKyB5ICogaW1nV2lkdGggKiA0O1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICByOiBidWZmZXJbaWR4XSxcclxuICAgICAgICBnOiBidWZmZXJbaWR4ICsgMV0sXHJcbiAgICAgICAgYjogYnVmZmVyW2lkeCArIDJdLFxyXG4gICAgICAgIGE6IGJ1ZmZlcltpZHggKyAzXSxcclxuICAgIH07XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDojrflj5bpnZ7pgI/mmI7lg4/ntKDnmoTnn6nlvaLlpKflsI9cclxuICogQHBhcmFtIGRhdGFcclxuICogQHBhcmFtIHdcclxuICogQHBhcmFtIGhcclxuICogQHBhcmFtIHRyaW1UaHJlc2hvbGRcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRUcmltUmVjdChidWZmZXI6IEJ1ZmZlciwgdzogbnVtYmVyLCBoOiBudW1iZXIsIHRyaW1UaHJlc2hvbGQ6IG51bWJlcikge1xyXG4gICAgLy8gQSBCIENcclxuICAgIC8vIEQgeCBGXHJcbiAgICAvLyBHIEggSVxyXG5cclxuICAgIGNvbnN0IHRocmVzaG9sZCA9IHRyaW1UaHJlc2hvbGQ7XHJcbiAgICBsZXQgdHggPSB3O1xyXG4gICAgbGV0IHR5ID0gaDtcclxuICAgIGxldCB0dyA9IDA7XHJcbiAgICBsZXQgdGggPSAwO1xyXG4gICAgbGV0IHg7XHJcbiAgICBsZXQgeTtcclxuXHJcbiAgICAvLyB0cmltIEEgQiBDXHJcbiAgICBmb3IgKHkgPSAwOyB5IDwgaDsgeSsrKSB7XHJcbiAgICAgICAgZm9yICh4ID0gMDsgeCA8IHc7IHgrKykge1xyXG4gICAgICAgICAgICBpZiAoZ2V0UGl4aWVsKGJ1ZmZlciwgeCwgeSwgdykuYSA+PSB0aHJlc2hvbGQpIHtcclxuICAgICAgICAgICAgICAgIHR5ID0geTtcclxuICAgICAgICAgICAgICAgIHkgPSBoO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvLyB0cmltIEcgSCBJXHJcbiAgICBmb3IgKHkgPSBoIC0gMTsgeSA+PSB0eTsgeS0tKSB7XHJcbiAgICAgICAgZm9yICh4ID0gMDsgeCA8IHc7IHgrKykge1xyXG4gICAgICAgICAgICBpZiAoZ2V0UGl4aWVsKGJ1ZmZlciwgeCwgeSwgdykuYSA+PSB0aHJlc2hvbGQpIHtcclxuICAgICAgICAgICAgICAgIHRoID0geSAtIHR5ICsgMTtcclxuICAgICAgICAgICAgICAgIHkgPSAwO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvLyB0cmltIERcclxuICAgIGZvciAoeCA9IDA7IHggPCB3OyB4KyspIHtcclxuICAgICAgICBmb3IgKHkgPSB0eTsgeSA8IHR5ICsgdGg7IHkrKykge1xyXG4gICAgICAgICAgICBpZiAoZ2V0UGl4aWVsKGJ1ZmZlciwgeCwgeSwgdykuYSA+PSB0aHJlc2hvbGQpIHtcclxuICAgICAgICAgICAgICAgIHR4ID0geDtcclxuICAgICAgICAgICAgICAgIHggPSB3O1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvLyB0cmltIEZcclxuICAgIGZvciAoeCA9IHcgLSAxOyB4ID49IHR4OyB4LS0pIHtcclxuICAgICAgICBmb3IgKHkgPSB0eTsgeSA8IHR5ICsgdGg7IHkrKykge1xyXG4gICAgICAgICAgICBpZiAoZ2V0UGl4aWVsKGJ1ZmZlciwgeCwgeSwgdykuYSA+PSB0aHJlc2hvbGQpIHtcclxuICAgICAgICAgICAgICAgIHR3ID0geCAtIHR4ICsgMTtcclxuICAgICAgICAgICAgICAgIHggPSAwO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIFt0eCwgdHksIHR3LCB0aF07XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiByZW1vdmVOdWxsKHNjZW5lRGF0YTogYW55LCBhc3NldFV1aWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgbGV0IGhhc051bGwgPSBmYWxzZTtcclxuXHJcbiAgICBmb3IgKGNvbnN0IG5vZGVEYXRhIG9mIHNjZW5lRGF0YSkge1xyXG4gICAgICAgIGlmIChub2RlRGF0YS5fY2hpbGRyZW4gJiYgbm9kZURhdGEuX2NoaWxkcmVuLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGVEYXRhLl9jaGlsZHJlbi5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZWwgPSBub2RlRGF0YS5fY2hpbGRyZW5baV07XHJcbiAgICAgICAgICAgICAgICBpZiAoIWVsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZURhdGEuX2NoaWxkcmVuLnNwbGljZShpLCAxKTtcclxuICAgICAgICAgICAgICAgICAgICBoYXNOdWxsID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGkxOG4udCgnaW1wb3J0ZXIuaW52YWxpZF9ub2RlX2RhdGEnLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NldFV1aWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBpMThuLnQoJ2ltcG9ydGVyLm5vZGUnKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBTdHJpbmcoZWwpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIGktLTtcclxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKG5vZGVEYXRhLl9jb21wb25lbnRzKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZURhdGEuX2NvbXBvbmVudHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gbm9kZURhdGEuX2NvbXBvbmVudHNbaV07XHJcbiAgICAgICAgICAgICAgICBpZiAoIWVsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZURhdGEuX2NvbXBvbmVudHMuc3BsaWNlKGksIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihcclxuICAgICAgICAgICAgICAgICAgICAgICAgaTE4bi50KCdpbXBvcnRlci5pbnZhbGlkX25vZGVfZGF0YScsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2V0VXVpZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IGkxOG4udCgnaW1wb3J0ZXIuY29tcG9uZW50JyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogU3RyaW5nKGVsKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICBoYXNOdWxsID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBpLS07XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaGFzTnVsbDtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gZmluZFZzQ29kZSgpIHtcclxuICAgIGNvbnN0IGFwcFBhdGggPSAnJztcclxuICAgIC8vIFRPRE9cclxuXHJcbiAgICByZXR1cm4gYXBwUGF0aDtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIE1pZ3JhdGVTdGVwIHtcclxuICAgIHByaXZhdGUgcmVzb2x2ZVF1ZXVlOiBhbnlbXSA9IFtdO1xyXG4gICAgaG9sZCgpIHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5yZXNvbHZlUXVldWUucHVzaChyZXNvbHZlKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMucmVzb2x2ZVF1ZXVlLmxlbmd0aCA9PT0gMSkge1xyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZS5oYXNSZXNvbHZlID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHN0ZXAoKSB7XHJcbiAgICAgICAgY29uc3QgcmVzb2x2ZSA9IHRoaXMucmVzb2x2ZVF1ZXVlLnNoaWZ0KCk7XHJcbiAgICAgICAgcmVzb2x2ZSAmJiByZXNvbHZlKCk7XHJcbiAgICAgICAgaWYgKHJlc29sdmUgJiYgcmVzb2x2ZS5oYXNSZXNvbHZlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3RlcCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG9wZW5Db2RlKGFzc2V0OiBBc3NldCk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG59XHJcblxyXG4vKipcclxuICog5bCG5Lik5LiqIG1ldGEg5ZCI5bm2XHJcbiAqIOWboOS4uiBtZXRhIOeahOWPr+iDveiiq+WFtuS7liBhc3NldCDnm7TmjqXlvJXnlKjvvIzmiYDku6XkuI3og73nm7TmjqXopobnm5ZcclxuICogc3ViTWV0YXMg6YeM55qE5pWw5o2u5piv5Y+m5LiA5LiqIGFzc2V0IOeahCBtZXRh77yM5omA5Lul5Lmf6ZyA6KaB5ou36LSdXHJcbiAqIEBwYXJhbSBhIFxyXG4gKiBAcGFyYW0gYiBcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBtZXJnZU1ldGEoYTogSUFzc2V0TWV0YSwgYjogSUFzc2V0TWV0YSkge1xyXG4gICAgT2JqZWN0LmtleXMoYikubWFwKChrZXkpID0+IHtcclxuICAgICAgICBpZiAoa2V5ID09PSAnc3ViTWV0YXMnKSB7XHJcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKGIuc3ViTWV0YXMpLmZvckVhY2goKGlkKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWEuc3ViTWV0YXNbaWRdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYS5zdWJNZXRhc1tpZF0gPSB7fSBhcyBJQXNzZXRNZXRhO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbWVyZ2VNZXRhKGEuc3ViTWV0YXNbaWRdLCBiLnN1Yk1ldGFzW2lkXSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBpZiAoYS5zdWJNZXRhcykge1xyXG4gICAgICAgICAgICAgICAgT2JqZWN0LmtleXMoYS5zdWJNZXRhcykuZm9yRWFjaCgoaWQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIShpZCBpbiBiLnN1Yk1ldGFzKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgYS5zdWJNZXRhc1tpZF07XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgIGFba2V5XSA9IGJba2V5XTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldE1lZGlhRHVyYXRpb24oZmlsZVBhdGg6IHN0cmluZykge1xyXG4gICAgY29uc3QgZmZwcm9iZSA9IHJlcXVpcmUoJ0BmZnByb2JlLWluc3RhbGxlci9mZnByb2JlJyk7XHJcbiAgICBjb25zdCB7IGV4ZWNTeW5jIH0gPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJyk7XHJcbiAgICBjb25zdCBmZnByb2JlUGF0aCA9IGZmcHJvYmUucGF0aDtcclxuICAgIGNvbnN0IGNvbW1hbmQgPSBgXCIke2ZmcHJvYmVQYXRofVwiIC12IGVycm9yIC1zaG93X2VudHJpZXMgZm9ybWF0PWR1cmF0aW9uIC1vZiBjc3Y9cD0wIFwiJHtmaWxlUGF0aH1cImA7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSBleGVjU3luYyhjb21tYW5kKS50b1N0cmluZygpLnRyaW0oKTtcclxuICAgICAgICByZXR1cm4gcGFyc2VGbG9hdChyZXN1bHQpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihg6I635Y+W5aqS5L2T5pe26ZW/5aSx6LSlOiAke2Vycm9yLm1lc3NhZ2V9YCk7XHJcbiAgICB9XHJcbn1cclxuIl19