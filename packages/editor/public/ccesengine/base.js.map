{"version":3,"file":"base.js","sources":["../../../cocos/core/legacy.ts","../../../cocos/core/data/utils/compiler.ts","../../../cocos/core/event/event-target-factory.ts","../../../cocos/render-scene/utils.ts","../../../extensions/ccpool/node-pool.ts","../../../cocos/native-binding/impl.ts","../../../exports/base.ts"],"sourcesContent":["/*\r\n Copyright (c) 2020-2023 Xiamen Yaji Software Co., Ltd.\r\n\r\n https://www.cocos.com/\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated documentation files (the \"Software\"), to deal\r\n in the Software without restriction, including without limitation the rights to\r\n use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies\r\n of the Software, and to permit persons to whom the Software is furnished to do so,\r\n subject to the following conditions:\r\n\r\n The above copyright notice and this permission notice shall be included in\r\n all copies or substantial portions of the Software.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n*/\r\n\r\nimport * as debug from './platform/debug';\r\nimport { _normalize, basename, changeBasename, changeExtname, dirname, extname, getSeperator, join, mainFileName, stripSep } from './utils/path';\r\nimport { legacyCC } from './global-exports';\r\n\r\n// CCDebug.js\r\nlegacyCC.log = debug.log;\r\nlegacyCC.warn = debug.warn;\r\nlegacyCC.error = debug.error;\r\nlegacyCC.assert = debug.assert;\r\nlegacyCC._throw = debug._throw;\r\nlegacyCC.logID = debug.logID;\r\nlegacyCC.warnID = debug.warnID;\r\nlegacyCC.errorID = debug.errorID;\r\nlegacyCC.assertID = debug.assertID;\r\nlegacyCC.debug = debug;\r\n\r\n// path.js\r\nlegacyCC.path = {\r\n    join,\r\n    extname,\r\n    mainFileName,\r\n    basename,\r\n    dirname,\r\n    changeExtname,\r\n    changeBasename,\r\n    _normalize,\r\n    stripSep,\r\n    get sep (): string {\r\n        return getSeperator();\r\n    },\r\n};\r\n","/*\r\n Copyright (c) 2013-2016 Chukong Technologies Inc.\r\n Copyright (c) 2017-2023 Xiamen Yaji Software Co., Ltd.\r\n\r\n http://www.cocos.com\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated documentation files (the \"Software\"), to deal\r\n in the Software without restriction, including without limitation the rights to\r\n use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies\r\n of the Software, and to permit persons to whom the Software is furnished to do so,\r\n subject to the following conditions:\r\n\r\n The above copyright notice and this permission notice shall be included in\r\n all copies or substantial portions of the Software.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n*/\r\n\r\nimport { DEV } from 'internal:constants';\r\n\r\nfunction deepFlatten (strList: string[], array: (string | string[])[]): void {\r\n    for (const item of array) {\r\n        if (Array.isArray(item)) {\r\n            deepFlatten(strList, item);\r\n        // eslint-disable-next-line brace-style\r\n        }\r\n        // else if (item instanceof Declaration) {\r\n        //     strList.push(item.toString());\r\n        // }\r\n        else {\r\n            strList.push(item);\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n *\r\n * @engineInternal\r\n */\r\nexport function flattenCodeArray (array: (string | string[])[]): string {\r\n    const separator = DEV ? '\\n' : '';\r\n    const strList = [];\r\n    deepFlatten(strList, array);\r\n    return strList.join(separator);\r\n}\r\n","/*\r\n Copyright (c) 2019-2023 Xiamen Yaji Software Co., Ltd.\r\n\r\n http://www.cocos.com\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated documentation files (the \"Software\"), to deal\r\n in the Software without restriction, including without limitation the rights to\r\n use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies\r\n of the Software, and to permit persons to whom the Software is furnished to do so,\r\n subject to the following conditions:\r\n\r\n The above copyright notice and this permission notice shall be included in\r\n all copies or substantial portions of the Software.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n*/\r\n\r\nimport { EventTarget } from './event-target';\r\n\r\n/**\r\n *\r\n * @engineInternal\r\n */\r\nexport function applyMixins (derivedCtor: any, baseCtors: any[]): void {\r\n    baseCtors.forEach((baseCtor) => {\r\n        Object.getOwnPropertyNames(baseCtor.prototype).forEach((name) => {\r\n            if (name !== 'constructor') {\r\n                Object.defineProperty(derivedCtor.prototype, name, Object.getOwnPropertyDescriptor(baseCtor.prototype, name)!);\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n/**\r\n * @en Interface for all classes that self implement the EventTarget protocol, they are normally not sub class of EventTarget\r\n * @zh 所有自己实现 EventTarget 功能的类都实现了这个 Interface，他们可能无法直接继承自 EventTarget\r\n */\r\nexport type IEventTarget = EventTarget\r\n","/*\r\n Copyright (c) 2020-2023 Xiamen Yaji Software Co., Ltd.\r\n\r\n https://www.cocos.com/\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated documentation files (the \"Software\"), to deal\r\n in the Software without restriction, including without limitation the rights to\r\n use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies\r\n of the Software, and to permit persons to whom the Software is furnished to do so,\r\n subject to the following conditions:\r\n\r\n The above copyright notice and this permission notice shall be included in\r\n all copies or substantial portions of the Software.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n*/\r\n\r\nimport { errorID } from '../core';\r\nimport { Attribute, Buffer, BufferInfo, Device, InputAssemblerInfo, AttributeName, BufferUsageBit, Format, MemoryUsageBit, InputAssembler } from '../gfx';\r\nimport { IGeometry } from '../primitive/define';\r\n\r\nexport function createIA (device: Device, data: IGeometry): InputAssembler | null {\r\n    if (!data.positions) {\r\n        errorID(16306);\r\n        return null;\r\n    }\r\n\r\n    const verts: number[] = [];\r\n    const vcount = data.positions.length / 3;\r\n\r\n    for (let i = 0; i < vcount; ++i) {\r\n        verts.push(data.positions[3 * i], data.positions[3 * i + 1], data.positions[3 * i + 2]);\r\n\r\n        if (data.normals) {\r\n            verts.push(data.normals[3 * i], data.normals[3 * i + 1], data.normals[3 * i + 2]);\r\n        }\r\n        if (data.uvs) {\r\n            verts.push(data.uvs[2 * i], data.uvs[2 * i + 1]);\r\n        }\r\n        if (data.colors) {\r\n            verts.push(data.colors[3 * i], data.colors[3 * i + 1], data.colors[3 * i + 2]);\r\n        }\r\n    }\r\n\r\n    const vfmt: Attribute[] = [];\r\n    vfmt.push(new Attribute(AttributeName.ATTR_POSITION, Format.RGB32F));\r\n    if (data.normals) {\r\n        vfmt.push(new Attribute(AttributeName.ATTR_NORMAL, Format.RGB32F));\r\n    }\r\n    if (data.uvs) {\r\n        vfmt.push(new Attribute(AttributeName.ATTR_TEX_COORD, Format.RG32F));\r\n    }\r\n    if (data.colors) {\r\n        vfmt.push(new Attribute(AttributeName.ATTR_COLOR, Format.RGB32F));\r\n    }\r\n\r\n    const vb = device.createBuffer(new BufferInfo(\r\n        BufferUsageBit.VERTEX | BufferUsageBit.TRANSFER_DST,\r\n        MemoryUsageBit.DEVICE,\r\n        verts.length * 4,\r\n        verts.length * 4 / vcount,\r\n    ));\r\n\r\n    vb.update(new Float32Array(verts));\r\n\r\n    let ib: Buffer | null = null;\r\n    if (data.indices) {\r\n        ib = device.createBuffer(new BufferInfo(\r\n            BufferUsageBit.INDEX | BufferUsageBit.TRANSFER_DST,\r\n            MemoryUsageBit.DEVICE,\r\n            data.indices.length * 2,\r\n            2,\r\n        ));\r\n\r\n        ib.update(new Uint16Array(data.indices));\r\n    }\r\n\r\n    return device.createInputAssembler(new InputAssemblerInfo(vfmt, [vb], ib));\r\n}\r\n","/*\r\n Copyright (c) 2016 Chukong Technologies Inc.\r\n Copyright (c) 2017-2020 Xiamen Yaji Software Co., Ltd.\r\n\r\n http://www.cocos2d-x.org\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated documentation files (the \"Software\"), to deal\r\n in the Software without restriction, including without limitation the rights\r\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n copies of the Software, and to permit persons to whom the Software is\r\n furnished to do so, subject to the following conditions:\r\n\r\n The above copyright notice and this permission notice shall be included in\r\n all copies or substantial portions of the Software.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n */\r\n\r\nimport { Component } from '../../cocos/scene-graph/component';\r\nimport { Node } from '../../cocos/scene-graph';\r\nimport { legacyCC } from '../../cocos/core/global-exports';\r\n\r\ntype Constructor<T = {}> = new(...args: any[]) => T;\r\n\r\ninterface IPoolHandlerComponent extends Component {\r\n    unuse (): void;\r\n\r\n    reuse (args: any): void;\r\n}\r\n\r\n/**\r\n * @en\r\n *  `NodePool` is the cache pool designed for node type.<br/>\r\n *  It can helps you to improve your game performance for objects which need frequent release and recreate operations<br/>\r\n *\r\n * It's recommended to create `NodePool` instances by node type, the type corresponds to node type in game design, not the class,\r\n * for example, a prefab is a specific node type. <br/>\r\n * When you create a node pool, you can pass a Component which contains `unuse`, `reuse` functions to control the content of node.<br/>\r\n *\r\n * Some common use case is :<br/>\r\n *      1. Bullets in game (die very soon, massive creation and recreation, no side effect on other objects)<br/>\r\n *      2. Blocks in candy crash (massive creation and recreation)<br/>\r\n *      etc...\r\n * @zh\r\n * `NodePool` 是用于管理节点对象的对象缓存池。<br/>\r\n * 它可以帮助您提高游戏性能，适用于优化对象的反复创建和销毁<br/>\r\n * 以前 cocos2d-x 中的 pool 和新的节点事件注册系统不兼容，因此请使用 `NodePool` 来代替。\r\n *\r\n * 新的 NodePool 需要实例化之后才能使用，每种不同的节点对象池需要一个不同的对象池实例，这里的种类对应于游戏中的节点设计，一个 prefab 相当于一个种类的节点。<br/>\r\n * 在创建缓冲池时，可以传入一个包含 unuse, reuse 函数的组件类型用于节点的回收和复用逻辑。<br/>\r\n *\r\n * 一些常见的用例是：<br/>\r\n *      1.在游戏中的子弹（死亡很快，频繁创建，对其他对象无副作用）<br/>\r\n *      2.糖果粉碎传奇中的木块（频繁创建）。\r\n *      等等....\r\n */\r\nexport class NodePool {\r\n    /**\r\n     * @en The pool handler component, it could be the class name or the constructor.\r\n     * @zh 缓冲池处理组件，用于节点的回收和复用逻辑，这个属性可以是组件类名或组件的构造函数。\r\n     */\r\n    public declare poolHandlerComp?: Constructor<IPoolHandlerComponent> | string;\r\n    private _pool: Node[] = [];\r\n\r\n    /**\r\n     * @en\r\n     * Constructor for creating a pool for a specific node template (usually a prefab).\r\n     * You can pass a component (type or name) argument for handling event for reusing and recycling node.\r\n     * @zh\r\n     * 使用构造函数来创建一个节点专用的对象池，您可以传递一个组件类型或名称，用于处理节点回收和复用时的事件逻辑。\r\n     * @param poolHandlerComp @en The constructor or the class name of the component to control the unuse/reuse logic. @zh 处理节点回收和复用事件逻辑的组件类型或名称。\r\n     * @example\r\n     * import { NodePool, Prefab } from 'cc';\r\n     *  properties: {\r\n     *      template: Prefab\r\n     *     },\r\n     *     onLoad () {\r\n     *       // MyTemplateHandler is a component with 'unuse' and 'reuse' to handle events when node is reused or recycled.\r\n     *       this.myPool = new NodePool('MyTemplateHandler');\r\n     *     }\r\n     *  }\r\n     */\r\n    constructor (poolHandlerComp?: Constructor<IPoolHandlerComponent> | string) {\r\n        this.poolHandlerComp = poolHandlerComp;\r\n    }\r\n\r\n    /**\r\n     * @en The current available size in the pool\r\n     * @zh 获取当前缓冲池的可用对象数量\r\n     */\r\n    public size (): number {\r\n        return this._pool.length;\r\n    }\r\n\r\n    /**\r\n     * @en Destroy all cached nodes in the pool\r\n     * @zh 销毁对象池中缓存的所有节点\r\n     */\r\n    public clear (): void {\r\n        const count = this._pool.length;\r\n        for (let i = 0; i < count; ++i) {\r\n            this._pool[i].destroy();\r\n        }\r\n        this._pool.length = 0;\r\n    }\r\n\r\n    /**\r\n     * @en Put a new Node into the pool.\r\n     * It will automatically remove the node from its parent without cleanup.\r\n     * It will also invoke unuse method of the poolHandlerComp if exist.\r\n     * @zh 向缓冲池中存入一个不再需要的节点对象。\r\n     * 这个函数会自动将目标节点从父节点上移除，但是不会进行 cleanup 操作。\r\n     * 这个函数会调用 poolHandlerComp 的 unuse 函数，如果组件和函数都存在的话。\r\n     * @example\r\n     * import { instantiate } from 'cc';\r\n     * const myNode = instantiate(this.template);\r\n     * this.myPool.put(myNode);\r\n     */\r\n    public put (obj: Node): void {\r\n        if (obj && this._pool.indexOf(obj) === -1) {\r\n            // Remove from parent, but don't cleanup\r\n            obj.removeFromParent();\r\n\r\n            // Invoke pool handler\r\n            // @ts-ignore\r\n            const handler = this.poolHandlerComp ? obj.getComponent(this.poolHandlerComp) : null;\r\n            if (handler && handler.unuse) {\r\n                handler.unuse();\r\n            }\r\n\r\n            this._pool.push(obj);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @en Get a obj from pool, if no available object in pool, null will be returned.\r\n     * This function will invoke the reuse function of poolHandlerComp if exist.\r\n     * @zh 获取对象池中的对象，如果对象池没有可用对象，则返回空。\r\n     * 这个函数会调用 poolHandlerComp 的 reuse 函数，如果组件和函数都存在的话。\r\n     * @param args - 向 poolHandlerComp 中的 'reuse' 函数传递的参数\r\n     * @example\r\n     *   let newNode = this.myPool.get();\r\n     */\r\n    public get (...args: any[]): Node | null {\r\n        const last = this._pool.length - 1;\r\n        if (last < 0) {\r\n            return null;\r\n        } else {\r\n            // Pop the last object in pool\r\n            const obj = this._pool[last];\r\n            this._pool.length = last;\r\n\r\n            // Invoke pool handler\r\n            // @ts-ignore\r\n            const handler = this.poolHandlerComp ? obj.getComponent(this.poolHandlerComp) : null;\r\n            if (handler && handler.reuse) {\r\n                handler.reuse(arguments);\r\n            }\r\n            return obj;\r\n        }\r\n    }\r\n}\r\n\r\nlegacyCC.NodePool = NodePool;\r\n","/*\r\n Copyright (c) 2022-2023 Xiamen Yaji Software Co., Ltd.\r\n\r\n https://www.cocos.com/\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated documentation files (the \"Software\"), to deal\r\n in the Software without restriction, including without limitation the rights to\r\n use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies\r\n of the Software, and to permit persons to whom the Software is furnished to do so,\r\n subject to the following conditions:\r\n\r\n The above copyright notice and this permission notice shall be included in\r\n all copies or substantial portions of the Software.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n*/\r\nimport { sys } from \"../core\";\r\nimport { NATIVE } from 'internal:constants';\r\n\r\nconst globalJsb: any = globalThis.jsb ?? {};\r\ndeclare const ScriptNativeBridge: any;\r\n\r\nif (NATIVE) {\r\n    Object.defineProperty(globalJsb, 'reflection', {\r\n        get() {\r\n            if (globalJsb.__bridge !== undefined) return globalJsb.__bridge;\r\n            if (globalThis.JavascriptJavaBridge && (sys.os === sys.OS.ANDROID || sys.os === sys.OS.OHOS)) {\r\n                globalJsb.__bridge = new globalThis.JavascriptJavaBridge();\r\n            } else if (globalThis.JavaScriptObjCBridge && (sys.os === sys.OS.IOS || sys.os === sys.OS.OSX)) {\r\n                globalJsb.__bridge = new globalThis.JavaScriptObjCBridge();\r\n            } else if (globalThis.JavaScriptArkTsBridge && (sys.os === sys.OS.OPENHARMONY)) {\r\n                globalJsb.__bridge = new globalThis.JavaScriptArkTsBridge();\r\n            } else {\r\n                globalJsb.__bridge = null;\r\n            }\r\n            return globalJsb.__bridge;\r\n        },\r\n        enumerable: true,\r\n        configurable: true,\r\n        set(value) {\r\n            globalJsb.__bridge = value;\r\n        },\r\n    });\r\n    Object.defineProperty(globalJsb, 'bridge', {\r\n        get() {\r\n            if (globalJsb.__ccbridge !== undefined) return globalJsb.__ccbridge;\r\n            if (globalThis.ScriptNativeBridge && sys.os === sys.OS.ANDROID || sys.os === sys.OS.IOS || sys.os === sys.OS.OSX || sys.os === sys.OS.OHOS) {\r\n                globalJsb.__ccbridge = new ScriptNativeBridge();\r\n            } else {\r\n                globalJsb.__ccbridge = null;\r\n            }\r\n            return globalJsb.__ccbridge;\r\n        },\r\n        enumerable: true,\r\n        configurable: true,\r\n        set(value) {\r\n            globalJsb.__ccbridge = value;\r\n        },\r\n    });\r\n    const JsbBridgeWrapper = {\r\n        eventMap: new Map(),\r\n        addNativeEventListener(eventName, listener) {\r\n            if (!this.eventMap.get(eventName)) {\r\n                this.eventMap.set(eventName, []);\r\n            }\r\n            const arr = this.eventMap.get(eventName);\r\n            if (!arr.includes(listener)) {\r\n                arr.push(listener);\r\n            }\r\n        },\r\n        dispatchEventToNative(eventName, arg) {\r\n            globalJsb.bridge.sendToNative(eventName, arg);\r\n        },\r\n        removeAllListenersForEvent(eventName) {\r\n            return this.eventMap.delete(eventName);\r\n        },\r\n        removeNativeEventListener(eventName, listener) {\r\n            const arr = this.eventMap.get(eventName);\r\n            if (!arr) {\r\n                return false;\r\n            }\r\n            for (let i = 0, l = arr.length; i < l; i++) {\r\n                if (arr[i] === listener) {\r\n                    arr.splice(i, 1);\r\n                    return true;\r\n                }\r\n            }\r\n            return true;\r\n        },\r\n        removeAllListeners() {\r\n            this.eventMap.clear();\r\n        },\r\n        triggerEvent(eventName, arg) {\r\n            const arr = this.eventMap.get(eventName);\r\n            if (!arr) {\r\n                console.error(`${eventName} does not exist`);\r\n                return;\r\n            }\r\n            arr.map((listener) => listener.call(null, arg));\r\n        },\r\n    };\r\n\r\n    Object.defineProperty(globalJsb, 'jsbBridgeWrapper', {\r\n        get() {\r\n            if (globalJsb.__JsbBridgeWrapper !== undefined) return globalJsb.__JsbBridgeWrapper;\r\n\r\n            if (globalThis.ScriptNativeBridge && sys.os === sys.OS.ANDROID || sys.os === sys.OS.IOS || sys.os === sys.OS.OSX || sys.os === sys.OS.OHOS) {\r\n                globalJsb.__JsbBridgeWrapper = JsbBridgeWrapper;\r\n                globalJsb.bridge.onNative = (methodName, arg1) => {\r\n                    // console.log(`Trigger event: ${methodName} with argeter: ${arg1}`);\r\n                    globalJsb.__JsbBridgeWrapper.triggerEvent(methodName, arg1);\r\n                };\r\n            } else {\r\n                globalJsb.__JsbBridgeWrapper = null;\r\n            }\r\n            return globalJsb.__JsbBridgeWrapper;\r\n        },\r\n        enumerable: true,\r\n        configurable: true,\r\n        set(value) {\r\n            globalJsb.__JsbBridgeWrapper = value;\r\n        },\r\n    });\r\n    const originSaveImageData = globalJsb.saveImageData;\r\n    globalJsb.saveImageData = (data: Uint8Array, width: number, height: number, filePath: string) => {\r\n        return new Promise<void>((resolve, reject) => {\r\n            originSaveImageData(data, width, height, filePath, (isSuccess) => {\r\n                if (isSuccess) {\r\n                    resolve();\r\n                } else {\r\n                    reject();\r\n                }\r\n            })\r\n        });\r\n    }\r\n}\r\n\r\nexport const native = {\r\n    DownloaderHints: globalJsb.DownloaderHints,\r\n    Downloader: globalJsb.Downloader,\r\n    zipUtils: globalJsb.zipUtils,\r\n    fileUtils: globalJsb.fileUtils,\r\n    DebugRenderer: globalJsb.DebugRenderer,\r\n    copyTextToClipboard: globalJsb.copyTextToClipboard?.bind(globalJsb),\r\n    garbageCollect: globalJsb.garbageCollect,\r\n    reflection: globalJsb.reflection,\r\n    bridge: globalJsb.bridge,\r\n    jsbBridgeWrapper: globalJsb.jsbBridgeWrapper,\r\n    AssetsManager: globalJsb.AssetsManager,\r\n    EventAssetsManager: globalJsb.EventAssetsManager,\r\n    Manifest: globalJsb.Manifest,\r\n    saveImageData: globalJsb.saveImageData,\r\n    process: globalJsb.process,\r\n    adpf: globalJsb.adpf,\r\n};\r\n","/*\r\n Copyright (c) 2020 Xiamen Yaji Software Co., Ltd.\r\n\r\n https://www.cocos.com/\r\n\r\n Permission is hereby granted, free of charge, to any person obtaining a copy\r\n of this software and associated engine source code (the \"Software\"), a limited,\r\n worldwide, royalty-free, non-assignable, revocable and non-exclusive license\r\n to use Cocos Creator solely to develop games on your target platforms. You shall\r\n not use Cocos Creator software for developing other software or tools that's\r\n used for developing games. You are not granted to publish, distribute,\r\n sublicense, and/or sell copies of Cocos Creator.\r\n\r\n The software or tools in this License Agreement are licensed, not sold.\r\n Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.\r\n\r\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\r\n THE SOFTWARE.\r\n */\r\n\r\nimport { legacyCC } from '../cocos/core/global-exports';\r\n// has to import predefines first\r\nimport '../predefine';\r\n\r\n// tslint:disable-next-line: ordered-imports\r\nimport '../cocos/core/legacy';\r\n//TODO(PP): should rename it to render-scene\r\nimport * as renderer from '../cocos/render-scene';\r\nimport * as gfx from '../cocos/gfx';\r\n\r\n// LOAD ENGINE CORE\r\nexport * from '../cocos/core';\r\n\r\nexport * from '../cocos/rendering';\r\nexport * from '../cocos/scene-graph';\r\nexport * from '../cocos/misc';\r\nexport * from '../cocos/game';\r\nexport { Root } from '../cocos/root';\r\nexport * from '../cocos/serialization';\r\n\r\nexport { gfx };\r\n\r\nexport * from '../cocos/asset/assets';\r\nexport * from '../cocos/asset/asset-manager';\r\n\r\nexport { renderer };\r\nlegacyCC.renderer = renderer;\r\n\r\nexport * from '../extensions/ccpool/node-pool';\r\n\r\nexport * from '../cocos/input/types';\r\nexport * from '../cocos/input';\r\n\r\nexport * from '../cocos/native-binding/index';\r\n\r\ntype Constructor_<T = unknown> = Constructor<T>;\r\n\r\nexport type { Constructor_ as Constructor };\r\n"],"names":["legacyCC","log","debug","warn","error","assert","_throw","logID","warnID","errorID","assertID","path","join","extname","mainFileName","basename","dirname","changeExtname","changeBasename","_normalize","stripSep","sep","getSeperator","deepFlatten","strList","array","_iterator","_createForOfIteratorHelperLoose","_step","done","item","value","Array","isArray","push","flattenCodeArray","separator","applyMixins","derivedCtor","baseCtors","forEach","baseCtor","Object","getOwnPropertyNames","prototype","name","defineProperty","getOwnPropertyDescriptor","createIA","device","data","positions","verts","vcount","length","i","normals","uvs","colors","vfmt","Attribute","AttributeName","ATTR_POSITION","Format","RGB32F","ATTR_NORMAL","ATTR_TEX_COORD","RG32F","ATTR_COLOR","vb","createBuffer","BufferInfo","BufferUsageBit","VERTEX","TRANSFER_DST","MemoryUsageBit","DEVICE","update","Float32Array","ib","indices","INDEX","Uint16Array","createInputAssembler","InputAssemblerInfo","NodePool","poolHandlerComp","_pool","_proto","size","clear","count","destroy","put","obj","indexOf","removeFromParent","handler","getComponent","unuse","get","_len","arguments","args","_key","last","reuse","globalJsb","_globalThis$jsb","globalThis","jsb","native","DownloaderHints","Downloader","zipUtils","fileUtils","DebugRenderer","copyTextToClipboard","_globalJsb$copyTextTo","bind","garbageCollect","reflection","bridge","jsbBridgeWrapper","AssetsManager","EventAssetsManager","Manifest","saveImageData","process","adpf","renderer"],"mappings":"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"}