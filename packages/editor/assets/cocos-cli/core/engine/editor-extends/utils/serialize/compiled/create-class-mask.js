"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = default_1;
const cc_1 = require("cc");
// import deserializer types
var D = cc_1.deserialize.Internal;
var DataTypeID = D.DataTypeID_;
const types_1 = require("./types");
const { CLASS_PROP_TYPE_OFFSET, MASK_CLASS, OBJ_DATA_MASK, CUSTOM_OBJ_DATA_CLASS, } = cc_1.deserialize._macros;
// 同一个构造函数，生成的类型可能有多个，每个类型叫作一个 Type。
class Type {
    properties = new Map();
    nodes = new Array();
    constructor(node) {
        this.setNodeProperties(node);
        this.nodes.push(node);
    }
    setNodeProperties(node) {
        const properties = this.properties;
        for (const simpleKey of node.simpleKeys) {
            properties.set(simpleKey, DataTypeID.SimpleType);
        }
        for (let i = 0; i < node.advanceds.length; i += 2) {
            const key = node.advanceds[i];
            properties.set(key, node.advanceds[i + 1]);
        }
    }
    addNode(node) {
        const properties = this.properties;
        let lackProperty = false;
        for (const simpleKey of node.simpleKeys) {
            if (properties.has(simpleKey)) {
                if (properties.get(simpleKey) !== DataTypeID.SimpleType) {
                    // 当前类的某个属性类型和目标对象的不同
                    return false;
                }
            }
            else {
                lackProperty = true;
            }
        }
        for (let i = 0; i < node.advanceds.length; i += 2) {
            const key = node.advanceds[i];
            if (properties.has(key)) {
                if (properties.get(key) !== node.advanceds[i + 1]) {
                    // 当前类的某个属性类型和目标对象的不同
                    return false;
                }
            }
            else {
                lackProperty = true;
            }
        }
        if (lackProperty) {
            // 当前类的属性和类型是目标对象的子集
            this.setNodeProperties(node);
            this.nodes.push(node);
            return true;
        }
        else {
            // 当前类包含了目标对象的所有属性及类型
            this.nodes.push(node);
            return true;
        }
    }
    static shouldUseSameMask(rhs) {
        const lhs = this;
        const ls = lhs.simpleKeys;
        const rs = rhs.simpleKeys;
        const la = lhs.advanceds;
        const ra = rhs.advanceds;
        if (ls.length !== rs.length || la.length !== ra.length) {
            return false;
        }
        for (let i = 0; i < ls.length; ++i) {
            if (ls[i] !== rs[i]) {
                return false;
            }
        }
        for (let i = 0; i < la.length; i += 2) {
            if (la[i] !== ra[i]) {
                return false;
            }
        }
        return true;
    }
    dump(classId, sharedClasses, sharedMasks) {
        // 缓存待生成的属性列表
        const simples = new types_1.TraceableDict();
        const advanceds = new types_1.TraceableDict();
        // 缓存待生成的 mask 数据，由于每个 mask 都有与其完全匹配的对象结构，因此直接使用对象本身做为缓存就行
        const maskNodes = new Array();
        // dump mask
        for (let i = 0; i < this.nodes.length; ++i) {
            const node = this.nodes[i];
            const maskNode = maskNodes.find(Type.shouldUseSameMask, node);
            if (maskNode) {
                sharedMasks.trace(maskNode, node.dumped, OBJ_DATA_MASK);
            }
            else {
                // new mask
                const maskData = [types_1.TraceableDict.PLACEHOLDER];
                for (let i = 0; i < node.simpleKeys.length; ++i) {
                    const key = node.simpleKeys[i];
                    simples.traceString(key, maskData, maskData.length);
                    maskData.push(types_1.TraceableDict.PLACEHOLDER);
                }
                const offset = maskData.length;
                for (let i = 0; i < node.advanceds.length; i += 2) {
                    const key = node.advanceds[i];
                    advanceds.traceString(key, maskData, maskData.length);
                    maskData.push(types_1.TraceableDict.PLACEHOLDER);
                }
                maskData.push(offset);
                sharedClasses.trace(this, maskData, MASK_CLASS);
                // register mask
                const item = sharedMasks.trace(node, node.dumped, OBJ_DATA_MASK);
                item.result = maskData;
                maskNodes.push(node);
            }
        }
        // dump class
        const simpleKeys = simples.dump();
        const advancedKeys = advanceds.dump(simpleKeys.length);
        const keys = simpleKeys.concat(advancedKeys);
        const offset = CLASS_PROP_TYPE_OFFSET + 1 - simpleKeys.length;
        const dataTypes = advancedKeys.map((x) => this.properties.get(x));
        const classData = [classId, keys, offset, ...dataTypes];
        sharedClasses.get(this).result = classData;
    }
}
function registerType(types, node) {
    for (const type of types) {
        if (type.addNode(node)) {
            return;
        }
    }
    const type = new Type(node);
    types.push(type);
}
function default_1(classNodes) {
    const sharedClasses = new types_1.TraceableDict();
    const sharedMasks = new types_1.TraceableDict();
    const ctors = new Map();
    // generate types
    for (let i = 0; i < classNodes.length; ++i) {
        const node = classNodes[i];
        const classId = node.ctor;
        if (node instanceof types_1.CustomClassNode) {
            sharedClasses.traceString(classId, node.dumped, CUSTOM_OBJ_DATA_CLASS);
            continue;
        }
        let types = ctors.get(classId);
        if (!types) {
            types = [];
            ctors.set(classId, types);
        }
        registerType(types, node);
    }
    // generate class/mask
    for (const [classId, types] of ctors) {
        // let types = ctors.get(classId) as Type[];
        for (const type of types) {
            type.dump(classId, sharedClasses, sharedMasks);
        }
    }
    return {
        sharedClasses: sharedClasses.dump(),
        sharedMasks: sharedMasks.dump(),
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWNsYXNzLW1hc2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9lbmdpbmUvZWRpdG9yLWV4dGVuZHMvdXRpbHMvc2VyaWFsaXplL2NvbXBpbGVkL2NyZWF0ZS1jbGFzcy1tYXNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBdUtBLDRCQXFDQztBQTVNRCwyQkFFWTtBQUVaLDRCQUE0QjtBQUM1QixJQUFPLENBQUMsR0FBRyxnQkFBVyxDQUFDLFFBQVEsQ0FBQztBQUNoQyxJQUFPLFVBQVUsR0FBRyxDQUFDLENBQUMsV0FBVyxDQUFDO0FBS2xDLG1DQUFtRjtBQUVuRixNQUFNLEVBQ0Ysc0JBQXNCLEVBQ3RCLFVBQVUsRUFDVixhQUFhLEVBQ2IscUJBQXFCLEdBQ3hCLEdBQUcsZ0JBQVcsQ0FBQyxPQUFPLENBQUM7QUFFeEIsb0NBQW9DO0FBQ3BDLE1BQU0sSUFBSTtJQUNOLFVBQVUsR0FBRyxJQUFJLEdBQUcsRUFBc0IsQ0FBQztJQUMzQyxLQUFLLEdBQUcsSUFBSSxLQUFLLEVBQWEsQ0FBQztJQUUvQixZQUFZLElBQWU7UUFDdkIsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzdCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFTyxpQkFBaUIsQ0FBQyxJQUFlO1FBQ3JDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7UUFDbkMsS0FBSyxNQUFNLFNBQVMsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDdEMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3JELENBQUM7UUFDRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUs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ZXJpYWxpemUsXHJcbn0gZnJvbSAnY2MnO1xyXG5cclxuLy8gaW1wb3J0IGRlc2VyaWFsaXplciB0eXBlc1xyXG5pbXBvcnQgRCA9IGRlc2VyaWFsaXplLkludGVybmFsO1xyXG5pbXBvcnQgRGF0YVR5cGVJRCA9IEQuRGF0YVR5cGVJRF87XHJcbnR5cGUgSUNsYXNzID0gRC5JQ2xhc3NfO1xyXG50eXBlIElDbGFzc09iamVjdERhdGEgPSBELklDbGFzc09iamVjdERhdGFfO1xyXG50eXBlIElNYXNrID0gRC5JTWFza187XHJcblxyXG5pbXBvcnQgeyBDbGFzc05vZGUsIEN1c3RvbUNsYXNzTm9kZSwgVHJhY2VhYmxlRGljdCwgVHJhY2VhYmxlSXRlbSB9IGZyb20gJy4vdHlwZXMnO1xyXG5cclxuY29uc3Qge1xyXG4gICAgQ0xBU1NfUFJPUF9UWVBFX09GRlNFVCxcclxuICAgIE1BU0tfQ0xBU1MsXHJcbiAgICBPQkpfREFUQV9NQVNLLFxyXG4gICAgQ1VTVE9NX09CSl9EQVRBX0NMQVNTLFxyXG59ID0gZGVzZXJpYWxpemUuX21hY3JvcztcclxuXHJcbi8vIOWQjOS4gOS4quaehOmAoOWHveaVsO+8jOeUn+aIkOeahOexu+Wei+WPr+iDveacieWkmuS4qu+8jOavj+S4quexu+Wei+WPq+S9nOS4gOS4qiBUeXBl44CCXHJcbmNsYXNzIFR5cGUge1xyXG4gICAgcHJvcGVydGllcyA9IG5ldyBNYXA8c3RyaW5nLCBEYXRhVHlwZUlEPigpO1xyXG4gICAgbm9kZXMgPSBuZXcgQXJyYXk8Q2xhc3NOb2RlPigpO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKG5vZGU6IENsYXNzTm9kZSkge1xyXG4gICAgICAgIHRoaXMuc2V0Tm9kZVByb3BlcnRpZXMobm9kZSk7XHJcbiAgICAgICAgdGhpcy5ub2Rlcy5wdXNoKG5vZGUpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2V0Tm9kZVByb3BlcnRpZXMobm9kZTogQ2xhc3NOb2RlKSB7XHJcbiAgICAgICAgY29uc3QgcHJvcGVydGllcyA9IHRoaXMucHJvcGVydGllcztcclxuICAgICAgICBmb3IgKGNvbnN0IHNpbXBsZUtleSBvZiBub2RlLnNpbXBsZUtleXMpIHtcclxuICAgICAgICAgICAgcHJvcGVydGllcy5zZXQoc2ltcGxlS2V5LCBEYXRhVHlwZUlELlNpbXBsZVR5cGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuYWR2YW5jZWRzLmxlbmd0aDsgaSArPSAyKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGtleSA9IG5vZGUuYWR2YW5jZWRzW2ldIGFzIHN0cmluZztcclxuICAgICAgICAgICAgcHJvcGVydGllcy5zZXQoa2V5LCBub2RlLmFkdmFuY2Vkc1tpICsgMV0gYXMgRGF0YVR5cGVJRCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGFkZE5vZGUobm9kZTogQ2xhc3NOb2RlKTogYm9vbGVhbiB7XHJcbiAgICAgICAgY29uc3QgcHJvcGVydGllcyA9IHRoaXMucHJvcGVydGllcztcclxuICAgICAgICBsZXQgbGFja1Byb3BlcnR5ID0gZmFsc2U7XHJcbiAgICAgICAgZm9yIChjb25zdCBzaW1wbGVLZXkgb2Ygbm9kZS5zaW1wbGVLZXlzKSB7XHJcbiAgICAgICAgICAgIGlmIChwcm9wZXJ0aWVzLmhhcyhzaW1wbGVLZXkpKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAocHJvcGVydGllcy5nZXQoc2ltcGxlS2V5KSAhPT0gRGF0YVR5cGVJRC5TaW1wbGVUeXBlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5b2T5YmN57G755qE5p+Q5Liq5bGe5oCn57G75Z6L5ZKM55uu5qCH5a+56LGh55qE5LiN5ZCMXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbGFja1Byb3BlcnR5ID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuYWR2YW5jZWRzLmxlbmd0aDsgaSArPSAyKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGtleSA9IG5vZGUuYWR2YW5jZWRzW2ldIGFzIHN0cmluZztcclxuICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMuaGFzKGtleSkpIHtcclxuICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0aWVzLmdldChrZXkpICE9PSBub2RlLmFkdmFuY2Vkc1tpICsgMV0pIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyDlvZPliY3nsbvnmoTmn5DkuKrlsZ7mgKfnsbvlnovlkoznm67moIflr7nosaHnmoTkuI3lkIxcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBsYWNrUHJvcGVydHkgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAobGFja1Byb3BlcnR5KSB7XHJcbiAgICAgICAgICAgIC8vIOW9k+WJjeexu+eahOWxnuaAp+WSjOexu+Wei+aYr+ebruagh+WvueixoeeahOWtkOmbhlxyXG4gICAgICAgICAgICB0aGlzLnNldE5vZGVQcm9wZXJ0aWVzKG5vZGUpO1xyXG4gICAgICAgICAgICB0aGlzLm5vZGVzLnB1c2gobm9kZSk7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgLy8g5b2T5YmN57G75YyF5ZCr5LqG55uu5qCH5a+56LGh55qE5omA5pyJ5bGe5oCn5Y+K57G75Z6LXHJcbiAgICAgICAgICAgIHRoaXMubm9kZXMucHVzaChub2RlKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBzaG91bGRVc2VTYW1lTWFzayh0aGlzOiBDbGFzc05vZGUsIHJoczogQ2xhc3NOb2RlKTogYm9vbGVhbiB7XHJcbiAgICAgICAgY29uc3QgbGhzID0gdGhpcztcclxuXHJcbiAgICAgICAgY29uc3QgbHMgPSBsaHMuc2ltcGxlS2V5cztcclxuICAgICAgICBjb25zdCBycyA9IHJocy5zaW1wbGVLZXlzO1xyXG4gICAgICAgIGNvbnN0IGxhID0gbGhzLmFkdmFuY2VkcztcclxuICAgICAgICBjb25zdCByYSA9IHJocy5hZHZhbmNlZHM7XHJcblxyXG4gICAgICAgIGlmIChscy5sZW5ndGggIT09IHJzLmxlbmd0aCB8fCBsYS5sZW5ndGggIT09IHJhLmxlbmd0aCkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbHMubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgaWYgKGxzW2ldICE9PSByc1tpXSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGEubGVuZ3RoOyBpICs9IDIpIHtcclxuICAgICAgICAgICAgaWYgKGxhW2ldICE9PSByYVtpXSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIGR1bXAoY2xhc3NJZDogc3RyaW5nLCBzaGFyZWRDbGFzc2VzOiBUcmFjZWFibGVEaWN0PElDbGFzc3xzdHJpbmc+LCBzaGFyZWRNYXNrczogVHJhY2VhYmxlRGljdDxJTWFzaz4pIHtcclxuICAgICAgICAvLyDnvJPlrZjlvoXnlJ/miJDnmoTlsZ7mgKfliJfooahcclxuICAgICAgICBjb25zdCBzaW1wbGVzID0gbmV3IFRyYWNlYWJsZURpY3Q8c3RyaW5nPigpO1xyXG4gICAgICAgIGNvbnN0IGFkdmFuY2VkcyA9IG5ldyBUcmFjZWFibGVEaWN0PHN0cmluZz4oKTtcclxuXHJcbiAgICAgICAgLy8g57yT5a2Y5b6F55Sf5oiQ55qEIG1hc2sg5pWw5o2u77yM55Sx5LqO5q+P5LiqIG1hc2sg6YO95pyJ5LiO5YW25a6M5YWo5Yy56YWN55qE5a+56LGh57uT5p6E77yM5Zug5q2k55u05o6l5L2/55So5a+56LGh5pys6Lqr5YGa5Li657yT5a2Y5bCx6KGMXHJcbiAgICAgICAgY29uc3QgbWFza05vZGVzID0gbmV3IEFycmF5PENsYXNzTm9kZT4oKTtcclxuXHJcbiAgICAgICAgLy8gZHVtcCBtYXNrXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLm5vZGVzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLm5vZGVzW2ldO1xyXG4gICAgICAgICAgICBjb25zdCBtYXNrTm9kZSA9IG1hc2tOb2Rlcy5maW5kKFR5cGUuc2hvdWxkVXNlU2FtZU1hc2ssIG5vZGUpO1xyXG4gICAgICAgICAgICBpZiAobWFza05vZGUpIHtcclxuICAgICAgICAgICAgICAgIHNoYXJlZE1hc2tzLnRyYWNlKG1hc2tOb2RlLCBub2RlLmR1bXBlZCBhcyBJQ2xhc3NPYmplY3REYXRhLCBPQkpfREFUQV9NQVNLKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vIG5ldyBtYXNrXHJcbiAgICAgICAgICAgICAgICBjb25zdCBtYXNrRGF0YSA9IFtUcmFjZWFibGVEaWN0LlBMQUNFSE9MREVSXSBhcyBJTWFzaztcclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5zaW1wbGVLZXlzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qga2V5ID0gbm9kZS5zaW1wbGVLZXlzW2ldO1xyXG4gICAgICAgICAgICAgICAgICAgIHNpbXBsZXMudHJhY2VTdHJpbmcoa2V5LCBtYXNrRGF0YSwgbWFza0RhdGEubGVuZ3RoKTtcclxuICAgICAgICAgICAgICAgICAgICBtYXNrRGF0YS5wdXNoKFRyYWNlYWJsZURpY3QuUExBQ0VIT0xERVIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gbWFza0RhdGEubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLmFkdmFuY2Vkcy5sZW5ndGg7IGkgKz0gMikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IG5vZGUuYWR2YW5jZWRzW2ldIGFzIHN0cmluZztcclxuICAgICAgICAgICAgICAgICAgICBhZHZhbmNlZHMudHJhY2VTdHJpbmcoa2V5LCBtYXNrRGF0YSwgbWFza0RhdGEubGVuZ3RoKTtcclxuICAgICAgICAgICAgICAgICAgICBtYXNrRGF0YS5wdXNoKFRyYWNlYWJsZURpY3QuUExBQ0VIT0xERVIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgbWFza0RhdGEucHVzaChvZmZzZXQpO1xyXG4gICAgICAgICAgICAgICAgc2hhcmVkQ2xhc3Nlcy50cmFjZSh0aGlzLCBtYXNrRGF0YSwgTUFTS19DTEFTUyk7XHJcbiAgICAgICAgICAgICAgICAvLyByZWdpc3RlciBtYXNrXHJcbiAgICAgICAgICAgICAgICBjb25zdCBpdGVtID0gc2hhcmVkTWFza3MudHJhY2Uobm9kZSwgbm9kZS5kdW1wZWQgYXMgSUNsYXNzT2JqZWN0RGF0YSwgT0JKX0RBVEFfTUFTSyk7XHJcbiAgICAgICAgICAgICAgICBpdGVtLnJlc3VsdCA9IG1hc2tEYXRhO1xyXG4gICAgICAgICAgICAgICAgbWFza05vZGVzLnB1c2gobm9kZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGR1bXAgY2xhc3NcclxuXHJcbiAgICAgICAgY29uc3Qgc2ltcGxlS2V5cyA9IHNpbXBsZXMuZHVtcCgpO1xyXG4gICAgICAgIGNvbnN0IGFkdmFuY2VkS2V5cyA9IGFkdmFuY2Vkcy5kdW1wKHNpbXBsZUtleXMubGVuZ3RoKTtcclxuICAgICAgICBjb25zdCBrZXlzID0gc2ltcGxlS2V5cy5jb25jYXQoYWR2YW5jZWRLZXlzKTtcclxuXHJcbiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gQ0xBU1NfUFJPUF9UWVBFX09GRlNFVCArIDEgLSBzaW1wbGVLZXlzLmxlbmd0aDtcclxuICAgICAgICBjb25zdCBkYXRhVHlwZXMgPSBhZHZhbmNlZEtleXMubWFwKCh4KSA9PiB0aGlzLnByb3BlcnRpZXMuZ2V0KHgpKTtcclxuICAgICAgICBjb25zdCBjbGFzc0RhdGEgPSBbY2xhc3NJZCwga2V5cywgb2Zmc2V0LCAuLi5kYXRhVHlwZXNdIGFzIElDbGFzcztcclxuXHJcbiAgICAgICAgKHNoYXJlZENsYXNzZXMuZ2V0KHRoaXMpIGFzIFRyYWNlYWJsZUl0ZW0pLnJlc3VsdCA9IGNsYXNzRGF0YTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcmVnaXN0ZXJUeXBlKHR5cGVzOiBUeXBlW10sIG5vZGU6IENsYXNzTm9kZSkge1xyXG4gICAgZm9yIChjb25zdCB0eXBlIG9mIHR5cGVzKSB7XHJcbiAgICAgICAgaWYgKHR5cGUuYWRkTm9kZShub2RlKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgY29uc3QgdHlwZSA9IG5ldyBUeXBlKG5vZGUpO1xyXG4gICAgdHlwZXMucHVzaCh0eXBlKTtcclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24oY2xhc3NOb2RlczogKENsYXNzTm9kZXxDdXN0b21DbGFzc05vZGUpW10pOiB7XHJcbiAgICBzaGFyZWRDbGFzc2VzOiAoSUNsYXNzfHN0cmluZylbXSxcclxuICAgIHNoYXJlZE1hc2tzOiBJTWFza1tdLFxyXG59IHtcclxuICAgIGNvbnN0IHNoYXJlZENsYXNzZXMgPSBuZXcgVHJhY2VhYmxlRGljdDxJQ2xhc3N8c3RyaW5nPigpO1xyXG4gICAgY29uc3Qgc2hhcmVkTWFza3MgPSBuZXcgVHJhY2VhYmxlRGljdDxJTWFzaz4oKTtcclxuICAgIGNvbnN0IGN0b3JzID0gbmV3IE1hcDxzdHJpbmcsIFR5cGVbXT4oKTtcclxuXHJcbiAgICAvLyBnZW5lcmF0ZSB0eXBlc1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjbGFzc05vZGVzLmxlbmd0aDsgKytpKSB7XHJcbiAgICAgICAgY29uc3Qgbm9kZSA9IGNsYXNzTm9kZXNbaV07XHJcbiAgICAgICAgY29uc3QgY2xhc3NJZCA9IG5vZGUuY3RvcjtcclxuICAgICAgICBpZiAobm9kZSBpbnN0YW5jZW9mIEN1c3RvbUNsYXNzTm9kZSkge1xyXG4gICAgICAgICAgICBzaGFyZWRDbGFzc2VzLnRyYWNlU3RyaW5nKGNsYXNzSWQsIG5vZGUuZHVtcGVkIGFzIG9iamVjdCwgQ1VTVE9NX09CSl9EQVRBX0NMQVNTKTtcclxuICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgdHlwZXMgPSBjdG9ycy5nZXQoY2xhc3NJZCk7XHJcbiAgICAgICAgaWYgKCF0eXBlcykge1xyXG4gICAgICAgICAgICB0eXBlcyA9IFtdO1xyXG4gICAgICAgICAgICBjdG9ycy5zZXQoY2xhc3NJZCwgdHlwZXMpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZWdpc3RlclR5cGUodHlwZXMsIG5vZGUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGdlbmVyYXRlIGNsYXNzL21hc2tcclxuICAgIGZvciAoY29uc3QgW2NsYXNzSWQsIHR5cGVzXSBvZiBjdG9ycykge1xyXG4gICAgICAgIC8vIGxldCB0eXBlcyA9IGN0b3JzLmdldChjbGFzc0lkKSBhcyBUeXBlW107XHJcbiAgICAgICAgZm9yIChjb25zdCB0eXBlIG9mIHR5cGVzKSB7XHJcbiAgICAgICAgICAgIHR5cGUuZHVtcChjbGFzc0lkLCBzaGFyZWRDbGFzc2VzLCBzaGFyZWRNYXNrcyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgc2hhcmVkQ2xhc3Nlczogc2hhcmVkQ2xhc3Nlcy5kdW1wKCksXHJcbiAgICAgICAgc2hhcmVkTWFza3M6IHNoYXJlZE1hc2tzLmR1bXAoKSxcclxuICAgIH07XHJcbn1cclxuIl19