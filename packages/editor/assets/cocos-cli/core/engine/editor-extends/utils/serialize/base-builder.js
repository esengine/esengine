"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Builder = void 0;
const serialization_1 = require("cc/editor/serialization");
// 通过 builder 的 API，把当前序列化的所有数据传输给 builder，由 builder 生成具体的序列化格式
class Builder {
    constructor(options) {
        this.minify = !!options.minify;
        this.stringify = !!('stringify' in options ? options.stringify : true);
        this._useCCON = options.useCCON ?? false;
    }
    // // 标记对象处于被多个参数共同引用的状态
    // markAsSharedObj (obj: any): void;
    dump() {
        if (this._useCCON) {
            return this._dumpAsCCON();
        }
        else {
            return this._dumpAsJson();
        }
    }
    get hasBinaryBuffer() {
        return this._useCCON;
    }
    get mainBufferBuilder() {
        return this._mainBufferBuilder;
    }
    stringify;
    minify;
    _mainBufferBuilder = new serialization_1.BufferBuilder();
    _dumpAsJson() {
        const mainJsonData = this.finalizeJsonPart();
        if (this.stringify) {
            return JSON.stringify(mainJsonData, null, this.minify ? 0 : 2);
        }
        else {
            return mainJsonData;
        }
    }
    _dumpAsCCON() {
        const json = this.finalizeJsonPart();
        const { _mainBufferBuilder: mainBufferBuilder } = this;
        const chunks = mainBufferBuilder.byteLength === 0
            ? []
            : [mainBufferBuilder.get()];
        return new serialization_1.CCON(json, chunks);
    }
}
exports.Builder = Builder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvZW5naW5lL2VkaXRvci1leHRlbmRzL3V0aWxzL3NlcmlhbGl6ZS9iYXNlLWJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsMkRBQThEO0FBRzlELCtEQUErRDtBQUMvRCxNQUFzQixPQUFPO0lBQ3pCLFlBQVksT0FBd0I7UUFDaEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztRQUMvQixJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQyxDQUFDLFdBQVcsSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3ZFLElBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLE9BQU8sSUFBSSxLQUFLLENBQUM7SUFDN0MsQ0FBQztJQXlDRCx3QkFBd0I7SUFDeEIsb0NBQW9DO0lBRXBDLElBQUk7UUFDQSxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNoQixPQUFPLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUM5QixDQUFDO2FBQU0sQ0FBQztZQUNKLE9BQU8sSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzlCLENBQUM7SUFDTCxDQUFDO0lBSUQsSUFBYyxlQUFlO1FBQ3pCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN6QixDQUFDO0lBRUQsSUFBYyxpQkFBaUI7UUFDM0IsT0FBTyxJQUFJLENBQUMsa0JBQWtCLENBQUM7SUFDbkMsQ0FBQztJQUVPLFNBQVMsQ0FBVTtJQUNuQixNQUFNLENBQVU7SUFJaEIsa0JBQWtCLEdBQUcsSUFBSSw2QkFBYSxFQUFFLENBQUM7SUFFekMsV0FBVztRQUNmLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQzdDLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ2pCLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkUsQ0FBQzthQUNJLENBQUM7WUFDRixPQUFPLFlBQVksQ0FBQztRQUN4QixDQUFDO0lBQ0wsQ0FBQztJQUVPLFdBQVc7UUFDZixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUNyQyxNQUFNLEVBQUUsa0JBQWtCLEVBQUUsaUJBQWlCLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDdkQsTUFBTSxNQUFNLEdBQWlCLGlCQUFpQixDQUFDLFVBQVUsS0FBSyxDQUFDO1lBQzNELENBQUMsQ0FBQyxFQUFFO1lBQ0osQ0FBQyxDQUFDLENBQUMsaUJBQWlCLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUNoQyxPQUFPLElBQUksb0JBQUksQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDbEMsQ0FBQztDQUNKO0FBNUZELDBCQTRGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgVmFsdWVUeXBlIH0gZnJvbSAnY2MnO1xyXG5pbXBvcnQgeyBCdWZmZXJCdWlsZGVyLCBDQ09OIH0gZnJvbSAnY2MvZWRpdG9yL3NlcmlhbGl6YXRpb24nO1xyXG5pbXBvcnQgeyBJQXJyYXlPcHRpb25zLCBJQ2xhc3NPcHRpb25zLCBJQ3VzdG9tQ2xhc3NPcHRpb25zLCBJT2JqUGFyc2luZ0luZm8sIFByb3BlcnR5T3B0aW9ucyB9IGZyb20gJy4vcGFyc2VyJztcclxuXHJcbi8vIOmAmui/hyBidWlsZGVyIOeahCBBUEnvvIzmiorlvZPliY3luo/liJfljJbnmoTmiYDmnInmlbDmja7kvKDovpPnu5kgYnVpbGRlcu+8jOeUsSBidWlsZGVyIOeUn+aIkOWFt+S9k+eahOW6j+WIl+WMluagvOW8j1xyXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQnVpbGRlciB7XHJcbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiBJQnVpbGRlck9wdGlvbnMpIHtcclxuICAgICAgICB0aGlzLm1pbmlmeSA9ICEhb3B0aW9ucy5taW5pZnk7XHJcbiAgICAgICAgdGhpcy5zdHJpbmdpZnkgPSAhISgnc3RyaW5naWZ5JyBpbiBvcHRpb25zID8gb3B0aW9ucy5zdHJpbmdpZnkgOiB0cnVlKTtcclxuICAgICAgICB0aGlzLl91c2VDQ09OID0gb3B0aW9ucy51c2VDQ09OID8/IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qXHJcbiAgICAgKiBzZXRQcm9wZXJ0eV9YWFgg55So5LqO5re75Yqg5LiA5Liq5YWD57Sg5Yiw5bqP5YiX5YyW57uT5p6E5Lit77yM6YCa6L+HIG93bmVyL2tleSDmnaXlhbPogZTliLDnjrDmnInlr7nosaHkuIpcclxuICAgICAqIEBtZXRob2Qgc2V0UHJvcGVydHlfWFhYXHJcbiAgICAgKiBAcGFyYW0gb3duZXIgLSDmjIHmnInor6Xlr7nosaHnmoTniLblr7nosaHvvIzlv4XpobvmmK/lt7Lmt7vliqDov4fnmoTlr7nosaHjgILlpoLmnpzmmK/moLnlr7nosaHliJnkuLogbnVsbOOAglxyXG4gICAgICogQHBhcmFtIG93bmVySW5mbyAtIOeItuWvueixoeeahCBJT2JqUGFyc2luZ0luZm9cclxuICAgICAqIEBwYXJhbSBrZXkgLSDlrZfnrKbkuLLliJnooajnpLrlsZ7mgKflkI3vvIxudW1iZXIg5YiZ6KGo56S65pWw57uE57Si5byVXHJcbiAgICAgKiBAcGFyYW0gdmFsdWUgLSDopoHmt7vliqDnmoTlhYPntKDvvIzlrp7pmYXkuIrlsLHnrYnkuo4gb3duZXJba2V5XVxyXG4gICAgICogQHBhcmFtIG9wdGlvbnMgLSDlhYPntKDlj4LmlbDvvIzkuI3lj6/nnIHnlaXvvIzov5nmmK/kuLrkuobljLnphY3lvaLlj4Llkozlrp7lj4LvvIzkvJjljJbmgKfog73jgIJcclxuICAgICAqICAgICAgICAgICAgICAgICAg5Y+C6ICDIGh0dHBzOi8vbXJhbGUucGgvYmxvZy8yMDE4LzAyLzAzL21heWJlLXlvdS1kb250LW5lZWQtcnVzdC10by1zcGVlZC11cC15b3VyLWpzLmh0bWwjb3B0aW1pemluZy1zb3J0aW5nLS0tYXJndW1lbnQtYWRhcHRhdGlvblxyXG4gICAgICogQHJldHVybiAtIHZhbHVlIOeahCBJT2JqUGFyc2luZ0luZm9cclxuICAgICAqL1xyXG5cclxuICAgIC8vIOWPr+ebtOaOpei1i+WAvOeahOWtl+aute+8jOWPr+S7peaYr+S7u+aEjyBKU09OIOS4reeahOWAvO+8jOS9huaYr+S4jeiDveaYr+WvueixoeOAgu+8iERhdGFUeXBlSUQuU2ltcGxlVHlwZSDlj6/ku6XmmK8gSlNPTiDlr7nosaHvvIlcclxuICAgIC8vIOWMheWQqyB1bmRlZmluZWTvvIjluo/liJfljJbml7blj6/og73kuI3mlK/mjIHvvIkg5ZKMIG51bGzjgILlhbblroPnsbvlnovlgLzpg73kuI3lj6/kuLogbnVsbOOAglxyXG4gICAgYWJzdHJhY3Qgc2V0UHJvcGVydHlfUmF3KG93bmVyOiBvYmplY3QsIG93bmVySW5mbzogSU9ialBhcnNpbmdJbmZvLCBrZXk6IHN0cmluZyB8IG51bWJlciwgdmFsdWU6IGFueSwgb3B0aW9uczogUHJvcGVydHlPcHRpb25zKTogdm9pZDtcclxuXHJcbiAgICAvLyBDQ0NsYXNzIOWvueixoe+8jOWQq+iHquWumuS5ieS6huW6j+WIl+WMluWHveaVsOeahOWvueixoVxyXG4gICAgYWJzdHJhY3Qgc2V0UHJvcGVydHlfQ2xhc3Mob3duZXI6IG9iamVjdCB8IG51bGwsIG93bmVySW5mbzogSU9ialBhcnNpbmdJbmZvIHwgbnVsbCwga2V5OiBzdHJpbmcgfCBudW1iZXIsIG9wdGlvbnM6IElDbGFzc09wdGlvbnMpOiBJT2JqUGFyc2luZ0luZm87XHJcblxyXG4gICAgLy8g6Ieq5a6a5LmJ5LqG5bqP5YiX5YyW5Ye95pWw55qE5a+56LGhXHJcbiAgICBhYnN0cmFjdCBzZXRQcm9wZXJ0eV9DdXN0b21pemVkQ2xhc3Mob3duZXI6IG9iamVjdCB8IG51bGwsIG93bmVySW5mbzogSU9ialBhcnNpbmdJbmZvIHwgbnVsbCwga2V5OiBzdHJpbmcgfCBudW1iZXIsIG9wdGlvbnM6IElDdXN0b21DbGFzc09wdGlvbnMpOiBJT2JqUGFyc2luZ0luZm87XHJcblxyXG4gICAgLy8g6L+U5Zue5piv5ZCm5Y+v6KKrIGJ1aWxkZXIg5aSE55CG77yM5aaC5peg5rOV5aSE55CG6ZyA6KaBIHBhcnNlciDlvZPlgZrmma7pgJrnmoQgQ2xhc3Mg6L+b6KGM6Kej5p6QXHJcbiAgICBhYnN0cmFjdCBzZXRQcm9wZXJ0eV9WYWx1ZVR5cGUob3duZXI6IG9iamVjdCB8IG51bGwsIG93bmVySW5mbzogSU9ialBhcnNpbmdJbmZvIHwgbnVsbCwga2V5OiBzdHJpbmcgfCBudW1iZXIsIHZhbHVlOiBWYWx1ZVR5cGUsIG9wdGlvbnM6IFByb3BlcnR5T3B0aW9ucyk6IElPYmpQYXJzaW5nSW5mbyB8IG51bGw7XHJcblxyXG4gICAgYWJzdHJhY3Qgc2V0UHJvcGVydHlfVHlwZWRBcnJheShvd25lcjogb2JqZWN0LCBvd25lckluZm86IElPYmpQYXJzaW5nSW5mbywga2V5OiBzdHJpbmcgfCBudW1iZXIsIHZhbHVlOiBhbnksIG9wdGlvbnM6IFByb3BlcnR5T3B0aW9ucyk6IHZvaWQ7XHJcblxyXG4gICAgYWJzdHJhY3Qgc2V0UHJvcGVydHlfQXNzZXRVdWlkKG93bmVyOiBvYmplY3QsIG93bmVySW5mbzogSU9ialBhcnNpbmdJbmZvLCBrZXk6IHN0cmluZyB8IG51bWJlciwgdXVpZDogc3RyaW5nLCBvcHRpb25zOiBQcm9wZXJ0eU9wdGlvbnMpOiB2b2lkO1xyXG5cclxuICAgIGFic3RyYWN0IHNldFByb3BlcnR5X0FycmF5KG93bmVyOiBvYmplY3QgfCBudWxsLCBvd25lckluZm86IElPYmpQYXJzaW5nSW5mbyB8IG51bGwsIGtleTogc3RyaW5nIHwgbnVtYmVyLCBvcHRpb25zOiBJQXJyYXlPcHRpb25zKTogSU9ialBhcnNpbmdJbmZvO1xyXG5cclxuICAgIC8vIEphdmFTY3JpcHQgUHJpbWl0aXZlIE9iamVjdFxyXG4gICAgYWJzdHJhY3Qgc2V0UHJvcGVydHlfRGljdChvd25lcjogb2JqZWN0IHwgbnVsbCwgb3duZXJJbmZvOiBJT2JqUGFyc2luZ0luZm8gfCBudWxsLCBrZXk6IHN0cmluZyB8IG51bWJlciwgb3B0aW9uczogUHJvcGVydHlPcHRpb25zKTogSU9ialBhcnNpbmdJbmZvO1xyXG5cclxuICAgIC8vIOS5i+WJjeW3sue7j+eZu+iusOi/h+eahOWvueixoe+8jOWPr+S7peS9v+eUqOi/meS4quexu+Wei++8jOS7hea3u+WKoOW8leeUqOWFs+ezu1xyXG4gICAgYWJzdHJhY3Qgc2V0UHJvcGVydHlfUGFyc2VkT2JqZWN0KG93bmVySW5mbzogSU9ialBhcnNpbmdJbmZvLCBrZXk6IHN0cmluZyB8IG51bWJlciwgdmFsdWVJbmZvOiBJT2JqUGFyc2luZ0luZm8sIGZvcm1lcmx5U2VyaWFsaXplZEFzOiBzdHJpbmcgfCBudWxsKTogdm9pZDtcclxuXHJcbiAgICBhYnN0cmFjdCBzZXRSb290KG9iakluZm86IElPYmpQYXJzaW5nSW5mbyk6IHZvaWQ7XHJcblxyXG4gICAgLy8gLy8g5qCH6K6w5a+56LGh5aSE5LqO6KKr5aSa5Liq5Y+C5pWw5YWx5ZCM5byV55So55qE54q25oCBXHJcbiAgICAvLyBtYXJrQXNTaGFyZWRPYmogKG9iajogYW55KTogdm9pZDtcclxuXHJcbiAgICBkdW1wKCk6IG9iamVjdCB8IHN0cmluZyB8IENDT04ge1xyXG4gICAgICAgIGlmICh0aGlzLl91c2VDQ09OKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kdW1wQXNDQ09OKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2R1bXBBc0pzb24oKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IGZpbmFsaXplSnNvblBhcnQoKTogYW55O1xyXG5cclxuICAgIHByb3RlY3RlZCBnZXQgaGFzQmluYXJ5QnVmZmVyKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl91c2VDQ09OO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBnZXQgbWFpbkJ1ZmZlckJ1aWxkZXIoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX21haW5CdWZmZXJCdWlsZGVyO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc3RyaW5naWZ5OiBib29sZWFuO1xyXG4gICAgcHJpdmF0ZSBtaW5pZnk6IGJvb2xlYW47XHJcblxyXG4gICAgcHJpdmF0ZSBkZWNsYXJlIF91c2VDQ09OOiBib29sZWFuO1xyXG5cclxuICAgIHByaXZhdGUgX21haW5CdWZmZXJCdWlsZGVyID0gbmV3IEJ1ZmZlckJ1aWxkZXIoKTtcclxuXHJcbiAgICBwcml2YXRlIF9kdW1wQXNKc29uKCkge1xyXG4gICAgICAgIGNvbnN0IG1haW5Kc29uRGF0YSA9IHRoaXMuZmluYWxpemVKc29uUGFydCgpO1xyXG4gICAgICAgIGlmICh0aGlzLnN0cmluZ2lmeSkge1xyXG4gICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkobWFpbkpzb25EYXRhLCBudWxsLCB0aGlzLm1pbmlmeSA/IDAgOiAyKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBtYWluSnNvbkRhdGE7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2R1bXBBc0NDT04oKSB7XHJcbiAgICAgICAgY29uc3QganNvbiA9IHRoaXMuZmluYWxpemVKc29uUGFydCgpO1xyXG4gICAgICAgIGNvbnN0IHsgX21haW5CdWZmZXJCdWlsZGVyOiBtYWluQnVmZmVyQnVpbGRlciB9ID0gdGhpcztcclxuICAgICAgICBjb25zdCBjaHVua3M6IFVpbnQ4QXJyYXlbXSA9IG1haW5CdWZmZXJCdWlsZGVyLmJ5dGVMZW5ndGggPT09IDBcclxuICAgICAgICAgICAgPyBbXVxyXG4gICAgICAgICAgICA6IFttYWluQnVmZmVyQnVpbGRlci5nZXQoKV07XHJcbiAgICAgICAgcmV0dXJuIG5ldyBDQ09OKGpzb24sIGNodW5rcyk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSUJ1aWxkZXJPcHRpb25zIHtcclxuICAgIGJ1aWxkZXI/OiAnZHluYW1pYycgfCAnY29tcGlsZWQnO1xyXG4gICAgLy8gaW5kaWNhdGVzIHdoZXRoZXIgbmVlZHMgdG8gY29udmVydCB0aGUgcmVzdWx0IGJ5IEpTT04uc3RyaW5naWZ5LCBkZWZhdWx0IGlzIHRydWVcclxuICAgIHN0cmluZ2lmeT86IGJvb2xlYW47XHJcbiAgICAvLyBkZWZhdWx0IGlzIGZhbHNlXHJcbiAgICBtaW5pZnk/OiBib29sZWFuO1xyXG4gICAgLy8gZGVmYXVsdCBpcyB0cnVlXHJcbiAgICBub05hdGl2ZURlcD86IGJvb2xlYW47XHJcbiAgICAvLyDlvLrliLblhoXogZTmiYDmnInmlbDmja7vvIzkuI3opoHlh7rnjrAgX19pZF9f77yM566A5YyW6Kej5p6Q6YC76L6R77yM5aaC5LiN5pSv5oyB5bCG5Lya5oqb5Ye65byC5bi4XHJcbiAgICAvLyDlkK/nlKjlkI7vvIzlpoLmnpzlpJrlpITlvJXnlKjnm7jlkIzlr7nosaHvvIzluo/liJfljJbnu5PmnpzlsIbkvJrkuI3lh4bnoa7vvJvlpoLmnpzlh7rnjrDlvqrnjq/lvJXnlKjvvIxKU09OLnN0cmluZ2lmeSDml7blsIbkvJrlh7rplJlcclxuICAgIGZvcmNlSW5saW5lPzogYm9vbGVhbjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIE91dHB1dHMgYXMgQ0NPTi5cclxuICAgICAqIFxyXG4gICAgICogQ0NPTiBkZW5vdGVzIGBDb2NvcyBDcmVhdG9yIE9iamVjdCBOb3RhdGlvbmAobGV0J3MgaW1hZ2luZSBKU09OIGFzIEphdmFTY3JpcHQgT2JqZWN0IE5vdGF0aW9uKS5cclxuICAgICAqIEl0IGFsbG93cyBiaW5hcnkgcmVwcmVzZW50YXRpb24gb2Ygc29tZSB2YWx1ZSBidXQgbG9zZXMgdGhlIHJlYWRhYmlsaXR5LlxyXG4gICAgICogXHJcbiAgICAgKiBDQ09OIGNhbiBiZSByZXByZXNlbnRlZCBhcyB0d28gZm9ybWFsOlxyXG4gICAgICogLSBKU09OICsgQmluYXJ5IGZpbGUocylcclxuICAgICAqIC0gU2luZ2xlIEJpbmFyeSBmaWxlXHJcbiAgICAgKiBIb3dldmVyIGBzZXJpYWxpemUoKWAgcHJvZHVjZXMgd2hvbGUgYENDT05gIGFuZCB5b3UgY291bGQgc2VsZWN0IGEgc3VpdGFibGUgZm9ybWFsLlxyXG4gICAgICogQXMgQ29jb3MgQ3JlYXRvciAzLjMsIHRoZSBgdXNlQ0NPTmAgb25seSBiZSB0dXJuZWQgb25cclxuICAgICAqIHdoZW4gaXQncyBnb2luZyB0byBzZXJpYWxpemUgYEFuaW1hdGlvbkNsaXBgIGludG8gbGlicmFyeSBvciBpbnRvIHByb2R1Y3Rpb24uXHJcbiAgICAgKi9cclxuICAgIHVzZUNDT04/OiBib29sZWFuO1xyXG59Il19