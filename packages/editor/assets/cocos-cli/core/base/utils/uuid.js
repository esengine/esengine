'use strict';
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.NonUuidMark = void 0;
exports.compressUUID = compressUUID;
exports.compressHex = compressHex;
exports.decompressUUID = decompressUUID;
exports.isUUID = isUUID;
exports.getUuidFromLibPath = getUuidFromLibPath;
exports.generate = generate;
exports.nameToSubId = nameToSubId;
const crypto_1 = require("crypto");
const node_uuid_1 = __importDefault(require("node-uuid"));
const Base64KeyChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
const AsciiTo64 = new Array(128);
for (let i = 0; i < 128; ++i) {
    AsciiTo64[i] = 0;
}
for (let i = 0; i < 64; ++i) {
    AsciiTo64[Base64KeyChars.charCodeAt(i)] = i;
}
const Reg_Dash = /-/g;
const Reg_Uuid = /^[0-9a-fA-F-]{36}$/;
const Reg_NormalizedUuid = /^[0-9a-fA-F]{32}$/;
const Reg_CompressedUuid = /^[0-9a-zA-Z+/]{22,23}$/;
const Reg_CompressedSubAssetUuid = /^([0-9a-zA-Z+/]{22,23})((@[0-9a-fA-F]{5,})+)+$/;
const Reg_subAssetUuid = /([^@]{32,36})((@[0-9a-fA-F]{5,})+)+$/;
const Reg_UuidInLibPath = /.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-]{8,}((@[0-9a-fA-F]{5,})+)?).*/;
// 加了这个标记后，字符串就不可能会是 uuid 了。
exports.NonUuidMark = '.';
// 压缩后的 uuid 可以减小保存时的尺寸，但不能做为文件名（因为无法区分大小写并且包含非法字符）。
// 默认将 uuid 的后面 27 位压缩成 18 位，前 5 位保留下来，方便调试。
// fc991dd7-0033-4b80-9d41-c8a86a702e59 -> fc9913XADNLgJ1ByKhqcC5Z
// 如果启用 min 则将 uuid 的后面 30 位压缩成 20 位，前 2 位保留不变。
// fc991dd7-0033-4b80-9d41-c8a86a702e59 -> fcmR3XADNLgJ1ByKhqcC5Z
/*
 * @param {Boolean} [min=false]
 */
function compressUUID(uuid, min) {
    const result = uuid.match(Reg_subAssetUuid);
    if (!result) {
        return compressNormalUuid(uuid, min);
    }
    uuid = result[1];
    return compressNormalUuid(uuid, min) + result[2];
}
function compressNormalUuid(uuid, min) {
    if (Reg_Uuid.test(uuid)) {
        uuid = uuid.replace(Reg_Dash, '');
    }
    else if (!Reg_NormalizedUuid.test(uuid)) {
        return uuid;
    }
    const reserved = (min === true) ? 2 : 5;
    return compressHex(uuid, reserved);
}
function compressHex(hexString, reservedHeadLength) {
    const length = hexString.length;
    let i;
    if (typeof reservedHeadLength !== 'undefined') {
        i = reservedHeadLength;
    }
    else {
        i = length % 3;
    }
    const head = hexString.slice(0, i);
    const base64Chars = [];
    while (i < length) {
        const hexVal1 = parseInt(hexString[i], 16);
        const hexVal2 = parseInt(hexString[i + 1], 16);
        const hexVal3 = parseInt(hexString[i + 2], 16);
        base64Chars.push(Base64KeyChars[(hexVal1 << 2) | (hexVal2 >> 2)]);
        base64Chars.push(Base64KeyChars[((hexVal2 & 3) << 4) | hexVal3]);
        i += 3;
    }
    return head + base64Chars.join('');
}
function decompressUUID(uuid) {
    const result = uuid.match(Reg_CompressedSubAssetUuid);
    if (!result) {
        return decompressNormalUuid(uuid);
    }
    uuid = result[1];
    return decompressNormalUuid(uuid) + result[2];
}
function decompressNormalUuid(str) {
    if (str.length === 23) {
        // decode base64
        const hexChars = [];
        for (let i = 5; i < 23; i += 2) {
            const lhs = AsciiTo64[str.charCodeAt(i)];
            const rhs = AsciiTo64[str.charCodeAt(i + 1)];
            hexChars.push((lhs >> 2).toString(16));
            hexChars.push((((lhs & 3) << 2) | rhs >> 4).toString(16));
            hexChars.push((rhs & 0xF).toString(16));
        }
        //
        str = str.slice(0, 5) + hexChars.join('');
    }
    else if (str.length === 22) {
        // decode base64
        const hexChars = [];
        for (let i = 2; i < 22; i += 2) {
            const lhs = AsciiTo64[str.charCodeAt(i)];
            const rhs = AsciiTo64[str.charCodeAt(i + 1)];
            hexChars.push((lhs >> 2).toString(16));
            hexChars.push((((lhs & 3) << 2) | rhs >> 4).toString(16));
            hexChars.push((rhs & 0xF).toString(16));
        }
        //
        str = str.slice(0, 2) + hexChars.join('');
    }
    else {
        return str;
    }
    return [str.slice(0, 8), str.slice(8, 12), str.slice(12, 16), str.slice(16, 20), str.slice(20)].join('-');
}
function isUUID(str) {
    return Reg_CompressedUuid.test(str) || Reg_NormalizedUuid.test(str) || Reg_Uuid.test(str) || Reg_subAssetUuid.test(str);
}
// 从路径中提取 uuid
// 支持类似 ".../5b/5b9cbc23-76b3-41ff-9953-4219fdbea72c/Fontin-SmallCaps.ttf" 这样的
function getUuidFromLibPath(path) {
    const matches = path.match(Reg_UuidInLibPath);
    if (matches) {
        return encodeURI(matches[1]);
    }
    return '';
}
function generate(compress = true) {
    const uuid = node_uuid_1.default.v4();
    return compress ? compressUUID(uuid, compress) : uuid;
}
const _extendIndex = [
    1, 2, 3, 4, 5,
    7, 8, 9, 10, 11, 12, 13, 14, 15,
    17, 18, 19, 20, 21, 22, 23, 24,
    26, 27, 28, 29, 30,
];
/**
 * 从一个名字转换成一个 id
 * 这是个有损压缩，并不能够还原成原来的名字
 * 注意：此方法需要和 asset-db 保持一致
 * @param id
 * @param extend
 */
function nameToSubId(name, extend = 0) {
    const md5 = (0, crypto_1.createHash)('md5').update(name).digest('hex');
    let id = md5[0] + md5[6] + md5[16] + md5[25] + md5[31];
    for (let i = 0; i < extend; i++) {
        id += md5[_extendIndex[i]];
    }
    return id;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXVpZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb3JlL2Jhc2UvdXRpbHMvdXVpZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7Ozs7OztBQThCYixvQ0FPQztBQVlELGtDQW1CQztBQUVELHdDQVFDO0FBaUNELHdCQUVDO0FBSUQsZ0RBTUM7QUFFRCw0QkFHQztBQWdCRCxrQ0FPQztBQXJKRCxtQ0FBb0M7QUFFcEMsMERBQTZCO0FBQzdCLE1BQU0sY0FBYyxHQUFHLGtFQUFrRSxDQUFDO0FBRTFGLE1BQU0sU0FBUyxHQUFHLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2pDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztJQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7QUFBQyxDQUFDO0FBQ25ELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztJQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQUMsQ0FBQztBQUU3RSxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUM7QUFDdEIsTUFBTSxRQUFRLEdBQUcsb0JBQW9CLENBQUM7QUFDdEMsTUFBTSxrQkFBa0IsR0FBRyxtQkFBbUIsQ0FBQztBQUMvQyxNQUFNLGtCQUFrQixHQUFHLHdCQUF3QixDQUFDO0FBQ3BELE1BQU0sMEJBQTBCLEdBQUcsZ0RBQWdELENBQUM7QUFDcEYsTUFBTSxnQkFBZ0IsR0FBRyxzQ0FBc0MsQ0FBQztBQUNoRSxNQUFNLGlCQUFpQixHQUFHLHNFQUFzRSxDQUFDO0FBRWpHLDRCQUE0QjtBQUNmLFFBQUEsV0FBVyxHQUFHLEdBQUcsQ0FBQztBQUUvQixvREFBb0Q7QUFDcEQsNENBQTRDO0FBQzVDLGtFQUFrRTtBQUNsRSwrQ0FBK0M7QUFDL0MsaUVBQWlFO0FBQ2pFOztHQUVHO0FBQ0gsU0FBZ0IsWUFBWSxDQUFDLElBQVksRUFBRSxHQUFZO0lBQ25ELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUM1QyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDVixPQUFPLGtCQUFrQixDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBQ0QsSUFBSSxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNqQixPQUFPLGtCQUFrQixDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDckQsQ0FBQztBQUVELFNBQVMsa0JBQWtCLENBQUMsSUFBWSxFQUFFLEdBQVk7SUFDbEQsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDdEIsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7U0FBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDeEMsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUNELE1BQU0sUUFBUSxHQUFHLENBQUMsR0FBRyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN4QyxPQUFPLFdBQVcsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7QUFDdkMsQ0FBQztBQUVELFNBQWdCLFdBQVcsQ0FBQyxTQUFpQixFQUFFLGtCQUEwQjtJQUNyRSxNQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDO0lBQ2hDLElBQUksQ0FBQyxDQUFDO0lBQ04sSUFBSSxPQUFPLGtCQUFrQixLQUFLLFdBQVcsRUFBRSxDQUFDO1FBQzVDLENBQUMsR0FBRyxrQkFBa0IsQ0FBQztJQUMzQixDQUFDO1NBQU0sQ0FBQztRQUNKLENBQUMsR0FBRyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQ25CLENBQUM7SUFDRCxNQUFNLElBQUksR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNuQyxNQUFNLFdBQVcsR0FBRyxFQUFFLENBQUM7SUFDdkIsT0FBTyxDQUFDLEdBQUcsTUFBTSxFQUFFLENBQUM7UUFDaEIsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUMzQyxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUMvQyxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUMvQyxXQUFXLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEUsV0FBVyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ2pFLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDWCxDQUFDO0lBQ0QsT0FBTyxJQUFJLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN2QyxDQUFDO0FBRUQsU0FBZ0IsY0FBYyxDQUFDLElBQVk7SUFDdkMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0lBQ3RELElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNWLE9BQU8sb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUVELElBQUksR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDakIsT0FBTyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDbEQsQ0FBQztBQUVELFNBQVMsb0JBQW9CLENBQUMsR0FBVztJQUNyQyxJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssRUFBRSxFQUFFLENBQUM7UUFDcEIsZ0JBQWdCO1FBQ2hCLE1BQU0sUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNwQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUM3QixNQUFNLEdBQUcsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3pDLE1BQU0sR0FBRyxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDdkMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzFELFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDNUMsQ0FBQztRQUNELEVBQUU7UUFDRixHQUFHLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM5QyxDQUFDO1NBQU0sSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLEVBQUUsRUFBRSxDQUFDO1FBQzNCLGdCQUFnQjtRQUNoQixNQUFNLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFDcEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDN0IsTUFBTSxHQUFHLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN6QyxNQUFNLEdBQUcsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM3QyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3ZDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUMxRCxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzVDLENBQUM7UUFDRCxFQUFFO1FBQ0YsR0FBRyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDOUMsQ0FBQztTQUFNLENBQUM7UUFDSixPQUFPLEdBQUcsQ0FBQztJQUNmLENBQUM7SUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUM5RyxDQUFDO0FBRUQsU0FBZ0IsTUFBTSxDQUFDLEdBQVc7SUFDOUIsT0FBTyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksa0JBQWtCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzVILENBQUM7QUFFRCxjQUFjO0FBQ2QsOEVBQThFO0FBQzlFLFNBQWdCLGtCQUFrQixDQUFDLElBQVk7SUFDM0MsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0lBQzlDLElBQUksT0FBTyxFQUFFLENBQUM7UUFDVixPQUFPLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBQ0QsT0FBTyxFQUFFLENBQUM7QUFDZCxDQUFDO0FBRUQsU0FBZ0IsUUFBUSxDQUFDLFFBQVEsR0FBRyxJQUFJO0lBQ3BDLE1BQU0sSUFBSSxHQUFHLG1CQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDdkIsT0FBTyxRQUFRLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztBQUMxRCxDQUFDO0FBRUQsTUFBTSxZQUFZLEdBQUc7SUFDakIsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUM7SUFDYixDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUU7SUFDL0IsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUU7SUFDOUIsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUU7Q0FDckIsQ0FBQztBQUVGOzs7Ozs7R0FNRztBQUNILFNBQWdCLFdBQVcsQ0FBQyxJQUFZLEVBQUUsTUFBTSxHQUFHLENBQUM7SUFDaEQsTUFBTSxHQUFHLEdBQUcsSUFBQSxtQkFBVSxFQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDekQsSUFBSSxFQUFFLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUN2RCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDOUIsRUFBRSxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBQ0QsT0FBTyxFQUFFLENBQUM7QUFDZCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG5cclxuaW1wb3J0IHsgY3JlYXRlSGFzaCB9IGZyb20gJ2NyeXB0byc7XHJcblxyXG5pbXBvcnQgVXVpZCBmcm9tICdub2RlLXV1aWQnO1xyXG5jb25zdCBCYXNlNjRLZXlDaGFycyA9ICdBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OSsvJztcclxuXHJcbmNvbnN0IEFzY2lpVG82NCA9IG5ldyBBcnJheSgxMjgpO1xyXG5mb3IgKGxldCBpID0gMDsgaSA8IDEyODsgKytpKSB7IEFzY2lpVG82NFtpXSA9IDA7IH1cclxuZm9yIChsZXQgaSA9IDA7IGkgPCA2NDsgKytpKSB7IEFzY2lpVG82NFtCYXNlNjRLZXlDaGFycy5jaGFyQ29kZUF0KGkpXSA9IGk7IH1cclxuXHJcbmNvbnN0IFJlZ19EYXNoID0gLy0vZztcclxuY29uc3QgUmVnX1V1aWQgPSAvXlswLTlhLWZBLUYtXXszNn0kLztcclxuY29uc3QgUmVnX05vcm1hbGl6ZWRVdWlkID0gL15bMC05YS1mQS1GXXszMn0kLztcclxuY29uc3QgUmVnX0NvbXByZXNzZWRVdWlkID0gL15bMC05YS16QS1aKy9dezIyLDIzfSQvO1xyXG5jb25zdCBSZWdfQ29tcHJlc3NlZFN1YkFzc2V0VXVpZCA9IC9eKFswLTlhLXpBLVorL117MjIsMjN9KSgoQFswLTlhLWZBLUZdezUsfSkrKSskLztcclxuY29uc3QgUmVnX3N1YkFzc2V0VXVpZCA9IC8oW15AXXszMiwzNn0pKChAWzAtOWEtZkEtRl17NSx9KSspKyQvO1xyXG5jb25zdCBSZWdfVXVpZEluTGliUGF0aCA9IC8uKlsvXFxcXF1bMC05YS1mQS1GXXsyfVsvXFxcXF0oWzAtOWEtZkEtRi1dezgsfSgoQFswLTlhLWZBLUZdezUsfSkrKT8pLiovO1xyXG5cclxuLy8g5Yqg5LqG6L+Z5Liq5qCH6K6w5ZCO77yM5a2X56ym5Liy5bCx5LiN5Y+v6IO95Lya5pivIHV1aWQg5LqG44CCXHJcbmV4cG9ydCBjb25zdCBOb25VdWlkTWFyayA9ICcuJztcclxuXHJcbi8vIOWOi+e8qeWQjueahCB1dWlkIOWPr+S7peWHj+Wwj+S/neWtmOaXtueahOWwuuWvuO+8jOS9huS4jeiDveWBmuS4uuaWh+S7tuWQje+8iOWboOS4uuaXoOazleWMuuWIhuWkp+Wwj+WGmeW5tuS4lOWMheWQq+mdnuazleWtl+espu+8ieOAglxyXG4vLyDpu5jorqTlsIYgdXVpZCDnmoTlkI7pnaIgMjcg5L2N5Y6L57yp5oiQIDE4IOS9je+8jOWJjSA1IOS9jeS/neeVmeS4i+adpe+8jOaWueS+v+iwg+ivleOAglxyXG4vLyBmYzk5MWRkNy0wMDMzLTRiODAtOWQ0MS1jOGE4NmE3MDJlNTkgLT4gZmM5OTEzWEFETkxnSjFCeUtocWNDNVpcclxuLy8g5aaC5p6c5ZCv55SoIG1pbiDliJnlsIYgdXVpZCDnmoTlkI7pnaIgMzAg5L2N5Y6L57yp5oiQIDIwIOS9je+8jOWJjSAyIOS9jeS/neeVmeS4jeWPmOOAglxyXG4vLyBmYzk5MWRkNy0wMDMzLTRiODAtOWQ0MS1jOGE4NmE3MDJlNTkgLT4gZmNtUjNYQUROTGdKMUJ5S2hxY0M1WlxyXG4vKlxyXG4gKiBAcGFyYW0ge0Jvb2xlYW59IFttaW49ZmFsc2VdXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gY29tcHJlc3NVVUlEKHV1aWQ6IHN0cmluZywgbWluOiBib29sZWFuKSB7XHJcbiAgICBjb25zdCByZXN1bHQgPSB1dWlkLm1hdGNoKFJlZ19zdWJBc3NldFV1aWQpO1xyXG4gICAgaWYgKCFyZXN1bHQpIHtcclxuICAgICAgICByZXR1cm4gY29tcHJlc3NOb3JtYWxVdWlkKHV1aWQsIG1pbik7XHJcbiAgICB9XHJcbiAgICB1dWlkID0gcmVzdWx0WzFdO1xyXG4gICAgcmV0dXJuIGNvbXByZXNzTm9ybWFsVXVpZCh1dWlkLCBtaW4pICsgcmVzdWx0WzJdO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjb21wcmVzc05vcm1hbFV1aWQodXVpZDogc3RyaW5nLCBtaW46IGJvb2xlYW4pIHtcclxuICAgIGlmIChSZWdfVXVpZC50ZXN0KHV1aWQpKSB7XHJcbiAgICAgICAgdXVpZCA9IHV1aWQucmVwbGFjZShSZWdfRGFzaCwgJycpO1xyXG4gICAgfSBlbHNlIGlmICghUmVnX05vcm1hbGl6ZWRVdWlkLnRlc3QodXVpZCkpIHtcclxuICAgICAgICByZXR1cm4gdXVpZDtcclxuICAgIH1cclxuICAgIGNvbnN0IHJlc2VydmVkID0gKG1pbiA9PT0gdHJ1ZSkgPyAyIDogNTtcclxuICAgIHJldHVybiBjb21wcmVzc0hleCh1dWlkLCByZXNlcnZlZCk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjb21wcmVzc0hleChoZXhTdHJpbmc6IHN0cmluZywgcmVzZXJ2ZWRIZWFkTGVuZ3RoOiBudW1iZXIpIHtcclxuICAgIGNvbnN0IGxlbmd0aCA9IGhleFN0cmluZy5sZW5ndGg7XHJcbiAgICBsZXQgaTtcclxuICAgIGlmICh0eXBlb2YgcmVzZXJ2ZWRIZWFkTGVuZ3RoICE9PSAndW5kZWZpbmVkJykge1xyXG4gICAgICAgIGkgPSByZXNlcnZlZEhlYWRMZW5ndGg7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGkgPSBsZW5ndGggJSAzO1xyXG4gICAgfVxyXG4gICAgY29uc3QgaGVhZCA9IGhleFN0cmluZy5zbGljZSgwLCBpKTtcclxuICAgIGNvbnN0IGJhc2U2NENoYXJzID0gW107XHJcbiAgICB3aGlsZSAoaSA8IGxlbmd0aCkge1xyXG4gICAgICAgIGNvbnN0IGhleFZhbDEgPSBwYXJzZUludChoZXhTdHJpbmdbaV0sIDE2KTtcclxuICAgICAgICBjb25zdCBoZXhWYWwyID0gcGFyc2VJbnQoaGV4U3RyaW5nW2kgKyAxXSwgMTYpO1xyXG4gICAgICAgIGNvbnN0IGhleFZhbDMgPSBwYXJzZUludChoZXhTdHJpbmdbaSArIDJdLCAxNik7XHJcbiAgICAgICAgYmFzZTY0Q2hhcnMucHVzaChCYXNlNjRLZXlDaGFyc1soaGV4VmFsMSA8PCAyKSB8IChoZXhWYWwyID4+IDIpXSk7XHJcbiAgICAgICAgYmFzZTY0Q2hhcnMucHVzaChCYXNlNjRLZXlDaGFyc1soKGhleFZhbDIgJiAzKSA8PCA0KSB8IGhleFZhbDNdKTtcclxuICAgICAgICBpICs9IDM7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaGVhZCArIGJhc2U2NENoYXJzLmpvaW4oJycpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZGVjb21wcmVzc1VVSUQodXVpZDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCByZXN1bHQgPSB1dWlkLm1hdGNoKFJlZ19Db21wcmVzc2VkU3ViQXNzZXRVdWlkKTtcclxuICAgIGlmICghcmVzdWx0KSB7XHJcbiAgICAgICAgcmV0dXJuIGRlY29tcHJlc3NOb3JtYWxVdWlkKHV1aWQpO1xyXG4gICAgfVxyXG5cclxuICAgIHV1aWQgPSByZXN1bHRbMV07XHJcbiAgICByZXR1cm4gZGVjb21wcmVzc05vcm1hbFV1aWQodXVpZCkgKyByZXN1bHRbMl07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRlY29tcHJlc3NOb3JtYWxVdWlkKHN0cjogc3RyaW5nKSB7XHJcbiAgICBpZiAoc3RyLmxlbmd0aCA9PT0gMjMpIHtcclxuICAgICAgICAvLyBkZWNvZGUgYmFzZTY0XHJcbiAgICAgICAgY29uc3QgaGV4Q2hhcnMgPSBbXTtcclxuICAgICAgICBmb3IgKGxldCBpID0gNTsgaSA8IDIzOyBpICs9IDIpIHtcclxuICAgICAgICAgICAgY29uc3QgbGhzID0gQXNjaWlUbzY0W3N0ci5jaGFyQ29kZUF0KGkpXTtcclxuICAgICAgICAgICAgY29uc3QgcmhzID0gQXNjaWlUbzY0W3N0ci5jaGFyQ29kZUF0KGkgKyAxKV07XHJcbiAgICAgICAgICAgIGhleENoYXJzLnB1c2goKGxocyA+PiAyKS50b1N0cmluZygxNikpO1xyXG4gICAgICAgICAgICBoZXhDaGFycy5wdXNoKCgoKGxocyAmIDMpIDw8IDIpIHwgcmhzID4+IDQpLnRvU3RyaW5nKDE2KSk7XHJcbiAgICAgICAgICAgIGhleENoYXJzLnB1c2goKHJocyAmIDB4RikudG9TdHJpbmcoMTYpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy9cclxuICAgICAgICBzdHIgPSBzdHIuc2xpY2UoMCwgNSkgKyBoZXhDaGFycy5qb2luKCcnKTtcclxuICAgIH0gZWxzZSBpZiAoc3RyLmxlbmd0aCA9PT0gMjIpIHtcclxuICAgICAgICAvLyBkZWNvZGUgYmFzZTY0XHJcbiAgICAgICAgY29uc3QgaGV4Q2hhcnMgPSBbXTtcclxuICAgICAgICBmb3IgKGxldCBpID0gMjsgaSA8IDIyOyBpICs9IDIpIHtcclxuICAgICAgICAgICAgY29uc3QgbGhzID0gQXNjaWlUbzY0W3N0ci5jaGFyQ29kZUF0KGkpXTtcclxuICAgICAgICAgICAgY29uc3QgcmhzID0gQXNjaWlUbzY0W3N0ci5jaGFyQ29kZUF0KGkgKyAxKV07XHJcbiAgICAgICAgICAgIGhleENoYXJzLnB1c2goKGxocyA+PiAyKS50b1N0cmluZygxNikpO1xyXG4gICAgICAgICAgICBoZXhDaGFycy5wdXNoKCgoKGxocyAmIDMpIDw8IDIpIHwgcmhzID4+IDQpLnRvU3RyaW5nKDE2KSk7XHJcbiAgICAgICAgICAgIGhleENoYXJzLnB1c2goKHJocyAmIDB4RikudG9TdHJpbmcoMTYpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy9cclxuICAgICAgICBzdHIgPSBzdHIuc2xpY2UoMCwgMikgKyBoZXhDaGFycy5qb2luKCcnKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIHN0cjtcclxuICAgIH1cclxuICAgIHJldHVybiBbc3RyLnNsaWNlKDAsIDgpLCBzdHIuc2xpY2UoOCwgMTIpLCBzdHIuc2xpY2UoMTIsIDE2KSwgc3RyLnNsaWNlKDE2LCAyMCksIHN0ci5zbGljZSgyMCldLmpvaW4oJy0nKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzVVVJRChzdHI6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIFJlZ19Db21wcmVzc2VkVXVpZC50ZXN0KHN0cikgfHwgUmVnX05vcm1hbGl6ZWRVdWlkLnRlc3Qoc3RyKSB8fCBSZWdfVXVpZC50ZXN0KHN0cikgfHwgUmVnX3N1YkFzc2V0VXVpZC50ZXN0KHN0cik7XHJcbn1cclxuXHJcbi8vIOS7jui3r+W+hOS4reaPkOWPliB1dWlkXHJcbi8vIOaUr+aMgeexu+S8vCBcIi4uLi81Yi81YjljYmMyMy03NmIzLTQxZmYtOTk1My00MjE5ZmRiZWE3MmMvRm9udGluLVNtYWxsQ2Fwcy50dGZcIiDov5nmoLfnmoRcclxuZXhwb3J0IGZ1bmN0aW9uIGdldFV1aWRGcm9tTGliUGF0aChwYXRoOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IG1hdGNoZXMgPSBwYXRoLm1hdGNoKFJlZ19VdWlkSW5MaWJQYXRoKTtcclxuICAgIGlmIChtYXRjaGVzKSB7XHJcbiAgICAgICAgcmV0dXJuIGVuY29kZVVSSShtYXRjaGVzWzFdKTtcclxuICAgIH1cclxuICAgIHJldHVybiAnJztcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlKGNvbXByZXNzID0gdHJ1ZSkge1xyXG4gICAgY29uc3QgdXVpZCA9IFV1aWQudjQoKTtcclxuICAgIHJldHVybiBjb21wcmVzcyA/IGNvbXByZXNzVVVJRCh1dWlkLCBjb21wcmVzcykgOiB1dWlkO1xyXG59XHJcblxyXG5jb25zdCBfZXh0ZW5kSW5kZXggPSBbXHJcbiAgICAxLCAyLCAzLCA0LCA1LFxyXG4gICAgNywgOCwgOSwgMTAsIDExLCAxMiwgMTMsIDE0LCAxNSxcclxuICAgIDE3LCAxOCwgMTksIDIwLCAyMSwgMjIsIDIzLCAyNCxcclxuICAgIDI2LCAyNywgMjgsIDI5LCAzMCxcclxuXTtcclxuXHJcbi8qKlxyXG4gKiDku47kuIDkuKrlkI3lrZfovazmjaLmiJDkuIDkuKogaWRcclxuICog6L+Z5piv5Liq5pyJ5o2f5Y6L57yp77yM5bm25LiN6IO95aSf6L+Y5Y6f5oiQ5Y6f5p2l55qE5ZCN5a2XXHJcbiAqIOazqOaEj++8muatpOaWueazlemcgOimgeWSjCBhc3NldC1kYiDkv53mjIHkuIDoh7RcclxuICogQHBhcmFtIGlkXHJcbiAqIEBwYXJhbSBleHRlbmRcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBuYW1lVG9TdWJJZChuYW1lOiBzdHJpbmcsIGV4dGVuZCA9IDApIHtcclxuICAgIGNvbnN0IG1kNSA9IGNyZWF0ZUhhc2goJ21kNScpLnVwZGF0ZShuYW1lKS5kaWdlc3QoJ2hleCcpO1xyXG4gICAgbGV0IGlkID0gbWQ1WzBdICsgbWQ1WzZdICsgbWQ1WzE2XSArIG1kNVsyNV0gKyBtZDVbMzFdO1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBleHRlbmQ7IGkrKykge1xyXG4gICAgICAgIGlkICs9IG1kNVtfZXh0ZW5kSW5kZXhbaV1dO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGlkO1xyXG59Il19