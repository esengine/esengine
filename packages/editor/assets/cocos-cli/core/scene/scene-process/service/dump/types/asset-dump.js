"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.assetDump = void 0;
// valueType直接使用引擎序列化
class AssetDump {
    encode(object, data, opts) {
        // 物理材质会在内存里创建一个虚拟的资源，这个资源不需要显示出去
        // 暂时性的 hack，后续需要移除
        // 测试方式：新建节点，挂载一个 BoxCollider 组件，观察 material属性是否正常
        const uuid = object ? object._uuid || '' : '';
        data.value = {
            uuid: uuid.startsWith('pm_') ? '' : uuid,
        };
    }
    async decode(data, info, dump, opts) {
        if (Array.isArray(dump.value)) {
            const result = [];
            for (let i = 0; i < dump.value.length; i++) {
                const data = dump.value[i];
                // TODO: 这是 Hack 做法，避开类似 uuid = 'ui-sprite-material' 资源加载失败的报错
                if (!data || !data.value.uuid || data.value.uuid.startsWith('ui-')) {
                    result[i] = null;
                }
                else {
                    const asset = await new Promise((resolve) => {
                        cc.assetManager.loadAny(data.value.uuid, (error, asset) => {
                            if (error) {
                                console.error(`asset can't be load:${data.value.uuid}`);
                                resolve(null);
                            }
                            else {
                                resolve(asset);
                            }
                        });
                    });
                    if (asset) {
                        result[i] = asset;
                    }
                    else {
                        // @ts-ignore
                        const placeHolder = EditorExtends.serialize.asAsset(dump.value.uuid, cc.js.getClassById(dump.type));
                        placeHolder.initDefault();
                        result[i] = placeHolder;
                    }
                }
            }
            data[info.key] = result;
        }
        else {
            // TODO: 这是 Hack 做法，避开类似 uuid = 'ui-sprite-material' 资源加载失败的报错
            if (!dump.value || !dump.value.uuid || dump.value.uuid.startsWith('ui-')) {
                data[info.key] = null;
            }
            else {
                const asset = await new Promise((resolve) => {
                    cc.assetManager.loadAny(dump.value.uuid, (error, asset) => {
                        if (error) {
                            console.error(`asset can't be load:${dump.value.uuid}`);
                            resolve(null);
                        }
                        else {
                            resolve(asset);
                        }
                    });
                });
                if (asset) {
                    data[info.key] = asset;
                }
                else {
                    // @ts-ignore
                    const placeHolder = EditorExtends.serialize.asAsset(dump.value.uuid, cc.js.getClassById(dump.type));
                    placeHolder.initDefault();
                    data[info.key] = placeHolder;
                }
            }
        }
    }
}
exports.assetDump = new AssetDump();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQtZHVtcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL3NjZW5lL3NjZW5lLXByb2Nlc3Mvc2VydmljZS9kdW1wL3R5cGVzL2Fzc2V0LWR1bXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBSUEscUJBQXFCO0FBQ3JCLE1BQU0sU0FBUztJQUNKLE1BQU0sQ0FBQyxNQUFXLEVBQUUsSUFBZSxFQUFFLElBQVU7UUFDbEQsaUNBQWlDO1FBQ2pDLG1CQUFtQjtRQUNuQixrREFBa0Q7UUFDbEQsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQzlDLElBQUksQ0FBQyxLQUFLLEdBQUc7WUFDVCxJQUFJLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJO1NBQzNDLENBQUM7SUFDTixDQUFDO0lBRU0sS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFTLEVBQUUsSUFBUyxFQUFFLElBQVMsRUFBRSxJQUFVO1FBQzNELElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUM1QixNQUFNLE1BQU0sR0FBUSxFQUFFLENBQUM7WUFDdkIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQ3pDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzNCLDhEQUE4RDtnQkFDOUQsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxLQUFL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cEcsV0FBVyxDQUFDLFdBQVcsRUFBRSxDQUFDO29CQUMxQixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLFdBQVcsQ0FBQztnQkFDakMsQ0FBQztZQUNMLENBQUM7UUFDTCxDQUFDO0lBQ0wsQ0FBQztDQUNKO0FBRVksUUFBQSxTQUFTLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElQcm9wZXJ0eSB9IGZyb20gJy4uLy4uLy4uLy4uL0B0eXBlcy9wdWJsaWMnO1xyXG5cclxuaW1wb3J0IHsgRHVtcEludGVyZmFjZSB9IGZyb20gJy4vZHVtcC1pbnRlcmZhY2UnO1xyXG5cclxuLy8gdmFsdWVUeXBl55u05o6l5L2/55So5byV5pOO5bqP5YiX5YyWXHJcbmNsYXNzIEFzc2V0RHVtcCBpbXBsZW1lbnRzIER1bXBJbnRlcmZhY2Uge1xyXG4gICAgcHVibGljIGVuY29kZShvYmplY3Q6IGFueSwgZGF0YTogSVByb3BlcnR5LCBvcHRzPzogYW55KSB7XHJcbiAgICAgICAgLy8g54mp55CG5p2Q6LSo5Lya5Zyo5YaF5a2Y6YeM5Yib5bu65LiA5Liq6Jma5ouf55qE6LWE5rqQ77yM6L+Z5Liq6LWE5rqQ5LiN6ZyA6KaB5pi+56S65Ye65Y67XHJcbiAgICAgICAgLy8g5pqC5pe25oCn55qEIGhhY2vvvIzlkI7nu63pnIDopoHnp7vpmaRcclxuICAgICAgICAvLyDmtYvor5XmlrnlvI/vvJrmlrDlu7roioLngrnvvIzmjILovb3kuIDkuKogQm94Q29sbGlkZXIg57uE5Lu277yM6KeC5a+fIG1hdGVyaWFs5bGe5oCn5piv5ZCm5q2j5bi4XHJcbiAgICAgICAgY29uc3QgdXVpZCA9IG9iamVjdCA/IG9iamVjdC5fdXVpZCB8fCAnJyA6ICcnO1xyXG4gICAgICAgIGRhdGEudmFsdWUgPSB7XHJcbiAgICAgICAgICAgIHV1aWQ6IHV1aWQuc3RhcnRzV2l0aCgncG1fJykgPyAnJyA6IHV1aWQsXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYXN5bmMgZGVjb2RlKGRhdGE6IGFueSwgaW5mbzogYW55LCBkdW1wOiBhbnksIG9wdHM/OiBhbnkpIHtcclxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShkdW1wLnZhbHVlKSkge1xyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQ6IGFueSA9IFtdO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGR1bXAudmFsdWUubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBkdW1wLnZhbHVlW2ldO1xyXG4gICAgICAgICAgICAgICAgLy8gVE9ETzog6L+Z5pivIEhhY2sg5YGa5rOV77yM6YG/5byA57G75Ly8IHV1aWQgPSAndWktc3ByaXRlLW1hdGVyaWFsJyDotYTmupDliqDovb3lpLHotKXnmoTmiqXplJlcclxuICAgICAgICAgICAgICAgIGlmICghZGF0YSB8fCAhZGF0YS52YWx1ZS51dWlkIHx8IGRhdGEudmFsdWUudXVpZC5zdGFydHNXaXRoKCd1aS0nKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFtpXSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFzc2V0ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2MuYXNzZXRNYW5hZ2VyLmxvYWRBbnkoZGF0YS52YWx1ZS51dWlkLCAoZXJyb3I6IGFueSwgYXNzZXQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgYXNzZXQgY2FuJ3QgYmUgbG9hZDoke2RhdGEudmFsdWUudXVpZH1gKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGFzc2V0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChhc3NldCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbaV0gPSBhc3NldDtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBsYWNlSG9sZGVyID0gRWRpdG9yRXh0ZW5kcy5zZXJpYWxpemUuYXNBc3NldChkdW1wLnZhbHVlLnV1aWQsIGNjLmpzLmdldENsYXNzQnlJZChkdW1wLnR5cGUpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2VIb2xkZXIuaW5pdERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0W2ldID0gcGxhY2VIb2xkZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBkYXRhW2luZm8ua2V5XSA9IHJlc3VsdDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyBUT0RPOiDov5nmmK8gSGFjayDlgZrms5XvvIzpgb/lvIDnsbvkvLwgdXVpZCA9ICd1aS1zcHJpdGUtbWF0ZXJpYWwnIOi1hOa6kOWKoOi9veWksei0peeahOaKpemUmVxyXG4gICAgICAgICAgICBpZiAoIWR1bXAudmFsdWUgfHwgIWR1bXAudmFsdWUudXVpZCB8fCBkdW1wLnZhbHVlLnV1aWQuc3RhcnRzV2l0aCgndWktJykpIHtcclxuICAgICAgICAgICAgICAgIGRhdGFbaW5mby5rZXldID0gbnVsbDtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFzc2V0ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjYy5hc3NldE1hbmFnZXIubG9hZEFueShkdW1wLnZhbHVlLnV1aWQsIChlcnJvcjogYW55LCBhc3NldDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgYXNzZXQgY2FuJ3QgYmUgbG9hZDoke2R1bXAudmFsdWUudXVpZH1gKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUobnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGFzc2V0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoYXNzZXQpIHtcclxuICAgICAgICAgICAgICAgICAgICBkYXRhW2luZm8ua2V5XSA9IGFzc2V0O1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGxhY2VIb2xkZXIgPSBFZGl0b3JFeHRlbmRzLnNlcmlhbGl6ZS5hc0Fzc2V0KGR1bXAudmFsdWUudXVpZCwgY2MuanMuZ2V0Q2xhc3NCeUlkKGR1bXAudHlwZSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHBsYWNlSG9sZGVyLmluaXREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YVtpbmZvLmtleV0gPSBwbGFjZUhvbGRlcjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IGFzc2V0RHVtcCA9IG5ldyBBc3NldER1bXAoKTtcclxuIl19