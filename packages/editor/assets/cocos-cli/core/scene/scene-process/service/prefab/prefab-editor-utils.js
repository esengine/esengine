"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.editorPrefabUtils = void 0;
const cc_1 = require("cc");
const utils_1 = require("./utils");
class EditorPrefabUtils {
    serialize(node) {
        // 校验数据
        utils_1.prefabUtils.checkMountedRootData(node, true);
        const { prefab } = utils_1.prefabUtils.getPrefabForSerialize(node);
        return EditorExtends.serialize(prefab);
    }
    removePrefabInstanceRoots(rootNode) {
        utils_1.prefabUtils.removePrefabInstanceRoots(rootNode);
    }
    generateSceneAsset(scene, rootNode) {
        const asset = new cc_1.SceneAsset();
        utils_1.prefabUtils.removePrefabInstanceRoots(scene);
        utils_1.prefabUtils.gatherPrefabInstanceRoots(scene); // 为了 softReload 场景能去创建 PrefabInstance，需要将它们记录在 scene 节点上
        // 软加载时需要更新根节点的 nestedPrefabRoots，否则序列化后会有问题
        if (rootNode) {
            utils_1.prefabUtils.removePrefabInstanceRoots(rootNode);
            utils_1.prefabUtils.gatherPrefabInstanceRoots(rootNode);
        }
        asset.scene = scene;
        return asset;
    }
    /**
     * 由于动态加载Prefab会导致节点的uuid发生变化，为了保证编辑过程中节点的uuid不变
     * 节点id也会，所以也需要更新
     * 在softReload之前会存储prefab节点的uuid,以便之后还原
     * @param scene 场景数据
     */
    storePrefabUUID(scene) {
        const prefabUUIDMap = new Map();
        for (let i = 0; i < scene.children.length; i++) {
            const child = scene.children[i];
            this.generatePrefabUUIDMap(child, prefabUUIDMap);
        }
        return prefabUUIDMap;
    }
    generatePrefabUUIDMap(node, uuidMap) {
        if (!uuidMap) {
            return;
        }
        // @ts-ignore
        const prefabInfo = node['_prefab'];
        let curMap = uuidMap;
        if (prefabInfo) {
            if (prefabInfo.instance) {
                curMap = new Map();
                uuidMap.set(prefabInfo.instance.fileId, curMap);
            }
            curMap.set(prefabInfo.fileId, node.uuid);
            node.components.forEach((comp) => {
                const compPrefab = comp.__prefab;
                if (compPrefab?.fileId) {
                    if (curMap.has(compPrefab.fileId)) {
                        console.warn(`generatePrefabUUIDMap ${compPrefab.fileId} already exist`);
                        return;
                    }
                    curMap.set(compPrefab.fileId, comp.uuid);
                }
            });
        }
        for (let i = 0; i < node.children.length; i++) {
            const child = node.children[i];
            this.generatePrefabUUIDMap(child, curMap);
        }
    }
    /**
     * 恢复Prefab的uuid
     * @param scene 场景数据
     * @param prefabUUIDMap
     */
    restorePrefabUUID(scene, prefabUUIDMap) {
        for (let i = 0; i < scene.children.length; i++) {
            const child = scene.children[i];
            this.applyPrefabUUID(child, prefabUUIDMap);
        }
    }
    applyPrefabUUID(node, uuidMap) {
        if (!uuidMap) {
            return;
        }
        const prefabInfo = node['_prefab'];
        let curMap = uuidMap;
        if (prefabInfo) {
            if (prefabInfo.instance) {
                curMap = uuidMap.get(prefabInfo.instance.fileId);
            }
            if (curMap) {
                const uuid = curMap.get(prefabInfo.fileId);
                if (!uuid) {
                    console.error(prefabInfo.fileId + ' not found uuid');
                }
                EditorExtends.Node.changeNodeUUID(node.uuid, uuid ?? '');
                node.components.forEach((comp) => {
                    const compPrefab = comp.__prefab;
                    if (compPrefab?.fileId) {
                        const compUUID = curMap.get(compPrefab.fileId);
                        compUUID && EditorExtends.Component.changeUUID(comp.uuid, compUUID);
                    }
                });
            }
        }
        for (let i = 0; i < node.children.length; i++) {
            const child = node.children[i];
            this.applyPrefabUUID(child, curMap);
        }
    }
}
exports.editorPrefabUtils = new EditorPrefabUtils();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlZmFiLWVkaXRvci11dGlscy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL3NjZW5lL3NjZW5lLXByb2Nlc3Mvc2VydmljZS9wcmVmYWIvcHJlZmFiLWVkaXRvci11dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwyQkFBNkM7QUFDN0MsbUNBQXNDO0FBSXRDLE1BQU0saUJBQWlCO0lBQ25CLFNBQVMsQ0FBQyxJQUFVO1FBQ2hCLE9BQU87UUFDUCxtQkFBVyxDQUFDLG9CQUFvQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUM3QyxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsbUJBQVcsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMzRCxPQUFPLGFBQWEsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVELHlCQUF5QixDQUFDLFFBQXNCO1FBQzVDLG1CQUFXLENBQUMseUJBQXlCLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDcEQsQ0FBQztJQUVELGtCQUFrQixDQUFDLEtBQVksRUFBRSxRQUFxQjtRQUNsRCxNQUFNLEtBQUssR0FBRyxJQUFJLGVBQVUsRUFBRSxDQUFDO1FBQy9CLG1CQUFXLENBQUMseUJBQXlCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDN0MsbUJBQVcsQ0FBQyx5QkFBeUIsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLHlEQUF5RDtRQUV2Ryw0Q0FBNEM7UUFDNUMsSUFBSSxRQUFRLEVBQUUsQ0FBQztZQUNYLG1CQUFXLENBQUMseUJBQXlCLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDaEQsbUJBQVcsQ0FBQyx5QkFBeUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNwRCxDQUFDO1FBQ0QsS0FBSyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFFcEIsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztJQUVE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QUFDLENBQUM7WUFDL0IsSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDeEMsQ0FBQztJQUNMLENBQUM7Q0FFSjtBQUVZLFFBQUEsaUJBQWlCLEdBQUcsSUFBSSxpQkFBaUIsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTm9kZSwgU2NlbmUsIFNjZW5lQXNzZXQgfSBmcm9tICdjYyc7XHJcbmltcG9ydCB7IHByZWZhYlV0aWxzIH0gZnJvbSAnLi91dGlscyc7XHJcblxyXG50eXBlIFVVSURNYXAgPSBNYXA8c3RyaW5nLCBzdHJpbmcgfCBVVUlETWFwPjtcclxuXHJcbmNsYXNzIEVkaXRvclByZWZhYlV0aWxzIHtcclxuICAgIHNlcmlhbGl6ZShub2RlOiBOb2RlKSB7XHJcbiAgICAgICAgLy8g5qCh6aqM5pWw5o2uXHJcbiAgICAgICAgcHJlZmFiVXRpbHMuY2hlY2tNb3VudGVkUm9vdERhdGEobm9kZSwgdHJ1ZSk7XHJcbiAgICAgICAgY29uc3QgeyBwcmVmYWIgfSA9IHByZWZhYlV0aWxzLmdldFByZWZhYkZvclNlcmlhbGl6ZShub2RlKTtcclxuICAgICAgICByZXR1cm4gRWRpdG9yRXh0ZW5kcy5zZXJpYWxpemUocHJlZmFiKTtcclxuICAgIH1cclxuXHJcbiAgICByZW1vdmVQcmVmYWJJbnN0YW5jZVJvb3RzKHJvb3ROb2RlOiBOb2RlIHwgU2NlbmUpIHtcclxuICAgICAgICBwcmVmYWJVdGlscy5yZW1vdmVQcmVmYWJJbnN0YW5jZVJvb3RzKHJvb3ROb2RlKTtcclxuICAgIH1cclxuXHJcbiAgICBnZW5lcmF0ZVNjZW5lQXNzZXQoc2NlbmU6IFNjZW5lLCByb290Tm9kZTogTm9kZSB8IG51bGwpIHtcclxuICAgICAgICBjb25zdCBhc3NldCA9IG5ldyBTY2VuZUFzc2V0KCk7XHJcbiAgICAgICAgcHJlZmFiVXRpbHMucmVtb3ZlUHJlZmFiSW5zdGFuY2VSb290cyhzY2VuZSk7XHJcbiAgICAgICAgcHJlZmFiVXRpbHMuZ2F0aGVyUHJlZmFiSW5zdGFuY2VSb290cyhzY2VuZSk7IC8vIOS4uuS6hiBzb2Z0UmVsb2FkIOWcuuaZr+iDveWOu+WIm+W7uiBQcmVmYWJJbnN0YW5jZe+8jOmcgOimgeWwhuWug+S7rOiusOW9leWcqCBzY2VuZSDoioLngrnkuIpcclxuXHJcbiAgICAgICAgLy8g6L2v5Yqg6L295pe26ZyA6KaB5pu05paw5qC56IqC54K555qEIG5lc3RlZFByZWZhYlJvb3Rz77yM5ZCm5YiZ5bqP5YiX5YyW5ZCO5Lya5pyJ6Zeu6aKYXHJcbiAgICAgICAgaWYgKHJvb3ROb2RlKSB7XHJcbiAgICAgICAgICAgIHByZWZhYlV0aWxzLnJlbW92ZVByZWZhYkluc3RhbmNlUm9vdHMocm9vdE5vZGUpO1xyXG4gICAgICAgICAgICBwcmVmYWJVdGlscy5nYXRoZXJQcmVmYWJJbnN0YW5jZVJvb3RzKHJvb3ROb2RlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYXNzZXQuc2NlbmUgPSBzY2VuZTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGFzc2V0O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog55Sx5LqO5Yqo5oCB5Yqg6L29UHJlZmFi5Lya5a+86Ie06IqC54K555qEdXVpZOWPkeeUn+WPmOWMlu+8jOS4uuS6huS/neivgee8lui+kei/h+eoi+S4reiKgueCueeahHV1aWTkuI3lj5hcclxuICAgICAqIOiKgueCuWlk5Lmf5Lya77yM5omA5Lul5Lmf6ZyA6KaB5pu05pawXHJcbiAgICAgKiDlnKhzb2Z0UmVsb2Fk5LmL5YmN5Lya5a2Y5YKocHJlZmFi6IqC54K555qEdXVpZCzku6Xkvr/kuYvlkI7ov5jljp9cclxuICAgICAqIEBwYXJhbSBzY2VuZSDlnLrmma/mlbDmja5cclxuICAgICAqL1xyXG4gICAgc3RvcmVQcmVmYWJVVUlEKHNjZW5lOiBTY2VuZSkge1xyXG4gICAgICAgIGNvbnN0IHByZWZhYlVVSURNYXAgPSBuZXcgTWFwKCk7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzY2VuZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBjb25zdCBjaGlsZCA9IHNjZW5lLmNoaWxkcmVuW2ldIGFzIHVua25vd24gYXMgTm9kZTtcclxuICAgICAgICAgICAgdGhpcy5nZW5lcmF0ZVByZWZhYlVVSURNYXAoY2hpbGQsIHByZWZhYlVVSURNYXApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHByZWZhYlVVSURNYXA7XHJcbiAgICB9XHJcblxyXG4gICAgZ2VuZXJhdGVQcmVmYWJVVUlETWFwKG5vZGU6IE5vZGUsIHV1aWRNYXA6IFVVSURNYXApIHtcclxuICAgICAgICBpZiAoIXV1aWRNYXApIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgIGNvbnN0IHByZWZhYkluZm8gPSBub2RlWydfcHJlZmFiJ107XHJcblxyXG4gICAgICAgIGxldCBjdXJNYXAgPSB1dWlkTWFwO1xyXG4gICAgICAgIGlmIChwcmVmYWJJbmZvKSB7XHJcbiAgICAgICAgICAgIGlmIChwcmVmYWJJbmZvLmluc3RhbmNlKSB7XHJcbiAgICAgICAgICAgICAgICBjdXJNYXAgPSBuZXcgTWFwKCk7XHJcbiAgICAgICAgICAgICAgICB1dWlkTWFwLnNldChwcmVmYWJJbmZvLmluc3RhbmNlLmZpbGVJZCwgY3VyTWFwKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY3VyTWFwLnNldChwcmVmYWJJbmZvLmZpbGVJZCwgbm9kZS51dWlkKTtcclxuICAgICAgICAgICAgbm9kZS5jb21wb25lbnRzLmZvckVhY2goKGNvbXApID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbXBQcmVmYWIgPSBjb21wLl9fcHJlZmFiO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNvbXBQcmVmYWI/LmZpbGVJZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjdXJNYXAuaGFzKGNvbXBQcmVmYWIuZmlsZUlkKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYGdlbmVyYXRlUHJlZmFiVVVJRE1hcCAke2NvbXBQcmVmYWIuZmlsZUlkfSBhbHJlYWR5IGV4aXN0YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY3VyTWFwLnNldChjb21wUHJlZmFiLmZpbGVJZCwgY29tcC51dWlkKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgY29uc3QgY2hpbGQgPSBub2RlLmNoaWxkcmVuW2ldO1xyXG4gICAgICAgICAgICB0aGlzLmdlbmVyYXRlUHJlZmFiVVVJRE1hcChjaGlsZCwgY3VyTWFwKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmgaLlpI1QcmVmYWLnmoR1dWlkXHJcbiAgICAgKiBAcGFyYW0gc2NlbmUg5Zy65pmv5pWw5o2uXHJcbiAgICAgKiBAcGFyYW0gcHJlZmFiVVVJRE1hcFxyXG4gICAgICovXHJcbiAgICByZXN0b3JlUHJlZmFiVVVJRChzY2VuZTogU2NlbmUsIHByZWZhYlVVSURNYXA6IFVVSURNYXApIHtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNjZW5lLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gc2NlbmUuY2hpbGRyZW5baV0gYXMgdW5rbm93biBhcyBOb2RlO1xyXG4gICAgICAgICAgICB0aGlzLmFwcGx5UHJlZmFiVVVJRChjaGlsZCwgcHJlZmFiVVVJRE1hcCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGFwcGx5UHJlZmFiVVVJRChub2RlOiBOb2RlLCB1dWlkTWFwOiBVVUlETWFwIHwgdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgaWYgKCF1dWlkTWFwKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHByZWZhYkluZm8gPSBub2RlWydfcHJlZmFiJ107XHJcblxyXG4gICAgICAgIGxldCBjdXJNYXA6IFVVSURNYXAgfCB1bmRlZmluZWQgPSB1dWlkTWFwO1xyXG4gICAgICAgIGlmIChwcmVmYWJJbmZvKSB7XHJcbiAgICAgICAgICAgIGlmIChwcmVmYWJJbmZvLmluc3RhbmNlKSB7XHJcbiAgICAgICAgICAgICAgICBjdXJNYXAgPSB1dWlkTWFwLmdldChwcmVmYWJJbmZvLmluc3RhbmNlLmZpbGVJZCkgYXMgTWFwPHN0cmluZywgc3RyaW5nPjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGN1ck1hcCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdXVpZCA9IChjdXJNYXAgYXMgTWFwPHN0cmluZywgc3RyaW5nPikuZ2V0KHByZWZhYkluZm8uZmlsZUlkKTtcclxuICAgICAgICAgICAgICAgIGlmICghdXVpZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IocHJlZmFiSW5mby5maWxlSWQgKyAnIG5vdCBmb3VuZCB1dWlkJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBFZGl0b3JFeHRlbmRzLk5vZGUuY2hhbmdlTm9kZVVVSUQobm9kZS51dWlkLCB1dWlkID8/ICcnKTtcclxuICAgICAgICAgICAgICAgIG5vZGUuY29tcG9uZW50cy5mb3JFYWNoKChjb21wKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tcFByZWZhYiA9IGNvbXAuX19wcmVmYWI7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBQcmVmYWI/LmZpbGVJZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjb21wVVVJRCA9IChjdXJNYXAgYXMgTWFwPHN0cmluZywgc3RyaW5nPikuZ2V0KGNvbXBQcmVmYWIuZmlsZUlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29tcFVVSUQgJiYgRWRpdG9yRXh0ZW5kcy5Db21wb25lbnQuY2hhbmdlVVVJRChjb21wLnV1aWQsIGNvbXBVVUlEKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gbm9kZS5jaGlsZHJlbltpXTtcclxuICAgICAgICAgICAgdGhpcy5hcHBseVByZWZhYlVVSUQoY2hpbGQsIGN1ck1hcCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IGVkaXRvclByZWZhYlV0aWxzID0gbmV3IEVkaXRvclByZWZhYlV0aWxzKCk7XHJcbiJdfQ==