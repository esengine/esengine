'use strict';
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.convertTGA = convertTGA;
exports.convertImageToHDR = convertImageToHDR;
exports.convertPSD = convertPSD;
exports.convertTIFF = convertTIFF;
exports.convertHDROrEXR = convertHDROrEXR;
exports.convertHDR = convertHDR;
exports.convertWithCmft = convertWithCmft;
const path_1 = require("path");
const pngjs_1 = require("pngjs");
const tga_js_1 = __importDefault(require("tga-js"));
const fs_extra_1 = require("fs-extra");
const psd_js_1 = __importDefault(require("psd.js"));
const sharp_1 = __importDefault(require("sharp"));
const global_1 = require("../../../../../global");
const utils_1 = __importDefault(require("../../../../base/utils"));
async function convertTGA(data) {
    const tga = new tga_js_1.default();
    tga.load(data);
    const imageData = tga.getImageData();
    const png = new pngjs_1.PNG({ width: imageData.width, height: imageData.height });
    png.data = Buffer.from(imageData.data);
    return await savePNGObject(png);
}
async function convertImageToHDR(file, uuid, temp) {
    // const output = join(temp, uuid + '.hdr');
    const output = (0, path_1.join)(temp, uuid + '.hdr');
    (0, fs_extra_1.ensureDirSync)((0, path_1.dirname)(output));
    // https://github.com/ImageMagick/ImageMagick
    let convertTool = (0, path_1.join)(global_1.GlobalPaths.staticDir, 'tools/mali_darwin/convert');
    if (process.platform === 'win32') {
        convertTool = (0, path_1.join)(global_1.GlobalPaths.staticDir, 'tools/mali_win32/convert.exe');
    }
    const toolDir = (0, path_1.dirname)(convertTool);
    convertTool = '.' + path_1.sep + (0, path_1.basename)(convertTool);
    const env = Object.assign({}, process.env);
    // convert 是 imagemagick 中的一个工具
    // etcpack 中应该是以 'convert' 而不是 './convert' 来调用工具的，所以需要将 toolDir 加到环境变量中
    // toolDir 需要放在前面，以防止系统找到用户自己安装的 imagemagick 版本
    env.PATH = toolDir + ':' + env.PATH;
    await utils_1.default.Process.quickSpawn(convertTool, [(0, path_1.normalize)(file), (0, path_1.normalize)(output)], {
        // windows 中需要进入到 toolDir 去执行命令才能成功
        cwd: toolDir,
        env: env,
    });
    return {
        extName: '.hdr',
        source: output,
    };
}
async function convertPSD(data) {
    const psd = new psd_js_1.default(data);
    psd.parse();
    const png = psd.image.toPng();
    return savePNGObject(png);
}
async function convertTIFF(file) {
    return new Promise((resolve, reject) => {
        (0, sharp_1.default)(file)
            .png()
            .toBuffer()
            .then((data) => {
            resolve({
                extName: '.png',
                data,
            });
        })
            .catch((err) => reject(err));
    });
}
async function savePNGObject(png) {
    return new Promise((resolve, reject) => {
        const buffer = [];
        png.on('data', (data) => {
            buffer.push(data);
        });
        png.on('end', () => {
            resolve({
                extName: '.png',
                data: Buffer.concat(buffer),
            });
        });
        png.on('error', (err) => {
            reject(err);
        });
        png.pack();
    });
}
async function convertHDROrEXR(extName, source, uuid, temp) {
    console.debug(`Start to convert asset {asset[${uuid}](${uuid})}`);
    const dist = (0, path_1.join)(temp, uuid);
    (0, fs_extra_1.ensureDirSync)(temp);
    if (extName === '.hdr') {
        return await convertWithCmft(source, dist);
    }
    else if (extName === '.exr') {
        // 先尝试使用 cmft
        try {
            return await convertWithCmft(source, dist, '_withexr');
        }
        catch (error) {
            // 如果使用 cmft 直接转失败，则先转 hdr 再使用 cmft 处理
            const res = await convertImageToHDR(source, uuid, temp);
            return await convertWithCmft(res.source, dist);
        }
    }
}
// 兼容旧接口
async function convertHDR(source, uuid, temp) {
    console.debug(`Start to convert asset {asset[${uuid}](${uuid})}`);
    const dist = (0, path_1.join)(temp, uuid);
    (0, fs_extra_1.ensureDirSync)(temp);
    return await convertWithCmft(source, dist);
}
async function convertWithCmft(file, dist, version = '') {
    // https://github.com/dariomanesku/cmft
    let tools = (0, path_1.join)(global_1.GlobalPaths.staticDir, `tools/cmft/cmftRelease64${version}${process.platform === 'win32' ? '.exe' : ''}`);
    if (!(0, fs_extra_1.existsSync)(tools)) {
        tools = (0, path_1.join)(global_1.GlobalPaths.staticDir, `tools/cmft/cmftRelease64${process.platform === 'win32' ? '.exe' : ''}`);
    }
    await utils_1.default.Process.quickSpawn(tools, [
        '--bypassoutputtype',
        '--output0params',
        'png,rgbm,latlong',
        '--input',
        file,
        '--output0',
        dist,
    ]);
    console.debug(`Convert asset${file} -> PNG success.`);
    return {
        extName: '.png',
        source: dist + '.png',
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2UtbWljcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL2Fzc2V0cy9hc3NldC1oYW5kbGVyL2Fzc2V0cy9pbWFnZS9pbWFnZS1taWNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7Ozs7QUFZYixnQ0FPQztBQUVELDhDQTJCQztBQUVELGdDQUtDO0FBRUQsa0NBYUM7QUFxQkQsMENBZ0JDO0FBR0QsZ0NBS0M7QUFFRCwwQ0FvQkM7QUF2SUQsK0JBQXdFO0FBRXhFLGlDQUE0QjtBQUM1QixvREFBeUI7QUFDekIsdUNBQStEO0FBQy9ELG9EQUF5QjtBQUN6QixrREFBMEI7QUFDMUIsa0RBQW9EO0FBQ3BELG1FQUEyQztBQUVwQyxLQUFLLFVBQVUsVUFBVSxDQUFDLElBQVk7SUFDekMsTUFBTSxHQUFHLEdBQUcsSUFBSSxnQkFBRyxFQUFFLENBQUM7SUFDdEIsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNmLE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUNyQyxNQUFNLEdBQUcsR0FBRyxJQUFJLFdBQUcsQ0FBQyxFQUFFLEtBQUssRUFBRSxTQUFTLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxTQUFTLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUMxRSxHQUFHLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3ZDLE9BQU8sTUFBTSxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDcEMsQ0FBQztBQUVNLEtBQUssVUFBVSxpQkFBaUIsQ0FBQyxJQUFZLEVBQUUsSUFBWSxFQUFFLElBQVk7SUFDNUUsNENBQTRDO0lBQzVDLE1BQU0sTUFBTSxHQUFHLElBQUEsV0FBSSxFQUFDLElBQUksRUFBRSxJQUFJLEdBQUcsTUFBTSxDQUFDLENBQUM7SUFD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QixDQUFDO0FBQ04sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxuXHJcbmltcG9ydCB7IGpvaW4sIGRpcm5hbWUsIGJhc2VuYW1lLCBleHRuYW1lLCBzZXAsIG5vcm1hbGl6ZSB9IGZyb20gJ3BhdGgnO1xyXG5cclxuaW1wb3J0IHsgUE5HIH0gZnJvbSAncG5nanMnO1xyXG5pbXBvcnQgVEdBIGZyb20gJ3RnYS1qcyc7XHJcbmltcG9ydCB7IHJlYWRGaWxlLCBlbnN1cmVEaXJTeW5jLCBleGlzdHNTeW5jIH0gZnJvbSAnZnMtZXh0cmEnO1xyXG5pbXBvcnQgUFNEIGZyb20gJ3BzZC5qcyc7XHJcbmltcG9ydCBTaGFycCBmcm9tICdzaGFycCc7XHJcbmltcG9ydCB7IEdsb2JhbFBhdGhzIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vZ2xvYmFsJztcclxuaW1wb3J0IHV0aWxzIGZyb20gJy4uLy4uLy4uLy4uL2Jhc2UvdXRpbHMnO1xyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNvbnZlcnRUR0EoZGF0YTogQnVmZmVyKTogUHJvbWlzZTx7IGV4dE5hbWU6IHN0cmluZzsgZGF0YTogQnVmZmVyIH0+IHtcclxuICAgIGNvbnN0IHRnYSA9IG5ldyBUR0EoKTtcclxuICAgIHRnYS5sb2FkKGRhdGEpO1xyXG4gICAgY29uc3QgaW1hZ2VEYXRhID0gdGdhLmdldEltYWdlRGF0YSgpO1xyXG4gICAgY29uc3QgcG5nID0gbmV3IFBORyh7IHdpZHRoOiBpbWFnZURhdGEud2lkdGgsIGhlaWdodDogaW1hZ2VEYXRhLmhlaWdodCB9KTtcclxuICAgIHBuZy5kYXRhID0gQnVmZmVyLmZyb20oaW1hZ2VEYXRhLmRhdGEpO1xyXG4gICAgcmV0dXJuIGF3YWl0IHNhdmVQTkdPYmplY3QocG5nKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNvbnZlcnRJbWFnZVRvSERSKGZpbGU6IHN0cmluZywgdXVpZDogc3RyaW5nLCB0ZW1wOiBzdHJpbmcpIHtcclxuICAgIC8vIGNvbnN0IG91dHB1dCA9IGpvaW4odGVtcCwgdXVpZCArICcuaGRyJyk7XHJcbiAgICBjb25zdCBvdXRwdXQgPSBqb2luKHRlbXAsIHV1aWQgKyAnLmhkcicpO1xyXG4gICAgZW5zdXJlRGlyU3luYyhkaXJuYW1lKG91dHB1dCkpO1xyXG5cclxuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9JbWFnZU1hZ2ljay9JbWFnZU1hZ2lja1xyXG4gICAgbGV0IGNvbnZlcnRUb29sID0gam9pbihHbG9iYWxQYXRocy5zdGF0aWNEaXIsICd0b29scy9tYWxpX2Rhcndpbi9jb252ZXJ0Jyk7XHJcbiAgICBpZiAocHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJykge1xyXG4gICAgICAgIGNvbnZlcnRUb29sID0gam9pbihHbG9iYWxQYXRocy5zdGF0aWNEaXIsICd0b29scy9tYWxpX3dpbjMyL2NvbnZlcnQuZXhlJyk7XHJcbiAgICB9XHJcbiAgICBjb25zdCB0b29sRGlyID0gZGlybmFtZShjb252ZXJ0VG9vbCk7XHJcbiAgICBjb252ZXJ0VG9vbCA9ICcuJyArIHNlcCArIGJhc2VuYW1lKGNvbnZlcnRUb29sKTtcclxuICAgIGNvbnN0IGVudiA9IE9iamVjdC5hc3NpZ24oe30sIHByb2Nlc3MuZW52KTtcclxuICAgIC8vIGNvbnZlcnQg5pivIGltYWdlbWFnaWNrIOS4reeahOS4gOS4quW3peWFt1xyXG4gICAgLy8gZXRjcGFjayDkuK3lupTor6XmmK/ku6UgJ2NvbnZlcnQnIOiAjOS4jeaYryAnLi9jb252ZXJ0JyDmnaXosIPnlKjlt6XlhbfnmoTvvIzmiYDku6XpnIDopoHlsIYgdG9vbERpciDliqDliLDnjq/looPlj5jph4/kuK1cclxuICAgIC8vIHRvb2xEaXIg6ZyA6KaB5pS+5Zyo5YmN6Z2i77yM5Lul6Ziy5q2i57O757uf5om+5Yiw55So5oi36Ieq5bex5a6J6KOF55qEIGltYWdlbWFnaWNrIOeJiOacrFxyXG4gICAgZW52LlBBVEggPSB0b29sRGlyICsgJzonICsgZW52LlBBVEg7XHJcbiAgICBhd2FpdCB1dGlscy5Qcm9jZXNzLnF1aWNrU3Bhd24oY29udmVydFRvb2wsIFtub3JtYWxpemUoZmlsZSksIG5vcm1hbGl6ZShvdXRwdXQpXSwge1xyXG4gICAgICAgIC8vIHdpbmRvd3Mg5Lit6ZyA6KaB6L+b5YWl5YiwIHRvb2xEaXIg5Y675omn6KGM5ZG95Luk5omN6IO95oiQ5YqfXHJcbiAgICAgICAgY3dkOiB0b29sRGlyLFxyXG4gICAgICAgIGVudjogZW52LFxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBleHROYW1lOiAnLmhkcicsXHJcbiAgICAgICAgc291cmNlOiBvdXRwdXQsXHJcbiAgICB9O1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY29udmVydFBTRChkYXRhOiBCdWZmZXIpOiBQcm9taXNlPHsgZXh0TmFtZTogc3RyaW5nOyBkYXRhOiBCdWZmZXIgfT4ge1xyXG4gICAgY29uc3QgcHNkID0gbmV3IFBTRChkYXRhKTtcclxuICAgIHBzZC5wYXJzZSgpO1xyXG4gICAgY29uc3QgcG5nID0gcHNkLmltYWdlLnRvUG5nKCk7XHJcbiAgICByZXR1cm4gc2F2ZVBOR09iamVjdChwbmcpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY29udmVydFRJRkYoZmlsZTogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2U8eyBleHROYW1lOiBzdHJpbmc7IGRhdGE6IEJ1ZmZlciB9PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgU2hhcnAoZmlsZSlcclxuICAgICAgICAgICAgLnBuZygpXHJcbiAgICAgICAgICAgIC50b0J1ZmZlcigpXHJcbiAgICAgICAgICAgIC50aGVuKChkYXRhOiBCdWZmZXIpID0+IHtcclxuICAgICAgICAgICAgICAgIHJlc29sdmUoe1xyXG4gICAgICAgICAgICAgICAgICAgIGV4dE5hbWU6ICcucG5nJyxcclxuICAgICAgICAgICAgICAgICAgICBkYXRhLFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyKSA9PiByZWplY3QoZXJyKSk7XHJcbiAgICB9KTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gc2F2ZVBOR09iamVjdChwbmc6IFBORykge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHsgZXh0TmFtZTogc3RyaW5nOyBkYXRhOiBCdWZmZXIgfT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGJ1ZmZlcjogQnVmZmVyW10gPSBbXTtcclxuICAgICAgICBwbmcub24oJ2RhdGEnLCAoZGF0YTogQnVmZmVyKSA9PiB7XHJcbiAgICAgICAgICAgIGJ1ZmZlci5wdXNoKGRhdGEpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHBuZy5vbignZW5kJywgKCkgPT4ge1xyXG4gICAgICAgICAgICByZXNvbHZlKHtcclxuICAgICAgICAgICAgICAgIGV4dE5hbWU6ICcucG5nJyxcclxuICAgICAgICAgICAgICAgIGRhdGE6IEJ1ZmZlci5jb25jYXQoYnVmZmVyIGFzIFVpbnQ4QXJyYXlbXSksXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHBuZy5vbignZXJyb3InLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHBuZy5wYWNrKCk7XHJcbiAgICB9KTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNvbnZlcnRIRFJPckVYUihleHROYW1lOiBzdHJpbmcsIHNvdXJjZTogc3RyaW5nLCB1dWlkOiBzdHJpbmcsIHRlbXA6IHN0cmluZykge1xyXG4gICAgY29uc29sZS5kZWJ1ZyhgU3RhcnQgdG8gY29udmVydCBhc3NldCB7YXNzZXRbJHt1dWlkfV0oJHt1dWlkfSl9YCk7XHJcbiAgICBjb25zdCBkaXN0ID0gam9pbih0ZW1wLCB1dWlkKTtcclxuICAgIGVuc3VyZURpclN5bmModGVtcCk7XHJcbiAgICBpZiAoZXh0TmFtZSA9PT0gJy5oZHInKSB7XHJcbiAgICAgICAgcmV0dXJuIGF3YWl0IGNvbnZlcnRXaXRoQ21mdChzb3VyY2UsIGRpc3QpO1xyXG4gICAgfSBlbHNlIGlmIChleHROYW1lID09PSAnLmV4cicpIHtcclxuICAgICAgICAvLyDlhYjlsJ3or5Xkvb/nlKggY21mdFxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBjb252ZXJ0V2l0aENtZnQoc291cmNlLCBkaXN0LCAnX3dpdGhleHInKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICAvLyDlpoLmnpzkvb/nlKggY21mdCDnm7TmjqXovazlpLHotKXvvIzliJnlhYjovawgaGRyIOWGjeS9v+eUqCBjbWZ0IOWkhOeQhlxyXG4gICAgICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBjb252ZXJ0SW1hZ2VUb0hEUihzb3VyY2UsIHV1aWQsIHRlbXApO1xyXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgY29udmVydFdpdGhDbWZ0KHJlcy5zb3VyY2UsIGRpc3QpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuLy8g5YW85a655pen5o6l5Y+jXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjb252ZXJ0SERSKHNvdXJjZTogc3RyaW5nLCB1dWlkOiBzdHJpbmcsIHRlbXA6IHN0cmluZykge1xyXG4gICAgY29uc29sZS5kZWJ1ZyhgU3RhcnQgdG8gY29udmVydCBhc3NldCB7YXNzZXRbJHt1dWlkfV0oJHt1dWlkfSl9YCk7XHJcbiAgICBjb25zdCBkaXN0ID0gam9pbih0ZW1wLCB1dWlkKTtcclxuICAgIGVuc3VyZURpclN5bmModGVtcCk7XHJcbiAgICByZXR1cm4gYXdhaXQgY29udmVydFdpdGhDbWZ0KHNvdXJjZSwgZGlzdCk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjb252ZXJ0V2l0aENtZnQoZmlsZTogc3RyaW5nLCBkaXN0OiBzdHJpbmcsIHZlcnNpb24gPSAnJyk6IFByb21pc2U8eyBleHROYW1lOiBzdHJpbmc7IHNvdXJjZTogc3RyaW5nIH0+IHtcclxuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9kYXJpb21hbmVza3UvY21mdFxyXG4gICAgbGV0IHRvb2xzID0gam9pbihHbG9iYWxQYXRocy5zdGF0aWNEaXIsIGB0b29scy9jbWZ0L2NtZnRSZWxlYXNlNjQke3ZlcnNpb259JHtwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInID8gJy5leGUnIDogJyd9YCk7XHJcbiAgICBpZiAoIWV4aXN0c1N5bmModG9vbHMpKSB7XHJcbiAgICAgICAgdG9vbHMgPSBqb2luKEdsb2JhbFBhdGhzLnN0YXRpY0RpciwgYHRvb2xzL2NtZnQvY21mdFJlbGVhc2U2NCR7cHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJyA/ICcuZXhlJyA6ICcnfWApO1xyXG4gICAgfVxyXG4gICAgYXdhaXQgdXRpbHMuUHJvY2Vzcy5xdWlja1NwYXduKHRvb2xzLCBbXHJcbiAgICAgICAgJy0tYnlwYXNzb3V0cHV0dHlwZScsXHJcbiAgICAgICAgJy0tb3V0cHV0MHBhcmFtcycsXHJcbiAgICAgICAgJ3BuZyxyZ2JtLGxhdGxvbmcnLFxyXG4gICAgICAgICctLWlucHV0JyxcclxuICAgICAgICBmaWxlLFxyXG4gICAgICAgICctLW91dHB1dDAnLFxyXG4gICAgICAgIGRpc3QsXHJcbiAgICBdKTtcclxuICAgIGNvbnNvbGUuZGVidWcoYENvbnZlcnQgYXNzZXQke2ZpbGV9IC0+IFBORyBzdWNjZXNzLmApO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBleHROYW1lOiAnLnBuZycsXHJcbiAgICAgICAgc291cmNlOiBkaXN0ICsgJy5wbmcnLFxyXG4gICAgfTtcclxufVxyXG4iXX0=