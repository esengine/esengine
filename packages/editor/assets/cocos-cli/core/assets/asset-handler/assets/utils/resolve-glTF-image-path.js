"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.resolveGlTfImagePath = resolveGlTfImagePath;
const path_1 = __importDefault(require("path"));
const fs_extra_1 = __importDefault(require("fs-extra"));
/**
 * 解析 glTF 图像的真实路径。
 * @param imageName 图像资源名。
 * @param expectedPath 图像期望的绝对路径。
 * @param glTFDir glTF 文件所在路径。
 * @param extras glTF 图像的 extras。
 * @param jail Locks the search within specified path.
 */
async function resolveGlTfImagePath(imageName, expectedPath, glTFDir, extras, jail) {
    if (expectedPath && (await fs_extra_1.default.pathExists(expectedPath))) {
        // 如果原始路径本身就存在，就直接使用该路径。
        return expectedPath;
    }
    let fbxGlTfConvImageExtrasFileName = '';
    let fbxGlTfConvImageExtrasRelativeFileName = '';
    if (typeof extras === 'object' && keyFbxGlTfConvImageExtras in extras) {
        console.debug(`Found FBX-glTF-conv specified extras: ${JSON.stringify(extras[keyFbxGlTfConvImageExtras], undefined, 2)}`);
        const { fileName, relativeFileName } = extras[keyFbxGlTfConvImageExtras];
        if (relativeFileName) {
            fbxGlTfConvImageExtrasRelativeFileName = normalizePathInFbx(relativeFileName);
        }
        if (fileName) {
            fbxGlTfConvImageExtrasFileName = normalizePathInFbx(fileName);
        }
    }
    if (fbxGlTfConvImageExtrasRelativeFileName) {
        const path = path_1.default.join(glTFDir, fbxGlTfConvImageExtrasRelativeFileName);
        if (await fs_extra_1.default.pathExists(path)) {
            return path;
        }
    }
    if (fbxGlTfConvImageExtrasFileName && (await fs_extra_1.default.pathExists(fbxGlTfConvImageExtrasFileName))) {
        return fbxGlTfConvImageExtrasFileName;
    }
    // Try find texture.
    console.debug('Image' + `(Name: ${imageName}, Expected path: ${expectedPath})` + ' is not found, fuzzy search starts.');
    const expectedExtName = expectedPath ? path_1.default.extname(expectedPath) : '';
    const expectedExtNameLower = expectedExtName.toLowerCase();
    const expectedBaseName = expectedPath ? path_1.default.basename(expectedPath, expectedExtName) : '';
    // 查找的 baseName。
    const searchBaseNames = new Set();
    if (expectedBaseName.length !== 0) {
        searchBaseNames.add(expectedBaseName);
    }
    if (imageName) {
        searchBaseNames.add(imageName);
    }
    if (fbxGlTfConvImageExtrasFileName) {
        searchBaseNames.add(path_1.default.basename(fbxGlTfConvImageExtrasFileName, path_1.default.extname(fbxGlTfConvImageExtrasFileName)));
    }
    if (fbxGlTfConvImageExtrasRelativeFileName) {
        searchBaseNames.add(path_1.default.basename(fbxGlTfConvImageExtrasRelativeFileName, path_1.default.extname(fbxGlTfConvImageExtrasRelativeFileName)));
    }
    if (searchBaseNames.size === 0) {
        return null;
    }
    // 查找的扩展名。
    const searchExtensions = ['.jpg', '.jpeg', '.png', '.tga', '.webp'];
    if (expectedExtName.length !== 0 && !searchExtensions.includes(expectedExtNameLower)) {
        searchExtensions.unshift(expectedExtNameLower);
    }
    // 查找的文件夹。
    const searchDirectories = ['textures', 'materials'];
    // 查找的深度。
    const maxDepth = 2;
    const normalizedJail = toNormalizedAbsolute(jail);
    const isInJail = (p) => {
        return p.startsWith(normalizedJail);
    };
    const searchBaseNamesArray = Array.from(searchBaseNames);
    let baseDir = toNormalizedAbsolute(glTFDir);
    for (let i = 0; i < maxDepth && isInJail(baseDir); ++i) {
        const result = await fuzzySearchTexture(baseDir, searchBaseNamesArray, searchExtensions);
        if (result) {
            console.debug(`Found ${result}, use it.`);
            return result;
        }
        const items = await fs_extra_1.default.readdir(baseDir);
        for (const item of items) {
            if (!searchDirectories.some((searchDir) => caseInsensitiveStringEqual(item, searchDir))) {
                continue;
            }
            const dir = path_1.default.join(baseDir, item);
            try {
                const stat = await fs_extra_1.default.stat(dir);
                if (!stat.isDirectory()) {
                    continue;
                }
            }
            catch { }
            const result = await fuzzySearchTexture(dir, searchBaseNamesArray, searchExtensions);
            if (result) {
                console.debug(`Found ${result}, use it.`);
                return result;
            }
        }
        baseDir = path_1.default.dirname(baseDir);
    }
    const expectedFileNames = [];
    for (const ext of searchExtensions) {
        for (const baseName of searchBaseNamesArray) {
            expectedFileNames.push(`${baseName}${ext}`.toLowerCase());
        }
    }
    for (const path of listFile(glTFDir)) {
        const baseName = path_1.default.basename(path).toLowerCase();
        if (expectedFileNames.includes(baseName)) {
            return path;
        }
    }
    console.debug('Fuzzy search failed.');
    return null;
}
function* listFile(directory) {
    const dirItems = fs_extra_1.default.readdirSync(directory);
    for (const dirItem of dirItems) {
        const fullPath = path_1.default.join(directory, dirItem);
        const stats = fs_extra_1.default.statSync(fullPath);
        if (stats.isFile()) {
            yield fullPath;
        }
        else if (stats.isDirectory()) {
            yield* listFile(fullPath);
        }
    }
}
function toNormalizedAbsolute(p) {
    const np = path_1.default.isAbsolute(p) ? p : path_1.default.join(process.cwd(), p);
    return path_1.default.normalize(np);
}
async function fuzzySearchTexture(directory, baseNames, extensions) {
    if (!(await fs_extra_1.default.pathExists(directory))) {
        return null;
    }
    const dirItems = await fs_extra_1.default.readdir(directory);
    for (const dirItem of dirItems) {
        const extName = path_1.default.extname(dirItem);
        const baseName = path_1.default.basename(dirItem, extName);
        if (!baseNames.some((item) => caseInsensitiveStringEqual(baseName, item))) {
            continue;
        }
        const fullName = path_1.default.join(directory, dirItem);
        const stat = await fs_extra_1.default.stat(fullName);
        if (!stat.isFile()) {
            continue;
        }
        if (extensions.indexOf(extName.toLowerCase()) >= 0) {
            return fullName;
        }
    }
    return null;
}
function caseInsensitiveStringEqual(a, b) {
    return a.length === b.length && a.toLowerCase() === b.toLowerCase();
}
const keyFbxGlTfConvImageExtras = 'FBX-glTF-conv';
function normalizePathInFbx(path) {
    return path.split(/[\\/]/g).join(path_1.default.sep);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb2x2ZS1nbFRGLWltYWdlLXBhdGguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9hc3NldHMvYXNzZXQtaGFuZGxlci9hc3NldHMvdXRpbHMvcmVzb2x2ZS1nbFRGLWltYWdlLXBhdGgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFXQSxvREE4SEM7QUF6SUQsZ0RBQXNCO0FBQ3RCLHdEQUEwQjtBQUUxQjs7Ozs7OztHQU9HO0FBQ0ksS0FBSyxVQUFVLG9CQUFvQixDQUN0QyxTQUE2QixFQUM3QixZQUFnQyxFQUNoQyxPQUFlLEVBQ2YsTUFBVyxFQUNYLElBQVk7SUFFWixJQUFJLFlBQVksSUFBSSxDQUFDLE1BQU0sa0JBQUUsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQ3RELHdCQUF3QjtRQUN4QixPQUFPLFlBQVksQ0FBQztJQUN4QixDQUFDO0lBRUQsSUFBSSw4QkFBOEIsR0FBRyxFQUFFLENBQUM7SUFDeEMsSUFBSSxzQ0FBc0MsR0FBRyxFQUFFLENBQUM7SUFDaEQsSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRLElBQUkseUJBQXlCLElBQUksTUFBTSxFQUFFLENBQUM7UUFDcEUsT0FBTyxDQUFDLEtBQUssQ0FBQyx5Q0FBeUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMseUJBQXlCLENBQUMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzFILE1BQU0sRUFBRSxRQUFRLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxNQUFNLENBQUMseUJBQXlCLENBQTRCLENBQUM7UUFDcEcsSUFBSSxnQkFBZ0IsRUFBRSxDQUFDO1lBQ25CLHNDQUFzQyxHQUFHLGtCQUFrQixDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDbEYsQ0FBQztRQUNELElBQUksUUFBUSxFQUFFLENBQUM7WUFDWCw4QkFBOEIsR0FBRyxrQkFBa0IsQ0FB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U0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsMEJBQTBCLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUN4RSxTQUFTO1FBQ2IsQ0FBQztRQUNELE1BQU0sUUFBUSxHQUFHLGNBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQzdDLE1BQU0sSUFBSSxHQUFHLE1BQU0sa0JBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDckMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDO1lBQ2pCLFNBQVM7UUFDYixDQUFDO1FBQ0QsSUFBSSxVQUFVLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQ2pELE9BQU8sUUFBUSxDQUFDO1FBQ3BCLENBQUM7SUFDTCxDQUFDO0lBQ0QsT0FBTyxJQUFJLENBQUM7QUFDaEIsQ0FBQztBQUVELFNBQVMsMEJBQTBCLENBQUMsQ0FBUyxFQUFFLENBQVM7SUFDcEQsT0FBTyxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztBQUN4RSxDQUFDO0FBRUQsTUFBTSx5QkFBeUIsR0FBRyxlQUFlLENBQUM7QUFjbEQsU0FBUyxrQkFBa0IsQ0FBQyxJQUFZO0lBQ3BDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzdDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcHMgZnJvbSAncGF0aCc7XHJcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XHJcblxyXG4vKipcclxuICog6Kej5p6QIGdsVEYg5Zu+5YOP55qE55yf5a6e6Lev5b6E44CCXHJcbiAqIEBwYXJhbSBpbWFnZU5hbWUg5Zu+5YOP6LWE5rqQ5ZCN44CCXHJcbiAqIEBwYXJhbSBleHBlY3RlZFBhdGgg5Zu+5YOP5pyf5pyb55qE57ud5a+56Lev5b6E44CCXHJcbiAqIEBwYXJhbSBnbFRGRGlyIGdsVEYg5paH5Lu25omA5Zyo6Lev5b6E44CCXHJcbiAqIEBwYXJhbSBleHRyYXMgZ2xURiDlm77lg4/nmoQgZXh0cmFz44CCXHJcbiAqIEBwYXJhbSBqYWlsIExvY2tzIHRoZSBzZWFyY2ggd2l0aGluIHNwZWNpZmllZCBwYXRoLlxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlc29sdmVHbFRmSW1hZ2VQYXRoKFxyXG4gICAgaW1hZ2VOYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQsXHJcbiAgICBleHBlY3RlZFBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCxcclxuICAgIGdsVEZEaXI6IHN0cmluZyxcclxuICAgIGV4dHJhczogYW55LFxyXG4gICAgamFpbDogc3RyaW5nLFxyXG4pIHtcclxuICAgIGlmIChleHBlY3RlZFBhdGggJiYgKGF3YWl0IGZzLnBhdGhFeGlzdHMoZXhwZWN0ZWRQYXRoKSkpIHtcclxuICAgICAgICAvLyDlpoLmnpzljp/lp4vot6/lvoTmnKzouqvlsLHlrZjlnKjvvIzlsLHnm7TmjqXkvb/nlKjor6Xot6/lvoTjgIJcclxuICAgICAgICByZXR1cm4gZXhwZWN0ZWRQYXRoO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBmYnhHbFRmQ29udkltYWdlRXh0cmFzRmlsZU5hbWUgPSAnJztcclxuICAgIGxldCBmYnhHbFRmQ29udkltYWdlRXh0cmFzUmVsYXRpdmVGaWxlTmFtZSA9ICcnO1xyXG4gICAgaWYgKHR5cGVvZiBleHRyYXMgPT09ICdvYmplY3QnICYmIGtleUZieEdsVGZDb252SW1hZ2VFeHRyYXMgaW4gZXh0cmFzKSB7XHJcbiAgICAgICAgY29uc29sZS5kZWJ1ZyhgRm91bmQgRkJYLWdsVEYtY29udiBzcGVjaWZpZWQgZXh0cmFzOiAke0pTT04uc3RyaW5naWZ5KGV4dHJhc1trZXlGYnhHbFRmQ29udkltYWdlRXh0cmFzXSwgdW5kZWZpbmVkLCAyKX1gKTtcclxuICAgICAgICBjb25zdCB7IGZpbGVOYW1lLCByZWxhdGl2ZUZpbGVOYW1lIH0gPSBleHRyYXNba2V5RmJ4R2xUZkNvbnZJbWFnZUV4dHJhc10gYXMgSUZieEdsVGZDb252SW1hZ2VFeHRyYXM7XHJcbiAgICAgICAgaWYgKHJlbGF0aXZlRmlsZU5hbWUpIHtcclxuICAgICAgICAgICAgZmJ4R2xUZkNvbnZJbWFnZUV4dHJhc1JlbGF0aXZlRmlsZU5hbWUgPSBub3JtYWxpemVQYXRoSW5GYngocmVsYXRpdmVGaWxlTmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChmaWxlTmFtZSkge1xyXG4gICAgICAgICAgICBmYnhHbFRmQ29udkltYWdlRXh0cmFzRmlsZU5hbWUgPSBub3JtYWxpemVQYXRoSW5GYngoZmlsZU5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAoZmJ4R2xUZkNvbnZJbWFnZUV4dHJhc1JlbGF0aXZlRmlsZU5hbWUpIHtcclxuICAgICAgICBjb25zdCBwYXRoID0gcHMuam9pbihnbFRGRGlyLCBmYnhHbFRmQ29udkltYWdlRXh0cmFzUmVsYXRpdmVGaWxlTmFtZSk7XHJcbiAgICAgICAgaWYgKGF3YWl0IGZzLnBhdGhFeGlzdHMocGF0aCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHBhdGg7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChmYnhHbFRmQ29udkltYWdlRXh0cmFzRmlsZU5hbWUgJiYgKGF3YWl0IGZzLnBhdGhFeGlzdHMoZmJ4R2xUZkNvbnZJbWFnZUV4dHJhc0ZpbGVOYW1lKSkpIHtcclxuICAgICAgICByZXR1cm4gZmJ4R2xUZkNvbnZJbWFnZUV4dHJhc0ZpbGVOYW1lO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFRyeSBmaW5kIHRleHR1cmUuXHJcblxyXG4gICAgY29uc29sZS5kZWJ1ZygnSW1hZ2UnICsgYChOYW1lOiAke2ltYWdlTmFtZX0sIEV4cGVjdGVkIHBhdGg6ICR7ZXhwZWN0ZWRQYXRofSlgICsgJyBpcyBub3QgZm91bmQsIGZ1enp5IHNlYXJjaCBzdGFydHMuJyk7XHJcblxyXG4gICAgY29uc3QgZXhwZWN0ZWRFeHROYW1lID0gZXhwZWN0ZWRQYXRoID8gcHMuZXh0bmFtZShleHBlY3RlZFBhdGgpIDogJyc7XHJcbiAgICBjb25zdCBleHBlY3RlZEV4dE5hbWVMb3dlciA9IGV4cGVjdGVkRXh0TmFtZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgY29uc3QgZXhwZWN0ZWRCYXNlTmFtZSA9IGV4cGVjdGVkUGF0aCA/IHBzLmJhc2VuYW1lKGV4cGVjdGVkUGF0aCwgZXhwZWN0ZWRFeHROYW1lKSA6ICcnO1xyXG5cclxuICAgIC8vIOafpeaJvueahCBiYXNlTmFtZeOAglxyXG4gICAgY29uc3Qgc2VhcmNoQmFzZU5hbWVzID0gbmV3IFNldDxzdHJpbmc+KCk7XHJcbiAgICBpZiAoZXhwZWN0ZWRCYXNlTmFtZS5sZW5ndGggIT09IDApIHtcclxuICAgICAgICBzZWFyY2hCYXNlTmFtZXMuYWRkKGV4cGVjdGVkQmFzZU5hbWUpO1xyXG4gICAgfVxyXG4gICAgaWYgKGltYWdlTmFtZSkge1xyXG4gICAgICAgIHNlYXJjaEJhc2VOYW1lcy5hZGQoaW1hZ2VOYW1lKTtcclxuICAgIH1cclxuICAgIGlmIChmYnhHbFRmQ29udkltYWdlRXh0cmFzRmlsZU5hbWUpIHtcclxuICAgICAgICBzZWFyY2hCYXNlTmFtZXMuYWRkKHBzLmJhc2VuYW1lKGZieEdsVGZDb252SW1hZ2VFeHRyYXNGaWxlTmFtZSwgcHMuZXh0bmFtZShmYnhHbFRmQ29udkltYWdlRXh0cmFzRmlsZU5hbWUpKSk7XHJcbiAgICB9XHJcbiAgICBpZiAoZmJ4R2xUZkNvbnZJbWFnZUV4dHJhc1JlbGF0aXZlRmlsZU5hbWUpIHtcclxuICAgICAgICBzZWFyY2hCYXNlTmFtZXMuYWRkKHBzLmJhc2VuYW1lKGZieEdsVGZDb252SW1hZ2VFeHRyYXNSZWxhdGl2ZUZpbGVOYW1lLCBwcy5leHRuYW1lKGZieEdsVGZDb252SW1hZ2VFeHRyYXNSZWxhdGl2ZUZpbGVOYW1lKSkpO1xyXG4gICAgfVxyXG4gICAgaWYgKHNlYXJjaEJhc2VOYW1lcy5zaXplID09PSAwKSB7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5p+l5om+55qE5omp5bGV5ZCN44CCXHJcbiAgICBjb25zdCBzZWFyY2hFeHRlbnNpb25zID0gWycuanBnJywgJy5qcGVnJywgJy5wbmcnLCAnLnRnYScsICcud2VicCddO1xyXG4gICAgaWYgKGV4cGVjdGVkRXh0TmFtZS5sZW5ndGggIT09IDAgJiYgIXNlYXJjaEV4dGVuc2lvbnMuaW5jbHVkZXMoZXhwZWN0ZWRFeHROYW1lTG93ZXIpKSB7XHJcbiAgICAgICAgc2VhcmNoRXh0ZW5zaW9ucy51bnNoaWZ0KGV4cGVjdGVkRXh0TmFtZUxvd2VyKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDmn6Xmib7nmoTmlofku7blpLnjgIJcclxuICAgIGNvbnN0IHNlYXJjaERpcmVjdG9yaWVzID0gWyd0ZXh0dXJlcycsICdtYXRlcmlhbHMnXTtcclxuXHJcbiAgICAvLyDmn6Xmib7nmoTmt7HluqbjgIJcclxuICAgIGNvbnN0IG1heERlcHRoID0gMjtcclxuXHJcbiAgICBjb25zdCBub3JtYWxpemVkSmFpbCA9IHRvTm9ybWFsaXplZEFic29sdXRlKGphaWwpO1xyXG4gICAgY29uc3QgaXNJbkphaWwgPSAocDogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHAuc3RhcnRzV2l0aChub3JtYWxpemVkSmFpbCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IHNlYXJjaEJhc2VOYW1lc0FycmF5ID0gQXJyYXkuZnJvbShzZWFyY2hCYXNlTmFtZXMpO1xyXG4gICAgbGV0IGJhc2VEaXIgPSB0b05vcm1hbGl6ZWRBYnNvbHV0ZShnbFRGRGlyKTtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWF4RGVwdGggJiYgaXNJbkphaWwoYmFzZURpcik7ICsraSkge1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGZ1enp5U2VhcmNoVGV4dHVyZShiYXNlRGlyLCBzZWFyY2hCYXNlTmFtZXNBcnJheSwgc2VhcmNoRXh0ZW5zaW9ucyk7XHJcbiAgICAgICAgaWYgKHJlc3VsdCkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKGBGb3VuZCAke3Jlc3VsdH0sIHVzZSBpdC5gKTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGl0ZW1zID0gYXdhaXQgZnMucmVhZGRpcihiYXNlRGlyKTtcclxuICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgaXRlbXMpIHtcclxuICAgICAgICAgICAgaWYgKCFzZWFyY2hEaXJlY3Rvcmllcy5zb21lKChzZWFyY2hEaXIpID0+IGNhc2VJbnNlbnNpdGl2ZVN0cmluZ0VxdWFsKGl0ZW0sIHNlYXJjaERpcikpKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgZGlyID0gcHMuam9pbihiYXNlRGlyLCBpdGVtKTtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHN0YXQgPSBhd2FpdCBmcy5zdGF0KGRpcik7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXN0YXQuaXNEaXJlY3RvcnkoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGNhdGNoIHt9XHJcblxyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBmdXp6eVNlYXJjaFRleHR1cmUoZGlyLCBzZWFyY2hCYXNlTmFtZXNBcnJheSwgc2VhcmNoRXh0ZW5zaW9ucyk7XHJcbiAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoYEZvdW5kICR7cmVzdWx0fSwgdXNlIGl0LmApO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBiYXNlRGlyID0gcHMuZGlybmFtZShiYXNlRGlyKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBleHBlY3RlZEZpbGVOYW1lczogc3RyaW5nW10gPSBbXTtcclxuICAgIGZvciAoY29uc3QgZXh0IG9mIHNlYXJjaEV4dGVuc2lvbnMpIHtcclxuICAgICAgICBmb3IgKGNvbnN0IGJhc2VOYW1lIG9mIHNlYXJjaEJhc2VOYW1lc0FycmF5KSB7XHJcbiAgICAgICAgICAgIGV4cGVjdGVkRmlsZU5hbWVzLnB1c2goYCR7YmFzZU5hbWV9JHtleHR9YC50b0xvd2VyQ2FzZSgpKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZm9yIChjb25zdCBwYXRoIG9mIGxpc3RGaWxlKGdsVEZEaXIpKSB7XHJcbiAgICAgICAgY29uc3QgYmFzZU5hbWUgPSBwcy5iYXNlbmFtZShwYXRoKS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgIGlmIChleHBlY3RlZEZpbGVOYW1lcy5pbmNsdWRlcyhiYXNlTmFtZSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHBhdGg7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgY29uc29sZS5kZWJ1ZygnRnV6enkgc2VhcmNoIGZhaWxlZC4nKTtcclxuICAgIHJldHVybiBudWxsO1xyXG59XHJcblxyXG5mdW5jdGlvbiogbGlzdEZpbGUoZGlyZWN0b3J5OiBzdHJpbmcpOiBHZW5lcmF0b3I8c3RyaW5nPiB7XHJcbiAgICBjb25zdCBkaXJJdGVtcyA9IGZzLnJlYWRkaXJTeW5jKGRpcmVjdG9yeSk7XHJcbiAgICBmb3IgKGNvbnN0IGRpckl0ZW0gb2YgZGlySXRlbXMpIHtcclxuICAgICAgICBjb25zdCBmdWxsUGF0aCA9IHBzLmpvaW4oZGlyZWN0b3J5LCBkaXJJdGVtKTtcclxuICAgICAgICBjb25zdCBzdGF0cyA9IGZzLnN0YXRTeW5jKGZ1bGxQYXRoKTtcclxuICAgICAgICBpZiAoc3RhdHMuaXNGaWxlKCkpIHtcclxuICAgICAgICAgICAgeWllbGQgZnVsbFBhdGg7XHJcbiAgICAgICAgfSBlbHNlIGlmIChzdGF0cy5pc0RpcmVjdG9yeSgpKSB7XHJcbiAgICAgICAgICAgIHlpZWxkKiBsaXN0RmlsZShmdWxsUGF0aCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiB0b05vcm1hbGl6ZWRBYnNvbHV0ZShwOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IG5wID0gcHMuaXNBYnNvbHV0ZShwKSA/IHAgOiBwcy5qb2luKHByb2Nlc3MuY3dkKCksIHApO1xyXG4gICAgcmV0dXJuIHBzLm5vcm1hbGl6ZShucCk7XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGZ1enp5U2VhcmNoVGV4dHVyZShkaXJlY3Rvcnk6IHN0cmluZywgYmFzZU5hbWVzOiBzdHJpbmdbXSwgZXh0ZW5zaW9uczogc3RyaW5nW10pIHtcclxuICAgIGlmICghKGF3YWl0IGZzLnBhdGhFeGlzdHMoZGlyZWN0b3J5KSkpIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IGRpckl0ZW1zID0gYXdhaXQgZnMucmVhZGRpcihkaXJlY3RvcnkpO1xyXG4gICAgZm9yIChjb25zdCBkaXJJdGVtIG9mIGRpckl0ZW1zKSB7XHJcbiAgICAgICAgY29uc3QgZXh0TmFtZSA9IHBzLmV4dG5hbWUoZGlySXRlbSk7XHJcbiAgICAgICAgY29uc3QgYmFzZU5hbWUgPSBwcy5iYXNlbmFtZShkaXJJdGVtLCBleHROYW1lKTtcclxuICAgICAgICBpZiAoIWJhc2VOYW1lcy5zb21lKChpdGVtKSA9PiBjYXNlSW5zZW5zaXRpdmVTdHJpbmdFcXVhbChiYXNlTmFtZSwgaXRlbSkpKSB7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBmdWxsTmFtZSA9IHBzLmpvaW4oZGlyZWN0b3J5LCBkaXJJdGVtKTtcclxuICAgICAgICBjb25zdCBzdGF0ID0gYXdhaXQgZnMuc3RhdChmdWxsTmFtZSk7XHJcbiAgICAgICAgaWYgKCFzdGF0LmlzRmlsZSgpKSB7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZXh0ZW5zaW9ucy5pbmRleE9mKGV4dE5hbWUudG9Mb3dlckNhc2UoKSkgPj0gMCkge1xyXG4gICAgICAgICAgICByZXR1cm4gZnVsbE5hbWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNhc2VJbnNlbnNpdGl2ZVN0cmluZ0VxdWFsKGE6IHN0cmluZywgYjogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gYS5sZW5ndGggPT09IGIubGVuZ3RoICYmIGEudG9Mb3dlckNhc2UoKSA9PT0gYi50b0xvd2VyQ2FzZSgpO1xyXG59XHJcblxyXG5jb25zdCBrZXlGYnhHbFRmQ29udkltYWdlRXh0cmFzID0gJ0ZCWC1nbFRGLWNvbnYnO1xyXG5cclxuaW50ZXJmYWNlIElGYnhHbFRmQ29udkltYWdlRXh0cmFzIHtcclxuICAgIC8qKlxyXG4gICAgICogU2VlIGBGYnhGaWxlVGV4dHVyZTo6R2V0RmlsZU5hbWUoKWAuXHJcbiAgICAgKi9cclxuICAgIGZpbGVOYW1lOiBzdHJpbmc7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBTZWUgYEZieEZpbGVUZXh0dXJlOjpHZXRSZWxhdGl2ZUZpbGVOYW1lKClgLlxyXG4gICAgICovXHJcbiAgICByZWxhdGl2ZUZpbGVOYW1lOiBzdHJpbmc7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG5vcm1hbGl6ZVBhdGhJbkZieChwYXRoOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBwYXRoLnNwbGl0KC9bXFxcXC9dL2cpLmpvaW4ocHMuc2VwKTtcclxufVxyXG4iXX0=