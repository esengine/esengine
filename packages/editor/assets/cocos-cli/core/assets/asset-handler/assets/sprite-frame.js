'use strict';
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SpriteFrameHandler = void 0;
exports.trimImage = trimImage;
const asset_db_1 = require("@cocos/asset-db");
const cc = __importStar(require("cc"));
const utils_1 = require("../utils");
const utils_2 = require("./image/utils");
const i18n_1 = __importDefault(require("../../../base/i18n"));
try {
    require('sharp');
}
catch (error) {
    console.error(error);
    console.error(i18n_1.default.t('importer.sharp_error'));
}
const Sharp = require('sharp');
Sharp.cache(false);
exports.SpriteFrameHandler = {
    // Handler 的名字，用于指定 Handler as 等
    name: 'sprite-frame',
    assetType: 'cc.SpriteFrame',
    iconInfo: {
        default: utils_2.defaultIconConfig,
        async generateThumbnail(asset) {
            let parentAsset = (0, asset_db_1.queryAsset)(asset.meta.userData.imageUuidOrDatabaseUri);
            if (parentAsset.meta.importer !== 'image') {
                parentAsset = parentAsset.parent;
            }
            if (parentAsset.invalid) {
                return utils_2.defaultIconConfig;
            }
            const extname = parentAsset.meta.files.find((extName) => extName !== '.json') || '.png';
            const imagePath = parentAsset.library + extname;
            const dest = asset.library + '_sprite_trim_' + extname;
            const userData = asset.userData;
            try {
                await trimImage(imagePath, dest, userData);
            }
            catch (error) {
                console.warn(`trim image {file(${imagePath})} to generate thumbnail failed~`);
                console.warn(error);
                return utils_2.defaultIconConfig;
            }
            return {
                type: 'image',
                value: dest,
            };
        },
    },
    userDataConfig: {
        default: {
            trimType: {
                default: 'auto',
                label: 'i18n:ENGINE.assets.spriteFrame.trimType',
                render: {
                    ui: 'ui-select',
                    items: [
                        {
                            label: 'auto',
                            value: 'auto',
                        },
                        {
                            label: 'custom',
                            value: 'custom',
                        },
                        {
                            label: 'none',
                            value: 'none',
                        },
                    ],
                },
            },
        },
    },
    importer: {
        // 版本号如果变更，则会强制重新导入
        version: '1.0.12',
        /**
         * 实际导入流程
         * 需要自己控制是否生成、拷贝文件
         *
         * 返回是否导入成功的标记
         * 如果返回 false，则 imported 标记不会变成 true
         * 后续的一系列操作都不会执行
         * @param asset
         */
        async import(asset) {
            // 如果没有生成 json 文件，则重新生成
            if (!asset.parent) {
                return false;
            }
            if (asset.parent.meta.importer === 'image') {
                const userData = asset.userData;
                let file;
                // TODO 此处需要更换通用写法，这样容易漏掉一些新格式支持的更新
                // @ts-ignore
                if (['.tga', '.hdr', '.bmp', '.exr', '.znt', '.psd'].includes(asset.parent.extname.toLowerCase())) {
                    file = asset.parent.library + '.png';
                }
                else {
                    file = asset.parent.source;
                }
                const MIN_SIZE = 1;
                const imageData = await Sharp(file).raw().toBuffer({ resolveWithObject: true });
                if (!imageData) {
                    return false;
                }
                if (userData.trimThreshold === undefined) {
                    userData.trimThreshold = 1;
                }
                userData.rotated = !!userData.rotated;
                userData.packable = userData.packable === undefined ? true : userData.packable;
                userData.rawHeight = imageData.info.height;
                userData.rawWidth = imageData.info.width;
                if (userData.trimType === 'auto') {
                    if (imageData.info.channels !== 4) {
                        userData.width = imageData.info.width;
                        userData.height = imageData.info.height;
                        userData.trimX = 0;
                        userData.trimY = 0;
                    }
                    else {
                        const rect = (0, utils_1.getTrimRect)(Buffer.from(imageData.data), userData.rawWidth, userData.rawHeight, userData.trimThreshold);
                        userData.width = Math.max(rect[2], MIN_SIZE);
                        userData.height = Math.max(rect[3], MIN_SIZE);
                        userData.trimX = cc.clamp(rect[0], 0, userData.rawWidth - userData.width);
                        userData.trimY = cc.clamp(rect[1], 0, userData.rawHeight - userData.height);
                    }
                }
                else if (userData.trimType === 'none') {
                    userData.trimX = 0;
                    userData.trimY = 0;
                    userData.width = imageData.info.width;
                    userData.height = imageData.info.height;
                }
                else {
                    userData.trimX = cc.clamp(userData.trimX, 0, userData.rawWidth - MIN_SIZE);
                    userData.trimY = cc.clamp(userData.trimY, 0, userData.rawHeight - MIN_SIZE);
                    userData.width = cc.clamp(userData.width === -1 ? userData.rawWidth : userData.width, MIN_SIZE, userData.rawWidth - userData.trimX);
                    userData.height = cc.clamp(userData.height === -1 ? userData.rawHeight : userData.height, MIN_SIZE, userData.rawHeight - userData.trimY);
                }
                userData.offsetX = userData.trimX + userData.width / 2 - userData.rawWidth / 2;
                userData.offsetY = -(userData.trimY + userData.height / 2 - userData.rawHeight / 2);
                userData.borderLeft = cc.clamp(userData.borderLeft, 0, userData.width);
                userData.borderRight = cc.clamp(userData.borderRight, 0, userData.width - userData.borderLeft);
                userData.borderTop = cc.clamp(userData.borderTop, 0, userData.height);
                userData.borderBottom = cc.clamp(userData.borderBottom, 0, userData.height - userData.borderTop);
                // userData.pixelsToUnit = 100;
                // userData.pivotX = 0.5;
                // userData.pivotY = 0.5;
                // userData.meshType = 0;
                initVerticesData(userData);
            }
            // userData.vertices = undefined;
            const spriteFrame = createSpriteFrame(asset);
            if (asset.parent instanceof asset_db_1.Asset) {
                spriteFrame.name = spriteFrame.name || asset.parent.basename || '';
            }
            getTexture(asset, spriteFrame);
            const serializeJSON = EditorExtends.serialize(spriteFrame);
            await asset.saveToLibrary('.json', serializeJSON);
            // plist 文件下导入的 sprite 序列化信息会记录父资源 uuid 但在依赖关系上并不依赖，需要走反序列化获取对的依赖关系
            const depends = (0, utils_1.getDependUUIDList)(JSON.parse(serializeJSON));
            asset.setData('depends', depends);
            return true;
        },
    },
};
exports.default = exports.SpriteFrameHandler;
async function trimImage(source, dest, options) {
    const image = Sharp(source).extract({
        left: options.trimX,
        top: options.trimY,
        width: options.rotated ? options.height : options.width,
        height: options.rotated ? options.width : options.height,
    });
    if (options.rotated) {
        image.rotate(270);
    }
    return await image.toFile(dest);
}
function createSpriteFrame(asset) {
    const userData = asset.userData;
    const sprite = new cc.SpriteFrame();
    sprite.name = asset.displayName ? asset.displayName : asset._name;
    sprite.atlasUuid = userData.atlasUuid;
    // @ts-ignore
    sprite._rect = cc.rect(userData.trimX, userData.trimY, userData.width, userData.height);
    // @ts-ignore
    sprite._originalSize = cc.size(userData.rawWidth, userData.rawHeight);
    // @ts-ignore
    sprite._offset = cc.v2(userData.offsetX, userData.offsetY);
    // @ts-ignore
    sprite._capInsets = [userData.borderLeft, userData.borderTop, userData.borderRight, userData.borderBottom];
    // @ts-ignore
    sprite._rotated = userData.rotated;
    // @ts-ignore
    sprite._packable = userData.packable;
    // @ts-ignore
    sprite._pixelsToUnit = userData.pixelsToUnit;
    // @ts-ignore
    sprite._pivot = cc.v2(userData.pivotX, userData.pivotY);
    // @ts-ignore
    sprite._meshType = userData.meshType;
    // @ts-ignore
    initVertices(sprite, userData);
    return sprite;
}
function getTexture(asset, spriteFrame) {
    const userData = asset.userData;
    // Get Texture
    const imageUuidOrDatabaseUri = userData.imageUuidOrDatabaseUri;
    if (!imageUuidOrDatabaseUri) {
        return;
    }
    else {
        let imageUuid = null;
        if (userData.isUuid) {
            imageUuid = imageUuidOrDatabaseUri;
        }
        else {
            imageUuid = (0, asset_db_1.queryUUID)(imageUuidOrDatabaseUri);
            if (!imageUuid) {
                console.warn(`Cannot find image ${(0, asset_db_1.queryPath)(imageUuidOrDatabaseUri) || ''}.`);
            }
        }
        if (imageUuid !== null) {
            // @ts-ignore
            spriteFrame._texture = EditorExtends.serialize.asAsset(imageUuid, cc.Texture2D);
        }
    }
}
function initVerticesData(userData) {
    if (userData.vertices === undefined) {
        userData.vertices = {
            rawPosition: [],
            indexes: [],
            uv: [],
            nuv: [],
            minPos: [],
            maxPos: [],
        };
    }
    const vertices = userData.vertices;
    vertices.rawPosition.length = 0;
    if (userData.meshType === cc.SpriteFrame.MeshType.POLYGON) {
        // 使用 Bayazit 来生成顶点并赋值
    }
    else {
        const width = userData.width;
        const height = userData.height;
        const halfWidth = width / 2;
        const halfHeight = height / 2;
        const texw = userData.rawWidth;
        const texh = userData.rawHeight;
        const rectX = userData.trimX;
        const rectY = texh - userData.trimY - height;
        const l = texw === 0 ? 0 : rectX / texw;
        const r = texw === 0 ? 1 : (rectX + width) / texw;
        const t = texh === 0 ? 1 : (rectY + height) / texh;
        const b = texh === 0 ? 0 : rectY / texh;
        vertices.rawPosition = [-halfWidth, -halfHeight, 0, halfWidth, -halfHeight, 0, -halfWidth, halfHeight, 0, halfWidth, halfHeight, 0];
        vertices.uv = [rectX, rectY + height, rectX + width, rectY + height, rectX, rectY, rectX + width, rectY];
        vertices.nuv = [l, b, r, b, l, t, r, t];
        vertices.indexes = [0, 1, 2, 2, 1, 3];
        vertices.minPos = [-halfWidth, -halfHeight, 0];
        vertices.maxPos = [halfWidth, halfHeight, 0];
    }
}
function initVertices(sprite, userData) {
    const userVertices = userData.vertices;
    sprite.vertices = {
        rawPosition: [],
        positions: [],
        indexes: userVertices.indexes,
        uv: userVertices.uv,
        nuv: userVertices.nuv,
        minPos: cc.v3(userVertices.minPos[0], userVertices.minPos[1], userVertices.minPos[2]),
        maxPos: cc.v3(userVertices.maxPos[0], userVertices.maxPos[1], userVertices.maxPos[2]),
    };
    const vertices = sprite.vertices;
    const rawPosition = userVertices.rawPosition;
    const tempVec3 = cc.v3();
    for (let i = 0; i < rawPosition.length; i += 3) {
        tempVec3.set(rawPosition[i], rawPosition[i + 1], rawPosition[i + 2]);
        vertices.rawPosition.push(tempVec3.clone());
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ByaXRlLWZyYW1lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvYXNzZXRzL2Fzc2V0LWhhbmRsZXIvYXNzZXRzL3Nwcml0ZS1mcmFtZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQTZNYiw4QkFXQztBQXRORCw4Q0FBd0Y7QUFDeEYsdUNBQXlCO0FBSXpCLG9DQUEwRDtBQUMxRCx5Q0FBa0Q7QUFDbEQsOERBQXNDO0FBRXRDLElBQUksQ0FBQztJQUNELE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNyQixDQUFDO0FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztJQUNiLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDckIsT0FBTyxDQUFDLEtBQUssQ0FBQyxjQUFJLENBQUMsQ0FBQyxDQUFDLHNCQUFzQixDQUFDLENBQUMsQ0FBQztBQUNsRCxDQUFDO0FBRUQsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBRS9CLEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7QUFFTixRQUFBLGtCQUFrQixHQUFpQjtJQUM1QyxnQ0FBZ0M7SUFDaEMsSUFBSSxFQUFFLGNBQWM7SUFFcEIsU0FBUyxFQUFFLGdCQUFnQjtJQUMzQixRQUFRLEVBQUU7UUFDTixPQUFPLEVBQUUseUJBQWlCO1FBQzFCLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxLQUFZO1lBQ2hDLElBQUksV0FBVyxHQUFHLElBQUEscUJBQVUsRUFBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxzQkFBc0IsQ0FBVSxDQUFDO1lBQ2xGLElBQUksV0FBVyxDQUFDLElBQUksQ0FBQyxRQUFRLEtBQUssT0FBTyxFQUFFLENBQUM7Z0JBQ3hDLFdBQVcsR0FBRyxXQUFXLENBQUMsTUFBZSxD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QUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQzt3QkFDN0MsUUFBUSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQzt3QkFDOUMsUUFBUSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsUUFBUSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7d0JBQzFFLFFBQVEsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUNoRixDQUFDO2dCQUNMLENBQUM7cUJBQU0sSUFBSSxRQUFRLENBQUMsUUFBUSxLQUFLLE1BQU0sRUFBRSxDQUFDO29CQUN0QyxRQUFRLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztvQkFDbkIsUUFBUSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7b0JBQ25CLFFBQVEsQ0FBQyxLQUFLLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7b0JBQ3RDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7Z0JBQzVDLENBQUM7cUJBQU0sQ0FBQztvQkFDSixRQUFRLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDLEVBQUUsUUFBUSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsQ0FBQztvQkFDM0UsUUFBUSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxTQUFTLEdBQUcsUUFB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QztRQUN4RCxzQkFBc0I7SUFDMUIsQ0FBQztTQUFNLENBQUM7UUFDSixNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDO1FBQzdCLE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUM7UUFDL0IsTUFBTSxTQUFTLEdBQUcsS0FBSyxHQUFHLENBQUMsQ0FBQztRQUM1QixNQUFNLFVBQVUsR0FBRyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBQzlCLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUM7UUFDL0IsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQztRQUNoQyxNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDO1FBQzdCLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxRQUFRLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQztRQUM3QyxNQUFNLENBQUMsR0FBRyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDeEMsTUFBTSxDQUFDLEdBQUcsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDbEQsTUFBTSxDQUFDLEdBQUcsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDbkQsTUFBTSxDQUFDLEdBQUcsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ3hDLFFBQVEsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDLFVBQVUsRUFBRSxDQUFDLEVBQUUsU0FBUyxFQUFFLENBQUMsVUFBVSxFQUFFLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxVQUFVLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDcEksUUFBUSxDQUFDLEVBQUUsR0FBRyxDQUFDLEtBQUssRUFBRSxLQUFLLEdBQUcsTUFBTSxFQUFFLEtBQUssR0FBRyxLQUFLLEVBQUUsS0FBSyxHQUFHLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssR0FBRyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDekcsUUFBUSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN4QyxRQUFRLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN0QyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDL0MsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLFNBQVMsRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDakQsQ0FBQztBQUNMLENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBQyxNQUFzQixFQUFFLFFBQXNDO0lBQ2hGLE1BQU0sWUFBWSxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUM7SUFDdkMsTUFBTSxDQUFDLFFBQVEsR0FBRztRQUNkLFdBQVcsRUFBRSxFQUFFO1FBQ2YsU0FBUyxFQUFFLEVBQUU7UUFDYixPQUFPLEVBQUUsWUFBWSxDQUFDLE9BQU87UUFDN0IsRUFBRSxFQUFFLFlBQVksQ0FBQyxFQUFFO1FBQ25CLEdBQUcsRUFBRSxZQUFZLENBQUMsR0FBRztRQUNyQixNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNyRixNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUN4RixDQUFDO0lBQ0YsTUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQztJQUNqQyxNQUFNLFdBQVcsR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDO0lBQzdDLE1BQU0sUUFBUSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztJQUN6QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDN0MsUUFBUSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQUUsV0FBVyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDckUsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDaEQsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG5pbXBvcnQgeyBBc3NldCwgVmlydHVhbEFzc2V0LCBxdWVyeVBhdGgsIHF1ZXJ5VVVJRCwgcXVlcnlBc3NldCB9IGZyb20gJ0Bjb2Nvcy9hc3NldC1kYic7XHJcbmltcG9ydCAqIGFzIGNjIGZyb20gJ2NjJztcclxuXHJcbmltcG9ydCB7IEFzc2V0SGFuZGxlciB9IGZyb20gJy4uLy4uL0B0eXBlcy9wcm90ZWN0ZWQnO1xyXG5pbXBvcnQgeyBTcHJpdGVGcmFtZUJhc2VBc3NldFVzZXJEYXRhLCBTcHJpdGVGcmFtZUFzc2V0VXNlckRhdGEgfSBmcm9tICcuLi8uLi9AdHlwZXMvdXNlckRhdGFzJztcclxuaW1wb3J0IHsgZ2V0VHJpbVJlY3QsIGdldERlcGVuZFVVSURMaXN0IH0gZnJvbSAnLi4vdXRpbHMnO1xyXG5pbXBvcnQgeyBkZWZhdWx0SWNvbkNvbmZpZyB9IGZyb20gJy4vaW1hZ2UvdXRpbHMnO1xyXG5pbXBvcnQgaTE4biBmcm9tICcuLi8uLi8uLi9iYXNlL2kxOG4nO1xyXG5cclxudHJ5IHtcclxuICAgIHJlcXVpcmUoJ3NoYXJwJyk7XHJcbn0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcclxuICAgIGNvbnNvbGUuZXJyb3IoaTE4bi50KCdpbXBvcnRlci5zaGFycF9lcnJvcicpKTtcclxufVxyXG5cclxuY29uc3QgU2hhcnAgPSByZXF1aXJlKCdzaGFycCcpO1xyXG5cclxuU2hhcnAuY2FjaGUoZmFsc2UpO1xyXG5cclxuZXhwb3J0IGNvbnN0IFNwcml0ZUZyYW1lSGFuZGxlcjogQXNzZXRIYW5kbGVyID0ge1xyXG4gICAgLy8gSGFuZGxlciDnmoTlkI3lrZfvvIznlKjkuo7mjIflrpogSGFuZGxlciBhcyDnrYlcclxuICAgIG5hbWU6ICdzcHJpdGUtZnJhbWUnLFxyXG5cclxuICAgIGFzc2V0VHlwZTogJ2NjLlNwcml0ZUZyYW1lJyxcclxuICAgIGljb25JbmZvOiB7XHJcbiAgICAgICAgZGVmYXVsdDogZGVmYXVsdEljb25Db25maWcsXHJcbiAgICAgICAgYXN5bmMgZ2VuZXJhdGVUaHVtYm5haWwoYXNzZXQ6IEFzc2V0KSB7XHJcbiAgICAgICAgICAgIGxldCBwYXJlbnRBc3NldCA9IHF1ZXJ5QXNzZXQoYXNzZXQubWV0YS51c2VyRGF0YS5pbWFnZVV1aWRPckRhdGFiYXNlVXJpKSBhcyBBc3NldDtcclxuICAgICAgICAgICAgaWYgKHBhcmVudEFzc2V0Lm1ldGEuaW1wb3J0ZXIgIT09ICdpbWFnZScpIHtcclxuICAgICAgICAgICAgICAgIHBhcmVudEFzc2V0ID0gcGFyZW50QXNzZXQucGFyZW50IGFzIEFzc2V0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChwYXJlbnRBc3NldC5pbnZhbGlkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdEljb25Db25maWc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgZXh0bmFtZSA9IHBhcmVudEFzc2V0Lm1ldGEuZmlsZXMuZmluZCgoZXh0TmFtZSkgPT4gZXh0TmFtZSAhPT0gJy5qc29uJykgfHwgJy5wbmcnO1xyXG4gICAgICAgICAgICBjb25zdCBpbWFnZVBhdGggPSBwYXJlbnRBc3NldC5saWJyYXJ5ICsgZXh0bmFtZTtcclxuICAgICAgICAgICAgY29uc3QgZGVzdCA9IGFzc2V0LmxpYnJhcnkgKyAnX3Nwcml0ZV90cmltXycgKyBleHRuYW1lO1xyXG4gICAgICAgICAgICBjb25zdCB1c2VyRGF0YSA9IGFzc2V0LnVzZXJEYXRhIGFzIFNwcml0ZUZyYW1lQmFzZUFzc2V0VXNlckRhdGE7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCB0cmltSW1hZ2UoaW1hZ2VQYXRoLCBkZXN0LCB1c2VyRGF0YSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYHRyaW0gaW1hZ2Uge2ZpbGUoJHtpbWFnZVBhdGh9KX0gdG8gZ2VuZXJhdGUgdGh1bWJuYWlsIGZhaWxlZH5gKTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihlcnJvcik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdEljb25Db25maWc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIHR5cGU6ICdpbWFnZScsXHJcbiAgICAgICAgICAgICAgICB2YWx1ZTogZGVzdCxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9LFxyXG4gICAgfSxcclxuXHJcbiAgICB1c2VyRGF0YUNvbmZpZzoge1xyXG4gICAgICAgIGRlZmF1bHQ6IHtcclxuICAgICAgICAgICAgdHJpbVR5cGU6IHtcclxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6ICdhdXRvJyxcclxuICAgICAgICAgICAgICAgIGxhYmVsOiAnaTE4bjpFTkdJTkUuYXNzZXRzLnNwcml0ZUZyYW1lLnRyaW1UeXBlJyxcclxuICAgICAgICAgICAgICAgIHJlbmRlcjoge1xyXG4gICAgICAgICAgICAgICAgICAgIHVpOiAndWktc2VsZWN0JyxcclxuICAgICAgICAgICAgICAgICAgICBpdGVtczogW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogJ2F1dG8nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICdhdXRvJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6ICdjdXN0b20nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICdjdXN0b20nLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogJ25vbmUnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICdub25lJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBdLFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgfSxcclxuICAgIGltcG9ydGVyOiB7XHJcbiAgICAgICAgLy8g54mI5pys5Y+35aaC5p6c5Y+Y5pu077yM5YiZ5Lya5by65Yi26YeN5paw5a+85YWlXHJcbiAgICAgICAgdmVyc2lvbjogJzEuMC4xMicsXHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOWunumZheWvvOWFpea1geeoi1xyXG4gICAgICAgICAqIOmcgOimgeiHquW3seaOp+WItuaYr+WQpueUn+aIkOOAgeaLt+i0neaWh+S7tlxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICog6L+U5Zue5piv5ZCm5a+85YWl5oiQ5Yqf55qE5qCH6K6wXHJcbiAgICAgICAgICog5aaC5p6c6L+U5ZueIGZhbHNl77yM5YiZIGltcG9ydGVkIOagh+iusOS4jeS8muWPmOaIkCB0cnVlXHJcbiAgICAgICAgICog5ZCO57ut55qE5LiA57O75YiX5pON5L2c6YO95LiN5Lya5omn6KGMXHJcbiAgICAgICAgICogQHBhcmFtIGFzc2V0XHJcbiAgICAgICAgICovXHJcbiAgICAgICAgYXN5bmMgaW1wb3J0KGFzc2V0OiBBc3NldCkge1xyXG4gICAgICAgICAgICAvLyDlpoLmnpzmsqHmnInnlJ/miJAganNvbiDmlofku7bvvIzliJnph43mlrDnlJ/miJBcclxuICAgICAgICAgICAgaWYgKCFhc3NldC5wYXJlbnQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGFzc2V0LnBhcmVudC5tZXRhLmltcG9ydGVyID09PSAnaW1hZ2UnKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB1c2VyRGF0YSA9IGFzc2V0LnVzZXJEYXRhIGFzIFNwcml0ZUZyYW1lQmFzZUFzc2V0VXNlckRhdGE7XHJcbiAgICAgICAgICAgICAgICBsZXQgZmlsZTtcclxuICAgICAgICAgICAgICAgIC8vIFRPRE8g5q2k5aSE6ZyA6KaB5pu05o2i6YCa55So5YaZ5rOV77yM6L+Z5qC35a655piT5ryP5o6J5LiA5Lqb5paw5qC85byP5pSv5oyB55qE5pu05pawXHJcbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICBpZiAoWycudGdhJywgJy5oZHInLCAnLmJtcCcsICcuZXhyJywgJy56bnQnLCAnLnBzZCddLmluY2x1ZGVzKGFzc2V0LnBhcmVudC5leHRuYW1lLnRvTG93ZXJDYXNlKCkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZmlsZSA9IGFzc2V0LnBhcmVudC5saWJyYXJ5ICsgJy5wbmcnO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBmaWxlID0gYXNzZXQucGFyZW50LnNvdXJjZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNvbnN0IE1JTl9TSVpFID0gMTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGltYWdlRGF0YSA9IGF3YWl0IFNoYXJwKGZpbGUpLnJhdygpLnRvQnVmZmVyKHsgcmVzb2x2ZVdpdGhPYmplY3Q6IHRydWUgfSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWltYWdlRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICh1c2VyRGF0YS50cmltVGhyZXNob2xkID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB1c2VyRGF0YS50cmltVGhyZXNob2xkID0gMTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB1c2VyRGF0YS5yb3RhdGVkID0gISF1c2VyRGF0YS5yb3RhdGVkO1xyXG4gICAgICAgICAgICAgICAgdXNlckRhdGEucGFja2FibGUgPSB1c2VyRGF0YS5wYWNrYWJsZSA9PT0gdW5kZWZpbmVkID8gdHJ1ZSA6IHVzZXJEYXRhLnBhY2thYmxlO1xyXG4gICAgICAgICAgICAgICAgdXNlckRhdGEucmF3SGVpZ2h0ID0gaW1hZ2VEYXRhLmluZm8uaGVpZ2h0O1xyXG4gICAgICAgICAgICAgICAgdXNlckRhdGEucmF3V2lkdGggPSBpbWFnZURhdGEuaW5mby53aWR0aDtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodXNlckRhdGEudHJpbVR5cGUgPT09ICdhdXRvJykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpbWFnZURhdGEuaW5mby5jaGFubmVscyAhPT0gNCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VyRGF0YS53aWR0aCA9IGltYWdlRGF0YS5pbmZvLndpZHRoO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VyRGF0YS5oZWlnaHQgPSBpbWFnZURhdGEuaW5mby5oZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJEYXRhLnRyaW1YID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlckRhdGEudHJpbVkgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY3QgPSBnZXRUcmltUmVjdChcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIEJ1ZmZlci5mcm9tKGltYWdlRGF0YS5kYXRhKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJEYXRhLnJhd1dpZHRoLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlckRhdGEucmF3SGVpZ2h0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlckRhdGEudHJpbVRocmVzaG9sZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlckRhdGEud2lkdGggPSBNYXRoLm1heChyZWN0WzJdLCBNSU5fU0laRSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJEYXRhLmhlaWdodCA9IE1hdGgubWF4KHJlY3RbM10sIE1JTl9TSVpFKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlckRhdGEudHJpbVggPSBjYy5jbGFtcChyZWN0WzBdLCAwLCB1c2VyRGF0YS5yYXdXaWR0aCAtIHVzZXJEYXRhLndpZHRoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlckRhdGEudHJpbVkgPSBjYy5jbGFtcChyZWN0WzFdLCAwLCB1c2VyRGF0YS5yYXdIZWlnaHQgLSB1c2VyRGF0YS5oZWlnaHQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodXNlckRhdGEudHJpbVR5cGUgPT09ICdub25lJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHVzZXJEYXRhLnRyaW1YID0gMDtcclxuICAgICAgICAgICAgICAgICAgICB1c2VyRGF0YS50cmltWSA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgdXNlckRhdGEud2lkdGggPSBpbWFnZURhdGEuaW5mby53aWR0aDtcclxuICAgICAgICAgICAgICAgICAgICB1c2VyRGF0YS5oZWlnaHQgPSBpbWFnZURhdGEuaW5mby5oZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHVzZXJEYXRhLnRyaW1YID0gY2MuY2xhbXAodXNlckRhdGEudHJpbVgsIDAsIHVzZXJEYXRhLnJhd1dpZHRoIC0gTUlOX1NJWkUpO1xyXG4gICAgICAgICAgICAgICAgICAgIHVzZXJEYXRhLnRyaW1ZID0gY2MuY2xhbXAodXNlckRhdGEudHJpbVksIDAsIHVzZXJEYXRhLnJhd0hlaWdodCAtIE1JTl9TSVpFKTtcclxuICAgICAgICAgICAgICAgICAgICB1c2VyRGF0YS53aWR0aCA9IGNjLmNsYW1wKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VyRGF0YS53aWR0aCA9PT0gLTEgPyB1c2VyRGF0YS5yYXdXaWR0aCA6IHVzZXJEYXRhLndpZHRoLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBNSU5fU0laRSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlckRhdGEucmF3V2lkdGggLSB1c2VyRGF0YS50cmltWCxcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIHVzZXJEYXRhLmhlaWdodCA9IGNjLmNsYW1wKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VyRGF0YS5oZWlnaHQgPT09IC0xID8gdXNlckRhdGEucmF3SGVpZ2h0IDogdXNlckRhdGEuaGVpZ2h0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBNSU5fU0laRSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlckRhdGEucmF3SGVpZ2h0IC0gdXNlckRhdGEudHJpbVksXHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICB1c2VyRGF0YS5vZmZzZXRYID0gdXNlckRhdGEudHJpbVggKyB1c2VyRGF0YS53aWR0aCAvIDIgLSB1c2VyRGF0YS5yYXdXaWR0aCAvIDI7XHJcbiAgICAgICAgICAgICAgICB1c2VyRGF0YS5vZmZzZXRZID0gLSh1c2VyRGF0YS50cmltWSArIHVzZXJEYXRhLmhlaWdodCAvIDIgLSB1c2VyRGF0YS5yYXdIZWlnaHQgLyAyKTtcclxuXHJcbiAgICAgICAgICAgICAgICB1c2VyRGF0YS5ib3JkZXJMZWZ0ID0gY2MuY2xhbXAodXNlckRhdGEuYm9yZGVyTGVmdCwgMCwgdXNlckRhdGEud2lkdGgpO1xyXG4gICAgICAgICAgICAgICAgdXNlckRhdGEuYm9yZGVyUmlnaHQgPSBjYy5jbGFtcCh1c2VyRGF0YS5ib3JkZXJSaWdodCwgMCwgdXNlckRhdGEud2lkdGggLSB1c2VyRGF0YS5ib3JkZXJMZWZ0KTtcclxuICAgICAgICAgICAgICAgIHVzZXJEYXRhLmJvcmRlclRvcCA9IGNjLmNsYW1wKHVzZXJEYXRhLmJvcmRlclRvcCwgMCwgdXNlckRhdGEuaGVpZ2h0KTtcclxuICAgICAgICAgICAgICAgIHVzZXJEYXRhLmJvcmRlckJvdHRvbSA9IGNjLmNsYW1wKHVzZXJEYXRhLmJvcmRlckJvdHRvbSwgMCwgdXNlckRhdGEuaGVpZ2h0IC0gdXNlckRhdGEuYm9yZGVyVG9wKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyB1c2VyRGF0YS5waXhlbHNUb1VuaXQgPSAxMDA7XHJcbiAgICAgICAgICAgICAgICAvLyB1c2VyRGF0YS5waXZvdFggPSAwLjU7XHJcbiAgICAgICAgICAgICAgICAvLyB1c2VyRGF0YS5waXZvdFkgPSAwLjU7XHJcbiAgICAgICAgICAgICAgICAvLyB1c2VyRGF0YS5tZXNoVHlwZSA9IDA7XHJcbiAgICAgICAgICAgICAgICBpbml0VmVydGljZXNEYXRhKHVzZXJEYXRhKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gdXNlckRhdGEudmVydGljZXMgPSB1bmRlZmluZWQ7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBzcHJpdGVGcmFtZSA9IGNyZWF0ZVNwcml0ZUZyYW1lKGFzc2V0KTtcclxuICAgICAgICAgICAgaWYgKGFzc2V0LnBhcmVudCBpbnN0YW5jZW9mIEFzc2V0KSB7XHJcbiAgICAgICAgICAgICAgICBzcHJpdGVGcmFtZS5uYW1lID0gc3ByaXRlRnJhbWUubmFtZSB8fCBhc3NldC5wYXJlbnQuYmFzZW5hbWUgfHwgJyc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZ2V0VGV4dHVyZShhc3NldCwgc3ByaXRlRnJhbWUpO1xyXG5cclxuICAgICAgICAgICAgY29uc3Qgc2VyaWFsaXplSlNPTiA9IEVkaXRvckV4dGVuZHMuc2VyaWFsaXplKHNwcml0ZUZyYW1lKTtcclxuICAgICAgICAgICAgYXdhaXQgYXNzZXQuc2F2ZVRvTGlicmFyeSgnLmpzb24nLCBzZXJpYWxpemVKU09OKTtcclxuXHJcbiAgICAgICAgICAgIC8vIHBsaXN0IOaWh+S7tuS4i+WvvOWFpeeahCBzcHJpdGUg5bqP5YiX5YyW5L+h5oGv5Lya6K6w5b2V54i26LWE5rqQIHV1aWQg5L2G5Zyo5L6d6LWW5YWz57O75LiK5bm25LiN5L6d6LWW77yM6ZyA6KaB6LWw5Y+N5bqP5YiX5YyW6I635Y+W5a+555qE5L6d6LWW5YWz57O7XHJcbiAgICAgICAgICAgIGNvbnN0IGRlcGVuZHMgPSBnZXREZXBlbmRVVUlETGlzdChKU09OLnBhcnNlKHNlcmlhbGl6ZUpTT04pKTtcclxuICAgICAgICAgICAgYXNzZXQuc2V0RGF0YSgnZGVwZW5kcycsIGRlcGVuZHMpO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSxcclxuICAgIH0sXHJcbn07XHJcbmV4cG9ydCBkZWZhdWx0IFNwcml0ZUZyYW1lSGFuZGxlcjtcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgVHJpbU9wdGlvbnMge1xyXG4gICAgd2lkdGg6IG51bWJlcjtcclxuICAgIGhlaWdodDogbnVtYmVyO1xyXG4gICAgdHJpbVg6IG51bWJlcjtcclxuICAgIHRyaW1ZOiBudW1iZXI7XHJcbiAgICByb3RhdGVkOiBib29sZWFuO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdHJpbUltYWdlKHNvdXJjZTogc3RyaW5nLCBkZXN0OiBzdHJpbmcsIG9wdGlvbnM6IFRyaW1PcHRpb25zKSB7XHJcbiAgICBjb25zdCBpbWFnZSA9IFNoYXJwKHNvdXJjZSkuZXh0cmFjdCh7XHJcbiAgICAgICAgbGVmdDogb3B0aW9ucy50cmltWCxcclxuICAgICAgICB0b3A6IG9wdGlvbnMudHJpbVksXHJcbiAgICAgICAgd2lkdGg6IG9wdGlvbnMucm90YXRlZCA/IG9wdGlvbnMuaGVpZ2h0IDogb3B0aW9ucy53aWR0aCxcclxuICAgICAgICBoZWlnaHQ6IG9wdGlvbnMucm90YXRlZCA/IG9wdGlvbnMud2lkdGggOiBvcHRpb25zLmhlaWdodCxcclxuICAgIH0pO1xyXG4gICAgaWYgKG9wdGlvbnMucm90YXRlZCkge1xyXG4gICAgICAgIGltYWdlLnJvdGF0ZSgyNzApO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGF3YWl0IGltYWdlLnRvRmlsZShkZXN0KTtcclxufVxyXG5cclxuZnVuY3Rpb24gY3JlYXRlU3ByaXRlRnJhbWUoYXNzZXQ6IEFzc2V0KSB7XHJcbiAgICBjb25zdCB1c2VyRGF0YSA9IGFzc2V0LnVzZXJEYXRhO1xyXG4gICAgY29uc3Qgc3ByaXRlID0gbmV3IGNjLlNwcml0ZUZyYW1lKCk7XHJcbiAgICBzcHJpdGUubmFtZSA9IGFzc2V0LmRpc3BsYXlOYW1lID8gYXNzZXQuZGlzcGxheU5hbWUgOiBhc3NldC5fbmFtZTtcclxuICAgIHNwcml0ZS5hdGxhc1V1aWQgPSB1c2VyRGF0YS5hdGxhc1V1aWQ7XHJcbiAgICAvLyBAdHMtaWdub3JlXHJcbiAgICBzcHJpdGUuX3JlY3QgPSBjYy5yZWN0KHVzZXJEYXRhLnRyaW1YLCB1c2VyRGF0YS50cmltWSwgdXNlckRhdGEud2lkdGgsIHVzZXJEYXRhLmhlaWdodCk7XHJcblxyXG4gICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgc3ByaXRlLl9vcmlnaW5hbFNpemUgPSBjYy5zaXplKHVzZXJEYXRhLnJhd1dpZHRoLCB1c2VyRGF0YS5yYXdIZWlnaHQpO1xyXG4gICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgc3ByaXRlLl9vZmZzZXQgPSBjYy52Mih1c2VyRGF0YS5vZmZzZXRYLCB1c2VyRGF0YS5vZmZzZXRZKTtcclxuICAgIC8vIEB0cy1pZ25vcmVcclxuICAgIHNwcml0ZS5fY2FwSW5zZXRzID0gW3VzZXJEYXRhLmJvcmRlckxlZnQsIHVzZXJEYXRhLmJvcmRlclRvcCwgdXNlckRhdGEuYm9yZGVyUmlnaHQsIHVzZXJEYXRhLmJvcmRlckJvdHRvbV07XHJcbiAgICAvLyBAdHMtaWdub3JlXHJcbiAgICBzcHJpdGUuX3JvdGF0ZWQgPSB1c2VyRGF0YS5yb3RhdGVkO1xyXG4gICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgc3ByaXRlLl9wYWNrYWJsZSA9IHVzZXJEYXRhLnBhY2thYmxlO1xyXG4gICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgc3ByaXRlLl9waXhlbHNUb1VuaXQgPSB1c2VyRGF0YS5waXhlbHNUb1VuaXQ7XHJcbiAgICAvLyBAdHMtaWdub3JlXHJcbiAgICBzcHJpdGUuX3Bpdm90ID0gY2MudjIodXNlckRhdGEucGl2b3RYLCB1c2VyRGF0YS5waXZvdFkpO1xyXG4gICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgc3ByaXRlLl9tZXNoVHlwZSA9IHVzZXJEYXRhLm1lc2hUeXBlO1xyXG4gICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgaW5pdFZlcnRpY2VzKHNwcml0ZSwgdXNlckRhdGEpO1xyXG4gICAgcmV0dXJuIHNwcml0ZTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0VGV4dHVyZShhc3NldDogVmlydHVhbEFzc2V0LCBzcHJpdGVGcmFtZTogY2MuU3ByaXRlRnJhbWUpIHtcclxuICAgIGNvbnN0IHVzZXJEYXRhID0gYXNzZXQudXNlckRhdGEgYXMgU3ByaXRlRnJhbWVBc3NldFVzZXJEYXRhO1xyXG4gICAgLy8gR2V0IFRleHR1cmVcclxuICAgIGNvbnN0IGltYWdlVXVpZE9yRGF0YWJhc2VVcmkgPSB1c2VyRGF0YS5pbWFnZVV1aWRPckRhdGFiYXNlVXJpO1xyXG4gICAgaWYgKCFpbWFnZVV1aWRPckRhdGFiYXNlVXJpKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBsZXQgaW1hZ2VVdWlkOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcclxuICAgICAgICBpZiAodXNlckRhdGEuaXNVdWlkKSB7XHJcbiAgICAgICAgICAgIGltYWdlVXVpZCA9IGltYWdlVXVpZE9yRGF0YWJhc2VVcmk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaW1hZ2VVdWlkID0gcXVlcnlVVUlEKGltYWdlVXVpZE9yRGF0YWJhc2VVcmkpO1xyXG4gICAgICAgICAgICBpZiAoIWltYWdlVXVpZCkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGBDYW5ub3QgZmluZCBpbWFnZSAke3F1ZXJ5UGF0aChpbWFnZVV1aWRPckRhdGFiYXNlVXJpKSB8fCAnJ30uYCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGltYWdlVXVpZCAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgIHNwcml0ZUZyYW1lLl90ZXh0dXJlID0gRWRpdG9yRXh0ZW5kcy5zZXJpYWxpemUuYXNBc3NldChpbWFnZVV1aWQsIGNjLlRleHR1cmUyRCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBpbml0VmVydGljZXNEYXRhKHVzZXJEYXRhOiBTcHJpdGVGcmFtZUJhc2VBc3NldFVzZXJEYXRhKSB7XHJcbiAgICBpZiAodXNlckRhdGEudmVydGljZXMgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIHVzZXJEYXRhLnZlcnRpY2VzID0ge1xyXG4gICAgICAgICAgICByYXdQb3NpdGlvbjogW10sXHJcbiAgICAgICAgICAgIGluZGV4ZXM6IFtdLFxyXG4gICAgICAgICAgICB1djogW10sXHJcbiAgICAgICAgICAgIG51djogW10sXHJcbiAgICAgICAgICAgIG1pblBvczogW10sXHJcbiAgICAgICAgICAgIG1heFBvczogW10sXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIGNvbnN0IHZlcnRpY2VzID0gdXNlckRhdGEudmVydGljZXM7XHJcbiAgICB2ZXJ0aWNlcy5yYXdQb3NpdGlvbi5sZW5ndGggPSAwO1xyXG5cclxuICAgIGlmICh1c2VyRGF0YS5tZXNoVHlwZSA9PT0gY2MuU3ByaXRlRnJhbWUuTWVzaFR5cGUuUE9MWUdPTikge1xyXG4gICAgICAgIC8vIOS9v+eUqCBCYXlheml0IOadpeeUn+aIkOmhtueCueW5tui1i+WAvFxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCB3aWR0aCA9IHVzZXJEYXRhLndpZHRoO1xyXG4gICAgICAgIGNvbnN0IGhlaWdodCA9IHVzZXJEYXRhLmhlaWdodDtcclxuICAgICAgICBjb25zdCBoYWxmV2lkdGggPSB3aWR0aCAvIDI7XHJcbiAgICAgICAgY29uc3QgaGFsZkhlaWdodCA9IGhlaWdodCAvIDI7XHJcbiAgICAgICAgY29uc3QgdGV4dyA9IHVzZXJEYXRhLnJhd1dpZHRoO1xyXG4gICAgICAgIGNvbnN0IHRleGggPSB1c2VyRGF0YS5yYXdIZWlnaHQ7XHJcbiAgICAgICAgY29uc3QgcmVjdFggPSB1c2VyRGF0YS50cmltWDtcclxuICAgICAgICBjb25zdCByZWN0WSA9IHRleGggLSB1c2VyRGF0YS50cmltWSAtIGhlaWdodDtcclxuICAgICAgICBjb25zdCBsID0gdGV4dyA9PT0gMCA/IDAgOiByZWN0WCAvIHRleHc7XHJcbiAgICAgICAgY29uc3QgciA9IHRleHcgPT09IDAgPyAxIDogKHJlY3RYICsgd2lkdGgpIC8gdGV4dztcclxuICAgICAgICBjb25zdCB0ID0gdGV4aCA9PT0gMCA/IDEgOiAocmVjdFkgKyBoZWlnaHQpIC8gdGV4aDtcclxuICAgICAgICBjb25zdCBiID0gdGV4aCA9PT0gMCA/IDAgOiByZWN0WSAvIHRleGg7XHJcbiAgICAgICAgdmVydGljZXMucmF3UG9zaXRpb24gPSBbLWhhbGZXaWR0aCwgLWhhbGZIZWlnaHQsIDAsIGhhbGZXaWR0aCwgLWhhbGZIZWlnaHQsIDAsIC1oYWxmV2lkdGgsIGhhbGZIZWlnaHQsIDAsIGhhbGZXaWR0aCwgaGFsZkhlaWdodCwgMF07XHJcbiAgICAgICAgdmVydGljZXMudXYgPSBbcmVjdFgsIHJlY3RZICsgaGVpZ2h0LCByZWN0WCArIHdpZHRoLCByZWN0WSArIGhlaWdodCwgcmVjdFgsIHJlY3RZLCByZWN0WCArIHdpZHRoLCByZWN0WV07XHJcbiAgICAgICAgdmVydGljZXMubnV2ID0gW2wsIGIsIHIsIGIsIGwsIHQsIHIsIHRdO1xyXG4gICAgICAgIHZlcnRpY2VzLmluZGV4ZXMgPSBbMCwgMSwgMiwgMiwgMSwgM107XHJcbiAgICAgICAgdmVydGljZXMubWluUG9zID0gWy1oYWxmV2lkdGgsIC1oYWxmSGVpZ2h0LCAwXTtcclxuICAgICAgICB2ZXJ0aWNlcy5tYXhQb3MgPSBbaGFsZldpZHRoLCBoYWxmSGVpZ2h0LCAwXTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaW5pdFZlcnRpY2VzKHNwcml0ZTogY2MuU3ByaXRlRnJhbWUsIHVzZXJEYXRhOiBTcHJpdGVGcmFtZUJhc2VBc3NldFVzZXJEYXRhKSB7XHJcbiAgICBjb25zdCB1c2VyVmVydGljZXMgPSB1c2VyRGF0YS52ZXJ0aWNlcztcclxuICAgIHNwcml0ZS52ZXJ0aWNlcyA9IHtcclxuICAgICAgICByYXdQb3NpdGlvbjogW10sXHJcbiAgICAgICAgcG9zaXRpb25zOiBbXSxcclxuICAgICAgICBpbmRleGVzOiB1c2VyVmVydGljZXMuaW5kZXhlcyxcclxuICAgICAgICB1djogdXNlclZlcnRpY2VzLnV2LFxyXG4gICAgICAgIG51djogdXNlclZlcnRpY2VzLm51dixcclxuICAgICAgICBtaW5Qb3M6IGNjLnYzKHVzZXJWZXJ0aWNlcy5taW5Qb3NbMF0sIHVzZXJWZXJ0aWNlcy5taW5Qb3NbMV0sIHVzZXJWZXJ0aWNlcy5taW5Qb3NbMl0pLFxyXG4gICAgICAgIG1heFBvczogY2MudjModXNlclZlcnRpY2VzLm1heFBvc1swXSwgdXNlclZlcnRpY2VzLm1heFBvc1sxXSwgdXNlclZlcnRpY2VzLm1heFBvc1syXSksXHJcbiAgICB9O1xyXG4gICAgY29uc3QgdmVydGljZXMgPSBzcHJpdGUudmVydGljZXM7XHJcbiAgICBjb25zdCByYXdQb3NpdGlvbiA9IHVzZXJWZXJ0aWNlcy5yYXdQb3NpdGlvbjtcclxuICAgIGNvbnN0IHRlbXBWZWMzID0gY2MudjMoKTtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmF3UG9zaXRpb24ubGVuZ3RoOyBpICs9IDMpIHtcclxuICAgICAgICB0ZW1wVmVjMy5zZXQocmF3UG9zaXRpb25baV0sIHJhd1Bvc2l0aW9uW2kgKyAxXSwgcmF3UG9zaXRpb25baSArIDJdKTtcclxuICAgICAgICB2ZXJ0aWNlcy5yYXdQb3NpdGlvbi5wdXNoKHRlbXBWZWMzLmNsb25lKCkpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==