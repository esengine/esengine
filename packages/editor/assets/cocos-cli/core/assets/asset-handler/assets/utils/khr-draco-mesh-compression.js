"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.decodeDracoGeometry = decodeDracoGeometry;
const draco3dgltf_1 = __importDefault(require("draco3dgltf"));
const decoderModule = draco3dgltf_1.default.createDecoderModule({});
function decodeDracoGeometry(options) {
    const decoder = new decoderModule.Decoder();
    const decoded = decodeDracoData(options.buffer, decoder, options);
    decoderModule.destroy(decoder);
    return decoded;
}
function decodeDracoData(buffer, decoder, options) {
    const decoderBuffer = new decoderModule.DecoderBuffer();
    decoderBuffer.Init(new Int8Array(buffer), buffer.byteLength);
    const geometryType = decoder.GetEncodedGeometryType(decoderBuffer);
    let dracoGeometry;
    let decodingStatus;
    switch (geometryType) {
        case decoderModule.TRIANGULAR_MESH:
            dracoGeometry = new decoderModule.Mesh();
            decodingStatus = decoder.DecodeBufferToMesh(decoderBuffer, dracoGeometry);
            break;
        case decoderModule.POINT_CLOUD:
            dracoGeometry = new decoderModule.PointCloud();
            decodingStatus = decoder.DecodeBufferToPointCloud(decoderBuffer, dracoGeometry);
            break;
        default:
            throw new Error(`Unknown geometry type ${geometryType}.`);
    }
    if (!decodingStatus.ok() || dracoGeometry.ptr === 0) {
        throw new Error(`Decoding failed: ${decodingStatus.error_msg()}`);
    }
    const vertices = decodeAttributes(dracoGeometry, decoder, options);
    const decoded = {
        vertices,
    };
    if (geometryType === decoderModule.TRIANGULAR_MESH && options.indices) {
        const indices = decodeIndices(dracoGeometry, decoder, options.indices);
        decoded.indices = indices;
    }
    decoderModule.destroy(dracoGeometry);
    decoderModule.destroy(decoderBuffer);
    return decoded;
}
function decodeAttributes(dracoGeometry, decoder, options) {
    const nVertices = dracoGeometry.num_points();
    const vertices = {};
    for (const attributeName of Object.keys(options.attributes)) {
        const { uniqueId, storageConstructor: attributeDataArrayConstructor, components: nComponentsPerAttribute, } = options.attributes[attributeName];
        const nValues = nComponentsPerAttribute * nVertices;
        const attribute = decoder.GetAttributeByUniqueId(dracoGeometry, uniqueId);
        const nActualComponentsPerAttribute = attribute.num_components();
        if (nActualComponentsPerAttribute !== nComponentsPerAttribute) {
            throw new Error(`Decompression error: components-per-attribute of ${attributeName} mismatch.`);
        }
        let attributeData;
        switch (attributeDataArrayConstructor) {
            case Float32Array:
                attributeData = new decoderModule.DracoFloat32Array();
                decoder.GetAttributeFloatForAllPoints(dracoGeometry, attribute, attributeData);
                break;
            case Int8Array:
                attributeData = new decoderModule.DracoInt8Array();
                decoder.GetAttributeInt8ForAllPoints(dracoGeometry, attribute, attributeData);
                break;
            case Int16Array:
                attributeData = new decoderModule.DracoInt16Array();
                decoder.GetAttributeInt16ForAllPoints(dracoGeometry, attribute, attributeData);
                break;
            case Int32Array:
                attributeData = new decoderModule.DracoInt32Array();
                decoder.GetAttributeInt32ForAllPoints(dracoGeometry, attribute, attributeData);
                break;
            case Uint8Array:
                attributeData = new decoderModule.DracoUInt8Array();
                decoder.GetAttributeUInt8ForAllPoints(dracoGeometry, attribute, attributeData);
                break;
            case Uint16Array:
                attributeData = new decoderModule.DracoUInt16Array();
                decoder.GetAttributeUInt16ForAllPoints(dracoGeometry, attribute, attributeData);
                break;
            case Uint32Array:
                attributeData = new decoderModule.DracoUInt32Array();
                decoder.GetAttributeUInt32ForAllPoints(dracoGeometry, attribute, attributeData);
                break;
            default:
                throw new Error('THREE.DRACOLoader: Unexpected attribute type.');
        }
        const attributeDataSize = attributeData.size();
        if (nValues !== attributeDataSize) {
            throw new Error(`Decompression error: ${attributeName} data size mismatch.`);
        }
        const attributeDataArray = new attributeDataArrayConstructor(nValues);
        for (let i = 0; i < nValues; ++i) {
            attributeDataArray[i] = attributeData.GetValue(i);
        }
        vertices[attributeName] = attributeDataArray;
        decoderModule.destroy(attributeData);
    }
    return vertices;
}
function decodeIndices(dracoMesh, decoder, indicesAccessor) {
    const nFaces = dracoMesh.num_faces();
    const nIndices = 3 * nFaces;
    const indicesConstructor = indicesAccessor;
    const indices = new indicesConstructor(nIndices);
    const dracoInt32Array = new decoderModule.DracoInt32Array();
    for (let iFace = 0; iFace < nFaces; ++iFace) {
        decoder.GetFaceFromMesh(dracoMesh, iFace, dracoInt32Array);
        const index = 3 * iFace;
        indices[index] = dracoInt32Array.GetValue(0);
        indices[index + 1] = dracoInt32Array.GetValue(1);
        indices[index + 2] = dracoInt32Array.GetValue(2);
    }
    decoderModule.destroy(dracoInt32Array);
    return indices;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2hyLWRyYWNvLW1lc2gtY29tcHJlc3Npb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9hc3NldHMvYXNzZXQtaGFuZGxlci9hc3NldHMvdXRpbHMva2hyLWRyYWNvLW1lc2gtY29tcHJlc3Npb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFvREEsa0RBS0M7QUF6REQsOERBQXVEO0FBa0R2RCxNQUFNLGFBQWEsR0FBRyxxQkFBUyxDQUFDLG1CQUFtQixDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBRXhELFNBQWdCLG1CQUFtQixDQUFDLE9BQW1DO0lBQ25FLE1BQU0sT0FBTyxHQUFHLElBQUksYUFBYSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQzVDLE1BQU0sT0FBTyxHQUFHLGVBQWUsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNsRSxhQUFhLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQy9CLE9BQU8sT0FBTyxDQUFDO0FBQ25CLENBQUM7QUFFRCxTQUFTLGVBQWUsQ0FBQyxNQUFpQixFQUFFLE9BQThCLEVBQUUsT0FBbUM7SUFDM0csTUFBTSxhQUFhLEdBQUcsSUFBSSxhQUFhLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDeEQsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRSxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDN0QsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLHNCQUFzQixDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ25FLElBQUksYUFBcUMsQ0FBQztJQUMxQyxJQUFJLGNBQW9DLENBQUM7SUFDekMsUUFBUSxZQUFZLEVBQUUsQ0FBQztRQUNuQixLQUFLLGFBQWEsQ0FBQyxlQUFlO1lBQzlCLGFBQWEsR0FBRyxJQUFJLGFBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUN6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QUssR0FBRyxDQUFDLENBQUMsR0FBRyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFDRCxhQUFhLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQ3ZDLE9BQU8sT0FBTyxDQUFDO0FBQ25CLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZHJhY29nbFRGLCB7IERlY29kZXJNb2R1bGUgfSBmcm9tICdkcmFjbzNkZ2x0Zic7XHJcblxyXG4vLyBSZWZlcmVuY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9tcmRvb2IvdGhyZWUuanMvYmxvYi9kZXYvZXhhbXBsZXMvanMvbG9hZGVycy9EUkFDT0xvYWRlci5qc1xyXG4vLyBSZWZlcmVuY2U6IHJlcXVpcmUoJ2RyYWNvM2RnbHRmJykvZHJhY29fbm9kZWpzX2V4YW1wbGUuanNcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgS0hSRHJhY29NZXNoQ29tcHJlc3Npb24ge1xyXG4gICAgYnVmZmVyVmlldzogbnVtYmVyO1xyXG4gICAgYXR0cmlidXRlczogUmVjb3JkPHN0cmluZywgbnVtYmVyPjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBEZWNvZGVkRHJhY29HZW9tZXRyeSB7XHJcbiAgICBpbmRpY2VzPzogRGVjb2RlZFN0b3JhZ2U7XHJcbiAgICB2ZXJ0aWNlczogUmVjb3JkPHN0cmluZywgRGVjb2RlZFN0b3JhZ2U+O1xyXG59XHJcblxyXG5leHBvcnQgdHlwZSBEZWNvZGVkU3RvcmFnZSA9IEludDhBcnJheSB8IEludDE2QXJyYXkgfCBJbnQzMkFycmF5IHwgVWludDhBcnJheSB8IFVpbnQxNkFycmF5IHwgVWludDMyQXJyYXkgfCBGbG9hdDMyQXJyYXk7XHJcblxyXG5leHBvcnQgdHlwZSBEZWNvZGVkU3RvcmFnZUNvbnN0cnVjdG9yID1cclxuICAgIHwgSW50OEFycmF5Q29uc3RydWN0b3JcclxuICAgIHwgSW50MTZBcnJheUNvbnN0cnVjdG9yXHJcbiAgICB8IEludDMyQXJyYXlDb25zdHJ1Y3RvclxyXG4gICAgfCBVaW50OEFycmF5Q29uc3RydWN0b3JcclxuICAgIHwgVWludDE2QXJyYXlDb25zdHJ1Y3RvclxyXG4gICAgfCBVaW50MzJBcnJheUNvbnN0cnVjdG9yXHJcbiAgICB8IEZsb2F0MzJBcnJheUNvbnN0cnVjdG9yO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBEZWNvZGVEcmFjb0dlb21ldHJ5T3B0aW9ucyB7XHJcbiAgICBidWZmZXI6IEludDhBcnJheTtcclxuICAgIGluZGljZXM/OiBEZWNvZGVkU3RvcmFnZUNvbnN0cnVjdG9yO1xyXG4gICAgYXR0cmlidXRlczogUmVjb3JkPFxyXG4gICAgICAgIHN0cmluZyxcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIC8qKlxyXG4gICAgICAgICAgICAgKiBVbmlxdWUgaWQgaW4gdGhlIGNvbXByZXNzZWQgZGF0YS5cclxuICAgICAgICAgICAgICovXHJcbiAgICAgICAgICAgIHVuaXF1ZUlkOiBudW1iZXI7XHJcblxyXG4gICAgICAgICAgICAvKipcclxuICAgICAgICAgICAgICogSXRzIGFzc29jaWF0ZWQgYWNjZXNzb3IuXHJcbiAgICAgICAgICAgICAqL1xyXG4gICAgICAgICAgICBzdG9yYWdlQ29uc3RydWN0b3I6IERlY29kZWRTdG9yYWdlQ29uc3RydWN0b3I7XHJcblxyXG4gICAgICAgICAgICAvKipcclxuICAgICAgICAgICAgICogSG93IG1hbnkgc3RvcmFnZSB1bml0cyBvbmUgYXR0cmlidXRlIG9jY3VwaWVzLlxyXG4gICAgICAgICAgICAgKi9cclxuICAgICAgICAgICAgY29tcG9uZW50czogbnVtYmVyO1xyXG4gICAgICAgIH1cclxuICAgID47XHJcbn1cclxuXHJcbmNvbnN0IGRlY29kZXJNb2R1bGUgPSBkcmFjb2dsVEYuY3JlYXRlRGVjb2Rlck1vZHVsZSh7fSk7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZGVjb2RlRHJhY29HZW9tZXRyeShvcHRpb25zOiBEZWNvZGVEcmFjb0dlb21ldHJ5T3B0aW9ucykge1xyXG4gICAgY29uc3QgZGVjb2RlciA9IG5ldyBkZWNvZGVyTW9kdWxlLkRlY29kZXIoKTtcclxuICAgIGNvbnN0IGRlY29kZWQgPSBkZWNvZGVEcmFjb0RhdGEob3B0aW9ucy5idWZmZXIsIGRlY29kZXIsIG9wdGlvbnMpO1xyXG4gICAgZGVjb2Rlck1vZHVsZS5kZXN0cm95KGRlY29kZXIpO1xyXG4gICAgcmV0dXJuIGRlY29kZWQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRlY29kZURyYWNvRGF0YShidWZmZXI6IEludDhBcnJheSwgZGVjb2RlcjogRGVjb2Rlck1vZHVsZS5EZWNvZGVyLCBvcHRpb25zOiBEZWNvZGVEcmFjb0dlb21ldHJ5T3B0aW9ucykge1xyXG4gICAgY29uc3QgZGVjb2RlckJ1ZmZlciA9IG5ldyBkZWNvZGVyTW9kdWxlLkRlY29kZXJCdWZmZXIoKTtcclxuICAgIGRlY29kZXJCdWZmZXIuSW5pdChuZXcgSW50OEFycmF5KGJ1ZmZlciksIGJ1ZmZlci5ieXRlTGVuZ3RoKTtcclxuICAgIGNvbnN0IGdlb21ldHJ5VHlwZSA9IGRlY29kZXIuR2V0RW5jb2RlZEdlb21ldHJ5VHlwZShkZWNvZGVyQnVmZmVyKTtcclxuICAgIGxldCBkcmFjb0dlb21ldHJ5OiBEZWNvZGVyTW9kdWxlLkdlb21ldHJ5O1xyXG4gICAgbGV0IGRlY29kaW5nU3RhdHVzOiBEZWNvZGVyTW9kdWxlLlN0YXR1cztcclxuICAgIHN3aXRjaCAoZ2VvbWV0cnlUeXBlKSB7XHJcbiAgICAgICAgY2FzZSBkZWNvZGVyTW9kdWxlLlRSSUFOR1VMQVJfTUVTSDpcclxuICAgICAgICAgICAgZHJhY29HZW9tZXRyeSA9IG5ldyBkZWNvZGVyTW9kdWxlLk1lc2goKTtcclxuICAgICAgICAgICAgZGVjb2RpbmdTdGF0dXMgPSBkZWNvZGVyLkRlY29kZUJ1ZmZlclRvTWVzaChkZWNvZGVyQnVmZmVyLCBkcmFjb0dlb21ldHJ5IGFzIERlY29kZXJNb2R1bGUuTWVzaCk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgZGVjb2Rlck1vZHVsZS5QT0lOVF9DTE9VRDpcclxuICAgICAgICAgICAgZHJhY29HZW9tZXRyeSA9IG5ldyBkZWNvZGVyTW9kdWxlLlBvaW50Q2xvdWQoKTtcclxuICAgICAgICAgICAgZGVjb2RpbmdTdGF0dXMgPSBkZWNvZGVyLkRlY29kZUJ1ZmZlclRvUG9pbnRDbG91ZChkZWNvZGVyQnVmZmVyLCBkcmFjb0dlb21ldHJ5KTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIGdlb21ldHJ5IHR5cGUgJHtnZW9tZXRyeVR5cGV9LmApO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghZGVjb2RpbmdTdGF0dXMub2soKSB8fCBkcmFjb0dlb21ldHJ5LnB0ciA9PT0gMCkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgRGVjb2RpbmcgZmFpbGVkOiAke2RlY29kaW5nU3RhdHVzLmVycm9yX21zZygpfWApO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHZlcnRpY2VzID0gZGVjb2RlQXR0cmlidXRlcyhkcmFjb0dlb21ldHJ5LCBkZWNvZGVyLCBvcHRpb25zKTtcclxuICAgIGNvbnN0IGRlY29kZWQ6IERlY29kZWREcmFjb0dlb21ldHJ5ID0ge1xyXG4gICAgICAgIHZlcnRpY2VzLFxyXG4gICAgfTtcclxuICAgIGlmIChnZW9tZXRyeVR5cGUgPT09IGRlY29kZXJNb2R1bGUuVFJJQU5HVUxBUl9NRVNIICYmIG9wdGlvbnMuaW5kaWNlcykge1xyXG4gICAgICAgIGNvbnN0IGluZGljZXMgPSBkZWNvZGVJbmRpY2VzKGRyYWNvR2VvbWV0cnkgYXMgRGVjb2Rlck1vZHVsZS5NZXNoLCBkZWNvZGVyLCBvcHRpb25zLmluZGljZXMpO1xyXG4gICAgICAgIGRlY29kZWQuaW5kaWNlcyA9IGluZGljZXM7XHJcbiAgICB9XHJcblxyXG4gICAgZGVjb2Rlck1vZHVsZS5kZXN0cm95KGRyYWNvR2VvbWV0cnkpO1xyXG4gICAgZGVjb2Rlck1vZHVsZS5kZXN0cm95KGRlY29kZXJCdWZmZXIpO1xyXG4gICAgcmV0dXJuIGRlY29kZWQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRlY29kZUF0dHJpYnV0ZXMoZHJhY29HZW9tZXRyeTogRGVjb2Rlck1vZHVsZS5HZW9tZXRyeSwgZGVjb2RlcjogRGVjb2Rlck1vZHVsZS5EZWNvZGVyLCBvcHRpb25zOiBEZWNvZGVEcmFjb0dlb21ldHJ5T3B0aW9ucykge1xyXG4gICAgY29uc3QgblZlcnRpY2VzID0gZHJhY29HZW9tZXRyeS5udW1fcG9pbnRzKCk7XHJcbiAgICBjb25zdCB2ZXJ0aWNlczogUmVjb3JkPHN0cmluZywgRGVjb2RlZFN0b3JhZ2U+ID0ge307XHJcbiAgICBmb3IgKGNvbnN0IGF0dHJpYnV0ZU5hbWUgb2YgT2JqZWN0LmtleXMob3B0aW9ucy5hdHRyaWJ1dGVzKSkge1xyXG4gICAgICAgIGNvbnN0IHtcclxuICAgICAgICAgICAgdW5pcXVlSWQsXHJcbiAgICAgICAgICAgIHN0b3JhZ2VDb25zdHJ1Y3RvcjogYXR0cmlidXRlRGF0YUFycmF5Q29uc3RydWN0b3IsXHJcbiAgICAgICAgICAgIGNvbXBvbmVudHM6IG5Db21wb25lbnRzUGVyQXR0cmlidXRlLFxyXG4gICAgICAgIH0gPSBvcHRpb25zLmF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV07XHJcbiAgICAgICAgY29uc3QgblZhbHVlcyA9IG5Db21wb25lbnRzUGVyQXR0cmlidXRlICogblZlcnRpY2VzO1xyXG5cclxuICAgICAgICBjb25zdCBhdHRyaWJ1dGUgPSBkZWNvZGVyLkdldEF0dHJpYnV0ZUJ5VW5pcXVlSWQoZHJhY29HZW9tZXRyeSwgdW5pcXVlSWQpO1xyXG4gICAgICAgIGNvbnN0IG5BY3R1YWxDb21wb25lbnRzUGVyQXR0cmlidXRlID0gYXR0cmlidXRlLm51bV9jb21wb25lbnRzKCk7XHJcbiAgICAgICAgaWYgKG5BY3R1YWxDb21wb25lbnRzUGVyQXR0cmlidXRlICE9PSBuQ29tcG9uZW50c1BlckF0dHJpYnV0ZSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYERlY29tcHJlc3Npb24gZXJyb3I6IGNvbXBvbmVudHMtcGVyLWF0dHJpYnV0ZSBvZiAke2F0dHJpYnV0ZU5hbWV9IG1pc21hdGNoLmApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IGF0dHJpYnV0ZURhdGE6XHJcbiAgICAgICAgICAgIHwgRGVjb2Rlck1vZHVsZS5EcmFjb0ludDhBcnJheVxyXG4gICAgICAgICAgICB8IERlY29kZXJNb2R1bGUuRHJhY29JbnQxNkFycmF5XHJcbiAgICAgICAgICAgIHwgRGVjb2Rlck1vZHVsZS5EcmFjb0ludDMyQXJyYXlcclxuICAgICAgICAgICAgfCBEZWNvZGVyTW9kdWxlLkRyYWNvVUludDhBcnJheVxyXG4gICAgICAgICAgICB8IERlY29kZXJNb2R1bGUuRHJhY29VSW50MTZBcnJheVxyXG4gICAgICAgICAgICB8IERlY29kZXJNb2R1bGUuRHJhY29VSW50MzJBcnJheVxyXG4gICAgICAgICAgICB8IERlY29kZXJNb2R1bGUuRHJhY29GbG9hdDMyQXJyYXk7XHJcbiAgICAgICAgc3dpdGNoIChhdHRyaWJ1dGVEYXRhQXJyYXlDb25zdHJ1Y3Rvcikge1xyXG4gICAgICAgICAgICBjYXNlIEZsb2F0MzJBcnJheTpcclxuICAgICAgICAgICAgICAgIGF0dHJpYnV0ZURhdGEgPSBuZXcgZGVjb2Rlck1vZHVsZS5EcmFjb0Zsb2F0MzJBcnJheSgpO1xyXG4gICAgICAgICAgICAgICAgZGVjb2Rlci5HZXRBdHRyaWJ1dGVGbG9hdEZvckFsbFBvaW50cyhkcmFjb0dlb21ldHJ5LCBhdHRyaWJ1dGUsIGF0dHJpYnV0ZURhdGEpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgSW50OEFycmF5OlxyXG4gICAgICAgICAgICAgICAgYXR0cmlidXRlRGF0YSA9IG5ldyBkZWNvZGVyTW9kdWxlLkRyYWNvSW50OEFycmF5KCk7XHJcbiAgICAgICAgICAgICAgICBkZWNvZGVyLkdldEF0dHJpYnV0ZUludDhGb3JBbGxQb2ludHMoZHJhY29HZW9tZXRyeSwgYXR0cmlidXRlLCBhdHRyaWJ1dGVEYXRhKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIEludDE2QXJyYXk6XHJcbiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVEYXRhID0gbmV3IGRlY29kZXJNb2R1bGUuRHJhY29JbnQxNkFycmF5KCk7XHJcbiAgICAgICAgICAgICAgICBkZWNvZGVyLkdldEF0dHJpYnV0ZUludDE2Rm9yQWxsUG9pbnRzKGRyYWNvR2VvbWV0cnksIGF0dHJpYnV0ZSwgYXR0cmlidXRlRGF0YSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBJbnQzMkFycmF5OlxyXG4gICAgICAgICAgICAgICAgYXR0cmlidXRlRGF0YSA9IG5ldyBkZWNvZGVyTW9kdWxlLkRyYWNvSW50MzJBcnJheSgpO1xyXG4gICAgICAgICAgICAgICAgZGVjb2Rlci5HZXRBdHRyaWJ1dGVJbnQzMkZvckFsbFBvaW50cyhkcmFjb0dlb21ldHJ5LCBhdHRyaWJ1dGUsIGF0dHJpYnV0ZURhdGEpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgVWludDhBcnJheTpcclxuICAgICAgICAgICAgICAgIGF0dHJpYnV0ZURhdGEgPSBuZXcgZGVjb2Rlck1vZHVsZS5EcmFjb1VJbnQ4QXJyYXkoKTtcclxuICAgICAgICAgICAgICAgIGRlY29kZXIuR2V0QXR0cmlidXRlVUludDhGb3JBbGxQb2ludHMoZHJhY29HZW9tZXRyeSwgYXR0cmlidXRlLCBhdHRyaWJ1dGVEYXRhKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFVpbnQxNkFycmF5OlxyXG4gICAgICAgICAgICAgICAgYXR0cmlidXRlRGF0YSA9IG5ldyBkZWNvZGVyTW9kdWxlLkRyYWNvVUludDE2QXJyYXkoKTtcclxuICAgICAgICAgICAgICAgIGRlY29kZXIuR2V0QXR0cmlidXRlVUludDE2Rm9yQWxsUG9pbnRzKGRyYWNvR2VvbWV0cnksIGF0dHJpYnV0ZSwgYXR0cmlidXRlRGF0YSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBVaW50MzJBcnJheTpcclxuICAgICAgICAgICAgICAgIGF0dHJpYnV0ZURhdGEgPSBuZXcgZGVjb2Rlck1vZHVsZS5EcmFjb1VJbnQzMkFycmF5KCk7XHJcbiAgICAgICAgICAgICAgICBkZWNvZGVyLkdldEF0dHJpYnV0ZVVJbnQzMkZvckFsbFBvaW50cyhkcmFjb0dlb21ldHJ5LCBhdHRyaWJ1dGUsIGF0dHJpYnV0ZURhdGEpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RIUkVFLkRSQUNPTG9hZGVyOiBVbmV4cGVjdGVkIGF0dHJpYnV0ZSB0eXBlLicpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgYXR0cmlidXRlRGF0YVNpemUgPSBhdHRyaWJ1dGVEYXRhLnNpemUoKTtcclxuICAgICAgICBpZiAoblZhbHVlcyAhPT0gYXR0cmlidXRlRGF0YVNpemUpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBEZWNvbXByZXNzaW9uIGVycm9yOiAke2F0dHJpYnV0ZU5hbWV9IGRhdGEgc2l6ZSBtaXNtYXRjaC5gKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGF0dHJpYnV0ZURhdGFBcnJheSA9IG5ldyBhdHRyaWJ1dGVEYXRhQXJyYXlDb25zdHJ1Y3RvcihuVmFsdWVzKTtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5WYWx1ZXM7ICsraSkge1xyXG4gICAgICAgICAgICBhdHRyaWJ1dGVEYXRhQXJyYXlbaV0gPSBhdHRyaWJ1dGVEYXRhLkdldFZhbHVlKGkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2ZXJ0aWNlc1thdHRyaWJ1dGVOYW1lXSA9IGF0dHJpYnV0ZURhdGFBcnJheTtcclxuXHJcbiAgICAgICAgZGVjb2Rlck1vZHVsZS5kZXN0cm95KGF0dHJpYnV0ZURhdGEpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHZlcnRpY2VzO1xyXG59XHJcblxyXG5mdW5jdGlvbiBkZWNvZGVJbmRpY2VzKGRyYWNvTWVzaDogRGVjb2Rlck1vZHVsZS5NZXNoLCBkZWNvZGVyOiBEZWNvZGVyTW9kdWxlLkRlY29kZXIsIGluZGljZXNBY2Nlc3NvcjogRGVjb2RlZFN0b3JhZ2VDb25zdHJ1Y3Rvcikge1xyXG4gICAgY29uc3QgbkZhY2VzID0gZHJhY29NZXNoLm51bV9mYWNlcygpO1xyXG4gICAgY29uc3QgbkluZGljZXMgPSAzICogbkZhY2VzO1xyXG4gICAgY29uc3QgaW5kaWNlc0NvbnN0cnVjdG9yID0gaW5kaWNlc0FjY2Vzc29yO1xyXG4gICAgY29uc3QgaW5kaWNlcyA9IG5ldyBpbmRpY2VzQ29uc3RydWN0b3IobkluZGljZXMpO1xyXG4gICAgY29uc3QgZHJhY29JbnQzMkFycmF5ID0gbmV3IGRlY29kZXJNb2R1bGUuRHJhY29JbnQzMkFycmF5KCk7XHJcbiAgICBmb3IgKGxldCBpRmFjZSA9IDA7IGlGYWNlIDwgbkZhY2VzOyArK2lGYWNlKSB7XHJcbiAgICAgICAgZGVjb2Rlci5HZXRGYWNlRnJvbU1lc2goZHJhY29NZXNoLCBpRmFjZSwgZHJhY29JbnQzMkFycmF5KTtcclxuICAgICAgICBjb25zdCBpbmRleCA9IDMgKiBpRmFjZTtcclxuICAgICAgICBpbmRpY2VzW2luZGV4XSA9IGRyYWNvSW50MzJBcnJheS5HZXRWYWx1ZSgwKTtcclxuICAgICAgICBpbmRpY2VzW2luZGV4ICsgMV0gPSBkcmFjb0ludDMyQXJyYXkuR2V0VmFsdWUoMSk7XHJcbiAgICAgICAgaW5kaWNlc1tpbmRleCArIDJdID0gZHJhY29JbnQzMkFycmF5LkdldFZhbHVlKDIpO1xyXG4gICAgfVxyXG4gICAgZGVjb2Rlck1vZHVsZS5kZXN0cm95KGRyYWNvSW50MzJBcnJheSk7XHJcbiAgICByZXR1cm4gaW5kaWNlcztcclxufVxyXG4iXX0=