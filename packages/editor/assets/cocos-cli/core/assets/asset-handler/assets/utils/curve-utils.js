"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.evaluateValueTangent = evaluateValueTangent;
exports.solveCubic = solveCubic;
function evaluateValueTangent(time, fromTime, fromValue, fromTangentX, fromTangentY, toTime, toValue, toTangentX, toTangentY) {
    const tangent0x = fromTangentX;
    const tangent0y = fromTangentY;
    const tangent1x = toTangentX;
    const tangent1y = toTangentY;
    const dt = toTime - fromTime;
    const ratio = (time - fromTime) / dt;
    const oneThird = 1.0 / 3.0;
    const dx = dt;
    // Hermite to Bezier
    const u0x = (tangent0x / dx) * oneThird;
    const u1x = 1.0 - (tangent1x / dx) * oneThird;
    const u0y = fromValue + tangent0y * oneThird;
    const u1y = toValue - tangent1y * oneThird;
    // Converts from Bernstein Basis to Power Basis.
    // Formula: [1, 0, 0, 0; -3, 3, 0, 0; 3, -6, 3, 0; -1, 3, -3, 1] * [p_0; p_1; p_2; p_3]
    // --------------------------------------
    // | Basis | Coeff
    // | t^3   | 3 * p_1 - p_0 - 3 * p_2 + p_3
    // | t^2   | 3 * p_0 - 6 * p_1 + 3 * p_2
    // | t^1   | 3 * p_1 - 3 * p_0
    // | t^0   | p_0
    // --------------------------------------
    // where: p_0 = 0, p_1 = u0x, p_2 = u1x, p_3 = 1
    // Especially, when both tangents are 1, we will have u0x = 1/3 and u1x = 2/3
    // and then: ratio = t, eg. the ratios are
    // 1-1 corresponding to param t. That's why we can do optimization like above.
    const coeff0 = 0.0; // 0
    const coeff1 = 3.0 * u0x; // 1
    const coeff2 = 3.0 * u1x - 6.0 * u0x; // -1
    const coeff3 = 3.0 * (u0x - u1x) + 1.0; // 1
    // Solves the param t from equation X(t) = ratio.
    const solutions = [0.0, 0.0, 0.0];
    const nSolutions = solveCubic(coeff0 - ratio, coeff1, coeff2, coeff3, solutions);
    const param = getParamFromCubicSolution(solutions, nSolutions, ratio);
    const value = bezierInterp(fromValue, u0y, u1y, toValue, param);
    const tanX = bezierTangent(fromTime, u0x, u1x, toTime, param);
    const tanY = bezierTangent(fromValue, u0y, u1y, toValue, param);
    return {
        value,
        tangent: {
            x: tanX,
            y: tanY,
        },
    };
}
function bezierInterp(p0, p1, p2, p3, t) {
    const u = 1 - t;
    const coeff0 = u * u * u;
    const coeff1 = 3 * u * u * t;
    const coeff2 = 3 * u * t * t;
    const coeff3 = t * t * t;
    return coeff0 * p0 + coeff1 * p1 + coeff2 * p2 + coeff3 * p3;
}
function bezierTangent(p0, p1, p2, p3, t) {
    const u = 1 - t;
    return 3 * u * u * (p1 - p0) + 6 * u * t * (p2 - p1) + 3 * t * t * (p3 - p2);
}
function getParamFromCubicSolution(solutions, solutionsCount, x) {
    let param = x;
    if (solutionsCount === 1) {
        param = solutions[0];
    }
    else {
        param = -Infinity;
        for (let iSolution = 0; iSolution < solutionsCount; ++iSolution) {
            const solution = solutions[iSolution];
            if (solution >= 0.0 && solution <= 1.0) {
                if (solution > param) {
                    param = solution;
                }
            }
        }
        if (param === -Infinity) {
            param = 0.0;
        }
    }
    return param;
}
// cSpell:words Cardano's irreducibilis
/**
 * Solve Cubic Equation using Cardano's formula.
 * The equation is formed from coeff0 + coeff1 * x + coeff2 * x^2 + coeff3 * x^3 = 0.
 * Modified from https://github.com/erich666/GraphicsGems/blob/master/gems/Roots3And4.c .
 */
function solveCubic(coeff0, coeff1, coeff2, coeff3, solutions) {
    // normal form: x^3 + Ax^2 + Bx + C = 0
    const a = coeff2 / coeff3;
    const b = coeff1 / coeff3;
    const c = coeff0 / coeff3;
    // substitute x = y - A/3 to eliminate quadric term:
    // x^3 +px + q = 0
    const sqrA = a * a;
    const p = (1.0 / 3.0) * ((-1.0 / 3) * sqrA + b);
    const q = (1.0 / 2.0) * ((2.0 / 27.0) * a * sqrA - (1.0 / 3) * a * b + c);
    // use Cardano's formula
    const cubicP = p * p * p;
    const d = q * q + cubicP;
    let nSolutions = 0;
    if (isZero(d)) {
        if (isZero(q)) {
            // one triple solution
            solutions[0] = 0;
            return 1;
        }
        else {
            // one single and one double solution
            const u = Math.cbrt(-q);
            solutions[0] = 2 * u;
            solutions[1] = -u;
            return 2;
        }
    }
    else if (d < 0) {
        // Casus irreducibilis: three real solutions
        const phi = (1.0 / 3) * Math.acos(-q / Math.sqrt(-cubicP));
        const t = 2 * Math.sqrt(-p);
        solutions[0] = t * Math.cos(phi);
        solutions[1] = -t * Math.cos(phi + Math.PI / 3);
        solutions[2] = -t * Math.cos(phi - Math.PI / 3);
        nSolutions = 3;
    }
    else {
        // one real solution
        const sqrtD = Math.sqrt(d);
        const u = Math.cbrt(sqrtD - q);
        const v = -Math.cbrt(sqrtD + q);
        solutions[0] = u + v;
        nSolutions = 1;
    }
    const sub = (1.0 / 3) * a;
    for (let i = 0; i < nSolutions; ++i) {
        solutions[i] -= sub;
    }
    return nSolutions;
}
const EQN_EPS = 1e-9;
function isZero(x) {
    return x > -EQN_EPS && x < EQN_EPS;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3VydmUtdXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9hc3NldHMvYXNzZXQtaGFuZGxlci9hc3NldHMvdXRpbHMvY3VydmUtdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxvREF5REM7QUE0Q0QsZ0NBcURDO0FBMUpELFNBQWdCLG9CQUFvQixDQUNoQyxJQUFZLEVBQ1osUUFBZ0IsRUFDaEIsU0FBaUIsRUFDakIsWUFBb0IsRUFDcEIsWUFBb0IsRUFDcEIsTUFBYyxFQUNkLE9BQWUsRUFDZixVQUFrQixFQUNsQixVQUFrQjtJQUVsQixNQUFNLFNBQVMsR0FBRyxZQUFZLENBQUM7SUFDL0IsTUFBTSxTQUFTLEdBQUcsWUFBWSxDQUFDO0lBQy9CLE1BQU0sU0FBUyxHQUFHLFVBQVUsQ0FBQztJQUM3QixNQUFNLFNBQVMsR0FBRyxVQUFVLENBQUM7SUFDN0IsTUFBTSxFQUFFLEdBQUcsTUFBTSxHQUFHLFFBQVEsQ0FBQztJQUM3QixNQUFNLEtBQUssR0FBRyxDQUFDLElBQUksR0FBRyxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUM7SUFFckMsTUFBTSxRQUFRLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQztJQUMzQixNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUM7SUFDZCxvQkFBb0I7SUFDcEIsTUFBTSxHQUFHLEdBQUcsQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDLEdBQUcsUUFBUSxDQUFDO0lBQ3hDLE1BQU0sR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUMsR0FBRyxRQUFRLENBQUM7SUFDOUMsTUFBTSxHQUFHLEdBQUcsU0FBUyxHQUFHLFNBQVMsR0FBRyxRQUFRLENBQUM7SUFDN0MsTUFBTSxHQUFHLEdBQUcsT0FBTyxHQUFHLFNBQVMsR0FBRyxRQUFRLENBQUM7SUFDM0MsZ0RBQWdEO0lBQ2hELHVGQUF1RjtJQUN2Rix5Q0FBeUM7SUFD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O1FBQzNELE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFNUIsU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2pDLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2hELFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2hELFVBQVUsR0FBRyxDQUFDLENBQUM7SUFDbkIsQ0FBQztTQUFNLENBQUM7UUFDSixvQkFBb0I7UUFDcEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMzQixNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztRQUMvQixNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2hDLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3JCLFVBQVUsR0FBRyxDQUFDLENBQUM7SUFDbkIsQ0FBQztJQUVELE1BQU0sR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMxQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsVUFBVSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUM7UUFDbEMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQztJQUN4QixDQUFDO0lBRUQsT0FBTyxVQUFVLENBQUM7QUFDdEIsQ0FBQztBQUVELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQztBQUVyQixTQUFTLE1BQU0sQ0FBQyxDQUFTO0lBQ3JCLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUM7QUFDdkMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBmdW5jdGlvbiBldmFsdWF0ZVZhbHVlVGFuZ2VudChcclxuICAgIHRpbWU6IG51bWJlcixcclxuICAgIGZyb21UaW1lOiBudW1iZXIsXHJcbiAgICBmcm9tVmFsdWU6IG51bWJlcixcclxuICAgIGZyb21UYW5nZW50WDogbnVtYmVyLFxyXG4gICAgZnJvbVRhbmdlbnRZOiBudW1iZXIsXHJcbiAgICB0b1RpbWU6IG51bWJlcixcclxuICAgIHRvVmFsdWU6IG51bWJlcixcclxuICAgIHRvVGFuZ2VudFg6IG51bWJlcixcclxuICAgIHRvVGFuZ2VudFk6IG51bWJlcixcclxuKTogeyB2YWx1ZTogbnVtYmVyOyB0YW5nZW50OiB7IHg6IG51bWJlcjsgeTogbnVtYmVyIH0gfSB7XHJcbiAgICBjb25zdCB0YW5nZW50MHggPSBmcm9tVGFuZ2VudFg7XHJcbiAgICBjb25zdCB0YW5nZW50MHkgPSBmcm9tVGFuZ2VudFk7XHJcbiAgICBjb25zdCB0YW5nZW50MXggPSB0b1RhbmdlbnRYO1xyXG4gICAgY29uc3QgdGFuZ2VudDF5ID0gdG9UYW5nZW50WTtcclxuICAgIGNvbnN0IGR0ID0gdG9UaW1lIC0gZnJvbVRpbWU7XHJcbiAgICBjb25zdCByYXRpbyA9ICh0aW1lIC0gZnJvbVRpbWUpIC8gZHQ7XHJcblxyXG4gICAgY29uc3Qgb25lVGhpcmQgPSAxLjAgLyAzLjA7XHJcbiAgICBjb25zdCBkeCA9IGR0O1xyXG4gICAgLy8gSGVybWl0ZSB0byBCZXppZXJcclxuICAgIGNvbnN0IHUweCA9ICh0YW5nZW50MHggLyBkeCkgKiBvbmVUaGlyZDtcclxuICAgIGNvbnN0IHUxeCA9IDEuMCAtICh0YW5nZW50MXggLyBkeCkgKiBvbmVUaGlyZDtcclxuICAgIGNvbnN0IHUweSA9IGZyb21WYWx1ZSArIHRhbmdlbnQweSAqIG9uZVRoaXJkO1xyXG4gICAgY29uc3QgdTF5ID0gdG9WYWx1ZSAtIHRhbmdlbnQxeSAqIG9uZVRoaXJkO1xyXG4gICAgLy8gQ29udmVydHMgZnJvbSBCZXJuc3RlaW4gQmFzaXMgdG8gUG93ZXIgQmFzaXMuXHJcbiAgICAvLyBGb3JtdWxhOiBbMSwgMCwgMCwgMDsgLTMsIDMsIDAsIDA7IDMsIC02LCAzLCAwOyAtMSwgMywgLTMsIDFdICogW3BfMDsgcF8xOyBwXzI7IHBfM11cclxuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiAgICAvLyB8IEJhc2lzIHwgQ29lZmZcclxuICAgIC8vIHwgdF4zICAgfCAzICogcF8xIC0gcF8wIC0gMyAqIHBfMiArIHBfM1xyXG4gICAgLy8gfCB0XjIgICB8IDMgKiBwXzAgLSA2ICogcF8xICsgMyAqIHBfMlxyXG4gICAgLy8gfCB0XjEgICB8IDMgKiBwXzEgLSAzICogcF8wXHJcbiAgICAvLyB8IHReMCAgIHwgcF8wXHJcbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gICAgLy8gd2hlcmU6IHBfMCA9IDAsIHBfMSA9IHUweCwgcF8yID0gdTF4LCBwXzMgPSAxXHJcbiAgICAvLyBFc3BlY2lhbGx5LCB3aGVuIGJvdGggdGFuZ2VudHMgYXJlIDEsIHdlIHdpbGwgaGF2ZSB1MHggPSAxLzMgYW5kIHUxeCA9IDIvM1xyXG4gICAgLy8gYW5kIHRoZW46IHJhdGlvID0gdCwgZWcuIHRoZSByYXRpb3MgYXJlXHJcbiAgICAvLyAxLTEgY29ycmVzcG9uZGluZyB0byBwYXJhbSB0LiBUaGF0J3Mgd2h5IHdlIGNhbiBkbyBvcHRpbWl6YXRpb24gbGlrZSBhYm92ZS5cclxuICAgIGNvbnN0IGNvZWZmMCA9IDAuMDsgLy8gMFxyXG4gICAgY29uc3QgY29lZmYxID0gMy4wICogdTB4OyAvLyAxXHJcbiAgICBjb25zdCBjb2VmZjIgPSAzLjAgKiB1MXggLSA2LjAgKiB1MHg7IC8vIC0xXHJcbiAgICBjb25zdCBjb2VmZjMgPSAzLjAgKiAodTB4IC0gdTF4KSArIDEuMDsgLy8gMVxyXG4gICAgLy8gU29sdmVzIHRoZSBwYXJhbSB0IGZyb20gZXF1YXRpb24gWCh0KSA9IHJhdGlvLlxyXG4gICAgY29uc3Qgc29sdXRpb25zID0gWzAuMCwgMC4wLCAwLjBdIGFzIFtudW1iZXIsIG51bWJlciwgbnVtYmVyXTtcclxuICAgIGNvbnN0IG5Tb2x1dGlvbnMgPSBzb2x2ZUN1YmljKGNvZWZmMCAtIHJhdGlvLCBjb2VmZjEsIGNvZWZmMiwgY29lZmYzLCBzb2x1dGlvbnMpO1xyXG4gICAgY29uc3QgcGFyYW0gPSBnZXRQYXJhbUZyb21DdWJpY1NvbHV0aW9uKHNvbHV0aW9ucywgblNvbHV0aW9ucywgcmF0aW8pO1xyXG5cclxuICAgIGNvbnN0IHZhbHVlID0gYmV6aWVySW50ZXJwKGZyb21WYWx1ZSwgdTB5LCB1MXksIHRvVmFsdWUsIHBhcmFtKTtcclxuICAgIGNvbnN0IHRhblggPSBiZXppZXJUYW5nZW50KGZyb21UaW1lLCB1MHgsIHUxeCwgdG9UaW1lLCBwYXJhbSk7XHJcbiAgICBjb25zdCB0YW5ZID0gYmV6aWVyVGFuZ2VudChmcm9tVmFsdWUsIHUweSwgdTF5LCB0b1ZhbHVlLCBwYXJhbSk7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHZhbHVlLFxyXG4gICAgICAgIHRhbmdlbnQ6IHtcclxuICAgICAgICAgICAgeDogdGFuWCxcclxuICAgICAgICAgICAgeTogdGFuWSxcclxuICAgICAgICB9LFxyXG4gICAgfTtcclxufVxyXG5cclxuZnVuY3Rpb24gYmV6aWVySW50ZXJwKHAwOiBudW1iZXIsIHAxOiBudW1iZXIsIHAyOiBudW1iZXIsIHAzOiBudW1iZXIsIHQ6IG51bWJlcikge1xyXG4gICAgY29uc3QgdSA9IDEgLSB0O1xyXG4gICAgY29uc3QgY29lZmYwID0gdSAqIHUgKiB1O1xyXG4gICAgY29uc3QgY29lZmYxID0gMyAqIHUgKiB1ICogdDtcclxuICAgIGNvbnN0IGNvZWZmMiA9IDMgKiB1ICogdCAqIHQ7XHJcbiAgICBjb25zdCBjb2VmZjMgPSB0ICogdCAqIHQ7XHJcbiAgICByZXR1cm4gY29lZmYwICogcDAgKyBjb2VmZjEgKiBwMSArIGNvZWZmMiAqIHAyICsgY29lZmYzICogcDM7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGJlemllclRhbmdlbnQocDA6IG51bWJlciwgcDE6IG51bWJlciwgcDI6IG51bWJlciwgcDM6IG51bWJlciwgdDogbnVtYmVyKSB7XHJcbiAgICBjb25zdCB1ID0gMSAtIHQ7XHJcbiAgICByZXR1cm4gMyAqIHUgKiB1ICogKHAxIC0gcDApICsgNiAqIHUgKiB0ICogKHAyIC0gcDEpICsgMyAqIHQgKiB0ICogKHAzIC0gcDIpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRQYXJhbUZyb21DdWJpY1NvbHV0aW9uKHNvbHV0aW9uczogcmVhZG9ubHkgW251bWJlciwgbnVtYmVyLCBudW1iZXJdLCBzb2x1dGlvbnNDb3VudDogbnVtYmVyLCB4OiBudW1iZXIpIHtcclxuICAgIGxldCBwYXJhbSA9IHg7XHJcbiAgICBpZiAoc29sdXRpb25zQ291bnQgPT09IDEpIHtcclxuICAgICAgICBwYXJhbSA9IHNvbHV0aW9uc1swXTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcGFyYW0gPSAtSW5maW5pdHk7XHJcbiAgICAgICAgZm9yIChsZXQgaVNvbHV0aW9uID0gMDsgaVNvbHV0aW9uIDwgc29sdXRpb25zQ291bnQ7ICsraVNvbHV0aW9uKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNvbHV0aW9uID0gc29sdXRpb25zW2lTb2x1dGlvbl07XHJcbiAgICAgICAgICAgIGlmIChzb2x1dGlvbiA+PSAwLjAgJiYgc29sdXRpb24gPD0gMS4wKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc29sdXRpb24gPiBwYXJhbSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtID0gc29sdXRpb247XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHBhcmFtID09PSAtSW5maW5pdHkpIHtcclxuICAgICAgICAgICAgcGFyYW0gPSAwLjA7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHBhcmFtO1xyXG59XHJcblxyXG4vLyBjU3BlbGw6d29yZHMgQ2FyZGFubydzIGlycmVkdWNpYmlsaXNcclxuXHJcbi8qKlxyXG4gKiBTb2x2ZSBDdWJpYyBFcXVhdGlvbiB1c2luZyBDYXJkYW5vJ3MgZm9ybXVsYS5cclxuICogVGhlIGVxdWF0aW9uIGlzIGZvcm1lZCBmcm9tIGNvZWZmMCArIGNvZWZmMSAqIHggKyBjb2VmZjIgKiB4XjIgKyBjb2VmZjMgKiB4XjMgPSAwLlxyXG4gKiBNb2RpZmllZCBmcm9tIGh0dHBzOi8vZ2l0aHViLmNvbS9lcmljaDY2Ni9HcmFwaGljc0dlbXMvYmxvYi9tYXN0ZXIvZ2Vtcy9Sb290czNBbmQ0LmMgLlxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIHNvbHZlQ3ViaWMoY29lZmYwOiBudW1iZXIsIGNvZWZmMTogbnVtYmVyLCBjb2VmZjI6IG51bWJlciwgY29lZmYzOiBudW1iZXIsIHNvbHV0aW9uczogW251bWJlciwgbnVtYmVyLCBudW1iZXJdKSB7XHJcbiAgICAvLyBub3JtYWwgZm9ybTogeF4zICsgQXheMiArIEJ4ICsgQyA9IDBcclxuICAgIGNvbnN0IGEgPSBjb2VmZjIgLyBjb2VmZjM7XHJcbiAgICBjb25zdCBiID0gY29lZmYxIC8gY29lZmYzO1xyXG4gICAgY29uc3QgYyA9IGNvZWZmMCAvIGNvZWZmMztcclxuXHJcbiAgICAvLyBzdWJzdGl0dXRlIHggPSB5IC0gQS8zIHRvIGVsaW1pbmF0ZSBxdWFkcmljIHRlcm06XHJcbiAgICAvLyB4XjMgK3B4ICsgcSA9IDBcclxuICAgIGNvbnN0IHNxckEgPSBhICogYTtcclxuICAgIGNvbnN0IHAgPSAoMS4wIC8gMy4wKSAqICgoLTEuMCAvIDMpICogc3FyQSArIGIpO1xyXG4gICAgY29uc3QgcSA9ICgxLjAgLyAyLjApICogKCgyLjAgLyAyNy4wKSAqIGEgKiBzcXJBIC0gKDEuMCAvIDMpICogYSAqIGIgKyBjKTtcclxuXHJcbiAgICAvLyB1c2UgQ2FyZGFubydzIGZvcm11bGFcclxuICAgIGNvbnN0IGN1YmljUCA9IHAgKiBwICogcDtcclxuICAgIGNvbnN0IGQgPSBxICogcSArIGN1YmljUDtcclxuXHJcbiAgICBsZXQgblNvbHV0aW9ucyA9IDA7XHJcbiAgICBpZiAoaXNaZXJvKGQpKSB7XHJcbiAgICAgICAgaWYgKGlzWmVybyhxKSkge1xyXG4gICAgICAgICAgICAvLyBvbmUgdHJpcGxlIHNvbHV0aW9uXHJcbiAgICAgICAgICAgIHNvbHV0aW9uc1swXSA9IDA7XHJcbiAgICAgICAgICAgIHJldHVybiAxO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIG9uZSBzaW5nbGUgYW5kIG9uZSBkb3VibGUgc29sdXRpb25cclxuICAgICAgICAgICAgY29uc3QgdSA9IE1hdGguY2JydCgtcSk7XHJcbiAgICAgICAgICAgIHNvbHV0aW9uc1swXSA9IDIgKiB1O1xyXG4gICAgICAgICAgICBzb2x1dGlvbnNbMV0gPSAtdTtcclxuICAgICAgICAgICAgcmV0dXJuIDI7XHJcbiAgICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChkIDwgMCkge1xyXG4gICAgICAgIC8vIENhc3VzIGlycmVkdWNpYmlsaXM6IHRocmVlIHJlYWwgc29sdXRpb25zXHJcbiAgICAgICAgY29uc3QgcGhpID0gKDEuMCAvIDMpICogTWF0aC5hY29zKC1xIC8gTWF0aC5zcXJ0KC1jdWJpY1ApKTtcclxuICAgICAgICBjb25zdCB0ID0gMiAqIE1hdGguc3FydCgtcCk7XHJcblxyXG4gICAgICAgIHNvbHV0aW9uc1swXSA9IHQgKiBNYXRoLmNvcyhwaGkpO1xyXG4gICAgICAgIHNvbHV0aW9uc1sxXSA9IC10ICogTWF0aC5jb3MocGhpICsgTWF0aC5QSSAvIDMpO1xyXG4gICAgICAgIHNvbHV0aW9uc1syXSA9IC10ICogTWF0aC5jb3MocGhpIC0gTWF0aC5QSSAvIDMpO1xyXG4gICAgICAgIG5Tb2x1dGlvbnMgPSAzO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICAvLyBvbmUgcmVhbCBzb2x1dGlvblxyXG4gICAgICAgIGNvbnN0IHNxcnREID0gTWF0aC5zcXJ0KGQpO1xyXG4gICAgICAgIGNvbnN0IHUgPSBNYXRoLmNicnQoc3FydEQgLSBxKTtcclxuICAgICAgICBjb25zdCB2ID0gLU1hdGguY2JydChzcXJ0RCArIHEpO1xyXG4gICAgICAgIHNvbHV0aW9uc1swXSA9IHUgKyB2O1xyXG4gICAgICAgIG5Tb2x1dGlvbnMgPSAxO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHN1YiA9ICgxLjAgLyAzKSAqIGE7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5Tb2x1dGlvbnM7ICsraSkge1xyXG4gICAgICAgIHNvbHV0aW9uc1tpXSAtPSBzdWI7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG5Tb2x1dGlvbnM7XHJcbn1cclxuXHJcbmNvbnN0IEVRTl9FUFMgPSAxZS05O1xyXG5cclxuZnVuY3Rpb24gaXNaZXJvKHg6IG51bWJlcikge1xyXG4gICAgcmV0dXJuIHggPiAtRVFOX0VQUyAmJiB4IDwgRVFOX0VQUztcclxufVxyXG4iXX0=