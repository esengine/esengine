"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.compressAnimationClip = compressAnimationClip;
const cc_1 = require("cc");
const { approx } = cc_1.math;
function compressAnimationClip(animationClip) {
    for (const track of animationClip.tracks) {
        for (const { curve } of track.channels()) {
            if (curve instanceof cc_1.RealCurve) {
                compressRealCurve(curve);
            }
        }
    }
}
function compressRealCurve(curve) {
    if (curve.keyFramesCount < 2) {
        return;
    }
    if (!Array.from(curve.values()).every(({ interpolationMode }) => interpolationMode === cc_1.RealInterpolationMode.LINEAR)) {
        return;
    }
    const times = Array.from(curve.times());
    const values = Array.from(curve.values()).map(({ value }) => value);
    const compressed = compress(times, values, [
        {
            type: 'remove-linear-keys',
            maxDiff: 1e-4,
        },
        {
            type: 'remove-trivial-keys',
            maxDiff: 1e-4,
        },
    ]);
    curve.assignSorted(compressed.times, compressed.values);
}
function compress(times, values, stack) {
    for (const compression of stack) {
        switch (compression.type) {
            case 'remove-linear-keys':
                ({ keys: times, values } = removeLinearKeys(times, values, compression.maxDiff));
                break;
            case 'remove-trivial-keys':
                ({ keys: times, values } = removeTrivialKeys(times, values, compression.maxDiff));
                break;
        }
    }
    return { times, values };
}
/**
 * Removes keys which are linear interpolations of surrounding keys.
 * @param keys Input keys.
 * @param values Input values.
 * @param maxDiff Max error.
 * @returns The new keys `keys` and new values `values`.
 */
function removeLinearKeys(keys, values, maxDiff = 1e-3) {
    const nKeys = keys.length;
    if (nKeys < 3) {
        return {
            keys: keys.slice(),
            values: values.slice(),
        };
    }
    const removeFlags = new Array(nKeys).fill(false);
    // We may choose to use different key selection policy?
    // http://nfrechette.github.io/2016/12/07/anim_compression_key_reduction/
    const iLastKey = nKeys - 1;
    for (let iKey = 1; iKey < iLastKey; ++iKey) {
        // Should we select previous non-removed key?
        const iPrevious = iKey - 1;
        const iNext = iKey + 1;
        const { [iPrevious]: previousKey, [iKey]: currentKey, [iNext]: nextKey } = keys;
        const { [iPrevious]: previousValue, [iKey]: currentValue, [iNext]: nextValue } = values;
        const alpha = (currentKey - previousKey) / (nextKey - previousKey);
        const expectedValue = (nextValue - previousValue) * alpha + previousValue;
        if (approx(expectedValue, currentValue, maxDiff)) {
            removeFlags[iKey] = true;
        }
    }
    return filterFromRemoveFlags(keys, values, removeFlags);
}
/**
 * Removes trivial frames.
 * @param keys Input keys.
 * @param values Input values.
 * @param maxDiff Max error.
 * @returns The new keys `keys` and new values `values`.
 */
function removeTrivialKeys(keys, values, maxDiff = 1e-3) {
    const nKeys = keys.length;
    if (nKeys < 2) {
        return {
            keys: keys.slice(),
            values: values.slice(),
        };
    }
    const removeFlags = new Array(nKeys).fill(false);
    for (let iKey = 1; iKey < nKeys; ++iKey) {
        // Should we select previous non-removed key?
        const iPrevious = iKey - 1;
        const { [iPrevious]: previousValue, [iKey]: currentValue } = values;
        if (approx(previousValue, currentValue, maxDiff)) {
            removeFlags[iKey] = true;
        }
    }
    return filterFromRemoveFlags(keys, values, removeFlags);
}
function filterFromRemoveFlags(keys, values, removeFlags) {
    const nKeys = keys.length;
    const nRemovals = removeFlags.reduce((n, removeFlag) => (removeFlag ? n + 1 : n), 0);
    if (!nRemovals) {
        return {
            keys: keys.slice(),
            values: values.slice(),
        };
    }
    const nNewKeyframes = nKeys - nRemovals;
    const newKeys = new Array(nNewKeyframes).fill(0.0);
    const newValues = new Array(nNewKeyframes).fill(0.0);
    for (let iNewKeys = 0, iKey = 0; iKey < nKeys; ++iKey) {
        if (!removeFlags[iKey]) {
            newKeys[iNewKeys] = keys[iKey];
            newValues[iNewKeys] = values[iKey];
            ++iNewKeys;
        }
    }
    return {
        keys: newKeys,
        values: newValues,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5pbWF0aW9uLWNvbXByZXNzaW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvYXNzZXRzL2Fzc2V0LWhhbmRsZXIvYXNzZXRzL3V0aWxzL2FuaW1hdGlvbi1jb21wcmVzc2lvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQWtCQSxzREFRQztBQTFCRCwyQkFBOEY7QUFFOUYsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLFNBQUksQ0FBQztBQWdCeEIsU0FBZ0IscUJBQXFCLENBQUMsYUFBNEI7SUFDOUQsS0FBSyxNQUFNLEtBQUssSUFBSSxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDdkMsS0FBSyxNQUFNLEVBQUUsS0FBSyxFQUFFLElBQUksS0FBSyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUM7WUFDdkMsSUFBSSxLQUFLLFlBQVksY0FBUyxFQUFFLENBQUM7Z0JBQzdCLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzdCLENBQUM7UUFDTCxDQUFDO0lBQ0wsQ0FBQztBQUNMLENBQUM7QUFFRCxTQUFTLGlCQUFpQixDQUFDLEtBQWdCO0lBQ3ZDLElBQUksS0FBSyxDQUFDLGNBQWMsR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUMzQixPQUFPO0lBQ1gsQ0FBQztJQUNELElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsaUJBQWlCLEVBQUUsRUFBRSxFQUFFLENBQUMsaUJBQWlCLEtBQUssMEJBQXFCLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztRQUNuSCxPQUFPO0lBQ1gsQ0FBQztJQUNELE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDeEMsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFL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QUFJLEVBQUUsT0FBTztRQUNiLE1BQU0sRUFBRSxTQUFTO0tBQ3BCLENBQUM7QUFDTixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQW5pbWF0aW9uQ2xpcCwgbWF0aCwgUmVhbEN1cnZlLCBSZWFsSW50ZXJwb2xhdGlvbk1vZGUsIFJlYWxLZXlmcmFtZVZhbHVlIH0gZnJvbSAnY2MnO1xyXG5cclxuY29uc3QgeyBhcHByb3ggfSA9IG1hdGg7XHJcblxyXG50eXBlIENvbXByZXNzaW9uU3RhY2sgPSBDb21wcmVzc2lvbltdO1xyXG5cclxudHlwZSBDb21wcmVzc2lvbiA9IFJlbW92ZUxpbmVhcktleXNDb21wcmVzc2lvbiB8IFJlbW92ZVRyaXZpYWxLZXlzQ29tcHJlc3Npb247XHJcblxyXG5pbnRlcmZhY2UgUmVtb3ZlTGluZWFyS2V5c0NvbXByZXNzaW9uIHtcclxuICAgIHR5cGU6ICdyZW1vdmUtbGluZWFyLWtleXMnO1xyXG4gICAgbWF4RGlmZjogbnVtYmVyO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgUmVtb3ZlVHJpdmlhbEtleXNDb21wcmVzc2lvbiB7XHJcbiAgICB0eXBlOiAncmVtb3ZlLXRyaXZpYWwta2V5cyc7XHJcbiAgICBtYXhEaWZmOiBudW1iZXI7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjb21wcmVzc0FuaW1hdGlvbkNsaXAoYW5pbWF0aW9uQ2xpcDogQW5pbWF0aW9uQ2xpcCkge1xyXG4gICAgZm9yIChjb25zdCB0cmFjayBvZiBhbmltYXRpb25DbGlwLnRyYWNrcykge1xyXG4gICAgICAgIGZvciAoY29uc3QgeyBjdXJ2ZSB9IG9mIHRyYWNrLmNoYW5uZWxzKCkpIHtcclxuICAgICAgICAgICAgaWYgKGN1cnZlIGluc3RhbmNlb2YgUmVhbEN1cnZlKSB7XHJcbiAgICAgICAgICAgICAgICBjb21wcmVzc1JlYWxDdXJ2ZShjdXJ2ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbXByZXNzUmVhbEN1cnZlKGN1cnZlOiBSZWFsQ3VydmUpIHtcclxuICAgIGlmIChjdXJ2ZS5rZXlGcmFtZXNDb3VudCA8IDIpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoIUFycmF5LmZyb20oY3VydmUudmFsdWVzKCkpLmV2ZXJ5KCh7IGludGVycG9sYXRpb25Nb2RlIH0pID0+IGludGVycG9sYXRpb25Nb2RlID09PSBSZWFsSW50ZXJwb2xhdGlvbk1vZGUuTElORUFSKSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IHRpbWVzID0gQXJyYXkuZnJvbShjdXJ2ZS50aW1lcygpKTtcclxuICAgIGNvbnN0IHZhbHVlcyA9IEFycmF5LmZyb20oY3VydmUudmFsdWVzKCkpLm1hcCgoeyB2YWx1ZSB9KSA9PiB2YWx1ZSk7XHJcbiAgICBjb25zdCBjb21wcmVzc2VkID0gY29tcHJlc3ModGltZXMsIHZhbHVlcywgW1xyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgdHlwZTogJ3JlbW92ZS1saW5lYXIta2V5cycsXHJcbiAgICAgICAgICAgIG1heERpZmY6IDFlLTQsXHJcbiAgICAgICAgfSxcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHR5cGU6ICdyZW1vdmUtdHJpdmlhbC1rZXlzJyxcclxuICAgICAgICAgICAgbWF4RGlmZjogMWUtNCxcclxuICAgICAgICB9LFxyXG4gICAgXSk7XHJcbiAgICBjdXJ2ZS5hc3NpZ25Tb3J0ZWQoY29tcHJlc3NlZC50aW1lcywgY29tcHJlc3NlZC52YWx1ZXMpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjb21wcmVzcyh0aW1lczogbnVtYmVyW10sIHZhbHVlczogbnVtYmVyW10sIHN0YWNrOiBDb21wcmVzc2lvblN0YWNrKSB7XHJcbiAgICBmb3IgKGNvbnN0IGNvbXByZXNzaW9uIG9mIHN0YWNrKSB7XHJcbiAgICAgICAgc3dpdGNoIChjb21wcmVzc2lvbi50eXBlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgJ3JlbW92ZS1saW5lYXIta2V5cyc6XHJcbiAgICAgICAgICAgICAgICAoeyBrZXlzOiB0aW1lcywgdmFsdWVzIH0gPSByZW1vdmVMaW5lYXJLZXlzKHRpbWVzLCB2YWx1ZXMsIGNvbXByZXNzaW9uLm1heERpZmYpKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdyZW1vdmUtdHJpdmlhbC1rZXlzJzpcclxuICAgICAgICAgICAgICAgICh7IGtleXM6IHRpbWVzLCB2YWx1ZXMgfSA9IHJlbW92ZVRyaXZpYWxLZXlzKHRpbWVzLCB2YWx1ZXMsIGNvbXByZXNzaW9uLm1heERpZmYpKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiB7IHRpbWVzLCB2YWx1ZXMgfTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFJlbW92ZXMga2V5cyB3aGljaCBhcmUgbGluZWFyIGludGVycG9sYXRpb25zIG9mIHN1cnJvdW5kaW5nIGtleXMuXHJcbiAqIEBwYXJhbSBrZXlzIElucHV0IGtleXMuXHJcbiAqIEBwYXJhbSB2YWx1ZXMgSW5wdXQgdmFsdWVzLlxyXG4gKiBAcGFyYW0gbWF4RGlmZiBNYXggZXJyb3IuXHJcbiAqIEByZXR1cm5zIFRoZSBuZXcga2V5cyBga2V5c2AgYW5kIG5ldyB2YWx1ZXMgYHZhbHVlc2AuXHJcbiAqL1xyXG5mdW5jdGlvbiByZW1vdmVMaW5lYXJLZXlzKGtleXM6IG51bWJlcltdLCB2YWx1ZXM6IG51bWJlcltdLCBtYXhEaWZmID0gMWUtMykge1xyXG4gICAgY29uc3QgbktleXMgPSBrZXlzLmxlbmd0aDtcclxuXHJcbiAgICBpZiAobktleXMgPCAzKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAga2V5czoga2V5cy5zbGljZSgpLFxyXG4gICAgICAgICAgICB2YWx1ZXM6IHZhbHVlcy5zbGljZSgpLFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcmVtb3ZlRmxhZ3MgPSBuZXcgQXJyYXk8Ym9vbGVhbj4obktleXMpLmZpbGwoZmFsc2UpO1xyXG4gICAgLy8gV2UgbWF5IGNob29zZSB0byB1c2UgZGlmZmVyZW50IGtleSBzZWxlY3Rpb24gcG9saWN5P1xyXG4gICAgLy8gaHR0cDovL25mcmVjaGV0dGUuZ2l0aHViLmlvLzIwMTYvMTIvMDcvYW5pbV9jb21wcmVzc2lvbl9rZXlfcmVkdWN0aW9uL1xyXG4gICAgY29uc3QgaUxhc3RLZXkgPSBuS2V5cyAtIDE7XHJcbiAgICBmb3IgKGxldCBpS2V5ID0gMTsgaUtleSA8IGlMYXN0S2V5OyArK2lLZXkpIHtcclxuICAgICAgICAvLyBTaG91bGQgd2Ugc2VsZWN0IHByZXZpb3VzIG5vbi1yZW1vdmVkIGtleT9cclxuICAgICAgICBjb25zdCBpUHJldmlvdXMgPSBpS2V5IC0gMTtcclxuICAgICAgICBjb25zdCBpTmV4dCA9IGlLZXkgKyAxO1xyXG4gICAgICAgIGNvbnN0IHsgW2lQcmV2aW91c106IHByZXZpb3VzS2V5LCBbaUtleV06IGN1cnJlbnRLZXksIFtpTmV4dF06IG5leHRLZXkgfSA9IGtleXM7XHJcbiAgICAgICAgY29uc3QgeyBbaVByZXZpb3VzXTogcHJldmlvdXNWYWx1ZSwgW2lLZXldOiBjdXJyZW50VmFsdWUsIFtpTmV4dF06IG5leHRWYWx1ZSB9ID0gdmFsdWVzO1xyXG4gICAgICAgIGNvbnN0IGFscGhhID0gKGN1cnJlbnRLZXkgLSBwcmV2aW91c0tleSkgLyAobmV4dEtleSAtIHByZXZpb3VzS2V5KTtcclxuICAgICAgICBjb25zdCBleHBlY3RlZFZhbHVlID0gKG5leHRWYWx1ZSAtIHByZXZpb3VzVmFsdWUpICogYWxwaGEgKyBwcmV2aW91c1ZhbHVlO1xyXG4gICAgICAgIGlmIChhcHByb3goZXhwZWN0ZWRWYWx1ZSwgY3VycmVudFZhbHVlLCBtYXhEaWZmKSkge1xyXG4gICAgICAgICAgICByZW1vdmVGbGFnc1tpS2V5XSA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBmaWx0ZXJGcm9tUmVtb3ZlRmxhZ3Moa2V5cywgdmFsdWVzLCByZW1vdmVGbGFncyk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBSZW1vdmVzIHRyaXZpYWwgZnJhbWVzLlxyXG4gKiBAcGFyYW0ga2V5cyBJbnB1dCBrZXlzLlxyXG4gKiBAcGFyYW0gdmFsdWVzIElucHV0IHZhbHVlcy5cclxuICogQHBhcmFtIG1heERpZmYgTWF4IGVycm9yLlxyXG4gKiBAcmV0dXJucyBUaGUgbmV3IGtleXMgYGtleXNgIGFuZCBuZXcgdmFsdWVzIGB2YWx1ZXNgLlxyXG4gKi9cclxuZnVuY3Rpb24gcmVtb3ZlVHJpdmlhbEtleXMoa2V5czogbnVtYmVyW10sIHZhbHVlczogbnVtYmVyW10sIG1heERpZmYgPSAxZS0zKSB7XHJcbiAgICBjb25zdCBuS2V5cyA9IGtleXMubGVuZ3RoO1xyXG5cclxuICAgIGlmIChuS2V5cyA8IDIpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBrZXlzOiBrZXlzLnNsaWNlKCksXHJcbiAgICAgICAgICAgIHZhbHVlczogdmFsdWVzLnNsaWNlKCksXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCByZW1vdmVGbGFncyA9IG5ldyBBcnJheTxib29sZWFuPihuS2V5cykuZmlsbChmYWxzZSk7XHJcbiAgICBmb3IgKGxldCBpS2V5ID0gMTsgaUtleSA8IG5LZXlzOyArK2lLZXkpIHtcclxuICAgICAgICAvLyBTaG91bGQgd2Ugc2VsZWN0IHByZXZpb3VzIG5vbi1yZW1vdmVkIGtleT9cclxuICAgICAgICBjb25zdCBpUHJldmlvdXMgPSBpS2V5IC0gMTtcclxuICAgICAgICBjb25zdCB7IFtpUHJldmlvdXNdOiBwcmV2aW91c1ZhbHVlLCBbaUtleV06IGN1cnJlbnRWYWx1ZSB9ID0gdmFsdWVzO1xyXG4gICAgICAgIGlmIChhcHByb3gocHJldmlvdXNWYWx1ZSwgY3VycmVudFZhbHVlLCBtYXhEaWZmKSkge1xyXG4gICAgICAgICAgICByZW1vdmVGbGFnc1tpS2V5XSA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBmaWx0ZXJGcm9tUmVtb3ZlRmxhZ3Moa2V5cywgdmFsdWVzLCByZW1vdmVGbGFncyk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGZpbHRlckZyb21SZW1vdmVGbGFncyhrZXlzOiBudW1iZXJbXSwgdmFsdWVzOiBudW1iZXJbXSwgcmVtb3ZlRmxhZ3M6IGJvb2xlYW5bXSkge1xyXG4gICAgY29uc3QgbktleXMgPSBrZXlzLmxlbmd0aDtcclxuXHJcbiAgICBjb25zdCBuUmVtb3ZhbHMgPSByZW1vdmVGbGFncy5yZWR1Y2UoKG4sIHJlbW92ZUZsYWcpID0+IChyZW1vdmVGbGFnID8gbiArIDEgOiBuKSwgMCk7XHJcbiAgICBpZiAoIW5SZW1vdmFscykge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGtleXM6IGtleXMuc2xpY2UoKSxcclxuICAgICAgICAgICAgdmFsdWVzOiB2YWx1ZXMuc2xpY2UoKSxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG5OZXdLZXlmcmFtZXMgPSBuS2V5cyAtIG5SZW1vdmFscztcclxuICAgIGNvbnN0IG5ld0tleXMgPSBuZXcgQXJyYXk8bnVtYmVyPihuTmV3S2V5ZnJhbWVzKS5maWxsKDAuMCk7XHJcbiAgICBjb25zdCBuZXdWYWx1ZXMgPSBuZXcgQXJyYXk8bnVtYmVyPihuTmV3S2V5ZnJhbWVzKS5maWxsKDAuMCk7XHJcbiAgICBmb3IgKGxldCBpTmV3S2V5cyA9IDAsIGlLZXkgPSAwOyBpS2V5IDwgbktleXM7ICsraUtleSkge1xyXG4gICAgICAgIGlmICghcmVtb3ZlRmxhZ3NbaUtleV0pIHtcclxuICAgICAgICAgICAgbmV3S2V5c1tpTmV3S2V5c10gPSBrZXlzW2lLZXldO1xyXG4gICAgICAgICAgICBuZXdWYWx1ZXNbaU5ld0tleXNdID0gdmFsdWVzW2lLZXldO1xyXG4gICAgICAgICAgICArK2lOZXdLZXlzO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGtleXM6IG5ld0tleXMsXHJcbiAgICAgICAgdmFsdWVzOiBuZXdWYWx1ZXMsXHJcbiAgICB9O1xyXG59XHJcbiJdfQ==