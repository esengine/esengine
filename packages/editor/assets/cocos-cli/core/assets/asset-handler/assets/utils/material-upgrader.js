"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.upgradeProperties = upgradeProperties;
const asset_db_1 = require("@cocos/asset-db");
const fs_extra_1 = require("fs-extra");
const auxMap = { x: 'r', y: 'g', z: 'b', w: 'a', r: 'x', g: 'y', b: 'z', a: 'w' };
function getVectorComponent(v, c) {
    const n1 = v[c];
    const n2 = v[auxMap[c]];
    return n1 !== undefined ? n1 : n2 !== undefined ? n2 : 0;
}
const idxMap = ['x', 'y', 'z', 'w'];
function serializeAsVector(data) {
    const vector = { __type__: 'cc.Vec' + data.length };
    data.forEach((n, i) => (vector[idxMap[i]] = n));
    return vector;
}
const defineRE = /<\s*(\w+)\s*(?:\|\s*(\w+))?\s*>/g;
const targetRE = /(\w+)\s*(?:\.\s*([xyzw]+|[rgba]+))?/i;
function handleFormerlySerializedAs(props, defines, name, target, uuid) {
    // replace define references
    let defCap = defineRE.exec(target);
    let noMoreRouting = false;
    if (defCap && defCap[0].length >= target.length - 1) {
        noMoreRouting = true;
    }
    while (defCap) {
        const replacement = defines[defCap[1]] || defCap[2] || '';
        const beg = defCap.index;
        const end = defCap.index + defCap[0].length;
        target = target.substring(0, beg) + replacement + target.substring(end);
        defineRE.lastIndex = 0;
        defCap = defineRE.exec(target);
    }
    const cap = targetRE.exec(target);
    if (!cap) {
        console.warn(`formerlySerializedAs: illegal target '${target}', upgrade skipped`);
        return false;
    }
    if (!target.endsWith('!') && props[name] !== undefined) {
        return false;
    } // new prop already exists and not in force update mode
    if (noMoreRouting) {
        if (props[name] === target) {
            return false;
        }
        props[name] = target;
        return true;
    }
    const oldValue = props[cap[1]];
    if (oldValue === undefined) {
        return false;
    } // nothing to upgrade
    // semantic check
    const swizzle = (cap[2] && cap[2].toLowerCase()) || '';
    if (swizzle && typeof oldValue !== 'object') {
        console.warn(`formerlySerializedAs: '${target}' expected an object, get ${typeof oldValue} in ${uuid}, upgrade skipped`);
        return false;
    }
    if (swizzle.length > 4) {
        console.warn(`formerlySerializedAs: illegal target '${target}', upgrade skipped`);
        return false;
    }
    if (swizzle.length === 0) {
        // direct map
        props[name] = oldValue;
        delete props[cap[1]];
    }
    else if (swizzle.length === 1) {
        // partial extraction
        props[name] = getVectorComponent(oldValue, swizzle);
    }
    else {
        // partial & swizzled extraction
        const data = swizzle.split('').map((c) => getVectorComponent(oldValue, c));
        props[name] = serializeAsVector(data);
    }
    return true;
}
async function upgradeProperties(material, asset) {
    const uuid = asset.uuid;
    const effectID = material._effectAsset && material._effectAsset.__uuid__;
    let upgraded = false;
    if (!effectID) {
        return false;
    }
    const effectInfo = (0, asset_db_1.queryAsset)(effectID);
    if (!effectInfo || !effectInfo.imported) {
        return false;
    }
    const effectPath = effectInfo.library + '.json';
    if (!(0, fs_extra_1.existsSync)(effectPath)) {
        console.error(`upgradeProperties: the library json of effect(${effectInfo.source}) not found, upgrade skipped`);
        return false;
    }
    const effect = (0, fs_extra_1.readJSONSync)(effectPath);
    const passes = effect.techniques[material._techIdx].passes;
    // user defined migration support
    for (let i = 0; i < passes.length; i++) {
        const pass = passes[i];
        const migrations = pass.migrations;
        if (!migrations) {
            continue;
        }
        const curProps = material._props[i];
        const curDefines = material._defines[i];
        if (migrations.properties && curProps && curDefines) {
            for (const name of Object.keys(migrations.properties)) {
                const target = migrations.properties[name].formerlySerializedAs;
                if (!target) {
                    continue;
                }
                upgraded = handleFormerlySerializedAs(curProps, curDefines, name, target, uuid) || upgraded;
            }
            for (const name of Object.keys(migrations.properties)) {
                if (!migrations.properties[name].removeImmediately) {
                    continue;
                }
                delete curProps[name];
                upgraded = true;
            }
        }
        if (migrations.macros && curDefines) {
            for (const name of Object.keys(migrations.macros)) {
                const target = migrations.macros[name].formerlySerializedAs;
                if (!target) {
                    continue;
                }
                upgraded = handleFormerlySerializedAs(curDefines, curDefines, name, target, uuid) || upgraded;
            }
            for (const name of Object.keys(migrations.macros)) {
                if (!migrations.macros[name].removeImmediately) {
                    continue;
                }
                delete curDefines[name];
                upgraded = true;
            }
        }
    }
    return upgraded;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0ZXJpYWwtdXBncmFkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9hc3NldHMvYXNzZXQtaGFuZGxlci9hc3NldHMvdXRpbHMvbWF0ZXJpYWwtdXBncmFkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUE2RkEsOENBNkRDO0FBMUpELDhDQUFvRDtBQUVwRCx1Q0FBb0Q7QUFFcEQsTUFBTSxNQUFNLEdBQTJCLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7QUFDMUcsU0FBUyxrQkFBa0IsQ0FBQyxDQUF5QixFQUFFLENBQVM7SUFDNUQsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hCLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN4QixPQUFPLEVBQUUsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDN0QsQ0FBQztBQUVELE1BQU0sTUFBTSxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDcEMsU0FBUyxpQkFBaUIsQ0FBQyxJQUFjO0lBQ3JDLE1BQU0sTUFBTSxHQUFRLEVBQUUsUUFBUSxFQUFFLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDekQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDaEQsT0FBTyxNQUFNLENBQUM7QUFDbEIsQ0FBQztBQUVELE1BQU0sUUFBUSxHQUFHLGtDQUFrQyxDQUFDO0FBQ3BELE1BQU0sUUFBUSxHQUFHLHNDQUFzQyxDQUFDO0FBQ3hELFNBQVMsMEJBQTBCLENBQUMsS0FBMEIsRUFBRSxPQUE0QixFQUFFLElBQVksRUFBRSxNQUFjLEVBQUUsSUFBWTtJQUNwSSw0QkFBNEI7SUFDNUIsSUFBSSxNQUFNLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNuQyxJQUFJLGFBQWEsR0FBRyxLQUFLLENBQUM7SUFDMUIsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ2xELGFBQWEsR0FBRyxJQUFJLENBQUM7SUFDekIsQ0FBQztJQUNELE9BQU8sTUFBTSxFQUFFLENBQUM7UUFDWixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUMxRCxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ3pCLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUM1QyxNQUFNLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLEdBQUcsV0FBVyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDeEUsUUFBUSxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUM7UUFDdkIsTUFBTSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUNELE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbEMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ1AsT0FBTyxDQUFDLElBQUksQ0FBQyx5Q0FBeUMsTUFBTSxvQkFBb0IsQ0FBQyxDQUFDO1FBQ2xGLE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7SUFDRCxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssU0FBUyxFQUFFLENBQUM7UUFDckQsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQyxDQUFDLHVEQUF1RDtJQUN6RCxJQUFJLGFBQWEsRUFBRSxDQUFDO1FBQ2hCLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLE1BQU0sRUFBRSxDQUFDO1lBQ3pCLE9BQU8sS0FBSyxDQUFDO1FBQ2pCLENBQUM7UUFDRCxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFDRCxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDL0IsSUFBSSxRQUFRLEtBQUssU0FBUyxFQUFFLENBQUM7UUFDekIsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQyxDQUFDLHFCQUFxQjtJQUN2QixpQkFBaUI7SUFDakIsTUFBTSxPQUFPLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3ZELElBQUksT0FBTyxJQUFJLE9BQU8sUUFBUSxLQUFLLFFBQVEsRUFBRSxDQUFDO1FBQzFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsMEJBQTBCLE1BQU0sNkJBQTZCLE9BQU8sUUFBUSxPQUFPLElBQUksbUJBQW1CLENBQUMsQ0FBQztRQUN6SCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBQ0QsSUFBSSxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ3JCLE9BQU8sQ0FBQyxJQUFJLENBQUMseUNBQXlDLE1BQU0sb0JBQW9CLENBQUMsQ0FBQztRQUNsRixPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBQ0QsSUFBSSxPQUFPLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1FBQ3ZCLGFBQWE7UUFDYixLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsUUFBUSxDQUFDO1FBQ3ZCLE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3pCLENBQUM7U0FBTSxJQUFJLE9BQU8sQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDOUIscUJBQXFCO1FBQ3JCLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxrQkFBa0IsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDeEQsQ0FBQztTQUFNLENBQUM7UUFDSixnQ0FBZ0M7UUFDaEMsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzNFLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMxQyxDQUFDO0lBQ0QsT0FBTyxJQUFJLENBQUM7QUFDaEIsQ0FBQztBQWdCTSxLQUFLLFVBQVUsaUJBQWlCLENBQUMsUUFBYSxFQUFFLEtBQVk7SUFDL0QsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQztJQUN4QixNQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsWUFBWSxJQUFJLFFBQVEsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDO0lBQ3pFLElBQUksUUFBUSxHQUFHLEtBQUssQ0FBQztJQUNyQixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDWixPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBQ0QsTUFBTSxVQUFVLEdBQUcsSUFBQSxxQkFBVSxFQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3hDLElBQUksQ0FBQyxVQUFVLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDdEMsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztJQUNELE1BQU0sVUFBVSxHQUFHLFVBQVUsQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQ2hELElBQUksQ0FBQyxJQUFBLHFCQUFVLEVBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztRQUMxQixPQUFPLENBQUMsS0FBSyxDQUFDLGlEQUFpRCxVQUFVLENBQUMsTUFBTSw4QkFBOEIsQ0FBQyxDQUFDO1FBQ2hILE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7SUFDRCxNQUFNLE1BQU0sR0FBRyxJQUFBLHVCQUFZLEVBQUMsVUFBVSxDQUFnQixDQUFDO0lBQ3ZELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUMzRCxpQ0FBaUM7SUFDakMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUNyQyxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFjLENBQUM7UUFDcEMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztRQUNuQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDZCxTQUFTO1FBQ2IsQ0FBQztRQUNELE1BQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEMsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4QyxJQUFJLFVBQVUsQ0FBQyxVQUFVLElBQUksUUFBUSxJQUFJLFVBQVUsRUFBRSxDQUFDO1lBQ2xELEtBQUssTUFBTSxJQUFJLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztnQkFDcEQsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQztnQkFDaEUsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO29CQUNWLFNBQVM7Z0JBQ2IsQ0FBQztnQkFDRCxRQUFRLEdBQUcsMEJBQTBCLENBQUMsUUFBUSxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxJQUFJLFFBQVEsQ0FBQztZQUNoRyxDQUFDO1lBQ0QsS0FBSyxNQUFNLElBQUksSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO2dCQUNwRCxJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO29CQUNqRCxTQUFTO2dCQUNiLENBQUM7Z0JBQ0QsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3RCLFFBQVEsR0FBRyxJQUFJLENBQUM7WUFDcEIsQ0FBQztRQUNMLENBQUM7UUFDRCxJQUFJLFVBQVUsQ0FBQyxNQUFNLElBQUksVUFBVSxFQUFFLENBQUM7WUFDbEMsS0FBSyxNQUFNLElBQUksSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO2dCQUNoRCxNQUFNLE1BQU0sR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLG9CQUFvQixDQUFDO2dCQUM1RCxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7b0JBQ1YsU0FBUztnQkFDYixDQUFDO2dCQUNELFFBQVEsR0FBRywwQkFBMEIsQ0FBQyxVQUFVLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLElBQUksUUFBUSxDQUFDO1lBQ2xHLENBQUM7WUFDRCxLQUFLLE1BQU0sSUFBSSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7Z0JBQ2hELElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLGlCQUFpQixFQUFFLENBQUM7b0JBQzdDLFNBQVM7Z0JBQ2IsQ0FBQztnQkFDRCxPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDeEIsUUFBUSxHQUFHLElBQUksQ0FBQztZQUNwQixDQUFDO1FBQ0wsQ0FBQztJQUNMLENBQUM7SUFDRCxPQUFPLFFBQVEsQ0FBQztBQUNwQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcXVlcnlBc3NldCwgQXNzZXQgfSBmcm9tICdAY29jb3MvYXNzZXQtZGInO1xyXG5pbXBvcnQgeyBFZmZlY3RBc3NldCB9IGZyb20gJ2NjJztcclxuaW1wb3J0IHsgcmVhZEpTT05TeW5jLCBleGlzdHNTeW5jIH0gZnJvbSAnZnMtZXh0cmEnO1xyXG5cclxuY29uc3QgYXV4TWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0geyB4OiAncicsIHk6ICdnJywgejogJ2InLCB3OiAnYScsIHI6ICd4JywgZzogJ3knLCBiOiAneicsIGE6ICd3JyB9O1xyXG5mdW5jdGlvbiBnZXRWZWN0b3JDb21wb25lbnQodjogUmVjb3JkPHN0cmluZywgbnVtYmVyPiwgYzogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBuMSA9IHZbY107XHJcbiAgICBjb25zdCBuMiA9IHZbYXV4TWFwW2NdXTtcclxuICAgIHJldHVybiBuMSAhPT0gdW5kZWZpbmVkID8gbjEgOiBuMiAhPT0gdW5kZWZpbmVkID8gbjIgOiAwO1xyXG59XHJcblxyXG5jb25zdCBpZHhNYXAgPSBbJ3gnLCAneScsICd6JywgJ3cnXTtcclxuZnVuY3Rpb24gc2VyaWFsaXplQXNWZWN0b3IoZGF0YTogbnVtYmVyW10pIHtcclxuICAgIGNvbnN0IHZlY3RvcjogYW55ID0geyBfX3R5cGVfXzogJ2NjLlZlYycgKyBkYXRhLmxlbmd0aCB9O1xyXG4gICAgZGF0YS5mb3JFYWNoKChuLCBpKSA9PiAodmVjdG9yW2lkeE1hcFtpXV0gPSBuKSk7XHJcbiAgICByZXR1cm4gdmVjdG9yO1xyXG59XHJcblxyXG5jb25zdCBkZWZpbmVSRSA9IC88XFxzKihcXHcrKVxccyooPzpcXHxcXHMqKFxcdyspKT9cXHMqPi9nO1xyXG5jb25zdCB0YXJnZXRSRSA9IC8oXFx3KylcXHMqKD86XFwuXFxzKihbeHl6d10rfFtyZ2JhXSspKT8vaTtcclxuZnVuY3Rpb24gaGFuZGxlRm9ybWVybHlTZXJpYWxpemVkQXMocHJvcHM6IFJlY29yZDxzdHJpbmcsIGFueT4sIGRlZmluZXM6IFJlY29yZDxzdHJpbmcsIGFueT4sIG5hbWU6IHN0cmluZywgdGFyZ2V0OiBzdHJpbmcsIHV1aWQ6IHN0cmluZykge1xyXG4gICAgLy8gcmVwbGFjZSBkZWZpbmUgcmVmZXJlbmNlc1xyXG4gICAgbGV0IGRlZkNhcCA9IGRlZmluZVJFLmV4ZWModGFyZ2V0KTtcclxuICAgIGxldCBub01vcmVSb3V0aW5nID0gZmFsc2U7XHJcbiAgICBpZiAoZGVmQ2FwICYmIGRlZkNhcFswXS5sZW5ndGggPj0gdGFyZ2V0Lmxlbmd0aCAtIDEpIHtcclxuICAgICAgICBub01vcmVSb3V0aW5nID0gdHJ1ZTtcclxuICAgIH1cclxuICAgIHdoaWxlIChkZWZDYXApIHtcclxuICAgICAgICBjb25zdCByZXBsYWNlbWVudCA9IGRlZmluZXNbZGVmQ2FwWzFdXSB8fCBkZWZDYXBbMl0gfHwgJyc7XHJcbiAgICAgICAgY29uc3QgYmVnID0gZGVmQ2FwLmluZGV4O1xyXG4gICAgICAgIGNvbnN0IGVuZCA9IGRlZkNhcC5pbmRleCArIGRlZkNhcFswXS5sZW5ndGg7XHJcbiAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnN1YnN0cmluZygwLCBiZWcpICsgcmVwbGFjZW1lbnQgKyB0YXJnZXQuc3Vic3RyaW5nKGVuZCk7XHJcbiAgICAgICAgZGVmaW5lUkUubGFzdEluZGV4ID0gMDtcclxuICAgICAgICBkZWZDYXAgPSBkZWZpbmVSRS5leGVjKHRhcmdldCk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBjYXAgPSB0YXJnZXRSRS5leGVjKHRhcmdldCk7XHJcbiAgICBpZiAoIWNhcCkge1xyXG4gICAgICAgIGNvbnNvbGUud2FybihgZm9ybWVybHlTZXJpYWxpemVkQXM6IGlsbGVnYWwgdGFyZ2V0ICcke3RhcmdldH0nLCB1cGdyYWRlIHNraXBwZWRgKTtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBpZiAoIXRhcmdldC5lbmRzV2l0aCgnIScpICYmIHByb3BzW25hbWVdICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9IC8vIG5ldyBwcm9wIGFscmVhZHkgZXhpc3RzIGFuZCBub3QgaW4gZm9yY2UgdXBkYXRlIG1vZGVcclxuICAgIGlmIChub01vcmVSb3V0aW5nKSB7XHJcbiAgICAgICAgaWYgKHByb3BzW25hbWVdID09PSB0YXJnZXQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBwcm9wc1tuYW1lXSA9IHRhcmdldDtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICAgIGNvbnN0IG9sZFZhbHVlID0gcHJvcHNbY2FwWzFdXTtcclxuICAgIGlmIChvbGRWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfSAvLyBub3RoaW5nIHRvIHVwZ3JhZGVcclxuICAgIC8vIHNlbWFudGljIGNoZWNrXHJcbiAgICBjb25zdCBzd2l6emxlID0gKGNhcFsyXSAmJiBjYXBbMl0udG9Mb3dlckNhc2UoKSkgfHwgJyc7XHJcbiAgICBpZiAoc3dpenpsZSAmJiB0eXBlb2Ygb2xkVmFsdWUgIT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgY29uc29sZS53YXJuKGBmb3JtZXJseVNlcmlhbGl6ZWRBczogJyR7dGFyZ2V0fScgZXhwZWN0ZWQgYW4gb2JqZWN0LCBnZXQgJHt0eXBlb2Ygb2xkVmFsdWV9IGluICR7dXVpZH0sIHVwZ3JhZGUgc2tpcHBlZGApO1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGlmIChzd2l6emxlLmxlbmd0aCA+IDQpIHtcclxuICAgICAgICBjb25zb2xlLndhcm4oYGZvcm1lcmx5U2VyaWFsaXplZEFzOiBpbGxlZ2FsIHRhcmdldCAnJHt0YXJnZXR9JywgdXBncmFkZSBza2lwcGVkYCk7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgaWYgKHN3aXp6bGUubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgLy8gZGlyZWN0IG1hcFxyXG4gICAgICAgIHByb3BzW25hbWVdID0gb2xkVmFsdWU7XHJcbiAgICAgICAgZGVsZXRlIHByb3BzW2NhcFsxXV07XHJcbiAgICB9IGVsc2UgaWYgKHN3aXp6bGUubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgLy8gcGFydGlhbCBleHRyYWN0aW9uXHJcbiAgICAgICAgcHJvcHNbbmFtZV0gPSBnZXRWZWN0b3JDb21wb25lbnQob2xkVmFsdWUsIHN3aXp6bGUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICAvLyBwYXJ0aWFsICYgc3dpenpsZWQgZXh0cmFjdGlvblxyXG4gICAgICAgIGNvbnN0IGRhdGEgPSBzd2l6emxlLnNwbGl0KCcnKS5tYXAoKGMpID0+IGdldFZlY3RvckNvbXBvbmVudChvbGRWYWx1ZSwgYykpO1xyXG4gICAgICAgIHByb3BzW25hbWVdID0gc2VyaWFsaXplQXNWZWN0b3IoZGF0YSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxufVxyXG5cclxuaW50ZXJmYWNlIElNaWdyYXRpb24ge1xyXG4gICAgZm9ybWVybHlTZXJpYWxpemVkQXM/OiBzdHJpbmc7XHJcbiAgICByZW1vdmVJbW1lZGlhdGVseT86IGJvb2xlYW47XHJcbn1cclxuXHJcbnR5cGUgQ0NQYXNzSW5mbyA9IEVmZmVjdEFzc2V0Wyd0ZWNobmlxdWVzJ11bMF1bJ3Bhc3NlcyddWzBdO1xyXG5cclxuaW50ZXJmYWNlIElQYXNzSW5mbyBleHRlbmRzIENDUGFzc0luZm8ge1xyXG4gICAgbWlncmF0aW9uczoge1xyXG4gICAgICAgIG1hY3JvczogUmVjb3JkPHN0cmluZywgSU1pZ3JhdGlvbj47XHJcbiAgICAgICAgcHJvcGVydGllczogUmVjb3JkPHN0cmluZywgSU1pZ3JhdGlvbj47XHJcbiAgICB9O1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBncmFkZVByb3BlcnRpZXMobWF0ZXJpYWw6IGFueSwgYXNzZXQ6IEFzc2V0KSB7XHJcbiAgICBjb25zdCB1dWlkID0gYXNzZXQudXVpZDtcclxuICAgIGNvbnN0IGVmZmVjdElEID0gbWF0ZXJpYWwuX2VmZmVjdEFzc2V0ICYmIG1hdGVyaWFsLl9lZmZlY3RBc3NldC5fX3V1aWRfXztcclxuICAgIGxldCB1cGdyYWRlZCA9IGZhbHNlO1xyXG4gICAgaWYgKCFlZmZlY3RJRCkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGNvbnN0IGVmZmVjdEluZm8gPSBxdWVyeUFzc2V0KGVmZmVjdElEKTtcclxuICAgIGlmICghZWZmZWN0SW5mbyB8fCAhZWZmZWN0SW5mby5pbXBvcnRlZCkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGNvbnN0IGVmZmVjdFBhdGggPSBlZmZlY3RJbmZvLmxpYnJhcnkgKyAnLmpzb24nO1xyXG4gICAgaWYgKCFleGlzdHNTeW5jKGVmZmVjdFBhdGgpKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcihgdXBncmFkZVByb3BlcnRpZXM6IHRoZSBsaWJyYXJ5IGpzb24gb2YgZWZmZWN0KCR7ZWZmZWN0SW5mby5zb3VyY2V9KSBub3QgZm91bmQsIHVwZ3JhZGUgc2tpcHBlZGApO1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGNvbnN0IGVmZmVjdCA9IHJlYWRKU09OU3luYyhlZmZlY3RQYXRoKSBhcyBFZmZlY3RBc3NldDtcclxuICAgIGNvbnN0IHBhc3NlcyA9IGVmZmVjdC50ZWNobmlxdWVzW21hdGVyaWFsLl90ZWNoSWR4XS5wYXNzZXM7XHJcbiAgICAvLyB1c2VyIGRlZmluZWQgbWlncmF0aW9uIHN1cHBvcnRcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFzc2VzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgY29uc3QgcGFzcyA9IHBhc3Nlc1tpXSBhcyBJUGFzc0luZm87XHJcbiAgICAgICAgY29uc3QgbWlncmF0aW9ucyA9IHBhc3MubWlncmF0aW9ucztcclxuICAgICAgICBpZiAoIW1pZ3JhdGlvbnMpIHtcclxuICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGN1clByb3BzID0gbWF0ZXJpYWwuX3Byb3BzW2ldO1xyXG4gICAgICAgIGNvbnN0IGN1ckRlZmluZXMgPSBtYXRlcmlhbC5fZGVmaW5lc1tpXTtcclxuICAgICAgICBpZiAobWlncmF0aW9ucy5wcm9wZXJ0aWVzICYmIGN1clByb3BzICYmIGN1ckRlZmluZXMpIHtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBuYW1lIG9mIE9iamVjdC5rZXlzKG1pZ3JhdGlvbnMucHJvcGVydGllcykpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG1pZ3JhdGlvbnMucHJvcGVydGllc1tuYW1lXS5mb3JtZXJseVNlcmlhbGl6ZWRBcztcclxuICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB1cGdyYWRlZCA9IGhhbmRsZUZvcm1lcmx5U2VyaWFsaXplZEFzKGN1clByb3BzLCBjdXJEZWZpbmVzLCBuYW1lLCB0YXJnZXQsIHV1aWQpIHx8IHVwZ3JhZGVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgbmFtZSBvZiBPYmplY3Qua2V5cyhtaWdyYXRpb25zLnByb3BlcnRpZXMpKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIW1pZ3JhdGlvbnMucHJvcGVydGllc1tuYW1lXS5yZW1vdmVJbW1lZGlhdGVseSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZGVsZXRlIGN1clByb3BzW25hbWVdO1xyXG4gICAgICAgICAgICAgICAgdXBncmFkZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtaWdyYXRpb25zLm1hY3JvcyAmJiBjdXJEZWZpbmVzKSB7XHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgbmFtZSBvZiBPYmplY3Qua2V5cyhtaWdyYXRpb25zLm1hY3JvcykpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG1pZ3JhdGlvbnMubWFjcm9zW25hbWVdLmZvcm1lcmx5U2VyaWFsaXplZEFzO1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHVwZ3JhZGVkID0gaGFuZGxlRm9ybWVybHlTZXJpYWxpemVkQXMoY3VyRGVmaW5lcywgY3VyRGVmaW5lcywgbmFtZSwgdGFyZ2V0LCB1dWlkKSB8fCB1cGdyYWRlZDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IG5hbWUgb2YgT2JqZWN0LmtleXMobWlncmF0aW9ucy5tYWNyb3MpKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIW1pZ3JhdGlvbnMubWFjcm9zW25hbWVdLnJlbW92ZUltbWVkaWF0ZWx5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBkZWxldGUgY3VyRGVmaW5lc1tuYW1lXTtcclxuICAgICAgICAgICAgICAgIHVwZ3JhZGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiB1cGdyYWRlZDtcclxufVxyXG4iXX0=