"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.migrationHook = exports.Archive = void 0;
const fs_extra_1 = __importDefault(require("fs-extra"));
const archiveProxyWatchedTag = Symbol('ArchiveProxyWatched');
class Archive {
    constructor(data = null) {
        deIndex(data, data);
        this._originalData = data;
        this._root = Array.isArray(data) ? data[0] : data;
        const proxyHandler = {
            get(target, property, receiver) {
                if (property === archiveProxyWatchedTag) {
                    return target;
                }
                const value = Reflect.get(target, property, receiver);
                if (value === null || value === undefined || typeof value !== 'object') {
                    return value;
                }
                const v = value[refTag] !== undefined ? value[refTag] : value;
                return new Proxy(v, proxyHandler);
            },
            set(target, property, value, receiver) {
                const realValue = typeof value === 'object' && value ? value[archiveProxyWatchedTag] ?? value : value;
                const v = !Array.isArray(value) && typeof value === 'object' && value ? { [refTag]: realValue } : realValue;
                return Reflect.set(target, property, v, receiver);
            },
        };
        this._proxyHandler = proxyHandler;
    }
    get root() {
        return new Proxy(this._root, this._proxyHandler);
    }
    get(value) {
        const object = typeof value === 'object' && value ? value[archiveProxyWatchedTag] ?? value : this._root;
        const objects = [object];
        reIndex(object, objects);
        return objects.length === 1 ? objects[0] : objects;
    }
    addObject() {
        return new Proxy({}, this._proxyHandler);
    }
    addTypedObject(typeName) {
        return new Proxy({ __type__: typeName }, this._proxyHandler);
    }
    visitTypedObject(className, visitor) {
        const visited = new Set();
        this._visitTypedObject(className, visitor, this._root, visited);
    }
    clearObject(object) {
        const keys = Object.keys(object);
        for (const key of keys) {
            switch (key) {
                case '__type__':
                    break;
                default:
                    delete object[key];
                    break;
            }
        }
    }
    _root;
    _originalData;
    _proxyHandler;
    _visitTypedObject(className, visitor, object, visited) {
        if (Array.isArray(object)) {
            object.forEach((child) => {
                this._visitTypedObject(className, visitor, child, visited);
            });
        }
        else if (object && typeof object === 'object') {
            if (object[refTag]) {
                this._visitTypedObject(className, visitor, object[refTag], visited);
            }
            else if (!visited.has(object)) {
                visited.add(object);
                const type = object.__type__;
                if (type === className) {
                    visitor(new Proxy(object, this._proxyHandler));
                }
                for (const value of Object.values(object)) {
                    this._visitTypedObject(className, visitor, value, visited);
                }
            }
        }
    }
}
exports.Archive = Archive;
const refTag = Symbol('Ref');
function deIndex(value, file) {
    if (Array.isArray(value)) {
        value.forEach((element) => {
            deIndex(element, file);
        });
    }
    else if (value && typeof value === 'object') {
        const ref = value;
        if (typeof ref.__id__ === 'number') {
            const id = ref.__id__;
            ref[refTag] = file[id];
        }
        else {
            Object.values(value).forEach((propertyValue) => deIndex(propertyValue, file));
        }
    }
}
function reIndex(value, objects) {
    if (Array.isArray(value)) {
        value.forEach((element) => {
            reIndex(element, objects);
        });
    }
    else if (value && typeof value === 'object') {
        const ref = value;
        const object = ref[refTag];
        if (object) {
            const id = objects.indexOf(object);
            if (id >= 0) {
                ref.__id__ = id;
            }
            else {
                ref.__id__ = objects.length;
                objects.push(object);
                reIndex(object, objects);
            }
        }
        else {
            Object.values(value).forEach((propertyValue) => reIndex(propertyValue, objects));
        }
    }
}
/**
 * version: 这个版本之前的 scene Handler 都会进行迁移
 * migrate: 在导入前执行的迁移的动作
 */
exports.migrationHook = {
    async pre(asset) {
        const swap = asset.getSwapSpace();
        swap.json = await fs_extra_1.default.readJSON(asset.source);
    },
    async post(asset, num) {
        const swap = asset.getSwapSpace();
        if (num > 0) {
            // 请勿使用 writeJson，因为这个接口会在末尾增加空行
            const json = JSON.stringify(swap.json, null, 2);
            await fs_extra_1.default.writeFile(asset.source, json);
        }
        delete swap.json;
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWlncmF0aW9uLXV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvYXNzZXRzL2Fzc2V0LWhhbmRsZXIvYXNzZXRzL3V0aWxzL21pZ3JhdGlvbi11dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQSx3REFBMEI7QUFJMUIsTUFBTSxzQkFBc0IsR0FBRyxNQUFNLENBQUMscUJBQXFCLENBQUMsQ0FBQztBQUU3RCxNQUFhLE9BQU87SUFDaEIsWUFBWSxPQUFnQixJQUFJO1FBQzVCLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDcEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7UUFDMUIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUNsRCxNQUFNLFlBQVksR0FBeUI7WUFDdkMsR0FBRyxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsUUFBUTtnQkFDMUIsSUFBSSxRQUFRLEtBQUssc0JBQXNCLEVBQUUsQ0FBQztvQkFDdEMsT0FBTyxNQUFNLENBQUM7Z0JBQ2xCLENBQUM7Z0JBQ0QsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO2dCQUN0RCxJQUFJLEtBQUssS0FBSyxJQUFJLElBQUksS0FBSyxLQUFLLFNBQVMsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUUsQ0FBQztvQkFDckUsT0FBTyxLQUFLLENBQUM7Z0JBQ2pCLENBQUM7Z0JBQ0QsTUFBTSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FB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TSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzNDLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDckIsQ0FBQztDQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBc3NldCB9IGZyb20gJ0Bjb2Nvcy9hc3NldC1kYic7XHJcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XHJcblxyXG50eXBlIFR5cGVkT2JqZWN0VmlzaXRvciA9IChzZXJpYWxpemVkOiBhbnkpID0+IHZvaWQ7XHJcblxyXG5jb25zdCBhcmNoaXZlUHJveHlXYXRjaGVkVGFnID0gU3ltYm9sKCdBcmNoaXZlUHJveHlXYXRjaGVkJyk7XHJcblxyXG5leHBvcnQgY2xhc3MgQXJjaGl2ZSB7XHJcbiAgICBjb25zdHJ1Y3RvcihkYXRhOiB1bmtub3duID0gbnVsbCkge1xyXG4gICAgICAgIGRlSW5kZXgoZGF0YSwgZGF0YSk7XHJcbiAgICAgICAgdGhpcy5fb3JpZ2luYWxEYXRhID0gZGF0YTtcclxuICAgICAgICB0aGlzLl9yb290ID0gQXJyYXkuaXNBcnJheShkYXRhKSA/IGRhdGFbMF0gOiBkYXRhO1xyXG4gICAgICAgIGNvbnN0IHByb3h5SGFuZGxlcjogUHJveHlIYW5kbGVyPG9iamVjdD4gPSB7XHJcbiAgICAgICAgICAgIGdldCh0YXJnZXQsIHByb3BlcnR5LCByZWNlaXZlcikge1xyXG4gICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5ID09PSBhcmNoaXZlUHJveHlXYXRjaGVkVGFnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gUmVmbGVjdC5nZXQodGFyZ2V0LCBwcm9wZXJ0eSwgcmVjZWl2ZXIpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQgfHwgdHlwZW9mIHZhbHVlICE9PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNvbnN0IHYgPSB2YWx1ZVtyZWZUYWddICE9PSB1bmRlZmluZWQgPyB2YWx1ZVtyZWZUYWddIDogdmFsdWU7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb3h5KHYsIHByb3h5SGFuZGxlcik7XHJcbiAgICAgICAgICAgIH0sXHJcblxyXG4gICAgICAgICAgICBzZXQodGFyZ2V0LCBwcm9wZXJ0eSwgdmFsdWUsIHJlY2VpdmVyKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZWFsVmFsdWUgPSB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmIHZhbHVlID8gdmFsdWVbYXJjaGl2ZVByb3h5V2F0Y2hlZFRhZ10gPz8gdmFsdWUgOiB2YWx1ZTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHYgPSAhQXJyYXkuaXNBcnJheSh2YWx1ZSkgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiB2YWx1ZSA/IHsgW3JlZlRhZ106IHJlYWxWYWx1ZSB9IDogcmVhbFZhbHVlO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFJlZmxlY3Quc2V0KHRhcmdldCwgcHJvcGVydHksIHYsIHJlY2VpdmVyKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuX3Byb3h5SGFuZGxlciA9IHByb3h5SGFuZGxlcjtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgcm9vdCgpIHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb3h5KHRoaXMuX3Jvb3QsIHRoaXMuX3Byb3h5SGFuZGxlcik7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldCh2YWx1ZT86IG9iamVjdCkge1xyXG4gICAgICAgIGNvbnN0IG9iamVjdCA9IHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgdmFsdWUgPyAodmFsdWUgYXMgYW55KVthcmNoaXZlUHJveHlXYXRjaGVkVGFnXSA/PyB2YWx1ZSA6IHRoaXMuX3Jvb3Q7XHJcbiAgICAgICAgY29uc3Qgb2JqZWN0czogdW5rbm93bltdID0gW29iamVjdF07XHJcbiAgICAgICAgcmVJbmRleChvYmplY3QsIG9iamVjdHMpO1xyXG4gICAgICAgIHJldHVybiBvYmplY3RzLmxlbmd0aCA9PT0gMSA/IG9iamVjdHNbMF0gOiBvYmplY3RzO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhZGRPYmplY3QoKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm94eSh7fSwgdGhpcy5fcHJveHlIYW5kbGVyKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYWRkVHlwZWRPYmplY3QodHlwZU5hbWU6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJveHkoeyBfX3R5cGVfXzogdHlwZU5hbWUgfSwgdGhpcy5fcHJveHlIYW5kbGVyKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgdmlzaXRUeXBlZE9iamVjdChjbGFzc05hbWU6IHN0cmluZywgdmlzaXRvcjogVHlwZWRPYmplY3RWaXNpdG9yKSB7XHJcbiAgICAgICAgY29uc3QgdmlzaXRlZCA9IG5ldyBTZXQ8b2JqZWN0PigpO1xyXG4gICAgICAgIHRoaXMuX3Zpc2l0VHlwZWRPYmplY3QoY2xhc3NOYW1lLCB2aXNpdG9yLCB0aGlzLl9yb290LCB2aXNpdGVkKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY2xlYXJPYmplY3Qob2JqZWN0OiBvYmplY3QpIHtcclxuICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMob2JqZWN0KTtcclxuICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XHJcbiAgICAgICAgICAgIHN3aXRjaCAoa2V5KSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdfX3R5cGVfXyc6XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSAob2JqZWN0IGFzIGFueSlba2V5XTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9yb290OiBvYmplY3Q7XHJcbiAgICBwcml2YXRlIF9vcmlnaW5hbERhdGE6IHVua25vd247XHJcbiAgICBwcml2YXRlIF9wcm94eUhhbmRsZXI6IFByb3h5SGFuZGxlcjxvYmplY3Q+O1xyXG5cclxuICAgIHByaXZhdGUgX3Zpc2l0VHlwZWRPYmplY3QoY2xhc3NOYW1lOiBzdHJpbmcsIHZpc2l0b3I6IFR5cGVkT2JqZWN0VmlzaXRvciwgb2JqZWN0OiB1bmtub3duLCB2aXNpdGVkOiBTZXQ8b2JqZWN0Pikge1xyXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KG9iamVjdCkpIHtcclxuICAgICAgICAgICAgb2JqZWN0LmZvckVhY2goKGNoaWxkOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3Zpc2l0VHlwZWRPYmplY3QoY2xhc3NOYW1lLCB2aXNpdG9yLCBjaGlsZCwgdmlzaXRlZCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSBpZiAob2JqZWN0ICYmIHR5cGVvZiBvYmplY3QgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgIGlmICgob2JqZWN0IGFzIGFueSlbcmVmVGFnXSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fdmlzaXRUeXBlZE9iamVjdChjbGFzc05hbWUsIHZpc2l0b3IsIChvYmplY3QgYXMgYW55KVtyZWZUYWddLCB2aXNpdGVkKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmICghdmlzaXRlZC5oYXMob2JqZWN0KSkge1xyXG4gICAgICAgICAgICAgICAgdmlzaXRlZC5hZGQob2JqZWN0KTtcclxuICAgICAgICAgICAgICAgIHR5cGUgTWF5YmVUeXBlZCA9IHsgX190eXBlX18/OiBzdHJpbmcgfTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHR5cGUgPSAob2JqZWN0IGFzIE1heWJlVHlwZWQpLl9fdHlwZV9fO1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IGNsYXNzTmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZpc2l0b3IobmV3IFByb3h5KG9iamVjdCwgdGhpcy5fcHJveHlIYW5kbGVyKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIE9iamVjdC52YWx1ZXMob2JqZWN0KSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3Zpc2l0VHlwZWRPYmplY3QoY2xhc3NOYW1lLCB2aXNpdG9yLCB2YWx1ZSwgdmlzaXRlZCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmNvbnN0IHJlZlRhZyA9IFN5bWJvbCgnUmVmJyk7XHJcblxyXG5mdW5jdGlvbiBkZUluZGV4KHZhbHVlOiB1bmtub3duLCBmaWxlOiB1bmtub3duKSB7XHJcbiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcclxuICAgICAgICB2YWx1ZS5mb3JFYWNoKChlbGVtZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGRlSW5kZXgoZWxlbWVudCwgZmlsZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9IGVsc2UgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICBjb25zdCByZWYgPSB2YWx1ZSBhcyB7IF9faWRfXz86IG51bWJlcjtbcmVmVGFnXTogb2JqZWN0IH07XHJcbiAgICAgICAgaWYgKHR5cGVvZiByZWYuX19pZF9fID09PSAnbnVtYmVyJykge1xyXG4gICAgICAgICAgICBjb25zdCBpZCA9IHJlZi5fX2lkX187XHJcbiAgICAgICAgICAgIHJlZltyZWZUYWddID0gKGZpbGUgYXMgb2JqZWN0W10pW2lkXTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBPYmplY3QudmFsdWVzKHZhbHVlKS5mb3JFYWNoKChwcm9wZXJ0eVZhbHVlKSA9PiBkZUluZGV4KHByb3BlcnR5VmFsdWUsIGZpbGUpKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlSW5kZXgodmFsdWU6IHVua25vd24sIG9iamVjdHM6IHVua25vd25bXSkge1xyXG4gICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XHJcbiAgICAgICAgdmFsdWUuZm9yRWFjaCgoZWxlbWVudCkgPT4ge1xyXG4gICAgICAgICAgICByZUluZGV4KGVsZW1lbnQsIG9iamVjdHMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSBlbHNlIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgY29uc3QgcmVmID0gdmFsdWUgYXMgeyBfX2lkX186IG51bWJlcjtbcmVmVGFnXT86IG9iamVjdCB9O1xyXG4gICAgICAgIGNvbnN0IG9iamVjdCA9IHJlZltyZWZUYWddO1xyXG4gICAgICAgIGlmIChvYmplY3QpIHtcclxuICAgICAgICAgICAgY29uc3QgaWQgPSBvYmplY3RzLmluZGV4T2Yob2JqZWN0KTtcclxuICAgICAgICAgICAgaWYgKGlkID49IDApIHtcclxuICAgICAgICAgICAgICAgIHJlZi5fX2lkX18gPSBpZDtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJlZi5fX2lkX18gPSBvYmplY3RzLmxlbmd0aDtcclxuICAgICAgICAgICAgICAgIG9iamVjdHMucHVzaChvYmplY3QpO1xyXG4gICAgICAgICAgICAgICAgcmVJbmRleChvYmplY3QsIG9iamVjdHMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyh2YWx1ZSkuZm9yRWFjaCgocHJvcGVydHlWYWx1ZSkgPT4gcmVJbmRleChwcm9wZXJ0eVZhbHVlLCBvYmplY3RzKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIE1pZ3JhdGlvblN3YXBTcGFjZSB7XHJcbiAgICBqc29uOiB1bmtub3duO1xyXG59XHJcblxyXG4vKipcclxuICogdmVyc2lvbjog6L+Z5Liq54mI5pys5LmL5YmN55qEIHNjZW5lIEhhbmRsZXIg6YO95Lya6L+b6KGM6L+B56e7XHJcbiAqIG1pZ3JhdGU6IOWcqOWvvOWFpeWJjeaJp+ihjOeahOi/geenu+eahOWKqOS9nFxyXG4gKi9cclxuXHJcbmV4cG9ydCBjb25zdCBtaWdyYXRpb25Ib29rID0ge1xyXG4gICAgYXN5bmMgcHJlKGFzc2V0OiBBc3NldCkge1xyXG4gICAgICAgIGNvbnN0IHN3YXAgPSBhc3NldC5nZXRTd2FwU3BhY2U8TWlncmF0aW9uU3dhcFNwYWNlPigpO1xyXG4gICAgICAgIHN3YXAuanNvbiA9IGF3YWl0IGZzLnJlYWRKU09OKGFzc2V0LnNvdXJjZSk7XHJcbiAgICB9LFxyXG4gICAgYXN5bmMgcG9zdChhc3NldDogQXNzZXQsIG51bTogbnVtYmVyKSB7XHJcbiAgICAgICAgY29uc3Qgc3dhcCA9IGFzc2V0LmdldFN3YXBTcGFjZTxNaWdyYXRpb25Td2FwU3BhY2U+KCk7XHJcbiAgICAgICAgaWYgKG51bSA+IDApIHtcclxuICAgICAgICAgICAgLy8g6K+35Yu/5L2/55SoIHdyaXRlSnNvbu+8jOWboOS4uui/meS4quaOpeWPo+S8muWcqOacq+WwvuWinuWKoOepuuihjFxyXG4gICAgICAgICAgICBjb25zdCBqc29uID0gSlNPTi5zdHJpbmdpZnkoc3dhcC5qc29uLCBudWxsLCAyKTtcclxuICAgICAgICAgICAgYXdhaXQgZnMud3JpdGVGaWxlKGFzc2V0LnNvdXJjZSwganNvbik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGRlbGV0ZSBzd2FwLmpzb247XHJcbiAgICB9LFxyXG59O1xyXG4iXX0=