'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.walk = walk;
exports.walkAsync = walkAsync;
exports.getComponent = getComponent;
exports.walkNode = walkNode;
exports.walkNodeAsync = walkNodeAsync;
exports.getPrefabOfNode = getPrefabOfNode;
exports.isNestedPrefab = isNestedPrefab;
exports.walkPrefabInstances = walkPrefabInstances;
const asset_db_1 = require("@cocos/asset-db");
const fs_extra_1 = require("fs-extra");
const fs_1 = require("fs");
/**
 * 遍历每一个对象，找到带有 uuid 的 object 并执行 handle
 * @param object
 * @param handle
 */
function walk(object, handle) {
    if (Array.isArray(object)) {
        for (const child of object) {
            walk(child, handle);
        }
    }
    else if (object && typeof object === 'object') {
        if ('__uuid__' in object) {
            handle(object);
        }
        else {
            for (const value of Object.values(object)) {
                walk(value, handle);
            }
        }
    }
}
async function walkAsync(object, handle) {
    if (Array.isArray(object)) {
        for (const child of object) {
            await walk(child, handle);
        }
    }
    else if (object && typeof object === 'object') {
        if ('__uuid__' in object) {
            await handle(object);
        }
        else {
            for (const value of Object.values(object)) {
                await walk(value, handle);
            }
        }
    }
}
/**
 * 查找一个 json 里面的 component
 * @param json
 * @param nodeIdx
 * @param compRE
 */
function getComponent(json, nodeIdx, compRE) {
    if (typeof nodeIdx !== 'number' || nodeIdx < 0) {
        return null;
    }
    const comps = json[nodeIdx]._components;
    for (const compIdx of comps) {
        const comp = json[compIdx.__id__];
        if (compRE.test(comp.__type__)) {
            return comp;
        }
    }
    return null;
}
/**
 * 遍历节点和它的子节点
 * @param json
 * @param nodeIdx
 * @param processFunc
 * @returns
 */
function walkNode(json, nodeRef, processFunc) {
    if (!nodeRef || typeof nodeRef.__id__ !== 'number' || nodeRef.__id__ < 0) {
        return;
    }
    const nodeJson = json[nodeRef.__id__];
    processFunc(nodeJson, nodeRef);
    if (nodeJson._children) {
        nodeJson._children.forEach((childObj) => {
            walkNode(json, childObj, processFunc);
        });
    }
}
/**
 * 遍历节点和它的子节点
 * @param json
 * @param nodeIdx
 * @param processFunc
 * @returns
 */
async function walkNodeAsync(json, nodeRef, processFunc) {
    if (!nodeRef || typeof nodeRef.__id__ !== 'number' || nodeRef.__id__ < 0) {
        return;
    }
    const nodeJson = json[nodeRef.__id__];
    await processFunc(nodeJson, nodeRef);
    if (nodeJson._children) {
        for (let index = 0; index < nodeJson._children.length; index++) {
            const childObj = nodeJson._children[index];
            await walkNodeAsync(json, childObj, processFunc);
        }
    }
}
/**
 * 通过__id__获取node的prefab信息
 * @param json
 */
function getPrefabOfNode(id, json) {
    if (id && json[id]) {
        const node = json[id];
        if (node && node.__type__ === 'cc.Node') {
            const prefabId = node._prefab?.__id__;
            if (prefabId && json[prefabId]) {
                return json[prefabId];
            }
        }
    }
}
function isNestedPrefab(node, json, prefabUuid) {
    if (node?._prefab?.__id__ && json[node._prefab.__id__]?.asset?.__uuid__) {
        // 部分prefab子节点存在索引自己的问题，需要过滤掉
        return json[node._prefab.__id__]?.asset?.__uuid__ !== prefabUuid;
    }
    return false;
}
const walkPrefabInstanceChildren = async function (children, json, sceneAsset, callback, prefabUuid) {
    for (let index = 0; index < children.length; index++) {
        const childRef = children[index];
        await walkNodeAsync(json, childRef, async (childJson, _) => {
            if (isNestedPrefab(childJson, json, prefabUuid)) {
                await walkPrefabInstances(childJson, json, sceneAsset, callback);
            }
            else {
                callback(childJson);
                if (childJson._components) {
                    childJson._components.forEach((componentRef) => {
                        const component = json[componentRef.__id__];
                        if (component) {
                            callback(component);
                        }
                    });
                }
            }
        });
    }
};
/**
 * 遍历嵌套预制体实例的所有节点和组件
 * @param node 预制体所在节点json
 * @param json 场景jsonscene
 */
async function walkPrefabInstances(node, json, sceneAsset, callback) {
    if (!node?._prefab?.__id__)
        return;
    // 根节点
    callback(node, json);
    const prefab = json[node._prefab.__id__];
    const uuid = prefab?.asset?.__uuid__;
    if (!uuid)
        return;
    const asset = (0, asset_db_1.queryAsset)(uuid);
    if (asset && asset.source) {
        let prefabJson = [];
        let file;
        if (asset.source.includes('@')) {
            if (!asset.init) {
                asset._assetDB.taskManager.pause(sceneAsset.task);
                await asset.waitInit();
                asset._assetDB.taskManager.resume(sceneAsset.task);
            }
            file = asset.library + '.json';
        }
        else {
            file = asset.source;
        }
        if ((0, fs_1.existsSync)(file)) {
            try {
                prefabJson = (0, fs_extra_1.readJSONSync)(file);
            }
            catch (error) {
                console.warn(error);
            }
        }
        if (!prefabJson[0] || !prefabJson[0]?.data?.__id__)
            return;
        // 遍历prefabJson的子节点和组件
        const root = prefabJson[prefabJson[0].data.__id__];
        if (root?._children) {
            await walkPrefabInstanceChildren(root._children, prefabJson, sceneAsset, callback, uuid);
        }
        if (root?._components) {
            root._components.forEach((componentRef) => {
                const component = prefabJson[componentRef.__id__];
                if (component) {
                    callback(component);
                }
            });
        }
    }
    // 遍历mountedChildrenNComponent
    const instanceID = prefab?.instance?.__id__;
    if (instanceID && json[instanceID]) {
        const instance = json[instanceID];
        if (instance.mountedChildren && instance.mountedChildren.length > 0) {
            const childrenRefs = [];
            instance.mountedChildren.forEach((infoRef) => {
                const info = json[infoRef.__id__];
                if (info && info.nodes) {
                    for (const node of info.nodes) {
                        childrenRefs.push(node);
                    }
                }
            });
            await walkPrefabInstanceChildren(childrenRefs, json, sceneAsset, callback, uuid);
        }
        if (instance.mountedComponents && instance.mountedComponents.length > 0) {
            instance.mountedComponents.forEach((infoRef) => {
                const info = json[infoRef.__id__];
                if (info && info.components) {
                    for (const component of info.components) {
                        if (component.__id__ && json[component.__id__]) {
                            callback(json[component.__id__]);
                        }
                    }
                }
            });
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9hc3NldHMvYXNzZXQtaGFuZGxlci9hc3NldHMvc2NlbmUvdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOztBQVliLG9CQWNDO0FBRUQsOEJBY0M7QUFRRCxvQ0FZQztBQVNELDRCQWFDO0FBU0Qsc0NBY0M7QUFNRCwwQ0FVQztBQUVELHdDQU1DO0FBNEJELGtEQTBFQztBQXRPRCw4Q0FBNkM7QUFDN0MsdUNBQWtEO0FBQ2xELDJCQUFnQztBQUVoQzs7OztHQUlHO0FBQ0gsU0FBZ0IsSUFBSSxDQUFDLE1BQVcsRUFBRSxNQUE2QjtJQUMzRCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztRQUN4QixLQUFLLE1BQU0sS0FBSyxJQUFJLE1BQU0sRUFBRSxDQUFDO1lBQ3pCLElBQUksQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDeEIsQ0FBQztJQUNMLENBQUM7U0FBTSxJQUFJLE1BQU0sSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRLEVBQUUsQ0FBQztRQUM5QyxJQUFJLFVBQVUsSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUN2QixNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDbkIsQ0FBQzthQUFNLENBQUM7WUFDSixLQUFLLE1BQU0sS0FBSyxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztnQkFDeEMsSUFBSSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztZQUN4QixDQUFDO1FBQ0wsQ0FBQztJQUNMLENBQUM7QUFDTCxDQUFDO0FBRU0sS0FBSyxVQUFVLFNBQVMsQ0FBQyxNQUFXLEVBQUUsTUFBNkI7SUFDdEUsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7UUFDeEIsS0FBSyxNQUFNLEtB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O29CQUNyQixLQUFLLE1BQU0sSUFBSSxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQzt3QkFDNUIsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDNUIsQ0FBQztnQkFDTCxDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7WUFDSCxNQUFNLDBCQUEwQixDQUFDLFlBQVksRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNyRixDQUFDO1FBQ0QsSUFBSSxRQUFRLENBQUMsaUJBQWlCLElBQUksUUFBUSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUN0RSxRQUFRLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBWSxFQUFFLEVBQUU7Z0JBQ2hELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQ2xDLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztvQkFDMUIsS0FBSyxNQUFNLFNBQVMsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7d0JBQ3RDLElBQUksU0FBUyxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7NEJBQzdDLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7d0JBQ3JDLENBQUM7b0JBQ0wsQ0FBQztnQkFDTCxDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDO0lBQ0wsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG5pbXBvcnQgeyBJQmFzZU5vZGUsIElPYmplY3RSZWYgfSBmcm9tICcuL2RlZmluZXMnO1xyXG5pbXBvcnQgeyBxdWVyeUFzc2V0IH0gZnJvbSAnQGNvY29zL2Fzc2V0LWRiJztcclxuaW1wb3J0IHsgcmVhZEpTT04sIHJlYWRKU09OU3luYyB9IGZyb20gJ2ZzLWV4dHJhJztcclxuaW1wb3J0IHsgZXhpc3RzU3luYyB9IGZyb20gJ2ZzJztcclxuXHJcbi8qKlxyXG4gKiDpgY3ljobmr4/kuIDkuKrlr7nosaHvvIzmib7liLDluKbmnIkgdXVpZCDnmoQgb2JqZWN0IOW5tuaJp+ihjCBoYW5kbGVcclxuICogQHBhcmFtIG9iamVjdFxyXG4gKiBAcGFyYW0gaGFuZGxlXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gd2FsayhvYmplY3Q6IGFueSwgaGFuZGxlOiAob2JqOiBvYmplY3QpID0+IHZvaWQpIHtcclxuICAgIGlmIChBcnJheS5pc0FycmF5KG9iamVjdCkpIHtcclxuICAgICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIG9iamVjdCkge1xyXG4gICAgICAgICAgICB3YWxrKGNoaWxkLCBoYW5kbGUpO1xyXG4gICAgICAgIH1cclxuICAgIH0gZWxzZSBpZiAob2JqZWN0ICYmIHR5cGVvZiBvYmplY3QgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgaWYgKCdfX3V1aWRfXycgaW4gb2JqZWN0KSB7XHJcbiAgICAgICAgICAgIGhhbmRsZShvYmplY3QpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgT2JqZWN0LnZhbHVlcyhvYmplY3QpKSB7XHJcbiAgICAgICAgICAgICAgICB3YWxrKHZhbHVlLCBoYW5kbGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gd2Fsa0FzeW5jKG9iamVjdDogYW55LCBoYW5kbGU6IChvYmo6IG9iamVjdCkgPT4gdm9pZCkge1xyXG4gICAgaWYgKEFycmF5LmlzQXJyYXkob2JqZWN0KSkge1xyXG4gICAgICAgIGZvciAoY29uc3QgY2hpbGQgb2Ygb2JqZWN0KSB7XHJcbiAgICAgICAgICAgIGF3YWl0IHdhbGsoY2hpbGQsIGhhbmRsZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChvYmplY3QgJiYgdHlwZW9mIG9iamVjdCA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICBpZiAoJ19fdXVpZF9fJyBpbiBvYmplY3QpIHtcclxuICAgICAgICAgICAgYXdhaXQgaGFuZGxlKG9iamVjdCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZm9yIChjb25zdCB2YWx1ZSBvZiBPYmplY3QudmFsdWVzKG9iamVjdCkpIHtcclxuICAgICAgICAgICAgICAgIGF3YWl0IHdhbGsodmFsdWUsIGhhbmRsZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDmn6Xmib7kuIDkuKoganNvbiDph4zpnaLnmoQgY29tcG9uZW50XHJcbiAqIEBwYXJhbSBqc29uXHJcbiAqIEBwYXJhbSBub2RlSWR4XHJcbiAqIEBwYXJhbSBjb21wUkVcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRDb21wb25lbnQoanNvbjogYW55W10sIG5vZGVJZHg6IG51bWJlciwgY29tcFJFOiBSZWdFeHApIHtcclxuICAgIGlmICh0eXBlb2Ygbm9kZUlkeCAhPT0gJ251bWJlcicgfHwgbm9kZUlkeCA8IDApIHtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IGNvbXBzID0ganNvbltub2RlSWR4XS5fY29tcG9uZW50cztcclxuICAgIGZvciAoY29uc3QgY29tcElkeCBvZiBjb21wcykge1xyXG4gICAgICAgIGNvbnN0IGNvbXAgPSBqc29uW2NvbXBJZHguX19pZF9fXTtcclxuICAgICAgICBpZiAoY29tcFJFLnRlc3QoY29tcC5fX3R5cGVfXykpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGNvbXA7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDpgY3ljoboioLngrnlkozlroPnmoTlrZDoioLngrlcclxuICogQHBhcmFtIGpzb25cclxuICogQHBhcmFtIG5vZGVJZHhcclxuICogQHBhcmFtIHByb2Nlc3NGdW5jXHJcbiAqIEByZXR1cm5zXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gd2Fsa05vZGUoanNvbjogYW55W10sIG5vZGVSZWY6IElPYmplY3RSZWYsIHByb2Nlc3NGdW5jOiAobm9kZUpzb246IElCYXNlTm9kZSwgbm9kZVJlZjogSU9iamVjdFJlZikgPT4gdm9pZCkge1xyXG4gICAgaWYgKCFub2RlUmVmIHx8IHR5cGVvZiBub2RlUmVmLl9faWRfXyAhPT0gJ251bWJlcicgfHwgbm9kZVJlZi5fX2lkX18gPCAwKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG5vZGVKc29uID0ganNvbltub2RlUmVmLl9faWRfX107XHJcbiAgICBwcm9jZXNzRnVuYyhub2RlSnNvbiwgbm9kZVJlZik7XHJcblxyXG4gICAgaWYgKG5vZGVKc29uLl9jaGlsZHJlbikge1xyXG4gICAgICAgIG5vZGVKc29uLl9jaGlsZHJlbi5mb3JFYWNoKChjaGlsZE9iajogSU9iamVjdFJlZikgPT4ge1xyXG4gICAgICAgICAgICB3YWxrTm9kZShqc29uLCBjaGlsZE9iaiwgcHJvY2Vzc0Z1bmMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcblxyXG4vKipcclxuICog6YGN5Y6G6IqC54K55ZKM5a6D55qE5a2Q6IqC54K5XHJcbiAqIEBwYXJhbSBqc29uXHJcbiAqIEBwYXJhbSBub2RlSWR4XHJcbiAqIEBwYXJhbSBwcm9jZXNzRnVuY1xyXG4gKiBAcmV0dXJuc1xyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHdhbGtOb2RlQXN5bmMoanNvbjogYW55W10sIG5vZGVSZWY6IElPYmplY3RSZWYsIHByb2Nlc3NGdW5jOiAobm9kZUpzb246IElCYXNlTm9kZSwgbm9kZVJlZjogSU9iamVjdFJlZikgPT4gdm9pZCkge1xyXG4gICAgaWYgKCFub2RlUmVmIHx8IHR5cGVvZiBub2RlUmVmLl9faWRfXyAhPT0gJ251bWJlcicgfHwgbm9kZVJlZi5fX2lkX18gPCAwKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG5vZGVKc29uID0ganNvbltub2RlUmVmLl9faWRfX107XHJcbiAgICBhd2FpdCBwcm9jZXNzRnVuYyhub2RlSnNvbiwgbm9kZVJlZik7XHJcblxyXG4gICAgaWYgKG5vZGVKc29uLl9jaGlsZHJlbikge1xyXG4gICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBub2RlSnNvbi5fY2hpbGRyZW4ubGVuZ3RoOyBpbmRleCsrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkT2JqID0gbm9kZUpzb24uX2NoaWxkcmVuW2luZGV4XTtcclxuICAgICAgICAgICAgYXdhaXQgd2Fsa05vZGVBc3luYyhqc29uLCBjaGlsZE9iaiwgcHJvY2Vzc0Z1bmMpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOmAmui/h19faWRfX+iOt+WPlm5vZGXnmoRwcmVmYWLkv6Hmga9cclxuICogQHBhcmFtIGpzb25cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRQcmVmYWJPZk5vZGUoaWQ6IG51bWJlciwganNvbjogYW55W10pIHtcclxuICAgIGlmIChpZCAmJiBqc29uW2lkXSkge1xyXG4gICAgICAgIGNvbnN0IG5vZGUgPSBqc29uW2lkXTtcclxuICAgICAgICBpZiAobm9kZSAmJiBub2RlLl9fdHlwZV9fID09PSAnY2MuTm9kZScpIHtcclxuICAgICAgICAgICAgY29uc3QgcHJlZmFiSWQgPSBub2RlLl9wcmVmYWI/Ll9faWRfXztcclxuICAgICAgICAgICAgaWYgKHByZWZhYklkICYmIGpzb25bcHJlZmFiSWRdKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ganNvbltwcmVmYWJJZF07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc05lc3RlZFByZWZhYihub2RlOiBhbnksIGpzb246IGFueVtdLCBwcmVmYWJVdWlkOiBzdHJpbmcpIHtcclxuICAgIGlmIChub2RlPy5fcHJlZmFiPy5fX2lkX18gJiYganNvbltub2RlLl9wcmVmYWIuX19pZF9fXT8uYXNzZXQ/Ll9fdXVpZF9fKSB7XHJcbiAgICAgICAgLy8g6YOo5YiGcHJlZmFi5a2Q6IqC54K55a2Y5Zyo57Si5byV6Ieq5bex55qE6Zeu6aKY77yM6ZyA6KaB6L+H5ruk5o6JXHJcbiAgICAgICAgcmV0dXJuIGpzb25bbm9kZS5fcHJlZmFiLl9faWRfX10/LmFzc2V0Py5fX3V1aWRfXyAhPT0gcHJlZmFiVXVpZDtcclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxufVxyXG5cclxuY29uc3Qgd2Fsa1ByZWZhYkluc3RhbmNlQ2hpbGRyZW4gPSBhc3luYyBmdW5jdGlvbiAoY2hpbGRyZW46IGFueVtdLCBqc29uOiBhbnlbXSwgc2NlbmVBc3NldDogYW55LCBjYWxsYmFjazogRnVuY3Rpb24sIHByZWZhYlV1aWQ6IHN0cmluZykge1xyXG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGNoaWxkcmVuLmxlbmd0aDsgaW5kZXgrKykge1xyXG4gICAgICAgIGNvbnN0IGNoaWxkUmVmID0gY2hpbGRyZW5baW5kZXhdO1xyXG4gICAgICAgIGF3YWl0IHdhbGtOb2RlQXN5bmMoanNvbiwgY2hpbGRSZWYsIGFzeW5jIChjaGlsZEpzb24sIF8pID0+IHtcclxuICAgICAgICAgICAgaWYgKGlzTmVzdGVkUHJlZmFiKGNoaWxkSnNvbiwganNvbiwgcHJlZmFiVXVpZCkpIHtcclxuICAgICAgICAgICAgICAgIGF3YWl0IHdhbGtQcmVmYWJJbnN0YW5jZXMoY2hpbGRKc29uLCBqc29uLCBzY2VuZUFzc2V0LCBjYWxsYmFjayk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhjaGlsZEpzb24pO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNoaWxkSnNvbi5fY29tcG9uZW50cykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNoaWxkSnNvbi5fY29tcG9uZW50cy5mb3JFYWNoKChjb21wb25lbnRSZWYpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tcG9uZW50ID0ganNvbltjb21wb25lbnRSZWYuX19pZF9fXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBvbmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soY29tcG9uZW50KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn07XHJcblxyXG4vKipcclxuICog6YGN5Y6G5bWM5aWX6aKE5Yi25L2T5a6e5L6L55qE5omA5pyJ6IqC54K55ZKM57uE5Lu2XHJcbiAqIEBwYXJhbSBub2RlIOmihOWItuS9k+aJgOWcqOiKgueCuWpzb25cclxuICogQHBhcmFtIGpzb24g5Zy65pmvanNvbnNjZW5lXHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gd2Fsa1ByZWZhYkluc3RhbmNlcyhub2RlOiBhbnksIGpzb246IGFueVtdLCBzY2VuZUFzc2V0OiBhbnksIGNhbGxiYWNrOiBGdW5jdGlvbikge1xyXG4gICAgaWYgKCFub2RlPy5fcHJlZmFiPy5fX2lkX18pIHJldHVybjtcclxuICAgIC8vIOagueiKgueCuVxyXG4gICAgY2FsbGJhY2sobm9kZSwganNvbik7XHJcbiAgICBjb25zdCBwcmVmYWIgPSBqc29uW25vZGUuX3ByZWZhYi5fX2lkX19dO1xyXG4gICAgY29uc3QgdXVpZCA9IHByZWZhYj8uYXNzZXQ/Ll9fdXVpZF9fO1xyXG4gICAgaWYgKCF1dWlkKSByZXR1cm47XHJcblxyXG4gICAgY29uc3QgYXNzZXQgPSBxdWVyeUFzc2V0KHV1aWQpO1xyXG4gICAgaWYgKGFzc2V0ICYmIGFzc2V0LnNvdXJjZSkge1xyXG4gICAgICAgIGxldCBwcmVmYWJKc29uOiBhbnlbXSA9IFtdO1xyXG4gICAgICAgIGxldCBmaWxlOiBzdHJpbmc7XHJcbiAgICAgICAgaWYgKGFzc2V0LnNvdXJjZS5pbmNsdWRlcygnQCcpKSB7XHJcbiAgICAgICAgICAgIGlmICghYXNzZXQuaW5pdCkge1xyXG4gICAgICAgICAgICAgICAgYXNzZXQuX2Fzc2V0REIudGFza01hbmFnZXIucGF1c2Uoc2NlbmVBc3NldC50YXNrKTtcclxuICAgICAgICAgICAgICAgIGF3YWl0IGFzc2V0LndhaXRJbml0KCk7XHJcbiAgICAgICAgICAgICAgICBhc3NldC5fYXNzZXREQi50YXNrTWFuYWdlci5yZXN1bWUoc2NlbmVBc3NldC50YXNrKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBmaWxlID0gYXNzZXQubGlicmFyeSArICcuanNvbic7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZmlsZSA9IGFzc2V0LnNvdXJjZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGV4aXN0c1N5bmMoZmlsZSkpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHByZWZhYkpzb24gPSByZWFkSlNPTlN5bmMoZmlsZSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oZXJyb3IpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghcHJlZmFiSnNvblswXSB8fCAhcHJlZmFiSnNvblswXT8uZGF0YT8uX19pZF9fKSByZXR1cm47XHJcblxyXG4gICAgICAgIC8vIOmBjeWOhnByZWZhYkpzb27nmoTlrZDoioLngrnlkoznu4Tku7ZcclxuICAgICAgICBjb25zdCByb290ID0gcHJlZmFiSnNvbltwcmVmYWJKc29uWzBdLmRhdGEuX19pZF9fXTtcclxuICAgICAgICBpZiAocm9vdD8uX2NoaWxkcmVuKSB7XHJcbiAgICAgICAgICAgIGF3YWl0IHdhbGtQcmVmYWJJbnN0YW5jZUNoaWxkcmVuKHJvb3QuX2NoaWxkcmVuLCBwcmVmYWJKc29uLCBzY2VuZUFzc2V0LCBjYWxsYmFjaywgdXVpZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChyb290Py5fY29tcG9uZW50cykge1xyXG4gICAgICAgICAgICByb290Ll9jb21wb25lbnRzLmZvckVhY2goKGNvbXBvbmVudFJlZjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb21wb25lbnQgPSBwcmVmYWJKc29uW2NvbXBvbmVudFJlZi5fX2lkX19dO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNvbXBvbmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGNvbXBvbmVudCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8vIOmBjeWOhm1vdW50ZWRDaGlsZHJlbk5Db21wb25lbnRcclxuICAgIGNvbnN0IGluc3RhbmNlSUQgPSBwcmVmYWI/Lmluc3RhbmNlPy5fX2lkX187XHJcbiAgICBpZiAoaW5zdGFuY2VJRCAmJiBqc29uW2luc3RhbmNlSURdKSB7XHJcbiAgICAgICAgY29uc3QgaW5zdGFuY2UgPSBqc29uW2luc3RhbmNlSURdO1xyXG4gICAgICAgIGlmIChpbnN0YW5jZS5tb3VudGVkQ2hpbGRyZW4gJiYgaW5zdGFuY2UubW91bnRlZENoaWxkcmVuLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgY29uc3QgY2hpbGRyZW5SZWZzOiBhbnlbXSA9IFtdO1xyXG4gICAgICAgICAgICBpbnN0YW5jZS5tb3VudGVkQ2hpbGRyZW4uZm9yRWFjaCgoaW5mb1JlZjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0ganNvbltpbmZvUmVmLl9faWRfX107XHJcbiAgICAgICAgICAgICAgICBpZiAoaW5mbyAmJiBpbmZvLm5vZGVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBub2RlIG9mIGluZm8ubm9kZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW5SZWZzLnB1c2gobm9kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgYXdhaXQgd2Fsa1ByZWZhYkluc3RhbmNlQ2hpbGRyZW4oY2hpbGRyZW5SZWZzLCBqc29uLCBzY2VuZUFzc2V0LCBjYWxsYmFjaywgdXVpZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChpbnN0YW5jZS5tb3VudGVkQ29tcG9uZW50cyAmJiBpbnN0YW5jZS5tb3VudGVkQ29tcG9uZW50cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGluc3RhbmNlLm1vdW50ZWRDb21wb25lbnRzLmZvckVhY2goKGluZm9SZWY6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaW5mbyA9IGpzb25baW5mb1JlZi5fX2lkX19dO1xyXG4gICAgICAgICAgICAgICAgaWYgKGluZm8gJiYgaW5mby5jb21wb25lbnRzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBjb21wb25lbnQgb2YgaW5mby5jb21wb25lbnRzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21wb25lbnQuX19pZF9fICYmIGpzb25bY29tcG9uZW50Ll9faWRfX10pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGpzb25bY29tcG9uZW50Ll9faWRfX10pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19