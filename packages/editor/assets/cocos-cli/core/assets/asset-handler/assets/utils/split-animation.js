"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.splitAnimation = splitAnimation;
const cc_1 = require("cc");
const exotic_animation_1 = require("cc/editor/exotic-animation");
const curve_utils_1 = require("./curve-utils");
function splitAnimation(animationClip, from, to) {
    const newClip = new cc_1.AnimationClip();
    newClip.duration = to - from;
    newClip.enableTrsBlending = animationClip.enableTrsBlending;
    for (const track of animationClip.tracks) {
        const newTrack = cloneTrackWithoutChannels(track);
        const sourceChannels = Array.from(track.channels());
        const targetChannels = Array.from(newTrack.channels());
        sourceChannels.forEach(({ name, curve }, index) => {
            targetChannels[index].name = name;
            const newCurve = targetChannels[index].curve;
            if (curve instanceof cc_1.RealCurve) {
                splitRealCurve(curve, from, to, newCurve);
            }
            else if (curve instanceof cc_1.QuatCurve) {
                splitQuaternionCurve(curve, from, to, newCurve);
            }
            else {
                throw new Error('Unknown curve type.');
            }
        });
        newClip.addTrack(track);
    }
    const exoticAnimation = animationClip[exotic_animation_1.exoticAnimationTag];
    if (exoticAnimation) {
        newClip[exotic_animation_1.exoticAnimationTag] = exoticAnimation.split(from, to);
    }
    return newClip;
}
function cloneTrackWithoutChannels(track) {
    switch (true) {
        default:
            throw new Error('Unknown track type.');
        case track instanceof cc_1.animation.RealTrack: {
            const newTrack = new cc_1.animation.RealTrack();
            return newTrack;
        }
        case track instanceof cc_1.animation.QuatTrack: {
            const newTrack = new cc_1.animation.QuatTrack();
            return newTrack;
        }
        case track instanceof cc_1.animation.ObjectTrack: {
            const newTrack = new cc_1.animation.ObjectTrack();
            return newTrack;
        }
        case track instanceof cc_1.animation.VectorTrack: {
            const newTrack = new cc_1.animation.VectorTrack();
            newTrack.componentsCount = track.componentsCount;
            return newTrack;
        }
        case track instanceof cc_1.animation.ColorTrack: {
            const newTrack = new cc_1.animation.ColorTrack();
            return newTrack;
        }
        case track instanceof exotic_animation_1.RealArrayTrack: {
            const newTrack = new exotic_animation_1.RealArrayTrack();
            newTrack.elementCount = track.elementCount;
            return newTrack;
        }
    }
}
function splitRealCurve(curve, from, to, out) {
    const fromIndex = curve.indexOfKeyframe(from);
    const toIndex = curve.indexOfKeyframe(to);
    const copyFrom = fromIndex;
    const copyTo = toIndex;
    const keyframes = [...curve.keyframes()].slice(copyFrom, copyTo);
    if (copyFrom !== fromIndex) {
        const { value, tangent } = evaluateBetweenKeyframes(curve, fromIndex, copyFrom, from);
        keyframes.unshift([
            from,
            {
                value,
                interpolationMode: curve.getKeyframeValue(fromIndex).interpolationMode,
                rightTangent: tangent.y,
                rightTangentWeight: tangent.x,
            },
        ]);
    }
    if (copyTo !== toIndex) {
        const { value, tangent } = evaluateBetweenKeyframes(curve, copyTo, toIndex, to);
        keyframes.unshift([
            to,
            {
                value,
                interpolationMode: curve.getKeyframeValue(toIndex).interpolationMode,
                leftTangent: tangent.y,
                leftTangentWeight: tangent.x,
            },
        ]);
    }
    out.assignSorted(keyframes);
    out.preExtrapolation = curve.preExtrapolation;
    out.postExtrapolation = curve.postExtrapolation;
}
function splitQuaternionCurve(curve, from, to, out) {
    const fromIndex = curve.indexOfKeyframe(from);
    const toIndex = curve.indexOfKeyframe(to);
    const copyFrom = fromIndex;
    const copyTo = toIndex;
    const keyframes = [...curve.keyframes()].slice(copyFrom, copyTo);
    if (copyFrom !== fromIndex && fromIndex >= 0) {
        const fromValue = curve.evaluate(from);
        keyframes.unshift([
            from,
            {
                value: fromValue,
                interpolationMode: curve.getKeyframeValue(fromIndex).interpolationMode,
                easingMethod: curve.getKeyframeValue(fromIndex).easingMethod,
            },
        ]);
    }
    if (copyTo !== toIndex && toIndex >= 0) {
        const toValue = curve.evaluate(to);
        keyframes.unshift([
            to,
            {
                value: toValue,
                interpolationMode: curve.getKeyframeValue(toIndex).interpolationMode,
                easingMethod: curve.getKeyframeValue(toIndex).easingMethod,
            },
        ]);
    }
    out.assignSorted(keyframes);
}
function evaluateBetweenKeyframes(curve, from, to, time) {
    const fromTime = curve.getKeyframeTime(from);
    const { value: fromValue, rightTangent: fromTangentY, rightTangentWeight: fromTangentX } = curve.getKeyframeValue(from);
    const toTime = curve.getKeyframeTime(to);
    const { value: toValue, leftTangent: toTangentY, leftTangentWeight: toTangentX } = curve.getKeyframeValue(to);
    return (0, curve_utils_1.evaluateValueTangent)(time, fromTime, fromValue, fromTangentX, fromTangentY, toTime, toValue, toTangentX, toTangentY);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BsaXQtYW5pbWF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvYXNzZXRzL2Fzc2V0LWhhbmRsZXIvYXNzZXRzL3V0aWxzL3NwbGl0LWFuaW1hdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUlBLHdDQTBCQztBQTlCRCwyQkFBdUg7QUFDdkgsaUVBQWdGO0FBQ2hGLCtDQUFxRDtBQUVyRCxTQUFnQixjQUFjLENBQUMsYUFBNEIsRUFBRSxJQUFZLEVBQUUsRUFBVTtJQUNqRixNQUFNLE9BQU8sR0FBRyxJQUFJLGtCQUFhLEVBQUUsQ0FBQztJQUNwQyxPQUFPLENBQUMsUUFBUSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7SUFDN0IsT0FBTyxDQUFDLGlCQUFpQixHQUFHLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQztJQUM1RCxLQUFLLE1BQU0sS0FBSyxJQUFJLGFBQWEsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUN2QyxNQUFNLFFBQVEsR0FBRyx5QkFBeUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsRCxNQUFNLGNBQWMsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQ3BELE1BQU0sY0FBYyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDdkQsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQzlDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1lBQ2xDLE1BQU0sUUFBUSxHQUFHLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFDN0MsSUFBSSxLQUFLLFlBQVksY0FBUyxFQUFFLENBQUM7Z0JBQzdCLGNBQWMsQ0FBQyxLQUFLLEVBQUUs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QUM3RDtTQUNKLENBQUMsQ0FBQztJQUNQLENBQUM7SUFDRCxHQUFHLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ2hDLENBQUM7QUFFRCxTQUFTLHdCQUF3QixDQUFDLEtBQWdCLEVBQUUsSUFBWSxFQUFFLEVBQVUsRUFBRSxJQUFZO0lBQ3RGLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDN0MsTUFBTSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxrQkFBa0IsRUFBRSxZQUFZLEVBQUUsR0FBRyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFeEgsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUN6QyxNQUFNLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLGlCQUFpQixFQUFFLFVBQVUsRUFBRSxHQUFHLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUU5RyxPQUFPLElBQUEsa0NBQW9CLEVBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUNoSSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYW5pbWF0aW9uLCBBbmltYXRpb25DbGlwLCBPYmplY3RDdXJ2ZSwgUXVhdEN1cnZlLCBRdWF0S2V5ZnJhbWVWYWx1ZSwgUmVhbEN1cnZlLCBSZWFsS2V5ZnJhbWVWYWx1ZSB9IGZyb20gJ2NjJztcclxuaW1wb3J0IHsgZXhvdGljQW5pbWF0aW9uVGFnLCBSZWFsQXJyYXlUcmFjayB9IGZyb20gJ2NjL2VkaXRvci9leG90aWMtYW5pbWF0aW9uJztcclxuaW1wb3J0IHsgZXZhbHVhdGVWYWx1ZVRhbmdlbnQgfSBmcm9tICcuL2N1cnZlLXV0aWxzJztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzcGxpdEFuaW1hdGlvbihhbmltYXRpb25DbGlwOiBBbmltYXRpb25DbGlwLCBmcm9tOiBudW1iZXIsIHRvOiBudW1iZXIpIHtcclxuICAgIGNvbnN0IG5ld0NsaXAgPSBuZXcgQW5pbWF0aW9uQ2xpcCgpO1xyXG4gICAgbmV3Q2xpcC5kdXJhdGlvbiA9IHRvIC0gZnJvbTtcclxuICAgIG5ld0NsaXAuZW5hYmxlVHJzQmxlbmRpbmcgPSBhbmltYXRpb25DbGlwLmVuYWJsZVRyc0JsZW5kaW5nO1xyXG4gICAgZm9yIChjb25zdCB0cmFjayBvZiBhbmltYXRpb25DbGlwLnRyYWNrcykge1xyXG4gICAgICAgIGNvbnN0IG5ld1RyYWNrID0gY2xvbmVUcmFja1dpdGhvdXRDaGFubmVscyh0cmFjayk7XHJcbiAgICAgICAgY29uc3Qgc291cmNlQ2hhbm5lbHMgPSBBcnJheS5mcm9tKHRyYWNrLmNoYW5uZWxzKCkpO1xyXG4gICAgICAgIGNvbnN0IHRhcmdldENoYW5uZWxzID0gQXJyYXkuZnJvbShuZXdUcmFjay5jaGFubmVscygpKTtcclxuICAgICAgICBzb3VyY2VDaGFubmVscy5mb3JFYWNoKCh7IG5hbWUsIGN1cnZlIH0sIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgIHRhcmdldENoYW5uZWxzW2luZGV4XS5uYW1lID0gbmFtZTtcclxuICAgICAgICAgICAgY29uc3QgbmV3Q3VydmUgPSB0YXJnZXRDaGFubmVsc1tpbmRleF0uY3VydmU7XHJcbiAgICAgICAgICAgIGlmIChjdXJ2ZSBpbnN0YW5jZW9mIFJlYWxDdXJ2ZSkge1xyXG4gICAgICAgICAgICAgICAgc3BsaXRSZWFsQ3VydmUoY3VydmUsIGZyb20sIHRvLCBuZXdDdXJ2ZSBhcyBSZWFsQ3VydmUpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGN1cnZlIGluc3RhbmNlb2YgUXVhdEN1cnZlKSB7XHJcbiAgICAgICAgICAgICAgICBzcGxpdFF1YXRlcm5pb25DdXJ2ZShjdXJ2ZSwgZnJvbSwgdG8sIG5ld0N1cnZlIGFzIFF1YXRDdXJ2ZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gY3VydmUgdHlwZS4nKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIG5ld0NsaXAuYWRkVHJhY2sodHJhY2spO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZXhvdGljQW5pbWF0aW9uID0gYW5pbWF0aW9uQ2xpcFtleG90aWNBbmltYXRpb25UYWddO1xyXG4gICAgaWYgKGV4b3RpY0FuaW1hdGlvbikge1xyXG4gICAgICAgIG5ld0NsaXBbZXhvdGljQW5pbWF0aW9uVGFnXSA9IGV4b3RpY0FuaW1hdGlvbi5zcGxpdChmcm9tLCB0byk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbmV3Q2xpcDtcclxufVxyXG5cclxuZnVuY3Rpb24gY2xvbmVUcmFja1dpdGhvdXRDaGFubmVscyh0cmFjazogYW5pbWF0aW9uLlRyYWNrKSB7XHJcbiAgICBzd2l0Y2ggKHRydWUpIHtcclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gdHJhY2sgdHlwZS4nKTtcclxuICAgICAgICBjYXNlIHRyYWNrIGluc3RhbmNlb2YgYW5pbWF0aW9uLlJlYWxUcmFjazoge1xyXG4gICAgICAgICAgICBjb25zdCBuZXdUcmFjayA9IG5ldyBhbmltYXRpb24uUmVhbFRyYWNrKCk7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXdUcmFjaztcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FzZSB0cmFjayBpbnN0YW5jZW9mIGFuaW1hdGlvbi5RdWF0VHJhY2s6IHtcclxuICAgICAgICAgICAgY29uc3QgbmV3VHJhY2sgPSBuZXcgYW5pbWF0aW9uLlF1YXRUcmFjaygpO1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3VHJhY2s7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhc2UgdHJhY2sgaW5zdGFuY2VvZiBhbmltYXRpb24uT2JqZWN0VHJhY2s6IHtcclxuICAgICAgICAgICAgY29uc3QgbmV3VHJhY2sgPSBuZXcgYW5pbWF0aW9uLk9iamVjdFRyYWNrKCk7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXdUcmFjaztcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FzZSB0cmFjayBpbnN0YW5jZW9mIGFuaW1hdGlvbi5WZWN0b3JUcmFjazoge1xyXG4gICAgICAgICAgICBjb25zdCBuZXdUcmFjayA9IG5ldyBhbmltYXRpb24uVmVjdG9yVHJhY2soKTtcclxuXHJcbiAgICAgICAgICAgIG5ld1RyYWNrLmNvbXBvbmVudHNDb3VudCA9IHRyYWNrLmNvbXBvbmVudHNDb3VudDtcclxuICAgICAgICAgICAgcmV0dXJuIG5ld1RyYWNrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlIHRyYWNrIGluc3RhbmNlb2YgYW5pbWF0aW9uLkNvbG9yVHJhY2s6IHtcclxuICAgICAgICAgICAgY29uc3QgbmV3VHJhY2sgPSBuZXcgYW5pbWF0aW9uLkNvbG9yVHJhY2soKTtcclxuICAgICAgICAgICAgcmV0dXJuIG5ld1RyYWNrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXNlIHRyYWNrIGluc3RhbmNlb2YgUmVhbEFycmF5VHJhY2s6IHtcclxuICAgICAgICAgICAgY29uc3QgbmV3VHJhY2sgPSBuZXcgUmVhbEFycmF5VHJhY2soKTtcclxuICAgICAgICAgICAgbmV3VHJhY2suZWxlbWVudENvdW50ID0gKHRyYWNrIGFzIFJlYWxBcnJheVRyYWNrKS5lbGVtZW50Q291bnQ7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXdUcmFjaztcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNwbGl0UmVhbEN1cnZlKGN1cnZlOiBSZWFsQ3VydmUsIGZyb206IG51bWJlciwgdG86IG51bWJlciwgb3V0OiBSZWFsQ3VydmUpIHtcclxuICAgIGNvbnN0IGZyb21JbmRleCA9IGN1cnZlLmluZGV4T2ZLZXlmcmFtZShmcm9tKTtcclxuICAgIGNvbnN0IHRvSW5kZXggPSBjdXJ2ZS5pbmRleE9mS2V5ZnJhbWUodG8pO1xyXG4gICAgY29uc3QgY29weUZyb20gPSBmcm9tSW5kZXg7XHJcbiAgICBjb25zdCBjb3B5VG8gPSB0b0luZGV4O1xyXG4gICAgY29uc3Qga2V5ZnJhbWVzOiBbbnVtYmVyLCBQYXJ0aWFsPFJlYWxLZXlmcmFtZVZhbHVlPl1bXSA9IFsuLi5jdXJ2ZS5rZXlmcmFtZXMoKV0uc2xpY2UoY29weUZyb20sIGNvcHlUbyk7XHJcbiAgICBpZiAoY29weUZyb20gIT09IGZyb21JbmRleCkge1xyXG4gICAgICAgIGNvbnN0IHsgdmFsdWUsIHRhbmdlbnQgfSA9IGV2YWx1YXRlQmV0d2VlbktleWZyYW1lcyhjdXJ2ZSwgZnJvbUluZGV4LCBjb3B5RnJvbSwgZnJvbSk7XHJcbiAgICAgICAga2V5ZnJhbWVzLnVuc2hpZnQoW1xyXG4gICAgICAgICAgICBmcm9tLFxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSxcclxuICAgICAgICAgICAgICAgIGludGVycG9sYXRpb25Nb2RlOiBjdXJ2ZS5nZXRLZXlmcmFtZVZhbHVlKGZyb21JbmRleCkuaW50ZXJwb2xhdGlvbk1vZGUsXHJcbiAgICAgICAgICAgICAgICByaWdodFRhbmdlbnQ6IHRhbmdlbnQueSxcclxuICAgICAgICAgICAgICAgIHJpZ2h0VGFuZ2VudFdlaWdodDogdGFuZ2VudC54LFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIF0pO1xyXG4gICAgfVxyXG4gICAgaWYgKGNvcHlUbyAhPT0gdG9JbmRleCkge1xyXG4gICAgICAgIGNvbnN0IHsgdmFsdWUsIHRhbmdlbnQgfSA9IGV2YWx1YXRlQmV0d2VlbktleWZyYW1lcyhjdXJ2ZSwgY29weVRvLCB0b0luZGV4LCB0byk7XHJcbiAgICAgICAga2V5ZnJhbWVzLnVuc2hpZnQoW1xyXG4gICAgICAgICAgICB0byxcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgdmFsdWUsXHJcbiAgICAgICAgICAgICAgICBpbnRlcnBvbGF0aW9uTW9kZTogY3VydmUuZ2V0S2V5ZnJhbWVWYWx1ZSh0b0luZGV4KS5pbnRlcnBvbGF0aW9uTW9kZSxcclxuICAgICAgICAgICAgICAgIGxlZnRUYW5nZW50OiB0YW5nZW50LnksXHJcbiAgICAgICAgICAgICAgICBsZWZ0VGFuZ2VudFdlaWdodDogdGFuZ2VudC54LFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIF0pO1xyXG4gICAgfVxyXG4gICAgb3V0LmFzc2lnblNvcnRlZChrZXlmcmFtZXMpO1xyXG4gICAgb3V0LnByZUV4dHJhcG9sYXRpb24gPSBjdXJ2ZS5wcmVFeHRyYXBvbGF0aW9uO1xyXG4gICAgb3V0LnBvc3RFeHRyYXBvbGF0aW9uID0gY3VydmUucG9zdEV4dHJhcG9sYXRpb247XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNwbGl0UXVhdGVybmlvbkN1cnZlKGN1cnZlOiBRdWF0Q3VydmUsIGZyb206IG51bWJlciwgdG86IG51bWJlciwgb3V0OiBRdWF0Q3VydmUpIHtcclxuICAgIGNvbnN0IGZyb21JbmRleCA9IGN1cnZlLmluZGV4T2ZLZXlmcmFtZShmcm9tKTtcclxuICAgIGNvbnN0IHRvSW5kZXggPSBjdXJ2ZS5pbmRleE9mS2V5ZnJhbWUodG8pO1xyXG4gICAgY29uc3QgY29weUZyb20gPSBmcm9tSW5kZXg7XHJcbiAgICBjb25zdCBjb3B5VG8gPSB0b0luZGV4O1xyXG4gICAgY29uc3Qga2V5ZnJhbWVzID0gWy4uLmN1cnZlLmtleWZyYW1lcygpXS5zbGljZShjb3B5RnJvbSwgY29weVRvKTtcclxuICAgIGlmIChjb3B5RnJvbSAhPT0gZnJvbUluZGV4ICYmIGZyb21JbmRleCA+PSAwKSB7XHJcbiAgICAgICAgY29uc3QgZnJvbVZhbHVlID0gY3VydmUuZXZhbHVhdGUoZnJvbSk7XHJcbiAgICAgICAga2V5ZnJhbWVzLnVuc2hpZnQoW1xyXG4gICAgICAgICAgICBmcm9tLFxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZTogZnJvbVZhbHVlLFxyXG4gICAgICAgICAgICAgICAgaW50ZXJwb2xhdGlvbk1vZGU6IGN1cnZlLmdldEtleWZyYW1lVmFsdWUoZnJvbUluZGV4KS5pbnRlcnBvbGF0aW9uTW9kZSxcclxuICAgICAgICAgICAgICAgIGVhc2luZ01ldGhvZDogY3VydmUuZ2V0S2V5ZnJhbWVWYWx1ZShmcm9tSW5kZXgpLmVhc2luZ01ldGhvZCxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICBdKTtcclxuICAgIH1cclxuICAgIGlmIChjb3B5VG8gIT09IHRvSW5kZXggJiYgdG9JbmRleCA+PSAwKSB7XHJcbiAgICAgICAgY29uc3QgdG9WYWx1ZSA9IGN1cnZlLmV2YWx1YXRlKHRvKTtcclxuICAgICAgICBrZXlmcmFtZXMudW5zaGlmdChbXHJcbiAgICAgICAgICAgIHRvLFxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZTogdG9WYWx1ZSxcclxuICAgICAgICAgICAgICAgIGludGVycG9sYXRpb25Nb2RlOiBjdXJ2ZS5nZXRLZXlmcmFtZVZhbHVlKHRvSW5kZXgpLmludGVycG9sYXRpb25Nb2RlLFxyXG4gICAgICAgICAgICAgICAgZWFzaW5nTWV0aG9kOiBjdXJ2ZS5nZXRLZXlmcmFtZVZhbHVlKHRvSW5kZXgpLmVhc2luZ01ldGhvZCxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICBdKTtcclxuICAgIH1cclxuICAgIG91dC5hc3NpZ25Tb3J0ZWQoa2V5ZnJhbWVzKTtcclxufVxyXG5cclxuZnVuY3Rpb24gZXZhbHVhdGVCZXR3ZWVuS2V5ZnJhbWVzKGN1cnZlOiBSZWFsQ3VydmUsIGZyb206IG51bWJlciwgdG86IG51bWJlciwgdGltZTogbnVtYmVyKSB7XHJcbiAgICBjb25zdCBmcm9tVGltZSA9IGN1cnZlLmdldEtleWZyYW1lVGltZShmcm9tKTtcclxuICAgIGNvbnN0IHsgdmFsdWU6IGZyb21WYWx1ZSwgcmlnaHRUYW5nZW50OiBmcm9tVGFuZ2VudFksIHJpZ2h0VGFuZ2VudFdlaWdodDogZnJvbVRhbmdlbnRYIH0gPSBjdXJ2ZS5nZXRLZXlmcmFtZVZhbHVlKGZyb20pO1xyXG5cclxuICAgIGNvbnN0IHRvVGltZSA9IGN1cnZlLmdldEtleWZyYW1lVGltZSh0byk7XHJcbiAgICBjb25zdCB7IHZhbHVlOiB0b1ZhbHVlLCBsZWZ0VGFuZ2VudDogdG9UYW5nZW50WSwgbGVmdFRhbmdlbnRXZWlnaHQ6IHRvVGFuZ2VudFggfSA9IGN1cnZlLmdldEtleWZyYW1lVmFsdWUodG8pO1xyXG5cclxuICAgIHJldHVybiBldmFsdWF0ZVZhbHVlVGFuZ2VudCh0aW1lLCBmcm9tVGltZSwgZnJvbVZhbHVlLCBmcm9tVGFuZ2VudFgsIGZyb21UYW5nZW50WSwgdG9UaW1lLCB0b1ZhbHVlLCB0b1RhbmdlbnRYLCB0b1RhbmdlbnRZKTtcclxufVxyXG4iXX0=