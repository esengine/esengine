'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.TexturePackerHandler = void 0;
exports._parseFloat2 = _parseFloat2;
exports._parseRect = _parseRect;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
const cc_1 = require("cc");
const utils_1 = require("../utils");
const utils_2 = require("./image/utils");
const plist = require('plist');
exports.TexturePackerHandler = {
    name: 'sprite-atlas',
    // 引擎内对应的类型
    assetType: 'cc.SpriteAtlas',
    importer: {
        // 版本号如果变更，则会强制重新导入
        version: '1.0.8',
        async import(asset) {
            // await asset.copyToLibrary(ext, asset.source);
            // atlas 最外层 userData 包含大图的 size，图片名 atlasTextureName，以及图片的 uuid textureUuid
            // 图集贴图都放置在 submeta 下
            // 数据 atlas 填充
            const userData = asset.userData;
            const file = await (0, fs_extra_1.readFile)(asset.source, 'utf8');
            // @ts-ignore
            const data = plist.parse(file);
            const metadata = data.metadata;
            // @ts-ignore
            userData.atlasTextureName = metadata.realTextureFileName || metadata.textureFileName;
            // @ts-ignore
            userData.format = metadata.format;
            userData.uuid = asset.uuid;
            // 标记依赖资源
            if (asset._assetDB) {
                const textureBaseName = (0, path_1.basename)(userData.atlasTextureName);
                const texturePath = (0, path_1.join)((0, path_1.dirname)(asset.source), textureBaseName);
                if (!(0, fs_extra_1.existsSync)(texturePath)) {
                    console.warn('Parse Error: Unable to find file Texture, the path: ' + texturePath);
                }
                asset.depend(texturePath);
                const uuid = asset._assetDB.pathToUuid(texturePath);
                if (!uuid) {
                    return false;
                }
                userData.textureUuid = uuid + '@' + require('@cocos/asset-db/libs/utils').nameToId('texture');
            }
            // 如果依赖的资源已经导入完成了，则生成对应的数据
            if (asset.userData.textureUuid && asset._assetDB) {
                const ext_replacer = /\.[^.]+$/;
                let keyNoExt = '';
                // @ts-ignore
                const keys = Object.keys(data.frames);
                // @ts-ignore
                const spriteAtlas = new cc_1.SpriteAtlas();
                spriteAtlas.name = asset.basename || '';
                for (const key of keys) {
                    keyNoExt = key.replace(ext_replacer, '');
                    // 数据 atlas 内 spriteFrame 填充
                    // @ts-ignore
                    const f = data.frames[key];
                    const atlasSubAsset = await asset.createSubAsset(keyNoExt, 'sprite-frame');
                    const frameData = fillFrameData(f, userData);
                    frameData.borderBottom = frameData.borderBottom | atlasSubAsset.userData.borderBottom;
                    frameData.borderTop = frameData.borderTop | atlasSubAsset.userData.borderTop;
                    frameData.borderLeft = frameData.borderLeft | atlasSubAsset.userData.borderLeft;
                    frameData.borderRight = frameData.borderRight | atlasSubAsset.userData.borderRight;
                    // asset.userData.redirect = atlasSubAsset.uuid;
                    // packable 如果有值，就使用 userData 里的值，不需要覆盖
                    if ('packable' in atlasSubAsset.userData) {
                        frameData['packable'] = atlasSubAsset.userData['packable'];
                    }
                    atlasSubAsset.assignUserData(frameData, true);
                    atlasSubAsset.userData.imageUuidOrDatabaseUri = frameData.imageUuidOrDatabaseUri;
                    // @ts-ignore
                    spriteAtlas.spriteFrames[keyNoExt] = EditorExtends.serialize.asAsset(atlasSubAsset.uuid, cc_1.SpriteFrame);
                }
                const serializeJSON = EditorExtends.serialize(spriteAtlas);
                await asset.saveToLibrary('.json', serializeJSON);
                const depends = (0, utils_1.getDependUUIDList)(serializeJSON);
                asset.setData('depends', depends);
            }
            return true;
        },
    },
    /**
     * 判断是否允许使用当前的 Handler 进行导入
     * @param asset
     */
    async validate(asset) {
        try {
            const data = plist.parse(await (0, fs_extra_1.readFile)(asset.source, 'utf8'));
            return typeof data.frames !== 'undefined' && typeof data.metadata !== 'undefined';
        }
        catch (e) {
            return false;
        }
    },
};
exports.default = exports.TexturePackerHandler;
function fillFrameData(frameData, userData) {
    const format = userData.format;
    const data = (0, utils_2.makeDefaultSpriteFrameAssetUserDataFromImageUuid)(userData.textureUuid, userData.uuid);
    let rotated = false;
    let sourceSize = '';
    let offsetStr = '';
    let textureRect = '';
    if (format === 1 || format === 2) {
        rotated = frameData.rotated;
        sourceSize = frameData.sourceSize;
        offsetStr = frameData.offset;
        textureRect = frameData.frame;
    }
    else if (format === 3) {
        rotated = frameData.textureRotated;
        sourceSize = frameData.spriteSourceSize;
        offsetStr = frameData.spriteOffset;
        textureRect = frameData.textureRect;
    }
    data.rotated = rotated;
    const originSize = _parseFloat2(sourceSize, cc_1.Size);
    data.rawWidth = originSize.width;
    data.rawHeight = originSize.height;
    const rect = _parseRect(textureRect);
    data.trimX = rect.x;
    data.trimY = rect.y;
    data.width = rect.width;
    data.height = rect.height;
    const offset = _parseFloat2(offsetStr, cc_1.Vec2);
    data.offsetX = offset.x;
    data.offsetY = offset.y;
    return data;
}
const BRACE_REGEX = /[\{\}]/g; // eslint-disable-line no-useless-escape
function _parseFloat2(data, Ctor) {
    const arr = data.slice(1, -1).split(',');
    return new Ctor(parseFloat(arr[0]), parseFloat(arr[1]));
}
function _parseRect(rectStr) {
    rectStr = rectStr.replace(BRACE_REGEX, '');
    const arr = rectStr.split(',');
    return new cc_1.Rect(parseFloat(arr[0] || '0'), parseFloat(arr[1] || '0'), parseFloat(arr[2] || '0'), parseFloat(arr[3] || '0'));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dHVyZS1wYWNrZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9hc3NldHMvYXNzZXQtaGFuZGxlci9hc3NldHMvdGV4dHVyZS1wYWNrZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7QUFtTGIsb0NBR0M7QUFFRCxnQ0FJQztBQXpMRCx1Q0FBZ0Q7QUFDaEQsK0JBQXdEO0FBQ3hELDJCQUFnRTtBQUVoRSxvQ0FBNkM7QUFFN0MseUNBQWlGO0FBRWpGLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQW1CbEIsUUFBQSxvQkFBb0IsR0FBaUI7SUFDOUMsSUFBSSxFQUFFLGNBQWM7SUFDcEIsV0FBVztJQUNYLFNBQVMsRUFBRSxnQkFBZ0I7SUFDM0IsUUFBUSxFQUFFO1FBQ04sbUJBQW1CO1FBQ25CLE9BQU8sRUFBRSxPQUFPO1FBRWhCLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBWTtZQUNyQixnREFBZ0Q7WUFFaEQsNEVBQTRFO1lBQzVFLHFCQUFxQjtZQUVyQixjQUFjO1lBQ2QsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQXNCLENBQUM7WUFFOUMsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFBLG1CQUFRLEVBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztZQUVsRCxhQUFhO1lBQ2IsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMvQixNQUFNLFFBQVEsR0FBYyxJQUFJLENBQUMsUUFBUSxDQUFDO1lBQzFDLGFBQWE7WUFDYixRQUFRLENBQUMsZ0JBQWdCLEdBQUcsUUFBUSxDQUFDLG1CQUFtQixJQUFJLFFBQVEsQ0FBQyxlQUFlLENBQUM7WUFDckYsYUFBYTtZQUNiLFFBQVEsQ0FBQyxNQUFNLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQztZQUNsQyxRQUFRLENBQUMs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VSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQ2hJLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG5pbXBvcnQgeyBBc3NldCB9IGZyb20gJ0Bjb2Nvcy9hc3NldC1kYic7XHJcbmltcG9ydCB7IGV4aXN0c1N5bmMsIHJlYWRGaWxlIH0gZnJvbSAnZnMtZXh0cmEnO1xyXG5pbXBvcnQgeyBiYXNlbmFtZSwgZGlybmFtZSwgZXh0bmFtZSwgam9pbiB9IGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgeyBTcHJpdGVGcmFtZSwgVmVjMiwgU2l6ZSwgUmVjdCwgU3ByaXRlQXRsYXMgfSBmcm9tICdjYyc7XHJcblxyXG5pbXBvcnQgeyBnZXREZXBlbmRVVUlETGlzdCB9IGZyb20gJy4uL3V0aWxzJztcclxuaW1wb3J0IHsgQXNzZXRIYW5kbGVyIH0gZnJvbSAnLi4vLi4vQHR5cGVzL3Byb3RlY3RlZCc7XHJcbmltcG9ydCB7IG1ha2VEZWZhdWx0U3ByaXRlRnJhbWVBc3NldFVzZXJEYXRhRnJvbUltYWdlVXVpZCB9IGZyb20gJy4vaW1hZ2UvdXRpbHMnO1xyXG5pbXBvcnQgeyBTcHJpdGVGcmFtZUFzc2V0VXNlckRhdGEsIFNwcml0ZUZyYW1lQmFzZUFzc2V0VXNlckRhdGEgfSBmcm9tICcuLi8uLi9AdHlwZXMvdXNlckRhdGFzJztcclxuY29uc3QgcGxpc3QgPSByZXF1aXJlKCdwbGlzdCcpO1xyXG5cclxuaW50ZXJmYWNlIElQYWNrQXRsYXMge1xyXG4gICAgYXRsYXNUZXh0dXJlTmFtZTogc3RyaW5nO1xyXG4gICAgdGV4dHVyZVV1aWQ6IHN0cmluZyB8IG51bGw7XHJcbiAgICBmcmFtZXM6IFNwcml0ZUZyYW1lQXNzZXRVc2VyRGF0YVtdO1xyXG4gICAgdXVpZDogc3RyaW5nO1xyXG4gICAgZm9ybWF0OiBudW1iZXI7XHJcbn1cclxuXHJcbmludGVyZmFjZSBJTWV0YWRhdGEge1xyXG4gICAgZm9ybWF0OiBudW1iZXI7XHJcbiAgICBwaXhlbEZvcm1hdDogc3RyaW5nO1xyXG4gICAgcHJlbXVsdGlwbHlBbHBoYTogYm9vbGVhbjtcclxuICAgIHJlYWxUZXh0dXJlRmlsZU5hbWU6IHN0cmluZztcclxuICAgIHRleHR1cmVGaWxlTmFtZTogc3RyaW5nO1xyXG4gICAgc2l6ZTogc3RyaW5nO1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgVGV4dHVyZVBhY2tlckhhbmRsZXI6IEFzc2V0SGFuZGxlciA9IHtcclxuICAgIG5hbWU6ICdzcHJpdGUtYXRsYXMnLFxyXG4gICAgLy8g5byV5pOO5YaF5a+55bqU55qE57G75Z6LXHJcbiAgICBhc3NldFR5cGU6ICdjYy5TcHJpdGVBdGxhcycsXHJcbiAgICBpbXBvcnRlcjoge1xyXG4gICAgICAgIC8vIOeJiOacrOWPt+WmguaenOWPmOabtO+8jOWImeS8muW8uuWItumHjeaWsOWvvOWFpVxyXG4gICAgICAgIHZlcnNpb246ICcxLjAuOCcsXHJcblxyXG4gICAgICAgIGFzeW5jIGltcG9ydChhc3NldDogQXNzZXQpIHtcclxuICAgICAgICAgICAgLy8gYXdhaXQgYXNzZXQuY29weVRvTGlicmFyeShleHQsIGFzc2V0LnNvdXJjZSk7XHJcblxyXG4gICAgICAgICAgICAvLyBhdGxhcyDmnIDlpJblsYIgdXNlckRhdGEg5YyF5ZCr5aSn5Zu+55qEIHNpemXvvIzlm77niYflkI0gYXRsYXNUZXh0dXJlTmFtZe+8jOS7peWPiuWbvueJh+eahCB1dWlkIHRleHR1cmVVdWlkXHJcbiAgICAgICAgICAgIC8vIOWbvumbhui0tOWbvumDveaUvue9ruWcqCBzdWJtZXRhIOS4i1xyXG5cclxuICAgICAgICAgICAgLy8g5pWw5o2uIGF0bGFzIOWhq+WFhVxyXG4gICAgICAgICAgICBjb25zdCB1c2VyRGF0YSA9IGFzc2V0LnVzZXJEYXRhIGFzIElQYWNrQXRsYXM7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBmaWxlID0gYXdhaXQgcmVhZEZpbGUoYXNzZXQuc291cmNlLCAndXRmOCcpO1xyXG5cclxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICBjb25zdCBkYXRhID0gcGxpc3QucGFyc2UoZmlsZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IG1ldGFkYXRhOiBJTWV0YWRhdGEgPSBkYXRhLm1ldGFkYXRhO1xyXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgIHVzZXJEYXRhLmF0bGFzVGV4dHVyZU5hbWUgPSBtZXRhZGF0YS5yZWFsVGV4dHVyZUZpbGVOYW1lIHx8IG1ldGFkYXRhLnRleHR1cmVGaWxlTmFtZTtcclxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICB1c2VyRGF0YS5mb3JtYXQgPSBtZXRhZGF0YS5mb3JtYXQ7XHJcbiAgICAgICAgICAgIHVzZXJEYXRhLnV1aWQgPSBhc3NldC51dWlkO1xyXG5cclxuICAgICAgICAgICAgLy8g5qCH6K6w5L6d6LWW6LWE5rqQXHJcbiAgICAgICAgICAgIGlmIChhc3NldC5fYXNzZXREQikge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdGV4dHVyZUJhc2VOYW1lID0gYmFzZW5hbWUodXNlckRhdGEuYXRsYXNUZXh0dXJlTmFtZSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0ZXh0dXJlUGF0aCA9IGpvaW4oZGlybmFtZShhc3NldC5zb3VyY2UpLCB0ZXh0dXJlQmFzZU5hbWUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFleGlzdHNTeW5jKHRleHR1cmVQYXRoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignUGFyc2UgRXJyb3I6IFVuYWJsZSB0byBmaW5kIGZpbGUgVGV4dHVyZSwgdGhlIHBhdGg6ICcgKyB0ZXh0dXJlUGF0aCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBhc3NldC5kZXBlbmQodGV4dHVyZVBhdGgpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdXVpZCA9IGFzc2V0Ll9hc3NldERCLnBhdGhUb1V1aWQodGV4dHVyZVBhdGgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCF1dWlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHVzZXJEYXRhLnRleHR1cmVVdWlkID0gdXVpZCArICdAJyArIHJlcXVpcmUoJ0Bjb2Nvcy9hc3NldC1kYi9saWJzL3V0aWxzJykubmFtZVRvSWQoJ3RleHR1cmUnKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8g5aaC5p6c5L6d6LWW55qE6LWE5rqQ5bey57uP5a+85YWl5a6M5oiQ5LqG77yM5YiZ55Sf5oiQ5a+55bqU55qE5pWw5o2uXHJcbiAgICAgICAgICAgIGlmIChhc3NldC51c2VyRGF0YS50ZXh0dXJlVXVpZCAmJiBhc3NldC5fYXNzZXREQikge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZXh0X3JlcGxhY2VyID0gL1xcLlteLl0rJC87XHJcbiAgICAgICAgICAgICAgICBsZXQga2V5Tm9FeHQgPSAnJztcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZGF0YS5mcmFtZXMpO1xyXG4gICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgICAgY29uc3Qgc3ByaXRlQXRsYXMgPSBuZXcgU3ByaXRlQXRsYXMoKTtcclxuICAgICAgICAgICAgICAgIHNwcml0ZUF0bGFzLm5hbWUgPSBhc3NldC5iYXNlbmFtZSB8fCAnJztcclxuXHJcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAga2V5Tm9FeHQgPSBrZXkucmVwbGFjZShleHRfcmVwbGFjZXIsICcnKTtcclxuICAgICAgICAgICAgICAgICAgICAvLyDmlbDmja4gYXRsYXMg5YaFIHNwcml0ZUZyYW1lIOWhq+WFhVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBmID0gZGF0YS5mcmFtZXNba2V5XTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBhdGxhc1N1YkFzc2V0ID0gYXdhaXQgYXNzZXQuY3JlYXRlU3ViQXNzZXQoa2V5Tm9FeHQsICdzcHJpdGUtZnJhbWUnKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBmcmFtZURhdGEgPSBmaWxsRnJhbWVEYXRhKGYsIHVzZXJEYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICBmcmFtZURhdGEuYm9yZGVyQm90dG9tID0gZnJhbWVEYXRhLmJvcmRlckJvdHRvbSB8IGF0bGFzU3ViQXNzZXQudXNlckRhdGEuYm9yZGVyQm90dG9tO1xyXG4gICAgICAgICAgICAgICAgICAgIGZyYW1lRGF0YS5ib3JkZXJUb3AgPSBmcmFtZURhdGEuYm9yZGVyVG9wIHwgYXRsYXNTdWJBc3NldC51c2VyRGF0YS5ib3JkZXJUb3A7XHJcbiAgICAgICAgICAgICAgICAgICAgZnJhbWVEYXRhLmJvcmRlckxlZnQgPSBmcmFtZURhdGEuYm9yZGVyTGVmdCB8IGF0bGFzU3ViQXNzZXQudXNlckRhdGEuYm9yZGVyTGVmdDtcclxuICAgICAgICAgICAgICAgICAgICBmcmFtZURhdGEuYm9yZGVyUmlnaHQgPSBmcmFtZURhdGEuYm9yZGVyUmlnaHQgfCBhdGxhc1N1YkFzc2V0LnVzZXJEYXRhLmJvcmRlclJpZ2h0O1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGFzc2V0LnVzZXJEYXRhLnJlZGlyZWN0ID0gYXRsYXNTdWJBc3NldC51dWlkO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIHBhY2thYmxlIOWmguaenOacieWAvO+8jOWwseS9v+eUqCB1c2VyRGF0YSDph4znmoTlgLzvvIzkuI3pnIDopoHopobnm5ZcclxuICAgICAgICAgICAgICAgICAgICBpZiAoJ3BhY2thYmxlJyBpbiBhdGxhc1N1YkFzc2V0LnVzZXJEYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZyYW1lRGF0YVsncGFja2FibGUnXSA9IGF0bGFzU3ViQXNzZXQudXNlckRhdGFbJ3BhY2thYmxlJ107XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGF0bGFzU3ViQXNzZXQuYXNzaWduVXNlckRhdGEoZnJhbWVEYXRhLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICBhdGxhc1N1YkFzc2V0LnVzZXJEYXRhLmltYWdlVXVpZE9yRGF0YWJhc2VVcmkgPSBmcmFtZURhdGEuaW1hZ2VVdWlkT3JEYXRhYmFzZVVyaTtcclxuICAgICAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICAgICAgc3ByaXRlQXRsYXMuc3ByaXRlRnJhbWVzW2tleU5vRXh0XSA9IEVkaXRvckV4dGVuZHMuc2VyaWFsaXplLmFzQXNzZXQoYXRsYXNTdWJBc3NldC51dWlkLCBTcHJpdGVGcmFtZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VyaWFsaXplSlNPTiA9IEVkaXRvckV4dGVuZHMuc2VyaWFsaXplKHNwcml0ZUF0bGFzKTtcclxuICAgICAgICAgICAgICAgIGF3YWl0IGFzc2V0LnNhdmVUb0xpYnJhcnkoJy5qc29uJywgc2VyaWFsaXplSlNPTik7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgZGVwZW5kcyA9IGdldERlcGVuZFVVSURMaXN0KHNlcmlhbGl6ZUpTT04pO1xyXG4gICAgICAgICAgICAgICAgYXNzZXQuc2V0RGF0YSgnZGVwZW5kcycsIGRlcGVuZHMpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9LFxyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIOWIpOaWreaYr+WQpuWFgeiuuOS9v+eUqOW9k+WJjeeahCBIYW5kbGVyIOi/m+ihjOWvvOWFpVxyXG4gICAgICogQHBhcmFtIGFzc2V0XHJcbiAgICAgKi9cclxuICAgIGFzeW5jIHZhbGlkYXRlKGFzc2V0OiBBc3NldCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBwbGlzdC5wYXJzZShhd2FpdCByZWFkRmlsZShhc3NldC5zb3VyY2UsICd1dGY4JykpO1xyXG4gICAgICAgICAgICByZXR1cm4gdHlwZW9mIGRhdGEuZnJhbWVzICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgZGF0YS5tZXRhZGF0YSAhPT0gJ3VuZGVmaW5lZCc7XHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxufTtcclxuZXhwb3J0IGRlZmF1bHQgVGV4dHVyZVBhY2tlckhhbmRsZXI7XHJcblxyXG5mdW5jdGlvbiBmaWxsRnJhbWVEYXRhKGZyYW1lRGF0YTogYW55LCB1c2VyRGF0YTogSVBhY2tBdGxhcykge1xyXG4gICAgY29uc3QgZm9ybWF0ID0gdXNlckRhdGEuZm9ybWF0O1xyXG4gICAgY29uc3QgZGF0YSA9IG1ha2VEZWZhdWx0U3ByaXRlRnJhbWVBc3NldFVzZXJEYXRhRnJvbUltYWdlVXVpZCh1c2VyRGF0YS50ZXh0dXJlVXVpZCEsIHVzZXJEYXRhLnV1aWQpO1xyXG4gICAgbGV0IHJvdGF0ZWQgPSBmYWxzZTtcclxuICAgIGxldCBzb3VyY2VTaXplID0gJyc7XHJcbiAgICBsZXQgb2Zmc2V0U3RyID0gJyc7XHJcbiAgICBsZXQgdGV4dHVyZVJlY3QgPSAnJztcclxuXHJcbiAgICBpZiAoZm9ybWF0ID09PSAxIHx8IGZvcm1hdCA9PT0gMikge1xyXG4gICAgICAgIHJvdGF0ZWQgPSBmcmFtZURhdGEucm90YXRlZDtcclxuICAgICAgICBzb3VyY2VTaXplID0gZnJhbWVEYXRhLnNvdXJjZVNpemU7XHJcbiAgICAgICAgb2Zmc2V0U3RyID0gZnJhbWVEYXRhLm9mZnNldDtcclxuICAgICAgICB0ZXh0dXJlUmVjdCA9IGZyYW1lRGF0YS5mcmFtZTtcclxuICAgIH0gZWxzZSBpZiAoZm9ybWF0ID09PSAzKSB7XHJcbiAgICAgICAgcm90YXRlZCA9IGZyYW1lRGF0YS50ZXh0dXJlUm90YXRlZDtcclxuICAgICAgICBzb3VyY2VTaXplID0gZnJhbWVEYXRhLnNwcml0ZVNvdXJjZVNpemU7XHJcbiAgICAgICAgb2Zmc2V0U3RyID0gZnJhbWVEYXRhLnNwcml0ZU9mZnNldDtcclxuICAgICAgICB0ZXh0dXJlUmVjdCA9IGZyYW1lRGF0YS50ZXh0dXJlUmVjdDtcclxuICAgIH1cclxuXHJcbiAgICBkYXRhLnJvdGF0ZWQgPSByb3RhdGVkO1xyXG4gICAgY29uc3Qgb3JpZ2luU2l6ZSA9IF9wYXJzZUZsb2F0Mihzb3VyY2VTaXplLCBTaXplKSBhcyBhbnk7XHJcbiAgICBkYXRhLnJhd1dpZHRoID0gb3JpZ2luU2l6ZS53aWR0aDtcclxuICAgIGRhdGEucmF3SGVpZ2h0ID0gb3JpZ2luU2l6ZS5oZWlnaHQ7XHJcbiAgICBjb25zdCByZWN0ID0gX3BhcnNlUmVjdCh0ZXh0dXJlUmVjdCk7XHJcbiAgICBkYXRhLnRyaW1YID0gcmVjdC54O1xyXG4gICAgZGF0YS50cmltWSA9IHJlY3QueTtcclxuICAgIGRhdGEud2lkdGggPSByZWN0LndpZHRoO1xyXG4gICAgZGF0YS5oZWlnaHQgPSByZWN0LmhlaWdodDtcclxuICAgIGNvbnN0IG9mZnNldCA9IF9wYXJzZUZsb2F0MihvZmZzZXRTdHIsIFZlYzIpIGFzIGFueTtcclxuICAgIGRhdGEub2Zmc2V0WCA9IG9mZnNldC54O1xyXG4gICAgZGF0YS5vZmZzZXRZID0gb2Zmc2V0Lnk7XHJcblxyXG4gICAgcmV0dXJuIGRhdGE7XHJcbn1cclxuXHJcbmludGVyZmFjZSBJQXRsYXMge1xyXG4gICAgc2l6ZTogU2l6ZTtcclxuICAgIGF0bGFzVGV4dHVyZU5hbWU6IHN0cmluZztcclxuICAgIHRleHR1cmVVdWlkOiBzdHJpbmcgfCBudWxsO1xyXG4gICAgZnJhbWVzOiBTcHJpdGVGcmFtZUJhc2VBc3NldFVzZXJEYXRhW107XHJcbiAgICB1dWlkOiBzdHJpbmc7XHJcbn1cclxuXHJcbmNvbnN0IEJSQUNFX1JFR0VYID0gL1tcXHtcXH1dL2c7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdXNlbGVzcy1lc2NhcGVcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBfcGFyc2VGbG9hdDIoZGF0YTogc3RyaW5nLCBDdG9yOiBhbnkpIHtcclxuICAgIGNvbnN0IGFyciA9IGRhdGEuc2xpY2UoMSwgLTEpLnNwbGl0KCcsJyk7XHJcbiAgICByZXR1cm4gbmV3IEN0b3IocGFyc2VGbG9hdChhcnJbMF0pLCBwYXJzZUZsb2F0KGFyclsxXSkpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gX3BhcnNlUmVjdChyZWN0U3RyOiBzdHJpbmcpIHtcclxuICAgIHJlY3RTdHIgPSByZWN0U3RyLnJlcGxhY2UoQlJBQ0VfUkVHRVgsICcnKTtcclxuICAgIGNvbnN0IGFyciA9IHJlY3RTdHIuc3BsaXQoJywnKTtcclxuICAgIHJldHVybiBuZXcgUmVjdChwYXJzZUZsb2F0KGFyclswXSB8fCAnMCcpLCBwYXJzZUZsb2F0KGFyclsxXSB8fCAnMCcpLCBwYXJzZUZsb2F0KGFyclsyXSB8fCAnMCcpLCBwYXJzZUZsb2F0KGFyclszXSB8fCAnMCcpKTtcclxufVxyXG4iXX0=