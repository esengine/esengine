"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.GlTFTrsTrackData = exports.GlTFTrsAnimationData = void 0;
const glTF_constants_1 = require("./glTF.constants");
const cc = __importStar(require("cc"));
const exotic_animation_1 = require("cc/editor/exotic-animation");
class GlTFTrsAnimationData {
    nodes = {};
    inputs = [];
    addNodeAnimation(path) {
        return (this.nodes[path] ??= new GlTFNodeTrsAnimationData());
    }
    createExotic() {
        const exoticAnimation = new exotic_animation_1.ExoticAnimation();
        for (const [path, data] of Object.entries(this.nodes)) {
            data.emitExotic(exoticAnimation, path);
        }
        return exoticAnimation;
    }
}
exports.GlTFTrsAnimationData = GlTFTrsAnimationData;
const INPUT_0 = new Float32Array([0.0]);
class GlTFNodeTrsAnimationData {
    position = null;
    rotation = null;
    scale = null;
    setConstantPosition(v) {
        this.position = new GlTFTrsTrackData(glTF_constants_1.GlTfAnimationInterpolation.STEP, INPUT_0, cc.Vec3.toArray(new Float32Array(3), v));
    }
    setConstantRotation(v) {
        this.rotation = new GlTFTrsTrackData(glTF_constants_1.GlTfAnimationInterpolation.STEP, INPUT_0, cc.Quat.toArray(new Float32Array(4), v));
    }
    setConstantScale(v) {
        this.scale = new GlTFTrsTrackData(glTF_constants_1.GlTfAnimationInterpolation.STEP, INPUT_0, cc.Vec3.toArray(new Float32Array(3), v));
    }
    emitExotic(exoticAnimation, path) {
        const { position, rotation, scale } = this;
        if (!position && !rotation && !scale) {
            return;
        }
        const exoticNodeAnimation = exoticAnimation.addNodeAnimation(path);
        const fps = 30;
        if (position) {
            const { input, output } = position.toLinearVec3Curve(fps);
            exoticNodeAnimation.createPosition(input, output);
        }
        if (rotation) {
            const { input, output } = rotation.toLinearQuatCurveNormalized(fps);
            exoticNodeAnimation.createRotation(input, output);
        }
        if (scale) {
            const { input, output } = scale.toLinearVec3Curve(fps);
            exoticNodeAnimation.createScale(input, output);
        }
    }
}
class GlTFTrsTrackData {
    interpolation;
    input;
    output;
    constructor(interpolation, input, output) {
        this.interpolation = interpolation;
        this.input = input;
        this.output = output;
    }
    toLinearVec3Curve(fps) {
        switch (this.interpolation) {
            case glTF_constants_1.GlTfAnimationInterpolation.CUBIC_SPLINE:
                return cubicSplineToLinearCurveData(this.input, this.output, 3, fps);
            case glTF_constants_1.GlTfAnimationInterpolation.STEP:
                return constantToLinearCurveData(this.input, this.output, 3, fps);
            default:
                return { input: this.input, output: this.output };
        }
    }
    toLinearQuatCurveNormalized(fps) {
        // https://github.com/KhronosGroup/glTF/issues/2008
        const result = this.toLinearQuatCurve(fps);
        const { output } = result;
        const q = new cc.Quat();
        for (let iQuat = 0; iQuat < output.length / 4; ++iQuat) {
            cc.Quat.fromArray(q, output, 4 * iQuat);
            cc.Quat.normalize(q, q);
            cc.Quat.toArray(output, q, 4 * iQuat);
        }
        return result;
    }
    toLinearQuatCurve(fps) {
        switch (this.interpolation) {
            case glTF_constants_1.GlTfAnimationInterpolation.CUBIC_SPLINE:
                return cubicSplineToLinearCurveData(this.input, this.output, 4, fps);
            case glTF_constants_1.GlTfAnimationInterpolation.STEP:
                return constantToLinearCurveData(this.input, this.output, 4, fps);
            default:
                return { input: this.input, output: this.output };
        }
    }
}
exports.GlTFTrsTrackData = GlTFTrsTrackData;
function calculateBakeParams(times, fps) {
    const startTime = times[0];
    const endTime = times[times.length - 1];
    const interval = 1.0 / fps;
    const count = (endTime - startTime) / interval;
    return {
        startTime,
        endTime,
        interval,
        count,
    };
}
function createTimesFromBakeParams(bakeParams, Constructor) {
    const { startTime, endTime, interval, count } = bakeParams;
    const result = new Constructor(count);
    for (let i = 0; i < count; i++) {
        result[i] = i === count - 1 ? endTime : startTime + interval * i;
    }
    return result;
}
function constantToLinearCurveData(times, values, components, fps) {
    if (times.length < 2) {
        return {
            input: times,
            output: values,
        };
    }
    const nValue = values.length / components;
    const bakeParams = calculateBakeParams(times, fps);
    const outputs = new Float32Array(components * bakeParams.count);
    for (let iComponent = 0; iComponent < components; ++iComponent) {
        const curve = new cc.RealCurve();
        curve.assignSorted(Array.from(times), Array.from({ length: nValue }, (_, iKeyframe) => ({
            value: values[components * iKeyframe + iComponent],
            interpolationMode: cc.RealInterpolationMode.CONSTANT,
        })));
        bake(curve, bakeParams, outputs, components, iComponent);
    }
    return {
        input: createTimesFromBakeParams(bakeParams, Float32Array),
        output: outputs,
    };
}
function cubicSplineToLinearCurveData(times, values, components, fps) {
    if (times.length < 2) {
        return {
            input: times,
            output: values,
        };
    }
    const nValue = values.length / (components * 3);
    const bakeParams = calculateBakeParams(times, fps);
    const outputs = new Float32Array(components * bakeParams.count);
    for (let iComponent = 0; iComponent < components; ++iComponent) {
        const curve = new cc.RealCurve();
        curve.assignSorted(Array.from(times), Array.from({ length: nValue }, (_, iKeyframe) => {
            const pComponentFrame = components * 3 * iKeyframe + iComponent;
            const inTangent = values[pComponentFrame + components * 0];
            const dataPoint = values[pComponentFrame + components * 1];
            const outTangent = values[pComponentFrame + components * 2];
            return {
                value: dataPoint,
                leftTangent: inTangent,
                rightTangent: outTangent,
                interpolationMode: cc.RealInterpolationMode.CUBIC,
            };
        }));
        bake(curve, bakeParams, outputs, components, iComponent);
    }
    return {
        input: createTimesFromBakeParams(bakeParams, Float32Array),
        output: outputs,
    };
}
function bake(curve, bakeParams, output, stride, offset) {
    const { startTime, endTime, interval, count } = bakeParams;
    let time = startTime;
    for (let i = 0; i < count; ++i, time += interval) {
        const value = curve.evaluate(i === count - 1 ? endTime : time);
        output[stride * i + offset] = value;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2xURi1hbmltYXRpb24tdXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9hc3NldHMvYXNzZXQtaGFuZGxlci9hc3NldHMvdXRpbHMvZ2xURi1hbmltYXRpb24tdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEscURBQThEO0FBQzlELHVDQUF5QjtBQUN6QixpRUFBNkQ7QUFNN0QsTUFBYSxvQkFBb0I7SUFDdEIsS0FBSyxHQUE2QyxFQUFFLENBQUM7SUFDckQsTUFBTSxHQUFpQixFQUFFLENBQUM7SUFFMUIsZ0JBQWdCLENBQUMsSUFBWTtRQUNoQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLHdCQUF3QixFQUFFLENBQUMsQ0FBQztJQUNqRSxDQUFDO0lBRU0sWUFBWTtRQUNmLE1BQU0sZUFBZSxHQUFHLElBQUksa0NBQWUsRUFBRSxDQUFDO1FBQzlDLEtBQUssTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQ3BELElBQUksQ0FBQyxVQUFVLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzNDLENBQUM7UUFDRCxPQUFPLGVBQWUsQ0FBQztJQUMzQixDQUFDO0NBQ0o7QUFmRCxvREFlQztBQUVELE1BQU0sT0FBTyxHQUFHLElBQUksWUFBWSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUV4QyxNQUFNLHdCQUF3QjtJQUNuQixRQUFRLEdBQTRCLElBQUksQ0FBQztJQUN6QyxRQUFRLEdBQTRCLElBQUksQ0FBQztJQUN6QyxLQUFLLEdBQTRCLElBQUksQ0FBQztJQUV0QyxtQkFBbUIsQ0FBQyxDQUFVO1FBQ2pDLElBQUksQ0FBQyxRQUFR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NUQsT0FBTztnQkFDSCxLQUFLLEVBQUUsU0FBUztnQkFDaEIsV0FBVyxFQUFFLFNBQVM7Z0JBQ3RCLFlBQVksRUFBRSxVQUFVO2dCQUN4QixpQkFBaUIsRUFBRSxFQUFFLENBQUMscUJBQXFCLENBQUMsS0FBSzthQUNwRCxDQUFDO1FBQ04sQ0FBQyxDQUFDLENBQ0wsQ0FBQztRQUNGLElBQUksQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDN0QsQ0FBQztJQUNELE9BQU87UUFDSCxLQUFLLEVBQUUseUJBQXlCLENBQUMsVUFBVSxFQUFFLFlBQVksQ0FBQztRQUMxRCxNQUFNLEVBQUUsT0FBTztLQUNsQixDQUFDO0FBQ04sQ0FBQztBQUVELFNBQVMsSUFBSSxDQUFDLEtBQW1CLEVBQUUsVUFBc0IsRUFBRSxNQUErQixFQUFFLE1BQWMsRUFBRSxNQUFjO0lBQ3RILE1BQU0sRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsR0FBRyxVQUFVLENBQUM7SUFDM0QsSUFBSSxJQUFJLEdBQUcsU0FBUyxDQUFDO0lBQ3JCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLEVBQUUsRUFBRSxDQUFDLEVBQUUsSUFBSSxJQUFJLFFBQVEsRUFBRSxDQUFDO1FBQy9DLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxLQUFLLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDL0QsTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDLEdBQUcsS0FBSyxDQUFDO0lBQ3hDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgR2xUZkFuaW1hdGlvbkludGVycG9sYXRpb24gfSBmcm9tICcuL2dsVEYuY29uc3RhbnRzJztcclxuaW1wb3J0ICogYXMgY2MgZnJvbSAnY2MnO1xyXG5pbXBvcnQgeyBFeG90aWNBbmltYXRpb24gfSBmcm9tICdjYy9lZGl0b3IvZXhvdGljLWFuaW1hdGlvbic7XHJcblxyXG50eXBlIEZsb2F0QXJyYXkgPSBGbG9hdDMyQXJyYXkgfCBGbG9hdDY0QXJyYXk7XHJcblxyXG50eXBlIE51bWJlckFycmF5T3JGbG9hdEFycmF5ID0gbnVtYmVyW10gfCBGbG9hdEFycmF5O1xyXG5cclxuZXhwb3J0IGNsYXNzIEdsVEZUcnNBbmltYXRpb25EYXRhIHtcclxuICAgIHB1YmxpYyBub2RlczogUmVjb3JkPHN0cmluZywgR2xURk5vZGVUcnNBbmltYXRpb25EYXRhPiA9IHt9O1xyXG4gICAgcHVibGljIGlucHV0czogRmxvYXRBcnJheVtdID0gW107XHJcblxyXG4gICAgcHVibGljIGFkZE5vZGVBbmltYXRpb24ocGF0aDogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuICh0aGlzLm5vZGVzW3BhdGhdID8/PSBuZXcgR2xURk5vZGVUcnNBbmltYXRpb25EYXRhKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjcmVhdGVFeG90aWMoKSB7XHJcbiAgICAgICAgY29uc3QgZXhvdGljQW5pbWF0aW9uID0gbmV3IEV4b3RpY0FuaW1hdGlvbigpO1xyXG4gICAgICAgIGZvciAoY29uc3QgW3BhdGgsIGRhdGFdIG9mIE9iamVjdC5lbnRyaWVzKHRoaXMubm9kZXMpKSB7XHJcbiAgICAgICAgICAgIGRhdGEuZW1pdEV4b3RpYyhleG90aWNBbmltYXRpb24sIHBhdGgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZXhvdGljQW5pbWF0aW9uO1xyXG4gICAgfVxyXG59XHJcblxyXG5jb25zdCBJTlBVVF8wID0gbmV3IEZsb2F0MzJBcnJheShbMC4wXSk7XHJcblxyXG5jbGFzcyBHbFRGTm9kZVRyc0FuaW1hdGlvbkRhdGEge1xyXG4gICAgcHVibGljIHBvc2l0aW9uOiBHbFRGVHJzVHJhY2tEYXRhIHwgbnVsbCA9IG51bGw7XHJcbiAgICBwdWJsaWMgcm90YXRpb246IEdsVEZUcnNUcmFja0RhdGEgfCBudWxsID0gbnVsbDtcclxuICAgIHB1YmxpYyBzY2FsZTogR2xURlRyc1RyYWNrRGF0YSB8IG51bGwgPSBudWxsO1xyXG5cclxuICAgIHB1YmxpYyBzZXRDb25zdGFudFBvc2l0aW9uKHY6IGNjLlZlYzMpIHtcclxuICAgICAgICB0aGlzLnBvc2l0aW9uID0gbmV3IEdsVEZUcnNUcmFja0RhdGEoR2xUZkFuaW1hdGlvbkludGVycG9sYXRpb24uU1RFUCwgSU5QVVRfMCwgY2MuVmVjMy50b0FycmF5KG5ldyBGbG9hdDMyQXJyYXkoMyksIHYpKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc2V0Q29uc3RhbnRSb3RhdGlvbih2OiBjYy5RdWF0KSB7XHJcbiAgICAgICAgdGhpcy5yb3RhdGlvbiA9IG5ldyBHbFRGVHJzVHJhY2tEYXRhKEdsVGZBbmltYXRpb25JbnRlcnBvbGF0aW9uLlNURVAsIElOUFVUXzAsIGNjLlF1YXQudG9BcnJheShuZXcgRmxvYXQzMkFycmF5KDQpLCB2KSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNldENvbnN0YW50U2NhbGUodjogY2MuVmVjMykge1xyXG4gICAgICAgIHRoaXMuc2NhbGUgPSBuZXcgR2xURlRyc1RyYWNrRGF0YShHbFRmQW5pbWF0aW9uSW50ZXJwb2xhdGlvbi5TVEVQLCBJTlBVVF8wLCBjYy5WZWMzLnRvQXJyYXkobmV3IEZsb2F0MzJBcnJheSgzKSwgdikpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBlbWl0RXhvdGljKGV4b3RpY0FuaW1hdGlvbjogRXhvdGljQW5pbWF0aW9uLCBwYXRoOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCB7IHBvc2l0aW9uLCByb3RhdGlvbiwgc2NhbGUgfSA9IHRoaXM7XHJcbiAgICAgICAgaWYgKCFwb3NpdGlvbiAmJiAhcm90YXRpb24gJiYgIXNjYWxlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZXhvdGljTm9kZUFuaW1hdGlvbiA9IGV4b3RpY0FuaW1hdGlvbi5hZGROb2RlQW5pbWF0aW9uKHBhdGgpO1xyXG4gICAgICAgIGNvbnN0IGZwcyA9IDMwO1xyXG4gICAgICAgIGlmIChwb3NpdGlvbikge1xyXG4gICAgICAgICAgICBjb25zdCB7IGlucHV0LCBvdXRwdXQgfSA9IHBvc2l0aW9uLnRvTGluZWFyVmVjM0N1cnZlKGZwcyk7XHJcbiAgICAgICAgICAgIGV4b3RpY05vZGVBbmltYXRpb24uY3JlYXRlUG9zaXRpb24oaW5wdXQsIG91dHB1dCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChyb3RhdGlvbikge1xyXG4gICAgICAgICAgICBjb25zdCB7IGlucHV0LCBvdXRwdXQgfSA9IHJvdGF0aW9uLnRvTGluZWFyUXVhdEN1cnZlTm9ybWFsaXplZChmcHMpO1xyXG4gICAgICAgICAgICBleG90aWNOb2RlQW5pbWF0aW9uLmNyZWF0ZVJvdGF0aW9uKGlucHV0LCBvdXRwdXQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoc2NhbGUpIHtcclxuICAgICAgICAgICAgY29uc3QgeyBpbnB1dCwgb3V0cHV0IH0gPSBzY2FsZS50b0xpbmVhclZlYzNDdXJ2ZShmcHMpO1xyXG4gICAgICAgICAgICBleG90aWNOb2RlQW5pbWF0aW9uLmNyZWF0ZVNjYWxlKGlucHV0LCBvdXRwdXQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEdsVEZUcnNUcmFja0RhdGEge1xyXG4gICAgY29uc3RydWN0b3IocHVibGljIGludGVycG9sYXRpb246IEdsVGZBbmltYXRpb25JbnRlcnBvbGF0aW9uLCBwdWJsaWMgaW5wdXQ6IEZsb2F0QXJyYXksIHB1YmxpYyBvdXRwdXQ6IEZsb2F0QXJyYXkpIHt9XHJcblxyXG4gICAgcHVibGljIHRvTGluZWFyVmVjM0N1cnZlKGZwczogbnVtYmVyKSB7XHJcbiAgICAgICAgc3dpdGNoICh0aGlzLmludGVycG9sYXRpb24pIHtcclxuICAgICAgICAgICAgY2FzZSBHbFRmQW5pbWF0aW9uSW50ZXJwb2xhdGlvbi5DVUJJQ19TUExJTkU6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gY3ViaWNTcGxpbmVUb0xpbmVhckN1cnZlRGF0YSh0aGlzLmlucHV0LCB0aGlzLm91dHB1dCwgMywgZnBzKTtcclxuICAgICAgICAgICAgY2FzZSBHbFRmQW5pbWF0aW9uSW50ZXJwb2xhdGlvbi5TVEVQOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbnN0YW50VG9MaW5lYXJDdXJ2ZURhdGEodGhpcy5pbnB1dCwgdGhpcy5vdXRwdXQsIDMsIGZwcyk7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4geyBpbnB1dDogdGhpcy5pbnB1dCwgb3V0cHV0OiB0aGlzLm91dHB1dCB9O1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgdG9MaW5lYXJRdWF0Q3VydmVOb3JtYWxpemVkKGZwczogbnVtYmVyKSB7XHJcbiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL0tocm9ub3NHcm91cC9nbFRGL2lzc3Vlcy8yMDA4XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy50b0xpbmVhclF1YXRDdXJ2ZShmcHMpO1xyXG4gICAgICAgIGNvbnN0IHsgb3V0cHV0IH0gPSByZXN1bHQ7XHJcbiAgICAgICAgY29uc3QgcSA9IG5ldyBjYy5RdWF0KCk7XHJcbiAgICAgICAgZm9yIChsZXQgaVF1YXQgPSAwOyBpUXVhdCA8IG91dHB1dC5sZW5ndGggLyA0OyArK2lRdWF0KSB7XHJcbiAgICAgICAgICAgIGNjLlF1YXQuZnJvbUFycmF5KHEsIG91dHB1dCwgNCAqIGlRdWF0KTtcclxuICAgICAgICAgICAgY2MuUXVhdC5ub3JtYWxpemUocSwgcSk7XHJcbiAgICAgICAgICAgIGNjLlF1YXQudG9BcnJheShvdXRwdXQsIHEsIDQgKiBpUXVhdCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHRvTGluZWFyUXVhdEN1cnZlKGZwczogbnVtYmVyKSB7XHJcbiAgICAgICAgc3dpdGNoICh0aGlzLmludGVycG9sYXRpb24pIHtcclxuICAgICAgICAgICAgY2FzZSBHbFRmQW5pbWF0aW9uSW50ZXJwb2xhdGlvbi5DVUJJQ19TUExJTkU6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gY3ViaWNTcGxpbmVUb0xpbmVhckN1cnZlRGF0YSh0aGlzLmlucHV0LCB0aGlzLm91dHB1dCwgNCwgZnBzKTtcclxuICAgICAgICAgICAgY2FzZSBHbFRmQW5pbWF0aW9uSW50ZXJwb2xhdGlvbi5TVEVQOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbnN0YW50VG9MaW5lYXJDdXJ2ZURhdGEodGhpcy5pbnB1dCwgdGhpcy5vdXRwdXQsIDQsIGZwcyk7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4geyBpbnB1dDogdGhpcy5pbnB1dCwgb3V0cHV0OiB0aGlzLm91dHB1dCB9O1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuaW50ZXJmYWNlIEJha2VQYXJhbXMge1xyXG4gICAgc3RhcnRUaW1lOiBudW1iZXI7XHJcbiAgICBlbmRUaW1lOiBudW1iZXI7XHJcbiAgICBpbnRlcnZhbDogbnVtYmVyO1xyXG4gICAgY291bnQ6IG51bWJlcjtcclxufVxyXG5cclxuZnVuY3Rpb24gY2FsY3VsYXRlQmFrZVBhcmFtcyh0aW1lczogRmxvYXRBcnJheSwgZnBzOiBudW1iZXIpOiBCYWtlUGFyYW1zIHtcclxuICAgIGNvbnN0IHN0YXJ0VGltZSA9IHRpbWVzWzBdO1xyXG4gICAgY29uc3QgZW5kVGltZSA9IHRpbWVzW3RpbWVzLmxlbmd0aCAtIDFdO1xyXG4gICAgY29uc3QgaW50ZXJ2YWwgPSAxLjAgLyBmcHM7XHJcbiAgICBjb25zdCBjb3VudCA9IChlbmRUaW1lIC0gc3RhcnRUaW1lKSAvIGludGVydmFsO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBzdGFydFRpbWUsXHJcbiAgICAgICAgZW5kVGltZSxcclxuICAgICAgICBpbnRlcnZhbCxcclxuICAgICAgICBjb3VudCxcclxuICAgIH07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNyZWF0ZVRpbWVzRnJvbUJha2VQYXJhbXMoYmFrZVBhcmFtczogQmFrZVBhcmFtcywgQ29uc3RydWN0b3I6IEZsb2F0MzJBcnJheUNvbnN0cnVjdG9yIHwgRmxvYXQ2NEFycmF5Q29uc3RydWN0b3IpOiBGbG9hdEFycmF5IHtcclxuICAgIGNvbnN0IHsgc3RhcnRUaW1lLCBlbmRUaW1lLCBpbnRlcnZhbCwgY291bnQgfSA9IGJha2VQYXJhbXM7XHJcbiAgICBjb25zdCByZXN1bHQgPSBuZXcgQ29uc3RydWN0b3IoY291bnQpO1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7XHJcbiAgICAgICAgcmVzdWx0W2ldID0gaSA9PT0gY291bnQgLSAxID8gZW5kVGltZSA6IHN0YXJ0VGltZSArIGludGVydmFsICogaTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbnN0YW50VG9MaW5lYXJDdXJ2ZURhdGEodGltZXM6IEZsb2F0QXJyYXksIHZhbHVlczogRmxvYXRBcnJheSwgY29tcG9uZW50czogbnVtYmVyLCBmcHM6IG51bWJlcikge1xyXG4gICAgaWYgKHRpbWVzLmxlbmd0aCA8IDIpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBpbnB1dDogdGltZXMsXHJcbiAgICAgICAgICAgIG91dHB1dDogdmFsdWVzLFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbiAgICBjb25zdCBuVmFsdWUgPSB2YWx1ZXMubGVuZ3RoIC8gY29tcG9uZW50cztcclxuICAgIGNvbnN0IGJha2VQYXJhbXMgPSBjYWxjdWxhdGVCYWtlUGFyYW1zKHRpbWVzLCBmcHMpO1xyXG4gICAgY29uc3Qgb3V0cHV0cyA9IG5ldyBGbG9hdDMyQXJyYXkoY29tcG9uZW50cyAqIGJha2VQYXJhbXMuY291bnQpO1xyXG4gICAgZm9yIChsZXQgaUNvbXBvbmVudCA9IDA7IGlDb21wb25lbnQgPCBjb21wb25lbnRzOyArK2lDb21wb25lbnQpIHtcclxuICAgICAgICBjb25zdCBjdXJ2ZSA9IG5ldyBjYy5SZWFsQ3VydmUoKTtcclxuICAgICAgICBjdXJ2ZS5hc3NpZ25Tb3J0ZWQoXHJcbiAgICAgICAgICAgIEFycmF5LmZyb20odGltZXMpLFxyXG4gICAgICAgICAgICBBcnJheS5mcm9tKHsgbGVuZ3RoOiBuVmFsdWUgfSwgKF8sIGlLZXlmcmFtZSkgPT4gKHtcclxuICAgICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZXNbY29tcG9uZW50cyAqIGlLZXlmcmFtZSArIGlDb21wb25lbnRdLFxyXG4gICAgICAgICAgICAgICAgaW50ZXJwb2xhdGlvbk1vZGU6IGNjLlJlYWxJbnRlcnBvbGF0aW9uTW9kZS5DT05TVEFOVCxcclxuICAgICAgICAgICAgfSkpLFxyXG4gICAgICAgICk7XHJcbiAgICAgICAgYmFrZShjdXJ2ZSwgYmFrZVBhcmFtcywgb3V0cHV0cywgY29tcG9uZW50cywgaUNvbXBvbmVudCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGlucHV0OiBjcmVhdGVUaW1lc0Zyb21CYWtlUGFyYW1zKGJha2VQYXJhbXMsIEZsb2F0MzJBcnJheSksXHJcbiAgICAgICAgb3V0cHV0OiBvdXRwdXRzLFxyXG4gICAgfTtcclxufVxyXG5cclxuZnVuY3Rpb24gY3ViaWNTcGxpbmVUb0xpbmVhckN1cnZlRGF0YSh0aW1lczogRmxvYXRBcnJheSwgdmFsdWVzOiBGbG9hdEFycmF5LCBjb21wb25lbnRzOiBudW1iZXIsIGZwczogbnVtYmVyKSB7XHJcbiAgICBpZiAodGltZXMubGVuZ3RoIDwgMikge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGlucHV0OiB0aW1lcyxcclxuICAgICAgICAgICAgb3V0cHV0OiB2YWx1ZXMsXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIGNvbnN0IG5WYWx1ZSA9IHZhbHVlcy5sZW5ndGggLyAoY29tcG9uZW50cyAqIDMpO1xyXG4gICAgY29uc3QgYmFrZVBhcmFtcyA9IGNhbGN1bGF0ZUJha2VQYXJhbXModGltZXMsIGZwcyk7XHJcbiAgICBjb25zdCBvdXRwdXRzID0gbmV3IEZsb2F0MzJBcnJheShjb21wb25lbnRzICogYmFrZVBhcmFtcy5jb3VudCk7XHJcbiAgICBmb3IgKGxldCBpQ29tcG9uZW50ID0gMDsgaUNvbXBvbmVudCA8IGNvbXBvbmVudHM7ICsraUNvbXBvbmVudCkge1xyXG4gICAgICAgIGNvbnN0IGN1cnZlID0gbmV3IGNjLlJlYWxDdXJ2ZSgpO1xyXG4gICAgICAgIGN1cnZlLmFzc2lnblNvcnRlZChcclxuICAgICAgICAgICAgQXJyYXkuZnJvbSh0aW1lcyksXHJcbiAgICAgICAgICAgIEFycmF5LmZyb20oeyBsZW5ndGg6IG5WYWx1ZSB9LCAoXywgaUtleWZyYW1lKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwQ29tcG9uZW50RnJhbWUgPSBjb21wb25lbnRzICogMyAqIGlLZXlmcmFtZSArIGlDb21wb25lbnQ7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpblRhbmdlbnQgPSB2YWx1ZXNbcENvbXBvbmVudEZyYW1lICsgY29tcG9uZW50cyAqIDBdO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YVBvaW50ID0gdmFsdWVzW3BDb21wb25lbnRGcmFtZSArIGNvbXBvbmVudHMgKiAxXTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG91dFRhbmdlbnQgPSB2YWx1ZXNbcENvbXBvbmVudEZyYW1lICsgY29tcG9uZW50cyAqIDJdO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZGF0YVBvaW50LFxyXG4gICAgICAgICAgICAgICAgICAgIGxlZnRUYW5nZW50OiBpblRhbmdlbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgcmlnaHRUYW5nZW50OiBvdXRUYW5nZW50LFxyXG4gICAgICAgICAgICAgICAgICAgIGludGVycG9sYXRpb25Nb2RlOiBjYy5SZWFsSW50ZXJwb2xhdGlvbk1vZGUuQ1VCSUMsXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICApO1xyXG4gICAgICAgIGJha2UoY3VydmUsIGJha2VQYXJhbXMsIG91dHB1dHMsIGNvbXBvbmVudHMsIGlDb21wb25lbnQpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBpbnB1dDogY3JlYXRlVGltZXNGcm9tQmFrZVBhcmFtcyhiYWtlUGFyYW1zLCBGbG9hdDMyQXJyYXkpLFxyXG4gICAgICAgIG91dHB1dDogb3V0cHV0cyxcclxuICAgIH07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGJha2UoY3VydmU6IGNjLlJlYWxDdXJ2ZSwgYmFrZVBhcmFtczogQmFrZVBhcmFtcywgb3V0cHV0OiBOdW1iZXJBcnJheU9yRmxvYXRBcnJheSwgc3RyaWRlOiBudW1iZXIsIG9mZnNldDogbnVtYmVyKSB7XHJcbiAgICBjb25zdCB7IHN0YXJ0VGltZSwgZW5kVGltZSwgaW50ZXJ2YWwsIGNvdW50IH0gPSBiYWtlUGFyYW1zO1xyXG4gICAgbGV0IHRpbWUgPSBzdGFydFRpbWU7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyArK2ksIHRpbWUgKz0gaW50ZXJ2YWwpIHtcclxuICAgICAgICBjb25zdCB2YWx1ZSA9IGN1cnZlLmV2YWx1YXRlKGkgPT09IGNvdW50IC0gMSA/IGVuZFRpbWUgOiB0aW1lKTtcclxuICAgICAgICBvdXRwdXRbc3RyaWRlICogaSArIG9mZnNldF0gPSB2YWx1ZTtcclxuICAgIH1cclxufVxyXG4iXX0=