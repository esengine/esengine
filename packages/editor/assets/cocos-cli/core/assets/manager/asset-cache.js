"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AssetCache = void 0;
exports.calcMd5 = calcMd5;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
const HASH_LEN = 5;
/**
 * 计算某个数据的 md5 值
 * @param data
 */
function calcMd5(data) {
    data = Array.isArray(data) ? data : [data];
    const { createHash } = require('crypto');
    const cryptoHash = createHash('md5');
    data.forEach((dataItem) => {
        cryptoHash.update(dataItem);
    });
    return cryptoHash.digest('hex').slice(0, HASH_LEN);
}
class AssetCache {
    _cacheMap = {};
    _tmpDir;
    constructor(tmp) {
        this._tmpDir = tmp;
    }
    _getCacheFilePath(asset, md5Key) {
        return (0, path_1.join)(this._tmpDir, 'asset-db', asset.uuid.slice(0, 2), asset.uuid, md5Key);
    }
    async add(asset, options, path) {
        const md5Key = calcMd5(JSON.stringify(options));
        const cachePath = this._getCacheFilePath(asset, md5Key + (0, path_1.extname)(path));
        try {
            await (0, fs_extra_1.copy)(path, cachePath);
            this._cacheMap[asset.uuid] = {
                path,
                md5Key,
            };
        }
        catch (error) {
            console.warn(error);
            return false;
        }
        return true;
    }
    query(uuid, options) {
        const md5Key = JSON.stringify(options);
        const cacheInfo = this._cacheMap[uuid];
        if (cacheInfo.md5Key === md5Key) {
            return cacheInfo.path;
        }
        return null;
    }
}
exports.AssetCache = AssetCache;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQtY2FjaGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29yZS9hc3NldHMvbWFuYWdlci9hc3NldC1jYWNoZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFVQSwwQkFRQztBQWxCRCx1Q0FBZ0M7QUFDaEMsK0JBQXFDO0FBR3JDLE1BQU0sUUFBUSxHQUFHLENBQUMsQ0FBQztBQUVuQjs7O0dBR0c7QUFDSCxTQUFnQixPQUFPLENBQUMsSUFBZ0Q7SUFDcEUsSUFBSSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMzQyxNQUFNLEVBQUUsVUFBVSxFQUFFLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3pDLE1BQU0sVUFBVSxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNyQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7UUFDdEIsVUFBVSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNoQyxDQUFDLENBQUMsQ0FBQztJQUNILE9BQU8sVUFBVSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQ3ZELENBQUM7QUFFRCxNQUFhLFVBQVU7SUFDbkIsU0FBUyxHQUdKLEVBQUUsQ0FBQztJQUNSLE9BQU8sQ0FBUztJQUVoQixZQUFZLEdBQVc7UUFDbkIsSUFBSSxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUM7SUFDdkIsQ0FBQztJQUVELGlCQUFpQixDQUFDLEtBQWEsRUFBRSxNQUFjO1FBQzNDLE9BQU8sSUFBQSxXQUFJLEVBQ1AsSUFBSSxDQUFDLE9BQU8sRUFDWixVQUFVLEVBQ1YsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUN0QixLQUFLLENBQUMsSUFBSSxFQUNWLE1BQU0sQ0FDVCxDQUFDO0lBQ04sQ0FBQztJQUVELEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBYSxFQUFFLE9BQXVCLEVBQUUsSUFBWTtRQUMxRCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ2hELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLEVBQUUsTUFBTSxHQUFHLElBQUEsY0FBTyxFQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDeEUsSUFBSSxDQUFDO1lBQ0QsTUFBTSxJQUFBLGVBQUksRUFBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFDNUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUc7Z0JBQ3pCLElBQUk7Z0JBQ0osTUFBTTthQUNULENBQUM7UUFDTixDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNiLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDcEIsT0FBTyxLQUFLLENBQUM7UUFDakIsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxLQUFLLENBQUMsSUFBWSxFQUFFLE9BQXVCO1FBQ3ZDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdkMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2QyxJQUFJLFNBQVMsQ0FBQyxNQUFNLEtBQUssTUFBTSxFQUFFLENBQUM7WUFDOUIsT0FBTyxTQUFTLENBQUMsSUFBSSxDQUFDO1FBQzFCLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0NBRUo7QUE5Q0QsZ0NBOENDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY29weSB9IGZyb20gJ2ZzLWV4dHJhJztcclxuaW1wb3J0IHsgZXh0bmFtZSwgam9pbiB9IGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgeyBJQXNzZXQsIElFeHBvcnRPcHRpb25zIH0gZnJvbSAnLi4vQHR5cGVzL3ByaXZhdGUnO1xyXG5cclxuY29uc3QgSEFTSF9MRU4gPSA1O1xyXG5cclxuLyoqXHJcbiAqIOiuoeeul+afkOS4quaVsOaNrueahCBtZDUg5YC8XHJcbiAqIEBwYXJhbSBkYXRhXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gY2FsY01kNShkYXRhOiAoQnVmZmVyIHwgc3RyaW5nKSB8IEFycmF5PEJ1ZmZlciB8IHN0cmluZz4pOiBzdHJpbmcge1xyXG4gICAgZGF0YSA9IEFycmF5LmlzQXJyYXkoZGF0YSkgPyBkYXRhIDogW2RhdGFdO1xyXG4gICAgY29uc3QgeyBjcmVhdGVIYXNoIH0gPSByZXF1aXJlKCdjcnlwdG8nKTtcclxuICAgIGNvbnN0IGNyeXB0b0hhc2ggPSBjcmVhdGVIYXNoKCdtZDUnKTtcclxuICAgIGRhdGEuZm9yRWFjaCgoZGF0YUl0ZW0pID0+IHtcclxuICAgICAgICBjcnlwdG9IYXNoLnVwZGF0ZShkYXRhSXRlbSk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBjcnlwdG9IYXNoLmRpZ2VzdCgnaGV4Jykuc2xpY2UoMCwgSEFTSF9MRU4pO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgQXNzZXRDYWNoZSB7XHJcbiAgICBfY2FjaGVNYXA6IFJlY29yZDxzdHJpbmcsIHtcclxuICAgICAgICBwYXRoOiBzdHJpbmc7XHJcbiAgICAgICAgbWQ1S2V5OiBzdHJpbmc7XHJcbiAgICB9PiA9IHt9O1xyXG4gICAgX3RtcERpcjogc3RyaW5nO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHRtcDogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5fdG1wRGlyID0gdG1wO1xyXG4gICAgfVxyXG5cclxuICAgIF9nZXRDYWNoZUZpbGVQYXRoKGFzc2V0OiBJQXNzZXQsIG1kNUtleTogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIGpvaW4oXHJcbiAgICAgICAgICAgIHRoaXMuX3RtcERpcixcclxuICAgICAgICAgICAgJ2Fzc2V0LWRiJyxcclxuICAgICAgICAgICAgYXNzZXQudXVpZC5zbGljZSgwLCAyKSxcclxuICAgICAgICAgICAgYXNzZXQudXVpZCxcclxuICAgICAgICAgICAgbWQ1S2V5LFxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgYWRkKGFzc2V0OiBJQXNzZXQsIG9wdGlvbnM6IElFeHBvcnRPcHRpb25zLCBwYXRoOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBtZDVLZXkgPSBjYWxjTWQ1KEpTT04uc3RyaW5naWZ5KG9wdGlvbnMpKTtcclxuICAgICAgICBjb25zdCBjYWNoZVBhdGggPSB0aGlzLl9nZXRDYWNoZUZpbGVQYXRoKGFzc2V0LCBtZDVLZXkgKyBleHRuYW1lKHBhdGgpKTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBhd2FpdCBjb3B5KHBhdGgsIGNhY2hlUGF0aCk7XHJcbiAgICAgICAgICAgIHRoaXMuX2NhY2hlTWFwW2Fzc2V0LnV1aWRdID0ge1xyXG4gICAgICAgICAgICAgICAgcGF0aCxcclxuICAgICAgICAgICAgICAgIG1kNUtleSxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLndhcm4oZXJyb3IpO1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIHF1ZXJ5KHV1aWQ6IHN0cmluZywgb3B0aW9uczogSUV4cG9ydE9wdGlvbnMpIHtcclxuICAgICAgICBjb25zdCBtZDVLZXkgPSBKU09OLnN0cmluZ2lmeShvcHRpb25zKTtcclxuICAgICAgICBjb25zdCBjYWNoZUluZm8gPSB0aGlzLl9jYWNoZU1hcFt1dWlkXTtcclxuICAgICAgICBpZiAoY2FjaGVJbmZvLm1kNUtleSA9PT0gbWQ1S2V5KSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjYWNoZUluZm8ucGF0aDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==