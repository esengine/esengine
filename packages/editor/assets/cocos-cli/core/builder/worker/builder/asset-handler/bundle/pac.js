"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.sortBundleInPac = sortBundleInPac;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
const bundle_utils_1 = require("../../../../share/bundle-utils");
const asset_library_1 = require("../../manager/asset-library");
const i18n_1 = __importDefault(require("../../../../../base/i18n"));
function sortBundleInPac(bundles, atlas, pacInfo, dependedAssets, imageCompressManager) {
    const { removeTextureInBundle, removeImageInBundle, removeSpriteAtlasInBundle } = pacInfo.packOptions;
    let firstBundleContainAtlasImage = null;
    const bundlesWithSamePriority = [];
    // 一个 AutoAtlas 可能会生成多张大图
    const imageUuid = atlas.imageUuid;
    const textureUuid = atlas.textureUuid;
    for (const bundle of bundles) {
        if (!bundle.output) {
            continue;
        }
        const taskResult = bundle.atlasRes;
        const assets = bundle.assetsWithoutRedirect;
        const assetsMap = new Set(assets);
        if (!assetsMap.has(pacInfo.uuid) &&
            !pacInfo.spriteFrames.find((x) => assetsMap.has(x._uuid))) {
            continue;
        }
        const spriteFrameUuids = [];
        const inBundle = pacInfo.path.startsWith(bundle.root + '/');
        if (inBundle) {
            console.debug(`Asset {asset(${pacInfo.path})} is Bundle`);
        }
        for (const spriteFrameInfo of atlas.spriteFrameInfos) {
            if (bundle.getRedirect(spriteFrameInfo.uuid)) {
                continue;
            }
            bundle.addAssetWithUuid(spriteFrameInfo.uuid);
            // 将小图信息从原有分组中删除
            bundle.removeFromGroups(spriteFrameInfo.uuid);
            if (!dependedAssets[spriteFrameInfo.textureUuid] && (removeTextureInBundle || !inBundle)) {
                bundle.removeAsset(spriteFrameInfo.textureUuid);
            }
            else if (dependedAssets[spriteFrameInfo.textureUuid] && !inBundle) {
                // 自动图集内的 texture 资源被使用后不剔除，但需要警告
                // https://github.com/cocos-creator/3d-tasks/issues/4014
                console.warn(i18n_1.default.t('builder.tips.use_texture_in_atlas', {
                    info: `{asset(${spriteFrameInfo.textureUuid})}`,
                    useInfo: `{asset(${dependedAssets[spriteFrameInfo.textureUuid].toString()})}`,
                }));
            }
            // !dependedAssets[spriteFrameInfo.textureUuid]: 由于 texture 与 image 之间的依赖关系，当 texture 被引用时，image 也不能剔除
            if (!dependedAssets[spriteFrameInfo.imageUuid] && (removeImageInBundle || !inBundle) && !dependedAssets[spriteFrameInfo.textureUuid]) {
                bundle.removeAsset(spriteFrameInfo.imageUuid);
                // 移除 image 碎图后，需要删除原有纹理压缩任务
                imageCompressManager && imageCompressManager.removeTask(spriteFrameInfo.imageUuid);
            }
            else if (dependedAssets[spriteFrameInfo.imageUuid] && !inBundle) {
                // 自动图集内的 image 资源被使用后不剔除，但需要警告
                // https://github.com/cocos-creator/3d-tasks/issues/4014
                console.warn(i18n_1.default.t('builder.tips.use_image_in_atlas', {
                    info: `{asset(${spriteFrameInfo.imageUuid})}`,
                    useInfo: `{asset(${dependedAssets[spriteFrameInfo.imageUuid].toString()})}`,
                }));
            }
            spriteFrameUuids.push(spriteFrameInfo.uuid);
            taskResult.assetsToImage[spriteFrameInfo.uuid] = imageUuid;
            taskResult.assetsToImage[spriteFrameInfo.imageUuid] = imageUuid;
        }
        // 大图按照优先级进行存放，如果已经有了一个 bundle 包含此大图且那个 bundle 的优先级高于此 bundle, 那存储一个 redirect 即可
        // 参考 https://github.com/cocos-creator/3d-tasks/issues/6352
        if (!firstBundleContainAtlasImage || firstBundleContainAtlasImage.priority === bundle.priority) {
            bundle.addAssetWithUuid(imageUuid);
            bundle.addAssetWithUuid(textureUuid);
            if (bundle.compressionType === bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON) {
                if (!bundle.groups[0]) {
                    bundle.addGroup('NORMAL', [imageUuid, textureUuid]);
                }
                else {
                    bundle.groups[0].uuids.push(imageUuid, textureUuid);
                }
            }
            else if (bundle.compressionType !== bundle_utils_1.BundleCompressionTypes.NONE) {
                bundle.addToGroup('IMAGE', imageUuid);
                bundle.addToGroup('TEXTURE', textureUuid);
            }
            const pacAssetInfo = asset_library_1.buildAssetLibrary.getAsset(pacInfo.uuid);
            let taskInfo = null;
            if (pacAssetInfo.meta.userData.compressSettings && imageCompressManager) {
                // 添加大图压缩任务
                taskInfo = imageCompressManager.genTaskInfoFromAssetInfo(pacAssetInfo);
                if (taskInfo) {
                    // 此处需要取合图实际文件的 mtime ，单纯合图资源的 mtime 信息不能包含小图的修改情况
                    taskInfo.mtime = (0, fs_extra_1.statSync)(atlas.imagePath).mtime.getTime();
                    bundle.compressTask[atlas.imageUuid] = imageCompressManager.addTask(atlas.imageUuid, {
                        ...taskInfo,
                        src: atlas.imagePath,
                    });
                }
            }
            // 如果没有压缩纹理任务，默认使用原图
            if (!taskInfo) {
                const dest = (0, path_1.join)(bundle.dest, bundle.nativeBase, imageUuid.slice(0, 2), imageUuid + (0, path_1.extname)(atlas.imagePath));
                (0, fs_extra_1.copySync)(atlas.imagePath, dest);
            }
            if (!firstBundleContainAtlasImage) {
                firstBundleContainAtlasImage = bundle;
            }
            else {
                bundlesWithSamePriority.push(bundle.root);
            }
        }
        else {
            bundle.addRedirect(textureUuid, firstBundleContainAtlasImage.name);
        }
        const groupUuids = [...spriteFrameUuids];
        if (assetsMap.has(pacInfo.uuid)) {
            if (!dependedAssets[pacInfo.uuid] && (!inBundle || removeSpriteAtlasInBundle)) {
                bundle.removeAsset(pacInfo.uuid);
                console.debug(`remove spriteAtlas._uuid : {asset(${pacInfo.uuid})}`);
            }
            else if (dependedAssets[pacInfo.uuid] || inBundle) {
                groupUuids.push(pacInfo.uuid);
            }
        }
        if (bundle.compressionType === bundle_utils_1.BundleCompressionTypes.MERGE_ALL_JSON) {
            if (!bundle.groups[0]) {
                bundle.addGroup('NORMAL', groupUuids);
            }
            else {
                bundle.groups[0].uuids.push(...groupUuids);
            }
        }
        else if (bundle.compressionType !== bundle_utils_1.BundleCompressionTypes.NONE) {
            bundle.addGroup('NORMAL', groupUuids);
        }
        // // 收集信息
        taskResult.imageToAtlas[imageUuid] = pacInfo.uuid;
        taskResult.assetsToImage[textureUuid] = imageUuid;
        if (!taskResult.atlasToImages[pacInfo.uuid]) {
            taskResult.atlasToImages[pacInfo.uuid] = [];
        }
        taskResult.atlasToImages[pacInfo.uuid].push(imageUuid);
    }
    if (firstBundleContainAtlasImage && bundlesWithSamePriority.length) {
        console.warn(i18n_1.default.t('builder.warn.repeat_atlas_in_bundle', {
            Atlas: pacInfo.path,
            bundle1: firstBundleContainAtlasImage.root,
            bundle2: bundlesWithSamePriority.toString(),
        }));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvYnVpbGRlci93b3JrZXIvYnVpbGRlci9hc3NldC1oYW5kbGVyL2J1bmRsZS9wYWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFRQSwwQ0FxSkM7QUE3SkQsdUNBQThDO0FBQzlDLCtCQUFxQztBQUNyQyxpRUFBd0U7QUFDeEUsK0RBQWdFO0FBRWhFLG9FQUE0QztBQUc1QyxTQUFnQixlQUFlLENBQUMsT0FBa0IsRUFBRSxLQUFpQixFQUFFLE9BQWlCLEVBQUUsY0FBd0MsRUFBRSxvQkFBc0M7SUFDdEssTUFBTSxFQUFFLHFCQUFxQixFQUFFLG1CQUFtQixFQUFFLHlCQUF5QixFQUFFLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQztJQUN0RyxJQUFJLDRCQUE0QixHQUFtQixJQUFJLENBQUM7SUFDeEQsTUFBTSx1QkFBdUIsR0FBYSxFQUFFLENBQUM7SUFFN0MseUJBQXlCO0lBQ3pCLE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUM7SUFDbEMsTUFBTSxXQUFXLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQztJQUN0QyxLQUFLLE1BQU0sTUFBTSxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDakIsU0FBUztRQUNiLENBQUM7UUFDRCxNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDO1FBQ25DLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQztRQUM1QyxNQUFNLFNBQVMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNsQyxJQUNJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO1lBQzVCLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFD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QUFhLENBQUMsV0FBVyxDQUFDLEdBQUcsU0FBUyxDQUFDO1FBQ2xELElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQzFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUNoRCxDQUFDO1FBQ0QsVUFBVSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFFRCxJQUFJLDRCQUE0QixJQUFJLHVCQUF1QixDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2pFLE9BQU8sQ0FBQyxJQUFJLENBQUMsY0FBSSxDQUFDLENBQUMsQ0FBQyxxQ0FBcUMsRUFBRTtZQUN2RCxLQUFLLEVBQUUsT0FBTyxDQUFDLElBQUk7WUFDbkIsT0FBTyxFQUFFLDRCQUE0QixDQUFDLElBQUk7WUFDMUMsT0FBTyxFQUFFLHVCQUF1QixDQUFDLFFBQVEsRUFBRTtTQUM5QyxDQUFDLENBQUMsQ0FBQztJQUNSLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY29weVN5bmMsIHN0YXRTeW5jIH0gZnJvbSAnZnMtZXh0cmEnO1xyXG5pbXBvcnQgeyBleHRuYW1lLCBqb2luIH0gZnJvbSAncGF0aCc7XHJcbmltcG9ydCB7IEJ1bmRsZUNvbXByZXNzaW9uVHlwZXMgfSBmcm9tICcuLi8uLi8uLi8uLi9zaGFyZS9idW5kbGUtdXRpbHMnO1xyXG5pbXBvcnQgeyBidWlsZEFzc2V0TGlicmFyeSB9IGZyb20gJy4uLy4uL21hbmFnZXIvYXNzZXQtbGlicmFyeSc7XHJcbmltcG9ydCB7IFRleHR1cmVDb21wcmVzcyB9IGZyb20gJy4uL3RleHR1cmUtY29tcHJlc3MnO1xyXG5pbXBvcnQgaTE4biBmcm9tICcuLi8uLi8uLi8uLi8uLi9iYXNlL2kxOG4nO1xyXG5pbXBvcnQgeyBJQnVuZGxlLCBJQXRsYXNJbmZvLCBJUGFjSW5mbywgSUltYWdlVGFza0luZm8gfSBmcm9tICcuLi8uLi8uLi8uLi9AdHlwZXMvcHJvdGVjdGVkJztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzb3J0QnVuZGxlSW5QYWMoYnVuZGxlczogSUJ1bmRsZVtdLCBhdGxhczogSUF0bGFzSW5mbywgcGFjSW5mbzogSVBhY0luZm8sIGRlcGVuZGVkQXNzZXRzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmdbXT4sIGltYWdlQ29tcHJlc3NNYW5hZ2VyPzogVGV4dHVyZUNvbXByZXNzKSB7XHJcbiAgICBjb25zdCB7IHJlbW92ZVRleHR1cmVJbkJ1bmRsZSwgcmVtb3ZlSW1hZ2VJbkJ1bmRsZSwgcmVtb3ZlU3ByaXRlQXRsYXNJbkJ1bmRsZSB9ID0gcGFjSW5mby5wYWNrT3B0aW9ucztcclxuICAgIGxldCBmaXJzdEJ1bmRsZUNvbnRhaW5BdGxhc0ltYWdlOiBJQnVuZGxlIHwgbnVsbCA9IG51bGw7XHJcbiAgICBjb25zdCBidW5kbGVzV2l0aFNhbWVQcmlvcml0eTogc3RyaW5nW10gPSBbXTtcclxuXHJcbiAgICAvLyDkuIDkuKogQXV0b0F0bGFzIOWPr+iDveS8mueUn+aIkOWkmuW8oOWkp+WbvlxyXG4gICAgY29uc3QgaW1hZ2VVdWlkID0gYXRsYXMuaW1hZ2VVdWlkO1xyXG4gICAgY29uc3QgdGV4dHVyZVV1aWQgPSBhdGxhcy50ZXh0dXJlVXVpZDtcclxuICAgIGZvciAoY29uc3QgYnVuZGxlIG9mIGJ1bmRsZXMpIHtcclxuICAgICAgICBpZiAoIWJ1bmRsZS5vdXRwdXQpIHtcclxuICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHRhc2tSZXN1bHQgPSBidW5kbGUuYXRsYXNSZXM7XHJcbiAgICAgICAgY29uc3QgYXNzZXRzID0gYnVuZGxlLmFzc2V0c1dpdGhvdXRSZWRpcmVjdDtcclxuICAgICAgICBjb25zdCBhc3NldHNNYXAgPSBuZXcgU2V0KGFzc2V0cyk7XHJcbiAgICAgICAgaWYgKFxyXG4gICAgICAgICAgICAhYXNzZXRzTWFwLmhhcyhwYWNJbmZvLnV1aWQpICYmXHJcbiAgICAgICAgICAgICFwYWNJbmZvLnNwcml0ZUZyYW1lcy5maW5kKCh4KSA9PiBhc3NldHNNYXAuaGFzKHguX3V1aWQpKVxyXG4gICAgICAgICkge1xyXG4gICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3Qgc3ByaXRlRnJhbWVVdWlkcyA9IFtdO1xyXG4gICAgICAgIGNvbnN0IGluQnVuZGxlID0gcGFjSW5mby5wYXRoLnN0YXJ0c1dpdGgoYnVuZGxlLnJvb3QgKyAnLycpO1xyXG4gICAgICAgIGlmIChpbkJ1bmRsZSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKGBBc3NldCB7YXNzZXQoJHtwYWNJbmZvLnBhdGh9KX0gaXMgQnVuZGxlYCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAoY29uc3Qgc3ByaXRlRnJhbWVJbmZvIG9mIGF0bGFzLnNwcml0ZUZyYW1lSW5mb3MpIHtcclxuICAgICAgICAgICAgaWYgKGJ1bmRsZS5nZXRSZWRpcmVjdChzcHJpdGVGcmFtZUluZm8udXVpZCkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBidW5kbGUuYWRkQXNzZXRXaXRoVXVpZChzcHJpdGVGcmFtZUluZm8udXVpZCk7XHJcbiAgICAgICAgICAgIC8vIOWwhuWwj+WbvuS/oeaBr+S7juWOn+acieWIhue7hOS4reWIoOmZpFxyXG4gICAgICAgICAgICBidW5kbGUucmVtb3ZlRnJvbUdyb3VwcyhzcHJpdGVGcmFtZUluZm8udXVpZCk7XHJcbiAgICAgICAgICAgIGlmICghZGVwZW5kZWRBc3NldHNbc3ByaXRlRnJhbWVJbmZvLnRleHR1cmVVdWlkXSAmJiAocmVtb3ZlVGV4dHVyZUluQnVuZGxlIHx8ICFpbkJ1bmRsZSkpIHtcclxuICAgICAgICAgICAgICAgIGJ1bmRsZS5yZW1vdmVBc3NldChzcHJpdGVGcmFtZUluZm8udGV4dHVyZVV1aWQpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGRlcGVuZGVkQXNzZXRzW3Nwcml0ZUZyYW1lSW5mby50ZXh0dXJlVXVpZF0gJiYgIWluQnVuZGxlKSB7XHJcbiAgICAgICAgICAgICAgICAvLyDoh6rliqjlm77pm4blhoXnmoQgdGV4dHVyZSDotYTmupDooqvkvb/nlKjlkI7kuI3liZTpmaTvvIzkvYbpnIDopoHorablkYpcclxuICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9jb2Nvcy1jcmVhdG9yLzNkLXRhc2tzL2lzc3Vlcy80MDE0XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oXHJcbiAgICAgICAgICAgICAgICAgICAgaTE4bi50KCdidWlsZGVyLnRpcHMudXNlX3RleHR1cmVfaW5fYXRsYXMnLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluZm86IGB7YXNzZXQoJHtzcHJpdGVGcmFtZUluZm8udGV4dHVyZVV1aWR9KX1gLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VJbmZvOiBge2Fzc2V0KCR7ZGVwZW5kZWRBc3NldHNbc3ByaXRlRnJhbWVJbmZvLnRleHR1cmVVdWlkXS50b1N0cmluZygpfSl9YCxcclxuICAgICAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gIWRlcGVuZGVkQXNzZXRzW3Nwcml0ZUZyYW1lSW5mby50ZXh0dXJlVXVpZF06IOeUseS6jiB0ZXh0dXJlIOS4jiBpbWFnZSDkuYvpl7TnmoTkvp3otZblhbPns7vvvIzlvZMgdGV4dHVyZSDooqvlvJXnlKjml7bvvIxpbWFnZSDkuZ/kuI3og73liZTpmaRcclxuICAgICAgICAgICAgaWYgKCFkZXBlbmRlZEFzc2V0c1tzcHJpdGVGcmFtZUluZm8uaW1hZ2VVdWlkXSAmJiAocmVtb3ZlSW1hZ2VJbkJ1bmRsZSB8fCAhaW5CdW5kbGUpICYmICFkZXBlbmRlZEFzc2V0c1tzcHJpdGVGcmFtZUluZm8udGV4dHVyZVV1aWRdKSB7XHJcbiAgICAgICAgICAgICAgICBidW5kbGUucmVtb3ZlQXNzZXQoc3ByaXRlRnJhbWVJbmZvLmltYWdlVXVpZCk7XHJcbiAgICAgICAgICAgICAgICAvLyDnp7vpmaQgaW1hZ2Ug56KO5Zu+5ZCO77yM6ZyA6KaB5Yig6Zmk5Y6f5pyJ57q555CG5Y6L57yp5Lu75YqhXHJcbiAgICAgICAgICAgICAgICBpbWFnZUNvbXByZXNzTWFuYWdlciAmJiBpbWFnZUNvbXByZXNzTWFuYWdlci5yZW1vdmVUYXNrKHNwcml0ZUZyYW1lSW5mby5pbWFnZVV1aWQpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGRlcGVuZGVkQXNzZXRzW3Nwcml0ZUZyYW1lSW5mby5pbWFnZVV1aWRdICYmICFpbkJ1bmRsZSkge1xyXG4gICAgICAgICAgICAgICAgLy8g6Ieq5Yqo5Zu+6ZuG5YaF55qEIGltYWdlIOi1hOa6kOiiq+S9v+eUqOWQjuS4jeWJlOmZpO+8jOS9humcgOimgeitpuWRilxyXG4gICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NvY29zLWNyZWF0b3IvM2QtdGFza3MvaXNzdWVzLzQwMTRcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihcclxuICAgICAgICAgICAgICAgICAgICBpMThuLnQoJ2J1aWxkZXIudGlwcy51c2VfaW1hZ2VfaW5fYXRsYXMnLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluZm86IGB7YXNzZXQoJHtzcHJpdGVGcmFtZUluZm8uaW1hZ2VVdWlkfSl9YCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlSW5mbzogYHthc3NldCgke2RlcGVuZGVkQXNzZXRzW3Nwcml0ZUZyYW1lSW5mby5pbWFnZVV1aWRdLnRvU3RyaW5nKCl9KX1gLFxyXG4gICAgICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgc3ByaXRlRnJhbWVVdWlkcy5wdXNoKHNwcml0ZUZyYW1lSW5mby51dWlkKTtcclxuICAgICAgICAgICAgdGFza1Jlc3VsdC5hc3NldHNUb0ltYWdlW3Nwcml0ZUZyYW1lSW5mby51dWlkXSA9IGltYWdlVXVpZDtcclxuICAgICAgICAgICAgdGFza1Jlc3VsdC5hc3NldHNUb0ltYWdlW3Nwcml0ZUZyYW1lSW5mby5pbWFnZVV1aWRdID0gaW1hZ2VVdWlkO1xyXG5cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5aSn5Zu+5oyJ54Wn5LyY5YWI57qn6L+b6KGM5a2Y5pS+77yM5aaC5p6c5bey57uP5pyJ5LqG5LiA5LiqIGJ1bmRsZSDljIXlkKvmraTlpKflm77kuJTpgqPkuKogYnVuZGxlIOeahOS8mOWFiOe6p+mrmOS6juatpCBidW5kbGUsIOmCo+WtmOWCqOS4gOS4qiByZWRpcmVjdCDljbPlj69cclxuICAgICAgICAvLyDlj4LogIMgaHR0cHM6Ly9naXRodWIuY29tL2NvY29zLWNyZWF0b3IvM2QtdGFza3MvaXNzdWVzLzYzNTJcclxuICAgICAgICBpZiAoIWZpcnN0QnVuZGxlQ29udGFpbkF0bGFzSW1hZ2UgfHwgZmlyc3RCdW5kbGVDb250YWluQXRsYXNJbWFnZS5wcmlvcml0eSA9PT0gYnVuZGxlLnByaW9yaXR5KSB7XHJcbiAgICAgICAgICAgIGJ1bmRsZS5hZGRBc3NldFdpdGhVdWlkKGltYWdlVXVpZCk7XHJcbiAgICAgICAgICAgIGJ1bmRsZS5hZGRBc3NldFdpdGhVdWlkKHRleHR1cmVVdWlkKTtcclxuICAgICAgICAgICAgaWYgKGJ1bmRsZS5jb21wcmVzc2lvblR5cGUgPT09IEJ1bmRsZUNvbXByZXNzaW9uVHlwZXMuTUVSR0VfQUxMX0pTT04pIHtcclxuICAgICAgICAgICAgICAgIGlmICghYnVuZGxlLmdyb3Vwc1swXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGJ1bmRsZS5hZGRHcm91cCgnTk9STUFMJywgW2ltYWdlVXVpZCwgdGV4dHVyZVV1aWRdKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYnVuZGxlLmdyb3Vwc1swXS51dWlkcy5wdXNoKGltYWdlVXVpZCwgdGV4dHVyZVV1aWQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGJ1bmRsZS5jb21wcmVzc2lvblR5cGUgIT09IEJ1bmRsZUNvbXByZXNzaW9uVHlwZXMuTk9ORSkge1xyXG4gICAgICAgICAgICAgICAgYnVuZGxlLmFkZFRvR3JvdXAoJ0lNQUdFJywgaW1hZ2VVdWlkKTtcclxuICAgICAgICAgICAgICAgIGJ1bmRsZS5hZGRUb0dyb3VwKCdURVhUVVJFJywgdGV4dHVyZVV1aWQpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBwYWNBc3NldEluZm8gPSBidWlsZEFzc2V0TGlicmFyeS5nZXRBc3NldChwYWNJbmZvLnV1aWQpO1xyXG5cclxuICAgICAgICAgICAgbGV0IHRhc2tJbmZvOiBJSW1hZ2VUYXNrSW5mbyB8IG51bGwgfCB1bmRlZmluZWQgPSBudWxsO1xyXG4gICAgICAgICAgICBpZiAocGFjQXNzZXRJbmZvLm1ldGEudXNlckRhdGEuY29tcHJlc3NTZXR0aW5ncyAmJiBpbWFnZUNvbXByZXNzTWFuYWdlcikge1xyXG4gICAgICAgICAgICAgICAgLy8g5re75Yqg5aSn5Zu+5Y6L57yp5Lu75YqhXHJcbiAgICAgICAgICAgICAgICB0YXNrSW5mbyA9IGltYWdlQ29tcHJlc3NNYW5hZ2VyLmdlblRhc2tJbmZvRnJvbUFzc2V0SW5mbyhwYWNBc3NldEluZm8pO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRhc2tJbmZvKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5q2k5aSE6ZyA6KaB5Y+W5ZCI5Zu+5a6e6ZmF5paH5Lu255qEIG10aW1lIO+8jOWNlee6r+WQiOWbvui1hOa6kOeahCBtdGltZSDkv6Hmga/kuI3og73ljIXlkKvlsI/lm77nmoTkv67mlLnmg4XlhrVcclxuICAgICAgICAgICAgICAgICAgICB0YXNrSW5mby5tdGltZSA9IHN0YXRTeW5jKGF0bGFzLmltYWdlUGF0aCkubXRpbWUuZ2V0VGltZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJ1bmRsZS5jb21wcmVzc1Rhc2tbYXRsYXMuaW1hZ2VVdWlkXSA9IGltYWdlQ29tcHJlc3NNYW5hZ2VyLmFkZFRhc2soYXRsYXMuaW1hZ2VVdWlkLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLnRhc2tJbmZvLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzcmM6IGF0bGFzLmltYWdlUGF0aCxcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8g5aaC5p6c5rKh5pyJ5Y6L57yp57q555CG5Lu75Yqh77yM6buY6K6k5L2/55So5Y6f5Zu+XHJcbiAgICAgICAgICAgIGlmICghdGFza0luZm8pIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRlc3QgPSBqb2luKGJ1bmRsZS5kZXN0LCBidW5kbGUubmF0aXZlQmFzZSwgaW1hZ2VVdWlkLnNsaWNlKDAsIDIpLCBpbWFnZVV1aWQgKyBleHRuYW1lKGF0bGFzLmltYWdlUGF0aCkpO1xyXG4gICAgICAgICAgICAgICAgY29weVN5bmMoYXRsYXMuaW1hZ2VQYXRoLCBkZXN0KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKCFmaXJzdEJ1bmRsZUNvbnRhaW5BdGxhc0ltYWdlKSB7XHJcbiAgICAgICAgICAgICAgICBmaXJzdEJ1bmRsZUNvbnRhaW5BdGxhc0ltYWdlID0gYnVuZGxlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgYnVuZGxlc1dpdGhTYW1lUHJpb3JpdHkucHVzaChidW5kbGUucm9vdCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgYnVuZGxlLmFkZFJlZGlyZWN0KHRleHR1cmVVdWlkLCBmaXJzdEJ1bmRsZUNvbnRhaW5BdGxhc0ltYWdlLm5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBncm91cFV1aWRzID0gWy4uLnNwcml0ZUZyYW1lVXVpZHNdO1xyXG4gICAgICAgIGlmIChhc3NldHNNYXAuaGFzKHBhY0luZm8udXVpZCkpIHtcclxuICAgICAgICAgICAgaWYgKCFkZXBlbmRlZEFzc2V0c1twYWNJbmZvLnV1aWRdICYmICghaW5CdW5kbGUgfHwgcmVtb3ZlU3ByaXRlQXRsYXNJbkJ1bmRsZSkpIHtcclxuICAgICAgICAgICAgICAgIGJ1bmRsZS5yZW1vdmVBc3NldChwYWNJbmZvLnV1aWQpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhgcmVtb3ZlIHNwcml0ZUF0bGFzLl91dWlkIDoge2Fzc2V0KCR7cGFjSW5mby51dWlkfSl9YCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZGVwZW5kZWRBc3NldHNbcGFjSW5mby51dWlkXSB8fCBpbkJ1bmRsZSkge1xyXG4gICAgICAgICAgICAgICAgZ3JvdXBVdWlkcy5wdXNoKHBhY0luZm8udXVpZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGJ1bmRsZS5jb21wcmVzc2lvblR5cGUgPT09IEJ1bmRsZUNvbXByZXNzaW9uVHlwZXMuTUVSR0VfQUxMX0pTT04pIHtcclxuICAgICAgICAgICAgaWYgKCFidW5kbGUuZ3JvdXBzWzBdKSB7XHJcbiAgICAgICAgICAgICAgICBidW5kbGUuYWRkR3JvdXAoJ05PUk1BTCcsIGdyb3VwVXVpZHMpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgYnVuZGxlLmdyb3Vwc1swXS51dWlkcy5wdXNoKC4uLmdyb3VwVXVpZHMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIGlmIChidW5kbGUuY29tcHJlc3Npb25UeXBlICE9PSBCdW5kbGVDb21wcmVzc2lvblR5cGVzLk5PTkUpIHtcclxuICAgICAgICAgICAgYnVuZGxlLmFkZEdyb3VwKCdOT1JNQUwnLCBncm91cFV1aWRzKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIC8vIOaUtumbhuS/oeaBr1xyXG4gICAgICAgIHRhc2tSZXN1bHQuaW1hZ2VUb0F0bGFzW2ltYWdlVXVpZF0gPSBwYWNJbmZvLnV1aWQ7XHJcbiAgICAgICAgdGFza1Jlc3VsdC5hc3NldHNUb0ltYWdlW3RleHR1cmVVdWlkXSA9IGltYWdlVXVpZDtcclxuICAgICAgICBpZiAoIXRhc2tSZXN1bHQuYXRsYXNUb0ltYWdlc1twYWNJbmZvLnV1aWRdKSB7XHJcbiAgICAgICAgICAgIHRhc2tSZXN1bHQuYXRsYXNUb0ltYWdlc1twYWNJbmZvLnV1aWRdID0gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRhc2tSZXN1bHQuYXRsYXNUb0ltYWdlc1twYWNJbmZvLnV1aWRdLnB1c2goaW1hZ2VVdWlkKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZmlyc3RCdW5kbGVDb250YWluQXRsYXNJbWFnZSAmJiBidW5kbGVzV2l0aFNhbWVQcmlvcml0eS5sZW5ndGgpIHtcclxuICAgICAgICBjb25zb2xlLndhcm4oaTE4bi50KCdidWlsZGVyLndhcm4ucmVwZWF0X2F0bGFzX2luX2J1bmRsZScsIHtcclxuICAgICAgICAgICAgQXRsYXM6IHBhY0luZm8ucGF0aCxcclxuICAgICAgICAgICAgYnVuZGxlMTogZmlyc3RCdW5kbGVDb250YWluQXRsYXNJbWFnZS5yb290LFxyXG4gICAgICAgICAgICBidW5kbGUyOiBidW5kbGVzV2l0aFNhbWVQcmlvcml0eS50b1N0cmluZygpLFxyXG4gICAgICAgIH0pKTtcclxuICAgIH1cclxufSJdfQ==