"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildSeparateEngine = void 0;
exports.buildEngineCommand = buildEngineCommand;
/**
 * 执行环境为标准 node 环境，请不要使用 Editor 或者 Electron 接口
 */
const ccbuild_1 = require("@cocos/ccbuild");
const path_1 = require("path");
const fs_extra_1 = require("fs-extra");
const defaultOptions = {
    engine: '', // 内置引擎模块地址
    out: '',
    platform: 'INVALID_PLATFORM', // v3.8.6 开始 ccbuild 支持 'INVALID_PLATFORM' 表示无效平台，防止之前初始化为 'HTML5' 后，平台插件忘记覆盖 platform 参数导致走 'HTML5' 的引擎打包流程导致的较难排查的问题
    moduleFormat: 'system',
    compress: true,
    split: false,
    nativeCodeBundleMode: 'both',
    assetURLFormat: 'runtime-resolved',
    noDeprecatedFeatures: false,
    sourceMap: false,
    // 需要从引擎地址整理默认模块地址
    features: [],
    loose: false,
    mode: 'BUILD',
    flags: {
        DEBUG: false,
    },
    metaFile: '',
    mangleProperties: false, // 3.8.5 先默认关闭此功能
    inlineEnum: true,
};
/**
 * 编译引擎代码，执行环境为标准 node 环境，请不要使用 Editor 或者 Electron 接口，所以需要使用的字段都需要在外部整理好传入
 * @param options 编译引擎参数
 */
async function buildEngineCommand(options) {
    const buildOptions = Object.assign({}, defaultOptions, options || {});
    // TODO features 的校验与默认值
    const { features, out } = buildOptions;
    await (0, fs_extra_1.remove)(out);
    await (0, fs_extra_1.ensureDir)((0, path_1.dirname)(out));
    console.debug(`start build engine with options: ${JSON.stringify(buildOptions)}`);
    const buildResult = await (0, ccbuild_1.buildEngine)(buildOptions);
    if (buildOptions.split) {
        const statsQuery = await ccbuild_1.StatsQuery.create(buildOptions.engine);
        const ccModuleSource = await ccbuild_1.buildEngine.transform(statsQuery.evaluateIndexModuleSource(statsQuery.getUnitsOfFeatures(features)), 'system');
        const ccModuleFile = (0, path_1.join)(options.out, 'cc.js');
        await (0, fs_extra_1.ensureDir)((0, path_1.dirname)(ccModuleFile));
        await (0, fs_extra_1.writeFile)(ccModuleFile, ccModuleSource.code, 'utf8');
        buildResult.exports['cc'] = 'cc.js';
    }
    const metaContent = buildResult;
    if (options.mangleConfigJsonMtime !== 0) {
        metaContent['mangleConfigJsonMtime'] = options.mangleConfigJsonMtime;
    }
    // 写入一些编译引擎的元信息
    await (0, fs_extra_1.ensureDir)((0, path_1.dirname)(buildOptions.metaFile));
    // 缓存一下引擎提供的模块映射
    await (0, fs_extra_1.writeJSON)(buildOptions.metaFile, metaContent, { spaces: 2 });
}
var separate_engine_1 = require("./separate-engine");
Object.defineProperty(exports, "buildSeparateEngine", { enumerable: true, get: function () { return separate_engine_1.buildSeparateEngine; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGQtZW5naW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2NvcmUvYnVpbGRlci93b3JrZXIvYnVpbGRlci9hc3NldC1oYW5kbGVyL3NjcmlwdC9idWlsZC1lbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBd0NBLGdEQThCQztBQXRFRDs7R0FFRztBQUNILDRDQUF5RDtBQUN6RCwrQkFBcUM7QUFDckMsdUNBQW1FO0FBRW5FLE1BQU0sY0FBYyxHQUF1QjtJQUN2QyxNQUFNLEVBQUUsRUFBRSxFQUFFLFdBQVc7SUFDdkIsR0FBRyxFQUFFLEVBQUU7SUFDUCxRQUFRLEVBQUUsa0JBQWtCLEVBQUUsc0hBQXNIO0lBQ3BKLFlBQVksRUFBRSxRQUFRO0lBQ3RCLFFBQVEsRUFBRSxJQUFJO0lBQ2QsS0FBSyxFQUFFLEtBQUs7SUFDWixvQkFBb0IsRUFBRSxNQUFNO0lBQzVCLGNBQWMsRUFBRSxrQkFBa0I7SUFDbEMsb0JBQW9CLEVBQUUsS0FBSztJQUMzQixTQUFTLEVBQUUsS0FBSztJQUNoQixrQkFBa0I7SUFDbEIsUUFBUSxFQUFFLEVBQUU7SUFDWixLQUFLLEVBQUUsS0FBSztJQUNaLElBQUksRUFBRSxPQUFPO0lBQ2IsS0FBSyxFQUFFO1FBQ0gsS0FBSyxFQUFFLEtBQUs7S0FDZjtJQUVELFFBQVEsRUFBRSxFQUFFO0lBQ1osZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLGlCQUFpQjtJQUMxQyxVQUFVLEVBQUUsSUFBSTtDQUNuQixDQUFDO0FBT0Y7OztHQUdHO0FBQ0ksS0FBSyxVQUFVLGtCQUFrQixDQUFDLE9BQTJCO0lBQ2hFLE1BQU0sWUFBWSxHQUF1QixNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxjQUFjLEVBQUUsT0FBTyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQzFGLHdCQUF3QjtJQUN4QixNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxHQUFHLFlBQVksQ0FBQztJQUN2QyxNQUFNLElBQUEsaUJBQU0sRUFBQyxHQUFHLENBQUMsQ0FBQztJQUNsQixNQUFNLElBQUEsb0JBQVMsRUFBQyxJQUFBLGNBQU8sRUFBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQzlCLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0NBQW9DLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2xGLE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBQSxxQkFBVyxFQUFDLFlBQVksQ0FBQyxDQUFDO0lBRXBELElBQUksWUFBWSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3JCLE1BQU0sVUFBVSxHQUFHLE1BQU0sb0JBQVUsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2hFLE1BQU0sY0FBYyxHQUFHLE1BQU0scUJBQVcsQ0FBQyxTQUFTLENBQzlDLFVBQVUsQ0FBQyx5QkFBeUIsQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsUUFBUyxDQUFDLENBQUMsRUFDOUUsUUFBUSxDQUNYLENBQUM7UUFDRixNQUFNLFlBQVksR0FBRyxJQUFBLFdBQUksRUFBQyxPQUFPLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ2hELE1BQU0sSUFBQSxvQkFBUyxFQUFDLElBQUEsY0FBTyxFQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7UUFDdkMsTUFBTSxJQUFBLG9CQUFTLEVBQUMsWUFBWSxFQUFFLGNBQWMsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDM0QsV0FBVyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUM7SUFDeEMsQ0FBQztJQUVELE1BQU0sV0FBVyxHQUE0RCxXQUFXLENBQUM7SUFDekYsSUFBSSxPQUFPLENBQUMscUJBQXFCLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDdEMsV0FBVyxDQUFDLHVCQUF1QixDQUFDLEdBQUcsT0FBTyxDQUFDLHFCQUFxQixDQUFDO0lBQ3pFLENBQUM7SUFFRCxlQUFlO0lBQ2YsTUFBTSxJQUFBLG9CQUFTLEVBQUMsSUFBQSxjQUFPLEVBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7SUFDaEQsZ0JBQWdCO0lBQ2hCLE1BQU0sSUFBQSxvQkFBUyxFQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsV0FBVyxFQUFFLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDdkUsQ0FBQztBQUVELHFEQUF3RDtBQUEvQyxzSEFBQSxtQkFBbUIsT0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiDmiafooYznjq/looPkuLrmoIflh4Ygbm9kZSDnjq/looPvvIzor7fkuI3opoHkvb/nlKggRWRpdG9yIOaIluiAhSBFbGVjdHJvbiDmjqXlj6NcclxuICovXHJcbmltcG9ydCB7IGJ1aWxkRW5naW5lLCBTdGF0c1F1ZXJ5IH0gZnJvbSAnQGNvY29zL2NjYnVpbGQnO1xyXG5pbXBvcnQgeyBkaXJuYW1lLCBqb2luIH0gZnJvbSAncGF0aCc7XHJcbmltcG9ydCB7IGVuc3VyZURpciwgcmVtb3ZlLCB3cml0ZUZpbGUsIHdyaXRlSlNPTiB9IGZyb20gJ2ZzLWV4dHJhJztcclxuXHJcbmNvbnN0IGRlZmF1bHRPcHRpb25zOiBidWlsZEVuZ2luZU9wdGlvbnMgPSB7XHJcbiAgICBlbmdpbmU6ICcnLCAvLyDlhoXnva7lvJXmk47mqKHlnZflnLDlnYBcclxuICAgIG91dDogJycsXHJcbiAgICBwbGF0Zm9ybTogJ0lOVkFMSURfUExBVEZPUk0nLCAvLyB2My44LjYg5byA5aeLIGNjYnVpbGQg5pSv5oyBICdJTlZBTElEX1BMQVRGT1JNJyDooajnpLrml6DmlYjlubPlj7DvvIzpmLLmraLkuYvliY3liJ3lp4vljJbkuLogJ0hUTUw1JyDlkI7vvIzlubPlj7Dmj5Lku7blv5jorrDopobnm5YgcGxhdGZvcm0g5Y+C5pWw5a+86Ie06LWwICdIVE1MNScg55qE5byV5pOO5omT5YyF5rWB56iL5a+86Ie055qE6L6D6Zq+5o6S5p+l55qE6Zeu6aKYXHJcbiAgICBtb2R1bGVGb3JtYXQ6ICdzeXN0ZW0nLFxyXG4gICAgY29tcHJlc3M6IHRydWUsXHJcbiAgICBzcGxpdDogZmFsc2UsXHJcbiAgICBuYXRpdmVDb2RlQnVuZGxlTW9kZTogJ2JvdGgnLFxyXG4gICAgYXNzZXRVUkxGb3JtYXQ6ICdydW50aW1lLXJlc29sdmVkJyxcclxuICAgIG5vRGVwcmVjYXRlZEZlYXR1cmVzOiBmYWxzZSxcclxuICAgIHNvdXJjZU1hcDogZmFsc2UsXHJcbiAgICAvLyDpnIDopoHku47lvJXmk47lnLDlnYDmlbTnkIbpu5jorqTmqKHlnZflnLDlnYBcclxuICAgIGZlYXR1cmVzOiBbXSxcclxuICAgIGxvb3NlOiBmYWxzZSxcclxuICAgIG1vZGU6ICdCVUlMRCcsXHJcbiAgICBmbGFnczoge1xyXG4gICAgICAgIERFQlVHOiBmYWxzZSxcclxuICAgIH0sXHJcblxyXG4gICAgbWV0YUZpbGU6ICcnLFxyXG4gICAgbWFuZ2xlUHJvcGVydGllczogZmFsc2UsIC8vIDMuOC41IOWFiOm7mOiupOWFs+mXreatpOWKn+iDvVxyXG4gICAgaW5saW5lRW51bTogdHJ1ZSxcclxufTtcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgYnVpbGRFbmdpbmVPcHRpb25zIGV4dGVuZHMgYnVpbGRFbmdpbmUuT3B0aW9ucyB7XHJcbiAgICBtZXRhRmlsZTogc3RyaW5nO1xyXG4gICAgbWFuZ2xlQ29uZmlnSnNvbk10aW1lPzogbnVtYmVyO1xyXG59XHJcblxyXG4vKipcclxuICog57yW6K+R5byV5pOO5Luj56CB77yM5omn6KGM546v5aKD5Li65qCH5YeGIG5vZGUg546v5aKD77yM6K+35LiN6KaB5L2/55SoIEVkaXRvciDmiJbogIUgRWxlY3Ryb24g5o6l5Y+j77yM5omA5Lul6ZyA6KaB5L2/55So55qE5a2X5q616YO96ZyA6KaB5Zyo5aSW6YOo5pW055CG5aW95Lyg5YWlXHJcbiAqIEBwYXJhbSBvcHRpb25zIOe8luivkeW8leaTjuWPguaVsFxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGJ1aWxkRW5naW5lQ29tbWFuZChvcHRpb25zOiBidWlsZEVuZ2luZU9wdGlvbnMpIHtcclxuICAgIGNvbnN0IGJ1aWxkT3B0aW9uczogYnVpbGRFbmdpbmVPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMgfHwge30pO1xyXG4gICAgLy8gVE9ETyBmZWF0dXJlcyDnmoTmoKHpqozkuI7pu5jorqTlgLxcclxuICAgIGNvbnN0IHsgZmVhdHVyZXMsIG91dCB9ID0gYnVpbGRPcHRpb25zO1xyXG4gICAgYXdhaXQgcmVtb3ZlKG91dCk7XHJcbiAgICBhd2FpdCBlbnN1cmVEaXIoZGlybmFtZShvdXQpKTtcclxuICAgIGNvbnNvbGUuZGVidWcoYHN0YXJ0IGJ1aWxkIGVuZ2luZSB3aXRoIG9wdGlvbnM6ICR7SlNPTi5zdHJpbmdpZnkoYnVpbGRPcHRpb25zKX1gKTtcclxuICAgIGNvbnN0IGJ1aWxkUmVzdWx0ID0gYXdhaXQgYnVpbGRFbmdpbmUoYnVpbGRPcHRpb25zKTtcclxuXHJcbiAgICBpZiAoYnVpbGRPcHRpb25zLnNwbGl0KSB7XHJcbiAgICAgICAgY29uc3Qgc3RhdHNRdWVyeSA9IGF3YWl0IFN0YXRzUXVlcnkuY3JlYXRlKGJ1aWxkT3B0aW9ucy5lbmdpbmUpO1xyXG4gICAgICAgIGNvbnN0IGNjTW9kdWxlU291cmNlID0gYXdhaXQgYnVpbGRFbmdpbmUudHJhbnNmb3JtKFxyXG4gICAgICAgICAgICBzdGF0c1F1ZXJ5LmV2YWx1YXRlSW5kZXhNb2R1bGVTb3VyY2Uoc3RhdHNRdWVyeS5nZXRVbml0c09mRmVhdHVyZXMoZmVhdHVyZXMhKSksXHJcbiAgICAgICAgICAgICdzeXN0ZW0nLFxyXG4gICAgICAgICk7XHJcbiAgICAgICAgY29uc3QgY2NNb2R1bGVGaWxlID0gam9pbihvcHRpb25zLm91dCwgJ2NjLmpzJyk7XHJcbiAgICAgICAgYXdhaXQgZW5zdXJlRGlyKGRpcm5hbWUoY2NNb2R1bGVGaWxlKSk7XHJcbiAgICAgICAgYXdhaXQgd3JpdGVGaWxlKGNjTW9kdWxlRmlsZSwgY2NNb2R1bGVTb3VyY2UuY29kZSwgJ3V0ZjgnKTtcclxuICAgICAgICBidWlsZFJlc3VsdC5leHBvcnRzWydjYyddID0gJ2NjLmpzJztcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBtZXRhQ29udGVudDogYnVpbGRFbmdpbmUuUmVzdWx0ICYgeyBtYW5nbGVDb25maWdKc29uTXRpbWU/OiBudW1iZXIgfSA9IGJ1aWxkUmVzdWx0O1xyXG4gICAgaWYgKG9wdGlvbnMubWFuZ2xlQ29uZmlnSnNvbk10aW1lICE9PSAwKSB7XHJcbiAgICAgICAgbWV0YUNvbnRlbnRbJ21hbmdsZUNvbmZpZ0pzb25NdGltZSddID0gb3B0aW9ucy5tYW5nbGVDb25maWdKc29uTXRpbWU7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5YaZ5YWl5LiA5Lqb57yW6K+R5byV5pOO55qE5YWD5L+h5oGvXHJcbiAgICBhd2FpdCBlbnN1cmVEaXIoZGlybmFtZShidWlsZE9wdGlvbnMubWV0YUZpbGUpKTtcclxuICAgIC8vIOe8k+WtmOS4gOS4i+W8leaTjuaPkOS+m+eahOaooeWdl+aYoOWwhFxyXG4gICAgYXdhaXQgd3JpdGVKU09OKGJ1aWxkT3B0aW9ucy5tZXRhRmlsZSwgbWV0YUNvbnRlbnQsIHsgc3BhY2VzOiAyIH0pO1xyXG59XHJcblxyXG5leHBvcnQgeyBidWlsZFNlcGFyYXRlRW5naW5lIH0gZnJvbSAnLi9zZXBhcmF0ZS1lbmdpbmUnOyJdfQ==