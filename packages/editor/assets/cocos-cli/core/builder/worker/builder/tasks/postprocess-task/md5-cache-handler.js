"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.md5CacheHandler = void 0;
const fs_extra_1 = require("fs-extra");
const path_1 = require("path");
const utils_1 = require("../../utils");
const minimatch_1 = __importDefault(require("minimatch"));
const fast_glob_1 = __importDefault(require("fast-glob"));
// 暂时缩小自动替换文件路径的处理范围，目前编辑器内置的模板这些格式已足够
// 其他类型过去版本也不支持替换 md5，如果有反馈再处理即可
const textFiles = ['.js', '.ts', '.html'];
function escapeGlobChars(str) {
    return str.replace(/([*?[\]{}()!+@|^$\\])/g, '\\$1');
}
// 把任意 Windows 风格或混合路径安全化为 POSIX 风格并转义
function safePatternFromAbsolute(absPath) {
    const posix = absPath.replace(/\\/g, '/');
    // 把每个路径段单独转义，防止转义路径分隔符
    return posix
        .split('/')
        .map(segment => escapeGlobChars(segment))
        .join('/');
}
// 目前由于内部模板有许多使用字符串拼接引用路径的写法，不能限制 import 或者 require 使用相对路径的方式
class md5CacheHandler {
    // 原始文件地址 -> 已添加 hash 后缀的文件地址
    hashedPathMap = {};
    options;
    _root; // 根目录，不使用 ./ 开头的路径引用并不一定相对于引用文件目录，需要在根目录下查找
    _files = [];
    _waitingMd5Files = [];
    _waitingReplaceFiles = [];
    // 等待更新的文件内容
    waitUpdateFiles = {};
    constructor(root, options) {
        this.options = options;
        this._root = root;
    }
    async initFiles() {
        this.options.excludes.push('**/*.map');
        this.options.excludes.push('**.ico');
        this.options.excludes.push('**.icns');
        this.options.includes = [
            ...this.options.replaceOnly,
            ...this.options.includes,
        ].map((url) => url.replace(/\\/g, '/'));
        // 初始化 md5 的文件处理范围
        const files = await (0, fast_glob_1.default)(this.options.includes, {
            onlyFiles: true,
            ignore: this.options.excludes,
            cwd: this._root,
            deep: 0,
            absolute: true,
        });
        const hasMd5Files = Object.values(this.hashedPathMap).map((path) => (0, path_1.resolve)(path));
        // 在 win 上 fg 获取到的路径为 / 拼接的路径，需要转换成标准的绝对路径
        this._files = files.filter((file) => !hasMd5Files.includes(file)).map((path) => (0, path_1.resolve)(path));
        if (this.options.replaceOnly.length) {
            this._files.forEach((path) => {
                // 需要绝对路径之间的互相匹配
                if (this.options.replaceOnly.find((exclude) => (0, minimatch_1.default)(path, (0, path_1.join)(this._root, exclude)))) {
                    this._waitingReplaceFiles.push(path);
                }
                else {
                    this._waitingMd5Files.push(path);
                }
            });
        }
        else {
            this._waitingMd5Files = this._files;
        }
    }
    async run() {
        // 初始化需要处理的文件范围
        await this.initFiles();
        // 先处理所有需要添加 md5 的文件以及其路径引用
        await this.addMD5ToFiles();
        // 如果没有任何添加 md5 后缀的文件，或者没有需要替换内容引用地址的文件，则无需处理
        if (!this._waitingMd5Files.length || !this._waitingReplaceFiles.length) {
            return;
        }
        // 替换其他不需要添加 md5 的文件内路径引用
        await Promise.all(this._waitingReplaceFiles.map((path) => this.replacePath(path)));
    }
    async replacePath(path) {
        const info = await this.readFileDepends(path);
        if (!info || !info.depends.length) {
            return;
        }
        else {
            // 替换路径引用
            await this.replacePathInCode(path, info);
            await (0, fs_extra_1.outputFile)(path, info.code);
        }
    }
    /**
     * 简单添加 md5 后缀，不识别文件内容
     * @param path
     * @returns
     */
    async addMd5ToPath(path, code) {
        const cryptoHash = (0, utils_1.calcMd5)(code || (0, fs_extra_1.readFileSync)(path, 'utf-8'));
        const newPath = (0, utils_1.patchMd5ToPath)(path, cryptoHash);
        if (code) {
            await (0, fs_extra_1.remove)(path);
            await (0, fs_extra_1.outputFile)(newPath, code);
        }
        else {
            await (0, fs_extra_1.rename)(path, newPath);
        }
        this.hashedPathMap[path] = newPath;
        return newPath;
    }
    /**
     * 查找在 file 内存在的完整的文件
     * @param path
     * @returns
     */
    findFile(parentDir, fileName) {
        // 存在文件后缀的文件
        if ((0, path_1.extname)(fileName)) {
            let path = (0, path_1.join)(parentDir, fileName);
            if (this.checkPathExist(path)) {
                return path;
            }
            else if (!fileName.startsWith('.')) {
                // 常规查找失败时，如果不是相对路径尝试找到根目录下的索引位置
                path = (0, path_1.join)(this._root, fileName);
                if (this.checkPathExist(path)) {
                    return path;
                }
            }
            return '';
        }
        // 没有文件后缀，尝试自动匹配可能的文件
        for (const extName of ['.js', '.json', '/index.js', '/index.json']) {
            let path;
            path = this._joinPath(parentDir, fileName, extName);
            if (this.checkPathExist(path)) {
                return path;
            }
            else if (!fileName.startsWith('.')) {
                path = this._joinPath(this._root, fileName, extName);
                if (this.checkPathExist(path)) {
                    return path;
                }
            }
        }
        return '';
    }
    checkPathExist(path) {
        return this._files.includes(path) || this.hashedPathMap[path];
    }
    _joinPath(root, fileName, extName) {
        if (extName.startsWith('.')) {
            return (0, path_1.join)(root, fileName + extName);
        }
        else {
            return (0, path_1.join)(root, fileName, extName);
        }
    }
    /**
     * 给文件添加 md5 后缀，将会识别内容替换路径引用
     */
    async addMD5ToFiles() {
        const files = this._waitingMd5Files;
        await Promise.all(files.map(async (path) => {
            if (this.hashedPathMap[path]) {
                return;
            }
            const info = await this.readFileDepends(path);
            if (!info || !info.depends.length) {
                await this.addMd5ToPath(path, info?.code);
                return;
            }
            // 存在依赖的路径时，尝试替换路径引用
            await this.replacePathInCode(path, info);
            if (info.depends.length) {
                this.waitUpdateFiles[path] = info;
            }
            else {
                await this.addMd5ToPath(path, info.code);
            }
        }));
        await new Promise(async (resolve, reject) => {
            try {
                const updateFiles = Object.keys(this.waitUpdateFiles);
                while (updateFiles.length) {
                    const path = updateFiles.shift();
                    if (!path) {
                        return;
                    }
                    const info = this.waitUpdateFiles[path];
                    // 尝试替换路径引用
                    await this.replacePathInCode(path, info);
                    if (info.depends.length === 0) {
                        await this.addMd5ToPath(path, info.code);
                        delete this.waitUpdateFiles[path];
                    }
                    else {
                        updateFiles.push(path);
                    }
                }
            }
            catch (error) {
                reject(error);
            }
            resolve();
        });
    }
    replacePathInCode(filePath, fileInfo) {
        const newDepends = [];
        fileInfo.depends.forEach((info, i) => {
            // 替换已经处理 md5 的路径
            if (this.hashedPathMap[info.path]) {
                fileInfo.code = fileInfo.code.replaceAll(info.matchStr, info.matchStr.replace((0, path_1.basename)(info.fileName), (0, path_1.basename)(this.hashedPathMap[info.path])));
            }
            else {
                // 1. 循环引用
                if (this.waitUpdateFiles[info.path] && this.waitUpdateFiles[info.path].depends.find((item) => item.path === filePath) ||
                    // 2. 不在 md5 处理范围内
                    !this._waitingMd5Files.includes(info.path)) {
                    return;
                }
                else {
                    newDepends.push(info);
                }
            }
        });
        fileInfo.depends = newDepends;
        return fileInfo;
    }
    async readFileDepends(path) {
        // 仅读取和替换文本文件内的依赖信息
        const extName = (0, path_1.extname)(path);
        if (!textFiles.includes(extName)) {
            return null;
        }
        // TODO 压缩混淆后的文件不做处理
        const code = (0, fs_extra_1.readFileSync)(path, 'utf-8');
        // 匹配代码内的引用地址信息
        const relativePathRegex = /(?:'|\")([^\s'"]+)(?:'|\")/g;
        let matches = [];
        if (extName === '.html') {
            // 匹配 html 里常规的路径链接
            matches = Array.from(code.matchAll(/(?:href|src)="([^"]*)"/g));
            // html 里 script 标签里的内容才能使用 relativePathRegex 进行依赖查找
            const scriptCodes = extractScriptContents(code);
            if (scriptCodes.length) {
                for (const scriptCode of scriptCodes) {
                    matches = matches.concat(Array.from(scriptCode.matchAll(relativePathRegex)));
                }
            }
        }
        else {
            matches = Array.from(code.matchAll(relativePathRegex));
        }
        const depends = [];
        const root = (0, path_1.dirname)(path);
        for (const match of matches) {
            // 需要补齐文件后缀
            const dependPath = this.findFile(root, match[1]);
            if (!dependPath) {
                continue;
            }
            depends.push({
                path: dependPath,
                matchStr: match[0],
                fileName: match[1],
            });
        }
        return {
            depends,
            code,
        };
    }
}
exports.md5CacheHandler = md5CacheHandler;
function extractScriptContents(htmlContent) {
    const scriptContents = [];
    const scriptTagRegex = /<script\b[^>]*>([\s\S]*?)<\/script>/gm;
    let match;
    while ((match = scriptTagRegex.exec(htmlContent)) !== null) {
        // match[1] 包含了<script>标签内的脚本内容
        if (match[1]) {
            scriptContents.push(match[1]);
        }
    }
    return scriptContents;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWQ1LWNhY2hlLWhhbmRsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9idWlsZGVyL3dvcmtlci9idWlsZGVyL3Rhc2tzL3Bvc3Rwcm9jZXNzLXRhc2svbWQ1LWNhY2hlLWhhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsdUNBQThFO0FBQzlFLCtCQUFpRTtBQUNqRSx1Q0FBc0Q7QUFDdEQsMERBQWtDO0FBQ2xDLDBEQUEyQjtBQWEzQixzQ0FBc0M7QUFDdEMsZ0NBQWdDO0FBQ2hDLE1BQU0sU0FBUyxHQUFhLENBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztBQUVwRCxTQUFTLGVBQWUsQ0FBQyxHQUFXO0lBQ2hDLE9BQU8sR0FBRyxDQUFDLE9BQU8sQ0FBQyx3QkFBd0IsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUN6RCxDQUFDO0FBRUQsc0NBQXNDO0FBQ3RDLFNBQVMsdUJBQXVCLENBQUMsT0FBZTtJQUM1QyxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztJQUMxQyx1QkFBdUI7SUFDdkIsT0FBTyxLQUFLO1NBQ1AsS0FBSyxDQUFDLEdBQUcsQ0FBQztTQUNWLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUN4QyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDbkIsQ0FBQztBQUVELDZEQUE2RDtBQUM3RCxNQUFhLGVBQWU7SUFDeEIsNkJBQTZCO0lBQzdCLGFBQWEsR0FBMkIsRUFBRSxDQUFDO0lBQzNDLE9BQU8sQ0FBYztJQUVyQixLQUFLLENBQVMsQ0FBQyw0Q0FBNEM7SUFFbkQsTUFBTSxHQUFhLEVBQUUsQ0FBQztJQUV0QixnQkFBZ0IsR0FBYSxFQUFFLENBQUM7SUFDaEMsb0JBQW9CLEdBQWEsRUFBRSxDQUFD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Y0FBYyxHQUFhLEVBQUUsQ0FBQztJQUNwQyxNQUFNLGNBQWMsR0FBRyx1Q0FBdUMsQ0FBQztJQUUvRCxJQUFJLEtBQUssQ0FBQztJQUNWLE9BQU8sQ0FBQyxLQUFLLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ3pELCtCQUErQjtRQUMvQixJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQ1gsY0FBYyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsQyxDQUFDO0lBQ0wsQ0FBQztJQUNELE9BQU8sY0FBYyxDQUFDO0FBQzFCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyByZWFkRmlsZVN5bmMsIHJlbW92ZSwgb3V0cHV0RmlsZSwgcmVuYW1lLCByZWFkRmlsZSB9IGZyb20gJ2ZzLWV4dHJhJztcclxuaW1wb3J0IHsgZGlybmFtZSwgYmFzZW5hbWUsIGpvaW4sIGV4dG5hbWUsIHJlc29sdmUgfSBmcm9tICdwYXRoJztcclxuaW1wb3J0IHsgY2FsY01kNSwgcGF0Y2hNZDVUb1BhdGggfSBmcm9tICcuLi8uLi91dGlscyc7XHJcbmltcG9ydCBtaW5pbWF0Y2ggZnJvbSAnbWluaW1hdGNoJztcclxuaW1wb3J0IGZnIGZyb20gJ2Zhc3QtZ2xvYic7XHJcbmltcG9ydCB7IElNRDVPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vLi4vQHR5cGVzL3Byb3RlY3RlZCc7XHJcblxyXG5pbnRlcmZhY2UgRmlsZURlcGVuZCB7XHJcbiAgICBwYXRoOiBzdHJpbmc7XHJcbiAgICBtYXRjaFN0cjogc3RyaW5nO1xyXG4gICAgZmlsZU5hbWU6IHN0cmluZztcclxufVxyXG5pbnRlcmZhY2UgRmlsZUNvbnRlbnRJbmZvIHtcclxuICAgIGRlcGVuZHM6IEZpbGVEZXBlbmRbXTtcclxuICAgIGNvZGU6IHN0cmluZztcclxufVxyXG5cclxuLy8g5pqC5pe257yp5bCP6Ieq5Yqo5pu/5o2i5paH5Lu26Lev5b6E55qE5aSE55CG6IyD5Zu077yM55uu5YmN57yW6L6R5Zmo5YaF572u55qE5qih5p2/6L+Z5Lqb5qC85byP5bey6Laz5aSfXHJcbi8vIOWFtuS7luexu+Wei+i/h+WOu+eJiOacrOS5n+S4jeaUr+aMgeabv+aNoiBtZDXvvIzlpoLmnpzmnInlj43ppojlho3lpITnkIbljbPlj69cclxuY29uc3QgdGV4dEZpbGVzOiBzdHJpbmdbXSA9IFsnLmpzJywgJy50cycsICcuaHRtbCddO1xyXG5cclxuZnVuY3Rpb24gZXNjYXBlR2xvYkNoYXJzKHN0cjogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gc3RyLnJlcGxhY2UoLyhbKj9bXFxde30oKSErQHxeJFxcXFxdKS9nLCAnXFxcXCQxJyk7XHJcbn1cclxuXHJcbi8vIOaKiuS7u+aEjyBXaW5kb3dzIOmjjuagvOaIlua3t+WQiOi3r+W+hOWuieWFqOWMluS4uiBQT1NJWCDpo47moLzlubbovazkuYlcclxuZnVuY3Rpb24gc2FmZVBhdHRlcm5Gcm9tQWJzb2x1dGUoYWJzUGF0aDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBwb3NpeCA9IGFic1BhdGgucmVwbGFjZSgvXFxcXC9nLCAnLycpO1xyXG4gICAgLy8g5oqK5q+P5Liq6Lev5b6E5q615Y2V54us6L2s5LmJ77yM6Ziy5q2i6L2s5LmJ6Lev5b6E5YiG6ZqU56ymXHJcbiAgICByZXR1cm4gcG9zaXhcclxuICAgICAgICAuc3BsaXQoJy8nKVxyXG4gICAgICAgIC5tYXAoc2VnbWVudCA9PiBlc2NhcGVHbG9iQ2hhcnMoc2VnbWVudCkpXHJcbiAgICAgICAgLmpvaW4oJy8nKTtcclxufVxyXG5cclxuLy8g55uu5YmN55Sx5LqO5YaF6YOo5qih5p2/5pyJ6K645aSa5L2/55So5a2X56ym5Liy5ou85o6l5byV55So6Lev5b6E55qE5YaZ5rOV77yM5LiN6IO96ZmQ5Yi2IGltcG9ydCDmiJbogIUgcmVxdWlyZSDkvb/nlKjnm7jlr7not6/lvoTnmoTmlrnlvI9cclxuZXhwb3J0IGNsYXNzIG1kNUNhY2hlSGFuZGxlciB7XHJcbiAgICAvLyDljp/lp4vmlofku7blnLDlnYAgLT4g5bey5re75YqgIGhhc2gg5ZCO57yA55qE5paH5Lu25Zyw5Z2AXHJcbiAgICBoYXNoZWRQYXRoTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XHJcbiAgICBvcHRpb25zOiBJTUQ1T3B0aW9ucztcclxuXHJcbiAgICBfcm9vdDogc3RyaW5nOyAvLyDmoLnnm67lvZXvvIzkuI3kvb/nlKggLi8g5byA5aS055qE6Lev5b6E5byV55So5bm25LiN5LiA5a6a55u45a+55LqO5byV55So5paH5Lu255uu5b2V77yM6ZyA6KaB5Zyo5qC555uu5b2V5LiL5p+l5om+XHJcblxyXG4gICAgcHJpdmF0ZSBfZmlsZXM6IHN0cmluZ1tdID0gW107XHJcblxyXG4gICAgcHJpdmF0ZSBfd2FpdGluZ01kNUZpbGVzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgcHJpdmF0ZSBfd2FpdGluZ1JlcGxhY2VGaWxlczogc3RyaW5nW10gPSBbXTtcclxuXHJcbiAgICAvLyDnrYnlvoXmm7TmlrDnmoTmlofku7blhoXlrrlcclxuICAgIHByaXZhdGUgd2FpdFVwZGF0ZUZpbGVzOiBSZWNvcmQ8c3RyaW5nLCBGaWxlQ29udGVudEluZm8+ID0ge307XHJcblxyXG4gICAgY29uc3RydWN0b3Iocm9vdDogc3RyaW5nLCBvcHRpb25zOiBJTUQ1T3B0aW9ucykge1xyXG4gICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XHJcbiAgICAgICAgdGhpcy5fcm9vdCA9IHJvb3Q7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhc3luYyBpbml0RmlsZXMoKSB7XHJcbiAgICAgICAgdGhpcy5vcHRpb25zLmV4Y2x1ZGVzLnB1c2goJyoqLyoubWFwJyk7XHJcbiAgICAgICAgdGhpcy5vcHRpb25zLmV4Y2x1ZGVzLnB1c2goJyoqLmljbycpO1xyXG4gICAgICAgIHRoaXMub3B0aW9ucy5leGNsdWRlcy5wdXNoKCcqKi5pY25zJyk7XHJcbiAgICAgICAgdGhpcy5vcHRpb25zLmluY2x1ZGVzID0gW1xyXG4gICAgICAgICAgICAuLi50aGlzLm9wdGlvbnMucmVwbGFjZU9ubHksXHJcbiAgICAgICAgICAgIC4uLnRoaXMub3B0aW9ucy5pbmNsdWRlcyxcclxuICAgICAgICBdLm1hcCgodXJsKSA9PiB1cmwucmVwbGFjZSgvXFxcXC9nLCAnLycpKTtcclxuICAgICAgICAvLyDliJ3lp4vljJYgbWQ1IOeahOaWh+S7tuWkhOeQhuiMg+WbtFxyXG4gICAgICAgIGNvbnN0IGZpbGVzOiBzdHJpbmdbXSA9IGF3YWl0IGZnKHRoaXMub3B0aW9ucy5pbmNsdWRlcywge1xyXG4gICAgICAgICAgICBvbmx5RmlsZXM6IHRydWUsXHJcbiAgICAgICAgICAgIGlnbm9yZTogdGhpcy5vcHRpb25zLmV4Y2x1ZGVzLFxyXG4gICAgICAgICAgICBjd2Q6IHRoaXMuX3Jvb3QsXHJcbiAgICAgICAgICAgIGRlZXA6IDAsXHJcbiAgICAgICAgICAgIGFic29sdXRlOiB0cnVlLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IGhhc01kNUZpbGVzID0gT2JqZWN0LnZhbHVlcyh0aGlzLmhhc2hlZFBhdGhNYXApLm1hcCgocGF0aCkgPT4gcmVzb2x2ZShwYXRoKSk7XHJcblxyXG4gICAgICAgIC8vIOWcqCB3aW4g5LiKIGZnIOiOt+WPluWIsOeahOi3r+W+hOS4uiAvIOaLvOaOpeeahOi3r+W+hO+8jOmcgOimgei9rOaNouaIkOagh+WHhueahOe7neWvuei3r+W+hFxyXG4gICAgICAgIHRoaXMuX2ZpbGVzID0gZmlsZXMuZmlsdGVyKChmaWxlKSA9PiAhaGFzTWQ1RmlsZXMuaW5jbHVkZXMoZmlsZSkpLm1hcCgocGF0aCkgPT4gcmVzb2x2ZShwYXRoKSk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmVwbGFjZU9ubHkubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2ZpbGVzLmZvckVhY2goKHBhdGgpID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIOmcgOimgee7neWvuei3r+W+hOS5i+mXtOeahOS6kuebuOWMuemFjVxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5yZXBsYWNlT25seS5maW5kKChleGNsdWRlKSA9PiBtaW5pbWF0Y2gocGF0aCwgam9pbih0aGlzLl9yb290LCBleGNsdWRlKSkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fd2FpdGluZ1JlcGxhY2VGaWxlcy5wdXNoKHBhdGgpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl93YWl0aW5nTWQ1RmlsZXMucHVzaChwYXRoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5fd2FpdGluZ01kNUZpbGVzID0gdGhpcy5fZmlsZXM7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIHJ1bigpIHtcclxuICAgICAgICAvLyDliJ3lp4vljJbpnIDopoHlpITnkIbnmoTmlofku7bojIPlm7RcclxuICAgICAgICBhd2FpdCB0aGlzLmluaXRGaWxlcygpO1xyXG4gICAgICAgIC8vIOWFiOWkhOeQhuaJgOaciemcgOimgea3u+WKoCBtZDUg55qE5paH5Lu25Lul5Y+K5YW26Lev5b6E5byV55SoXHJcbiAgICAgICAgYXdhaXQgdGhpcy5hZGRNRDVUb0ZpbGVzKCk7XHJcbiAgICAgICAgLy8g5aaC5p6c5rKh5pyJ5Lu75L2V5re75YqgIG1kNSDlkI7nvIDnmoTmlofku7bvvIzmiJbogIXmsqHmnInpnIDopoHmm7/mjaLlhoXlrrnlvJXnlKjlnLDlnYDnmoTmlofku7bvvIzliJnml6DpnIDlpITnkIZcclxuICAgICAgICBpZiAoIXRoaXMuX3dhaXRpbmdNZDVGaWxlcy5sZW5ndGggfHwgIXRoaXMuX3dhaXRpbmdSZXBsYWNlRmlsZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5pu/5o2i5YW25LuW5LiN6ZyA6KaB5re75YqgIG1kNSDnmoTmlofku7blhoXot6/lvoTlvJXnlKhcclxuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbCh0aGlzLl93YWl0aW5nUmVwbGFjZUZpbGVzLm1hcCgocGF0aCkgPT4gdGhpcy5yZXBsYWNlUGF0aChwYXRoKSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIHJlcGxhY2VQYXRoKHBhdGg6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IGluZm8gPSBhd2FpdCB0aGlzLnJlYWRGaWxlRGVwZW5kcyhwYXRoKTtcclxuICAgICAgICBpZiAoIWluZm8gfHwgIWluZm8uZGVwZW5kcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIOabv+aNoui3r+W+hOW8leeUqFxyXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnJlcGxhY2VQYXRoSW5Db2RlKHBhdGgsIGluZm8pO1xyXG4gICAgICAgICAgICBhd2FpdCBvdXRwdXRGaWxlKHBhdGgsIGluZm8uY29kZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog566A5Y2V5re75YqgIG1kNSDlkI7nvIDvvIzkuI3or4bliKvmlofku7blhoXlrrlcclxuICAgICAqIEBwYXJhbSBwYXRoIFxyXG4gICAgICogQHJldHVybnMgXHJcbiAgICAgKi9cclxuICAgIGFzeW5jIGFkZE1kNVRvUGF0aChwYXRoOiBzdHJpbmcsIGNvZGU/OiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBjcnlwdG9IYXNoID0gY2FsY01kNShjb2RlIHx8IHJlYWRGaWxlU3luYyhwYXRoLCAndXRmLTgnKSk7XHJcbiAgICAgICAgY29uc3QgbmV3UGF0aCA9IHBhdGNoTWQ1VG9QYXRoKHBhdGgsIGNyeXB0b0hhc2gpO1xyXG4gICAgICAgIGlmIChjb2RlKSB7XHJcbiAgICAgICAgICAgIGF3YWl0IHJlbW92ZShwYXRoKTtcclxuICAgICAgICAgICAgYXdhaXQgb3V0cHV0RmlsZShuZXdQYXRoLCBjb2RlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBhd2FpdCByZW5hbWUocGF0aCwgbmV3UGF0aCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuaGFzaGVkUGF0aE1hcFtwYXRoXSA9IG5ld1BhdGg7XHJcbiAgICAgICAgcmV0dXJuIG5ld1BhdGg7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmn6Xmib7lnKggZmlsZSDlhoXlrZjlnKjnmoTlrozmlbTnmoTmlofku7ZcclxuICAgICAqIEBwYXJhbSBwYXRoIFxyXG4gICAgICogQHJldHVybnMgXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgZmluZEZpbGUocGFyZW50RGlyOiBzdHJpbmcsIGZpbGVOYW1lOiBzdHJpbmcpIHtcclxuICAgICAgICAvLyDlrZjlnKjmlofku7blkI7nvIDnmoTmlofku7ZcclxuICAgICAgICBpZiAoZXh0bmFtZShmaWxlTmFtZSkpIHtcclxuICAgICAgICAgICAgbGV0IHBhdGggPSBqb2luKHBhcmVudERpciwgZmlsZU5hbWUpO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5jaGVja1BhdGhFeGlzdChwYXRoKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHBhdGg7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWZpbGVOYW1lLnN0YXJ0c1dpdGgoJy4nKSkge1xyXG4gICAgICAgICAgICAgICAgLy8g5bi46KeE5p+l5om+5aSx6LSl5pe277yM5aaC5p6c5LiN5piv55u45a+56Lev5b6E5bCd6K+V5om+5Yiw5qC555uu5b2V5LiL55qE57Si5byV5L2N572uXHJcbiAgICAgICAgICAgICAgICBwYXRoID0gam9pbih0aGlzLl9yb290LCBmaWxlTmFtZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGVja1BhdGhFeGlzdChwYXRoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXRoO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOayoeacieaWh+S7tuWQjue8gO+8jOWwneivleiHquWKqOWMuemFjeWPr+iDveeahOaWh+S7tlxyXG4gICAgICAgIGZvciAoY29uc3QgZXh0TmFtZSBvZiBbJy5qcycsICcuanNvbicsICcvaW5kZXguanMnLCAnL2luZGV4Lmpzb24nXSkge1xyXG4gICAgICAgICAgICBsZXQgcGF0aDogc3RyaW5nO1xyXG4gICAgICAgICAgICBwYXRoID0gdGhpcy5fam9pblBhdGgocGFyZW50RGlyLCBmaWxlTmFtZSwgZXh0TmFtZSk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmNoZWNrUGF0aEV4aXN0KHBhdGgpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcGF0aDtcclxuICAgICAgICAgICAgfSBlbHNlIGlmICghZmlsZU5hbWUuc3RhcnRzV2l0aCgnLicpKSB7XHJcbiAgICAgICAgICAgICAgICBwYXRoID0gdGhpcy5fam9pblBhdGgodGhpcy5fcm9vdCwgZmlsZU5hbWUsIGV4dE5hbWUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hlY2tQYXRoRXhpc3QocGF0aCkpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGF0aDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjaGVja1BhdGhFeGlzdChwYXRoOiBzdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZmlsZXMuaW5jbHVkZXMocGF0aCkgfHwgdGhpcy5oYXNoZWRQYXRoTWFwW3BhdGhdO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2pvaW5QYXRoKHJvb3Q6IHN0cmluZywgZmlsZU5hbWU6IHN0cmluZywgZXh0TmFtZTogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKGV4dE5hbWUuc3RhcnRzV2l0aCgnLicpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBqb2luKHJvb3QsIGZpbGVOYW1lICsgZXh0TmFtZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIGpvaW4ocm9vdCwgZmlsZU5hbWUsIGV4dE5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOe7meaWh+S7tua3u+WKoCBtZDUg5ZCO57yA77yM5bCG5Lya6K+G5Yir5YaF5a655pu/5o2i6Lev5b6E5byV55SoXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgYXN5bmMgYWRkTUQ1VG9GaWxlcygpIHtcclxuICAgICAgICBjb25zdCBmaWxlcyA9IHRoaXMuX3dhaXRpbmdNZDVGaWxlcztcclxuXHJcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoZmlsZXMubWFwKGFzeW5jIChwYXRoKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmhhc2hlZFBhdGhNYXBbcGF0aF0pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBpbmZvID0gYXdhaXQgdGhpcy5yZWFkRmlsZURlcGVuZHMocGF0aCk7XHJcbiAgICAgICAgICAgIGlmICghaW5mbyB8fCAhaW5mby5kZXBlbmRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5hZGRNZDVUb1BhdGgocGF0aCwgaW5mbz8uY29kZSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8g5a2Y5Zyo5L6d6LWW55qE6Lev5b6E5pe277yM5bCd6K+V5pu/5o2i6Lev5b6E5byV55SoXHJcbiAgICAgICAgICAgIGF3YWl0IHRoaXMucmVwbGFjZVBhdGhJbkNvZGUocGF0aCwgaW5mbyk7XHJcbiAgICAgICAgICAgIGlmIChpbmZvLmRlcGVuZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLndhaXRVcGRhdGVGaWxlc1twYXRoXSA9IGluZm87XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmFkZE1kNVRvUGF0aChwYXRoLCBpbmZvLmNvZGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZTx2b2lkPihhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB1cGRhdGVGaWxlczogc3RyaW5nW10gPSBPYmplY3Qua2V5cyh0aGlzLndhaXRVcGRhdGVGaWxlcyk7XHJcbiAgICAgICAgICAgICAgICB3aGlsZSAodXBkYXRlRmlsZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGF0aCA9IHVwZGF0ZUZpbGVzLnNoaWZ0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwYXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5mbyA9IHRoaXMud2FpdFVwZGF0ZUZpbGVzW3BhdGhdO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOWwneivleabv+aNoui3r+W+hOW8leeUqFxyXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucmVwbGFjZVBhdGhJbkNvZGUocGF0aCwgaW5mbyk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZm8uZGVwZW5kcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5hZGRNZDVUb1BhdGgocGF0aCwgaW5mby5jb2RlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMud2FpdFVwZGF0ZUZpbGVzW3BhdGhdO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZUZpbGVzLnB1c2gocGF0aCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVwbGFjZVBhdGhJbkNvZGUoZmlsZVBhdGg6IHN0cmluZywgZmlsZUluZm86IEZpbGVDb250ZW50SW5mbykge1xyXG4gICAgICAgIGNvbnN0IG5ld0RlcGVuZHM6IEZpbGVEZXBlbmRbXSA9IFtdO1xyXG4gICAgICAgIGZpbGVJbmZvLmRlcGVuZHMuZm9yRWFjaCgoaW5mbywgaSkgPT4ge1xyXG4gICAgICAgICAgICAvLyDmm7/mjaLlt7Lnu4/lpITnkIYgbWQ1IOeahOi3r+W+hFxyXG4gICAgICAgICAgICBpZiAodGhpcy5oYXNoZWRQYXRoTWFwW2luZm8ucGF0aF0pIHtcclxuICAgICAgICAgICAgICAgIGZpbGVJbmZvLmNvZGUgPSBmaWxlSW5mby5jb2RlLnJlcGxhY2VBbGwoaW5mby5tYXRjaFN0ciwgaW5mby5tYXRjaFN0ci5yZXBsYWNlKGJhc2VuYW1lKGluZm8uZmlsZU5hbWUpLCBiYXNlbmFtZSh0aGlzLmhhc2hlZFBhdGhNYXBbaW5mby5wYXRoXSkpKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vIDEuIOW+queOr+W8leeUqFxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMud2FpdFVwZGF0ZUZpbGVzW2luZm8ucGF0aF0gJiYgdGhpcy53YWl0VXBkYXRlRmlsZXNbaW5mby5wYXRoXS5kZXBlbmRzLmZpbmQoKGl0ZW0pID0+IGl0ZW0ucGF0aCA9PT0gZmlsZVBhdGgpIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gMi4g5LiN5ZyoIG1kNSDlpITnkIbojIPlm7TlhoVcclxuICAgICAgICAgICAgICAgICAgICAhdGhpcy5fd2FpdGluZ01kNUZpbGVzLmluY2x1ZGVzKGluZm8ucGF0aClcclxuICAgICAgICAgICAgICAgICkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV3RGVwZW5kcy5wdXNoKGluZm8pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgZmlsZUluZm8uZGVwZW5kcyA9IG5ld0RlcGVuZHM7XHJcbiAgICAgICAgcmV0dXJuIGZpbGVJbmZvO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYXN5bmMgcmVhZEZpbGVEZXBlbmRzKHBhdGg6IHN0cmluZyk6IFByb21pc2U8RmlsZUNvbnRlbnRJbmZvIHwgbnVsbD4ge1xyXG4gICAgICAgIC8vIOS7heivu+WPluWSjOabv+aNouaWh+acrOaWh+S7tuWGheeahOS+nei1luS/oeaBr1xyXG4gICAgICAgIGNvbnN0IGV4dE5hbWUgPSBleHRuYW1lKHBhdGgpO1xyXG4gICAgICAgIGlmICghdGV4dEZpbGVzLmluY2x1ZGVzKGV4dE5hbWUpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBUT0RPIOWOi+e8qea3t+a3huWQjueahOaWh+S7tuS4jeWBmuWkhOeQhlxyXG5cclxuICAgICAgICBjb25zdCBjb2RlID0gcmVhZEZpbGVTeW5jKHBhdGgsICd1dGYtOCcpO1xyXG4gICAgICAgIC8vIOWMuemFjeS7o+eggeWGheeahOW8leeUqOWcsOWdgOS/oeaBr1xyXG4gICAgICAgIGNvbnN0IHJlbGF0aXZlUGF0aFJlZ2V4ID0gLyg/Oid8XFxcIikoW15cXHMnXCJdKykoPzonfFxcXCIpL2c7XHJcbiAgICAgICAgbGV0IG1hdGNoZXM6IFJlZ0V4cE1hdGNoQXJyYXlbXSA9IFtdO1xyXG4gICAgICAgIGlmIChleHROYW1lID09PSAnLmh0bWwnKSB7XHJcbiAgICAgICAgICAgIC8vIOWMuemFjSBodG1sIOmHjOW4uOinhOeahOi3r+W+hOmTvuaOpVxyXG4gICAgICAgICAgICBtYXRjaGVzID0gQXJyYXkuZnJvbShjb2RlLm1hdGNoQWxsKC8oPzpocmVmfHNyYyk9XCIoW15cIl0qKVwiL2cpKTtcclxuICAgICAgICAgICAgLy8gaHRtbCDph4wgc2NyaXB0IOagh+etvumHjOeahOWGheWuueaJjeiDveS9v+eUqCByZWxhdGl2ZVBhdGhSZWdleCDov5vooYzkvp3otZbmn6Xmib5cclxuICAgICAgICAgICAgY29uc3Qgc2NyaXB0Q29kZXMgPSBleHRyYWN0U2NyaXB0Q29udGVudHMoY29kZSk7XHJcbiAgICAgICAgICAgIGlmIChzY3JpcHRDb2Rlcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgc2NyaXB0Q29kZSBvZiBzY3JpcHRDb2Rlcykge1xyXG4gICAgICAgICAgICAgICAgICAgIG1hdGNoZXMgPSBtYXRjaGVzLmNvbmNhdChBcnJheS5mcm9tKHNjcmlwdENvZGUubWF0Y2hBbGwocmVsYXRpdmVQYXRoUmVnZXgpKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBtYXRjaGVzID0gQXJyYXkuZnJvbShjb2RlLm1hdGNoQWxsKHJlbGF0aXZlUGF0aFJlZ2V4KSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGRlcGVuZHM6IEZpbGVEZXBlbmRbXSA9IFtdO1xyXG4gICAgICAgIGNvbnN0IHJvb3QgPSBkaXJuYW1lKHBhdGgpO1xyXG4gICAgICAgIGZvciAoY29uc3QgbWF0Y2ggb2YgbWF0Y2hlcykge1xyXG4gICAgICAgICAgICAvLyDpnIDopoHooaXpvZDmlofku7blkI7nvIBcclxuICAgICAgICAgICAgY29uc3QgZGVwZW5kUGF0aCA9IHRoaXMuZmluZEZpbGUocm9vdCwgbWF0Y2hbMV0pO1xyXG4gICAgICAgICAgICBpZiAoIWRlcGVuZFBhdGgpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRlcGVuZHMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICBwYXRoOiBkZXBlbmRQYXRoLFxyXG4gICAgICAgICAgICAgICAgbWF0Y2hTdHI6IG1hdGNoWzBdLFxyXG4gICAgICAgICAgICAgICAgZmlsZU5hbWU6IG1hdGNoWzFdLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgZGVwZW5kcyxcclxuICAgICAgICAgICAgY29kZSxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBleHRyYWN0U2NyaXB0Q29udGVudHMoaHRtbENvbnRlbnQ6IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuICAgIGNvbnN0IHNjcmlwdENvbnRlbnRzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgY29uc3Qgc2NyaXB0VGFnUmVnZXggPSAvPHNjcmlwdFxcYltePl0qPihbXFxzXFxTXSo/KTxcXC9zY3JpcHQ+L2dtO1xyXG5cclxuICAgIGxldCBtYXRjaDtcclxuICAgIHdoaWxlICgobWF0Y2ggPSBzY3JpcHRUYWdSZWdleC5leGVjKGh0bWxDb250ZW50KSkgIT09IG51bGwpIHtcclxuICAgICAgICAvLyBtYXRjaFsxXSDljIXlkKvkuoY8c2NyaXB0Puagh+etvuWGheeahOiEmuacrOWGheWuuVxyXG4gICAgICAgIGlmIChtYXRjaFsxXSkge1xyXG4gICAgICAgICAgICBzY3JpcHRDb250ZW50cy5wdXNoKG1hdGNoWzFdKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc2NyaXB0Q29udGVudHM7XHJcbn0iXX0=