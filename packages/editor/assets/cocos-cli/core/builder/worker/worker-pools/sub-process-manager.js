"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.workerManager = exports.WorkerManager = void 0;
const child_process_1 = require("child_process");
const path_1 = require("path");
const global_1 = require("../../../../global");
// 获取 CPU 数量，有几个 CPU 就创建几个子进程，这样就可以最大化的利用机器性能
const workerPath = (0, path_1.join)(__dirname, './sub-process');
class ProcessPool {
    pool = new Set();
    // 中断构建任务时，会杀掉正在运行的进程，其他进程会继续保留等待后续调用
    runningPool = new Set();
    add(child) {
        this.pool.add(child);
    }
    running(child) {
        this.runningPool.add(child);
    }
    notRunning(child) {
        this.runningPool.delete(child);
    }
    /**
     * 删除进程，将会移除所有进程池里的索引
     * @param child
     */
    delete(child) {
        this.notRunning(child);
        this.pool.delete(child);
    }
    killAll() {
        this.pool.forEach((child) => {
            child.kill();
        });
        this.pool.clear();
    }
    kill(child) {
        child.kill();
        this.notRunning(child);
        this.delete(child);
    }
    killRunning() {
        this.runningPool.forEach((child) => {
            child.kill();
            this.delete(child);
        });
        this.runningPool.clear();
    }
    killFree() {
        this.pool.forEach((child) => {
            if (this.runningPool.has(child)) {
                return;
            }
            child.kill();
            this.pool.delete(child);
        });
    }
}
const processPool = new ProcessPool();
class WorkerTask {
    path;
    lazy = false;
    busy = false;
    options;
    _name;
    _method;
    get name() {
        return this._method || this._name;
    }
    _hasResolve = false;
    _hasReject = false;
    _resolve;
    _reject;
    setResolve = (resolve) => {
        this._hasResolve = false;
        this._resolve = resolve;
    };
    setReject = (reject) => {
        this._hasReject = false;
        this._reject = reject;
    };
    resolve = (value) => {
        if (this._hasResolve || !this._method || !this._resolve) {
            return;
        }
        console.debug(`execute-script-end with ${this.name} ${Date.now() - this.startTime}ms`);
        this._hasResolve = true;
        delete this._method;
        this._resolve(value);
    };
    reject = (error) => {
        if (this._hasReject || !this._method || !this._reject) {
            error && console.debug(error);
            return;
        }
        console.error(error);
        this._hasReject = true;
        delete this._method;
        this._reject(error);
    };
    startTime = Date.now();
    _handleProcess;
    constructor(params) {
        this._name = params.name;
        this.path = params.path;
        this.lazy = params.lazy || false;
        this.options = params.options;
    }
    async execute(method, args) {
        const child = await this.getWorkerProcess();
        if (!child) {
            throw new Error('No worker ' + this.name);
        }
        return new Promise((resolve, reject) => {
            this._method = method;
            this.setResolve(resolve);
            this.setReject(reject);
            this.startTime = Date.now();
            child.send({
                type: 'execute-script',
                path: this.path,
                method,
                args,
            });
            processPool.running(child);
        });
    }
    async getWorkerProcess() {
        if (!this._handleProcess) {
            this._handleProcess = await this.createWorkerProcess();
        }
        return this._handleProcess;
    }
    async createWorkerProcess() {
        const child = (0, child_process_1.fork)(workerPath, [], {
            execArgv: WorkerManager.defaultArgv || [],
            stdio: ['ipc', 'pipe', 'pipe', 'pipe'],
            // 进程默认的 cwd 不同系统上不稳定，在编译脚本时可能遇到问题
            cwd: this.options?.cwd || global_1.GlobalPaths.workspace,
            // 确保子进程能够独立运行
            detached: false,
            // 确保信号处理正确
            killSignal: 'SIGTERM',
        });
        child.on('message', (m) => {
            if (m && m.type === 'execute-script-end') {
                processPool.notRunning(child);
                m.code === 0 ? this.resolve(m.data) : this.reject(new Error(`execute-task ${this.name} failed with code ${m.code}!`));
            }
        });
        child.on('error', (err) => {
            this.reject(err);
            this.close();
        });
        child.on('exit', (code, signal) => {
            if (code !== 0 && signal !== 'SIGTERM') {
                this.reject(new Error(`Exit process with code:${code}, signal:${signal} in task ${this.name}`));
            }
            else {
                this.resolve();
            }
            this.close();
        });
        child.stdout?.on('data', (data) => {
            console.log(`[${this.name}]` + data.toString());
        });
        child.stderr?.on('data', (data) => {
            const info = data.toString();
            // 调试模式下开启进程默认会在 stderr 里输出一段调试信息，这段信息在不同的设备上有的显示多行有的显示单行文字，因而需要做多次过滤
            if (!info || info.includes('Debugger') || info.includes('For help, see') || info.includes('Starting inspector on')) {
                console.debug(info);
                return;
            }
            // 子进程警告输出 HACK 2/2
            if (info.includes('[warning]')) {
                console.warn(`[${this.name}]` + info.replace('[warning]', ''));
                return;
            }
            console.error(`[${this.name}]` + info);
        });
        processPool.add(child);
        return child;
    }
    close() {
        this.busy = false;
        delete this._method;
        if (this._handleProcess) {
            processPool.kill(this._handleProcess);
            delete this._handleProcess;
        }
    }
}
/**
 * 任务进程管理器
 */
class WorkerManager {
    // 任务队列
    taskMap = {};
    _clearFreeChildTimer;
    static defaultArgv = [];
    static toggleDebug() {
        if (WorkerManager.defaultArgv.includes('--inspect')) {
            WorkerManager.defaultArgv = WorkerManager.defaultArgv.filter((arg) => arg !== '--inspect');
        }
        else {
            WorkerManager.defaultArgv.push('--inspect');
        }
    }
    constructor(tasks) {
        tasks && tasks.forEach((task) => this.registerTask(task));
    }
    /**
     * 注册一个需要开启子进程独立运行的任务信息，注册后会开启子进程，等待执行，有重复的任务会复用进程
     * @param task
     * @returns
     */
    async registerTask(task) {
        if (this.taskMap[task.name]) {
            return;
        }
        this.taskMap[task.name] = new WorkerTask(task);
    }
    async runTask(name, method, args) {
        this.resetClearTimer();
        const task = this.taskMap[name];
        if (!task) {
            throw new Error('No worker ' + name);
        }
        return await task.execute(method, args);
    }
    /**
     * 停止某个进程
     * @param name
     */
    kill(name) {
        const task = this.taskMap[name];
        if (!task) {
            return;
        }
        task.close();
    }
    /**
     * 中断所有正在执行的进程任务，和直接 kill 有差异
     */
    killRunningChilds = processPool.killRunning.bind(processPool);
    /**
     * 清理在空闲状态的进程
     */
    killFreeChilds = processPool.killFree.bind(processPool);
    /**
     * 重置清理进程池的定时器, 20 分钟之内没有多余操作，就清理空闲子进程
     */
    resetClearTimer() {
        this._clearFreeChildTimer && clearTimeout(this._clearFreeChildTimer);
        this._clearFreeChildTimer = setTimeout(() => {
            this.killFreeChilds();
        }, 20 * 1000 * 60);
    }
    /**
     * 快速开启子进程
     * @param command
     * @param cmdParams
     * @param options
     * @returns
     */
    quickSpawn(command, cmdParams, options = {
        downGradeLog: true,
        prefix: '',
    }) {
        if (command === 'npm') {
            command = process.platform === 'win32' ? 'npm.cmd' : 'npm';
        }
        options.prefix = options.prefix || '';
        return new Promise((resolve, reject) => {
            const ls = (0, child_process_1.spawn)(command, cmdParams, {
                cwd: options?.cwd || undefined,
                env: options?.env,
                shell: !!options?.shell,
            });
            processPool.add(ls);
            processPool.running(ls);
            if (!options.ignoreLog) {
                ls.stdout.on('data', (data) => {
                    data = data.toString();
                    if (options?.downGradeLog) {
                        console.debug(options.prefix + data.toString());
                    }
                    else {
                        console.log(options.prefix + data.toString());
                    }
                });
            }
            ls.stderr.on('data', (err) => {
                const error = err.toString();
                // 过滤掉空或只有换行的报错，以及 native-pack-tool 没有设置私有仓库的警告（就不去 engine 修改了）
                if (!error || error === '\n' || /^(?=.*native-pack-tool)(?=.*No repository field)/gi.test(error)) {
                    return;
                }
                const data = options.prefix + error;
                let type = 'error';
                if (/warn/gi.test(data)) {
                    type = 'warn';
                    if (options?.downGradeWaring) {
                        type = 'log';
                    }
                }
                else if (options?.downGradeError) {
                    type = 'log';
                }
                // @ts-ignore
                console[type](data);
            });
            ls.on('close', (code) => {
                processPool.delete(ls);
                if (code !== 0) {
                    reject(options.prefix + `Child process exit width code ${code}:${command} ${cmdParams.toString()}`);
                }
                else {
                    resolve(true);
                    console.debug(options.prefix + `Child process exit width code ${code}`);
                }
            });
            ls.on('error', (err) => {
                processPool.delete(ls);
                console.error(options.prefix + `child process error: ${command} ${cmdParams.toString()}`);
                reject(err);
            });
            ls.on('exit', (code) => {
                processPool.delete(ls);
                if (code !== 0) {
                    reject(options.prefix + `Child process exit width code ${code}:${command} ${cmdParams.toString()}`);
                }
                else {
                    resolve(true);
                    console.debug(options.prefix + `Child process exit width code ${code}`);
                }
            });
        });
    }
}
exports.WorkerManager = WorkerManager;
exports.workerManager = new WorkerManager();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ViLXByb2Nlc3MtbWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL2J1aWxkZXIvd29ya2VyL3dvcmtlci1wb29scy9zdWItcHJvY2Vzcy1tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLGlEQUF1RTtBQUN2RSwrQkFBcUM7QUFHckMsK0NBQWlEO0FBRWpELDZDQUE2QztBQUM3QyxNQUFNLFVBQVUsR0FBRyxJQUFBLFdBQUksRUFBQyxTQUFTLEVBQUUsZUFBZSxDQUFDLENBQUM7QUFlcEQsTUFBTSxXQUFXO0lBQ0wsSUFBSSxHQUFzQixJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQzVDLHFDQUFxQztJQUM3QixXQUFXLEdBQXNCLElBQUksR0FBRyxFQUFFLENBQUM7SUFFbkQsR0FBRyxDQUFDLEtBQW1CO1FBQ25CLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3pCLENBQUM7SUFFRCxPQUFPLENBQUMsS0FBbUI7UUFDdkIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVELFVBQVUsQ0FBQyxLQUFtQjtRQUMxQixJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsTUFBTSxDQUFDLEtBQW1CO1FBQ3RCLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdkIsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVELE9BQU87UUFDSCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO1lBQ3hCLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNqQixDQUFDLENBQUMsQ0FBQztRQUNILElB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RUFBRSxFQUFFO2dCQUMxQixXQUFXLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUN2QixPQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsd0JBQXdCLE9BQU8sSUFBSSxTQUFTLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUMxRixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDaEIsQ0FBQyxDQUFDLENBQUM7WUFDSCxFQUFFLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFO2dCQUNuQixXQUFXLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUN2QixJQUFJLElBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQztvQkFDYixNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxpQ0FBaUMsSUFBSSxJQUFJLE9BQU8sSUFBSSxTQUFTLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUN4RyxDQUFDO3FCQUFNLENBQUM7b0JBQ0osT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUNkLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxpQ0FBaUMsSUFBSSxFQUFFLENBQUMsQ0FBQztnQkFDNUUsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDOztBQXJKTCxzQ0FzSkM7QUFFWSxRQUFBLGFBQWEsR0FBRyxJQUFJLGFBQWEsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB7IENoaWxkUHJvY2VzcywgZm9yaywgRm9ya09wdGlvbnMsIHNwYXduIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XHJcbmltcG9ydCB7IGRpcm5hbWUsIGpvaW4gfSBmcm9tICdwYXRoJztcclxuaW1wb3J0IHsgSVF1aWNrU3Bhd25PcHRpb24gfSBmcm9tICcuLi8uLi9AdHlwZXMvcHJvdGVjdGVkJztcclxuaW1wb3J0IHByb2plY3QgZnJvbSAnLi4vLi4vLi4vcHJvamVjdCc7XHJcbmltcG9ydCB7IEdsb2JhbFBhdGhzIH0gZnJvbSAnLi4vLi4vLi4vLi4vZ2xvYmFsJztcclxuXHJcbi8vIOiOt+WPliBDUFUg5pWw6YeP77yM5pyJ5Yeg5LiqIENQVSDlsLHliJvlu7rlh6DkuKrlrZDov5vnqIvvvIzov5nmoLflsLHlj6/ku6XmnIDlpKfljJbnmoTliKnnlKjmnLrlmajmgKfog71cclxuY29uc3Qgd29ya2VyUGF0aCA9IGpvaW4oX19kaXJuYW1lLCAnLi9zdWItcHJvY2VzcycpO1xyXG5cclxuaW50ZXJmYWNlIENoaWxkUHJvY2Vzc01lc3NhZ2VJbmZvIHtcclxuICAgIHR5cGU6IHN0cmluZztcclxuICAgIGRhdGE6IGFueTtcclxuICAgIGNvZGU/OiBudW1iZXI7XHJcbn1cclxuXHJcbmludGVyZmFjZSBJVGFzayB7XHJcbiAgICBuYW1lOiBzdHJpbmc7IC8vIOS7u+WKoeWQjeensFxyXG4gICAgcGF0aDogc3RyaW5nOyAvLyDmiafooYznmoTohJrmnKxcclxuICAgIGxhenk/OiBib29sZWFuOyAvLyDmmK/lkKbkvb/nlKjml7blho3liJvlu7rov5vnqItcclxuICAgIG9wdGlvbnM/OiBGb3JrT3B0aW9ucztcclxufVxyXG5cclxuY2xhc3MgUHJvY2Vzc1Bvb2wge1xyXG4gICAgcHJpdmF0ZSBwb29sOiBTZXQ8Q2hpbGRQcm9jZXNzPiA9IG5ldyBTZXQoKTtcclxuICAgIC8vIOS4reaWreaehOW7uuS7u+WKoeaXtu+8jOS8muadgOaOieato+WcqOi/kOihjOeahOi/m+eoi++8jOWFtuS7lui/m+eoi+S8mue7p+e7reS/neeVmeetieW+heWQjue7reiwg+eUqFxyXG4gICAgcHJpdmF0ZSBydW5uaW5nUG9vbDogU2V0PENoaWxkUHJvY2Vzcz4gPSBuZXcgU2V0KCk7XHJcblxyXG4gICAgYWRkKGNoaWxkOiBDaGlsZFByb2Nlc3MpIHtcclxuICAgICAgICB0aGlzLnBvb2wuYWRkKGNoaWxkKTtcclxuICAgIH1cclxuXHJcbiAgICBydW5uaW5nKGNoaWxkOiBDaGlsZFByb2Nlc3MpIHtcclxuICAgICAgICB0aGlzLnJ1bm5pbmdQb29sLmFkZChjaGlsZCk7XHJcbiAgICB9XHJcblxyXG4gICAgbm90UnVubmluZyhjaGlsZDogQ2hpbGRQcm9jZXNzKSB7XHJcbiAgICAgICAgdGhpcy5ydW5uaW5nUG9vbC5kZWxldGUoY2hpbGQpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yig6Zmk6L+b56iL77yM5bCG5Lya56e76Zmk5omA5pyJ6L+b56iL5rGg6YeM55qE57Si5byVXHJcbiAgICAgKiBAcGFyYW0gY2hpbGQgXHJcbiAgICAgKi9cclxuICAgIGRlbGV0ZShjaGlsZDogQ2hpbGRQcm9jZXNzKSB7XHJcbiAgICAgICAgdGhpcy5ub3RSdW5uaW5nKGNoaWxkKTtcclxuICAgICAgICB0aGlzLnBvb2wuZGVsZXRlKGNoaWxkKTtcclxuICAgIH1cclxuXHJcbiAgICBraWxsQWxsKCkge1xyXG4gICAgICAgIHRoaXMucG9vbC5mb3JFYWNoKChjaGlsZCkgPT4ge1xyXG4gICAgICAgICAgICBjaGlsZC5raWxsKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5wb29sLmNsZWFyKCk7XHJcbiAgICB9XHJcblxyXG4gICAga2lsbChjaGlsZDogQ2hpbGRQcm9jZXNzKSB7XHJcbiAgICAgICAgY2hpbGQua2lsbCgpO1xyXG4gICAgICAgIHRoaXMubm90UnVubmluZyhjaGlsZCk7XHJcbiAgICAgICAgdGhpcy5kZWxldGUoY2hpbGQpO1xyXG4gICAgfVxyXG5cclxuICAgIGtpbGxSdW5uaW5nKCkge1xyXG4gICAgICAgIHRoaXMucnVubmluZ1Bvb2wuZm9yRWFjaCgoY2hpbGQpID0+IHtcclxuICAgICAgICAgICAgY2hpbGQua2lsbCgpO1xyXG4gICAgICAgICAgICB0aGlzLmRlbGV0ZShjaGlsZCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5ydW5uaW5nUG9vbC5jbGVhcigpO1xyXG4gICAgfVxyXG5cclxuICAgIGtpbGxGcmVlKCkge1xyXG4gICAgICAgIHRoaXMucG9vbC5mb3JFYWNoKChjaGlsZCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5ydW5uaW5nUG9vbC5oYXMoY2hpbGQpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2hpbGQua2lsbCgpO1xyXG4gICAgICAgICAgICB0aGlzLnBvb2wuZGVsZXRlKGNoaWxkKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG5cclxuY29uc3QgcHJvY2Vzc1Bvb2wgPSBuZXcgUHJvY2Vzc1Bvb2woKTtcclxuXHJcbmNsYXNzIFdvcmtlclRhc2sge1xyXG4gICAgcGF0aDogc3RyaW5nO1xyXG4gICAgbGF6eSA9IGZhbHNlO1xyXG4gICAgYnVzeSA9IGZhbHNlO1xyXG4gICAgb3B0aW9ucz86IEZvcmtPcHRpb25zO1xyXG4gICAgX25hbWU6IHN0cmluZztcclxuICAgIF9tZXRob2Q/OiBzdHJpbmc7XHJcblxyXG4gICAgZ2V0IG5hbWUoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX21ldGhvZCB8fCB0aGlzLl9uYW1lO1xyXG4gICAgfVxyXG5cclxuICAgIF9oYXNSZXNvbHZlID0gZmFsc2U7XHJcbiAgICBfaGFzUmVqZWN0ID0gZmFsc2U7XHJcblxyXG4gICAgX3Jlc29sdmU/OiAodmFsdWU/OiBhbnkpID0+IHZvaWQ7XHJcbiAgICBfcmVqZWN0PzogKGVycm9yPzogYW55KSA9PiB2b2lkO1xyXG5cclxuICAgIHNldFJlc29sdmUgPSAocmVzb2x2ZTogKHZhbHVlPzogYW55KSA9PiB2b2lkKSA9PiB7XHJcbiAgICAgICAgdGhpcy5faGFzUmVzb2x2ZSA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuX3Jlc29sdmUgPSByZXNvbHZlO1xyXG4gICAgfTtcclxuICAgIHNldFJlamVjdCA9IChyZWplY3Q6IChlcnJvcj86IGFueSkgPT4gdm9pZCkgPT4ge1xyXG4gICAgICAgIHRoaXMuX2hhc1JlamVjdCA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuX3JlamVjdCA9IHJlamVjdDtcclxuICAgIH07XHJcblxyXG4gICAgcmVhZG9ubHkgcmVzb2x2ZSA9ICh2YWx1ZT86IGFueSkgPT4ge1xyXG4gICAgICAgIGlmICh0aGlzLl9oYXNSZXNvbHZlIHx8ICF0aGlzLl9tZXRob2QgfHwgIXRoaXMuX3Jlc29sdmUpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zb2xlLmRlYnVnKGBleGVjdXRlLXNjcmlwdC1lbmQgd2l0aCAke3RoaXMubmFtZX0gJHtEYXRlLm5vdygpIC0gdGhpcy5zdGFydFRpbWV9bXNgKTtcclxuICAgICAgICB0aGlzLl9oYXNSZXNvbHZlID0gdHJ1ZTtcclxuICAgICAgICBkZWxldGUgdGhpcy5fbWV0aG9kO1xyXG4gICAgICAgIHRoaXMuX3Jlc29sdmUodmFsdWUpO1xyXG4gICAgfTtcclxuICAgIHJlYWRvbmx5IHJlamVjdCA9IChlcnJvcj86IEVycm9yKSA9PiB7XHJcbiAgICAgICAgaWYgKHRoaXMuX2hhc1JlamVjdCB8fCAhdGhpcy5fbWV0aG9kIHx8ICF0aGlzLl9yZWplY3QpIHtcclxuICAgICAgICAgICAgZXJyb3IgJiYgY29uc29sZS5kZWJ1ZyhlcnJvcik7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XHJcbiAgICAgICAgdGhpcy5faGFzUmVqZWN0ID0gdHJ1ZTtcclxuICAgICAgICBkZWxldGUgdGhpcy5fbWV0aG9kO1xyXG4gICAgICAgIHRoaXMuX3JlamVjdChlcnJvcik7XHJcbiAgICB9O1xyXG5cclxuICAgIHN0YXJ0VGltZSA9IERhdGUubm93KCk7XHJcbiAgICBfaGFuZGxlUHJvY2Vzcz86IENoaWxkUHJvY2VzcztcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihwYXJhbXM6IElUYXNrKSB7XHJcbiAgICAgICAgdGhpcy5fbmFtZSA9IHBhcmFtcy5uYW1lO1xyXG4gICAgICAgIHRoaXMucGF0aCA9IHBhcmFtcy5wYXRoO1xyXG4gICAgICAgIHRoaXMubGF6eSA9IHBhcmFtcy5sYXp5IHx8IGZhbHNlO1xyXG4gICAgICAgIHRoaXMub3B0aW9ucyA9IHBhcmFtcy5vcHRpb25zO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyBleGVjdXRlKG1ldGhvZDogc3RyaW5nLCBhcmdzPzogYW55W10pIHtcclxuICAgICAgICBjb25zdCBjaGlsZCA9IGF3YWl0IHRoaXMuZ2V0V29ya2VyUHJvY2VzcygpO1xyXG4gICAgICAgIGlmICghY2hpbGQpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyB3b3JrZXIgJyArIHRoaXMubmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5fbWV0aG9kID0gbWV0aG9kO1xyXG4gICAgICAgICAgICB0aGlzLnNldFJlc29sdmUocmVzb2x2ZSk7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0UmVqZWN0KHJlamVjdCk7XHJcbiAgICAgICAgICAgIHRoaXMuc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcclxuICAgICAgICAgICAgY2hpbGQuc2VuZCh7XHJcbiAgICAgICAgICAgICAgICB0eXBlOiAnZXhlY3V0ZS1zY3JpcHQnLFxyXG4gICAgICAgICAgICAgICAgcGF0aDogdGhpcy5wYXRoLFxyXG4gICAgICAgICAgICAgICAgbWV0aG9kLFxyXG4gICAgICAgICAgICAgICAgYXJncyxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHByb2Nlc3NQb29sLnJ1bm5pbmcoY2hpbGQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYXN5bmMgZ2V0V29ya2VyUHJvY2VzcygpIHtcclxuICAgICAgICBpZiAoIXRoaXMuX2hhbmRsZVByb2Nlc3MpIHtcclxuICAgICAgICAgICAgdGhpcy5faGFuZGxlUHJvY2VzcyA9IGF3YWl0IHRoaXMuY3JlYXRlV29ya2VyUHJvY2VzcygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5faGFuZGxlUHJvY2VzcztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFzeW5jIGNyZWF0ZVdvcmtlclByb2Nlc3MoKSB7XHJcbiAgICAgICAgY29uc3QgY2hpbGQgPSBmb3JrKHdvcmtlclBhdGgsIFtdLCB7XHJcbiAgICAgICAgICAgIGV4ZWNBcmd2OiBXb3JrZXJNYW5hZ2VyLmRlZmF1bHRBcmd2IHx8IFtdLFxyXG4gICAgICAgICAgICBzdGRpbzogWydpcGMnLCAncGlwZScsICdwaXBlJywgJ3BpcGUnXSxcclxuICAgICAgICAgICAgLy8g6L+b56iL6buY6K6k55qEIGN3ZCDkuI3lkIzns7vnu5/kuIrkuI3nqLPlrprvvIzlnKjnvJbor5HohJrmnKzml7blj6/og73pgYfliLDpl67pophcclxuICAgICAgICAgICAgY3dkOiB0aGlzLm9wdGlvbnM/LmN3ZCB8fCBHbG9iYWxQYXRocy53b3Jrc3BhY2UsXHJcbiAgICAgICAgICAgIC8vIOehruS/neWtkOi/m+eoi+iDveWkn+eLrOeri+i/kOihjFxyXG4gICAgICAgICAgICBkZXRhY2hlZDogZmFsc2UsXHJcbiAgICAgICAgICAgIC8vIOehruS/neS/oeWPt+WkhOeQhuato+ehrlxyXG4gICAgICAgICAgICBraWxsU2lnbmFsOiAnU0lHVEVSTScsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY2hpbGQub24oJ21lc3NhZ2UnLCAobTogQ2hpbGRQcm9jZXNzTWVzc2FnZUluZm8pID0+IHtcclxuICAgICAgICAgICAgaWYgKG0gJiYgbS50eXBlID09PSAnZXhlY3V0ZS1zY3JpcHQtZW5kJykge1xyXG4gICAgICAgICAgICAgICAgcHJvY2Vzc1Bvb2wubm90UnVubmluZyhjaGlsZCk7XHJcbiAgICAgICAgICAgICAgICBtLmNvZGUgPT09IDAgPyB0aGlzLnJlc29sdmUobS5kYXRhKSA6IHRoaXMucmVqZWN0KG5ldyBFcnJvcihgZXhlY3V0ZS10YXNrICR7dGhpcy5uYW1lfSBmYWlsZWQgd2l0aCBjb2RlICR7bS5jb2RlfSFgKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBjaGlsZC5vbignZXJyb3InLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMucmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBjaGlsZC5vbignZXhpdCcsIChjb2RlLCBzaWduYWwpID0+IHtcclxuICAgICAgICAgICAgaWYgKGNvZGUgIT09IDAgJiYgc2lnbmFsICE9PSAnU0lHVEVSTScpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVqZWN0KG5ldyBFcnJvcihgRXhpdCBwcm9jZXNzIHdpdGggY29kZToke2NvZGV9LCBzaWduYWw6JHtzaWduYWx9IGluIHRhc2sgJHt0aGlzLm5hbWV9YCkpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZXNvbHZlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5jbG9zZSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNoaWxkLnN0ZG91dD8ub24oJ2RhdGEnLCAoZGF0YTogQnVmZmVyKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0aGlzLm5hbWV9XWAgKyBkYXRhLnRvU3RyaW5nKCkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNoaWxkLnN0ZGVycj8ub24oJ2RhdGEnLCAoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBpbmZvOiBzdHJpbmcgPSBkYXRhLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgICAgIC8vIOiwg+ivleaooeW8j+S4i+W8gOWQr+i/m+eoi+m7mOiupOS8muWcqCBzdGRlcnIg6YeM6L6T5Ye65LiA5q616LCD6K+V5L+h5oGv77yM6L+Z5q615L+h5oGv5Zyo5LiN5ZCM55qE6K6+5aSH5LiK5pyJ55qE5pi+56S65aSa6KGM5pyJ55qE5pi+56S65Y2V6KGM5paH5a2X77yM5Zug6ICM6ZyA6KaB5YGa5aSa5qyh6L+H5rukXHJcbiAgICAgICAgICAgIGlmICghaW5mbyB8fCBpbmZvLmluY2x1ZGVzKCdEZWJ1Z2dlcicpIHx8IGluZm8uaW5jbHVkZXMoJ0ZvciBoZWxwLCBzZWUnKSB8fCBpbmZvLmluY2x1ZGVzKCdTdGFydGluZyBpbnNwZWN0b3Igb24nKSkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhpbmZvKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyDlrZDov5vnqIvorablkYrovpPlh7ogSEFDSyAyLzJcclxuICAgICAgICAgICAgaWYgKGluZm8uaW5jbHVkZXMoJ1t3YXJuaW5nXScpKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYFske3RoaXMubmFtZX1dYCArIGluZm8ucmVwbGFjZSgnW3dhcm5pbmddJywgJycpKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0aGlzLm5hbWV9XWAgKyBpbmZvKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBwcm9jZXNzUG9vbC5hZGQoY2hpbGQpO1xyXG4gICAgICAgIHJldHVybiBjaGlsZDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY2xvc2UoKSB7XHJcbiAgICAgICAgdGhpcy5idXN5ID0gZmFsc2U7XHJcbiAgICAgICAgZGVsZXRlIHRoaXMuX21ldGhvZDtcclxuICAgICAgICBpZiAodGhpcy5faGFuZGxlUHJvY2Vzcykge1xyXG4gICAgICAgICAgICBwcm9jZXNzUG9vbC5raWxsKHRoaXMuX2hhbmRsZVByb2Nlc3MpO1xyXG4gICAgICAgICAgICBkZWxldGUgdGhpcy5faGFuZGxlUHJvY2VzcztcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDku7vliqHov5vnqIvnrqHnkIblmahcclxuICovXHJcbmV4cG9ydCBjbGFzcyBXb3JrZXJNYW5hZ2VyIHtcclxuICAgIC8vIOS7u+WKoemYn+WIl1xyXG4gICAgcHJpdmF0ZSB0YXNrTWFwOiBSZWNvcmQ8c3RyaW5nLCBXb3JrZXJUYXNrPiA9IHt9O1xyXG4gICAgcHJpdmF0ZSBfY2xlYXJGcmVlQ2hpbGRUaW1lcj86IE5vZGVKUy5UaW1lb3V0O1xyXG4gICAgc3RhdGljIGRlZmF1bHRBcmd2OiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuICAgIHN0YXRpYyB0b2dnbGVEZWJ1ZygpIHtcclxuICAgICAgICBpZiAoV29ya2VyTWFuYWdlci5kZWZhdWx0QXJndi5pbmNsdWRlcygnLS1pbnNwZWN0JykpIHtcclxuICAgICAgICAgICAgV29ya2VyTWFuYWdlci5kZWZhdWx0QXJndiA9IFdvcmtlck1hbmFnZXIuZGVmYXVsdEFyZ3YuZmlsdGVyKChhcmcpID0+IGFyZyAhPT0gJy0taW5zcGVjdCcpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIFdvcmtlck1hbmFnZXIuZGVmYXVsdEFyZ3YucHVzaCgnLS1pbnNwZWN0Jyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0cnVjdG9yKHRhc2tzPzogSVRhc2tbXSkge1xyXG4gICAgICAgIHRhc2tzICYmIHRhc2tzLmZvckVhY2goKHRhc2spID0+IHRoaXMucmVnaXN0ZXJUYXNrKHRhc2spKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOazqOWGjOS4gOS4qumcgOimgeW8gOWQr+WtkOi/m+eoi+eLrOeri+i/kOihjOeahOS7u+WKoeS/oeaBr++8jOazqOWGjOWQjuS8muW8gOWQr+WtkOi/m+eoi++8jOetieW+heaJp+ihjO+8jOaciemHjeWkjeeahOS7u+WKoeS8muWkjeeUqOi/m+eoi1xyXG4gICAgICogQHBhcmFtIHRhc2tcclxuICAgICAqIEByZXR1cm5zXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBhc3luYyByZWdpc3RlclRhc2sodGFzazogSVRhc2spIHtcclxuICAgICAgICBpZiAodGhpcy50YXNrTWFwW3Rhc2submFtZV0pIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnRhc2tNYXBbdGFzay5uYW1lXSA9IG5ldyBXb3JrZXJUYXNrKHRhc2spO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyBydW5UYXNrKG5hbWU6IHN0cmluZywgbWV0aG9kOiBzdHJpbmcsIGFyZ3M/OiBhbnlbXSkge1xyXG4gICAgICAgIHRoaXMucmVzZXRDbGVhclRpbWVyKCk7XHJcbiAgICAgICAgY29uc3QgdGFzayA9IHRoaXMudGFza01hcFtuYW1lXTtcclxuICAgICAgICBpZiAoIXRhc2spIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyB3b3JrZXIgJyArIG5hbWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYXdhaXQgdGFzay5leGVjdXRlKG1ldGhvZCwgYXJncyk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlgZzmraLmn5DkuKrov5vnqItcclxuICAgICAqIEBwYXJhbSBuYW1lXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBraWxsKG5hbWU6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IHRhc2sgPSB0aGlzLnRhc2tNYXBbbmFtZV07XHJcbiAgICAgICAgaWYgKCF0YXNrKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGFzay5jbG9zZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Lit5pat5omA5pyJ5q2j5Zyo5omn6KGM55qE6L+b56iL5Lu75Yqh77yM5ZKM55u05o6lIGtpbGwg5pyJ5beu5byCXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBraWxsUnVubmluZ0NoaWxkcyA9IHByb2Nlc3NQb29sLmtpbGxSdW5uaW5nLmJpbmQocHJvY2Vzc1Bvb2wpO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5riF55CG5Zyo56m66Zey54q25oCB55qE6L+b56iLXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBraWxsRnJlZUNoaWxkcyA9IHByb2Nlc3NQb29sLmtpbGxGcmVlLmJpbmQocHJvY2Vzc1Bvb2wpO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog6YeN572u5riF55CG6L+b56iL5rGg55qE5a6a5pe25ZmoLCAyMCDliIbpkp/kuYvlhoXmsqHmnInlpJrkvZnmk43kvZzvvIzlsLHmuIXnkIbnqbrpl7LlrZDov5vnqItcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSByZXNldENsZWFyVGltZXIoKSB7XHJcbiAgICAgICAgdGhpcy5fY2xlYXJGcmVlQ2hpbGRUaW1lciAmJiBjbGVhclRpbWVvdXQodGhpcy5fY2xlYXJGcmVlQ2hpbGRUaW1lcik7XHJcbiAgICAgICAgdGhpcy5fY2xlYXJGcmVlQ2hpbGRUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmtpbGxGcmVlQ2hpbGRzKCk7XHJcbiAgICAgICAgfSwgMjAgKiAxMDAwICogNjApO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5b+r6YCf5byA5ZCv5a2Q6L+b56iLXHJcbiAgICAgKiBAcGFyYW0gY29tbWFuZFxyXG4gICAgICogQHBhcmFtIGNtZFBhcmFtc1xyXG4gICAgICogQHBhcmFtIG9wdGlvbnNcclxuICAgICAqIEByZXR1cm5zXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBxdWlja1NwYXduKGNvbW1hbmQ6IHN0cmluZywgY21kUGFyYW1zOiBzdHJpbmdbXSwgb3B0aW9uczogSVF1aWNrU3Bhd25PcHRpb24gPSB7XHJcbiAgICAgICAgZG93bkdyYWRlTG9nOiB0cnVlLFxyXG4gICAgICAgIHByZWZpeDogJycsXHJcbiAgICB9KTogUHJvbWlzZTxudW1iZXIgfCBib29sZWFuPiB7XHJcbiAgICAgICAgaWYgKGNvbW1hbmQgPT09ICducG0nKSB7XHJcbiAgICAgICAgICAgIGNvbW1hbmQgPSBwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInID8gJ25wbS5jbWQnIDogJ25wbSc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG9wdGlvbnMucHJlZml4ID0gb3B0aW9ucy5wcmVmaXggfHwgJyc7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbHMgPSBzcGF3bihjb21tYW5kLCBjbWRQYXJhbXMsIHtcclxuICAgICAgICAgICAgICAgIGN3ZDogb3B0aW9ucz8uY3dkIHx8IHVuZGVmaW5lZCxcclxuICAgICAgICAgICAgICAgIGVudjogb3B0aW9ucz8uZW52LFxyXG4gICAgICAgICAgICAgICAgc2hlbGw6ICEhb3B0aW9ucz8uc2hlbGwsXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBwcm9jZXNzUG9vbC5hZGQobHMpO1xyXG4gICAgICAgICAgICBwcm9jZXNzUG9vbC5ydW5uaW5nKGxzKTtcclxuICAgICAgICAgICAgaWYgKCFvcHRpb25zLmlnbm9yZUxvZykge1xyXG4gICAgICAgICAgICAgICAgbHMuc3Rkb3V0Lm9uKCdkYXRhJywgKGRhdGEpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBkYXRhID0gZGF0YS50b1N0cmluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zPy5kb3duR3JhZGVMb2cpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhvcHRpb25zLnByZWZpeCArIGRhdGEudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2cob3B0aW9ucy5wcmVmaXggKyBkYXRhLnRvU3RyaW5nKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBscy5zdGRlcnIub24oJ2RhdGEnLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBlcnJvciA9IGVyci50b1N0cmluZygpO1xyXG4gICAgICAgICAgICAgICAgLy8g6L+H5ruk5o6J56m65oiW5Y+q5pyJ5o2i6KGM55qE5oql6ZSZ77yM5Lul5Y+KIG5hdGl2ZS1wYWNrLXRvb2wg5rKh5pyJ6K6+572u56eB5pyJ5LuT5bqT55qE6K2m5ZGK77yI5bCx5LiN5Y67IGVuZ2luZSDkv67mlLnkuobvvIlcclxuICAgICAgICAgICAgICAgIGlmICghZXJyb3IgfHwgZXJyb3IgPT09ICdcXG4nIHx8IC9eKD89LipuYXRpdmUtcGFjay10b29sKSg/PS4qTm8gcmVwb3NpdG9yeSBmaWVsZCkvZ2kudGVzdChlcnJvcikpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gb3B0aW9ucy5wcmVmaXggKyBlcnJvcjtcclxuICAgICAgICAgICAgICAgIGxldCB0eXBlID0gJ2Vycm9yJztcclxuICAgICAgICAgICAgICAgIGlmICgvd2Fybi9naS50ZXN0KGRhdGEpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICd3YXJuJztcclxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucz8uZG93bkdyYWRlV2FyaW5nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSAnbG9nJztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnM/LmRvd25HcmFkZUVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICdsb2cnO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgICAgY29uc29sZVt0eXBlXShkYXRhKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBscy5vbignY2xvc2UnLCAoY29kZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcHJvY2Vzc1Bvb2wuZGVsZXRlKGxzKTtcclxuICAgICAgICAgICAgICAgIGlmIChjb2RlICE9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG9wdGlvbnMucHJlZml4ICsgYENoaWxkIHByb2Nlc3MgZXhpdCB3aWR0aCBjb2RlICR7Y29kZX06JHtjb21tYW5kfSAke2NtZFBhcmFtcy50b1N0cmluZygpfWApO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcob3B0aW9ucy5wcmVmaXggKyBgQ2hpbGQgcHJvY2VzcyBleGl0IHdpZHRoIGNvZGUgJHtjb2RlfWApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgbHMub24oJ2Vycm9yJywgKGVycjogRXJyb3IpID0+IHtcclxuICAgICAgICAgICAgICAgIHByb2Nlc3NQb29sLmRlbGV0ZShscyk7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKG9wdGlvbnMucHJlZml4ICsgYGNoaWxkIHByb2Nlc3MgZXJyb3I6ICR7Y29tbWFuZH0gJHtjbWRQYXJhbXMudG9TdHJpbmcoKX1gKTtcclxuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgbHMub24oJ2V4aXQnLCAoY29kZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcHJvY2Vzc1Bvb2wuZGVsZXRlKGxzKTtcclxuICAgICAgICAgICAgICAgIGlmIChjb2RlICE9PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG9wdGlvbnMucHJlZml4ICsgYENoaWxkIHByb2Nlc3MgZXhpdCB3aWR0aCBjb2RlICR7Y29kZX06JHtjb21tYW5kfSAke2NtZFBhcmFtcy50b1N0cmluZygpfWApO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcob3B0aW9ucy5wcmVmaXggKyBgQ2hpbGQgcHJvY2VzcyBleGl0IHdpZHRoIGNvZGUgJHtjb2RlfWApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IHdvcmtlck1hbmFnZXIgPSBuZXcgV29ya2VyTWFuYWdlcigpO1xyXG4iXX0=