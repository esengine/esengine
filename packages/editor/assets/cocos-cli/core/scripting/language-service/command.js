"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.RenameCommand = exports.Command = exports.CommandType = void 0;
const path_1 = require("path");
const asserts_1 = require("../utils/asserts");
const path_2 = require("../utils/path");
const utils_1 = __importDefault(require("../../base/utils"));
var CommandType;
(function (CommandType) {
    CommandType[CommandType["rename"] = 0] = "rename";
})(CommandType || (exports.CommandType = CommandType = {}));
class Command {
}
exports.Command = Command;
class RenameCommand extends Command {
    oldFilePath;
    newFilePath;
    _newFileDBInfo;
    _oldFileDBInfo;
    /** 新的文件/文件夹在 db的 url */
    _newFileDBURL;
    /** 旧的文件/文件夹在 db的 url */
    _oldFileDBURL;
    /** 仅在移动的内容为文件的时候有效 */
    oldFilePathWithOutExt;
    /** 仅在移动的内容为文件的时候有效 */
    newFilePathWithOutExt;
    static _createDescription(oldFilePath, newFilePath) { return `Rename ${(0, path_2.resolveFileName)(oldFilePath)} to ${(0, path_2.resolveFileName)(newFilePath)}.`; }
    static _createID(oldFilePath, newFilePath) { return this._createDescription(oldFilePath, newFilePath); }
    _executed = false;
    id;
    description;
    commandType;
    static create(oldFilePath, newFilePath) {
        return new RenameCommand(oldFilePath, newFilePath);
    }
    constructor(oldFilePath, newFilePath) {
        super();
        this.oldFilePath = oldFilePath;
        this.newFilePath = newFilePath;
        this.oldFilePath = (0, path_2.resolveFileName)(oldFilePath);
        this.oldFilePathWithOutExt = (0, path_2.removeTSExt)(this.oldFilePath);
        this.newFilePath = (0, path_2.resolveFileName)(newFilePath);
        this.newFilePathWithOutExt = (0, path_2.removeTSExt)(this.newFilePath);
        this.id = RenameCommand._createID(oldFilePath, newFilePath);
        this.description = RenameCommand._createDescription(oldFilePath, newFilePath);
        this.commandType = CommandType.rename;
    }
    /**
      *
      * @param dbUrlInfos
      * @param filePath 修改文件后的资源的路径
      * @param text 修改文件的原始内容
      * @param changes 文件需要做得变动
      * @returns
      */
    applyImportChanges(dbUrlInfos, filePath, text, changes) {
        (0, asserts_1.asserts)(this._newFileDBInfo);
        (0, asserts_1.asserts)(this._newFileDBURL);
        (0, asserts_1.asserts)(this._oldFileDBInfo);
        (0, asserts_1.asserts)(this._newFileDBInfo);
        const filePathWithOutExt = (0, path_2.removeTSExt)(filePath);
        /** 当前修改的脚本是否为命令里的目标脚本 */
        const isTargetFile = filePath === this.newFilePath;
        /** 脚本的目标位置是否与目标目录 */
        const isFileSameDB = utils_1.default.Path.contains(this._newFileDBInfo.target, filePath);
        /** 是否需要额外地处理导入路径 */
        const needToUpdateImportPath = isTargetFile || !isFileSameDB;
        for (let i = changes.length - 1; i >= 0; i--) {
            const { span, newText } = changes[i];
            let _nextText = newText;
            // 原本写了 db://
            const newImportPath = (0, path_1.join)(filePath, '../', _nextText);
            if (needToUpdateImportPath) {
                if (text.substring(span.start, span.start + 5) === path_2.dbURLRoot && !isFileSameDB) {
                    if (!newText.startsWith(path_2.dbURLRoot)) {
                        if (dbUrlInfos) {
                            for (let index = 0; index < dbUrlInfos.length; index++) {
                                const info = dbUrlInfos[index];
                                if (utils_1.default.Path.contains(info.target, newImportPath)) {
                                    const relativePath = utils_1.default.Path.relative(info.target, newImportPath);
                                    _nextText = info.dbURL + (0, path_2.resolveFileName)(relativePath);
                                    break;
                                }
                            }
                        }
                    }
                }
                else {
                    // 文件放别的 db 了，将引用脚本的 import 更新为 db 协议的写法
                    let oldFilePath;
                    if (filePath === this.newFilePath) {
                        oldFilePath = this.oldFilePathWithOutExt;
                    }
                    else {
                        oldFilePath = filePathWithOutExt;
                    }
                    const oldImportPath = (0, path_2.resolveFileName)((0, path_1.join)(oldFilePath, '../', text.substring(span.start, this.textSpanEnd(span))));
                    if (oldImportPath === this.oldFilePathWithOutExt) {
                        // 这个脚本引用了旧的文件
                        _nextText = this._newFileDBURL;
                    }
                    else if (utils_1.default.Path.contains(this.oldFilePath + '/', oldImportPath)) {
                        // 这个脚本引用了旧的目录里的文件
                        _nextText = oldImportPath.replace(this.oldFilePath, this._newFileDBURL);
                    }
                    else if (oldFilePath === this.oldFilePathWithOutExt) {
                        // 旧的脚本要更新引用路径了，这个时候所有相对路径全部要换成 db 协议
                        const relativePath = utils_1.default.Path.relative(this._oldFileDBInfo.target, oldImportPath);
                        _nextText = this._oldFileDBInfo.dbURL + (0, path_2.resolveFileName)(relativePath);
                    }
                }
            }
            text = `${text.substring(0, span.start)}${_nextText}${text.substring(this.textSpanEnd(span))}`;
        }
        return text;
    }
    textSpanEnd(span) {
        return span.start + span.length;
    }
    async execute(languageServiceAdapter) {
        for (let index = 0; index < languageServiceAdapter.dbURLInfos.length; index++) {
            const info = languageServiceAdapter.dbURLInfos[index];
            if (utils_1.default.Path.contains(info.target, this.newFilePath)) {
                this._newFileDBInfo = info;
                const relativePath = utils_1.default.Path.relative(info.target, this.newFilePath);
                this._newFileDBURL = info.dbURL + (0, path_2.removeTSExt)((0, path_2.resolveFileName)(relativePath));
            }
            if (utils_1.default.Path.contains(info.target, this.oldFilePath)) {
                this._oldFileDBInfo = info;
                const relativePath = utils_1.default.Path.relative(info.target, this.oldFilePath);
                this._oldFileDBURL = info.dbURL + (0, path_2.removeTSExt)((0, path_2.resolveFileName)(relativePath));
            }
        }
        const filePathSet = new Set();
        if (!this._executed) {
            const changes = languageServiceAdapter.languageService.getEditsForFileRename(this.oldFilePath, this.newFilePath, {}, undefined);
            for (let index = 0; index < changes.length; index++) {
                const change = changes[index];
                const content = languageServiceAdapter.host.readFile(change.fileName);
                if (!content) {
                    continue;
                }
                const newContent = this.applyImportChanges(languageServiceAdapter.dbURLInfos, change.fileName, content, change.textChanges);
                filePathSet.add(change.fileName);
                const info = languageServiceAdapter.host.readCache(change.fileName);
                (0, asserts_1.asserts)(info);
                languageServiceAdapter.host.writeCache({ uuid: info.uuid, filePath: change.fileName, content: newContent });
            }
            this._executed = true;
        }
        return filePathSet;
    }
}
exports.RenameCommand = RenameCommand;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb3JlL3NjcmlwdGluZy9sYW5ndWFnZS1zZXJ2aWNlL2NvbW1hbmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsK0JBQTRCO0FBSTVCLDhDQUEyQztBQUMzQyx3Q0FBd0U7QUFDeEUsNkRBQXFDO0FBRXJDLElBQVksV0FFWDtBQUZELFdBQVksV0FBVztJQUNuQixpREFBVSxDQUFBO0FBQ2QsQ0FBQyxFQUZXLFdBQVcsMkJBQVgsV0FBVyxRQUV0QjtBQUVELE1BQXNCLE9BQU87Q0FLNUI7QUFMRCwwQkFLQztBQVFELE1BQWEsYUFBYyxTQUFRLE9BQU87SUFxQlA7SUFBMEM7SUFwQmpFLGNBQWMsQ0FBc0I7SUFDcEMsY0FBYyxDQUFzQjtJQUM1Qyx3QkFBd0I7SUFDaEIsYUFBYSxDQUFvQjtJQUN6Qyx3QkFBd0I7SUFDaEIsYUFBYSxDQUFxQjtJQUMxQyxzQkFBc0I7SUFDYixxQkFBcUIsQ0FBUztJQUN2QyxzQkFBc0I7SUFDYixxQkFBcUIsQ0FBUztJQUMvQixNQUFNLENBQUMsa0JBQWtCLENBQUMsV0FBcUIsRUFBRSxXQUFxQixJQUFHLE9BQU8sVUFBVSxJQUFBLHNCQUFlLEVBQUMsV0FBVyxDQUFDLE9BQU8sSUFBQSxzQkFBZSxFQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQSxDQUFDO0lBQzlKLE1BQU0sQ0FBQyxTQUFTLENBQUMsV0FBcUIsRUFBRSxXQUFxQixJQUFHLE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFBLENBQUM7SUFDMUgsU0FBUyxHQUFHLEtBQUssQ0FBQztJQUNqQixFQUFFLENBQVM7SUFDWCxXQUFXLENBQVM7SUFDcEIsV0FBVyxDQUFjO0lBRWxDLE1BQU0sQ0FBQyxNQUFNLENBQUMsV0FBcUIsRUFBRSxXQUFxQjtRQUN0RCxPQUFPLElBQUksYUFBYSxDQUFD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QixNQUFNLE9BQU8sR0FBRyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDdEUsSUFBSSxDQUFDLE9BQU8sRUFBQyxDQUFDO29CQUNWLFNBQVM7Z0JBQ2IsQ0FBQztnQkFDRCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsc0JBQXNCLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFFNUgsV0FBVyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ2pDLE1BQU0sSUFBSSxHQUFHLHNCQUFzQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUNwRSxJQUFBLGlCQUFPLEVBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2Qsc0JBQXNCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxNQUFNLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUMsQ0FBQyxDQUFDO1lBQzlHLENBQUM7WUFFRCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztRQUMxQixDQUFDO1FBQ0QsT0FBTyxXQUFXLENBQUM7SUFDdkIsQ0FBQztDQUVKO0FBL0lELHNDQStJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcclxuaW1wb3J0IHRzLCB7IFRleHRDaGFuZ2UgfSBmcm9tICd0eXBlc2NyaXB0JztcclxuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlQWRhcHRlciB9IGZyb20gJy4nO1xyXG5pbXBvcnQgeyBEYlVSTEluZm8gfSBmcm9tICcuLi9pbnRlbGxpZ2VuY2UnO1xyXG5pbXBvcnQgeyBhc3NlcnRzIH0gZnJvbSAnLi4vdXRpbHMvYXNzZXJ0cyc7XHJcbmltcG9ydCB7IGRiVVJMUm9vdCwgcmVtb3ZlVFNFeHQsIHJlc29sdmVGaWxlTmFtZSB9IGZyb20gJy4uL3V0aWxzL3BhdGgnO1xyXG5pbXBvcnQgdXRpbHMgZnJvbSAnLi4vLi4vYmFzZS91dGlscyc7XHJcblxyXG5leHBvcnQgZW51bSBDb21tYW5kVHlwZXtcclxuICAgIHJlbmFtZSA9IDAsXHJcbn1cclxuXHJcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBDb21tYW5kIHtcclxuICAgIGFic3RyYWN0IGlkOiBzdHJpbmdcclxuICAgIGFic3RyYWN0IGRlc2NyaXB0aW9uOiBzdHJpbmdcclxuICAgIGFic3RyYWN0IGNvbW1hbmRUeXBlOiBDb21tYW5kVHlwZVxyXG4gICAgYWJzdHJhY3QgZXhlY3V0ZShsYW5ndWFnZVNlcnZpY2VBZGFwdGVyOiBMYW5ndWFnZVNlcnZpY2VBZGFwdGVyKTogUHJvbWlzZTxTZXQ8RmlsZVBhdGg+PjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBBd2FpdENvbW1hbmQge1xyXG4gICAgLyoqIOiwg+eUqOi/meS4quaWueazleWwhuino+mZpOWRveS7pOeahOetieW+hSAqL1xyXG4gICAgcmVzb2x2ZUF3YWl0OiAoYW55OiBhbnkpID0+IHZvaWQ7XHJcbiAgICBjb21tYW5kOiBDb21tYW5kLFxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgUmVuYW1lQ29tbWFuZCBleHRlbmRzIENvbW1hbmQge1xyXG4gICAgcHJpdmF0ZSBfbmV3RmlsZURCSW5mbzogRGJVUkxJbmZvfHVuZGVmaW5lZDtcclxuICAgIHByaXZhdGUgX29sZEZpbGVEQkluZm86IERiVVJMSW5mb3x1bmRlZmluZWQ7XHJcbiAgICAvKiog5paw55qE5paH5Lu2L+aWh+S7tuWkueWcqCBkYueahCB1cmwgKi9cclxuICAgIHByaXZhdGUgX25ld0ZpbGVEQlVSTDogc3RyaW5nIHx1bmRlZmluZWQ7XHJcbiAgICAvKiog5pen55qE5paH5Lu2L+aWh+S7tuWkueWcqCBkYueahCB1cmwgKi9cclxuICAgIHByaXZhdGUgX29sZEZpbGVEQlVSTDogc3RyaW5nIHwgdW5kZWZpbmVkO1xyXG4gICAgLyoqIOS7heWcqOenu+WKqOeahOWGheWuueS4uuaWh+S7tueahOaXtuWAmeacieaViCAqL1xyXG4gICAgcmVhZG9ubHkgb2xkRmlsZVBhdGhXaXRoT3V0RXh0OiBzdHJpbmc7XHJcbiAgICAvKiog5LuF5Zyo56e75Yqo55qE5YaF5a655Li65paH5Lu255qE5pe25YCZ5pyJ5pWIICovXHJcbiAgICByZWFkb25seSBuZXdGaWxlUGF0aFdpdGhPdXRFeHQ6IHN0cmluZztcclxuICAgIHByaXZhdGUgc3RhdGljIF9jcmVhdGVEZXNjcmlwdGlvbihvbGRGaWxlUGF0aDogRmlsZVBhdGgsIG5ld0ZpbGVQYXRoOiBGaWxlUGF0aCl7IHJldHVybiBgUmVuYW1lICR7cmVzb2x2ZUZpbGVOYW1lKG9sZEZpbGVQYXRoKX0gdG8gJHtyZXNvbHZlRmlsZU5hbWUobmV3RmlsZVBhdGgpfS5gO31cclxuICAgIHByaXZhdGUgc3RhdGljIF9jcmVhdGVJRChvbGRGaWxlUGF0aDogRmlsZVBhdGgsIG5ld0ZpbGVQYXRoOiBGaWxlUGF0aCl7IHJldHVybiB0aGlzLl9jcmVhdGVEZXNjcmlwdGlvbihvbGRGaWxlUGF0aCwgbmV3RmlsZVBhdGgpO31cclxuICAgIHByaXZhdGUgX2V4ZWN1dGVkID0gZmFsc2U7XHJcbiAgICByZWFkb25seSBpZDogc3RyaW5nO1xyXG4gICAgcmVhZG9ubHkgZGVzY3JpcHRpb246IHN0cmluZztcclxuICAgIHJlYWRvbmx5IGNvbW1hbmRUeXBlOiBDb21tYW5kVHlwZTtcclxuXHJcbiAgICBzdGF0aWMgY3JlYXRlKG9sZEZpbGVQYXRoOiBGaWxlUGF0aCwgbmV3RmlsZVBhdGg6IEZpbGVQYXRoKTogQ29tbWFuZHtcclxuICAgICAgICByZXR1cm4gbmV3IFJlbmFtZUNvbW1hbmQob2xkRmlsZVBhdGgsIG5ld0ZpbGVQYXRoKTtcclxuICAgIH1cclxuICAgIGNvbnN0cnVjdG9yKHByb3RlY3RlZCByZWFkb25seSBvbGRGaWxlUGF0aDogRmlsZVBhdGgsIHByb3RlY3RlZCByZWFkb25seSBuZXdGaWxlUGF0aDogRmlsZVBhdGgpe1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgdGhpcy5vbGRGaWxlUGF0aCA9IHJlc29sdmVGaWxlTmFtZShvbGRGaWxlUGF0aCk7XHJcbiAgICAgICAgdGhpcy5vbGRGaWxlUGF0aFdpdGhPdXRFeHQgPSByZW1vdmVUU0V4dCh0aGlzLm9sZEZpbGVQYXRoKTtcclxuICAgICAgICB0aGlzLm5ld0ZpbGVQYXRoID0gcmVzb2x2ZUZpbGVOYW1lKG5ld0ZpbGVQYXRoKTtcclxuICAgICAgICB0aGlzLm5ld0ZpbGVQYXRoV2l0aE91dEV4dCA9IHJlbW92ZVRTRXh0KHRoaXMubmV3RmlsZVBhdGgpO1xyXG4gICAgICAgIHRoaXMuaWQgPSBSZW5hbWVDb21tYW5kLl9jcmVhdGVJRChvbGRGaWxlUGF0aCwgbmV3RmlsZVBhdGgpO1xyXG4gICAgICAgIHRoaXMuZGVzY3JpcHRpb24gPSBSZW5hbWVDb21tYW5kLl9jcmVhdGVEZXNjcmlwdGlvbihvbGRGaWxlUGF0aCwgbmV3RmlsZVBhdGgpO1xyXG4gICAgICAgIHRoaXMuY29tbWFuZFR5cGUgPSBDb21tYW5kVHlwZS5yZW5hbWU7XHJcbiAgICAgICAgIFxyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgICogXHJcbiAgICAgICogQHBhcmFtIGRiVXJsSW5mb3MgXHJcbiAgICAgICogQHBhcmFtIGZpbGVQYXRoIOS/ruaUueaWh+S7tuWQjueahOi1hOa6kOeahOi3r+W+hFxyXG4gICAgICAqIEBwYXJhbSB0ZXh0IOS/ruaUueaWh+S7tueahOWOn+Wni+WGheWuuVxyXG4gICAgICAqIEBwYXJhbSBjaGFuZ2VzIOaWh+S7tumcgOimgeWBmuW+l+WPmOWKqFxyXG4gICAgICAqIEByZXR1cm5zIFxyXG4gICAgICAqL1xyXG4gICAgcHJvdGVjdGVkIGFwcGx5SW1wb3J0Q2hhbmdlcyhkYlVybEluZm9zOiByZWFkb25seSBEYlVSTEluZm9bXSwgZmlsZVBhdGg6IHN0cmluZywgdGV4dDogc3RyaW5nLCBjaGFuZ2VzOiByZWFkb25seSBUZXh0Q2hhbmdlW10pOiBzdHJpbmd7XHJcbiAgICAgICAgYXNzZXJ0cyh0aGlzLl9uZXdGaWxlREJJbmZvKTtcclxuICAgICAgICBhc3NlcnRzKHRoaXMuX25ld0ZpbGVEQlVSTCk7XHJcbiAgICAgICAgYXNzZXJ0cyh0aGlzLl9vbGRGaWxlREJJbmZvKTtcclxuICAgICAgICBhc3NlcnRzKHRoaXMuX25ld0ZpbGVEQkluZm8pO1xyXG4gICAgICAgIGNvbnN0IGZpbGVQYXRoV2l0aE91dEV4dCA9IHJlbW92ZVRTRXh0KGZpbGVQYXRoKTtcclxuICAgICAgICAvKiog5b2T5YmN5L+u5pS555qE6ISa5pys5piv5ZCm5Li65ZG95Luk6YeM55qE55uu5qCH6ISa5pysICovXHJcbiAgICAgICAgY29uc3QgaXNUYXJnZXRGaWxlID0gZmlsZVBhdGggPT09IHRoaXMubmV3RmlsZVBhdGg7XHJcbiAgICAgICAgLyoqIOiEmuacrOeahOebruagh+S9jee9ruaYr+WQpuS4juebruagh+ebruW9lSAqL1xyXG4gICAgICAgIGNvbnN0IGlzRmlsZVNhbWVEQiA9IHV0aWxzLlBhdGguY29udGFpbnModGhpcy5fbmV3RmlsZURCSW5mby50YXJnZXQsIGZpbGVQYXRoKTsgIFxyXG4gICAgICAgIC8qKiDmmK/lkKbpnIDopoHpop3lpJblnLDlpITnkIblr7zlhaXot6/lvoQgKi9cclxuICAgICAgICBjb25zdCBuZWVkVG9VcGRhdGVJbXBvcnRQYXRoID0gaXNUYXJnZXRGaWxlIHx8ICFpc0ZpbGVTYW1lREI7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IGNoYW5nZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcclxuICAgICAgICAgICAgY29uc3QgeyBzcGFuLCBuZXdUZXh0IH0gPSBjaGFuZ2VzW2ldO1xyXG4gICAgICAgICAgICBsZXQgX25leHRUZXh0ID0gbmV3VGV4dDtcclxuICAgICAgICAgICAgLy8g5Y6f5pys5YaZ5LqGIGRiOi8vXHJcbiAgICAgICAgICAgIGNvbnN0IG5ld0ltcG9ydFBhdGggPSBqb2luKGZpbGVQYXRoLCAnLi4vJywgX25leHRUZXh0KTtcclxuICAgICAgICAgICAgaWYgKG5lZWRUb1VwZGF0ZUltcG9ydFBhdGgpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0ZXh0LnN1YnN0cmluZyhzcGFuLnN0YXJ0LCBzcGFuLnN0YXJ0ICsgNSkgPT09IGRiVVJMUm9vdCAmJiAhaXNGaWxlU2FtZURCKXtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIW5ld1RleHQuc3RhcnRzV2l0aChkYlVSTFJvb3QpKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRiVXJsSW5mb3Mpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGRiVXJsSW5mb3MubGVuZ3RoOyBpbmRleCsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5mbyA9IGRiVXJsSW5mb3NbaW5kZXhdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1dGlscy5QYXRoLmNvbnRhaW5zKGluZm8udGFyZ2V0LCBuZXdJbXBvcnRQYXRoKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlbGF0aXZlUGF0aCA9IHV0aWxzLlBhdGgucmVsYXRpdmUoaW5mby50YXJnZXQsIG5ld0ltcG9ydFBhdGgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfbmV4dFRleHQgPSBpbmZvLmRiVVJMICsgcmVzb2x2ZUZpbGVOYW1lKHJlbGF0aXZlUGF0aCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyDmlofku7bmlL7liKvnmoQgZGIg5LqG77yM5bCG5byV55So6ISa5pys55qEIGltcG9ydCDmm7TmlrDkuLogZGIg5Y2P6K6u55qE5YaZ5rOVXHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IG9sZEZpbGVQYXRoOiBzdHJpbmc7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGVQYXRoID09PSB0aGlzLm5ld0ZpbGVQYXRoKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb2xkRmlsZVBhdGggPSB0aGlzLm9sZEZpbGVQYXRoV2l0aE91dEV4dDtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvbGRGaWxlUGF0aCA9IGZpbGVQYXRoV2l0aE91dEV4dDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2xkSW1wb3J0UGF0aCA9IHJlc29sdmVGaWxlTmFtZShqb2luKG9sZEZpbGVQYXRoLCAnLi4vJywgdGV4dC5zdWJzdHJpbmcoc3Bhbi5zdGFydCwgdGhpcy50ZXh0U3BhbkVuZChzcGFuKSkpKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAob2xkSW1wb3J0UGF0aCA9PT0gdGhpcy5vbGRGaWxlUGF0aFdpdGhPdXRFeHQgKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8g6L+Z5Liq6ISa5pys5byV55So5LqG5pen55qE5paH5Lu2XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9uZXh0VGV4dCA9IHRoaXMuX25ld0ZpbGVEQlVSTDtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHV0aWxzLlBhdGguY29udGFpbnModGhpcy5vbGRGaWxlUGF0aCArICcvJywgb2xkSW1wb3J0UGF0aCkgKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8g6L+Z5Liq6ISa5pys5byV55So5LqG5pen55qE55uu5b2V6YeM55qE5paH5Lu2XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9uZXh0VGV4dCA9IG9sZEltcG9ydFBhdGgucmVwbGFjZSh0aGlzLm9sZEZpbGVQYXRoLCB0aGlzLl9uZXdGaWxlREJVUkwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob2xkRmlsZVBhdGggPT09IHRoaXMub2xkRmlsZVBhdGhXaXRoT3V0RXh0KXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8g5pen55qE6ISa5pys6KaB5pu05paw5byV55So6Lev5b6E5LqG77yM6L+Z5Liq5pe25YCZ5omA5pyJ55u45a+56Lev5b6E5YWo6YOo6KaB5o2i5oiQIGRiIOWNj+iurlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZWxhdGl2ZVBhdGggPSB1dGlscy5QYXRoLnJlbGF0aXZlKHRoaXMuX29sZEZpbGVEQkluZm8udGFyZ2V0LCBvbGRJbXBvcnRQYXRoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgX25leHRUZXh0ID0gdGhpcy5fb2xkRmlsZURCSW5mby5kYlVSTCArIHJlc29sdmVGaWxlTmFtZSggcmVsYXRpdmVQYXRoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRleHQgPSBgJHt0ZXh0LnN1YnN0cmluZygwLCBzcGFuLnN0YXJ0KX0ke19uZXh0VGV4dH0ke3RleHQuc3Vic3RyaW5nKHRoaXMudGV4dFNwYW5FbmQoc3BhbikpfWA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0ZXh0OyBcclxuICAgIH1cclxuICAgIHByb3RlY3RlZCB0ZXh0U3BhbkVuZChzcGFuOiB0cy5UZXh0U3Bhbik6IG51bWJlcntcclxuICAgICAgICByZXR1cm4gc3Bhbi5zdGFydCArIHNwYW4ubGVuZ3RoO1xyXG4gICAgfVxyXG4gICAgYXN5bmMgZXhlY3V0ZShsYW5ndWFnZVNlcnZpY2VBZGFwdGVyOiBMYW5ndWFnZVNlcnZpY2VBZGFwdGVyKTogUHJvbWlzZTxTZXQ8c3RyaW5nPj57XHJcbiAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGxhbmd1YWdlU2VydmljZUFkYXB0ZXIuZGJVUkxJbmZvcy5sZW5ndGg7IGluZGV4KyspIHtcclxuICAgICAgICAgICAgY29uc3QgaW5mbyA9IGxhbmd1YWdlU2VydmljZUFkYXB0ZXIuZGJVUkxJbmZvc1tpbmRleF07XHJcbiAgICAgICAgICAgIGlmICh1dGlscy5QYXRoLmNvbnRhaW5zKGluZm8udGFyZ2V0LCB0aGlzLm5ld0ZpbGVQYXRoKSl7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9uZXdGaWxlREJJbmZvID0gaW5mbztcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlbGF0aXZlUGF0aCA9IHV0aWxzLlBhdGgucmVsYXRpdmUoaW5mby50YXJnZXQsIHRoaXMubmV3RmlsZVBhdGgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fbmV3RmlsZURCVVJMID0gaW5mby5kYlVSTCArIHJlbW92ZVRTRXh0KHJlc29sdmVGaWxlTmFtZSggcmVsYXRpdmVQYXRoKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHV0aWxzLlBhdGguY29udGFpbnMoaW5mby50YXJnZXQsIHRoaXMub2xkRmlsZVBhdGgpICl7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9vbGRGaWxlREJJbmZvID0gaW5mbztcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlbGF0aXZlUGF0aCA9IHV0aWxzLlBhdGgucmVsYXRpdmUoaW5mby50YXJnZXQsIHRoaXMub2xkRmlsZVBhdGgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fb2xkRmlsZURCVVJMID0gaW5mby5kYlVSTCArIHJlbW92ZVRTRXh0KHJlc29sdmVGaWxlTmFtZShyZWxhdGl2ZVBhdGgpKTtcclxuXHJcbiAgICAgICAgICAgIH0gIFxyXG4gICAgICAgIH0gXHJcblxyXG4gICAgICAgIGNvbnN0IGZpbGVQYXRoU2V0ID0gbmV3IFNldDxzdHJpbmc+KCk7XHJcblxyXG4gICAgICAgIGlmICghdGhpcy5fZXhlY3V0ZWQpe1xyXG4gICAgICAgICAgICBjb25zdCBjaGFuZ2VzID0gbGFuZ3VhZ2VTZXJ2aWNlQWRhcHRlci5sYW5ndWFnZVNlcnZpY2UuZ2V0RWRpdHNGb3JGaWxlUmVuYW1lKHRoaXMub2xkRmlsZVBhdGgsIHRoaXMubmV3RmlsZVBhdGgsIHt9LCB1bmRlZmluZWQpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGNoYW5nZXMubGVuZ3RoOyBpbmRleCsrKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjaGFuZ2UgPSBjaGFuZ2VzW2luZGV4XTtcclxuICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBsYW5ndWFnZVNlcnZpY2VBZGFwdGVyLmhvc3QucmVhZEZpbGUoY2hhbmdlLmZpbGVOYW1lKTtcclxuICAgICAgICAgICAgICAgIGlmICghY29udGVudCl7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdDb250ZW50ID0gdGhpcy5hcHBseUltcG9ydENoYW5nZXMobGFuZ3VhZ2VTZXJ2aWNlQWRhcHRlci5kYlVSTEluZm9zLCBjaGFuZ2UuZmlsZU5hbWUsIGNvbnRlbnQsIGNoYW5nZS50ZXh0Q2hhbmdlcyk7XHJcbiAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgZmlsZVBhdGhTZXQuYWRkKGNoYW5nZS5maWxlTmFtZSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0gbGFuZ3VhZ2VTZXJ2aWNlQWRhcHRlci5ob3N0LnJlYWRDYWNoZShjaGFuZ2UuZmlsZU5hbWUpO1xyXG4gICAgICAgICAgICAgICAgYXNzZXJ0cyhpbmZvKTtcclxuICAgICAgICAgICAgICAgIGxhbmd1YWdlU2VydmljZUFkYXB0ZXIuaG9zdC53cml0ZUNhY2hlKHt1dWlkOiBpbmZvLnV1aWQsIGZpbGVQYXRoOiBjaGFuZ2UuZmlsZU5hbWUsIGNvbnRlbnQ6IG5ld0NvbnRlbnR9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgdGhpcy5fZXhlY3V0ZWQgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmlsZVBhdGhTZXQ7XHJcbiAgICB9XHJcblxyXG59XHJcblxyXG4iXX0=