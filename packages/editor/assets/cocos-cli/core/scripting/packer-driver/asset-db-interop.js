"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DBChangeType = exports.AssetDbInterop = void 0;
const url_1 = require("url");
const db_module_url_1 = require("../utils/db-module-url");
const cache_1 = require("../shared/cache");
const path_1 = require("../utils/path");
const path_2 = require("path");
const asset_1 = require("@cocos/asset-db/libs/asset");
class AssetDbInterop {
    _tsScriptInfoCache = cache_1.tsScriptAssetCache;
    removeTsScriptInfoCache(dbTarget) {
        const scriptInfos = [];
        this._tsScriptInfoCache.forEach(item => {
            if ((0, path_2.normalize)(item.filePath).startsWith(dbTarget)) {
                scriptInfos.push(item);
                this._tsScriptInfoCache.delete(item.filePath);
            }
        });
        return scriptInfos;
    }
    async destroyed() {
        this._tsScriptInfoCache.clear();
    }
    async queryAssetDomains(dbInfos) {
        const assetDatabaseDomains = [];
        for (const dbInfo of dbInfos) {
            const dbURL = (0, db_module_url_1.getDatabaseModuleRootURL)(dbInfo.dbID);
            const assetDatabaseDomain = {
                root: new URL(dbURL),
                physical: dbInfo.target,
            };
            if (isPackageDomain(dbInfo.dbID)) {
                assetDatabaseDomain.jail = dbInfo.target;
            }
            assetDatabaseDomains.push(assetDatabaseDomain);
        }
        return assetDatabaseDomains;
    }
    /**
     * 因为时间累计而缓存的资源更改。
     */
    _changeQueue = [];
    /**
     * 当收到资源更改消息后触发。我们会更新资源更改计时器。
     */
    onAssetChange(changeInfo) {
        const filePath = (0, path_1.resolveFileName)(changeInfo.filePath);
        const uuid = changeInfo.uuid;
        const assetChange = {
            url: (0, url_1.pathToFileURL)(filePath),
            importer: changeInfo.importer,
            uuid: uuid,
            filePath: filePath,
            type: changeInfo.type === asset_1.AssetActionEnum.none ? asset_1.AssetActionEnum.change : changeInfo.type,
            isPluginScript: isPluginScript(changeInfo.userData),
        };
        const importer = changeInfo.importer;
        if (!(importer === 'javascript' || importer === 'typescript')) {
            return;
        }
        let info = null;
        if (importer === 'typescript') {
            info = mapperForTypeScriptAssetInfoCache(changeInfo);
        }
        if (!info) {
            this._changeQueue.push(assetChange);
            return;
        }
        if (changeInfo.type === asset_1.AssetActionEnum.change) {
            if (!this._tsScriptInfoCache.has(filePath)) {
                for (const iterator of this._tsScriptInfoCache.values()) {
                    if (iterator.uuid === uuid) {
                        this._tsScriptInfoCache.delete(iterator.filePath);
                        this._tsScriptInfoCache.set(info.filePath, info);
                        assetChange.oldFilePath = iterator.filePath;
                        assetChange.newFilePath = info.filePath;
                        break;
                    }
                }
            }
        }
        if (changeInfo.type === asset_1.AssetActionEnum.add) {
            if (importer === 'typescript') {
                const deletedItemIndex = this._changeQueue.findIndex(item => item.type === asset_1.AssetActionEnum.delete && item.uuid === uuid);
                if (deletedItemIndex !== -1) {
                    assetChange.type = asset_1.AssetActionEnum.change;
                    assetChange.oldFilePath = (0, path_1.resolveFileName)(this._changeQueue[deletedItemIndex].filePath);
                    assetChange.newFilePath = info.filePath;
                    this._changeQueue.splice(deletedItemIndex, 1);
                }
                if (importer === 'typescript') {
                    this._tsScriptInfoCache.set(info.filePath, info);
                }
            }
        }
        if (changeInfo.type === asset_1.AssetActionEnum.delete) {
            this._tsScriptInfoCache.delete(filePath);
        }
        this._changeQueue.push(assetChange);
    }
    getAssetChangeQueue() {
        return this._changeQueue;
    }
    resetAssetChangeQueue() {
        this._changeQueue = [];
    }
}
exports.AssetDbInterop = AssetDbInterop;
var DBChangeType;
(function (DBChangeType) {
    DBChangeType[DBChangeType["add"] = 0] = "add";
    DBChangeType[DBChangeType["remove"] = 1] = "remove";
})(DBChangeType || (exports.DBChangeType = DBChangeType = {}));
function mapperForTypeScriptAssetInfoCache(changeInfo) {
    const filePath = (0, path_1.resolveFileName)(changeInfo.filePath);
    return {
        uuid: changeInfo.uuid,
        filePath: filePath,
        url: (0, url_1.pathToFileURL)(filePath),
        isPluginScript: isPluginScript(changeInfo.userData),
    };
}
function isPluginScript(userData) {
    if (userData?.isPlugin) {
        return true;
    }
    else {
        return false;
    }
}
function isPackageDomain(databaseID) {
    return !['assets', 'internal'].includes(databaseID);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQtZGItaW50ZXJvcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb3JlL3NjcmlwdGluZy9wYWNrZXItZHJpdmVyL2Fzc2V0LWRiLWludGVyb3AudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBRUEsNkJBQW9DO0FBQ3BDLDBEQUFrRTtBQUNsRSwyQ0FBK0U7QUFDL0Usd0NBQWdEO0FBQ2hELCtCQUFpQztBQUNqQyxzREFBNkQ7QUFRN0QsTUFBYSxjQUFjO0lBRUosa0JBQWtCLEdBQUcsMEJBQWtCLENBQUM7SUFHM0QsdUJBQXVCLENBQUMsUUFBZ0I7UUFDcEMsTUFBTSxXQUFXLEdBQStCLEVBQUUsQ0FBQztRQUNuRCxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ25DLElBQUksSUFBQSxnQkFBUyxFQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztnQkFDaEQsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDdkIsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDbEQsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxXQUFXLENBQUM7SUFDdkIsQ0FBQztJQUdELEtBQUssQ0FBQyxTQUFTO1FBQ1gsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3BDLENBQUM7SUFFTSxLQUFLLENBQUMsaUJBQWlCLENBQUMsT0FBaUI7UUFDNUMsTUFBTSxvQkFBb0IsR0FBMEIsRUFBRSxDQUFDO1FBQ3ZELEtBQUssTUFBTSxNQUFNLElBQUksT0FBTyxFQUFFLENBQUM7WUFDM0IsTUFBTSxLQUFLLEdBQUcsSUFBQSx3Q0FBd0IsRUFBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDcEQsTUFBTSxt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NkNBQUcsQ0FBQTtJQUFFLG1EQUFNLENBQUE7QUFBQyxDQUFDLEVBQTVCLFlBQVksNEJBQVosWUFBWSxRQUFnQjtBQXlCeEMsU0FBUyxpQ0FBaUMsQ0FBQyxVQUEyQjtJQUNsRSxNQUFNLFFBQVEsR0FBRyxJQUFBLHNCQUFlLEVBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3RELE9BQU87UUFDSCxJQUFJLEVBQUUsVUFBVSxDQUFDLElBQUk7UUFDckIsUUFBUSxFQUFFLFFBQVE7UUFDbEIsR0FBRyxFQUFFLElBQUEsbUJBQWEsRUFBQyxRQUFRLENBQUM7UUFDNUIsY0FBYyxFQUFFLGNBQWMsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDO0tBQ3RELENBQUM7QUFDTixDQUFDO0FBRUQsU0FBUyxjQUFjLENBQUMsUUFBYTtJQUNqQyxJQUFJLFFBQVEsRUFBRSxRQUFRLEVBQUUsQ0FBQztRQUNyQixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO1NBQU0sQ0FBQztRQUNKLE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7QUFDTCxDQUFDO0FBb0JELFNBQVMsZUFBZSxDQUFDLFVBQWtCO0lBQ3ZDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDeEQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgQXNzZXRJbmZvLCBJQXNzZXRNZXRhLCBRdWVyeUFzc2V0c09wdGlvbiB9IGZyb20gJy4uLy4uL2Fzc2V0cy9AdHlwZXMvcHVibGljJztcclxuXHJcbmltcG9ydCB7IHBhdGhUb0ZpbGVVUkwgfSBmcm9tICd1cmwnO1xyXG5pbXBvcnQgeyBnZXREYXRhYmFzZU1vZHVsZVJvb3RVUkwgfSBmcm9tICcuLi91dGlscy9kYi1tb2R1bGUtdXJsJztcclxuaW1wb3J0IHsgdHNTY3JpcHRBc3NldENhY2hlLCBUeXBlU2NyaXB0QXNzZXRJbmZvQ2FjaGUgfSBmcm9tICcuLi9zaGFyZWQvY2FjaGUnO1xyXG5pbXBvcnQgeyByZXNvbHZlRmlsZU5hbWUgfSBmcm9tICcuLi91dGlscy9wYXRoJztcclxuaW1wb3J0IHsgbm9ybWFsaXplIH0gZnJvbSAncGF0aCc7XHJcbmltcG9ydCB7IEFzc2V0QWN0aW9uRW51bSB9IGZyb20gJ0Bjb2Nvcy9hc3NldC1kYi9saWJzL2Fzc2V0JztcclxuaW1wb3J0IHsgREJJbmZvIH0gZnJvbSAnLi4vQHR5cGVzL2NvbmZpZy1leHBvcnQnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBRdWVyeUFsbEFzc2V0T3B0aW9uPFQgPSB7IGFzc2V0SW5mbzogQXNzZXRJbmZvIH0+IHtcclxuICAgIGFzc2V0RGJPcHRpb25zPzogUXVlcnlBc3NldHNPcHRpb24sXHJcbiAgICBmaWx0ZXI/OiAoYXNzZXRJbmZvOiBBc3NldEluZm8sIG1ldGE/OiBJQXNzZXRNZXRhKSA9PiBib29sZWFuLFxyXG4gICAgbWFwcGVyPzogKGFzc2V0SW5mbzogQXNzZXRJbmZvLCBtZXRhPzogSUFzc2V0TWV0YSkgPT4gVCxcclxufVxyXG5leHBvcnQgY2xhc3MgQXNzZXREYkludGVyb3Age1xyXG5cclxuICAgIHByb3RlY3RlZCByZWFkb25seSBfdHNTY3JpcHRJbmZvQ2FjaGUgPSB0c1NjcmlwdEFzc2V0Q2FjaGU7XHJcblxyXG5cclxuICAgIHJlbW92ZVRzU2NyaXB0SW5mb0NhY2hlKGRiVGFyZ2V0OiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBzY3JpcHRJbmZvczogVHlwZVNjcmlwdEFzc2V0SW5mb0NhY2hlW10gPSBbXTtcclxuICAgICAgICB0aGlzLl90c1NjcmlwdEluZm9DYWNoZS5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICBpZiAobm9ybWFsaXplKGl0ZW0uZmlsZVBhdGgpLnN0YXJ0c1dpdGgoZGJUYXJnZXQpKSB7XHJcbiAgICAgICAgICAgICAgICBzY3JpcHRJbmZvcy5wdXNoKGl0ZW0pO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fdHNTY3JpcHRJbmZvQ2FjaGUuZGVsZXRlKGl0ZW0uZmlsZVBhdGgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBzY3JpcHRJbmZvcztcclxuICAgIH1cclxuXHJcblxyXG4gICAgYXN5bmMgZGVzdHJveWVkKCkge1xyXG4gICAgICAgIHRoaXMuX3RzU2NyaXB0SW5mb0NhY2hlLmNsZWFyKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFzeW5jIHF1ZXJ5QXNzZXREb21haW5zKGRiSW5mb3M6IERCSW5mb1tdKSB7XHJcbiAgICAgICAgY29uc3QgYXNzZXREYXRhYmFzZURvbWFpbnM6IEFzc2V0RGF0YWJhc2VEb21haW5bXSA9IFtdO1xyXG4gICAgICAgIGZvciAoY29uc3QgZGJJbmZvIG9mIGRiSW5mb3MpIHtcclxuICAgICAgICAgICAgY29uc3QgZGJVUkwgPSBnZXREYXRhYmFzZU1vZHVsZVJvb3RVUkwoZGJJbmZvLmRiSUQpO1xyXG4gICAgICAgICAgICBjb25zdCBhc3NldERhdGFiYXNlRG9tYWluOiBBc3NldERhdGFiYXNlRG9tYWluID0ge1xyXG4gICAgICAgICAgICAgICAgcm9vdDogbmV3IFVSTChkYlVSTCksXHJcbiAgICAgICAgICAgICAgICBwaHlzaWNhbDogZGJJbmZvLnRhcmdldCxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgaWYgKGlzUGFja2FnZURvbWFpbihkYkluZm8uZGJJRCkpIHtcclxuICAgICAgICAgICAgICAgIGFzc2V0RGF0YWJhc2VEb21haW4uamFpbCA9IGRiSW5mby50YXJnZXQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgYXNzZXREYXRhYmFzZURvbWFpbnMucHVzaChhc3NldERhdGFiYXNlRG9tYWluKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGFzc2V0RGF0YWJhc2VEb21haW5zO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Zug5Li65pe26Ze057Sv6K6h6ICM57yT5a2Y55qE6LWE5rqQ5pu05pS544CCXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX2NoYW5nZVF1ZXVlOiBBc3NldENoYW5nZVtdID0gW107XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlvZPmlLbliLDotYTmupDmm7TmlLnmtojmga/lkI7op6blj5HjgILmiJHku6zkvJrmm7TmlrDotYTmupDmm7TmlLnorqHml7blmajjgIJcclxuICAgICAqL1xyXG4gICAgXHJcbiAgICBvbkFzc2V0Q2hhbmdlKFxyXG4gICAgICAgIGNoYW5nZUluZm86IEFzc2V0Q2hhbmdlSW5mb1xyXG4gICAgKSB7XHJcbiAgICAgICAgY29uc3QgZmlsZVBhdGggPSByZXNvbHZlRmlsZU5hbWUoY2hhbmdlSW5mby5maWxlUGF0aCk7XHJcbiAgICAgICAgY29uc3QgdXVpZCA9IGNoYW5nZUluZm8udXVpZDtcclxuICAgICAgICBjb25zdCBhc3NldENoYW5nZTogQXNzZXRDaGFuZ2UgPSB7XHJcbiAgICAgICAgICAgIHVybDogcGF0aFRvRmlsZVVSTChmaWxlUGF0aCksXHJcbiAgICAgICAgICAgIGltcG9ydGVyOiBjaGFuZ2VJbmZvLmltcG9ydGVyLFxyXG4gICAgICAgICAgICB1dWlkOiB1dWlkLFxyXG4gICAgICAgICAgICBmaWxlUGF0aDogZmlsZVBhdGgsXHJcbiAgICAgICAgICAgIHR5cGU6IGNoYW5nZUluZm8udHlwZSA9PT0gQXNzZXRBY3Rpb25FbnVtLm5vbmUgPyBBc3NldEFjdGlvbkVudW0uY2hhbmdlIDogY2hhbmdlSW5mby50eXBlLFxyXG4gICAgICAgICAgICBpc1BsdWdpblNjcmlwdDogaXNQbHVnaW5TY3JpcHQoY2hhbmdlSW5mby51c2VyRGF0YSksXHJcbiAgICAgICAgfTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBpbXBvcnRlciA9IGNoYW5nZUluZm8uaW1wb3J0ZXI7XHJcbiAgICAgICAgaWYgKCEoaW1wb3J0ZXIgPT09ICdqYXZhc2NyaXB0JyB8fCBpbXBvcnRlciA9PT0gJ3R5cGVzY3JpcHQnKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBpbmZvIDogVHlwZVNjcmlwdEFzc2V0SW5mb0NhY2hlIHwgbnVsbCA9IG51bGw7XHJcbiAgICAgICAgaWYgKGltcG9ydGVyID09PSAndHlwZXNjcmlwdCcpIHtcclxuICAgICAgICAgICAgaW5mbyA9IG1hcHBlckZvclR5cGVTY3JpcHRBc3NldEluZm9DYWNoZShjaGFuZ2VJbmZvKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFpbmZvKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2NoYW5nZVF1ZXVlLnB1c2goYXNzZXRDaGFuZ2UpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgICBcclxuICAgICAgICBpZiAoY2hhbmdlSW5mby50eXBlID09PSBBc3NldEFjdGlvbkVudW0uY2hhbmdlKSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5fdHNTY3JpcHRJbmZvQ2FjaGUuaGFzKGZpbGVQYXRoKSkge1xyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBpdGVyYXRvciBvZiB0aGlzLl90c1NjcmlwdEluZm9DYWNoZS52YWx1ZXMoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVyYXRvci51dWlkID09PSB1dWlkKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl90c1NjcmlwdEluZm9DYWNoZS5kZWxldGUoaXRlcmF0b3IuZmlsZVBhdGgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl90c1NjcmlwdEluZm9DYWNoZS5zZXQoaW5mby5maWxlUGF0aCwgaW5mbyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIChhc3NldENoYW5nZSBhcyBNb2RpZmllZEFzc2V0Q2hhbmdlKS5vbGRGaWxlUGF0aCA9IGl0ZXJhdG9yLmZpbGVQYXRoO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAoYXNzZXRDaGFuZ2UgYXMgTW9kaWZpZWRBc3NldENoYW5nZSkubmV3RmlsZVBhdGggPSBpbmZvLmZpbGVQYXRoO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNoYW5nZUluZm8udHlwZSA9PT0gQXNzZXRBY3Rpb25FbnVtLmFkZCkge1xyXG4gICAgICAgICAgICBpZiAoaW1wb3J0ZXIgPT09ICd0eXBlc2NyaXB0Jykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGVsZXRlZEl0ZW1JbmRleCA9IHRoaXMuX2NoYW5nZVF1ZXVlLmZpbmRJbmRleChpdGVtID0+IGl0ZW0udHlwZSA9PT0gQXNzZXRBY3Rpb25FbnVtLmRlbGV0ZSAmJiBpdGVtLnV1aWQgPT09IHV1aWQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGRlbGV0ZWRJdGVtSW5kZXggIT09IC0xKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGFzc2V0Q2hhbmdlLnR5cGUgPSBBc3NldEFjdGlvbkVudW0uY2hhbmdlO1xyXG4gICAgICAgICAgICAgICAgICAgIChhc3NldENoYW5nZSBhcyBNb2RpZmllZEFzc2V0Q2hhbmdlKS5vbGRGaWxlUGF0aCA9IHJlc29sdmVGaWxlTmFtZSh0aGlzLl9jaGFuZ2VRdWV1ZVtkZWxldGVkSXRlbUluZGV4XS5maWxlUGF0aCk7XHJcbiAgICAgICAgICAgICAgICAgICAgKGFzc2V0Q2hhbmdlIGFzIE1vZGlmaWVkQXNzZXRDaGFuZ2UpLm5ld0ZpbGVQYXRoID0gaW5mby5maWxlUGF0aDtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9jaGFuZ2VRdWV1ZS5zcGxpY2UoZGVsZXRlZEl0ZW1JbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoaW1wb3J0ZXIgPT09ICd0eXBlc2NyaXB0Jykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3RzU2NyaXB0SW5mb0NhY2hlLnNldChpbmZvLmZpbGVQYXRoLCBpbmZvKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNoYW5nZUluZm8udHlwZSA9PT0gQXNzZXRBY3Rpb25FbnVtLmRlbGV0ZSkge1xyXG4gICAgICAgICAgICB0aGlzLl90c1NjcmlwdEluZm9DYWNoZS5kZWxldGUoZmlsZVBhdGgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5fY2hhbmdlUXVldWUucHVzaChhc3NldENoYW5nZSk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0QXNzZXRDaGFuZ2VRdWV1ZSgpOiBBc3NldENoYW5nZVtdIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fY2hhbmdlUXVldWU7XHJcbiAgICB9XHJcblxyXG4gICAgcmVzZXRBc3NldENoYW5nZVF1ZXVlKCkge1xyXG4gICAgICAgIHRoaXMuX2NoYW5nZVF1ZXVlID0gW107XHJcbiAgICB9XHJcbn1cclxuXHJcblxyXG5leHBvcnQgdHlwZSBBc3NldENoYW5nZVR5cGUgPSBBc3NldEFjdGlvbkVudW07XHJcblxyXG5leHBvcnQgZW51bSBEQkNoYW5nZVR5cGUgeyBhZGQsIHJlbW92ZSB9XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEFzc2V0Q2hhbmdlSW5mbyB7XHJcbiAgICB0eXBlOiBBc3NldENoYW5nZVR5cGU7XHJcbiAgICB1dWlkOiBzdHJpbmc7XHJcbiAgICBmaWxlUGF0aDogc3RyaW5nO1xyXG4gICAgaW1wb3J0ZXI6IHN0cmluZztcclxuICAgIHVzZXJEYXRhOiBPYmplY3Q7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQXNzZXRDaGFuZ2Uge1xyXG4gICAgdHlwZTogQXNzZXRDaGFuZ2VUeXBlO1xyXG4gICAgdXVpZDogVVVJRDtcclxuICAgIGZpbGVQYXRoOiBGaWxlUGF0aDtcclxuICAgIGltcG9ydGVyOiBzdHJpbmc7XHJcbiAgICB1cmw6IFVSTDtcclxuICAgIGlzUGx1Z2luU2NyaXB0OiBib29sZWFuO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIE1vZGlmaWVkQXNzZXRDaGFuZ2UgZXh0ZW5kcyBBc3NldENoYW5nZSB7XHJcbiAgICB0eXBlOiBBc3NldEFjdGlvbkVudW0uY2hhbmdlO1xyXG4gICAgb2xkRmlsZVBhdGg/OiBGaWxlUGF0aDtcclxuICAgIG5ld0ZpbGVQYXRoPzogRmlsZVBhdGg7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG1hcHBlckZvclR5cGVTY3JpcHRBc3NldEluZm9DYWNoZShjaGFuZ2VJbmZvOiBBc3NldENoYW5nZUluZm8pOiBUeXBlU2NyaXB0QXNzZXRJbmZvQ2FjaGUge1xyXG4gICAgY29uc3QgZmlsZVBhdGggPSByZXNvbHZlRmlsZU5hbWUoY2hhbmdlSW5mby5maWxlUGF0aCk7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHV1aWQ6IGNoYW5nZUluZm8udXVpZCxcclxuICAgICAgICBmaWxlUGF0aDogZmlsZVBhdGgsXHJcbiAgICAgICAgdXJsOiBwYXRoVG9GaWxlVVJMKGZpbGVQYXRoKSxcclxuICAgICAgICBpc1BsdWdpblNjcmlwdDogaXNQbHVnaW5TY3JpcHQoY2hhbmdlSW5mby51c2VyRGF0YSksXHJcbiAgICB9O1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc1BsdWdpblNjcmlwdCh1c2VyRGF0YTogYW55KSB7XHJcbiAgICBpZiAodXNlckRhdGE/LmlzUGx1Z2luKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBBc3NldERhdGFiYXNlRG9tYWluIHtcclxuICAgIC8qKlxyXG4gICAgICog5q2k5Z+f55qE5qC5IFVSTOOAglxyXG4gICAgICovXHJcbiAgICByb290OiBVUkw7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmraTln5/nmoTniannkIbot6/lvoTjgIJcclxuICAgICAqL1xyXG4gICAgcGh5c2ljYWw6IHN0cmluZztcclxuXHJcbiAgICAvKipcclxuICAgICAqIOatpOWfn+eahOeJqeeQhuaguei3r+W+hOOAguWmguaenOacquaMh+WumuWImeS4uuaWh+S7tuezu+e7n+aguei3r+W+hOOAglxyXG4gICAgICog5Zyo5omn6KGMIG5wbSDnrpfms5Xml7bkvJrkvb/nlKjmraTlrZfmrrXjgIJcclxuICAgICAqL1xyXG4gICAgamFpbD86IHN0cmluZztcclxufVxyXG5cclxuZnVuY3Rpb24gaXNQYWNrYWdlRG9tYWluKGRhdGFiYXNlSUQ6IHN0cmluZykge1xyXG4gICAgcmV0dXJuICFbJ2Fzc2V0cycsICdpbnRlcm5hbCddLmluY2x1ZGVzKGRhdGFiYXNlSUQpO1xyXG59XHJcbiJdfQ==