"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.project = exports.Project = void 0;
const node_uuid_1 = require("node-uuid");
const path_1 = require("path");
const fs_extra_1 = require("fs-extra");
const utils_1 = require("../utils");
class Project {
    /**
     * The version of the Project
     */
    static version = '4.0.0';
    _projectPath = '';
    _type = '3d';
    _pkgPath;
    _tmpDir;
    _libraryDir;
    _info = {
        name: 'unknow',
        type: '3d',
        version: 'unknow',
        uuid: 'unknow',
        creator: {
            version: 'unknow',
        }
    };
    get path() {
        return this._projectPath;
    }
    get type() {
        return this._type;
    }
    static getPackageJsonPath(projectPath) {
        return (0, path_1.join)(projectPath, 'package.json');
    }
    get pkgPath() {
        if (!this._pkgPath) {
            this._pkgPath = Project.getPackageJsonPath(this._projectPath);
        }
        return this._pkgPath;
    }
    get tmpDir() {
        if (!this._tmpDir) {
            this._tmpDir = (0, path_1.join)(this._projectPath, 'temp');
        }
        return this._tmpDir;
    }
    get libraryDir() {
        if (!this._libraryDir) {
            this._libraryDir = (0, path_1.join)(this._projectPath, 'library');
        }
        return this._libraryDir;
    }
    static async create(projectPath, type = '3d') {
        try {
            const packageJSONPath = Project.getPackageJsonPath(projectPath);
            if ((0, fs_extra_1.existsSync)(projectPath) || (0, fs_extra_1.existsSync)(packageJSONPath)) {
                throw new Error('Failed to create project, project exist');
            }
            await (0, fs_extra_1.mkdir)(projectPath, { recursive: true });
            const requiredDirs = [
                (0, path_1.join)(projectPath, 'temp'),
                (0, path_1.join)(projectPath, 'library')
            ].map(dir => !(0, fs_extra_1.existsSync)(dir) ? (0, fs_extra_1.mkdir)(dir, { recursive: true }) : Promise.resolve());
            await Promise.all(requiredDirs);
            await (0, utils_1.safeOutputJSON)(packageJSONPath, Project.generateProjectInfo(projectPath, type));
            return true;
        }
        catch (error) {
            return false;
        }
    }
    getInfo(key) {
        if (typeof key !== 'string') {
            return this._info;
        }
        const keys = key.split('.');
        let current = this._info;
        for (const k of keys) {
            if (current === undefined || current === null) {
                return null;
            }
            current = current[k];
        }
        return current;
    }
    async updateInfo(keyOrValue, value) {
        try {
            if (typeof keyOrValue === 'string') {
                const keys = keyOrValue.split('.');
                let current = this._info;
                for (let i = 0; i < keys.length - 1; i++) {
                    const k = keys[i];
                    if (current[k] === undefined || current[k] === null) {
                        current[k] = {};
                    }
                    else if (typeof current[k] !== 'object' || current[k] === null) {
                        throw new Error(`Cannot set property on non-object at path: ${keys.slice(0, i + 1).join('.')}`);
                    }
                    current = current[k];
                }
                const finalKey = keys[keys.length - 1];
                current[finalKey] = value;
            }
            else {
                this._info = { ...this._info, ...keyOrValue };
            }
            await (0, utils_1.safeOutputJSON)(this.pkgPath, this._info);
            return true;
        }
        catch (error) {
            return false;
        }
    }
    async open(projectPath) {
        this._projectPath = projectPath;
        if (!(0, fs_extra_1.existsSync)(projectPath) || !(0, fs_extra_1.existsSync)(this.pkgPath)) {
            throw new Error(`Failed to open project ${projectPath} : package.json not found.`);
        }
        else {
            const info = await (0, fs_extra_1.readJSON)(this.pkgPath);
            if (!this.isValid(info)) {
                throw new Error(`Failed to open project ${projectPath}: package.json data error.`);
            }
            await this.updateInfo(info);
        }
        return true;
    }
    async close() {
        return await (0, utils_1.safeOutputJSON)(this.pkgPath, this.getInfo());
    }
    /**
     * Generates project information object
     *
     * @param {string} projectPath - The project directory path
     * @param {ProjectType} type - The project type (2d or 3d)
     * @returns {ProjectInfo} Generated project information
     */
    static generateProjectInfo(projectPath, type) {
        return {
            name: (0, path_1.basename)(projectPath),
            type: type,
            version: Project.version,
            uuid: (0, node_uuid_1.v4)(),
            creator: {
                version: Project.version,
                dependencies: {}
            }
        };
    }
    /**
     * Validates if the project information is valid
     *
     * @param {ProjectInfo} info - The project information to validate
     * @returns {boolean} Returns true if the project info is valid, false otherwise
     */
    isValid(info) {
        return typeof info.type !== 'undefined' ||
            typeof info.version !== 'undefined' ||
            typeof info.creator !== 'undefined';
    }
}
exports.Project = Project;
exports.project = new Project();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29yZS9wcm9qZWN0L3NjcmlwdC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSx5Q0FBK0I7QUFDL0IsK0JBQXNDO0FBQ3RDLHVDQUF1RDtBQUV2RCxvQ0FBMEM7QUFxRjFDLE1BQWEsT0FBTztJQUNoQjs7T0FFRztJQUNILE1BQU0sQ0FBVSxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBRTFCLFlBQVksR0FBVyxFQUFFLENBQUM7SUFDMUIsS0FBSyxHQUFnQixJQUFJLENBQUM7SUFDMUIsUUFBUSxDQUFxQjtJQUM3QixPQUFPLENBQXFCO0lBQzVCLFdBQVcsQ0FBcUI7SUFDaEMsS0FBSyxHQUFnQjtRQUN6QixJQUFJLEVBQUUsUUFBUTtRQUNkLElBQUksRUFBRSxJQUFJO1FBQ1YsT0FBTyxFQUFFLFFBQVE7UUFDakIsSUFBSSxFQUFFLFFBQVE7UUFDZCxPQUFPLEVBQUU7WUFDTCxPQUFPLEVBQUUsUUFBUTtTQUNwQjtLQUNKLENBQUM7SUFFRixJQUFJLElBQUk7UUFDSixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7SUFDN0IsQ0FBQztJQUVELElBQUksSUFBSTtRQUNKLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUN0QixDQUFDO0lBRUQsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFdBQW1CO1FBQ3pDLE9BQU8sSUFBQSxXQUFJLEVBQUMsV0FBVyxFQUFFLGNBQWMsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxJQUFJLE9BQU87UUFDUCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ2pCLElBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNsRSxDQUFDO1FBQ0QsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO0lBQ3pCLENBQUM7SUFFRCxJQUFJLE1B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QUFPLEVBQUU7Z0JBQ0wsT0FBTyxFQUFFLE9BQU8sQ0FBQyxPQUFPO2dCQUN4QixZQUFZLEVBQUUsRUFBRTthQUNuQjtTQUNKLENBQUM7SUFDTixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSyxPQUFPLENBQUMsSUFBaUI7UUFDN0IsT0FBTyxPQUFPLElBQUksQ0FBQyxJQUFJLEtBQUssV0FBVztZQUNuQyxPQUFPLElBQUksQ0FBQyxPQUFPLEtBQUssV0FBVztZQUNuQyxPQUFPLElBQUksQ0FBQyxPQUFPLEtBQUssV0FBVyxDQUFDO0lBQzVDLENBQUM7O0FBM0tMLDBCQTRLQztBQUVZLFFBQUEsT0FBTyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB2NCB9IGZyb20gJ25vZGUtdXVpZCc7XHJcbmltcG9ydCB7IGJhc2VuYW1lLCBqb2luIH0gZnJvbSAncGF0aCc7XHJcbmltcG9ydCB7IGV4aXN0c1N5bmMsIG1rZGlyLCByZWFkSlNPTiB9IGZyb20gJ2ZzLWV4dHJhJztcclxuaW1wb3J0IHsgUHJvamVjdEluZm8sIFByb2plY3RUeXBlIH0gZnJvbSAnLi4vQHR5cGVzL3B1YmxpYyc7XHJcbmltcG9ydCB7IHNhZmVPdXRwdXRKU09OIH0gZnJvbSAnLi4vdXRpbHMnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJUHJvamVjdCB7XHJcbiAgICAvKipcclxuICAgICAqIEdldHMgdGhlIHByb2plY3QgZGlyZWN0b3J5IHBhdGhcclxuICAgICAqXHJcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgcHJvamVjdCBkaXJlY3RvcnkgcGF0aFxyXG4gICAgICovXHJcbiAgICBnZXQgcGF0aCgpOiBzdHJpbmc7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBHZXRzIHRoZSBwcm9qZWN0IHR5cGUgKDJkIG9yIDNkKVxyXG4gICAgICpcclxuICAgICAqIEByZXR1cm5zIHsnMmQnIHwgJzNkJ30gVGhlIHByb2plY3QgdHlwZVxyXG4gICAgICovXHJcbiAgICBnZXQgdHlwZSgpOiAnMmQnIHwgJzNkJ1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0cyB0aGUgcGFja2FnZS5qc29uIGZpbGUgcGF0aFxyXG4gICAgICpcclxuICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBwYXRoIHRvIHBhY2thZ2UuanNvbiBmaWxlXHJcbiAgICAgKi9cclxuICAgIGdldCBwa2dQYXRoKCk6IHN0cmluZztcclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldHMgdGhlIHRlbXAgZGlyZWN0b3J5IHBhdGhcclxuICAgICAqXHJcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgcGF0aCB0byB0aGUgdGVtcG9yYXJ5IGRpcmVjdG9yeVxyXG4gICAgICovXHJcbiAgICBnZXQgdG1wRGlyKCk6IHN0cmluZztcclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldHMgdGhlIGxpYnJhcnkgZGlyZWN0b3J5IHBhdGhcclxuICAgICAqXHJcbiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgcGF0aCB0byB0aGUgbGlicmFyeSBkaXJlY3RvcnlcclxuICAgICAqL1xyXG4gICAgZ2V0IGxpYnJhcnlEaXIoKTogc3RyaW5nO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogT3BlbnMgdGhlIHByb2plY3QgYW5kIGxvYWRzIHByb2plY3QgaW5mb3JtYXRpb25cclxuICAgICAqXHJcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZTxib29sZWFuPn0gUmV0dXJucyB0cnVlIGlmIHRoZSBwcm9qZWN0IHdhcyBvcGVuZWQgc3VjY2Vzc2Z1bGx5LCBmYWxzZSBvdGhlcndpc2VcclxuICAgICAqL1xyXG4gICAgb3Blbihwcm9qZWN0UGF0aDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIENsb3NlcyB0aGUgcHJvamVjdCBhbmQgc2F2ZXMgY3VycmVudCBwcm9qZWN0IGluZm9ybWF0aW9uXHJcbiAgICAgKlxyXG4gICAgICogQHJldHVybnMge1Byb21pc2U8Ym9vbGVhbj59IFJldHVybnMgdHJ1ZSBpZiB0aGUgcHJvamVjdCB3YXMgY2xvc2VkIHN1Y2Nlc3NmdWxseSwgZmFsc2Ugb3RoZXJ3aXNlXHJcbiAgICAgKi9cclxuICAgIGNsb3NlKCk6IFByb21pc2U8Ym9vbGVhbj47XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBHZXRzIHRoZSBjb21wbGV0ZSBwcm9qZWN0IGluZm9ybWF0aW9uXHJcbiAgICAgKlxyXG4gICAgICogQHJldHVybnMge1Byb2plY3RJbmZvfSBUaGUgY29tcGxldGUgcHJvamVjdCBpbmZvcm1hdGlvbiBvYmplY3RcclxuICAgICAqL1xyXG4gICAgZ2V0SW5mbygpOiBQcm9qZWN0SW5mbztcclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldHMgc3BlY2lmaWMgcHJvamVjdCBpbmZvcm1hdGlvbiBieSBrZXkgcGF0aFxyXG4gICAgICpcclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUga2V5IHBhdGggdG8gYWNjZXNzIG5lc3RlZCBwcm9wZXJ0aWVzIChlLmcuLCAnY3JlYXRvci52ZXJzaW9uJylcclxuICAgICAqIEByZXR1cm5zIHthbnl9IFRoZSB2YWx1ZSBhdCB0aGUgc3BlY2lmaWVkIGtleSBwYXRoLCBvciBudWxsIGlmIG5vdCBmb3VuZFxyXG4gICAgICovXHJcbiAgICBnZXRJbmZvKGtleTogc3RyaW5nKTogYW55O1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0cyBwcm9qZWN0IGluZm9ybWF0aW9uIHdpdGggb3B0aW9uYWwga2V5IHBhdGhcclxuICAgICAqXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW2tleV0gLSBPcHRpb25hbCBrZXkgcGF0aCB0byBhY2Nlc3MgbmVzdGVkIHByb3BlcnRpZXNcclxuICAgICAqIEByZXR1cm5zIHtQcm9qZWN0SW5mbyB8IGFueX0gUHJvamVjdCBpbmZvcm1hdGlvbiBvciBzcGVjaWZpYyB2YWx1ZVxyXG4gICAgICovXHJcbiAgICBnZXRJbmZvKGtleT86IHN0cmluZyk6IFByb2plY3RJbmZvIHwgYW55O1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogVXBkYXRlcyBzcGVjaWZpYyBwcm9qZWN0IGluZm9ybWF0aW9uIGJ5IGtleSBwYXRoIG9yIGNvbXBsZXRlIGluZm9cclxuICAgICAqXHJcbiAgICAgKiBAcGFyYW0ge3N0cmluZyB8IFByb2plY3RJbmZvfSBrZXlPclZhbHVlIC0gRWl0aGVyIGEga2V5IHBhdGggc3RyaW5nIG9yIGNvbXBsZXRlIFByb2plY3RJbmZvIG9iamVjdFxyXG4gICAgICogQHBhcmFtIHtQcm9qZWN0SW5mb30gW3ZhbHVlXSAtIFRoZSB2YWx1ZSB0byBzZXQgd2hlbiB1c2luZyBrZXkgcGF0aCAocmVxdWlyZWQgaWYga2V5T3JWYWx1ZSBpcyBzdHJpbmcpXHJcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZTxib29sZWFuPn0gUmV0dXJucyB0cnVlIGlmIHVwZGF0ZSB3YXMgc3VjY2Vzc2Z1bCwgZmFsc2Ugb3RoZXJ3aXNlXHJcbiAgICAgKi9cclxuICAgIHVwZGF0ZUluZm88VD4oa2V5T3JWYWx1ZTogc3RyaW5nIHwgUHJvamVjdEluZm8sIHZhbHVlPzogVCk6IFByb21pc2U8Ym9vbGVhbj47XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBQcm9qZWN0IGltcGxlbWVudHMgSVByb2plY3Qge1xyXG4gICAgLyoqXHJcbiAgICAgKiBUaGUgdmVyc2lvbiBvZiB0aGUgUHJvamVjdFxyXG4gICAgICovXHJcbiAgICBzdGF0aWMgcmVhZG9ubHkgdmVyc2lvbiA9ICc0LjAuMCc7XHJcblxyXG4gICAgcHJpdmF0ZSBfcHJvamVjdFBhdGg6IHN0cmluZyA9ICcnO1xyXG4gICAgcHJpdmF0ZSBfdHlwZTogUHJvamVjdFR5cGUgPSAnM2QnO1xyXG4gICAgcHJpdmF0ZSBfcGtnUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkO1xyXG4gICAgcHJpdmF0ZSBfdG1wRGlyOiBzdHJpbmcgfCB1bmRlZmluZWQ7XHJcbiAgICBwcml2YXRlIF9saWJyYXJ5RGlyOiBzdHJpbmcgfCB1bmRlZmluZWQ7XHJcbiAgICBwcml2YXRlIF9pbmZvOiBQcm9qZWN0SW5mbyA9IHtcclxuICAgICAgICBuYW1lOiAndW5rbm93JyxcclxuICAgICAgICB0eXBlOiAnM2QnLFxyXG4gICAgICAgIHZlcnNpb246ICd1bmtub3cnLFxyXG4gICAgICAgIHV1aWQ6ICd1bmtub3cnLFxyXG4gICAgICAgIGNyZWF0b3I6IHtcclxuICAgICAgICAgICAgdmVyc2lvbjogJ3Vua25vdycsXHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBnZXQgcGF0aCgpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9wcm9qZWN0UGF0aDtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgdHlwZSgpOiAnMmQnIHwgJzNkJyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3R5cGU7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGdldFBhY2thZ2VKc29uUGF0aChwcm9qZWN0UGF0aDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gam9pbihwcm9qZWN0UGF0aCwgJ3BhY2thZ2UuanNvbicpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBwa2dQYXRoKCk6IHN0cmluZyB7XHJcbiAgICAgICAgaWYgKCF0aGlzLl9wa2dQYXRoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3BrZ1BhdGggPSBQcm9qZWN0LmdldFBhY2thZ2VKc29uUGF0aCh0aGlzLl9wcm9qZWN0UGF0aCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLl9wa2dQYXRoO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCB0bXBEaXIoKTogc3RyaW5nIHtcclxuICAgICAgICBpZiAoIXRoaXMuX3RtcERpcikge1xyXG4gICAgICAgICAgICB0aGlzLl90bXBEaXIgPSBqb2luKHRoaXMuX3Byb2plY3RQYXRoLCAndGVtcCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5fdG1wRGlyO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBsaWJyYXJ5RGlyKCk6IHN0cmluZyB7XHJcbiAgICAgICAgaWYgKCF0aGlzLl9saWJyYXJ5RGlyKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2xpYnJhcnlEaXIgPSBqb2luKHRoaXMuX3Byb2plY3RQYXRoLCAnbGlicmFyeScpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5fbGlicmFyeURpcjtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIGNyZWF0ZShwcm9qZWN0UGF0aDogc3RyaW5nLCB0eXBlOiBQcm9qZWN0VHlwZSA9ICczZCcpOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBwYWNrYWdlSlNPTlBhdGggPSBQcm9qZWN0LmdldFBhY2thZ2VKc29uUGF0aChwcm9qZWN0UGF0aCk7XHJcbiAgICAgICAgICAgIGlmIChleGlzdHNTeW5jKHByb2plY3RQYXRoKSB8fCBleGlzdHNTeW5jKHBhY2thZ2VKU09OUGF0aCkpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGNyZWF0ZSBwcm9qZWN0LCBwcm9qZWN0IGV4aXN0Jyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgYXdhaXQgbWtkaXIocHJvamVjdFBhdGgsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xyXG4gICAgICAgICAgICBjb25zdCByZXF1aXJlZERpcnMgPSBbXHJcbiAgICAgICAgICAgICAgICBqb2luKHByb2plY3RQYXRoLCAndGVtcCcpLFxyXG4gICAgICAgICAgICAgICAgam9pbihwcm9qZWN0UGF0aCwgJ2xpYnJhcnknKVxyXG4gICAgICAgICAgICBdLm1hcChkaXIgPT4gIWV4aXN0c1N5bmMoZGlyKSA/IG1rZGlyKGRpciwgeyByZWN1cnNpdmU6IHRydWUgfSkgOiBQcm9taXNlLnJlc29sdmUoKSk7XHJcblxyXG4gICAgICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChyZXF1aXJlZERpcnMpO1xyXG4gICAgICAgICAgICBhd2FpdCBzYWZlT3V0cHV0SlNPTihwYWNrYWdlSlNPTlBhdGgsIFByb2plY3QuZ2VuZXJhdGVQcm9qZWN0SW5mbyhwcm9qZWN0UGF0aCwgdHlwZSkpO1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRJbmZvKCk6IFByb2plY3RJbmZvO1xyXG5cclxuICAgIHB1YmxpYyBnZXRJbmZvKGtleTogc3RyaW5nKTogYW55O1xyXG5cclxuICAgIHB1YmxpYyBnZXRJbmZvKGtleT86IHN0cmluZyk6IFByb2plY3RJbmZvIHwgYW55IHtcclxuICAgICAgICBpZiAodHlwZW9mIGtleSAhPT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2luZm87XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGtleXMgPSBrZXkuc3BsaXQoJy4nKTtcclxuXHJcbiAgICAgICAgbGV0IGN1cnJlbnQgPSB0aGlzLl9pbmZvO1xyXG4gICAgICAgIGZvciAoY29uc3QgayBvZiBrZXlzKSB7XHJcbiAgICAgICAgICAgIGlmIChjdXJyZW50ID09PSB1bmRlZmluZWQgfHwgY3VycmVudCA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnRba107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBjdXJyZW50O1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyB1cGRhdGVJbmZvPFQ+KGtleU9yVmFsdWU6IHN0cmluZyB8IFByb2plY3RJbmZvLCB2YWx1ZT86IFQpOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIGtleU9yVmFsdWUgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBrZXlzID0ga2V5T3JWYWx1ZS5zcGxpdCgnLicpO1xyXG4gICAgICAgICAgICAgICAgbGV0IGN1cnJlbnQgPSB0aGlzLl9pbmZvO1xyXG5cclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGggLSAxOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBrID0ga2V5c1tpXTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFtrXSA9PT0gdW5kZWZpbmVkIHx8IGN1cnJlbnRba10gPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFtrXSA9IHt9O1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGN1cnJlbnRba10gIT09ICdvYmplY3QnIHx8IGN1cnJlbnRba10gPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3Qgc2V0IHByb3BlcnR5IG9uIG5vbi1vYmplY3QgYXQgcGF0aDogJHtrZXlzLnNsaWNlKDAsIGkgKyAxKS5qb2luKCcuJyl9YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50W2tdO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsS2V5ID0ga2V5c1trZXlzLmxlbmd0aCAtIDFdO1xyXG4gICAgICAgICAgICAgICAgY3VycmVudFtmaW5hbEtleV0gPSB2YWx1ZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2luZm8gPSB7IC4uLnRoaXMuX2luZm8sIC4uLmtleU9yVmFsdWUgfTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgYXdhaXQgc2FmZU91dHB1dEpTT04odGhpcy5wa2dQYXRoLCB0aGlzLl9pbmZvKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYXN5bmMgb3Blbihwcm9qZWN0UGF0aDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgICAgICAgdGhpcy5fcHJvamVjdFBhdGggPSBwcm9qZWN0UGF0aDtcclxuICAgICAgICBpZiAoIWV4aXN0c1N5bmMocHJvamVjdFBhdGgpIHx8ICFleGlzdHNTeW5jKHRoaXMucGtnUGF0aCkpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gb3BlbiBwcm9qZWN0ICR7cHJvamVjdFBhdGh9IDogcGFja2FnZS5qc29uIG5vdCBmb3VuZC5gKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCBpbmZvOiBQcm9qZWN0SW5mbyA9IGF3YWl0IHJlYWRKU09OKHRoaXMucGtnUGF0aCk7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5pc1ZhbGlkKGluZm8pKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBvcGVuIHByb2plY3QgJHtwcm9qZWN0UGF0aH06IHBhY2thZ2UuanNvbiBkYXRhIGVycm9yLmApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGF3YWl0IHRoaXMudXBkYXRlSW5mbyhpbmZvKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFzeW5jIGNsb3NlKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gICAgICAgIHJldHVybiBhd2FpdCBzYWZlT3V0cHV0SlNPTih0aGlzLnBrZ1BhdGgsIHRoaXMuZ2V0SW5mbygpKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdlbmVyYXRlcyBwcm9qZWN0IGluZm9ybWF0aW9uIG9iamVjdFxyXG4gICAgICpcclxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcm9qZWN0UGF0aCAtIFRoZSBwcm9qZWN0IGRpcmVjdG9yeSBwYXRoXHJcbiAgICAgKiBAcGFyYW0ge1Byb2plY3RUeXBlfSB0eXBlIC0gVGhlIHByb2plY3QgdHlwZSAoMmQgb3IgM2QpXHJcbiAgICAgKiBAcmV0dXJucyB7UHJvamVjdEluZm99IEdlbmVyYXRlZCBwcm9qZWN0IGluZm9ybWF0aW9uXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgc3RhdGljIGdlbmVyYXRlUHJvamVjdEluZm8ocHJvamVjdFBhdGg6IHN0cmluZywgdHlwZTogUHJvamVjdFR5cGUpOiBQcm9qZWN0SW5mbyB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgbmFtZTogYmFzZW5hbWUocHJvamVjdFBhdGgpLFxyXG4gICAgICAgICAgICB0eXBlOiB0eXBlLFxyXG4gICAgICAgICAgICB2ZXJzaW9uOiBQcm9qZWN0LnZlcnNpb24sXHJcbiAgICAgICAgICAgIHV1aWQ6IHY0KCksXHJcbiAgICAgICAgICAgIGNyZWF0b3I6IHtcclxuICAgICAgICAgICAgICAgIHZlcnNpb246IFByb2plY3QudmVyc2lvbixcclxuICAgICAgICAgICAgICAgIGRlcGVuZGVuY2llczoge31cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBWYWxpZGF0ZXMgaWYgdGhlIHByb2plY3QgaW5mb3JtYXRpb24gaXMgdmFsaWRcclxuICAgICAqXHJcbiAgICAgKiBAcGFyYW0ge1Byb2plY3RJbmZvfSBpbmZvIC0gVGhlIHByb2plY3QgaW5mb3JtYXRpb24gdG8gdmFsaWRhdGVcclxuICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgdGhlIHByb2plY3QgaW5mbyBpcyB2YWxpZCwgZmFsc2Ugb3RoZXJ3aXNlXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgaXNWYWxpZChpbmZvOiBQcm9qZWN0SW5mbyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0eXBlb2YgaW5mby50eXBlICE9PSAndW5kZWZpbmVkJyB8fFxyXG4gICAgICAgICAgICB0eXBlb2YgaW5mby52ZXJzaW9uICE9PSAndW5kZWZpbmVkJyB8fFxyXG4gICAgICAgICAgICB0eXBlb2YgaW5mby5jcmVhdG9yICE9PSAndW5kZWZpbmVkJztcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IHByb2plY3QgPSBuZXcgUHJvamVjdCgpO1xyXG4iXX0=